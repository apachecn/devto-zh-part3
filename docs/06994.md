# ç”¨æ‰¿è¯ºè§£å†³ä½ æ‰€æœ‰çš„é—®é¢˜

> åŸæ–‡:[https://dev . to/reverent Mike/solve-all-your ' s problem-with-promise-all-settled-444 I](https://dev.to/irreverentmike/solve-all-your-problems-with-promise-allsettled-444i)

(æ³¨:è¿™ç¯‡æ–‡ç« çš„çµæ„Ÿæ¥è‡ªäº[éŸ¦æ–¯Â·åšæ–¯](https://twitter.com/wesbos)åœ¨ JAMstack_conf_nyc çš„ä¸€æ¬¡æ¼”è®²ã€‚è°¢è°¢ä½ çš„æç¤ºï¼ŒéŸ¦æ–¯ï¼)

æœ€è¿‘ï¼Œæˆ‘å‘ç°è‡ªå·±åœ¨æ„å»ºè¶Šæ¥è¶Šå¤æ‚çš„ JavaScript web åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ ç†Ÿæ‚‰ç°ä»£ JavaScriptï¼Œä½ è‚¯å®šé‡åˆ°è¿‡[`Promise`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)â€”â€”ä¸€ç§å¸®åŠ©ä½ å¼‚æ­¥æ‰§è¡Œä»£ç çš„ç»“æ„ã€‚ä¸€ä¸ª`Promise`å°±åƒå®ƒå¬èµ·æ¥çš„é‚£æ ·:ä½ ç”¨å®ƒä»¬æ¥æ‰§è¡Œä»£ç ï¼Œè¿™äº›ä»£ç å°†(æ‰¿è¯º)åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»è¿”å›ä¸€ä¸ªå€¼:

çœ‹çœ‹è¿™ä¸ªæœ‰ç‚¹åšä½œçš„ä¾‹å­ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¼‚æ­¥åŠ è½½åšå®¢å¸–å­ä¸Šçš„è¯„è®º:

```
const loadComments = new Promise((resolve, reject) => {
  // run an asynchronous API call
  BlogEngine.loadCommentsForPost({ id: '12345' })
    .then(comments => {
      // Everything worked! Return this promise with the comments we got back.
      resolve(comments)
    })
    .error(err => {
      // something went wrong - send the error back
      reject(new Error(err))
    })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿˜æœ‰ä¸€ç§æ›¿ä»£çš„è¯­æ³•æ¨¡å¼ï¼Œ`async` / `await`ï¼Œè®©ä½ ä»¥ä¸€ç§æ›´æ¸…æ™°çš„ä¼ªåºåˆ—å½¢å¼å†™ä¸‹æ‰¿è¯º:

```
const loadComments = async () => {
  try {
    const comments = await BlogEngine.loadCommentsForPost({ id: '12345' })
    return comments
  } catch (err) {
    return new Error(err)
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#dealing-with-multiple-promises)åº”å¯¹å¤šé‡æ‰¿è¯º

ä¸å¯é¿å…åœ°ï¼Œä½ ä¼šå‘ç°è‡ªå·±å¤„äºéœ€è¦å±¥è¡Œå¤šä¸ªæ‰¿è¯ºçš„æƒ…å†µã€‚è®©æˆ‘ä»¬ç®€å•åœ°å¼€å§‹:

```
 const postIds = ['1', '2', '3', '4', '5'];
postIds.forEach(async (id) => {
  // load the comments for this post
  const comments = await loadComments(id);

  // then do something with them, like spit them out to the console, for example
  console.log(`Returned ${comments.length} comments, bru`);
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è½»æ¾ç‚¹ã€‚å¿«é€Ÿå¾ªç¯å¯ä»¥è®©æˆ‘ä»¬å¯¹æ„Ÿå…´è¶£çš„æ¯ç¯‡æ–‡ç« éƒ½æœ‰è¯„è®ºã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé™·é˜±â€”â€”`await`å…³é”®å­—å°†åœæ­¢å¾ªç¯çš„æ‰§è¡Œï¼Œç›´åˆ°`loadComments`ä¸ºæ¯ä¸ªå¸–å­è¿”å›ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æŒ‰é¡ºåºåŠ è½½æ¯ä¸ªå¸–å­çš„è¯„è®º*ï¼Œè€Œä¸æ˜¯åˆ©ç”¨æµè§ˆå™¨ä¸€æ¬¡å‘é€å¤šä¸ª API è¯·æ±‚çš„èƒ½åŠ›ã€‚*

 *ä¸€æ¬¡å‘é€å¤šä¸ªè¯·æ±‚çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨`Promise.all()`ã€‚è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªç”±`Promise` s ç»„æˆçš„*æ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«æ¯ä¸ªæ‰¿è¯ºçš„å“åº”çš„æ•°ç»„:* 

```
const postIds = ['1', '2', '3', '4', '5'];
const promises = postIds.map(async (id) => {
  return await loadComments(id);
};

const postComments = Promise.all(promises);

// postComments will be an Array of results fromj the promises we created:
console.log(JSON.postComments);
/*
[
  { post1Comments },
  { post2Comments },
  etc...
]
*/ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿˜æœ‰**ä¸€ä¸ªé‡è¦çš„æŠ“(lol)** è·Ÿ`Promise.all()`ã€‚å¦‚æœ*å‘é€ç»™`Promise.all()`çš„ä»»ä½•*æ‰¿è¯ºå¤±è´¥æˆ–è€…`reject`å¤±è´¥ï¼Œ*ä¸€åˆ‡*å¤±è´¥ã€‚æ¥è‡ª [MDN ç½‘ç»œæ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all)(é‡ç‚¹æ˜¯æˆ‘çš„):

> å½“ä½œä¸º iterable ä¼ é€’çš„æ‰€æœ‰æ‰¿è¯ºéƒ½å·²è§£ææˆ– iterable ä¸åŒ…å«æ‰¿è¯ºæ—¶ï¼Œ`Promise.all()`æ–¹æ³•è¿”å›ä¸€ä¸ªè§£æçš„`Promise`ã€‚**å®ƒä»¥ç¬¬ä¸€ä¸ªæ‹’ç»çš„æ‰¿è¯ºçš„ç†ç”±æ‹’ç»ã€‚**

è¯¥æ­»çš„ï¼Œäº‹å®è¯æ˜`Promise.all()`åœ¨æ‰§è¡Œç­–ç•¥ä¸Šç›¸å½“ä¿å®ˆã€‚å¦‚æœä½ æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œè¿™å¯èƒ½æ˜¯éå¸¸å±é™©çš„ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœä¸º*ä¸€ç¯‡æ–‡ç« *åŠ è½½è¯„è®ºå¯¼è‡´*æ¯ç¯‡æ–‡ç« *çš„è¯„è®ºéƒ½æ— æ³•åŠ è½½ï¼Œè¿™ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿè¯¥æ­»çš„ã€‚

## [](#enter-raw-promiseallsettled-endraw-)*è¾“å…¥`Promise.allSettled()`*

ç›´åˆ°æœ€è¿‘ï¼Œå¯¹äºè¿™ç§æƒ…å†µè¿˜æ²¡æœ‰ä¸€ä¸ªä»¤äººæƒŠå¹çš„ç­”æ¡ˆã€‚*ç„¶è€Œ*ï¼Œæˆ‘ä»¬å°†å¾ˆå¿«å¹¿æ³›ä½¿ç”¨ [`Promise.allSettled()`](https://github.com/tc39/proposal-promise-allSettled) ï¼Œè¿™æ˜¯ç›®å‰ ECMAscript æŠ€æœ¯å§”å‘˜ä¼š 39 é¢å‰çš„ç¬¬ä¸‰é˜¶æ®µææ¡ˆï¼Œè¯¥å§”å‘˜ä¼šè´Ÿè´£æ‰¹å‡†å’Œè®¤å¯ ECMAscript(ä¹Ÿç§°ä¸ºâ€œJavaScriptâ€ï¼Œè”åˆå›½å‘èµ·çš„)çš„å˜æ›´ã€‚

ä½ çœ‹ï¼Œ`Promise.allSettled()`åšçš„æ­£æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æƒ³è¦çš„åŠ è½½åšå®¢è¯„è®ºã€‚å¦‚æœ*ä¼ é€’ç»™å®ƒçš„ä»»ä½•ä¸€ä¸ª*å¤±è´¥ï¼Œå®ƒä¸ä¼šå¤±è´¥ï¼Œè€Œæ˜¯ç­‰å¾…ç›´åˆ°å®ƒä»¬éƒ½å®Œæˆæ‰§è¡Œ(æ¢å¥è¯è¯´ï¼Œç›´åˆ°å®ƒä»¬éƒ½â€œè§£å†³â€)ï¼Œå¹¶ä»æ¯ä¸ªè¿”å›ä¸€ä¸ªæ•°ç»„:

(è¿™ä¸ªä»£ç æ ·æœ¬æŠ„è¢­è‡ª github ææ¡ˆâ€”â€”å»çœ‹çœ‹æ›´å¤šç»†èŠ‚)

```
const promises = [fetch('index.html'), fetch('https://does-not-exist/')]
const results = await Promise.allSettled(promises)
const successfulPromises = results.filter(p => p.status === 'fulfilled') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æ˜¯è¿™æ ·ï¼è¶…çº§å¥½ç”¨ã€‚

## [](#using-raw-promiseall-endraw-now-updated)ç°åœ¨ä½¿ç”¨`Promise.All()`(æ›´æ–°ï¼)

**2019 å¹´ 4 æœˆ 26 æ—¥æ›´æ–°**
å®‰è£… [`core-js`](https://github.com/zloirock/core-js) åŒ…ï¼Œå¹¶å°†å…¶åŒ…å«åœ¨æ‚¨çš„ä»£ç åº“ä¸­:

```
import 'core-js/proposals/promise-all-settled' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**åŸå¸–:**
å¥½äº†ï¼Œäº‹æƒ…æ˜¯è¿™æ ·çš„â€”â€”è¿™å°±æ˜¯æ£˜æ‰‹çš„éƒ¨åˆ†ã€‚æˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶è®¤ä¸ºï¼Œè¿™å°±åƒå‘Šè¯‰ä½ åœ¨é¡¹ç›®çš„`.babelrc`é…ç½®ä¸­ä½¿ç”¨ä¸€ä¸ª`stage-3`é¢„ç½®ä¸€æ ·ç®€å•ã€‚äº‹å®è¯æ˜ï¼Œæˆªæ­¢åˆ° v7ï¼ŒBabel å·²ç»[åœæ­¢å‘å¸ƒèˆå°é¢„ç½®](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)ï¼å¦‚æœè¿™å¯¹ä½ æœ‰ä»»ä½•æ„ä¹‰ï¼Œä½ åº”è¯¥çœ‹çœ‹ä»–ä»¬çš„å¸–å­ã€‚

ç°åœ¨çš„ç­”æ¡ˆæ˜¯ï¼Œ*ä¸æ˜¯*ä½¿ç”¨`Promise.allSettled()`è¿˜ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å¾—åˆ°å¹¿æ³›çš„æ”¯æŒã€‚é¦–å…ˆï¼Œæ®æˆ‘æ‰€çŸ¥ï¼Œæ²¡æœ‰ä¸€ä¸ª babel config æ‰©å±•å¯ä»¥ä¸ºä½ çš„é¡¹ç›®å¢åŠ æ”¯æŒã€‚ç›®å‰ï¼Œä½ èƒ½å¾—åˆ°çš„æœ€å¥½çš„æ˜¯ä¸€ä¸ª polyfill æˆ–è€…ä¸€ä¸ªå®ç°äº†`allSettled()`çš„å¯é€‰åº“ã€‚

æˆ‘çŸ¥é“è¿™å¯èƒ½ä¼šä»¤äººå¤±æœ›â€”â€”å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œæˆ‘é‡åˆ°çš„åå‡ ä¸ªé—®é¢˜éƒ½å¯ä»¥ç”¨è¿™ä¸ªæ–°è¯­æ³•å¾ˆå¥½åœ°è§£å†³ã€‚ä¸è¿‡ï¼Œæˆ‘æƒ³è®©ä½ ä»¬å…³æ³¨çš„æ˜¯ï¼ŒJavaScript çš„æŒç»­å¢é•¿æ˜¯å¤šä¹ˆæƒŠäººã€‚çœ‹åˆ°è¿™äº›å¯¹è¯­è¨€çš„è¡¥å……ä¹Ÿåœ¨å…¬å¼€çš„ä¸­è¿›è¡Œ[æ˜¯ä»¤äººå…´å¥‹çš„ï¼Œä¹Ÿæ˜¯éå¸¸é…·çš„ã€‚å¼€æºæ˜¯å¦‚æ­¤ç¾å¥½çš„äº‹æƒ…ï¼](https://github.com/tc39/proposal-promise-allSettled)

å¦‚æœä½ çœŸçš„æƒ³åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨`Promise.All()`,ä½ æœ€å¥½ä»¥æŸç§æ–¹å¼ä¸ºè¿™ä¸ªè¿‡ç¨‹åšå‡ºè´¡çŒ®ã€‚è¿™å¯èƒ½å°åˆ°ç¼–å†™è‡ªå·±çš„ polyfillï¼Œæˆ–è€…å‘ tc39 ç›¸å…³äººå‘˜æä¾›åé¦ˆï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–åº“ã€‚

### [](#footnote)è„šæ³¨

æˆ‘ä¼šå°½æˆ‘æ‰€èƒ½ä¿æŒè¿™ç¯‡æ–‡ç« çš„æ›´æ–°ã€‚å½“`allSettled`å‘å¸ƒæ—¶ï¼Œæˆ‘ä¼šè®©ä½ ä»¬çŸ¥é“ã€‚ğŸ‘

*(æœ¬æ–‡å°é¢ç…§ç‰‡ç”±[ç“¦ä¼¦ä¸Â·å®‰æ‰˜åŠªå¥‡](https://unsplash.com/photos/9cRDDvhpBRw?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)åœ¨ [Unsplash](https://unsplash.com/search/photos/promise?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„ã€‚è°¢è°¢ä½ çš„å·¥ä½œï¼)**