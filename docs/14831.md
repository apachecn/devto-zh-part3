# åˆ›é€ ä¸€ä¸ªå›¾å½¢å’Œé˜¿æ³¢ç½—çš„ API | part iii

> [https://dev . to/gugadev/creating-one-API-con-graph QL-y-Apollo--part-iii-1c86](https://dev.to/gugadev/creando-una-api-con-graphql-y-apollo--parte-iii-1c86)

åœ¨ä¸Šä¸€ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è§’åº¦åº”ç”¨ç¨‹åºå¹¶åˆ›å»ºäº†è¡¨æ ¼ã€‚æˆ‘ä»¬çœ‹åˆ°äº†æˆ‘ä»¬å¦‚ä½•é€šè¿‡æŒ‡ä»¤æ¥æ¨¡å—åŒ–ä»£ç ï¼Œå¹¶é€šè¿‡ä¸€ç‚¹ CSS ä½¿ä»£ç çœ‹èµ·æ¥ä¼˜é›…ã€‚ä½†æ˜¯ï¼Œç”±äºè¿™è¿˜ä¸å¤Ÿï¼Œåœ¨ç³»åˆ—çš„è¿™ç¬¬ä¸‰éƒ¨åˆ†å’Œæœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸æˆ‘ä»¬çš„ graph QL API è¿›è¡Œé€šä¿¡ã€‚

å¥½å§ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚æˆ‘ä»¬å·²ç»æœ‰äº†æˆ‘ä»¬çš„è¡¨æ ¼ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ç»™å®ƒä¸€äº›åŠŸèƒ½ã€‚å…·ä½“è€Œè¨€ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ä»»åŠ¡å°†æ˜¯ä¸¤ä»¶äº‹:

*   å‘ç”µå­é‚®ä»¶ä¸­æ·»åŠ éªŒè¯ï¼Œä»¥ç¡®ä¿å®ƒæœªè¢«ä½¿ç”¨ã€‚
*   å¦‚æœä¸Šä¸€ä¸ªæ­¥éª¤æˆåŠŸé€šè¿‡ï¼Œåˆ™æ³¨å†Œæ–°ç”¨æˆ·ã€‚

> å¼€å§‹ä¹‹å‰:æœ`uri`æ–¹å‘èµ°ï¼Œå¹¶ç»™å˜é‡`uri`åˆ†é…æˆ‘ä»¬ API è¿è¡Œçš„åœ°å€ï¼Œå³:*[ã€http://localhost:3000ã€‘](http://localhost:3000)*ã€‚

## [](#validando-que-el-email-no-est%C3%A9-registrado)éªŒè¯ç”µå­é‚®ä»¶æœªæ³¨å†Œã€‚

å¦‚æœæ‚¨è¿˜è®°å¾—æˆ‘ä»¥å‰çš„ active Forms æ•™ç¨‹ï¼Œæ‚¨ä¼šè®°å¾—æˆ‘ä»¬è°ˆè¿‡å¼‚æ­¥éªŒè¯å™¨ã€‚å®ƒä»¬å…·æœ‰è¿”å›æ‰¿è¯ºæˆ–å¯è§‚å¯Ÿå®ä¾‹çš„éªŒè¯çš„ç‰¹ç‚¹ã€‚é€šè¿‡è¿™ç§ç±»å‹çš„éªŒè¯å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ graph QL API æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯ã€‚

### [](#creaci%C3%B3n-del-servicio)åˆ›å»ºæœåŠ¡

æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ˜¯ç”ŸæˆæœåŠ¡ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º
:

```
ng g s signup/ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶åŠ å…¥ä»¥ä¸‹æ–¹æ³•`checkForExists` :

```
import { Injectable } from '@angular/core'
import { Apollo } from 'apollo-angular'
import { Observable, Subscriber, Observer } from 'rxjs'
import gql from 'graphql-tag'
import { ApolloQueryResult } from 'apollo-client'
import { User } from '../models/user'

@Injectable({
  providedIn: 'root'
})
export class SignupService {

  constructor(private apollo: Apollo) { }

  /**
   * Search an user by his email address
   * @param email | string user's email who's looking for
   * @returns boolean if the user exists or not
   */
  public checkForExists(email: string): Observable<boolean> {
    return Observable.create((sub: Subscriber<boolean>) => {
      this.apollo.query({
        query: gql`
          query Find($email: String!) {
            user(email: $email) {
              id
            }
          }
        `,
        variables: { email }
      })
      .subscribe((value: ApolloQueryResult<any>) => {
        const found: User | null = value.data.user
        sub.next(found !== null)
        sub.complete()
      })
    })
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬è¯¦ç»†åœ°çœ‹ä¸€ä¸‹ã€‚ç¬¬ä¸€æ˜¯*æ³¨å…¥`Apollo`å¯¹æˆ‘ä»¬å»ºè®¾è€…çš„ä¾èµ–ã€‚è¿™ç§ä¾èµ–å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸æˆ‘ä»¬çš„ API è¿›è¡Œåå•†ã€‚*

 *ç¬¬äºŒï¼Œæˆ‘ä»¬çš„æ–¹æ³•`checkForExists`æ”¶åˆ°çš„å‚æ•°æ˜¯ç”µå­é‚®ä»¶ã€‚æ­¤æ–¹æ³•è¿”å›å°†å­˜å‚¨å¸ƒå°”å€¼çš„å¯è§‚å¯Ÿå€¼ã€‚åœ¨`Observable.create`å†…ï¼Œæˆ‘ä»¬ä½¿ç”¨é˜¿æ³¢ç½—çš„`query`æ–¹æ³•ã€‚æ­¤æ–¹æ³•æ¥æ”¶å±æ€§`query`å’Œå¯é€‰å±æ€§`variables`ã€‚åœ¨`query`ç‰©ä¸šæˆ‘ä»¬è¿›è¡Œå’¨è¯¢ã€‚æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬ç”¨ GraphQL å£°æ˜äº†ä¸€ä¸ªåä¸º`$email`çš„å˜é‡ï¼Œè¯¥å˜é‡å°†åœ¨å±æ€§`variables` :
ä¸­ç»™å‡ºä¸€ä¸ªå€¼

```
variables: { email } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¶å€¼ä»…ä¸ºæ¯ä¸ªå‚æ•°æ”¶åˆ°çš„ç”µå­é‚®ä»¶çš„å˜é‡ã€‚æ­¤æŸ¥è¯¢å°†è¿”å›ä¸€ä¸ªæˆ‘ä»¬è®¢é˜…ä»¥è·å¾—â€œ`data.user`â€çš„è§‚æµ‹å€¼ï¼Œè¿™å°†æ˜¯æˆ‘ä»¬è·å¾—çš„ç­”æ¡ˆæ‰€åœ¨ã€‚

æ­¤æŸ¥è¯¢å°†é€šè¿‡ç”µå­é‚®ä»¶æœç´¢ç”¨æˆ·ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›ç”¨æˆ·ï¼Œå¦åˆ™è¿”å› nullã€‚

### [](#importaci%C3%B3n-del-servicio)æœåŠ¡è¿›å£

ç°åœ¨è¯·åŠ¡å¿…å°†æœåŠ¡è¾“å…¥åˆ°`SignupModule` :

```
@NgModule({
  declarations: [
    SignupComponent
  ],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    InputModule,
    ButtonModule
  ],
  exports: [
    SignupComponent
  ],
  providers: [SignupService] // <--- aquÃ­
})
export class SignupModule { } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬æŠŠå®ƒæ³¨å…¥æˆ‘ä»¬çš„`SignupComponent` :

```
constructor(
  private fb: FormBuilder,
  private ss: SignupService // nuevo parÃ¡metro
) {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±è¿™æ ·äº†ã€‚æˆ‘ä»¬ç°åœ¨å‡†å¤‡ä½¿ç”¨è¯¥æœåŠ¡ã€‚ğŸ˜‰

## [](#consumiendo-nuestra-api)æ¶ˆè´¹æˆ‘ä»¬çš„ API

ä¸€æ—¦æˆ‘ä»¬çš„æœåŠ¡å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å°±å¼€å§‹ä½¿ç”¨æ‚¨çš„æ–¹æ³•`checkForExists`è¿›è¡ŒéªŒè¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`validateEmailNotTaken`çš„æ–¹æ³•ï¼Œå®ƒå°†æˆä¸ºæˆ‘ä»¬çš„éªŒè¯è€…ã€‚

```
validateEmailNotTaken(ctrl: AbstractControl) {
    return (
      this
        .ss
        .checkForExists(ctrl.value)
        .pipe(map(taken => taken ? { taken: true } : null))
    )
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ä»»ä½•éªŒè¯å‡½æ•°ä¸€æ ·ï¼Œæ­¤æ–¹æ³•æ¥å—ç±»å‹ä¸ºâ€œ`AbstractControl`â€çš„å‚æ•°ï¼Œè¯¥å‚æ•°æŒ‡å…¶æ§åˆ¶çš„æ§ä»¶ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºâ€œ`email`â€ã€‚æˆ‘ä»¬è¿è¡Œæ–¹æ³•`checkForExists`ï¼Œå°†æ‚¨åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥çš„ç”µå­é‚®ä»¶ä¼ é€’ç»™æ‚¨ã€‚ä¸€æ—¦æ‰§è¡Œï¼Œæˆ‘ä»¬åˆ¶ä½œä¸€å¼ *åœ°å›¾*çš„å¯è§‚æµ‹æ€§ï¼Œä»¥ä¾¿æŠŠååº”è½¬åŒ–ä¸ºä¸ªæ€§åŒ–çš„ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†å¸ƒå°”ç­”æ¡ˆï¼Œå³æ˜¯å¦å­˜åœ¨ç”¨æˆ·ã€‚æœ€åï¼Œå¦‚æœå­˜åœ¨ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªå¯¹è±¡`{ taken: true }`ï¼Œè¯¥å¯¹è±¡å°†è¢«æ·»åŠ åˆ°çª—ä½“æ§ä»¶çš„ errors å¯¹è±¡ä¸­ï¼Œæ¨¡æ¿å¯ä»¥è®¿é—®è¯¥å¯¹è±¡ã€‚å¦åˆ™ï¼Œä»…è¿”å› nullã€‚

æœ€åï¼Œæˆ‘ä»¬å°†éªŒè¯å™¨æ·»åŠ åˆ°æ§ä»¶çš„å¼‚æ­¥éªŒè¯å™¨é˜µåˆ—`email` :

```
ngOnInit() {
    this.suForm = this.fb.group({
      email: new FormControl('', [
        Validators.required,
        Validators.email
      ], [ // lo agregamos aquÃ­
        this.validateEmailNotTaken.bind(this)
      ]),
      password: new FormControl('', [
        Validators.required,
        Validators.pattern('^(?=.*[0-9])(?=.*[a-zA-Z])([a-zA-Z0-9]+)$')
      ])
    })
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœè¿è¡Œåº”ç”¨ç¨‹åºå¹¶è¾“å…¥ä»¥å‰ä¿å­˜çš„ç”µå­é‚®ä»¶ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯:

[![](../Images/e891799870d4986921e8ebd8b1091656.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--2TP8JWQO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i.imgur.com/qTrd7Xi.png)

âˆå¤©å•Šï¼æˆ‘ä»¬å·²ç»å®Œå…¨éªŒè¯äº†æˆ‘ä»¬çš„è¡¨æ ¼ã€‚ğŸ˜

## [](#registrando-el-usuario)æ³¨å†Œç”¨æˆ·

æˆ‘ä»¬å·²ç»æœ‰äº†éªŒè¯ï¼Œå¦‚æœæ‰€æœ‰éªŒè¯éƒ½é€šè¿‡äº†ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦æ³¨å†Œç”¨æˆ·ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è½¬åˆ°`signup.service.ts`å¹¶åŠ å…¥ä»¥ä¸‹æ–¹æ³•:

```
 /**
   * 
   * @param data | User information of the user
   * @returns User the recently created user
   */
  public register(data: User): Observable<User> {
    return Observable.create((sub: Subscriber<User>) => {
      this.apollo.mutate({
        mutation: gql`
          mutation Register($data: UserInput!) {
            createUser(data: $data) {
              id,
              email
            }
          }
        `,
        variables: { data }
      })
      .subscribe((value: ApolloQueryResult<any>) => {
        const created: User = value.data.createUser
        sub.next(created)
        sub.complete()
      })
    })
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç§æ–¹æ³•ä¸æˆ‘ä»¬å…ˆå‰çš„æŸ¥è¯¢ç±»ä¼¼ã€‚å¾—åˆ°ä¸€ä¸ªç±»å‹ä¸º`User`çš„å¼•æ•°ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ª`Observable<User>`ã€‚åœ¨`Observable.create`å†…ï¼Œæˆ‘ä»¬è¿è¡Œé˜¿æ³¢ç½—çš„`mutate`æ–¹æ³•æ¥æ‰§è¡Œ*çªå˜*ï¼Œå¹¶ä½œä¸ºå˜é‡`$data`ä¼ é€’ç»™å®ƒï¼Œå³æˆ‘ä»¬æ”¶åˆ°çš„`User`ç‰©ä½“ã€‚æœ€åï¼Œæˆ‘ä»¬è®¢é˜…äº† Observableï¼Œä»æ‚¨åˆ›å»ºçš„ç”¨æˆ·å¤„è·å–ä¿¡æ¯å¹¶å°†å…¶å‘é€å‡ºå»ã€‚

è¿™ç§æ–¹æ³•æ˜¯ä»`SignupComponent`çš„`submit`æ–¹æ³•è°ƒç”¨çš„ï¼Œè¯¥æ–¹æ³•å°†åœ¨çª—ä½“çš„`submit`äº‹ä»¶ä¸­è§¦å‘ã€‚æ–°æ–¹æ³•`signup`å¦‚ä¸‹:

```
public signup() {
    const user = new User
    user.email = this.email.value
    user.password = this.password.value
    // agregamos esto
    this.ss.register(user).subscribe((created: User) => {
      alert('Registro exitoso')
      this.suForm.reset()
    })
  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦æˆ‘ä»¬å»ºç«‹äº†ç”¨æˆ·æ•°æ®ï¼Œæˆ‘ä»¬æŠŠå®ƒä¼ ç»™äº†`register`ï¼Œè¿™ä¸ªäººå°±ä¼šç”¨é˜¿æ³¢ç½—æ‰§è¡Œçªå˜`createUser`ï¼Œç„¶åè¿”å›ç­”æ¡ˆï¼ŒæŠŠå®ƒä¿å­˜åœ¨`User`ç‰©ä½“ä¸Šï¼Œå†è¿”å›ç»™è§‚å¯Ÿè€…ã€‚å¦‚æœè®¢é˜…ï¼Œåˆ™æ–°åˆ›å»ºçš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ã€‚æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨`FormGroup#reset`æ–¹æ³•é‡ç½®æ§ä»¶å€¼ã€‚

å°±è¿™æ ·äº†ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†å®Œæ•´çš„è¡¨æ ¼ã€‚ğŸ˜‰

è¯·è®°ä½ï¼Œä»£ç å¯åœ¨â€œ[github](https://github.com/gugadev/graphql-ng-signup)ä¸Šæ‰¾åˆ°ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ï¼*