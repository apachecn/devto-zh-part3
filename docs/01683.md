# æ‰©å±• Saturn ä»¥æ”¯æŒåŸºæœ¬è®¤è¯

> åŸæ–‡:[https://dev . to/azure/extending-Saturn-to-support-basic-authentic ation-3ip 1](https://dev.to/azure/extending-saturn-to-support-basic-authentication-3ip1)

æœ€è¿‘ï¼Œæˆ‘éœ€è¦ä¸ºä¸€ä¸ªé¡¹ç›®çš„æœ¬åœ°å¼€å‘åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿ APIï¼Œæˆ‘å†³å®šä½¿ç”¨ [Saturn](https://saturnframework.org/) ï¼Œå®ƒæ˜¯è¿™æ ·æè¿°è‡ªå·±çš„:

> ä¸€ä¸ªå…³æ³¨å¼€å‘äººå‘˜ç”Ÿäº§åŠ›ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§çš„ç°ä»£ web æ¡†æ¶

Saturn æ˜¯ç”¨ F#å†™çš„ï¼Œå¦‚æœæ•´ä¸ªé¡¹ç›®éƒ½æ˜¯ F#çš„è¯ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªåˆç†çš„é€‰æ‹©ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª[å…¥é—¨](https://saturnframework.org/docs/guides/how-to-start/)æŒ‡å—ï¼Œæ‰€ä»¥æˆ‘å°±ä¸èµ˜è¿°äº†ï¼Œç›¸åæˆ‘ä¼šæŠŠé‡ç‚¹æ”¾åœ¨è¿™ä¸ªé¡¹ç›®ç‰¹åˆ«éœ€è¦çš„ä¸œè¥¿ä¸Šï¼ŒåŸºæœ¬è®¤è¯ï¼Œå› ä¸ºæˆ‘å˜²ç¬‘çš„ API åœ¨å¹•åä½¿ç”¨äº†å®ƒï¼Œæˆ‘æƒ³æ¨¡æ‹Ÿå®ƒã€‚

## [](#extending-saturn-applications)æ‰©å±•åœŸæ˜Ÿåº”ç”¨

ä»æ¦‚å¿µä¸Šè®²ï¼ŒSaturn ä½¿ç”¨[è®¡ç®—è¡¨è¾¾å¼](https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions?WT.mc_id=devto-blog-aapowell)æŠ½è±¡å‡º ASP.NET ç®¡é“ï¼Œç»™ä½ ä¸€ä¸ªéå¸¸æ¸…æ™°çš„ F#è¯­æ³•æ¥å®šä¹‰ä½ çš„åº”ç”¨ã€‚

æˆ‘æƒ³è®©åº”ç”¨ç¨‹åºå®šä¹‰åƒè¿™æ ·å·¥ä½œ:

```
let app = application {
    use_basic_auth
    // the rest of our app setup
    url (sprintf "http://0.0.0.0:%d/" port) } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ˜ŸæœŸå…­`ApplicationBuilder`åˆ›å»ºä¸€ä¸ª[è‡ªå®šä¹‰æ“ä½œ](https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions?WT.mc_id=aaronpowell-blog-aapowell#custom-operations)ã€‚è°¢å¤©è°¢åœ°ï¼ŒF#ä½¿å¾—æ‰©å±•ä½ ä¸æ‹¥æœ‰çš„ç±»å‹å˜å¾—éå¸¸å®¹æ˜“ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§:

```
type ApplicationBuilder with
    [<CustomOperationAttribute("use_basic_auth")>]
    member __.UseBasicAuth(state : ApplicationState) =
        state 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†åœ¨`application`è®¡ç®—è¡¨è¾¾å¼ä¸Šå®šä¹‰æˆ‘ä»¬çš„æ–°å±æ€§ï¼Œå¹¶å°†å…¶å‘½åä¸º`use_basic_auth`ï¼Œå®ƒå°†æ‰§è¡Œå·²å®šä¹‰çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç­¾åä¸º`ApplicationState -> ApplicationState`ã€‚

### [](#adding-middleware)æ·»åŠ ä¸­é—´ä»¶

æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ç¼–è¾‘ Saturn ä½¿ç”¨çš„ä¸­é—´ä»¶ï¼Œä»¥åŒ…å«èº«ä»½éªŒè¯ï¼Œç”±äºå®ƒæ˜¯ ASP.NET æ ¸å¿ƒï¼Œæˆ‘ä»¬éœ€è¦[æ·»åŠ å®ƒçš„èº«ä»½ä¸­é—´ä»¶](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2&tabs=visual-studio&WT.mc_id=devto-blog-aapowell)ã€‚è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„`UserBasicAuth`å‡½æ•°:

```
type ApplicationBuilder with
    [<CustomOperationAttribute("use_basic_auth")>]
    member __.UseBasicAuth state =
        let middleware (app : IApplicationBuilder) =
            app.UseAuthentication()

        { state with
            AppConfigs = middleware::state.AppConfigs } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£å¾ˆå®¹æ˜“ï¼æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸º`middleware`çš„æ–°å‡½æ•°ï¼Œå®ƒå°†è®¤è¯ä¸­é—´ä»¶æ·»åŠ åˆ°ç®¡é“ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`::` List å‡½æ•°å°†æˆ‘ä»¬çš„ä¸­é—´ä»¶æ·»åŠ åˆ°ä¸­é—´ä»¶é›†åˆçš„`head`ä¸­ï¼Œå¹¶ä½¿ç”¨å½“å‰çš„`ApplicationState`åˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•ç±»å‹ï¼Œåªéœ€æ›´æ–°`AppConfigs`å±æ€§ã€‚

### [](#implementing-basic-authentication)å®ç°åŸºæœ¬è®¤è¯

åœ¨æˆ‘ä»¬çš„ç®¡é“ä¸­å¯ç”¨äº†èº«ä»½éªŒè¯ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥éœ€è¦å‘Šè¯‰å®ƒæˆ‘ä»¬æƒ³è¦ä½¿ç”¨å“ªç§èº«ä»½éªŒè¯ï¼Œä»¥åŠå¦‚ä½•å®é™…å¤„ç†å®ƒï¼

```
type ApplicationBuilder with
    [<CustomOperationAttribute("use_basic_auth")>]
    member __.UseBasicAuth state =
        let middleware (app : IApplicationBuilder) =
            app.UseAuthentication()

        let service (s : IServiceCollection) =
            s.AddAuthentication("BasicAuthentication")
                .AddScheme<AuthenticationSchemeOptions, BasicAuthHandler>("BasicAuthentication", null)
                |> ignore

            s.AddTransient<IUserService, UserService>() |> ignore
            s

        { state with
            ServicesConfig = service::state.ServicesConfig
            AppConfigs = middleware::state.AppConfigs } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª`service`å‡½æ•°ï¼Œå®ƒæ¥å—`IServiceCollection`ï¼Œæ·»åŠ è®¤è¯æœåŠ¡ä½œä¸º`BasicAuthentication`(å› æ­¤ç®¡é“çŸ¥é“å®ƒæ˜¯é‚£ä¸ªç±»å‹)ï¼Œæ·»åŠ å¤„ç†ç¨‹åº(ä¸€ä¸ªç§°ä¸º`BasicAuthHandler`çš„ç±»å‹)ï¼Œå¹¶ä¸”è¿˜åœ¨ä¾èµ–æ³¨å…¥æ¡†æ¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªç±»å‹æ¥è®¿é—®æˆ‘ä»¬çš„ç”¨æˆ·ã€‚ç„¶åï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªæ–°å‡½æ•°ä¿®æ”¹æˆ‘ä»¬çš„è®°å½•ç±»å‹ï¼Œä¸€åˆ‡å°±ç»ªï¼

#### [](#implementing-the-basic-authentication-handler)å®ç°åŸºæœ¬è®¤è¯å¤„ç†ç¨‹åº

å¥½äº†ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰*å®Œå…¨*å®Œæˆï¼Œæˆ‘ä»¬åº”è¯¥çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•åœ¨`BasicAuthHandler`ç±»å‹ä¸­å®é™…å®ç°åŸºæœ¬çš„è®¤è¯å¤„ç†å™¨ï¼Œä»¥åŠæˆ‘ä»¬çš„ç”¨æˆ·å­˜å‚¨ã€‚

è®©æˆ‘ä»¬ä»ç”¨æˆ·å­˜å‚¨å¼€å§‹ï¼Œå› ä¸ºæˆ‘å·²ç»åšå¾—å¾ˆç®€å•äº†ï¼Œæ¯•ç«Ÿï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿ:

```
type IUserService =
    abstract member AuthenticateAsync : string -> string -> Async<bool>

type UserService() =
    let users = [("aaron", "password")] |> Map.ofList

    interface IUserService with
        member __.AuthenticateAsync username password =
            async {
                return match users.TryGetValue username with
                       | (true, user) when user = password -> true
                       | _ -> false } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜¯çš„ï¼Œè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆç²¾å½©çš„ï¼Œæˆ‘åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ï¼Œåœ¨å†…å­˜ä¸­æµ‹è¯•ç”¨æˆ·å’Œå¯†ç ã€‚åœ¨éæ¨¡æ‹Ÿç³»ç»Ÿä¸­ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æ›´å®‰å…¨åœ°å®ç°å®ƒï¼Œä½†å®ƒç¡®å®æ»¡è¶³äº†æˆ‘ç°åœ¨çš„éœ€æ±‚ã€‚ğŸ˜‰æˆ‘è¿˜å°†å®ƒåˆ›å»ºä¸ºä¸€ä¸ªæ¥å£ï¼Œè¿™æ ·æˆ‘å¯ä»¥å‘ä¸‹æ³¨å…¥å®ƒï¼Œæˆ–è€…å¦‚æœæˆ‘è¦ç¼–å†™æµ‹è¯•ï¼Œæˆ‘å¯ä»¥æ¨¡ä»¿å®ƒ( *Narator:ä»–æ²¡æœ‰ç¼–å†™æµ‹è¯•*)ã€‚

æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ç§æ–¹æ³•æ¥éªŒè¯ç”¨æˆ·çš„å‡­è¯æ˜¯å¦æœ‰æ•ˆï¼Œé‚£ä¹ˆæ˜¯æ—¶å€™å®ç°å¤„ç†è®¤è¯çš„ç±»äº†ï¼Œ`BasicAuthHander` :

```
type BasicAuthHandler(options, logger, encoder, clock, userService : IUserService) =
    inherit AuthenticationHandler<AuthenticationSchemeOptions>(options, logger, encoder, clock) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç§ç±»å‹ä» ASP.NET æ ¸å¿ƒæ¡†æ¶ä¸­çš„`AuthenticationHandler`ç»§æ‰¿è€Œæ¥ï¼Œå¹¶ä¸”éœ€è¦æˆ‘ä»¬å®ç°`HandleAuthenticateAsync`å‡½æ•°æ‰æ˜¯æœ‰ç”¨çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹:

```
type BasicAuthHandler(options, logger, encoder, clock, userService : IUserService) =
    inherit AuthenticationHandler<AuthenticationSchemeOptions>(options, logger, encoder, clock)

    override this.HandleAuthenticateAsync() =
        task { return AuthenticateResult.Fail "Not Implemented" } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*è¡¥å……è¯´æ˜:æˆ‘ä½¿ç”¨ TaskBuilder.fs åŒ…æ¥åˆ›å»ºä¸€ä¸ªä½¿ç”¨`task`è®¡ç®—è¡¨è¾¾å¼çš„`Task<T>`å“åº”ã€‚*

ä½œä¸ºä¸­é—´ä»¶ç®¡é“çš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šæ‰§è¡Œï¼Œæˆ‘éœ€è¦ç¡®ä¿æä¾›äº†`Authorization`å¤´ï¼Œå¹¶ä¸”å…¶ä¸­æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„åŸºæœ¬ Auth ä»¤ç‰Œã€‚è®©æˆ‘ä»¬é¦–å…ˆç¡®ä¿å¤´éƒ¨å­˜åœ¨ä¸€ä¸ª`match`è¡¨è¾¾å¼:

```
override this.HandleAuthenticateAsync() =
    let request = this.Request
    match request.Headers.TryGetValue "Authorization" with
    | (true, headerValue) ->
        task { return AuthenticateResult.Fail("Not implemented") }
    | (false, _) ->
        task { return AuthenticateResult.Fail("Missing Authorization Header") } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¨¡å¼åŒ¹é…å°†æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æœ‰æŠ¥å¤´ï¼Œå¦‚æœæŠ¥å¤´å­˜åœ¨ï¼Œåˆ™è¿›å…¥é€‚å½“çš„å—ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å°†æŒ‘æˆ˜å¤±è´¥ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ª`401`å“åº”ã€‚

ä¸ºäº†éªŒè¯è¿™ä¸ªä»¤ç‰Œï¼Œæˆ‘å°†ä»ä¸€ä¸ªå¿«é€Ÿçš„å‡½æ•°å¼€å§‹è§£åŒ…ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
type Credentials =
     { Username: string
       Password: string }

let getCreds headerValue =
    let value = AuthenticationHeaderValue.Parse headerValue
    let bytes = Convert.FromBase64String value.Parameter
    let creds = (Encoding.UTF8.GetString bytes).Split([|':'|])

    { Username = creds.[0]
      Password = creds.[1] } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†æŠŠç¼–ç åçš„å­—ç¬¦ä¸²è§£ç æˆä¸€ä¸ª`username:password`å¯¹ï¼Œæˆ‘å°†å…¶ä½œä¸ºè®°å½•è¿”å›(æ‚¨å¯ä»¥ä½¿ç”¨åŒ¿åè®°å½•ç±»å‹æˆ–å…ƒç»„ï¼Œå®Œå…¨ç”±æ‚¨å†³å®š)ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨æˆ‘ä»¬çš„`IUserService` :
æ¥éªŒè¯å®ƒ

```
override this.HandleAuthenticateAsync() =
    let request = this.Request
    match request.Headers.TryGetValue "Authorization" with
    | (true, headerValue) ->
        async {
        let creds = getCreds headerValue.[0]

        let! userFound = userService.AuthenticateAsync creds.Username creds.Password

        return match userFound with
                | true ->
                    let claims = [| Claim(ClaimTypes.NameIdentifier, creds.Username); Claim(ClaimTypes.Name, creds.Username) |]
                    let identity = ClaimsIdentity(claims, this.Scheme.Name)
                    let principal = ClaimsPrincipal identity
                    let ticket = AuthenticationTicket(principal, this.Scheme.Name)
                    AuthenticateResult.Success ticket
                | false ->
                    AuthenticateResult.Fail("Invalid Username or Password") }
        |> Async.StartAsTask
    | (false, _) ->
        task { return AuthenticateResult.Fail("Missing Authorization Header") } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†ä½¿ç”¨å¦ä¸€ä¸ª`match`æ¥åå¯¹æˆ‘ä»¬çš„`IUserService.AuthenticateAsync`çš„ç»“æœ(å®ƒä½¿ç”¨ F# `async`)ï¼Œå¦‚æœç”¨æˆ·æ˜¯æœ‰æ•ˆçš„ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå£°æ˜ç¥¨ï¼Œå¹¶æˆåŠŸåœ°å°†å®ƒè¿”å›ç»™ç®¡é“ä»¥è¯·æ±‚ç»§ç»­ã€‚

## [](#wiring-it-up-with-our-raw-router-endraw-)ç”¨æˆ‘ä»¬çš„`router`æ¥çº¿

ç°åœ¨æ˜¯æ—¶å€™åœ¨æˆ‘ä»¬æƒ³è¦è¿›è¡Œèº«ä»½éªŒè¯çš„è·¯ç”±ä¸Šæ·»åŠ èº«ä»½éªŒè¯äº†ï¼Œæˆ‘ä»¬ä½¿ç”¨`router`è®¡ç®—è¡¨è¾¾å¼æ¥å®Œæˆã€‚æˆ‘ä»¬å°†ä»ç®¡é“å¼€å§‹:

```
let matchUpUsers : HttpHandler = fun next ctx -> next ctx

let authPipeline = pipeline {
    requires_authentication (Giraffe.Auth.challenge "BasicAuthentication")
    plug matchUpUsers } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†`pipeline`çš„`requires_authentication`å±æ€§è®¾ç½®ä¸ºæ¥è‡ª[é•¿é¢ˆé¹¿](https://github.com/giraffe-fsharp/Giraffe)çš„`BasicAuthentication`æŒ‘æˆ˜(åœŸæ˜Ÿæ„å»ºäºå…¶ä¸Šçš„ç½‘ç»œæ¡†æ¶)ã€‚

æœ€åï¼Œæˆ‘ä»¬çš„`router` :
æ—¶é—´åˆ°äº†

```
let webApp = router {
    pipe_through authPipeline
    // define routes
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#conclusion)ç»“è®º

Saturn çš„è®¡ç®—è¡¨è¾¾å¼è®¾è®¡éå¸¸ç®€æ´ï¼Œäº‹å®ä¸Šï¼Œæ‚¨åªéœ€æ‰©å±•è¡¨ç¤ºæ‚¨æƒ³è¦æ‰©å±•çš„ Saturn éƒ¨åˆ†çš„ç±»å‹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“åœ°æ·»åŠ ä¸€ä¸ªå®šåˆ¶çš„èº«ä»½éªŒè¯æä¾›è€…ã€‚

å¸Œæœ›è¿™èƒ½å¸®åŠ©å…¶ä»–äººæ‰©å±•åœŸæ˜Ÿã€‚ğŸ˜Š