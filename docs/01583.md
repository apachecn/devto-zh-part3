# ä½¿ç”¨ Airtable ç¬¬ 1 éƒ¨åˆ†åˆ›å»ºç”¨æˆ·æ•°æ®åº“

> åŸæ–‡:[https://dev . to/cjwd/creating-a-user-database-with-air table-part-1-44ij](https://dev.to/cjwd/creating-a-user-database-with-airtable-part-1-44ij)

æˆ‘ä»¥å‰å†™è¿‡ä¸€ç¯‡å…³äºå¦‚ä½•é€šè¿‡å”¯ä¸€å­—æ®µå€¼å¦‚ç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åä» Airtable è·å–è®°å½•çš„æ–‡ç« ã€‚æˆ‘å°†ä½¿ç”¨ä¸€ä¸ªå®é™…çš„ä¾‹å­â€”â€”ç”¨æˆ·æ•°æ®åº“â€”â€”æ¥è¯¦ç»†è¯´æ˜è¿™ä¸€ç‚¹ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Airtable ä½œä¸ºåç«¯æ„å»ºåº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½ä¼šæ´¾ä¸Šç”¨åœºã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæˆ‘åˆ›å»ºçš„ç¤ºä¾‹ç”¨æˆ·æ•°æ®åº“ã€‚

[ç¤ºä¾‹ç”¨æˆ·æ•°æ®åº“](https://airtable.com/shrlcd86mTnOvSC1m)

## [](#just-want-the-code)åªæ˜¯æƒ³è¦ä»£ç ï¼Ÿ

åœ¨ [Github](https://github.com/cjwd/user-database-airtable-tut) ä¸Šè·å¾—å®Œæ•´çš„å·¥ä½œæ¼”ç¤ºã€‚å¦‚æœæ‚¨æƒ³ç»§ç»­ï¼Œä¸‹è½½ starter files æ–‡ä»¶å¤¹ï¼Œå¹¶å°†å…¶é‡å‘½åä¸ºæ‚¨æƒ³è¦çš„åç§°ï¼Œç„¶åè¿è¡Œ yarn æ¥å®‰è£…ä¾èµ–é¡¹ã€‚

èµ·å§‹æ–‡ä»¶å·²ç»æœ‰äº†åº”ç”¨ç¨‹åºçš„åŸºæœ¬æ¡†æ¶ï¼Œæ¯”å¦‚ç™»å½•å’Œæ³¨å†Œé¡µé¢ï¼Œä»¥åŠæ˜¾ç¤ºè¿™äº›é¡µé¢çš„è·¯å¾„ã€‚æœ¬æ–‡å°†ç€é‡äºæ„å»ºç”¨äºåˆ›å»ºç”¨æˆ·å’Œå¤„ç†ç™»å½•çš„ç”¨æˆ·æ§åˆ¶å™¨ã€‚

## [](#creating-a-user)åˆ›å»ºç”¨æˆ·

å½“ç”¨æˆ·åœ¨æ³¨å†Œé¡µé¢ä¸Šæäº¤ä»–ä»¬çš„ä¿¡æ¯æ—¶ï¼Œå®ƒå°†å‘/user/add è·¯ç”±å‘é€ä¸€ä¸ª post è¯·æ±‚ã€‚è¿™å·²åœ¨æ³¨å†Œè¡¨çš„ action å±æ€§ä¸­æŒ‡å®šã€‚è®©æˆ‘ä»¬é¦–å…ˆåœ¨ index.js æ–‡ä»¶ä¸­ä¸ºè¿™ä¸ª post è¯·æ±‚åˆ›å»ºä¸€ä¸ªè·¯ç”±ã€‚

```
// index.js
router.post("/user/add", userController.addUser); 
```

å½“ç”¨æˆ·å‘è¯¥è·¯ç”±å‘é€è¯·æ±‚æ—¶ï¼Œå®ƒå°†è°ƒç”¨ userController.js ä¸­çš„ addUser å‡½æ•°ã€‚

```
// userController.js

exports.addUser = (req, res, next) => {
  const { fullname, email, username } = req.body;

  table.create(
    {
      email,
      username,
      display_name: fullname
    },
    function(err, record) {
      if (err) {
        console.error(err);
        return;
      }
      req.body.id = record.getId();
      // store password
    }
  );
}; 
```

æˆ‘ä»¬ä½¿ç”¨ Airtable çš„ create æ–¹æ³•æ¥åˆ›å»ºè®°å½•ã€‚æ³¨æ„ï¼Œæˆ‘æ²¡æœ‰åŒ…æ‹¬å¯†ç å­—æ®µï¼Œå› ä¸ºåœ¨å°†å¯†ç ä¿å­˜åˆ°æ•°æ®åº“ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤æ¥æ•£åˆ—å¯†ç ã€‚æˆ‘ä»¬ç¨åä¼šè°ˆåˆ°è¿™ä¸€ç‚¹ã€‚

## [](#add-a-constraint-to-the-email-and-username-fields)ä¸ºç”µå­é‚®ä»¶å’Œç”¨æˆ·åå­—æ®µæ·»åŠ çº¦æŸ

æˆ‘ä»¬åœ¨æ·»åŠ ç”¨æˆ·æ—¶é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°æ®åº“ä¸­å·²ç»å­˜åœ¨çš„ç”µå­é‚®ä»¶åœ°å€å’Œç”¨æˆ·åæ·»åŠ å¦ä¸€ä¸ªç”¨æˆ·ã€‚Airtable ç›®å‰æ²¡æœ‰ä¸ºå­—æ®µè®¾ç½®çº¦æŸçš„åŠŸèƒ½ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ API ä»ä»£ç ä¸­å®ç°ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåŠ©æ‰‹å‡½æ•°ï¼Œå®ƒå°†æ ¹æ®ç”¨æˆ·æ˜¯å¦å­˜åœ¨è¿”å› true æˆ– falseã€‚

```
// userController.js

const findUser = async (email, username) => {
  let recordExists = false;
  const options = {
    filterByFormula: `OR(email = '${email}', username = '${username}')`
  };

  const users = await data.getAirtableRecords(table, options);

  users.filter(user => {
    if (user.get("email") === email || user.get("username") === username) {
      return (recordExists = true);
    }
    return (recordExists = false);
  });

  return recordExists;
}; 
```

ç„¶åæˆ‘ä»¬éœ€è¦ä» addUser å‡½æ•°ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œåªæœ‰å½“å®ƒè¿”å› true æ—¶æˆ‘ä»¬æ‰åˆ›å»ºç”¨æˆ·ï¼Œå¦åˆ™æˆ‘ä»¬ç”¨ä¸€æ¡æ¶ˆæ¯æ˜¾ç¤ºç™»å½•é¡µé¢ã€‚addUser å‡½æ•°ç°åœ¨å˜æˆäº†ã€‚

```
// userController.js

exports.addUser = async (req, res, next) => {
  const { fullname, email, username } = req.body;

  const userExists = await findUser(email, username);

  if (userExists) {
    res.render("login", {
      message: "Username or Email already exists!"
    });
    return;
  }

  table.create(
    {
      email,
      username,
      display_name: fullname
    },
    function(err, record) {
      if (err) {
        console.error(err);
        return;
      }
      req.body.id = record.getId();
      next();
    }
  );
}; 
```

## [](#storing-the-users-password)å­˜å‚¨ç”¨æˆ·çš„å¯†ç 

æˆ‘ä»¬æ­£åœ¨æˆåŠŸåˆ›å»ºç”¨æˆ·è®°å½•ï¼Œä½†æˆ‘ä»¬ä¸ä¼šå­˜å‚¨ç”¨æˆ·çš„å¯†ç ã€‚æˆ‘ä»¬å¯ä»¥å­˜å‚¨è¾“å…¥çš„çº¯æ–‡æœ¬å¯†ç ï¼Œä½†æ˜¾ç„¶è¿™æ ·ä¸å¥½ã€‚æˆ‘å°†ä½¿ç”¨ bcrypt åŒ…æ•£åˆ—ç”¨æˆ·çš„çº¯æ–‡æœ¬å¯†ç ï¼Œå¹¶å°†æ•£åˆ—åçš„å¯†ç å­˜å‚¨åœ¨ Airtable base ä¸­ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… bcrypt npm åŒ…ï¼Œå¹¶åœ¨ userController.js æ–‡ä»¶ä¸­éœ€è¦å®ƒã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ starter æ–‡ä»¶ï¼Œè¿™å·²ç»ä¸ºæ‚¨å®Œæˆäº†ã€‚

ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥åˆ›å»ºæ•£åˆ—å¯†ç ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æ–°åˆ›å»ºçš„ç”¨æˆ·è®°å½•ä¸­ã€‚ç”±äºç”¨æˆ·è®°å½•å·²ç»åˆ›å»ºï¼Œæˆ‘ä»¬éœ€è¦*æ›´æ–°*ç”¨æˆ·è®°å½•ä»¥æ·»åŠ å¯†ç ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Airtable çš„æ›´æ–°æ–¹æ³•ã€‚

```
// userController.js

exports.storePassword = (req, res) => {
  const { password, id } = req.body;

  bcrypt.hash(password, 10, function(err, hash) {
    if (err) {
      console.error(err);
      return;
    }

    table.update(
      id,
      {
        password: hash
      },
      function(err) {
        if (err) {
          console.error(err);
          return;
        }
        res.render("login", {
          message: "Your account has been created!"
        });
      }
    );
  });
}; 
```

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ addUser å‡½æ•°ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºè®°å½•åç«‹å³è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—®ç”¨æˆ·çš„ç”µå­é‚®ä»¶å’Œå¯†ç ã€‚è¿™æ ·åšå°†ä¿®æ”¹è·¯ç”±ä»¥åœ¨ addUser ä¹‹åè°ƒç”¨ storePassword å‡½æ•°ï¼Œå¹¶åœ¨ addUser å‡½æ•°ä¸­åˆ›å»ºè®°å½•æ—¶è°ƒç”¨ next()æ¥è°ƒç”¨æˆ‘ä»¬çš„è·¯ç”±é“¾ä¸­çš„ä¸‹ä¸€ä¸ªå‡½æ•° storePassword å‡½æ•°ã€‚

```
// index.js
router.post("/user/add", userController.addUser, userController.storePassword); 
```

```
// userController.js
exports.addUser = (req, res, next) => {
  const { fullname, email, username } = req.body;

  const userExists = await findUser(email, username);

  if (userExists) {
    res.render("login", {
      message: "Username or Email already exists!"
    });
    return;
  }

  table.create(
    {
      email,
      username,
      display_name: fullname
    },
    function(err, record) {
      if (err) {
        console.error(err);
        return;
      }
      req.body.id = record.getId();
      // The user has been successfully create, let's encrypt and store their password
      next();
    }
  );
}; 
```

## [](#logging-the-user-in)ç™»å½•ç”¨æˆ·

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºç”¨æˆ·ç™»å½•çš„æµç¨‹ã€‚ç™»å½•è¡¨å•å‘è¯¥è·¯ç”±/ç”¨æˆ·/æˆæƒå‘é€ä¸€ä¸ª post è¯·æ±‚ã€‚

```
// index.js
router.post("/user/auth", userController.authenticate); 
```

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º authenticate çš„åŠŸèƒ½ï¼Œé€šè¿‡ç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åæ‰¾åˆ°ç”¨æˆ·ï¼Œå¹¶æ¯”è¾ƒå¯†ç æ¥å†³å®šæ˜¯å¦è®©ç”¨æˆ·ç™»å½•ã€‚

```
// userController.js
exports.authenticate = (req, res) => {
  const { username, password } = req.body;
  const options = {
    filterByFormula: `OR(email = '${username}', username = '${username}')`
  };

  data
    .getAirtableRecords(table, options)
    .then(users => {
      users.forEach(function(user) {
        bcrypt.compare(password, user.get("password"), function(err, response) {
          if (response) {
            // Passwords match, response = true
            res.render("profile", {
              user: user.fields
            });
          } else {
            // Passwords don't match
            console.log(err);
          }
        });
      });
    })
    .catch(err => {
      console.log(Error(err));
    });
}; 
```

è¿™å°±å®Œæˆäº†ç¬¬ 1 éƒ¨åˆ†ã€‚ä½ å¯ä»¥åœ¨ [Github](https://github.com/cjwd/user-database-airtable-tut) ä¸Šè·å¾—å®Œæ•´çš„å·¥ä½œä»£ç ã€‚
åœ¨ç¬¬ 2 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„ä¼šè¯ï¼Œåœ¨ç”¨æˆ·ç™»å½•æ—¶ä¿å­˜ç”¨æˆ·æ•°æ®ã€‚è¯·å…³æ³¨ç¬¬ 2 éƒ¨åˆ†ğŸ‘€ã€‚