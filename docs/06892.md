# å¦‚ä½•è·å– Go ä¸­çš„ S3 å¯¹è±¡

> [https://dev . to/maurogedoso/how-obtain-un-object-de-S3-en-go-16b1](https://dev.to/maurogestoso/como-obtener-un-objeto-de-s3-en-go-16b1)

*æœ€åˆå‘è¡¨äº[æˆ‘çš„åšå®¢](https://maurogestoso.github.io/blog/2019/como-obtener-un-objeto-de-s3-en-go/)T3]*

*å¯¹äºæœ¬ä¾‹ï¼Œæˆ‘å‡è®¾æ‚¨å·²ç»å®‰è£…äº†`go`ï¼Œå¹¶ä¸”`aws-cli`å·²å®‰è£…å¹¶é…ç½®äº† AWS é…ç½®æ–‡ä»¶ã€‚*

æ­¤ç¤ºä¾‹è¯´æ˜å¦‚ä½•ä½¿ç”¨ Go ä»¥ç¼–ç¨‹æ–¹å¼è·å–å­˜å‚¨åœ¨ AWS 3 ä¸­çš„å¯¹è±¡çš„å†…å®¹ã€‚

è¦åœ¨è®¡ç®—æœºä¸Šéµå¾ªæ­¤ç¤ºä¾‹ï¼Œæ‚¨éœ€è¦:

*   ä¸€ä¸ªæ–°çš„å›´æ£‹é¡¹ç›®
*   aws para goï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½:`go get github.com/aws/aws-sdk-go`
*   S3 çš„â€œ*bucket*ä¸­çš„æ–‡æœ¬æ–‡ä»¶ï¼Œä¾‹å¦‚ JSON å¯¹è±¡ã€‚æŒ‡å‡º*æ¡¶*çš„åç§°å’Œå¯¹è±¡çš„åœ°å€ã€‚

## 1ï¸âƒ£åˆ›å»ºä¸€ä¸ªå®¢æˆ· S3

åœ¨[æœåŠ¡æ–‡æ¡£`s3`](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#New) ä¸­ï¼Œæˆ‘é¦–å…ˆé‡åˆ°çš„æ–¹æ³•ä¹‹ä¸€æ˜¯`New()`ï¼Œå®ƒæ¥æ”¶é…ç½®å¹¶è¿”å›ç±»å‹`*S3`ï¼Œå³æˆ‘ä»¬çš„åˆå§‹åŒ–å®¢æˆ·ã€‚æ­¤å®¢æˆ·å…è®¸æˆ‘ä»¬è®¿é—® S3 çš„æ‰€æœ‰å…¬å…±æ–¹æ³•ã€‚

```
package  main  import  (  "github.com/aws/aws-sdk-go/aws"  "github.com/aws/aws-sdk-go/aws/session"  "github.com/aws/aws-sdk-go/service/s3"  )  func  main()  {  s3Client  :=  s3.New(session.New(),  &aws.Config{  Region:  aws.String("eu-west-1"),  })  } 
```

*   `s3.New()`çš„ç¬¬ä¸€ä¸ªè®ºç‚¹æ˜¯`session`ã€‚å› ä¸ºæˆ‘è¿˜ä¸éœ€è¦å®ƒã€‚
*   `s3.New()`çš„ç¬¬äºŒä¸ªè®ºç‚¹æ˜¯`*aws.Config`å¼çš„ï¼Œè¿™é‡Œå…·ä½“è¯´æ˜äº†æˆ‘æƒ³åœ¨ AWS çš„å“ªä¸ªåœ°åŒºå·¥ä½œã€‚æˆ‘ä¸æ˜ç™½ä¸ºä»€ä¹ˆ SDK ä¸ä»æˆ‘çš„é…ç½®æ–‡ä»¶è®¾ç½®(ä½äºâ€œ`~/.aws/config`â€ä¸­)è‡ªåŠ¨è¯»å–å®ƒ-æˆ‘...ã€‚

## è°ƒç”¨`GetObject()`æ–¹æ³•

ç°åœ¨æˆ‘ä»¬å¯ä»¥è°ƒç”¨`GetObject()`æ–¹æ³•æ¥è·å¾—æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡ã€‚åœ¨[æ–¹æ³•æ–‡ä»¶](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.GetObject)ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æ‚¨æ”¶åˆ°äº†`*GetObjectInput`ç±»å‹çš„å¼•æ•°ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å¯ä»¥æŒ‡å®š*æ¡¶*çš„åç§°ä»¥åŠæˆ‘ä»¬ä¸€å¼€å§‹æŒ‡å‘çš„å¯¹è±¡çš„åœ°å€(å¦‚æœæ‚¨è¿˜æ²¡æœ‰åœ¨ S3 ä¸­åˆ›å»ºå¯¹è±¡ï¼Œç°åœ¨æ˜¯ä¸€ä¸ª

```
package  main  import  (  // ğŸ‘‡ imports nuevos ğŸ‘‡  "fmt"  "log"  // â˜ï¸ imports nuevos ï¸ï¸â˜ï¸  "github.com/aws/aws-sdk-go/aws"  "github.com/aws/aws-sdk-go/aws/session"  "github.com/aws/aws-sdk-go/service/s3"  )  func  main()  {  s3Client  :=  s3.New(session.New(),  &aws.Config{  Region:  aws.String("eu-west-1"),  })  // â˜ï¸ cÃ³digo existente â˜ï¸  // ğŸ‘‡ cÃ³digo nuevo ğŸ‘‡  bucket  :=  "mi-bucket"  key  :=  "ejemplo.json"  result,  err  :=  s3Client.GetObject(&s3.GetObjectInput{  Bucket:  aws.String(bucket),  Key:  aws.String(key),  })  if  err  !=  nil  {  log.Fatal(err)  }  fmt.Println(result)  } 
```

*   AWS ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå°†*å­—ç¬¦ä¸²*è½¬æ¢ä¸ºæ­£ç¡®æ ¼å¼çš„å®ç”¨ç¨‹åºã€‚æˆ‘ä¸å¤ªæ˜ç™½ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥é€šè¿‡*å­—ç¬¦ä¸²ï¼Œä½†ä¼¼ä¹æ˜¯å…¬è®¤çš„åšæ³•(ä»æ–‡çŒ®ä¸­å¤åˆ¶ç²˜è´´)*
**   åœ¨ç»ˆç«¯ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬æ‰“å°çš„ä¸œè¥¿åƒè¿™æ ·:*

```
{
  AcceptRanges: "bytes",
  Body: buffer(0xc0003d6100),
  ContentLength: 116,
  ContentType: "binary/octet-stream",
  ETag: "\"65ae86d6ce8c3139528a137657122255\"",
  LastModified: 2019-04-14 10:35:37 +0000 UTC,
  Metadata: {

  }
} 
```

å¯¹è±¡çš„å†…å®¹åº”è¯¥åœ¨`Body`ä¸‹é¢ï¼Œä½†æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬æ”¶åˆ°äº†ä¸€ä¸ªå«`buffer`çš„ä¸œè¥¿ï¼Œçœ‹èµ·æ¥åƒæ˜¯ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºçš„äºŒè¿›åˆ¶ä¿¡æ¯ã€‚æœ‰æ„æ€

## è§£è¯»ç»“æœ

åœ¨[ç±»å‹çš„æ–‡ä»¶`GetObjectOutput`](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#GetObjectOutput) ä¸­ï¼Œæˆ‘ä»¬ç¡®è®¤ç‰©å“çš„å†…å®¹ä¸º`Body`æ‰€æœ‰ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çœ‹ä¸åˆ°æˆ‘ä»¬åœ¨ S3 çš„æ–‡ä»¶ä¸­ä¿å­˜çš„æ–‡æœ¬å‘¢ï¼Ÿå…³é”®åœ¨äº S3 å¯ä»¥å­˜å‚¨ä»»ä½•æ ¼å¼çš„ä¿¡æ¯ï¼Œå› æ­¤å°†è¿™äº›ä¿¡æ¯è¿”å›åˆ°æ•°å­—é€šä¿¡çš„å…±åŒåˆ†æ¯:äºŒè¿›åˆ¶æ˜¯æœ‰æ„ä¹‰çš„ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„å·¥ä½œæ˜¯è§£é‡Šè¿™äº›ä¿¡æ¯ï¼Œå¹¶ä½¿å…¶æˆä¸ºå¯¹æˆ‘ä»¬æ›´æœ‰ç”¨çš„æ ¼å¼ã€‚

åœ¨æ–‡çŒ®ä¸­æˆ‘ä»¬çœ‹åˆ°`Body`æ˜¯`io.ReadCloser`å‹çš„ã€‚*ç•Œé¢* `io.Reader`æ˜¯ Go ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„ç•Œé¢ä¹‹ä¸€ï¼Œä¾‹å¦‚å®ç°äº†ä»ç¡¬ç›˜è¯»å–æ–‡ä»¶çš„ç»“æœã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œè¿™æ˜¯å®ƒåœ¨å†…å­˜ä¸­å‘ˆç°äºŒè¿›åˆ¶ä¿¡æ¯çš„æ–¹å¼ï¼Œæ˜¯å¯ä»¥é˜…è¯»çš„ã€‚`io.ReadCloser`ç±»å‹æ˜¯æŒ‡å®ç°*`Reader`å’Œ`Closer`ç•Œé¢ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¯»å–ä¿¡æ¯å¹¶å°†å…¶è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ã€‚*

 *ä½ å¯èƒ½ä¼šæƒ³è±¡ï¼Œæˆ‘ä¸æ˜¯ä¸€ä¸ªå›´æ£‹ä¸“å®¶ï¼Œæ‰€ä»¥æˆ‘ä¸ä¼šæ¬ºéª—ä½ :æ­¤æ—¶æˆ‘ç›´æ¥å»é—®å”è°·æ­Œï¼Œå‘ç°äº†[ã€è¿™ä¸ªé—®é¢˜å †ç§¯å¦‚å±±æº¢å‡ºã€‘](https://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go)ã€‚

```
package  main  import  (  "bytes"  "fmt"  "log"  "github.com/aws/aws-sdk-go/aws"  "github.com/aws/aws-sdk-go/aws/session"  "github.com/aws/aws-sdk-go/service/s3"  )  func  main()  {  s3Client  :=  s3.New(session.New(),  &aws.Config{  Region:  aws.String("eu-west-1"),  })  bucket  :=  "mi-bucket"  key  :=  "ejemplo.json"  result,  err  :=  s3Client.GetObject(&s3.GetObjectInput{  Bucket:  aws.String(bucket),  Key:  aws.String(key),  })  if  err  !=  nil  {  log.Fatal(err)  }  // â˜ï¸ cÃ³digo existente â˜ï¸  // ğŸ‘‡ cÃ³digo nuevo ğŸ‘‡  defer  result.Body.Close()  buf  :=  new(bytes.Buffer)  buf.ReadFrom(result.Body)  fmt.Println(buf.String())  } 
```

*   ç”±äº*ç¼“å†²åŒº*å…è®¸å…³é—­(è®°ä½ï¼Œå®ƒè¿˜å®ç°äº†*ç•Œé¢* `Closer`ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åŠŸèƒ½è¿è¡Œç»“æŸæ—¶ä¸`defer`å»¶æœŸã€‚è¿™ä¸æ˜¯å¿…è¦çš„ï¼Œä½†è¿™æ˜¯è‰¯å¥½åšæ³•ã€‚
*   åŒ…`bytes`å…è®¸æˆ‘ä»¬åˆ›å»ºå­—èŠ‚çš„*ç¼“å†²åŒº*ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`ReadFrom`æ–¹æ³•è¯»å–å®ç°*ç•Œé¢*T2ã€‘çš„ä¸œè¥¿ï¼Œå› æ­¤æˆ‘ä»¬ä¼ ç»™äº†`Body`ã€‚
*   `buf.ReadFrom()`çš„ç»“æœä¸è¿”å›è¯»å–çš„ä¿¡æ¯ï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚ä¿¡æ¯åŒ…å«åœ¨æˆ‘ä»¬çš„`buf Buffer`ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`String()`æ–¹æ³•å°†å…¶è½¬æ¢ä¸º`string`

æˆ‘è¦åšçš„ä¸€ä¸ªå¯èƒ½çš„ä¿®æ”¹æ˜¯å°†ä¸‹è½½å¯¹è±¡å†…å®¹çš„åŠŸèƒ½æå–åˆ°å‡½æ•°ä¸­ï¼Œä»¥ä¾¿æ›´æ¸…æ¥šåœ°é˜…è¯»æˆ‘ä»¬ç¨‹åºçš„ä¸»è¦è·¯å¾„:

```
package  main  import  (  "bytes"  "fmt"  "log"  "github.com/aws/aws-sdk-go/aws"  "github.com/aws/aws-sdk-go/aws/session"  "github.com/aws/aws-sdk-go/service/s3"  )  func  main()  {  s3Client  :=  s3.New(session.New(),  &aws.Config{  Region:  aws.String("eu-west-1"),  })  data,  err  :=  downloadS3Data(s3Client,  "mi-bucket",  "ejemplo.json")  if  err  !=  nil  {  log.Fatal(err)  }  fmt.Println(string(data))  }  func  downloadS3Data(s3Client  *s3.S3,  bucket  string,  key  string)  ([]byte,  error)  {  result,  err  :=  s3Client.GetObject(&s3.GetObjectInput{  Bucket:  aws.String(bucket),  Key:  aws.String(key),  })  if  err  !=  nil  {  return  nil,  err  }  defer  result.Body.Close()  fmt.Println(result)  buf  :=  new(bytes.Buffer)  buf.ReadFrom(result.Body)  return  buf.Bytes(),  nil  } 
```

*   çœ‹ S3 çš„å®¢æˆ·å¦‚ä½•ä¼ é€’ç»™è¯¥åŠŸèƒ½ï¼Œè¿™å°†ä½¿æˆ‘ä»¬å°†æ¥èƒ½å¤Ÿâ€œT1â€æµ‹è¯•è¯¥åŠŸèƒ½æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªè™šå‡çš„å®¢æˆ·ï¼Œå¹¶éªŒè¯å®ƒæ˜¯ç”¨æ­£ç¡®çš„è®ºæ®è°ƒç”¨çš„ï¼Œè¿˜æ˜¯ä¼ªé€ ç»“æœï¼Œä»¥ä¾¿æˆ‘ä»¬çš„â€œT2â€æµ‹è¯•â€œâ€ä¸ä¾èµ–å®ƒ
*   æˆ‘è¿˜ä¿®æ”¹äº†åŠŸèƒ½ï¼Œä½¿å‡½æ•°è¿”å›å­—èŠ‚çš„åˆ‡ç‰‡è€Œä¸æ˜¯*å­—ç¬¦ä¸²*ï¼Œè¿™ä½¿å¾—å‡½æ•°åœ¨å¯ä»¥ä¸‹è½½çš„ä¿¡æ¯æ ¼å¼æ–¹é¢æ›´åŠ çµæ´»ã€‚

## ä»…æ­¤è€Œå·²-æˆ‘...ã€‚

æˆ‘å¸Œæœ›è¿™ä¸ªä¾‹å­å¾ˆæœ‰ç”¨ï¼Œæˆ‘éå¸¸å¸®åŠ©è‡ªå·±æ›´å¥½åœ°äº†è§£ Go æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå°¤å…¶æ˜¯ç±»å‹ç³»ç»Ÿå’Œç•Œé¢ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶å‘è¡¨æ„è§

## é“¾æ¥

*   [å…·æœ‰ç¼–ç ](https://gist.github.com/maurogestoso/b437d7f15e8ef45f69d165f0916060a8)çš„ Gist

*   AWS SDK æ–‡æ¡£:

    *   [T2`s3.New()`](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#New)
    *   [T2`GetObject()`](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.GetObject)
    *   [`GetObjectInput`](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#GetObjectInput)/[`GetObjectOutput`T5ã€‘](https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#GetObjectOutput)
*   go æ–‡æ¡£:

    *   [T2`bytes`](https://golang.org/pkg/bytes/)
    *   [T2`Buffer.ReadFrom()`](https://golang.org/pkg/bytes/#Buffer.ReadFrom)

    *   [T2`type Reader`](https://golang.org/pkg/io/#Reader)
    *   [T2`type ReadCloser`](https://golang.org/pkg/io/#ReadCloser)
*   å †æ ˆæº¢å‡º:[cÃ³mo converter un`io.Reader`a un`string`ï¼Ÿ](https://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go)**