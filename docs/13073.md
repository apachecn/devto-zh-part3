# å¾æœå«æœ‰å’–å•¡å› çš„äºšé©¬é€Šé›…å…¸å¨œä¸æ¢…è’‚æ–¯ä¸‰ä»¶å¥—

> åŸæ–‡:[https://dev . to/hrbrmstr/caffeinated-Amazon-Athena-with-the-metis-trio-of-packages-1mb](https://dev.to/hrbrmstr/conquering-caffeinated-amazon-athena-with-the-metis-trio-of-packages-1mgb)

æˆ‘å¿…é¡»åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å¤´æå‡ºä¸€ä¸ªå‡è®¾ï¼Œå¦‚æœä½ æ­£åœ¨ç”¨äºšé©¬é€Šé›…å…¸å¨œåšä»»ä½•äº‹æƒ…ï¼Œä½ åº”è¯¥è®¤çœŸè€ƒè™‘ä½¿ç”¨ä»–ä»¬çš„å…è´¹ ODBC é©±åŠ¨ç¨‹åº,å› ä¸ºè¿™æ˜¯å°†å®ƒä»¬è¿æ¥åˆ° DBI å’Œ tidyverse-wise çš„æœ€ç®€å•çš„æ–¹æ³•ã€‚æˆ‘åœ¨ä¹‹å‰çš„å¸–å­ä¸­å·²ç»[è¯´è¿‡è¿™ä¹ˆå¤šäº†ã€‚å¦‚æœæ‚¨ä¸çŸ¥é“é‡æ–°æ‰“åŒ…æ‰€æä¾›çš„ Linux ODBC é©±åŠ¨ç¨‹åºä»¥åœ¨æ‚¨çš„ Linux é£æ ¼ä¸Šå·¥ä½œçš„å’’è¯­ï¼Œè¯·åœ¨è¯„è®ºä¸­ç•™è¨€ã€‚](https://rud.is/b/2018/04/20/painless-odbc-dplyr-connections-to-amazon-athena-and-apache-drill-with-r-odbc/)

ç„¶è€Œ â€¦

æœ‰æ—¶å€™â€”â€”æ¯”æ–¹è¯´ï¼Œå½“æ‚¨è¯•å›¾åœ¨ kubernetes é›†ç¾¤ä¸­å»ºç«‹ä¸€ä¸ª R æœåŠ¡ï¼Œå°† Athena ä¸­çš„æ•°æ®è¿æ¥åˆ° R ä¸­çš„åˆ†æå’Œå¯è§†åŒ–æ—¶ ODBC é©±åŠ¨ç¨‹åºå¯èƒ½æ˜¯ä¸€ä¸ªéšœç¢è€Œä¸æ˜¯å¸®åŠ©ï¼Œè€Œ JDBC æ˜¯é˜»åŠ›æœ€å°çš„é€”å¾„ã€‚

å½“ç„¶ï¼Œæœ‰ in-CRAN `AWR.Athena`åŒ…ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªç›¸å½“å—çº¦æŸå’Œä½åŠŸèƒ½çš„ RJDBC shimï¼Œå®ƒå®Œæˆäº†åŸºæœ¬çš„å·¥ä½œï¼Œä½†æ²¡æœ‰æ›´å¤šçš„ã€‚

è¾“å…¥:

*   [`metis.jars`](https://git.sr.ht/~hrbrmstr/metis-jars)|[GL](https://gitlab.com/hrbrmstr/metis-jars)|[GH](https://github.com/hrbrmstr/metis-jars)
*   [`metis`](https://git.sr.ht/~hrbrmstr/metis)|[GL](https://gitlab.com/hrbrmstr/metis)|[GH](https://github.com/hrbrmstr/metis)è€Œä¸”ï¼Œ
*   [`metis.tidy`](https://git.sr.ht/~hrbrmstr/metis-tidy)|[GL](https://gitlab.com/hrbrmstr/metis-tidy)|[GH](https://github.com/hrbrmstr/metis-tidy)

ä¸‰ä¸ªè½¯ä»¶åŒ…ï¼Œæ—¨åœ¨å½“ ODBC ä¸å¯ç”¨æ—¶ï¼Œä½¿ R è¿æ¥åˆ° Amazon Athena å˜å¾—è¶…çº§ç®€å•ã€‚

### [](#why-three-packages)ä¸ºä»€ä¹ˆæ˜¯ä¸‰åŒ…ï¼Ÿ

å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œ`metis` -trio æœ‰ç€å·¨å¤§çš„å¸Œæœ›ï¼Œå…¶ä¸­çš„ä¸€ä¸ªå…³é”®éƒ¨åˆ†æ˜¯å°†ç½å­åˆ†æˆä¸€ä¸ªåŒ…(`metis.jars`)å¹¶å°†å®é™…åŠŸèƒ½åˆ†æˆå…¶ä»–åŒ…(`metis`å’Œ`metis.tidy`)ã€‚æˆ‘ä»¬å°†ä¼šçœ‹åˆ° CRAN å°è¯•å¦‚ä½•è¿›è¡Œï¼Œå› ä¸º JAR åŒ…çš„é‡é‡è¶³ä»¥ä¿è¯ä¸€ä¸ª`NOTE`ã€‚é©±åŠ¨ç¨‹åºçš„æ‰“åŒ…å‡å°‘äº†ä½ é¢„åŠ è½½ JAR(æœ¬åœ°åŠ è½½æˆ–è€…åŠ è½½åˆ° Docker é•œåƒä¸­)æˆ–è€…åƒ`AWR.Athena`ä¸€æ ·æ‰§è¡ŒåŒ…å¯åŠ¨çš„ä¸‹è½½èˆè¹ˆçš„éœ€è¦(æˆ‘ä»ç„¶ä¸æ˜ç™½ä¸ºä»€ä¹ˆé™¤äº† _(ãƒ„)_/ä¹‹å¤–ï¼Œå®ƒæ²¡æœ‰åƒ CRAN é‚£æ ·åš)ã€‚

`metis.jars`ä¹Ÿæœ‰ä¸‰ä¸ªåŠ©æ‰‹åŠŸèƒ½ï¼Œåšä¸€äº›(åŸºæœ¬çš„)æœ‰è¶£çš„äº‹æƒ…:

```
library(metis.jars)

simba_driver_version()
## [1] "02.00.06.1008"

athena_supported_types()
## [1] "BOOLEAN" "TINYINT" "SMALLINT" "INT" "INTEGER"  
## [6] "BIGINT" "REAL" "FLOAT" "DOUBLE" "DECIMAL"  
## [11] "DATE" "TIMESTAMP" "BINARY" "VARBINARY" "CHAR"     
## [16] "VARCHAR" "STRING" "ARRAY" "MAP" "ROW"      
## [21] "STRUCT"   

metis_jar_path()
## [1] "/Library/Frameworks/R.framework/Versions/3.5/Resources/library/metis.jars/java/AthenaJDBC42_2.0.6.jar" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬ä¸€ç§ä½¿ç”¨`rJava`æ¥å£ç›´æ¥æŸ¥è¯¢ç‰ˆæœ¬(å› ä¸ºäºšé©¬é€Šä¼¼ä¹ä¸€å¹´æ›´æ–°ä¸¤æ¬¡ Simba JAR)ã€‚é€šè¿‡å°† JAR åˆ†ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„åŒ…ä¸­ï¼Œå¯ä»¥æ›´é¢‘ç¹åœ°å¯¹å…¶ä»–ä¸¤ä¸ªå…„å¼ŸåŒ…è¿›è¡Œæ›´æ–°ï¼Œè€Œä¸ä¼šå ç”¨ CRAN çš„ç£ç›˜ç©ºé—´ã€‚`metis.jars`ä¹Ÿè¢«ç‰ˆæœ¬åŒ–åˆ°åŒ…å«çš„ JAR ä¸­ï¼Œæ‰€ä»¥é…ç½®ç®¡ç†å¯¹äººä»¬æ¥è¯´ä¼šæ›´å®¹æ˜“ã€‚

ç¬¬äºŒä¸ª type-lister å‡½æ•°çš„åŸå› æ˜¯ï¼Œäºšé©¬é€Šæœ‰æœ›å¢åŠ å¯¹æ‰€æœ‰ Presto æ•°æ®ç±»å‹çš„æ”¯æŒï¼Œå°¤å…¶æ˜¯`IPADDRESS`ã€‚å®ƒå†æ¬¡æ‰§è¡Œ JDBC é©±åŠ¨ç¨‹åºè‡ªçœæ¥æ”¶é›†æ”¯æŒçš„ç±»å‹ã€‚

æœ€åï¼Œç¬¬ä¸‰ä¸ªå‡½æ•°ä»`metis`åŒ…ç”šè‡³*ä½ è‡ªå·±çš„*æ¥å£åŒ…ä¸­æŠ½è±¡å‡º JAR ä½ç½®ï¼Œå¦‚æœä½ é€‰æ‹©ä¾èµ–å®ƒçš„è¯ã€‚

### [](#ok-but-why-not-just-two)å¥½å§ï¼Œä½†ä¸ºä»€ä¹ˆä¸åªæ˜¯ä¸¤ä¸ªå‘¢ï¼Ÿ

ä¸`AWR.Athena`ç›¸æ¯”ï¼Œ`metis`åŒ…æ˜¯ DBI åŒ…è£…å™¨çš„ä¸€ä¸ªåŠŸèƒ½æ›´å¼ºçš„ RJDBC è¶…ç±»ã€‚å®ƒåšçš„ä¸€ä»¶äº‹ï¼Œå®ƒçš„å…‹å…°è¡¨äº²ä¸èƒ½æ­£ç¡®å¤„ç†`BIGINT`çš„:

```
library(metis)

dbConnect(
  metis::Athena(),
  Schema = "sampledb",
  AwsCredentialsProviderClass = "com.simba.athena.amazonaws.auth.PropertiesFileCredentialsProvider",
  AwsCredentialsProviderArguments = path.expand("~/.aws/athenaCredentials.props")
) -> con

dbGetQuery(con, "
SELECT
  CAST('chr' AS CHAR(4)) achar,
  CAST('varchr' AS VARCHAR) avarchr,
  CAST(SUBSTR(timestamp, 1, 10) AS DATE) AS tsday,
  CAST(100.1 AS DOUBLE) AS justadbl,
  CAST(127 AS TINYINT) AS asmallint,
  CAST(100 AS INTEGER) AS justanint,
  CAST(100000000000000000 AS BIGINT) AS abigint,
  CAST(('GET' = 'GET') AS BOOLEAN) AS is_get,
  ARRAY[1, 2, 3] AS arr1,
  ARRAY['1', '2, 3', '4'] AS arr2,
  MAP(ARRAY['foo', 'bar'], ARRAY[1, 2]) AS mp,
  CAST(ROW(1, 2.0) AS ROW(x BIGINT, y DOUBLE)) AS rw,
  CAST('{\"a\":1}' AS JSON) js
FROM elb_logs
LIMIT 1
") %>% 
  dplyr::glimpse()
## Observations: 1
## Variables: 13
## $ achar <chr> "chr "
## $ avarchr <chr> "varchr"
## $ tsday <date> 2014-09-29
## $ justadbl <dbl> 100.1
## $ asmallint <int> 127
## $ justanint <int> 100
## $ abigint <S3: integer64> 100000000000000000
## $ is_get <lgl> TRUE
## $ arr1 <chr> "1, 2, 3"
## $ arr2 <chr> "1, 2, 3, 4"
## $ mp <chr> "{bar=2, foo=1}"
## $ rw <chr> "{x=1, y=2.0}"
## $ js <chr> "\"{\\\"a\\\":1}\"" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

~~å¾ˆå¿«~~ Athena æ•°ç»„ã€åœ°å›¾ã€è¡Œå’Œ JSON å°±åƒ Athena é©±åŠ¨ç¨‹åºä¸­çš„å­—ç¬¦ï¼Œå®ƒä»¬çš„æ ¼å¼å¦‚æ­¤ç³Ÿç³•ï¼Œä»¥è‡³äºå®Œå…¨æ”¯æŒå®ƒä»¬çš„`list`åˆ—å‡ ä¹æ²¡æœ‰å¸Œæœ›ã€‚*ä½†æ˜¯*ï¼Œä½ å¯ä»¥ç”¨`metis`å¾—åˆ°çœŸæ­£çš„å¤§æ•´æ•°ï¼ŒåŒæ—¶å®Œå…¨æ”¯æŒæ‰€æœ‰å…¶ä»–å½“å‰çš„ Athena ç±»å‹ã€‚

å¯èƒ½æ˜¯æ—§çš„ã€ç‹¬ç«‹çš„`metis`åŒ…ç”¨æˆ·çš„äººéœ€è¦æ³¨æ„ä¸€äº›äº‹æƒ…ã€‚

ç¬¬ä¸€ï¼Œ`dbConnect()`æœ‰çªç ´æ€§çš„å˜åŒ–ã€‚åœ¨æ›´é«˜çº§çš„`athena_jdbc()`å‡½æ•°ä¸­ä»ç„¶å­˜åœ¨çš„ snake_case åç§°å·²ç»æ²¡æœ‰äº†ã€‚ä½œä¸ºå¯¹è¿™ç§ç—›è‹¦çš„äº¤æ¢ï¼Œä½ ç°åœ¨æ‹¥æœ‰æ‰€æœ‰é›…å…¸å¨œ JDBC è¿æ¥å±æ€§çš„å®Œå…¨å‘½åå¥‡å¶æ ¡éªŒï¼Œå¹¶ä¸”å¯ä»¥æ›´å®¹æ˜“åœ°ä½¿ç”¨æ›¿ä»£å‡­è¯æä¾›è€…ï¼Œè¿™æ˜¯`metis`çš„å ‚å…„[å®Œå…¨ä¸èƒ½ä¸ºä½ ](https://github.com/nfultz/AWR.Athena/blob/master/R/athena.R#L77)åšçš„ï¼Œè¿™åœ¨ä¸Šé¢çš„ä¾‹å­å’Œè½¯ä»¶åŒ…è‡ªè¿°æ–‡ä»¶ä¸­æœ‰æ‰€è¯´æ˜ã€‚

`metis`åŒ…ä¹Ÿä½¿å¾—æŸ¥çœ‹*æ‰€æœ‰*å¯ç”¨çš„ Athena è¿æ¥å±æ€§çš„æ–‡æ¡£å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºå®ƒæœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿™äº›å±æ€§çš„æè¿°æ€§è¡¨æ ¼çš„å°æ’å›¾(è¿™é‡Œå‘ˆç°ä¸º)ã€‚

è¿˜æœ‰å¯¹â€œæµå¼ APIâ€(TLDR:æ›´å¿«çš„ç»“æœé›†ä¸‹è½½)çš„åˆæ­¥æ”¯æŒï¼Œä½†åœ¨æœ¬å‘¨ AWS æ”¿ç­–è°ƒæ•´ä¹‹å‰ï¼Œè¿™ä¸ä¼šå¾—åˆ°å……åˆ†æµ‹è¯•ã€‚

### [](#gotcha-but-srsly-why-not-just-two)æ˜ç™½äº†ã€‚ä½†æ˜¯ï¼Œè¯´çœŸçš„ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸¤ä¸ªå‘¢ï¼Ÿ

å°½ç®¡å¾ˆæ£’(åŒ…æ‹¬åŸºæœ¬çš„ Docker æ˜ åƒæ”¯æŒ),`tidyverse`åœ¨ç¼–è¯‘æ—¶é—´å’Œä¾èµ–æ€§æ–¹é¢å¹¶ä¸æ˜¯æ²¡æœ‰å¼€é”€ï¼Œè¿™ä¸¤è€…åœ¨ Linux ç³»ç»Ÿå’Œä¸€äº› Docker ç¯å¢ƒä¸­å°¤å…¶ä»¤äººç—›è‹¦ã€‚æ‚¨å®Œå…¨å¯ä»¥ä½¿ç”¨ä¸€äº›ç²¾å¿ƒåˆ¶ä½œçš„ SQL å’Œ JDBCï¼Œæ˜ åƒè¶Šè–„ï¼Œå°±è¶Šå®¹æ˜“éƒ¨ç½²å’Œæ‰©å±•ã€‚

ä½†æ˜¯ï¼tidyverse æ˜¯å¦‚æ­¤çš„æœ‰ç”¨ï¼Œä»¥è‡³äºç¡®ä¿å¯¹ Athena çš„æµç•…æ”¯æŒæ˜¯è‡³å…³é‡è¦çš„ã€‚å°±å…¶æœ¬èº«è€Œè¨€ï¼Œ`metis`ç”µçº¿é«˜è¾¾`dplyr` / `dbplyr`å¥½ï¼Œä½†æ˜¯é€šè¿‡(åœ¨`metis.tidy`ä¸­)æä¾›ä¸€äº›å¢å¼ºçš„`db_data_type()`æ”¯æŒ(ä¸»è¦é’ˆå¯¹`BIGINT`)å’Œä¸€äº›é¢å¤–çš„ğŸ’™)å¯¹äºæˆ‘ä»¬è¿™äº›ç»§ç»­åœ¨é R ä¸Šä¸‹æ–‡ä¸­ç›²ç›®ä½¿ç”¨ R-only åŠ¨è¯å¦‚`grep()`æˆ–`as.POSIXct()`çš„äººæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å‡çº§`interactive()`ä½¿ç”¨å’Œ tid yverse-infined æœåŠ¡ä½¿ç”¨:

```
library(metis.tidy)
library(dbplyr)
library(dplyr)

metis::dbConnect(
  metis::Athena(),
  Schema = "sampledb",
  AwsCredentialsProviderClass = "com.simba.athena.amazonaws.auth.PropertiesFileCredentialsProvider",
  AwsCredentialsProviderArguments = path.expand("~/.aws/athenaCredentials.props")
) -> con

elb_logs <- tbl(con, "elb_logs")

filter(elb_logs, grepl("20", elbresponsecode)) %>%
  mutate(
    tsday = as.Date(substring(timestamp, 1L, 10L)),
    host = url_extract_host(url),
    proto_version = regexp_extract(protocol, "([[:digit:]\\.]+)"),
  ) %>%
  select(tsday, host, receivedbytes, requestprocessingtime, proto_version) %>%
  head(1) %>%
  glimpse()
## Observations: ??
## Variables: 5
## Database: AthenaConnection
## $ tsday <date> 2014-09-29
## $ host <chr> "www.abcxyz.com"
## $ receivedbytes <S3: integer64> 0
## $ requestprocessingtime <dbl> 9.5e-05
## $ proto_version <chr> "1.1" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#fin)é³

è¿™ç§å½»åº•é‡æ„çš„ä¸€ä¸ªç›¸å½“å¤§çš„æ¨åŠ¨åŠ›æ˜¯éœ€è¦åœ¨æ— æœåŠ¡å™¨çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ R at $DAYJOB ä¸­çš„é›…å…¸å¨œ JDBC æ¥å£ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘/æˆ‘ä»¬éœ€è¦ï¼Œå…¶ä»–äººä¹Ÿå¯èƒ½éœ€è¦ã€‚æ‰€æœ‰è¿™ä¸‰ä¸ªåŒ…éƒ½ç»è¿‡äº†æµ‹è¯•(ä¸æˆ‘ä¸ªäººçš„ Athena è®¾ç½®ä¸€èµ·å·¥ä½œï¼Œè¯¥è®¾ç½®å¾ˆå®¹æ˜“å¤åˆ¶ï¼Œå› ä¸ºå®ƒåªæ˜¯å¯ç”¨ Athena æ—¶å¾—åˆ°çš„é»˜è®¤æ¨¡å¼å’Œè¡¨)ï¼Œé€šè¿‡äº† CRAN æ£€æŸ¥ï¼Œå¹¶ä¸”åœ¨æ‚¨é˜…è¯»æœ¬æ–‡æ—¶å°†åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ç¡®å®æœ‰è¿™ä¸‰ä¸ªæœ‹å‹çš„ CRAN è®¡åˆ’ï¼Œä½†æ‰€æœ‰ä¸‰ä¸ªåŒ…éœ€è¦åŒæ—¶è¿›å…¥ï¼Œæˆ‘éœ€è¦å¾—åˆ°æµ‹è¯•ï¼Œå¹¶åœ¨æäº¤ä¹‹å‰è¯æ˜æµ‹è¯•åœ¨ç‰¹æ‹‰ç»´æ–¯æ˜¯æ´»çš„ã€‚ç°åœ¨æ˜¯åŠŸèƒ½è¯·æ±‚ã€é—®é¢˜æŠ¥å‘Šæˆ–é—®é¢˜çš„æ—¶å€™äº†ã€‚åœ¨ SourceHut çš„(sr.ht) API å®Œæˆä¹‹å‰ï¼Œè¿™äº›è´¡çŒ®æœ€å¥½ç•™ç»™ GitLab(æœ€å¥½)æˆ– GitHub(å¦‚æœä½ å¿…é¡»ç»§ç»­ä¸ºé‚£äº›æŸå®³ä½ è‡ªç”±çš„å¤§å‹è·¨å›½å…¬å¸æ”¶é’±çš„è¯)ã€‚

### [](#postscript)POSTSCRIPT

é‡è®¿`metis`çš„å¦ä¸€ä¸ªåŸå› æ˜¯[è¿™ä¸ª R å´©æºƒ`rJava`é—®é¢˜](https://github.com/s-u/RJDBC/issues/71)å®é™…ä¸Šæ˜¯ä¸€ä¸ª Simba Athena å®ç°é—®é¢˜(JDBC é©±åŠ¨ä¸­çš„æ“ä½œç³»ç»Ÿä¿¡å·ï¼Œ *rly* ï¼Ÿ)

æœ¬`Rprofile`æ¡ç›®:

```
options(
  "java.parameters" = c(getOption("java.parameters", default = NULL), "-Xrs")
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`rJava`æ›´æ–°ä¹‹å‰ä¸€ç›´æ˜¯ä¸€ä¸ªå¯é çš„è§£å†³æ–¹æ³•ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœ`metis.jars`æ£€æµ‹åˆ°æ‚¨çš„è®¾ç½®å­˜åœ¨é£é™©ï¼Œå®ƒä¼šåœ¨åŠ è½½æ—¶å‘å‡ºè­¦å‘Šã€‚