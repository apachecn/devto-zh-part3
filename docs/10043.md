# å‡½æ•°çš„å®šä¹‰å±æ€§:åœ¨ Jest æˆ– AVA ä¸­åˆ›å»ºæ¨¡æ‹Ÿå¯¹è±¡å®ä¾‹

> åŸæ–‡:[https://dev . to/Hugo _ _ df/JavaScript-object-define property-for-a-function-create-mock-object-instances-in-jest-or-ava-41pi](https://dev.to/hugo__df/javascript-object-defineproperty-for-a-function-create-mock-object-instances-in-jest-or-ava-41pi)

è¿™ç¯‡æ–‡ç« è®²è¿°äº†å¦‚ä½•ä½¿ç”¨`Object.defineProperty`æ¥æ¨¡ä»¿æ„é€ å‡½æ•°å¦‚ä½•åˆ›å»ºæ–¹æ³•ã€‚ä½œä¸ºå‡½æ•°çš„ä¸å¯æšä¸¾å±æ€§ã€‚

`Object.defineProperty`ä¸å‡½æ•°å€¼ä¸€èµ·ä½¿ç”¨çš„è¦ç‚¹å¯ä»¥å½’ç»“ä¸º:

```
const obj = {}

Object.defineProperty(obj, 'yes', { value: () => Math.random() > .5 })

console.log(obj) // {}
console.log(obj.yes()) // false or true depending on the call :D 
```

å¦‚æ‚¨æ‰€è§ï¼Œ`yes`å±æ€§æ²¡æœ‰è¢«æšä¸¾ï¼Œä½†æ˜¯å®ƒç¡®å®å­˜åœ¨ã€‚è¿™å¯¹äºå°†å‡½æ•°è®¾ç½®ä¸ºæ–¹æ³•æ¨¡æ‹Ÿéå¸¸æœ‰ç”¨ã€‚

è¿™å¯¹æµ‹è¯•ä½¿ç”¨ Mongo çš„`ObjectId`è¿™æ ·çš„ä¸œè¥¿çš„ä»£ç å¾ˆæœ‰ç”¨ã€‚æˆ‘ä»¬ä¸å¸Œæœ›å®é™…çš„ ObjectIds æ•£å¸ƒåœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚è™½ç„¶æˆ‘ç¡®å®åˆ›å»ºäº†ä¸€ä¸ªå…è®¸ä½ ç”Ÿæˆ ObjectId å…¼å®¹å€¼çš„åº”ç”¨ç¨‹åº([çœ‹è¿™é‡Œ Mongo ObjectId ç”Ÿæˆå™¨](https://observablehq.com/@hugodf/mongodb-objectid-generator))ã€‚

GitHub[github.com/HugoDF/mock-mongo-object-id](https://github.com/HugoDF/mock-mongo-object-id)ä¸Šæœ‰æ‰€æœ‰çš„æµ‹è¯•å’Œå¯¹æˆ‘ä»¬æ­£åœ¨åšçš„äº‹æƒ…å’Œä¸ºä»€ä¹ˆè¦åšçš„å¿«é€Ÿè§£é‡Šï¼Œåœ¨æˆ‘ä»¬å…‰è£åœ°ä½¿ç”¨`Object.defineProperty`æ—¶è¾¾åˆ°é«˜æ½®ã€‚å¦‚æœä½ æ˜¯ç²‰ä¸ï¼Œå°±æŠŠå®ƒç•™åœ¨æ˜Ÿæ˜Ÿä¸ŠğŸ™‚ã€‚

## [](#testing-mongo-objectid)æµ‹è¯• Mongo ObjectId

æ‚¨åœ¨æŒä¹…å±‚ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œæ‚¨é€šå¸¸å¸Œæœ›ä½¿ç”¨`ObjectId()`æ„é€ å‡½æ•°å°†å­—ç¬¦ä¸²è½¬æ¢æˆ ObjectId

è¯·çœ‹ä¸‹é¢çš„ç‰‡æ®µ:

```
const { ObjectID, MongoClient } = require('mongodb')
const mongoClient = new MongoClient()
async function getUserIdFromSession(sessionId) {
  const session = await (await mongoClient.connect()).collection('sessions').findOne({
    _id: ObjectId(sessionId)
  });

  return session.userId && session.userId.toString();
} 
```

### [](#a-naive-mock)å¤©çœŸçš„å˜²å¼„

ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿå®ç°åº”è¯¥æ˜¯:

```
const mockObjectId = data => data; 
```

æˆ‘ä»¬ä¾èµ–äºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³`.toString`æ–¹æ³•å­˜åœ¨äºå­—ç¬¦ä¸²ä¸Š:

```
'myString'.toString() // 'myString' 
```

é—®é¢˜æ˜¯å®ƒä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒçš„è¡Œä¸ºä¸åŒ

### [](#a-better-mock)æ›´å¥½çš„å˜²å¼„

è¿™å°±æ˜¯æˆ‘ä»¬çš„ä¸‰ä¸ªè¦æ±‚:

*   åº”è¯¥å­˜åœ¨å¹¶è¿”å›ä¼ é€’ç»™æ„é€ å‡½æ•°çš„ä»»ä½•å†…å®¹
*   å®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡
*   `ObjectId('a')`åº”è¯¥æ·±åº¦ç­‰äº`ObjectId('a')`

```
const test = require('ava')
const mockObjectId = data => {
  return {
    name: data,
    toString: () => data
  };
}

test("toString() returns right value", t => {
  t.is(mockObjectId("foo").toString(), "foo");
});
test("it's an object", t => {
  const actual = mockObjectId("foo");
  t.is(typeof actual, "object");
});
test.failing("two objectIds with same value are equal", t => {
  const first = mockObjectId("foo");
  const second = naiveObjectId("foo");
  t.deepEqual(first, second);
}); 
```

å¤±è´¥:

```
Difference:

  {
    name: 'foo',
-   toString: Function toString {},
+   toString: Function toString {},
  } 
```

æ˜¯æ¯ä¸ªæ¨¡æ‹Ÿå®ä¾‹çš„æ–°å‡½æ•°â€¦è¿™æ„å‘³ç€å®ƒä»¬å¹¶ä¸å®Œå…¨ç›¸ç­‰ã€‚

### [](#the-right-mock)å³è®½

```
const test = require("ava");

const mockObjectId = data => {
  const oid = {
    name: data
  };
  Object.defineProperty(oid, "toString", {
    value: () => data
  });
  return oid;
};

test("toString() returns right value", t => {
  t.is(mockObjectId("foo").toString(), "foo");
});
test("it's an object", t => {
  const actual = mockObjectId("foo");
  t.is(typeof actual, "object");
});
test("two objectIds with same value are equal", t => {
  const first = mockObjectId("foo");
  const second = mockObjectId("foo");
  t.deepEqual(first, second);
}); 
```

## object . define property å¦‚ä½•æ‹¯æ•‘äº†æˆ‘ä»¬çš„åŸ¹æ ¹

è¿™æ˜¯å…³äºå¯æšä¸¾æ€§çš„ã€‚æˆ‘ä»¬æƒ³è¦æ¨¡ä»¿ä¸€ä¸ªæœ‰æ–¹æ³•çš„å¯¹è±¡ï¼Œä½†æ˜¯å½“äººä»¬æšä¸¾å®ƒçš„æ—¶å€™æ–¹æ³•ä¸ä¼šå‡ºç°ã€‚

`Object.defineProperty`å…è®¸æ‚¨è®¾ç½®å±æ€§æ˜¯å¦å¯æšä¸¾ã€å¯å†™å’Œå¯é…ç½®ï¼Œä»¥åŠä¸€ä¸ªå€¼æˆ– get/set (getter/setter)å¯¹(å‚è§ [MDN Object.defineProperty](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty) )ã€‚

éœ€è¦ 2 ä¸ªæè¿°ç¬¦(é…ç½®)å€¼:`configurable`(å¦‚æœä¸ºçœŸï¼Œå¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤å±æ€§ï¼Œé»˜è®¤ä¸ºå‡)ï¼Œ`enumerable`(å¦‚æœä¸ºçœŸï¼Œåœ¨æšä¸¾å¯¹è±¡å±æ€§æ—¶æ˜¾ç¤ºï¼Œé»˜è®¤ä¸ºå‡)ã€‚

è¿˜æœ‰ä¸€äº›å¯é€‰çš„æè¿°ç¬¦(é…ç½®)å€¼:`value`(ä¸å±æ€§å…³è”çš„å€¼ï¼Œä»»ä½•åŒ…å«å‡½æ•°çš„ JS ç±»å‹)ã€`writable`(å¯ä»¥ä½¿ç”¨èµ‹å€¼æ“ä½œç¬¦å†™å…¥è¯¥å±æ€§å—ï¼Œé»˜è®¤ä¸º false)ã€`get`å’Œ`set`(è°ƒç”¨å®ƒä»¬æ¥è·å–å’Œè®¾ç½®å±æ€§)ã€‚

è¿™æ˜¯ä¸€ä¸ªè°ƒç”¨ç¤ºä¾‹:

```
const o = {}
Object.defineProperty(
  o,
  'me',
  {
    value: 'Hugo',
    writable: false, // default: false
  }
)

console.log(o.me) // 'Hugo' 
```

æ‰€æœ‰çš„ä»£ç éƒ½åœ¨ github.com/HugoDF/mock-mongo-object-id ä¸Šä¼ ã€‚å¦‚æœä½ æ˜¯ç²‰ä¸ï¼Œå°±æŠŠå®ƒç•™åœ¨æ˜Ÿæ˜Ÿä¸ŠğŸ™‚ã€‚

[æ— åˆ·æ ‡å¿—
rawpixel](https://unsplash.com/@rawpixel?utm_medium=referral&utm_campaign=photographer-credit&utm_content=creditBadge)