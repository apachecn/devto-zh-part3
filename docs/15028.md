# åŸºäºå¼ é‡æµ Keras çš„çŒ´å­è¯†åˆ«

> åŸæ–‡:[https://dev . to/imron learning/monkey-recognition-with-tensor flow-keras-4 bcp](https://dev.to/imronlearning/monkey-recognition-with-tensorflow-keras-4bcp)

ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæœºå™¨å­¦ä¹ å˜å¾—å¦‚æ­¤ç®€å•ã€‚å¦‚æœä½ æ²¡æœ‰ä»»ä½•æ•°å­¦èƒŒæ™¯çŸ¥è¯†æˆ–ä»»ä½•å…³äºæœºå™¨å­¦ä¹ çš„å­¦æœ¯èƒŒæ™¯ï¼Œè¿™ä¸å†æ˜¯ä¸€ä¸ªéšœç¢ã€‚æˆ‘å½“ç„¶å±äºè¿™ä¸€ç±»ã€‚

æˆ‘ä½¿ç”¨æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªç›®æ ‡æ˜¯å½“è¯†åˆ«ä¸€äº›ä¸œè¥¿çš„æ—¶å€™ã€‚æˆ‘æƒ³å»ºç«‹ä¸€ä¸ªå¯ä»¥è¿›è¡Œé¢éƒ¨è¯†åˆ«ã€è¯†åˆ«åŠ¨ç‰©ç§ç±»ã€äº‹ç‰©åç§°ç­‰çš„æ¨¡å‹ã€‚å¯¹äºä¸€ä¸ªæ•°å­¦çŸ¥è¯†å¾ˆå°‘çš„äººæ¥è¯´ï¼Œå­¦ä¹ è¿™ç§æ•°å­¦æ˜¯éå¸¸å¯æ€•å’Œå›°éš¾çš„ã€‚æˆ‘å‡ ä¹æ”¾å¼ƒäº†è¿™ä¸ªçœ‹ä¼¼ä¸å¯å®ç°çš„ç›®æ ‡ï¼Œç›´åˆ°æˆ‘å‘ç°äº†**â€œé¢„è®­æ¨¡ç‰¹â€**ã€‚

**é¢„è®­ç»ƒæ¨¡å‹**åŸºæœ¬ä¸Šéƒ½æ˜¯*(æ ¹æ®æˆ‘çš„ç†è§£)*ï¼Œåœ¨ä¸åŒçš„æ•°æ®é›†ä¸Šè®­ç»ƒè¿‡çš„è§£å†³ç±»ä¼¼é—®é¢˜çš„æ¨¡å‹ã€‚æœ‰ä¸åŒç§ç±»çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œæ¯ä¸€ç§éƒ½æœ‰å…¶ç‰¹å®šçš„ç›®çš„ï¼Œç”¨äºè§£å†³ä¸åŒçš„é—®é¢˜ã€‚

ä»Šå¤©ï¼Œæˆ‘å°†å‘å¤§å®¶å±•ç¤ºæˆ‘æ˜¯å¦‚ä½•ä½¿ç”¨é¢„å…ˆè®­ç»ƒå¥½çš„æ¨¡å‹ **ResNet50** æ„å»ºä¸€ä¸ªçŒ´å­è¯†åˆ«æ¨¡å‹çš„ã€‚ **ResNet50** å¯¹äºæŒ‡å®šç‰©ç§*(æ ¹æ®æˆ‘æ‰€è§)*æ¥è¯´å¾ˆæ£’ã€‚æˆ‘è§è¿‡è¿™ä¹Ÿç”¨äºç‹—ã€‚æ‰€ä»¥è®©æˆ‘ä»¬å’ŒçŒ´å­ä¸€èµ·å»å§ğŸ™ˆ

# [](#setup)è®¾ç½®

æˆ‘åœ¨ä¸€ä¸ªç¬”è®°æœ¬ä¸Šåšè¿™ä¸ªé¡¹ç›®ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ä¸ºæœºå™¨å­¦ä¹ è®¾ç½®ä½ çš„æœºå™¨ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„[è®¾ç½®](https://dev.to/benprax/setup-for-machine-learning-part-3-1c02)å¸–å­ã€‚æˆ‘ç”¨çš„æ˜¯ Kaggle çš„ [10 ç§çŒ´å­](https://www.kaggle.com/slothkong/10-monkey-species)ã€‚

æˆ‘ä»¬è¿˜å¿…é¡»æœ‰ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è¯¥ç‰©ç§çš„æ‰€æœ‰ç´¢å¼•ã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ª [Github gist](https://gist.github.com/bennyprax/65818b886ee7ad14230f96c727bce07b) é‡Œä¸‹è½½ã€‚è¿™å¯¹ä»¥åå¾ˆé‡è¦ã€‚

æœ€åï¼Œä¸‹è½½ ResNet50 çš„é¢„è®­ç»ƒæ¨¡å‹ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ¥è‡ª Kaggle çš„[é“¾æ¥](https://www.kaggle.com/keras/resnet50)ã€‚

# [](#structuring-our-data-directory)æ„å»ºæˆ‘ä»¬çš„æ•°æ®ç›®å½•

æˆ‘çš„ç›®å½•æ–‡ä»¶å¤¹å¦‚ä¸‹æ‰€ç¤º:

[![Directory Structure](../Images/525add0715daee8d11274163c2768665.png "Directory Structure")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--nVSF_5zI--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/lt8n06nkp3f1i16jdt2r.png)

æˆ‘ä»¬æœ‰ç”¨äºè®­ç»ƒå’ŒéªŒè¯çš„å›¾åƒã€‚*è®°ä½æ•°æ®åˆ†å‰²
åœ¨è®­ç»ƒ/éªŒè¯æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬æœ‰æ¯ä¸ªç‰©ç§åŠå…¶å›¾åƒçš„ç›®å½•ã€‚

# [](#transforming-the-images)å˜æ¢å›¾åƒ

ç¬¬ä¸€ä¸ªéšœç¢æ˜¯è·å–å›¾åƒå¹¶å°†å…¶è½¬æ¢æˆæˆ‘ä»¬çš„æœºå™¨å­¦ä¹ æ¨¡å‹å¯ä»¥ç†è§£çš„ä¸œè¥¿ã€‚

```
 from tensorflow.python.keras.preprocessing.image import ImageDataGenerator
from tensorflow.python.keras.applications.resnet50 import preprocess_input

image_size = 224
data_generator_with_aug = ImageDataGenerator(preprocessing_function=preprocess_input, 
                                             horizontal_flip=True,
                                             width_shift_range=0.2,
                                             height_shift_range=0.2)
train_path='10-monkey-species/training'
train_generator = data_generator_with_aug.flow_from_directory(train_path, 
                                                     target_size=(image_size, image_size), 
                                                     batch_size=24,
                                                     class_mode='categorical')

data_generator_with_no_aug = ImageDataGenerator(preprocessing_function=preprocess_input)

validation_path='10-monkey-species/validation'
validation_generator = data_generator_with_no_aug.flow_from_directory(validation_path,
                                                          target_size=(image_size, image_size),
                                                          batch_size=24,
                                                          class_mode='categorical') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚`ImageDataGenerator`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè·å–å›¾åƒå¹¶å¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œç„¶åè¾“å‡ºæ¨¡å‹å¯ä»¥ç†è§£çš„æ•°æ®ã€‚`preprocessing_function`å‚æ•°æ¥å—å¦ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯æ¥è‡ª ResNet50 çš„`preprocess_input`,å®ƒç¿»è¯‘ RestNet50 å¯ä»¥ç†è§£çš„å›¾åƒã€‚å…¶ä»–å‚æ•°å…è®¸æ•°æ®æ‰©å……ã€‚

æ•°æ®æ‰©å……åŸºæœ¬ä¸Šå…è®¸ä½ æ‰©å……ä½ çš„æ•°æ®ã€‚è¿™æ„å‘³ç€å®ƒå…è®¸æ‚¨å¢åŠ æ•°æ®æ ·æœ¬ï¼Œè€Œå®é™…ä¸Šå¹¶ä¸å¢åŠ æ‚¨æ‹¥æœ‰çš„æ•°æ®æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¿»è½¬å›¾åƒæˆ–ç¨å¾®æ”¹å˜å›¾åƒçš„å®½åº¦å’Œé«˜åº¦å…è®¸æˆ‘ä»¬æœ‰æ›´å¤šçš„å›¾åƒæ ·æœ¬ï¼Œè€Œä¸å®é™…ä½¿ç”¨ç›¸åŒçš„ç²¾ç¡®å›¾åƒã€‚

`flow_from_directory`æ¥æ”¶æ‚¨æ”¾åœ¨ç›®å½•ä¸­çš„æ‰€æœ‰å›¾åƒã€‚

# [](#building-our-model)å»ºç«‹æˆ‘ä»¬çš„æ¨¡å‹

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å»ºç«‹æˆ‘ä»¬çš„æ¨¡å‹ï¼ï¼

```
 from tensorflow.python.keras.applications import ResNet50
from tensorflow.python.keras.models import Sequential
from tensorflow.python.keras.layers import Dense, Flatten, Conv2D, Dropout

resnet_weights_path = 'resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'
model = Sequential()
model.add(ResNet50(include_top=False, pooling='avg', weights=resnet_weights_path))

num_classes = 10
model.add(Dense(num_classes, activation='softmax'))

# Say not to train first layer (ResNet) model. It is already trained model.layers[0].trainable = False

model.compile(optimizer='sgd', loss='categorical_crossentropy', metrics=['accuracy'])

model.fit_generator(train_generator, 
steps_per_epoch=3, 
epochs=20, 
validation_data=validation_generator, 
validation_steps=1) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ†è§£:

*   æ‰€ä»¥æˆ‘ä»¬ç”¨äº†ä¸€ä¸ªé¡ºåºå·ç§¯ç½‘ç»œã€‚ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰é¢„è®­ç»ƒæƒé‡çš„ ResNet50 å±‚ã€‚
*   ç„¶åæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå¯†é›†å±‚ï¼Œæˆ‘ä»¬çš„ç±»çš„æ•°é‡æ˜¯ 10ã€‚ç±»åˆ«çš„æ•°é‡æ„å‘³ç€æˆ‘ä»¬è¯•å›¾è¯†åˆ«çš„ç‰©ç§çš„æ•°é‡*(åœ¨æœ¬ä¾‹ä¸­)*ã€‚
*   æˆ‘ä»¬è¿˜è¯´è¿‡ï¼Œå¯¹äºæ¨¡å‹çš„ç¬¬ä¸€å±‚ï¼Œæˆ‘ä»¬ä¸æƒ³é‡æ–°è®­ç»ƒå®ƒã€‚
*   ç„¶åæˆ‘ä»¬ç¼–è¯‘äº†æˆ‘ä»¬ç”¨`model.compile()`åšçš„æ‰€æœ‰ä¸œè¥¿ï¼Œæœ€åæŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ”¾è¿›äº†`model.fit_generator()`

è¿˜è®°å¾—æˆ‘ä»¬æ”¹å˜å½¢è±¡æ—¶åˆ¶é€ çš„å‘ç”µæœºå—ï¼Ÿæˆ‘ä»¬æŠŠå®ƒä»¬éƒ½æ”¾åœ¨è¿™é‡Œã€‚

*   Epochs åŸºæœ¬ä¸Šæ˜¯æ¨¡å‹åœ¨å›¾åƒä¸­å¾ªç¯çš„æ¬¡æ•°ã€‚
*   `steps_per_epoch`æ˜¯æˆ‘ä»¬åœ¨æ¯ä¸ªæ—¶æœŸæ‹æ‘„çš„å›¾åƒæ•°é‡ã€‚

# [](#testing-our-model)æµ‹è¯•æˆ‘ä»¬çš„æ¨¡å‹

```
import numpy as np
from os.path import join
from tensorflow.python.keras.preprocessing.image import load_img, img_to_array

image_dir = '10-monkey-species/validation'
img_paths = [join(image_dir, filename) for filename in 
               ['n0/n000.jpg',
                'n5/n502.jpg',
                'n9/n9031.jpg',
                'n2/n2014.jpg']]

image_size = 224
def read_prep_images(img_paths, img_height=image_size, img_width=image_size):
    imgs = [load_img(img_path, target_size=(img_height, img_width)) for img_path in img_paths]
    img_array = np.array([img_to_array(img) for img in imgs])
    output = preprocess_input(img_array)

    return output

test_data = read_prep_images(img_paths) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œï¼Œæˆ‘ä»¬ä»æˆ‘ä»¬çš„éªŒè¯æ•°æ®é›†ä¸­è·å–å‡ ä¸ªæµ‹è¯•å›¾åƒï¼Œå¹¶ä½¿ç”¨`read_prep`å‡½æ•°å°†å®ƒä»¬æ›´æ”¹ä¸º`np.array`ã€‚

ç„¶åæˆ‘ä»¬ç”¨æˆ‘ä»¬çš„æ¨¡å‹é¢„æµ‹å®ƒä»¬ã€‚

```
preds = model.predict(test_data)
print(preds) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#translating-our-predictions)ç¿»è¯‘æˆ‘ä»¬çš„é¢„æµ‹

æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„é¢„æµ‹è½¬åŒ–ä¸ºæŒ‡æ•°ï¼Œä»¥ä¾¿:

1.  æˆ‘ä»¬å¯ä»¥åœ¨ JSON æ–‡ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªç´¢å¼•
2.  è¿”å›è¯¥ç´¢å¼•çš„é€‚å½“æ•°æ®

æˆ‘ä» Kaggle é‚£é‡Œå¤åˆ¶äº†è¿™ä¸ªï¼Œç¨å¾®åšäº†äº›è°ƒæ•´ã€‚

```
import json
from IPython.display import Image, display

def decode_predictions(preds, top=5, class_list_path=None):
  if len(preds.shape) != 2 or preds.shape[1] != 10:
    raise ValueError('`decode_predictions` expects '
                     'a batch of predictions '
                     '(i.e. a 2D array of shape (samples, 1000)). '
                     'Found array with shape: ' + str(preds.shape))
  index_list = json.load(open(class_list_path))
  results = []
  for pred in preds:
    top_indices = pred.argsort()[-top:][::-1]
    result = [tuple(index_list[str(i)]) + (pred[i],) for i in top_indices]
    result.sort(key=lambda x: x[2], reverse=True)
    results.append(result)
  return results

most_likely_labels = decode_predictions(preds, top=5, class_list_path='10-monkey-species/class_monkey_species.json')

for i, img_path in enumerate(img_paths):
    display(Image(img_path))
    print(most_likely_labels[i]) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› æ­¤,`decode_predictions`è¿›ç¨‹æ¥æ”¶ä¸€ä¸ª 2D æ•°ç»„`preds`,å¹¶ä» json æ–‡ä»¶ä¸­ç´¢å¼•ç›¸åº”çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ preds æ˜¯[0ï¼Œ1ï¼Œ8]ï¼Œé‚£ä¹ˆå®ƒå°†ä» json å¯¹å…¶è¿›è¡Œç´¢å¼•ï¼Œå¹¶è¿”å›[['index_0 'ï¼Œ' folder_name']ï¼Œ['index_1 'ï¼Œ' folder_name']ï¼Œ['index_8 'ï¼Œ' folder_name']]ã€‚

for å¾ªç¯ä¸»è¦æ¥æ”¶å›¾åƒï¼Œå¹¶æ˜¾ç¤ºè§£ç åçš„é¢„æµ‹ã€‚

è€Œè¿™å°±æ˜¯ç»“æœ:
[![result](../Images/f3acfa1fc2d968764cfec5bab0a1b076.png "Model Prediction Result")](https://res.cloudinary.com/practicaldev/image/fetch/s--Itek1KHg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/hwhmekqp6w7i0ieu4c2z.png)

# [](#conclusion)ç»“è®º

æœºå™¨å­¦ä¹ å˜å¾—å¼‚å¸¸ç®€å•ã€‚ä»¤äººç ç›®ç»“èˆŒã€‚è¿™é‡Œçš„æŸäº›æœ¯è¯­ï¼Œå¦‚â€œsoftmaxâ€å’Œâ€œrelu â€,éƒ½æ˜¯æ•°å­¦æœ¯è¯­ï¼Œä½ ä¸éœ€è¦æ·±ç©¶å®ƒä»¬çš„æœºåˆ¶ï¼Œä½†å¦‚æœä½ å¯¹å®ƒä»¬çš„åŠŸèƒ½å’Œç”¨é€”æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè¿™äº›æœ¯è¯­ä¼šå¾ˆæœ‰ç”¨ã€‚åœ¨æˆ‘è¿„ä»Šä¸ºæ­¢çš„æœºå™¨å­¦ä¹ ä¹‹æ—…ä¸­ï¼Œä½ åªéœ€è¦å¯¹å®ƒæœ‰ä¸€ä¸ªå¤§è‡´çš„ç†è§£å’Œæ¦‚å¿µå°±å¯ä»¥çœŸæ­£å¼€å§‹äº†ã€‚

å¸Œæœ›ä½ èƒ½ä»ä¸­å­¦åˆ°ä¸€äº›ä¸œè¥¿ï¼å¸Œæœ›å¬åˆ°æ‚¨çš„åé¦ˆğŸ˜„
åœ¨ twitter å’Œ instagram @heyimprax ä¸ŠæŸ¥çœ‹æ›´å¤šæ¥è‡ªæˆ‘çš„ä¿¡æ¯ã€‚

æ„Ÿè°¢é˜…è¯»ï¼ä½ æˆåŠŸäº†ğŸ‰å–æ¯å’–å•¡ä¼‘æ¯ä¸€ä¸‹å§ï¼Œâ˜•ï¸