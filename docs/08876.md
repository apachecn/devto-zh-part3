# ä½¿ç”¨åè®®ç¼“å†²åŒºå®šä¹‰æ‚¨çš„æœåŠ¡:ç¬¬ 1 éƒ¨åˆ†

> åŸæ–‡:[https://dev . to/jaredwolff/use-protocol-buffers-to-define-your-service-part-1-42fh](https://dev.to/jaredwolff/use-protocol-buffers-to-define-your-service-part-1-42fh)

å…³äºè“ç‰™ä½èƒ½è€—ï¼Œæœ€ä»¤äººå›°æƒ‘çš„äº‹æƒ…ä¹‹ä¸€æ˜¯æ•°æ®æ˜¯å¦‚ä½•ç§»åŠ¨çš„ã€‚æ ¹æ®æ‚¨çš„åº”ç”¨ï¼Œæ‚¨çš„è®¾å¤‡çŠ¶æ€å¯èƒ½ç›¸å½“å¤æ‚ã€‚è¿™æ„å‘³ç€æ¯æ¡æ•°æ®éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ç«¯ç‚¹ï¼Œè¿™æ— å¼‚äºè“ç‰™è‡ªæ€ã€‚

é‚£ä¹ˆï¼Œä»–çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ

[![Sheep with Protobuf](../Images/2f350e26b226d2397b29e4c8ec6a5830.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ELe9cMFD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-define-your-own-bluetooth-low-energy-configuration-service-using-protobuf/images/protobuf.jpg)

[åè®®ç¼“å†²å™¨ã€‚](https://developers.google.com/protocol-buffers/)

åè®®ç¼“å†²åŒºæ˜¯ç¼–ç /è§£ç ä¼˜åŒ–çš„ç»“æ„åŒ–æ•°æ®çš„ç¼–ç¨‹æ–¹å¼ã€‚å®ƒä»¬å¯ä»¥åœ¨å‡ ä¹ä»»ä½•å¹³å°ä¸Šå…±äº«å’Œæ“ä½œã€‚Nordic å®é™…ä¸Šåœ¨ä»–ä»¬çš„ DFU æœåŠ¡ä¸­ä½¿ç”¨äº†å®ƒçš„ä¸€ä¸ªå˜ç§ã€‚

å¼€å¤´å‡ å¥è¯é‡Œæœ‰è®¸å¤šæ—¶é«¦çš„è¯è¯­ã€‚å¸Œæœ›åœ¨è¿™ç¯‡æ–‡ç« ç»“æŸæ—¶ï¼Œä½ ä¼šæ˜ç™½æˆ‘åœ¨è¯´ä»€ä¹ˆã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†åŒ…æ‹¬å®Œå…¨åˆ·æ–°çš„ç¤ºä¾‹ä»£ç ï¼Œæ‚¨å¯ä»¥å…‹éš†å¹¶ç«‹å³å¼€å§‹ä½¿ç”¨ã€‚ä½ æ‰€éœ€è¦çš„åªæ˜¯è¿™äº›ä¸­çš„ä¸€ä¸ª:

[![NRF52 Development Kit](../Images/0e962b5bb2809d3acf8cb035d0e9c8ba.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--iL0QCGTD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-define-your-own-bluetooth-low-energy-configuration-service-using-protobuf/images/DSC01544.jpg)

é‚£ä¹ˆï¼Œå¦‚ä½•ä½¿ç”¨è¿™ä¸ªç¥å¥‡çš„è½¯ä»¶å‘¢ï¼Ÿ

è¯·ç»§ç»­é˜…è¯»ï¼

## [](#install)å®‰è£…

è¯¥è¿‡ç¨‹çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç¡®ä¿æ‚¨å·²ç»å®‰è£…äº†æ‰€æœ‰æ­£ç¡®çš„å®ç”¨ç¨‹åºã€‚å–å†³äºå“ªç§ç¼–ç¨‹è¯­è¨€å°†å†³å®šæ‚¨å®‰è£…å’Œä½¿ç”¨ä»€ä¹ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å°†æ¦‚è¿°æˆ‘åœ¨è¿‡å»ä½¿ç”¨ Cã€Go å’Œ Javascript çš„å‡ ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨çš„å®ç”¨ç¨‹åºã€‚

æ˜¯ä½ å¿…é¡»åœ¨è¿™é‡Œå®‰è£…çš„æœ€é‡è¦çš„å·¥å…·ã€‚æ˜¯ Protobufâ€œç¼–è¯‘å™¨â€å°†ä½ çš„`.proto`å’Œ`.options`æ–‡ä»¶è½¬æ¢æˆé™æ€ä»£ç ã€‚

1.  å¯¹äº Macï¼Œè¯·åœ¨æ­¤ä¸‹è½½é€‚å½“çš„ç‰ˆæœ¬[ã€‚](https://github.com/google/protobuf/releases)
2.  è§£å‹ç¼©æ–‡ä»¶å¤¹
3.  è¿è¡Œæ–‡ä»¶å¤¹ä¸­çš„`./autogen.sh &&Â ./configure && make`
4.  å¦‚æœå‡ºç°é”™è¯¯`autoreconf: failed to run aclocal: No such file or directory`ï¼Œè¯·ä½¿ç”¨è‡ªåˆ¶è½¯ä»¶å®‰è£…`autoconf`:

`brew install autoconf && brew install automake`

ç„¶åï¼Œé‡æ–°è¿è¡Œæ­¥éª¤ 3ã€‚

1.  ç„¶åè¿è¡Œ:

```
make check
sudo make install
which protoc 
```

è€ƒè™‘ç”¨äºåè®®ç¼“å†²åŒºçš„ç¼–è¯‘å™¨ã€‚å®ƒå¯ä»¥ç›´æ¥è¾“å‡ºåŸå§‹æ–‡ä»¶æˆ–åº“ã€‚è¿™æ˜¯å› ä¸ºå®ƒå†…ç½®äº† Go æ”¯æŒã€‚

åŸå§‹æ•°æ®ä¹Ÿå¯ä»¥ç”¨æ¥ä¸ºå…¶ä»–è¯­è¨€ç”Ÿæˆé™æ€åº“ã€‚è¿™é€šå¸¸éœ€è¦ä¸€ä¸ª(æˆ–å¤šä¸ª)é¢å¤–çš„å®ç”¨ç¨‹åºã€‚æˆ‘åœ¨ä¸‹é¢æè¿°äº† Dondi Lib é¡¹ç›®ä½¿ç”¨çš„ä¸¤ç§æ–¹æ³•ã€‚

1.  `nanopb`æ˜¯ä¸€ä¸ª python è„šæœ¬ï¼Œç”¨äºåˆ›å»ºç¼–ç /è§£ç ç»“æ„åŒ–æ•°æ®çš„ C åº“ã€‚
    å®ƒå¯ä»¥é€šè¿‡å¯¼èˆªåˆ° [nanopb git repo](https://github.com/nanopb/nanopb) å¹¶ä¸‹è½½é€‚å½“çš„æ–‡ä»¶æ¥å®‰è£…ã€‚æœ€é‡è¦çš„éƒ¨åˆ†åŒ…æ‹¬:

2.  `pb_encode.c`ã€`pb_decode.c`å’Œ`pb_common.c`

3.  `/generator/nanopb_generator.py`

4.  å’Œä¸`nanopb_generator.py`ä½äºåŒä¸€ä½ç½®çš„`/generator/nanopb/`ç›®å½•

    `nanopb`æ—¨åœ¨éƒ¨ç½²åœ¨åµŒå…¥å¼å¹³å°ä¸Šã€‚å®ƒä¸åŒäº`protoc-c`(å¸¸è§„çš„ C å˜ä½“)ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ºåµŒå…¥å¼å¤„ç†å™¨ç­‰èµ„æºå—é™çš„ç³»ç»Ÿè€Œä¼˜åŒ–çš„ã€‚ç¼“å†²åŒºçš„å¤§å°æœ‰é™ã€‚æ²¡æœ‰å†…å­˜åˆ†é…ï¼æ ¹æ®æ˜¯å¦æœ‰åŒå‘é€šä¿¡ï¼Œæ‚¨åªèƒ½å¯¼å…¥å’Œä½¿ç”¨ç¼–ç åŠŸèƒ½æˆ–è§£ç åŠŸèƒ½ã€‚

5.  `pbjs`ä½¿ç”¨`protoc`çš„è¾“å‡ºç”Ÿæˆä¸€ä¸ªé™æ€ javascript åº“ã€‚è¿™éå¸¸å¼ºå¤§ï¼Œå› ä¸ºæ‚¨å¯ä»¥åœ¨ä»»ä½• javascript åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚å®‰è£…`pbjs`çš„æœ€ä½³æ–¹å¼æ˜¯è¿è¡Œ:

```
npm install -g protobufjs 
```

æˆ‘åœ¨ç¤ºä¾‹ä»£ç ä¸­ç¨å¾®ç®€åŒ–äº†è¿™ä¸€æ­¥ã€‚[ä»å…‹éš†æ­¤å¤„çš„ repos å¼€å§‹ã€‚](https://www.jaredwolff.com/files/protobuf/)

## [](#setting-up-the-protocol-buffer)è®¾ç½®åè®®ç¼“å†²åŒº

åˆ›å»ºä¸€ä¸ªåä¸º`command.proto`çš„æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿è¯¥æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º:

```
syntax = "proto3";

message event {
  enum event_type {
    command = 0;
    response = 1;
  }
  event_type type = 1;
  string message = 2;
} 
```

ä¹ä¸€çœ‹ï¼Œå®ƒå¯èƒ½å¾ˆé™Œç”Ÿï¼Œä½†æ˜¯ä¸€æ—¦ä½ æ·±å…¥äº†è§£ï¼Œå®ƒä¸æ ‡å‡†çš„ C ç»“æ„æˆ–å“ˆå¸Œè¡¨å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†ä¸¤ç§ç±»å‹çš„æ•°æ®:a `string`å’Œ`enum`ä½œä¸ºç±»å‹ã€‚å®é™…ä¸Šè¿˜æœ‰ä¸€äº›ä½ å¯ä»¥åœ¨[æ–‡æ¡£](https://developers.google.com/protocol-buffers/docs/proto)ä¸­æ‰¾åˆ°ã€‚ç¼–è¯‘æ—¶ï¼Œç­‰æ•ˆçš„ c ç»“æ„å¦‚ä¸‹æ‰€ç¤º:

```
/* Struct definitions */
typedef struct _event {
    event_event_type type;
    char message[64];
/* @@protoc_insertion_point(struct:event) */
} event; 
```

å…¶ä¸­`event_event_type`æ˜¯

```
/* Enum definitions */
typedef enum _event_event_type {
    event_event_type_command = 0,
    event_event_type_response = 1
} event_event_type; 
```

æ‚¨å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°åœ¨å½¼æ­¤å†…éƒ¨åµŒå¥—ä»»æ„å¤šçš„æ¶ˆæ¯ã€‚ä¸è¿‡ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯è¶Šå°è¶Šå¥½ï¼Œå› æ­¤æ•°æ®ä¼ è¾“æ•ˆç‡ä¹Ÿè¶Šé«˜ã€‚è¿™å¯¹äºèµ„æºå—é™çš„ç³»ç»Ÿæˆ– LTE éƒ¨ç½²å°¤ä¸ºé‡è¦ï¼Œåœ¨è¿™äº›ç³»ç»Ÿæˆ–éƒ¨ç½²ä¸­ï¼Œæ‚¨éœ€è¦ä¸ºä½¿ç”¨çš„æ¯å…†å­—èŠ‚æ”¯ä»˜*è´¹ç”¨ã€‚**æ³¨æ„:**å½“å…ƒç´ æœªè¢«ä½¿ç”¨æˆ–å®šä¹‰æ—¶ï¼Œå®ƒä»¬é€šå¸¸*ä¸*åŒ…æ‹¬åœ¨ç¼–ç åè®®ç¼“å†²åŒºæœ‰æ•ˆè½½è·ä¸­ã€‚*

é€šå¸¸ï¼Œå½“æ‚¨åˆ›å»ºè¿™æ ·çš„é€šç”¨æ¶ˆæ¯æ—¶ï¼Œå¯¹å­—ç¬¦ä¸²`message`çš„å¤§å°æ²¡æœ‰é™åˆ¶ã€‚è¯¥é€‰é¡¹å¯ä»¥åœ¨`.options`æ–‡ä»¶ä¸­è®¾ç½®:

```
event.message   max_size:64 
```

è¿™æ ·ï¼Œå†…å­˜å¯ä»¥åœ¨ç¼–è¯‘æ—¶åœ¨æˆ‘çš„å¾®å¤„ç†å™¨ä»£ç ä¸­é™æ€åˆ†é…ã€‚å¦‚æœæ¶ˆæ¯å¤§å°å¤§äº 64 å­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨ä»£ç ä¸­è¢«æˆªæ–­(æˆ–è€…åœ¨è§£ç è¿‡ç¨‹ä¸­æ‚¨å°†å¾—åˆ°ä¸€ä¸ªé”™è¯¯)ã€‚è¿™å–å†³äºæ‚¨ï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œæ¥è®¡ç®—æ‚¨å¯èƒ½éœ€è¦è¿™ç§ç±»å‹çš„æ•°æ®çš„ç»å¯¹æœ€å¤§å­—èŠ‚(æˆ–å­—ç¬¦)æ•°é‡ã€‚

ä½ å¯ä»¥åœ¨ä»–ä»¬çš„æ–‡æ¡£ä¸­æŸ¥çœ‹æ›´å¤šä¸`nanopb`ç›¸å…³çš„ç‰¹æ€§ã€‚

## [](#generating-the-appropriate-static-libraries)ç”Ÿæˆåˆé€‚çš„é™æ€åº“

ä¸ºäº†ä½¿è¿™å°½å¯èƒ½ç®€å•ï¼Œæˆ‘å°†ä»¥ä¸‹æ‰€æœ‰ä»£ç æ”¾å…¥ Makefile ä¸­ã€‚å½“æ‚¨å¯¹åè®®ç¼“å†²åŒºè¿›è¡Œæ›´æ”¹æ—¶ï¼Œä¼šç”Ÿæˆæ‰€ä½¿ç”¨çš„æ¯ç§è¯­è¨€çš„æ¯ä¸ªåº“ã€‚

å¦‚æœæˆ‘ä»¬æƒ³ç”Ÿæˆä¸€ä¸ªé™æ€çš„ Go æ–‡ä»¶ï¼Œå‘½ä»¤åº”è¯¥æ˜¯è¿™æ ·çš„:

```
protoc -I<directory with .proto> --go_out=<output directory> command.proto 
```

å¦‚æœæ‚¨å·²ç»å®‰è£…äº† nanopb æ’ä»¶ï¼Œæ‚¨å¯ä»¥åšä¸€äº›ç±»ä¼¼çš„äº‹æƒ…æ¥ç”Ÿæˆ C ä»£ç :

```
protoc -I<directory with .proto> -ocommand.pb command.proto
<path>/<to>/protogen/nanopb_generator.py -I<directory with .proto> command 
```

ç¬¬ä¸€ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªé€šç”¨çš„â€œå¯¹è±¡â€æ–‡ä»¶ã€‚ç¬¬äºŒä¸ªå®é™…ä¸Šåˆ›å»ºäº†é™æ€ C åº“ã€‚

å¯¹äº javascript:

```
pbjs -t static-module -p<directory with .proto> command.proto > command.pb.js 
```

æ‚¨å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„`.proto`å’Œ`.options`æ–‡ä»¶ç¤ºä¾‹æ¥æµ‹è¯•è¿™äº›å‘½ä»¤ã€‚æˆ‘è¿˜å°†è¿™ä¸ªæ‰‹åŠ¨è¿‡ç¨‹æ„å»ºåˆ°ç¤ºä¾‹å­˜å‚¨åº“ä¸­çš„ä¸€ä¸ªå‘½ä»¤ä¸­ã€‚[åœ¨æ­¤è·å–è®¿é—®æƒé™ã€‚](https://www.jaredwolff.com/files/protobuf/)

## [](#encoding-and-decoding)ç¼–ç å’Œè§£ç 

[![Encoding](../Images/e80a55d92d79c24441a47af2ae4cc77d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--r81CcPUY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.jaredwolff.com/how-to-define-your-own-bluetooth-low-energy-configuration-service-using-protobuf/images/data-3432628_1920.jpg)

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ–°ç¼–è¯‘çš„é™æ€ä»£ç ï¼è¿™å°±æ˜¯ä¹è¶£çš„å¼€å§‹ã€‚

### [](#encoding-using-javascript)ä½¿ç”¨ Javascript ç¼–ç 

è¿™é‡Œæœ‰ä¸€ä¸ªå…¸å‹çš„æµç¨‹ï¼Œæ‚¨å¯ä»¥åœ¨ä½¿ç”¨é™æ€ç”Ÿæˆçš„ javascript åº“æ—¶éµå¾ªã€‚é¦–å…ˆï¼Œåˆå§‹åŒ–åº“ã€‚

```
// Import the config message
var protobuf  = require('./command.pb.js'); 
```

ç„¶ååˆ›å»ºä¸€ä¸ª`event`çš„å®ä¾‹:

```
// setup command
var event = protobuf.event.create();
event.type = protobuf.event.event_type.command;
event.message = "This is"; 
```

ç„¶åï¼Œç¼–è¯‘æœ‰æ•ˆè´Ÿè½½ã€‚å³æŠŠäººç±»å¯è¯»çš„ JSON è½¬æ¢æˆæ‰“åŒ…å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è§ä¸‹æ–‡ã€‚

```
// make sure it's valid
var err = protobuf.event.verify(event);
if( err != null ) {
   console.log("verify failed: " + err);
   return;
} 
```

å¦‚æœä½ çš„å¯¹è±¡æ ¼å¼ä¸æ­£ç¡®æˆ–è€…å¦‚æœä½ ç¼ºå°‘`required`å…ƒç´ ï¼Œä½ ä¼šåœ¨è¿™ä¸€æ­¥å¾—åˆ°é”™è¯¯ã€‚æˆ‘ä¸æ¨èåœ¨å®šä¹‰ä½ çš„`.proto`æ–‡ä»¶æ—¶ä½¿ç”¨`required`å‰ç¼€ã€‚å¯¹æ‰€éœ€å…ƒç´ çš„ä»»ä½•æ£€æŸ¥éƒ½å¯ä»¥åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä»£ç ä¸­è½»æ¾å®Œæˆã€‚

æœ€åï¼Œæœ€åä¸€æ­¥æ˜¯ç¼–ç å¹¶å°†å…¶è½¬æ¢ä¸ºåŸå§‹å­—èŠ‚:

```
// encode into raw bytes
var payload = protobuf.event.encode(event).finish(); 
```

ç„¶åä½ å¯ä»¥ä½¿ç”¨ payload å¹¶é€šè¿‡ BLEã€HTTP æˆ–å…¶ä»–æ–¹å¼å‘é€å®ƒã€‚å¦‚æœæœ‰é€šä¿¡åè®®ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒå‘é€è¿™ä¸ªç¼“å†²åŒºï¼

### [](#decoding-in-c)è§£ç ç”¨ C

ä¸€æ—¦æ•°æ®è¢«æ¥æ”¶ï¼Œå®ƒå°±åœ¨åµŒå…¥å¼ç«¯è¢«è§£ç ã€‚`nanopb`ä»¤äººè¿·æƒ‘ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€äº›å¯¹æ‚¨æœ‰ç”¨çš„ä»£ç :

```
// Setitng up protocol buffer data
event evt;

// Read in buffer
pb_istream_t istream = pb_istream_from_buffer((pb_byte_t *)data, data_len);

if (!pb_decode(&istream, event_fields, &evt)) {
   NRF_LOG_ERROR("Unable to decode: %s", PB_GET_ERROR(&istream));
   return;
}

// Validate code & type
if( evt.type != event_event_type_command ) {
   return;
} 
```

é¦–å…ˆï¼Œæ ¹æ®åŸå§‹æ•°æ®å’Œæ•°æ®å¤§å°åˆ›å»ºä¸€ä¸ªè¾“å…¥æµã€‚

ç„¶åï¼Œä½¿ç”¨`pb_decode`åŠŸèƒ½ã€‚æ‚¨å°†ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘è¾“å…¥æµã€‚ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨çš„åè®®ç¼“å†²åŒºçš„å®šä¹‰ã€‚å®ƒä½äº`command.pb.h`æ–‡ä»¶ä¸­ã€‚

```
/* Defines for backwards compatibility with code written before nanopb-0.4.0 */
#define event_fields &event_msg 
```

æœ€åä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘è¦å°†è§£ç åçš„æ•°æ®æ”¾å…¥çš„ç»“æ„çš„æŒ‡é’ˆã€‚(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯åœ¨ä¸Šé¢çš„`pb_istream_from_buffer`ä¹‹å‰å®šä¹‰çš„`evt`)ã€‚

### [](#encoding-in-c)ç¼–ç ç”¨ C

ç°åœ¨è®©æˆ‘ä»¬è¯´ï¼Œæˆ‘ä»¬è¦å›å¤ä¸Šé¢åˆšåˆšè§£ç çš„æ¶ˆæ¯ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¿…é¡»åˆ›å»ºæ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œç¼–ç å¹¶å°†å…¶å‘é€å›å»ã€‚æµç¨‹æ˜¯è¿™æ ·çš„:

```
// Encode value
pb_byte_t output[event_size];

// Output buffer
pb_ostream_t ostream = pb_ostream_from_buffer(output,sizeof(output));

if (!pb_encode(&ostream, event_fields, &evt)) {
   NRF_LOG_ERROR("Unable to encode: %s", PB_GET_ERROR(&ostream));
   return;
} 
```

é¦–å…ˆåˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨æ¥ä¿å­˜åè®®ç¼“å†²åŒºå ç”¨çš„æœ€å¤§å­—èŠ‚æ•°ã€‚è¿™åœ¨ä½ çš„`command.pb.h`é‡Œä¹Ÿæœ‰å®šä¹‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`event_size`è¢«è®¾ç½®ä¸º`67`ã€‚ç„¶åï¼Œç±»ä¼¼äº decode å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæµå¹¶å°†å…¶è¿æ¥åˆ°ç¼“å†²åŒºã€‚æœ€åï¼Œé€šè¿‡å°†æ‚¨çš„`evt`ç»“æ„ä¸æµå’Œ`event_fields`ä¸€èµ·æŒ‡å‘ï¼Œå¯¹æ•°æ®è¿›è¡Œç¼–ç ã€‚

åªè¦`pb_encode`è¿”å›æ— è¯¯ï¼Œç¼–ç åçš„æ•°æ®å·²ç»å†™å…¥`output`ï¼è¯¥ç»“æ„å¯ä»¥æ˜¯å¯å˜é•¿åº¦çš„ï¼Œæ‰€ä»¥å‘é€æ—¶æœ€å¥½çš„å¤„ç†æ–¹å¼æ˜¯ä»`ostream`è·å–`bytes_written`:

```
NRF_LOG_INFO("bytes written %d",ostream.bytes_written); 
```

## [](#conclusion)ç»“è®º

å¾ˆé«˜å…´ä½ æ¥äº†ï¼æˆ‘å¸Œæœ›æ‚¨å¼€å§‹æŒæ¡åè®®ç¼“å†²åŒºçš„åŠ›é‡ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘èŠ±äº†ç‚¹æ—¶é—´æ‰æƒ³æ˜ç™½ã€‚æ‚¨ä¹Ÿå¯ä»¥æˆä¸ºåè®®ç¼“å†²å¤§å¸ˆï¼ğŸ˜‰

å¦‚æœæ‚¨å¯¹åè®®ç¼“å†²åŒºä¸å¤ªæ»¡æ„ï¼Œè¿˜æœ‰å…¶ä»–é€‰æ‹©ã€‚æˆ‘åœ¨ä»¥å‰çš„äº§å“ä¸Šä½¿ç”¨è¿‡ [MessagePack](https://msgpack.org) å¹¶å–å¾—äº†ä¸€äº›æˆåŠŸã€‚å®ƒå¾ˆç®€å•ï¼Œå¹¶ä¸”å¯¹å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¤§é‡çš„æ”¯æŒã€‚

å¦‚æœä½ å¯¹å¦‚ä½•å°†å®ƒèå…¥è“ç‰™ä½èƒ½è€—é¡¹ç›®æ„Ÿå…´è¶£ï¼Œè¯·ç»§ç»­å…³æ³¨ç¬¬äºŒéƒ¨åˆ†ã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å»ºç«‹ä¸€ä¸ªéå¸¸ç®€å•çš„è“ç‰™æœåŠ¡å’Œç‰¹æ€§ï¼Œå®ƒå°†ç”¨äºæ¥å›ä¼ è¾“æˆ‘ä»¬æ–°ç¼–ç çš„æ•°æ®ã€‚

æ­¤å¤–ï¼Œå¦‚æœæ‚¨æƒ³æŸ¥çœ‹æ‰€æœ‰è¿è¡Œä¸­çš„ä»£ç ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½æ‰€æœ‰å†…å®¹ã€‚