# TypeScript ä¸­çš„ç±»å‹å®‰å…¨é”™è¯¯å¤„ç†

> åŸæ–‡:[https://dev . to/_ gdelgado/type-safe-error-handling-in-typescript-1p4n](https://dev.to/_gdelgado/type-safe-error-handling-in-typescript-1p4n)

> æœ€åˆå‘å¸ƒåœ¨æˆ‘çš„[åšå®¢](https://gdelgado.ca/type-safe-error-handling-in-typescript.html#title)

æˆ‘ä»¬ä»¥å‰éƒ½ç»å†è¿‡ã€‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†ä¸€äº›è¾¹ç¼˜æƒ…å†µï¼Œæˆ‘ä»¬ä½¿ç”¨å…³é”®å­—`throw`æ¥å¤„ç†è¿™ç§æƒ…å†µ:

```
type ResponseData = {
  statusCode: number
  responseBody?: ResponseBody
}

const makeHttpRequest = async (url: string): Promise<ResponseData> => {
  if (!isUrl(url)) {
    throw new Error(
      'Invalid string passed into `makeHttpRequest`. Expected a valid URL.'
    )
  }

  // ...
  // other business logic here
  // ...

  return { ... } // ResponseData
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æƒ³è±¡ä¸€ä¸ªæœˆåï¼Œä½ æ­£åœ¨åšä½ çš„é¡¹ç›®ï¼Œè¿™æ—¶ä½ æˆ–ä¸€ä¸ªåŒäº‹å¿˜è®°å°†`makeHttpRequest`åŒ…è£…åœ¨`try / catch`å—ä¸­ã€‚

è¿™é‡Œå‘ç”Ÿäº†ä¸¤ä»¶äº‹:

*   ç¼–è¯‘å™¨ä¸å†èƒ½å‘Šè¯‰ä½ ä½ çš„ä»£ç æ˜¯å¦ä¸ä¼šå‡ºç°è¿è¡Œæ—¶é”™è¯¯ã€‚æ¢å¥è¯è¯´ï¼Œä½¿ç”¨`throw`ä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚è€Œä¸”å’Œ`any`ä¸€æ ·å±é™©ã€‚å®ƒä»¬éƒ½å†²æ·¡äº†ä½¿ç”¨ TypeScript çš„å¥½å¤„ã€‚

*   å› ä¸ºç¼–è¯‘å™¨å’Œç±»å‹éƒ½æ²¡æœ‰å‘Šè¯‰ä½ `makeHttpRequest`å¯èƒ½å¤±è´¥(read: throw)ï¼Œä½ æœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯ã€‚è¿™å¯¹æ¯ä¸ªäººæ¥è¯´éƒ½æ˜¯æµªè´¹æ—¶é—´ã€é‡‘é’±å’Œå¹¸ç¦ã€‚äººä»¬å¼€å§‹é—®ï¼Œå¦‚æœç¼–è¯‘å™¨ä¸èƒ½å¸®åŠ©ä»–ä»¬åšä¸€äº›åŸºæœ¬çš„äº‹æƒ…ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ª`try / catch`å—ï¼Œä»–ä»¬ä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨ TypeScriptã€‚

æ‰€ä»¥é—®é¢˜æ˜¯:

> æˆ‘ä»¬å¦‚ä½•å°†æ•…éšœæ€§ç¼–ç åˆ°ç±»å‹ç³»ç»Ÿä¸­ï¼Ÿ

é¦–å…ˆï¼Œè®©æˆ‘ä»¬é¦–å…ˆæ‰¿è®¤`throw`ä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚ä¸ºäº†è®© TypeScript ç¼–è¯‘å™¨ç«™åœ¨æˆ‘ä»¬è¿™è¾¹ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ã€‚

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä»£è¡¨å¯èƒ½å¤±è´¥çš„è®¡ç®—ç»“æœçš„`type`æˆ–`interface`ä¼šæ€ä¹ˆæ ·ï¼Ÿ

æˆ‘ä»¬çš„ç±»å‹å°†ä»£è¡¨ä¸¤ä¸ªç®€å•çš„ç»“æœ:

*   æˆåŠŸæ¡ˆä¾‹:å°†è¿”å›/åŒ…å«ä¸€ä¸ªâ€œæˆåŠŸå€¼â€(å³`makeHttpRequest`æƒ…å†µä¸‹çš„`ResponseData`)
*   å¤±è´¥æ¡ˆä¾‹:è¿”å›/åŒ…å«å…³äº**ä¸ºä»€ä¹ˆ**å¤±è´¥å‘ç”Ÿçš„æœ‰ç”¨ä¿¡æ¯

è®©æˆ‘ä»¬ç§°æˆ‘ä»¬çš„ç±»å‹ä¸ºç›´è§‚çš„ä¸œè¥¿å§ã€‚è®©æˆ‘ä»¬ç§°æˆ‘ä»¬çš„æˆåŠŸå˜é‡ä¸º`Ok`ï¼Œç§°æˆ‘ä»¬çš„å¤±è´¥å˜é‡ä¸º`Err`ã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†æˆ‘ä»¬çš„ç±»å‹å½¢å¼åŒ–ä¸ºä»£ç ï¼Œå®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·:

```
type Result<T, E>
  = Ok<T, E> // contains a success value of type T
  | Err<T, E> // contains a failure value of type E 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å›åˆ°æˆ‘ä»¬çš„`makeHttpRequest`å‡½æ•°ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å¤±è´¥çš„å¯èƒ½æ€§ç¼–ç åˆ°ç±»å‹ç³»ç»Ÿä¸­ã€‚

å› æ­¤ï¼Œ`makeHttpRequest`å°†å…·æœ‰ä»¥ä¸‹ç­¾å:

```
makeHttpRequest(url: string): Promise<Result<ResponseData, Error>> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‡½æ•°å®šä¹‰åº”è¯¥æ˜¯è¿™æ ·çš„:

```
// utility functions to build Ok and Err instances
const ok = <T, E>(value: T): Result<T, E> => new Ok(value)

const err = <T, E>(error: E): Result<T, E> => new Err(error)

const makeHttpRequest = async (url: string): Promise<Result<ResponseData, Error>> => {
  if (!isUrl(url)) {
    return err(new Error(
      'Invalid string passed into `makeHttpRequest`. Expected a valid URL.'
    ))
  }

  // ...
  // other business logic here
  // ...

  return ok({ ... }) // Ok(ResponseData)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç„¶`err(new Error('...'))`ä¼¼ä¹æœ‰ç‚¹ä¹å‘³ã€‚ä½†æ˜¯æœ‰äº›äº‹æƒ…ä½ åº”è¯¥çŸ¥é“:

*   `err`å‡½æ•°çš„å‚æ•°å¿…é¡»æ˜¯`E`ç±»å‹ï¼Œå¦åˆ™åœ¨`err`å†…éƒ¨çš„ç±»å‹å’Œ`makeHttpRequest`çš„è¿”å›ç±»å‹ä¹‹é—´ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯(ç±»å‹ä¸åŒ¹é…)(`E`ç±»å‹è¢«è¡¨ç¤ºä¸º`Error`å®ä¾‹)ã€‚

    *   ç›¸å…³åœ°ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©äº†`Error`ä½œä¸º`E`çš„ç±»å‹...æ„æ€æ˜¯`E`å¯ä»¥æ˜¯ä½ æƒ³è¦çš„ä»»ä½•ä¸œè¥¿ï¼ç¨åå°†è¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ï¼
*   `makeHttpRequest`çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒä¼šéšæœºæŠ›å‡ºã€‚ä¸å†æœ‰è¿è¡Œæ—¶é”™è¯¯ğŸš€

*   `makeHttpRequest`å‡½æ•°çš„ä½œè€…ä¹Ÿä¸å¿…æ‹…å¿ƒæ¯æ¬¡å‡ºç°æ–°çš„è¾¹ç¼˜æƒ…å†µæ—¶éƒ½è¦ç¼–å†™å’Œæ›´æ–°æ–‡æ¡£ï¼Œå¦åˆ™ä¼šå¯¼è‡´å‡½æ•°æŠ›å‡ºé”™è¯¯ã€‚å‡½æ•°çš„æ‰€æœ‰è¡Œä¸ºéƒ½ç¼–ç åœ¨è¿”å›ç±»å‹ä¸­ã€‚ä¸æ­¤ç›¸å…³ï¼Œè¯¥ç±»å‹ç°åœ¨ä½œä¸ºæ–‡æ¡£:â€œ`makeHttpRequest`æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒå¯ä»¥é€šè¿‡`ResponseData`æˆåŠŸï¼Œä¹Ÿå¯ä»¥é€šè¿‡`Error`å¤±è´¥ã€‚â€

..."ä½†æ˜¯ï¼Œç­‰ç­‰ï¼Œæˆ‘å¦‚ä½•è·å¾—åŒ…è£…åœ¨`Result<T, E>`ä¸­çš„`T`å€¼æˆ–`E`å€¼ï¼Ÿ"

é—®å¾—å¥½ã€‚è®©æˆ‘å‘Šè¯‰ä½ æ€ä¹ˆåšã€‚æˆ‘ä»¬å°†ä½¿ç”¨æˆ‘åˆ¶ä½œçš„åä¸º`neverthrow`çš„åŒ…ã€‚

`> npm install neverthrow`

```
import { ok, err, Result } from 'neverthrow'

// we'll keep this simple
type ResponseBody = {}

interface ResponseData {
  statusCode: number
  responseBody?: ResponseBody
}

const makeHttpRequest = async (
  url: string
): Promise<Result<ResponseData, Error>> => {
  if (!isUrl(url)) {
    return err(new Error(
      'Invalid string passed into `makeHttpRequest`. Expected a valid URL.'
    ))
  }

  // ...
  // other business logic here
  // ...

  return ok({ ... }) // Ok(ResponseData)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥æˆ‘ä»¬ç°åœ¨åœ¨ä¸ä¸Šä¸€ä¸ªä»£ç ç‰‡æ®µç›¸åŒçš„åœ°æ–¹ï¼Œé™¤äº†è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨äº†`neverthrow`åŒ…ã€‚

å¦‚æœä½ é€šè¯»ä¸€ä¸‹`neverthrow` [æ–‡æ¡£](https://github.com/gdelgado14/neverthrow#top-level-api)ï¼Œä½ ä¼šçœ‹åˆ°`Result`æœ‰ä¸€ä¸ª`.map`æ–¹æ³•ï¼Œå®ƒè·å–`Result`ä¸­çš„`T`å€¼ï¼Œå¹¶å°†å…¶è½¬æ¢æˆä½ æƒ³è¦çš„ä»»ä½•å€¼ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­:

```
import { makeHttpRequest } from './http-api.ts'

const run = async () => {
  // unwrap the Promise
  // at this point
  // we have a Result<ResponseData, Error>
  const result = await makeHttpRequest('https://jsonplaceholder.typicode.com/todos/1')

  result.map(responseData => {
    console.log(responseData)
  })
}

run() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯ç­‰ç­‰ï¼Œå¦‚æœç»“æœå˜é‡åŒ…å«ä¸€ä¸ª`E`å€¼å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ª`Err`è€Œä¸æ˜¯ä¸€ä¸ª`Ok`ã€‚

å¥½å§ï¼ŒåŒæ ·çš„ï¼Œ`neverthrow`çš„æ–‡æ¡£ä¹Ÿå‘Šè¯‰ä½ å¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µ...å°±ç”¨`mapErr`ï¼

```
import { makeHttpRequest } from './http-api.ts'

const run = async () => {
  // unwrap the Promise
  // at this point
  // we have a Result<ResponseData, Error>
  const result = await makeHttpRequest('https://jsonplaceholder.typicode.com/todos/1')

  result.mapErr(errorInstance => {
    console.log(errorInstance)
  })
}

run() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…³äº`Result` s æœ€ç¾å¦™çš„äº‹æƒ…æ˜¯**å®ƒä»¬æ˜¯å¯é“¾æ¥çš„**ï¼ä¸‹é¢æ˜¯ä¸Šé¢ä»£ç ä¸­ä¸€ä¸ªæ›´ç°å®çš„ä¾‹å­:

```
import { makeHttpRequest } from './http-api.ts'

const run = async () => {
  // unwrap the Promise
  // at this point
  // we have a Result<ResponseData, Error>
  const result = await makeHttpRequest('https://jsonplaceholder.typicode.com/todos/1')

  result
    .map(responseData => {
      // do something with the success value
    })
    .mapErr(errorInstance => {
      // do something with the failure value
    })
}

run() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨`Result`ç±»å‹å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…(æŸ¥çœ‹[æ–‡æ¡£](https://github.com/gdelgado14/neverthrow#top-level-api)ï¼Œä½†æ˜¯`map` ing æ˜¯ API æœ€é‡è¦çš„éƒ¨åˆ†ã€‚

## [](#making-your-types-more-intuitive)è®©ä½ çš„ç±»å‹æ›´ç›´è§‚

å¦‚æœæ‚¨å¼€å§‹åœ¨è¿”å›ç±»å‹ä¸­å¤§é‡ä½¿ç”¨`Result`ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸¤ä»¶äº‹:

*   `Result` s çš„æ„æ€ä¸æ˜¯å¾ˆæ¸…æ¥š

    *   ç¤ºä¾‹:æ•°æ®åº“æŸ¥è¯¢çš„`Result`å¯èƒ½ç±»ä¼¼äº`Promise<Result<T, DbError>>`ï¼Œè€Œç½‘ç»œè°ƒç”¨çš„`Result`å¯èƒ½ç±»ä¼¼äº`Promise<Result<T, NetworkError>>`ã€‚
*   è¿™äº›ç±»å‹éå¸¸å†—é•¿ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢æˆ‘ä»¬æœ‰ä¸€ä¸ª`Promise<Result<ResponseData, Error>>`...è¿™æ˜¯æœ‰ç‚¹å“äººçš„ç±»å‹ï¼

è¦è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨**ç±»å‹åˆ«å**ï¼

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ã€‚ä¸å…¶è®©ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå¸¦æœ‰`DbError`çš„æ³›å‹`Result`ä½œä¸º`E`ç±»å‹ï¼Œä¸ºä»€ä¹ˆä¸å°†è¿™ä¸ªç±»å‹å‘½åä¸ºæ›´ç›´è§‚çš„ç±»å‹å‘¢ï¼Ÿ

```
type DbResult<T> = Result<T, DbError> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä½ çš„å‡½æ•°å¯ä»¥ç›´æ¥è¿”å›`Promise<DbResult<T>>`ã€‚ç®€æ´äº†å¾ˆå¤šï¼

æ­¤å¤–ï¼Œä½ çš„ç±»å‹ç°åœ¨ç¼–ç çš„æ„ä¹‰ã€‚ä¸Šé¢çš„ç±»å‹è¡¨æ˜æ­£åœ¨è¿›è¡Œçš„å¼‚æ­¥å¯èƒ½ä¼šå¤±è´¥ï¼Œæˆ‘çŸ¥é“å®ƒæ­£åœ¨å¤„ç†æ•°æ®åº“ã€‚æ•´æ´ï¼

è¿™æ˜¯æˆ‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­çš„ä¸€ä¸ªçœŸå®ä¾‹å­:

```
handler: (req: Request, res: SessionManager) => DecodeResult<Promise<RouteResult<T>>> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥`handler`æ˜¯ä¸€ä¸ªåšå‡ ä»¶äº‹çš„å‡½æ•°:

*   å®ƒå¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œè§£ç /ååºåˆ—åŒ–
*   ç„¶åå®ƒåšä¸€äº›å¼‚æ­¥çš„äº‹æƒ…ï¼Œç”¨ä¸€äº›ç±»å‹ä¸º`T`çš„æ•°æ®ç”Ÿæˆä¸€ä¸ª`RouteResult`

æˆ‘åªé€šè¿‡é˜…è¯»ç±»å‹å°±çŸ¥é“ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ç¾å¦™çš„æ˜¯ï¼Œæˆ‘æ°¸è¿œä¸ä¼šé‡åˆ°è¿è¡Œæ—¶é”™è¯¯ï¼Œå› ä¸ºæˆ‘çš„ä»£ç ä¸ä¼šæŠ›å‡º(æˆ‘æ‰€ä¾èµ–çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“éƒ½è¢«åŒ…è£…ä»¥è¿”å›`Result` s)ã€‚

## [](#summary)æ€»ç»“

*   å°½å¯èƒ½é¿å…ä½¿ç”¨`throw`ã€‚

    *   æ‚¨çš„ API çš„ç”¨æˆ·ä¸éœ€è¦`catch`(ç¼–è¯‘å™¨ä¸å¼ºåˆ¶æ‰§è¡Œ)ã€‚è¿™æ„å‘³ç€æ‚¨æœ€ç»ˆä¼šé‡åˆ°è¿è¡Œæ—¶é”™è¯¯...è¿™åªæ˜¯æ—¶é—´é—®é¢˜
    *   ä½¿ç”¨`throw`è¿«ä½¿æ‚¨ç»´æŠ¤æœ€ç»ˆä¼šå˜å¾—é™ˆæ—§çš„æ–‡æ¡£
    *   å¦‚æœä½ è®¾æ³•ç»´æŠ¤ä½ çš„æ–‡æ¡£ï¼Œå¾ˆå¤šäººä¸ä¼šè´¹å¿ƒé€šè¯»æ–‡æ¡£ï¼Œä¹Ÿä¸ä¼šæ„è¯†åˆ°ä½ çš„å‡½æ•°åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºé”™
*   ä½¿ç”¨`Result` s å°†å¤±è´¥çš„å¯èƒ½æ€§ç¼–ç åˆ°ä½ çš„ç±»å‹ä¸­

    *   è¿™äº›ç±»å‹æ˜¯è‡ªæ–‡æ¡£åŒ–çš„ï¼Œå®ƒä»¬ä¸ä¼šå˜å¾—â€œé™ˆæ—§â€
    *   ç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½çš„ APIï¼Œè®©ä»–ä»¬ä»¥å®‰å…¨çš„æ–¹å¼å¤„ç†å¤±è´¥å€¼(ä½¿ç”¨`map`å’Œ`mapErr`)
*   æœ‰ä¸€ä¸ªç»è¿‡å…¨é¢æµ‹è¯•å’Œç±»å‹æ£€æŸ¥çš„ npm åŒ…å«åš`neverthrow`...è¯•è¯•å§ï¼