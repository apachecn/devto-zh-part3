# é‡‡ç”¨ Spring Boot å’Œ Spring Cloud çš„ Java å¾®æœåŠ¡

> åŸæ–‡:[https://dev . to/oktadev/Java-micro services-with-spring-boot-and-spring-cloud-ijd](https://dev.to/oktadev/java-microservices-with-spring-boot-and-spring-cloud-ijd)

åœ¨å¼€å‘å¾®æœåŠ¡æ¶æ„æ—¶ï¼ŒJava æ˜¯ä¸€ç§å¾ˆå¥½çš„è¯­è¨€ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¡Œä¸šä¸­çš„ä¸€äº›å¤§ç‰Œéƒ½åœ¨ç”¨å®ƒã€‚ä½ å¬è¯´è¿‡ç½‘é£ã€äºšé©¬é€Šæˆ–è°·æ­Œå—ï¼Ÿæ˜“è´ã€æ¨ç‰¹å’Œé¢†è‹±å‘¢ï¼Ÿæ˜¯çš„ï¼Œå¤„ç†éš¾ä»¥ç½®ä¿¡çš„æµé‡çš„ä¸»è¦å…¬å¸æ­£åœ¨ç”¨ Java åšè¿™ä»¶äº‹ã€‚

ç”¨ Java å®ç°å¾®æœåŠ¡æ¶æ„å¹¶ä¸é€‚åˆæ‰€æœ‰äººã€‚å°±æ­¤è€Œè¨€ï¼Œé€šå¸¸ä¸éœ€è¦å®æ–½å¾®æœåŠ¡ã€‚å¤§å¤šæ•°å…¬å¸è¿™æ ·åšæ˜¯ä¸ºäº†æ‰©å±•ä»–ä»¬çš„äººå‘˜ï¼Œè€Œä¸æ˜¯ä»–ä»¬çš„ç³»ç»Ÿã€‚å¦‚æœä½ æƒ³æ‰©å¤§ä½ çš„äººå‘˜è§„æ¨¡ï¼Œé›‡ä½£ Java å¼€å‘äººå‘˜æ˜¯æœ€å¥½çš„æ–¹æ³•ä¹‹ä¸€ã€‚æ¯•ç«Ÿï¼Œç²¾é€š Java çš„å¼€å‘äººå‘˜æ¯”å¤§å¤šæ•°å…¶ä»–è¯­è¨€éƒ½å¤šâ€”â€”å°½ç®¡ JavaScript ä¼¼ä¹æ­£åœ¨è¿…é€Ÿèµ¶ä¸Šæ¥ï¼

Java ç”Ÿæ€ç³»ç»Ÿæœ‰ä¸€äº›å¼€å‘å¾®æœåŠ¡æ¶æ„çš„æˆç†Ÿæ¨¡å¼ã€‚å¦‚æœä½ ç†Ÿæ‚‰ Springï¼Œä½ ä¼šè§‰å¾—ç”¨ Spring Boot å’Œ Spring Cloud å¼€å‘å°±åƒåœ¨å®¶é‡Œä¸€æ ·ã€‚å› ä¸ºè¿™æ˜¯æœ€å¿«çš„å…¥é—¨æ–¹å¼ä¹‹ä¸€ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘åº”è¯¥å¸¦ä½ çœ‹ä¸€ä¸ªå¿«é€Ÿæ•™ç¨‹ã€‚

## [](#create-java-microservices-with-spring-cloud-and-spring-boot)ç”¨æ˜¥äº‘å’Œ Spring Boot æ‰“é€  Java å¾®æœåŠ¡

åœ¨æˆ‘çš„å¤§éƒ¨åˆ†æ•™ç¨‹ä¸­ï¼Œæˆ‘å‘ä½ å±•ç¤ºäº†å¦‚ä½•ä»å¤´å¼€å§‹æ„å»ºä¸€åˆ‡ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³é‡‡ç”¨ä¸€ç§ä¸åŒçš„æ–¹æ³•ï¼Œé€šè¿‡ä¸€ä¸ªé¢„å…ˆæ„å»ºçš„ç¤ºä¾‹ä¸æ‚¨äº¤æµã€‚å¸Œæœ›ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªæœ‰ç‚¹çŸ­ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚

å¯ä»¥ä»å…‹éš†[@ oktadeveloper/Java-micro services-examples](https://github.com/oktadeveloper/java-microservices-examples)èµ„æºåº“å¼€å§‹ã€‚

```
git clone https://github.com/oktadeveloper/java-microservices-examples.git
cd java-microservices-examples/spring-boot+cloud 
```

åœ¨`spring-boot+cloud`ç›®å½•ä¸­ï¼Œæœ‰ä¸‰ä¸ªé¡¹ç›®:

*   **å‘ç°æœåŠ¡**:ç½‘é£å°¤é‡Œå¡æœåŠ¡å™¨ï¼Œç”¨äºæœåŠ¡å‘ç°ã€‚

*   **car-service** :ä¸€ä¸ªç®€å•çš„æ±½è½¦æœåŠ¡ï¼Œä½¿ç”¨ Spring Data REST æ¥æä¾›æ±½è½¦çš„ REST APIã€‚

*   **api-gateway** :ä¸€ä¸ª api ç½‘å…³ï¼Œæœ‰ä¸€ä¸ª`/cool-cars`ç«¯ç‚¹ï¼Œä¸`car-service`å¯¹è¯ï¼Œè¿‡æ»¤æ‰ä¸é…·çš„æ±½è½¦(å½“ç„¶æ˜¯åœ¨æˆ‘çœ‹æ¥)ã€‚

æˆ‘ä½¿ç”¨ start.spring.io çš„ REST API å’Œ T2 çš„ HTTPie åˆ›å»ºäº†æ‰€æœ‰è¿™äº›åº”ç”¨ç¨‹åºã€‚

```
http https://start.spring.io/starter.zip javaVersion==11 \
  artifactId==discovery-service name==eureka-service \
  dependencies==cloud-eureka-server baseDir==discovery-service | tar -xzvf -

http https://start.spring.io/starter.zip \
  artifactId==car-service name==car-service baseDir==car-service \
  dependencies==actuator,cloud-eureka,data-jpa,h2,data-rest,web,devtools,lombok | tar -xzvf -

http https://start.spring.io/starter.zip \
  artifactId==api-gateway name==api-gateway baseDir==api-gateway \
  dependencies==cloud-eureka,cloud-feign,data-rest,web,cloud-hystrix,lombok | tar -xzvf - 
```

### [](#spring-microservices-with-java-11)ç”¨ Java 11+çš„ Spring å¾®æœåŠ¡

ä¸ºäº†è®©`discovery-service`åœ¨ Java 11 ä¸Šè¿è¡Œï¼Œæˆ‘å¿…é¡»æ·»åŠ å¯¹ JAXB çš„ä¾èµ–ã€‚

```
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
</dependency> 
```

å…¶ä»–ä¸¤ä¸ªåº”ç”¨ç¨‹åºåœ¨ Java 11 ä¸Šå¼€ç®±å³ç”¨ï¼Œè¿è¡Œè‰¯å¥½ï¼Œä¸éœ€è¦æ”¹å˜ä¾èµ–å…³ç³»ã€‚

## [](#java-service-discovery-with-netflix-eureka)Java æœåŠ¡å‘ç°ä¸ç½‘é£å°¤é‡Œå¡

`discovery-service`çš„é…ç½®ä¸å¤§å¤šæ•° Eureka æœåŠ¡å™¨ç›¸åŒã€‚å®ƒä½œä¸ºå…¶ä¸»ç±»å’Œå±æ€§ä¸Šçš„ä¸€ä¸ª`@EnableEurekaServer`æ³¨é‡Šï¼Œè®¾ç½®å…¶ç«¯å£å¹¶å…³é—­å‘ç°ã€‚

```
server.port=8761
eureka.client.register-with-eureka=false 
```

`car-service`å’Œ`api-gateway`é¡¹ç›®çš„é…ç½®æ–¹å¼ç±»ä¼¼ã€‚ä¸¤è€…éƒ½å®šä¹‰äº†å”¯ä¸€çš„åç§°ï¼Œå¹¶ä¸”`car-service`è¢«é…ç½®ä¸ºåœ¨ç«¯å£`8090`ä¸Šè¿è¡Œï¼Œå› æ­¤å®ƒä¸ä¼šä¸`8080`å†²çªã€‚

*æ±½è½¦æœåŠ¡/src/main/resources/application . properties*T2ã€‘

```
server.port=8090
spring.application.name=car-service 
```

*API-gateway/src/main/resources/application . properties*

```
spring.application.name=api-gateway 
```

ä¸¤ä¸ªé¡¹ç›®ä¸­çš„ä¸»ç±»éƒ½ç”¨`@EnableDiscoveryClient`è¿›è¡Œäº†æ³¨é‡Šã€‚

## [](#build-a-java-microservice-with-spring-data-rest)ç”¨ Spring Data REST æ­å»º Java å¾®æœåŠ¡

`car-service`æä¾›äº†ä¸€ä¸ª REST APIï¼Œå…è®¸æ‚¨ CRUD(åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤)carsã€‚å½“åº”ç”¨ç¨‹åºä½¿ç”¨ä¸€ä¸ª`ApplicationRunner` bean åŠ è½½æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ç»„é»˜è®¤çš„ carsã€‚

*car-service/src/main/Java/com/example/car service/carserviceapplication . Java*

```
package com.example.carservice;

import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.NonNull;
import org.springframework.boot.ApplicationRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.context.annotation.Bean;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.rest.core.annotation.RepositoryRestResource;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import java.util.stream.Stream;

@EnableDiscoveryClient
@SpringBootApplication
public class CarServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(CarServiceApplication.class, args);
    }

    @Bean
    ApplicationRunner init(CarRepository repository) {
        return args -> {
            Stream.of("Ferrari", "Jaguar", "Porsche", "Lamborghini", "Bugatti",
                    "AMC Gremlin", "Triumph Stag", "Ford Pinto", "Yugo GV").forEach(name -> {
                repository.save(new Car(name));
            });
            repository.findAll().forEach(System.out::println);
        };
    }
}

@Data
@NoArgsConstructor
@Entity
class Car {

    public Car(String name) {
        this.name = name;
    }

    @Id
    @GeneratedValue
    private Long id;

    @NonNull
    private String name;
}

@RepositoryRestResource
interface CarRepository extends JpaRepository<Car, Long> {
} 
```

### [](#spring-cloud-feign-and-hystrix-in-an-api-gateway)ä¸€ä¸ª API ç½‘å…³ä¸­çš„ Spring Cloud + Feign å’Œ Hystrix

[Feign](https://github.com/OpenFeign/feign) è®©ç¼–å†™ Java HTTP å®¢æˆ·ç«¯æ›´å®¹æ˜“ã€‚Spring Cloud ä½¿å¾—ç”¨å‡ è¡Œä»£ç åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå®¢æˆ·ç«¯æˆä¸ºå¯èƒ½ã€‚ [Hystrix](https://github.com/Netflix/Hystrix) å¯ä»¥ä¸ºä½ çš„è™šæ‹Ÿå®¢æˆ·ç«¯æ·»åŠ æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œè®©å®ƒä»¬æ›´æœ‰å¼¹æ€§ã€‚

`api-gateway`ä½¿ç”¨ Feign å’Œ Hystrix ä¸ä¸‹æ¸¸çš„`car-service`å¯¹è¯ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œåˆ™æ•…éšœè½¬ç§»åˆ°ä¸€ä¸ª`fallback()`æ–¹æ³•ã€‚å®ƒè¿˜å…¬å¼€äº†ä¸€ä¸ª`/cool-cars`ç«¯ç‚¹ï¼Œè¿‡æ»¤æ‰æ‚¨å¯èƒ½ä¸æƒ³æ‹¥æœ‰çš„æ±½è½¦ã€‚

*API-gateway/src/main/Java/com/example/API gateway/API gateway application . Java*

```
package com.example.apigateway;

import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import lombok.Data;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.hateoas.Resources;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.Collection;
import java.util.stream.Collectors;

@EnableFeignClients
@EnableCircuitBreaker
@EnableDiscoveryClient
@EnableZuulProxy
@SpringBootApplication
public class ApiGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApiGatewayApplication.class, args);
    }
}

@Data
class Car {
    private String name;
}

@FeignClient("car-service")
interface CarClient {

    @GetMapping("/cars")
    @CrossOrigin
    Resources<Car> readCars();
}

@RestController
class CoolCarController {

    private final CarClient carClient;

    public CoolCarController(CarClient carClient) {
        this.carClient = carClient;
    }

    private Collection<Car> fallback() {
        return new ArrayList<>();
    }

    @GetMapping("/cool-cars")
    @CrossOrigin
    @HystrixCommand(fallbackMethod = "fallback")
    public Collection<Car> goodCars() {
        return carClient.readCars()
                .getContent()
                .stream()
                .filter(this::isCool)
                .collect(Collectors.toList());
    }

    private boolean isCool(Car car) {
        return !car.getName().equals("AMC Gremlin") &&
                !car.getName().equals("Triumph Stag") &&
                !car.getName().equals("Ford Pinto") &&
                !car.getName().equals("Yugo GV");
    }
} 
```

## [](#run-a-java-microservices-architecture)è¿è¡Œä¸€ä¸ª Java å¾®æœåŠ¡æ¶æ„

å¦‚æœä½ åœ¨å•ç‹¬çš„ç»ˆç«¯çª—å£ä¸­ç”¨`./mvnw`è¿è¡Œæ‰€æœ‰è¿™äº›æœåŠ¡ï¼Œä½ å¯ä»¥å¯¼èˆªåˆ°`http://localhost:8761`å¹¶çœ‹åˆ°å®ƒä»¬å·²ç»åœ¨ Eureka æ³¨å†Œäº†ã€‚

[![Eureka Server](../Images/4dc2b963b77f173fcc766b1658b6ce7f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--21p6ttxH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/java-microservices/eureka-server-d63b0113f94b54a7191de98b2989862f6b8bf1be9bbdb12124a6f59c279d432e.png)

å¦‚æœä½ åœ¨æµè§ˆå™¨ä¸­å¯¼èˆªåˆ°`http://localhost:8080/cool-bars`ï¼Œä½ å°†è¢«é‡å®šå‘åˆ° Oktaã€‚æä»€ä¹ˆï¼Ÿ

## [](#secure-java-microservices-with-oauth-20-and-oidc)ç”¨ OAuth 2.0 å’Œ OIDC ä¿æŠ¤ Java å¾®æœåŠ¡

æˆ‘å·²ç»ä½¿ç”¨ OAuth 2.0 å’Œ OIDC åœ¨è¿™ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­é…ç½®äº†å®‰å…¨æ€§ã€‚ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸOIDC æ˜¯ OAuth 2.0 çš„æ‰©å±•ï¼Œå®ƒæä¾›äº†èº«ä»½ã€‚å®ƒè¿˜æä¾›äº†å‘ç°åŠŸèƒ½ï¼Œå› æ­¤æ‰€æœ‰ä¸åŒçš„ OAuth 2.0 ç«¯ç‚¹éƒ½å¯ä»¥ä»ä¸€ä¸ª URL(ç§°ä¸º`issuer`)ä¸­è¢«å‘ç°ã€‚

æˆ‘æ˜¯å¦‚ä½•ä¸ºæ‰€æœ‰è¿™äº›å¾®æœåŠ¡é…ç½®å®‰å…¨æ€§çš„ï¼Ÿå¾ˆé«˜å…´ä½ é—®äº†ï¼

æˆ‘æŠŠ Okta çš„ Spring Boot é¦–å‘åŠ åˆ°äº†`api-gateway`å’Œ`car-service` :
ä¸­çš„`pom.xml`

```
<dependency>
    <groupId>com.okta.spring</groupId>
    <artifactId>okta-spring-boot-starter</artifactId>
    <version>1.2.0</version>
</dependency> 
```

ç„¶åæˆ‘åœ¨ Okta ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ OIDC åº”ç”¨ç¨‹åºï¼Œé…ç½®äº†æˆæƒä»£ç æµã€‚å¦‚æœæ‚¨æƒ³çœ‹åˆ°ä¸€åˆ‡éƒ½åœ¨è¿è¡Œï¼Œæ‚¨éœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤ã€‚

### [](#create-a-web-application-in-okta)åœ¨ Okta ä¸­åˆ›å»ºä¸€ä¸ª Web åº”ç”¨

ç™»å½•ä½ çš„ Okta å¼€å‘è€…è´¦å·(æˆ–è€…[æ³¨å†Œ](https://developer.okta.com/signup/)å¦‚æœä½ æ²¡æœ‰è´¦å·çš„è¯)ã€‚

1.  ä»**åº”ç”¨**é¡µé¢ï¼Œé€‰æ‹©**æ·»åŠ åº”ç”¨**ã€‚

2.  åœ¨åˆ›å»ºæ–°åº”ç”¨ç¨‹åºé¡µé¢ä¸Šï¼Œé€‰æ‹© **Web** ã€‚

3.  ç»™ä½ çš„ app èµ·ä¸ªå¥½è®°çš„åå­—ï¼Œæ·»åŠ `http://localhost:8080/login/oauth2/code/okta`ä½œä¸ºç™»å½•é‡å®šå‘ URIï¼Œé€‰æ‹©**åˆ·æ–°ä»¤ç‰Œ**(é™¤äº†**æˆæƒç **ï¼Œç‚¹å‡»**å®Œæˆ**ã€‚

å°†å‘è¡Œè€…(åœ¨ **API** > **æˆæƒæœåŠ¡å™¨**ä¸‹æ‰¾åˆ°)ã€å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯ç§˜å¯†å¤åˆ¶åˆ°ä¸¤ä¸ªé¡¹ç›®çš„`application.properties`ä¸­ã€‚

```
okta.oauth2.issuer=$issuer
okta.oauth2.client-id=$clientId
okta.oauth2.client-secret=$clientSecret 
```

ä¸‹ä¸€èŠ‚ä¸­çš„ Java ä»£ç å·²ç»å­˜åœ¨ï¼Œä½†æ˜¯æˆ‘æƒ³æˆ‘åº”è¯¥è§£é‡Šä¸€ä¸‹ï¼Œè¿™æ ·ä½ å°±çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚

### [](#configure-spring-security-for-oauth-20-login-and-resource-server)ä¸º OAuth 2.0 ç™»å½•å’Œèµ„æºæœåŠ¡å™¨é…ç½® Spring å®‰å…¨

åœ¨`ApiGatewayApplication.java`ä¸­ï¼Œæˆ‘æ·»åŠ äº† Spring å®‰å…¨é…ç½®æ¥å¯ç”¨ OAuth 2.0 ç™»å½•ï¼Œå¹¶å¯ç”¨ç½‘å…³ä½œä¸ºèµ„æºæœåŠ¡å™¨ã€‚

```
@Configuration
static class OktaOAuth2WebSecurityConfigurerAdapter extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http
            .authorizeRequests().anyRequest().authenticated()
                .and()
            .oauth2Login()
                .and()
            .oauth2ResourceServer().jwt();
        // @formatter:on
    }
} 
```

æœ¬ä¾‹ä¸­æ²¡æœ‰ä½¿ç”¨èµ„æºæœåŠ¡å™¨é…ç½®ï¼Œä½†æˆ‘æ·»åŠ äº†å®ƒï¼Œä»¥é˜²æ‚¨æƒ³è¦å°†ç§»åŠ¨åº”ç”¨ç¨‹åºæˆ– SPA è¿æ¥åˆ°è¯¥ç½‘å…³ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ SPAï¼Œæ‚¨è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ª bean æ¥é…ç½® CORSã€‚

```
@Bean
public FilterRegistrationBean<CorsFilter> simpleCorsFilter() {
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    CorsConfiguration config = new CorsConfiguration();
    config.setAllowCredentials(true);
    config.setAllowedOrigins(Collections.singletonList("*"));
    config.setAllowedMethods(Collections.singletonList("*"));
    config.setAllowedHeaders(Collections.singletonList("*"));
    source.registerCorsConfiguration("/**", config);
    FilterRegistrationBean<CorsFilter> bean = new FilterRegistrationBean<>(new CorsFilter(source));
    bean.setOrder(Ordered.HIGHEST_PRECEDENCE);
    return bean;
} 
```

**æ³¨æ„**:å¦‚æœä½ ç¡®å®ä½¿ç”¨äº†åƒè¿™æ ·çš„ CORS è¿‡æ»¤å™¨ï¼Œæˆ‘å»ºè®®ä½ æŠŠæ¥æºã€æ–¹æ³•å’Œå¤´ä¿®æ”¹å¾—æ›´å…·ä½“äº›ï¼Œä»¥å¢åŠ å®‰å…¨æ€§ã€‚

`CarServiceApplication.java`åªè¢«é…ç½®ä¸ºèµ„æºæœåŠ¡å™¨ï¼Œå› ä¸ºå®ƒä¸ä¼šè¢«ç›´æ¥è®¿é—®ã€‚

```
@Configuration
static class OktaOAuth2WebSecurityConfigurerAdapter extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // @formatter:off
        http
            .authorizeRequests().anyRequest().authenticated()
                .and()
            .oauth2ResourceServer().jwt();
        // @formatter:on
    }
} 
```

ä¸ºäº†ä½¿ API ç½‘å…³èƒ½å¤Ÿè®¿é—®æ±½è½¦æœåŠ¡ï¼Œæˆ‘åœ¨ API ç½‘å…³é¡¹ç›®ä¸­åˆ›å»ºäº†ä¸€ä¸ª`UserFeignClientInterceptor.java`ã€‚

*API-gateway/src/main/Java/com/example/API gateway/userfeignclientinterceptor . Java*

```
package com.example.apigateway;

import feign.RequestInterceptor;
import feign.RequestTemplate;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.stereotype.Component;

@Component
public class UserFeignClientInterceptor implements RequestInterceptor {
    private static final String AUTHORIZATION_HEADER = "Authorization";
    private static final String BEARER_TOKEN_TYPE = "Bearer";
    private final OAuth2AuthorizedClientService clientService;

    public UserFeignClientInterceptor(OAuth2AuthorizedClientService clientService) {
        this.clientService = clientService;
    }

    @Override
    public void apply(RequestTemplate template) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        OAuth2AuthenticationToken oauthToken = (OAuth2AuthenticationToken) authentication;
        OAuth2AuthorizedClient client = clientService.loadAuthorizedClient(
                oauthToken.getAuthorizedClientRegistrationId(),
                oauthToken.getName());

        OAuth2AccessToken accessToken = client.getAccessToken();
        template.header(AUTHORIZATION_HEADER, String.format("%s %s", BEARER_TOKEN_TYPE, accessToken.getTokenValue()));
    }
} 
```

æˆ‘åœ¨`ApiGatewayApplication.java` :
ä¸­å°†å…¶é…ç½®ä¸º`RequestInterceptor`

```
@Bean
public RequestInterceptor getUserFeignClientInterceptor(OAuth2AuthorizedClientService clientService) {
    return new UserFeignClientInterceptor(clientService);
} 
```

å¹¶ä¸”ï¼Œæˆ‘åœ¨`api-gateway/src/main/resources/application.properties`ä¸­æ·»åŠ äº†ä¸¤ä¸ªå±æ€§ï¼Œå› æ­¤ Feign æ˜¯ Spring å®‰å…¨æ„ŸçŸ¥çš„ã€‚

```
feign.hystrix.enabled=true
hystrix.shareSecurityContext=true 
```

## [](#see-java-microservices-running-with-security-enabled)æŸ¥çœ‹å¯ç”¨å®‰å…¨çš„ Java å¾®æœåŠ¡è¿è¡Œ

ä½¿ç”¨`./mvnw`åœ¨å•ç‹¬çš„ç»ˆç«¯çª—å£ä¸­è¿è¡Œæ‰€æœ‰çš„åº”ç”¨ç¨‹åºï¼Œæˆ–è€…åœ¨æ‚¨çš„ IDE ä¸­è¿è¡Œï¼Œå¦‚æœæ‚¨æ„¿æ„çš„è¯ã€‚

**æç¤º**:ä¸ºäº†ç®€åŒ–åœ¨ IDE ä¸­çš„è¿è¡Œï¼Œåœ¨æ ¹ç›®å½•ä¸­æœ‰ä¸€ä¸ªèšåˆå™¨`pom.xml`ã€‚å¦‚æœä½ å·²ç»å®‰è£…äº† [IntelliJ IDEA çš„å‘½ä»¤è¡Œå¯åŠ¨å™¨](https://emmanuelbernard.com/blog/2017/02/27/start-intellij-idea-command-line/)ï¼Œä½ åªéœ€è¦è¿è¡Œ`idea pom.xml`ã€‚

å¯¼èˆªåˆ°`http://localhost:8080/cool-cars`ï¼Œä½ å°†è¢«é‡å®šå‘åˆ° Okta è¿›è¡Œç™»å½•ã€‚

[![Okta Login](../Images/aaed0bf89229bc1125779692ebac6f98.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CMF5Ov1E--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/java-microservices/okta-login-843a59bf22b807807090cf5b897a75b7a58cf56e8c03f7247a8f52358f6db447.png)

è¾“å…¥ä½ çš„ Okta å¼€å‘è€…è´¦æˆ·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªé…·è½¦åˆ—è¡¨ã€‚

[![Cool Cars](../Images/00b20ba8e7597bd46e15b5675b4bc184.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--TGgujzOF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/java-microservices/cool-cars-9bfa3deaddca250e8de5b0f022b4ab00968c1204f71e3e1671095466f0e06af8.png)

å¦‚æœæ‚¨å·²ç»åšåˆ°äº†è¿™ä¸€æ­¥ï¼Œå¹¶ä¸”è¿è¡Œäº†ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæ­å–œæ‚¨ï¼ä½ è¶…çº§é…·ï¼ğŸ˜

## [](#use-netflix-zuul-and-spring-cloud-to-proxy-routes)ä½¿ç”¨ç½‘é£ç¥–å°”å’Œæ˜¥äº‘æ¥ä»£ç†èˆªçº¿

å¾®æœåŠ¡æ¶æ„ä¸­å¦ä¸€ä¸ªä½ å¯èƒ½å–œæ¬¢çš„ä¾¿åˆ©ç‰¹æ€§æ˜¯[ç½‘é£Â·ç¥–å°”](https://github.com/Netflix/zuul)ã€‚Zuul æ˜¯ä¸€ç§ç½‘å…³æœåŠ¡ï¼Œæä¾›åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å¼¹æ€§ç­‰åŠŸèƒ½ã€‚

ä¸ºäº†æ·»åŠ  Zuulï¼Œæˆ‘å°†å…¶ä½œä¸ºä¾èµ–é¡¹æ·»åŠ åˆ°`api-gateway/pom.xml` :

```
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
</dependency> 
```

ç„¶åæˆ‘æŠŠ`@EnableZuulProxy`åŠ åˆ°äº†`ApiGatewayApplication`ç±»ä¸­ã€‚

```
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@EnableZuulProxy
@SpringBootApplication
public class ApiGatewayApplication {
    ...
} 
```

ä¸ºäº†å°†è®¿é—®ä»¤ç‰Œä¼ é€’ç»™ä»£ç†è·¯ç”±ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªæ‰©å±•äº†`ZuulFilter`çš„`AuthorizationHeaderFilter`ç±»ã€‚

```
package com.example.apigateway;

import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import org.springframework.core.Ordered;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.security.oauth2.core.oidc.OidcUserInfo;

import java.util.Optional;

import static org.springframework.cloud.netflix.zuul.filters.support.FilterConstants.PRE_TYPE;

public class AuthorizationHeaderFilter extends ZuulFilter {

    private final OAuth2AuthorizedClientService clientService;

    public AuthorizationHeaderFilter(OAuth2AuthorizedClientService clientService) {
        this.clientService = clientService;
    }

    @Override
    public String filterType() {
        return PRE_TYPE;
    }

    @Override
    public int filterOrder() {
        return Ordered.LOWEST_PRECEDENCE;
    }

    @Override
    public boolean shouldFilter() {
        return true;
    }

    @Override
    public Object run() {
        RequestContext ctx = RequestContext.getCurrentContext();
        Optional<String> authorizationHeader = getAuthorizationHeader();
        authorizationHeader.ifPresent(s -> ctx.addZuulRequestHeader("Authorization", s));
        return null;
    }

    private Optional<String> getAuthorizationHeader() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        OAuth2AuthenticationToken oauthToken = (OAuth2AuthenticationToken) authentication;
        OAuth2AuthorizedClient client = clientService.loadAuthorizedClient(
                oauthToken.getAuthorizedClientRegistrationId(),
                oauthToken.getName());

        OAuth2AccessToken accessToken = client.getAccessToken();

        if (accessToken == null) {
            return Optional.empty();
        } else {
            String tokenType = accessToken.getTokenType().getValue();
            String authorizationHeaderValue = String.format("%s %s", tokenType, accessToken.getTokenValue());
            return Optional.of(authorizationHeaderValue);
        }
    }
} 
```

**æ³¨æ„**:ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°`getAuthorizationHeader()`æ–¹æ³•ä¸­çš„ä»£ç ä¸`UserFeignClientInterceptor`ä¸­çš„ä»£ç éå¸¸ç›¸ä¼¼ã€‚å› ä¸ºåªæœ‰å‡ è¡Œä»£ç ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ä¸å°†å®ƒä»¬ç§»åˆ°å®ç”¨ç¨‹åºç±»ä¸­ã€‚Feign æ‹¦æˆªå™¨ç”¨äº`@FeignClient`ï¼Œè€Œ Zuul è¿‡æ»¤å™¨ç”¨äº Zuul ä»£ç†çš„è¯·æ±‚ã€‚

ä¸ºäº†è®© Spring Boot å’Œç¥–å°”çŸ¥é“è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œæˆ‘åœ¨ä¸»åº”ç”¨ç¨‹åºç±»ä¸­å°†å®ƒæ³¨å†Œä¸ºä¸€ä¸ª beanã€‚

```
public AuthorizationHeaderFilter authHeaderFilter(OAuth2AuthorizedClientService clientService) {
    return new AuthorizationHeaderFilter(clientService);
} 
```

ä¸ºäº†ä»£ç†ä» API ç½‘å…³åˆ°æ±½è½¦æœåŠ¡çš„è¯·æ±‚ï¼Œæˆ‘å‘`api-gateway/src/main/resources/application.properties`æ·»åŠ äº†è·¯ç”±ã€‚

```
zuul.routes.car-service.path=/cars
zuul.routes.car-service.url=http://localhost:8090

zuul.routes.home.path=/home
zuul.routes.home.url=http://localhost:8090

zuul.sensitive-headers=Cookie,Set-Cookie 
```

æˆ‘åœ¨`/home`è·¯çº¿çš„`car-service`é¡¹ç›®ä¸­æ·»åŠ äº†ä¸€ä¸ª`HomeController`ã€‚

```
package com.example.carservice;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.security.Principal;

@RestController
public class HomeController {

    private final static Logger log = LoggerFactory.getLogger(HomeController.class);

    @GetMapping("/home")
    public String howdy(Principal principal) {
        String username = principal.getName();
        JwtAuthenticationToken token = (JwtAuthenticationToken) principal;
        log.info("claims: " + token.getTokenAttributes());
        return "Hello, " + username;
    }
} 
```

### [](#confirm-your-zuul-routes-work)ç¡®è®¤æ‚¨çš„ Zuul è·¯çº¿å·¥ä½œ

ç”±äºè¿™äº›æ›´æ”¹å·²ç»å­˜åœ¨äºæ‚¨å…‹éš†çš„é¡¹ç›®ä¸­ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹`https://localhost:8080/cars`å’Œ`http://localhost:8080/home`ã€‚

[![Home with Zuul](../Images/6db1a8d1279cd083759631d3e0e64e6b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--XELXir9X--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/java-microservices/zuul-home-3f3e8ce8ceb1789cddb5d4386cca1de64f080e4f3220370d98790cf1bb0c041b.png)

## [](#what-about-spring-cloud-config)æ˜¥äº‘é…ç½®æ€ä¹ˆæ ·ï¼Ÿ

åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæ‚¨å¿…é¡»åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­é…ç½® OIDC å±æ€§ã€‚å¦‚æœæ‚¨æœ‰ 500 ä¸ªå¾®æœåŠ¡ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªçœŸæ­£çš„éš¾é¢˜ã€‚æ˜¯çš„ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬å®šä¹‰ä¸ºç¯å¢ƒå˜é‡ï¼Œè¿™å°±è§£å†³äº†é—®é¢˜ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨æœ‰ä½¿ç”¨ä¸åŒ OIDC å®¢æˆ·ç«¯ id çš„ä¸åŒå¾®æœåŠ¡å †æ ˆï¼Œè¿™ç§æ–¹æ³•å°†ä¼šå¾ˆå›°éš¾ã€‚

[Spring Cloud Config](https://spring.io/projects/spring-cloud-config) æ˜¯ä¸€ä¸ªä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›å¤–éƒ¨åŒ–é…ç½®çš„é¡¹ç›®ã€‚æˆ‘å°†åœ¨ä»¥åçš„æ•™ç¨‹ä¸­ä»‹ç»å®ƒï¼Œè€Œä¸æ˜¯æŠŠå®ƒæ·»åŠ åˆ°è¿™ä¸ªä¾‹å­ä¸­ã€‚

## [](#what-about-kotlin)ç§‘ç‰¹æ—å‘¢ï¼Ÿ

æˆ‘ç”¨ Java å†™äº†è¿™ç¯‡æ–‡ç« ï¼Œå› ä¸ºå®ƒæ˜¯ Java ç”Ÿæ€ç³»ç»Ÿä¸­æœ€æµè¡Œçš„è¯­è¨€ã€‚ç„¶è€Œï¼Œæ ¹æ® RedMonk ä» 2019 å¹´ 1 æœˆå¼€å§‹çš„ç¼–ç¨‹è¯­è¨€æ’åï¼Œ [Kotlin æ­£åœ¨ä¸Šå‡](https://redmonk.com/sogrady/2019/03/20/language-rankings-1-19/)ã€‚

> è‡³å°‘åœ¨æœ¬å­£åº¦ï¼ŒKotlin å®ç°äº†å¤§å¹…å¢é•¿ï¼Œè€Œå…¶ä»–ä¸‰å®¶åŸºäº JVM çš„åŒè¡Œéƒ½å‡ºç°äº†ä¸‹æ»‘ã€‚äº‹å®ä¸Šï¼ŒKotlin çš„è¿›æ­¥å¦‚æ­¤ä¹‹å¤§ï¼Œä»¥è‡³äºå®ƒæœ€ç»ˆè¿›å…¥äº†å‰ 20 åï¼Œæ’åœ¨ç¬¬ 20 ä½ï¼ŒåŒæ—¶è¿˜è¶…è¶Šäº† Clojure (#24)å’Œ Groovy (#24)ã€‚å®ƒä»ç„¶è¿œè¿œè½åäº Scala(ç¬¬ 13 ä½)ï¼Œä½† Kotlin çš„å¢é•¿åœ¨è¿™äº›æ’åçš„å†å²ä¸Šä»…æ¬¡äº Swiftï¼Œå› æ­¤çœ‹çœ‹æ¥ä¸‹æ¥çš„ä¸€ä¸¤æ¬¡è¿è¡Œä¼šæ˜¯æœ‰è¶£çš„ã€‚

Spring å¯¹ Kotlin æœ‰æå¥½çš„æ”¯æŒï¼Œä½ å¯ä»¥åœ¨ start.spring.io ä¸Šé€‰æ‹©å®ƒä½œä¸ºä¸€ç§è¯­è¨€ã€‚å¦‚æœä½ æƒ³çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨ Kotlin å†™æ›´å¤šçš„å¸–å­ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä»¬ï¼

## [](#known-issues-with-refresh-tokens)åˆ·æ–°ä»¤ç‰Œçš„å·²çŸ¥é—®é¢˜

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOkta çš„è®¿é—®ä»¤ç‰Œä¼šåœ¨ä¸€å°æ—¶åè¿‡æœŸã€‚è¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ï¼Œåœ¨ä½¿ç”¨ OAuth 2.0 æ—¶ï¼Œå»ºè®®ä½¿ç”¨çŸ­æœŸè®¿é—®ä»¤ç‰Œã€‚åˆ·æ–°ä»¤ç‰Œçš„å¯¿å‘½é€šå¸¸è¦é•¿å¾—å¤šï¼Œæ¯”å¦‚å‡ å¤©æˆ–å‡ ä¸ªæœˆï¼Œå¹¶ä¸”å¯ç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œã€‚å½“ä½¿ç”¨ Okta çš„ Spring Boot å¯åŠ¨å™¨æ—¶ï¼Œè¿™åº”è¯¥ä¼šè‡ªåŠ¨å‘ç”Ÿï¼Œä½†å®ƒæ²¡æœ‰ã€‚

æˆ‘é…ç½®äº†æˆ‘çš„ Okta orgï¼Œä½¿å…¶è®¿é—®ä»¤ç‰Œåœ¨äº”åˆ†é’Ÿåè¿‡æœŸã€‚æ‚¨å¯ä»¥è½¬åˆ° **API** > **æˆæƒæœåŠ¡å™¨** > **è®¿é—®ç­–ç•¥**ï¼Œç‚¹å‡»**é»˜è®¤ç­–ç•¥**ï¼Œå¹¶ç¼–è¾‘å…¶è§„åˆ™ã€‚ç„¶åå°†è®¿é—®ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸä» 1 å°æ—¶æ›´æ”¹ä¸º 5 åˆ†é’Ÿã€‚

åœ¨ä½ çš„æµè§ˆå™¨ä¸­ç‚¹å‡»`http://localhost:8080/cool-cars`ï¼Œä½ å°†è¢«é‡å®šå‘åˆ° Okta è¿›è¡Œç™»å½•ã€‚ç™»å½•ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ª JSON å­—ç¬¦ä¸²çš„æ±½è½¦ã€‚

å»åšåˆ«çš„äº‹æƒ…è¶…è¿‡ 5 åˆ†é’Ÿã€‚

å›æ¥ï¼Œåˆ·æ–°ä½ çš„æµè§ˆå™¨ï¼Œä½ ä¼šçœ‹åˆ°`[]`è€Œä¸æ˜¯æ‰€æœ‰çš„è½¦ã€‚

**æ›´æ–°** : Spring Security 5.1 è¿˜æ²¡æœ‰è‡ªåŠ¨åˆ·æ–° OAuth è®¿é—®ä»¤ç‰Œã€‚åº”è¯¥ä¼šåœ¨ Spring Security 5.2 ä¸­æä¾›ã€‚

## Spring Bootã€æ˜¥äº‘ã€å¾®æœåŠ¡å¸¦ç»™æ‚¨æ›´å¤šä¹è¶£

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡å…³äºå¦‚ä½•ç”¨ Spring Boot å’Œ Spring Cloud æ„å»º Java å¾®æœåŠ¡æ¶æ„çš„æ–‡ç« ã€‚æ‚¨å­¦ä¹ äº†å¦‚ä½•ç”¨æœ€å°‘çš„ä»£ç æ„å»ºä¸€åˆ‡ï¼Œç„¶åç”¨ Spring Securityã€OAuth 2.0 å’Œ Okta å¯¹å…¶è¿›è¡Œå®‰å…¨é…ç½®ã€‚

ä½ å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°æœ¬æ•™ç¨‹[ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰ä»£ç ã€‚](https://github.com/oktadeveloper/java-microservices-examples)

åœ¨è¿™ä¸ªåšå®¢ä¸Šï¼Œæˆ‘ä»¬æ˜¯ Spring Bootã€æ˜¥å¤©äº‘å’Œå¾®æœåŠ¡çš„å¿ å®ç²‰ä¸ã€‚è¿™é‡Œæœ‰å‡ ä¸ªä½ å¯èƒ½ä¼šæ„Ÿå…´è¶£çš„å¸–å­:

*   [Angular 8 + Spring Boot 2.2:ä»Šå¤©å°±å»ºç«‹ä¸€ä¸ª CRUD åº”ç”¨ç¨‹åºï¼](https://developer.okta.com/blog/2019/05/13/angular-8-spring-boot-2)

*   [Spring Boot ç™»å½•é€‰é¡¹å¿«é€ŸæŒ‡å—](https://developer.okta.com/blog/2019/05/15/spring-boot-login-options)

*   [ä¸ Spring Boot å’Œ Kubernetes ä¸€èµ·æ„å»ºå¾®æœåŠ¡æ¶æ„](https://developer.okta.com/blog/2019/04/01/spring-boot-microservices-with-kubernetes)

*   [ä½¿ç”¨ HTTPS å’Œ OAuth 2.0 ä¿æŠ¤æœåŠ¡å¯¹æœåŠ¡çš„ Spring å¾®æœåŠ¡](https://developer.okta.com/blog/2019/03/07/spring-microservices-https-oauth2)

*   [æ„å»º Spring å¾®æœåŠ¡å¹¶å°†å…¶ç”¨äºç”Ÿäº§](https://developer.okta.com/blog/2019/02/28/spring-microservices-docker)

è¯·åœ¨ Twitter @oktadev ä¸Šå…³æ³¨æˆ‘ä»¬[å¹¶è®¢é˜…](https://twitter.com/oktadev)[æˆ‘ä»¬çš„ YouTube é¢‘é“](https://www.youtube.com/c/oktadev)äº†è§£æ›´å¤š Spring Boot å’Œå¾®æœåŠ¡çŸ¥è¯†ã€‚