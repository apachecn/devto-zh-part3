# å¦‚ä½•åœ¨ä½¿ç”¨ TypeScript+mongose çš„åŒæ—¶å‡å°‘æ ·æ¿ä»£ç çš„æ•°é‡ğŸ™ˆ

> åŸæ–‡:[https://dev . to/nuc light/how-can-I-reduce-amount-of-boilerplate-code-while-working-with-typescriptmongoose-26do](https://dev.to/nuclight/how-can-i-reduce-amount-of-boilerplate-code-while-working-with-typescriptmongoose--26do)

å‡è®¾æˆ‘æœ‰ä¸¤ä¸ªå®ä½“:*è½¦è¾†*å’Œ*å…³ç¨*ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»(è½¦è¾†å¯ä»¥æœ‰å¤šä¸ªå…³ç¨)ã€‚

è¿™æ˜¯æˆ‘å¯¹å¯¹è±¡çš„åŸºæœ¬ç±»å‹å®šä¹‰ï¼Œæˆ‘æƒ³ä½¿ç”¨:

```
interface Tariff {
    id: string;         // <-- ID of entity
    createdAt: Date;    // <-- some meta data fields for sorting and etc.

    days: number;       // <-- userful info
    price: number;      // <-
}

interface Vehicle {
    id: string;          // <-- ID of entity
    createdAt: Date;     // <-- some meta data fields for sorting and etc.

    model: string;       // <-- userful info
    year?: string;       // <-
    seatsCount?: number; // <-
    tariffs: Tariff[];   // <-- array of tariffs
} 
```

çœ‹èµ·æ¥å¾ˆæ£’ã€‚ä¸ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæ•°æ®åº“æ¨¡å‹ã€‚é¦–å…ˆè®©æˆ‘ä»¬å®šä¹‰ mongoose æ¨¡å¼:

```
import mongoose from "mongoose";

const vehicleSchema = new mongoose.Schema({
    createdAt: {type: Date, required: true, default: () => new Date()},

    model: {type: String, required: true},
    year: String,
    seatsCount: Number,
}); 
```

å¤ªæ£’äº†ã€‚æˆ‘å†³å®šä¸æŠŠå…³ç¨æ”¾åœ¨è½¦è¾†æ–‡ä»¶ä¸­ï¼Œå®ƒä»¬å°†è¢«åˆ†å¼€å­˜æ”¾ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºçŒ«é¼¬æ¨¡å‹ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦æä¾›æ‰©å±•`mongoose.Document`åˆ°`mongoose.model`çš„æ³›å‹ç±»å‹ã€‚è¿™å°±æ˜¯ä»£ç å¤åˆ¶å¼€å§‹çš„åœ°æ–¹:

```
// First we need to define TypeScript schema equalent of mongoose schema:
interface VehicleSchema {
    createdAt: Date;

    model: string;
    year?: string;
    seatsCount?: number;
}

// Then we need to defined a new type of out vehicle models:
type VehicleModel = VehicleSchema && mongoose.Document;

// And finaly we can create model:
const VehicleModel = mongoose.model<VehicleModel>("Car", carSchema);

// Look, here is a type named "VehicleModel" and a constant named "VehicleModel" 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸º CRUD æ“ä½œç¼–å†™å‡½æ•°:

```
namespace vehicle {
    export const create = async (form: VehicleCreateForm): Promise<Vehicle> => {
        const fields = toDb(form);

        // assume form is prevalidated
        let dbVehicle = new VehicleModel(form);
        dbVehicle = await model.save();

        // tariff - is the separate module, like this one, 
        // createAllFor methods retuns Tariff[]
        const tariffs = await tariff.createAllFor(dbVehicle.id, form.tariffs);

        return fromDb(dbVehicle, tariffs);
    }

    //...

    // export const update = ...
    // export const list = ...
    // export const get = ... 
    // etc..
} 
```

è¿™é‡Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªé¢å¤–çš„ç±»å‹:`VehicleCreateForm`ï¼Œå®ƒæè¿°äº†åˆ›å»ºè½¦è¾†æ‰€éœ€çš„æ‰€æœ‰å­—æ®µ:

```
interface VehicleCreateForm {
    model: string;
    year?: string;
    seatsCount?: number;
    tariffs: TariffCreateFields[]; // <-- here is another one special type
}

interface TariffCreateFields {
    days: number;
    price: number;
} 
```

æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸¤ä¸ªå‡½æ•°:`toDb`æ¥é˜²æ­¢ä¸€äº›å­—æ®µï¼Œä¾‹å¦‚`tariffs`è¢«ä¼ é€’ç»™æ¨¡å‹ã€‚å¹¶ä¸”`fromDb`å°†æ¨¡å‹â€œç¿»è¯‘â€æˆ`Vehicle`å®ä½“ï¼Œåˆ é™¤æˆ–è½¬æ¢ä¸€äº›å­—æ®µ:

```
const u = <T>(value: T | undefined | null): (T | undefined) => value === null ? undefined : value;

const toDb = (f: VehicleCreateForm): VehicleCreateFields => ({
    model: f.model,
    year: f.year,
    seatsCount: f.seatsCount,
});

const fromDb = (m: VehicleModel, tariffs: Tariff[]): Vehicle => ({
    id: m.id,
    createdAt: m.createdAt,

    model: m.model,
    year: u(m.year),
    tariffs,
}); 
```

è€Œä¸”ï¼Œyaaaï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤šä¸€ç§ç±»å‹:`VehicleCreateFields`ã€‚æˆ‘ä»¬è¦ä¼ é€’ç»™æ¨¡å‹æ„é€ å‡½æ•°çš„å­—æ®µã€‚

```
interface VehicleCreateFields {
    model: string;
    year?: string;
    seatsCount?: number;
} 
```

ä¼¼ä¹è¿™é‡Œå·²ç»ç»“æŸäº†ã€‚

æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ç±»ä¼¼äº`vehicle`çš„`tariff`åç§°ç©ºé—´ã€‚æ‰€æœ‰ç±»å‹éƒ½å°†è¢«å¤åˆ¶:`TariffSchema`ã€`TariffModel`ã€`TariffCreateForm`ã€`TariffCreateDocument`ã€‚

æ¯ä¸€ä¸ªæ–°çš„å®ä½“éƒ½ä¼šè¿™æ ·ã€‚åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œæˆ‘å¯ä»¥é¿å…åˆ›å»º`VehicleUpdateFields`ç±»å‹ï¼Œè€Œä½¿ç”¨`VehicleCreateFields`æ¥åˆ›å»ºå’Œæ›´æ–°ã€‚ä¹Ÿå¯èƒ½æœ‰`VehicleUpdateDocument`ç­‰ç­‰ã€‚

æˆ‘å¦‚ä½•å‡å°‘ä»£ç é‡å¤çš„æ•°é‡ï¼Ÿä½ å¦‚ä½•å¤„ç†æ‰“å­—ç¨¿/çŒ«é¼¬ï¼Ÿ

å½“ç„¶ï¼Œæˆ‘å¯ä»¥æå–å…¬å…±å­—æ®µåˆ°â€œå…¬å…± chunckâ€æ¥å£ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•å‘½åå®ƒä»¬ã€‚æˆ‘è¯•å›¾ä½¿ç”¨æ¥å£ç»§æ‰¿ï¼Œç»“æœå´æ˜¯ä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„å°å­—ä½“ã€‚å–œæ¬¢:

```
interface Entity {
    id: string;
    createdAt: Date;
}

interface VehicleOwnFields {
    model: string;
    year?: string;
    seatsCount?: number;
}

interface VehicleOwnFields {
    model: string;
    year?: string;
    seatsCount?: number;
}

interface VehicleExternalFields {
    tariffs: Tariff[];
}

type Vehicle = Entity && VehicleOwnFields && VehicleExternalFields;
// and so on... 
```

æˆ‘è®¤ä¸ºè¿™ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

ä¹Ÿå¯èƒ½å­˜åœ¨å®ä½“å’Œæ¨¡å¼ä¸­çš„å­—æ®µå…·æœ‰ä¸åŒç±»å‹çš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘å¯ä»¥å†³å®šå°†`Tariff[]`åºåˆ—åŒ–ä¸º JSONï¼Œå¹¶ä½œä¸ºå­—ç¬¦ä¸²å­—æ®µå­˜å‚¨åœ¨`VehicleModel`ä¸­ã€‚

æˆ‘è®¤ä¸ºè¿™æ˜¯æ‰“å­—ç¨¿å’Œ ORM çš„æ™®éé—®é¢˜ã€‚å¦‚æœä½ çŸ¥é“æè¿°è¿™ä¸ªé—®é¢˜çš„å¥½æ–‡ç« ï¼Œè¯·ç»™æˆ‘é“¾æ¥ã€‚