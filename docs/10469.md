# æ•°å­—æµ·æ´‹ Kubernetes ä¸Šå¾®æœåŠ¡çš„ CI/CD

> åŸæ–‡:[https://dev . to/markoa/cicd-for-micro services-on-digital ocean-kubernetes-1d G1](https://dev.to/markoa/cicd-for-microservices-on-digitalocean-kubernetes-1dg1)

Semaphore è®©ä½ èƒ½å¤Ÿè½»æ¾åœ°åˆ›å»º CI/CD ç®¡é“æ¥æ„å»ºã€è¿è¡Œå’Œéƒ¨ç½² Docker å®¹å™¨ã€‚DigitalOcean æœ€è¿‘æ¨å‡ºäº†ä¸€é¡¹åä¸º[çš„æ‰˜ç®¡ Kubernetes æœåŠ¡](https://blog.digitalocean.com/digitalocean-releases-k8s-as-a-service/)ï¼Œè¯¥æœåŠ¡ç®€åŒ–äº†äº‘åŸç”Ÿåº”ç”¨çš„è¿è¡Œã€‚æ€»ä¹‹ï¼Œå®ƒä»¬æ˜¯é«˜æ•ˆè½¯ä»¶å¼€å‘çš„ç»ä½³ç»„åˆã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨å¿«é€Ÿè¿ç»­äº¤ä»˜ç®¡é“ä¸­å°†è¿™ä¸¤ä¸ªæœåŠ¡è¿æ¥åœ¨ä¸€èµ·ã€‚

## [](#what-were-building)æˆ‘ä»¬åœ¨å»ºé€ ä»€ä¹ˆ

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª Ruby Sinatra å¾®æœåŠ¡ï¼Œå®ƒå…¬å¼€äº†ä¸€äº› HTTP ç«¯ç‚¹å¹¶åŒ…å«ä¸€ä¸ªæµ‹è¯•å¥—ä»¶ã€‚æˆ‘ä»¬å°†å®ƒä¸ Docker æ‰“åŒ…å¹¶éƒ¨ç½²åˆ° DigitalOcean Kubernetesã€‚CI/CD ç®¡é“å°†å®Œå…¨è‡ªåŠ¨åŒ–ä»¥ä¸‹ä»»åŠ¡:

*   å®‰è£…é¡¹ç›®ä¾èµ–é¡¹ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ä»ç¼“å­˜ä¸­é‡ç”¨å®ƒä»¬ï¼›
*   è¿è¡Œå•å…ƒæµ‹è¯•ï¼›
*   æ„å»ºå¹¶æ ‡è®° Docker å›¾åƒï¼›
*   å°† Docker æ˜ åƒæ¨é€åˆ° Docker Hub å®¹å™¨æ³¨å†Œè¡¨ï¼›
*   å‘ DigitalOcean Kubernetes æä¾›ä¸€é”®éƒ¨ç½²ã€‚

[![Final CI/CD pipeline](../Images/e260af3cb0e14b8980ab04539951782c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--30NphxW8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/3ji2iv1bmvs83oschgsz.png)

æˆ‘ä»¬å°†ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œä½†å¦‚æœä½ æƒ³ç›´æ¥è¿›å…¥æºä»£ç çš„æœ€ç»ˆç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹ GitHub ä¸Šçš„ semaphore-demo-ruby-kubernetes èµ„æºåº“:

## ![GitHub logo](../Images/292a238c61c5611a7f4d07a21d9e8e0a.png)[semaphore ci-demos](https://github.com/semaphoreci-demos)/[semaphore-demo-ruby-kubernetes](https://github.com/semaphoreci-demos/semaphore-demo-ruby-kubernetes)

### Kubernetes çš„ä¿¡å·é‡æ¼”ç¤º CI/CD ç®¡é“ã€‚

<article class="markdown-body entry-content container-lg" itemprop="text">

# Kubernetes çš„ä¿¡å·é‡ CI/CD æ¼”ç¤º

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºå’Œ CI/CD ç®¡é“ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Semaphore 2.0 åœ¨ Kubernetes ä¸Šæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²å¾®æœåŠ¡ã€‚

æˆåˆ†:

*   Ruby Sinatra ä½œä¸º web æ¡†æ¶
*   ç”¨äºæµ‹è¯•çš„ RSpec
*   åŒ…è£…åœ¨ç å¤´é›†è£…ç®±ä¸­
*   å®¹å™¨è¢«æ¨é€åˆ° Docker Hub æ³¨å†Œè¡¨
*   éƒ¨ç½²åˆ° Kubernetes

## ä¿¡å·é‡ä¸Šçš„ CI/CD

å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰ Semaphoreï¼Œå¯ä»¥éšæ„æ´¾ç”Ÿè¿™ä¸ªå­˜å‚¨åº“å¹¶ä½¿ç”¨å®ƒæ¥[åˆ›å»ºä¸€ä¸ªé¡¹ç›®](https://docs.semaphoreci.com/article/63-your-first-project)ã€‚

CI/CD ç®¡é“åœ¨`.semaphore`ç›®å½•ä¸­å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤º:

[![CI/CD pipeline on Semaphore](../Images/449e1bd122c60bea28c60018db726d7b.png)T2ã€‘](https://raw.githubusercontent.com/semaphoreci-demos/semaphore-demo-ruby-kubernetes/master/pipeline.png)

## æœ¬åœ°åº”ç”¨ç¨‹åºè®¾ç½®

è¦è¿è¡Œå¾®æœåŠ¡:

```
bundle install --path vendor/bundle
bundle exec rackup 
```

è¦è¿è¡Œæµ‹è¯•:

```
bundle exec rspec 
```

è¦æ„å»ºå’Œè¿è¡Œ Docker å®¹å™¨:

```
docker build -t semaphore-demo-ruby-kubernetes .
docker run -p 80:4567 semaphore-demo-ruby-kubernetes
curl localhost
> hello world :)) 
```

## è®¸å¯è¯

ç‰ˆæƒæ‰€æœ‰(c) 2019 æ¸²æŸ“æ–‡æœ¬

åœ¨éº»çœç†å·¥å­¦é™¢è®¸å¯ä¸‹åˆ†å‘ã€‚è¯·å‚è§æ–‡ä»¶è®¸å¯ã€‚

</article>

[View on GitHub](https://github.com/semaphoreci-demos/semaphore-demo-ruby-kubernetes)

æˆ‘ä»¬å¼€å§‹å§ï¼

## 5 åˆ†é’Ÿååœ¨æ•°å­—æµ·æ´‹ä¸Šå¯åŠ¨ Kubernetes é›†ç¾¤

åœ¨ DigitalOcean ä¸Šå‘å¸ƒ Kubernetes é›†ç¾¤éå¸¸ç®€å•ã€‚åœ¨æ‚¨çš„æ§åˆ¶é¢æ¿ä¸Šï¼Œä½¿ç”¨é¡¶éƒ¨çš„â€œåˆ›å»ºâ€æŒ‰é’®æ¥åˆ›å»ºå®ƒã€‚ç¾¤é›†å°†åœ¨ 4-5 åˆ†é’Ÿåå¯ç”¨ã€‚

[![Creating a Kubernetes cluster on DigitalOcean](../Images/fd219a756a02e23d355dbd71f20a63ad.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lCBF3qb1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/037dw1taykle4wjic8gt.png)

â€œç¾¤é›†â€é¡µé¢åŒ…æ‹¬è®¸å¤šæ‚¨å¯ä»¥ä½¿ç”¨çš„æç¤ºå’Œèµ„æºã€‚å¦‚æœæ‚¨è¿˜æ²¡æœ‰è¿™æ ·åšï¼Œç°åœ¨æ˜¯æ—¶å€™å®‰è£… Kubernetes å‘½ä»¤è¡Œå·¥å…· kubectlã€‚

## [](#connect-to-your-kubernetes-cluster)è¿æ¥åˆ°æ‚¨çš„ Kubernetes é›†ç¾¤

æ»šåŠ¨åˆ°ç¾¤é›†é¡µé¢çš„åº•éƒ¨ï¼Œä¸‹è½½å°†ç”¨äºéªŒè¯å’Œè¿æ¥åˆ°ç¾¤é›†çš„é…ç½®æ–‡ä»¶ã€‚

[![Download your DigitalOcean Kubernetes configuration file](../Images/1ebc22429848a20ac4c9f67beb3accb4.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--MOdZ5NE_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ou2za8iy1kglq1mgxpzc.png)

åœ¨æ‚¨çš„æœ¬åœ°æœºå™¨ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•æ¥åŒ…å« Kubernetes é…ç½®æ–‡ä»¶:

```
$ mkdir ~/.kube 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†ä¸‹è½½çš„æ–‡ä»¶ç§»åŠ¨åˆ°`~/.kube`å¹¶æŒ‡ç¤º kubectl ä½¿ç”¨å®ƒã€‚æ‚¨å¯ä»¥åœ¨æ‚¨çš„ç»ˆç«¯ä¼šè¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæˆ–è€…å°†å®ƒæ·»åŠ åˆ°æ‚¨çš„ shell é…ç½®æ–‡ä»¶ä¸­ï¼Œå¦‚`.bashrc`æˆ–`.zshrc` :

```
$ export KUBECONFIG=$HOME/.kube/dok8s.yaml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¡®ä¿æ›´æ”¹`dok8s.yaml`ä»¥åŒ¹é…æ‚¨çš„æ–‡ä»¶åã€‚

é€šè¿‡è¿è¡Œ`kubectl get nodes`ï¼ŒéªŒè¯æ‚¨å¯ä»¥ä¸æ‚¨çš„ DigitalOcean Kubernetes é›†ç¾¤é€šä¿¡ã€‚å½“è¯¥å‘½ä»¤æˆåŠŸæ—¶ï¼Œå®ƒè¿”å›ç±»ä¼¼å¦‚ä¸‹çš„ä¿¡æ¯:

```
$ kubectl get nodes
NAME                        STATUS    ROLES     AGE       VERSION
nostalgic-heisenberg-8vi3   Ready     <none>    4d        v1.13.2
nostalgic-heisenberg-8vi8   Ready     <none>    4d        v1.13.2 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

èŠ‚ç‚¹æ•°é‡å°†ä¸æ‚¨åœ¨é›†ç¾¤åˆ›å»ºè¿‡ç¨‹ä¸­é€‰æ‹©çš„æ•°é‡ç›¸åŒ¹é…ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨åœ¨é›†ç¾¤ä»å¤„äºä¾›åº”çŠ¶æ€æ—¶è¿è¡Œ`get nodes`ï¼ŒèŠ‚ç‚¹æ•°é‡å°†ä¸ºé›¶ã€‚

æ•°å­—æµ·æ´‹è¿˜æ²¡æœ‰å›åº”æˆ‘å…³äºä»–ä»¬å’Œæ²ƒå°”ç‰¹Â·æ€€ç‰¹å…³ç³»çš„è¯¢é—®ã€‚

## [](#connect-semaphore-to-your-kubernetes-cluster)å°†ä¿¡å·é‡è¿æ¥åˆ°æ‚¨çš„ Kubernetes é›†ç¾¤

æ­¤æ—¶ï¼Œæ‚¨å·²ç»æœ‰äº†ä¸€ä¸ªå¯ä»¥ä»æœ¬åœ°æœºå™¨æ§åˆ¶çš„ Kubernetes é›†ç¾¤ã€‚è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ªåŸºæœ¬çš„ CI/CD é¡¹ç›®ï¼Œå…¶ä¸­ Semaphore ä¹Ÿå¯ä»¥æˆåŠŸæ‰§è¡Œ`kubectl get nodes`ã€‚

å¦‚æœä½ æ˜¯æ——è¯­æ–°æ‰‹ï¼Œä»[åˆ›å»ºä¸€ä¸ªå…è´¹è´¦æˆ·](https://semaphoreci.com)å¼€å§‹ã€‚å…è´¹å¸æˆ·æ¯æœˆä¸ºæ‚¨æä¾› 20 ç¾å…ƒçš„ä¿¡ç”¨é¢åº¦ï¼Œè¶³ä»¥æä¾›é•¿è¾¾ 1300 åˆ†é’Ÿçš„æœåŠ¡ã€‚å¦‚æœä½ è¿æ¥ä¸€å¼ ä¿¡ç”¨å¡ï¼Œä½ å°†å¾—åˆ°é¢å¤–çš„ 200 ç¾å…ƒçš„å…è´¹ä¿¡ç”¨ã€‚

### [](#create-a-project-on-semaphore)åœ¨ä¿¡å·é‡ä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®

è¿›å…¥ Semaphore åï¼Œç‚¹å‡»å·¦ä¾§è¾¹æ ä¸­çš„â€œé¡¹ç›®>æ–°å»ºâ€é“¾æ¥ã€‚æ‚¨å¯ä»¥æŒ‰ç…§å±å¹•ä¸Šçš„è¯´æ˜é€‰æ‹©ä¸€ä¸ªå­˜å‚¨åº“å¹¶æäº¤é»˜è®¤çš„ YML æ–‡ä»¶ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå‘½ä»¤è¡Œæ–¹æ³•ã€‚

é¦–å…ˆï¼Œ[å®‰è£… semï¼Œä¿¡å·é‡å‘½ä»¤è¡Œå·¥å…·](https://docs.semaphoreci.com/article/53-sem-reference)ã€‚æ‚¨å¯ä»¥é€šè¿‡æ‰“å¼€ä»»ä½•ä¿¡å·é‡å±å¹•å³ä¸Šè§’çš„ CLI å°éƒ¨ä»¶æ¥æ‰¾åˆ°ç¡®åˆ‡çš„è¯´æ˜ã€‚

[![Finding the instructions to install Semaphore CLI](../Images/7fbd0881db13954de77866138e31b37b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qD8x82G8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6eqbawc4yxk0422kjeij.png)

ç¬¬ä¸€ä¸ªå‘½ä»¤ä¸‹è½½å¹¶å®‰è£… CLI:

```
$ curl https://storage.googleapis.com/sem-cli-releases/get.sh | bash 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬äºŒä¸ªå‘½ä»¤å°† sem è¿æ¥åˆ°æ‚¨çš„ç»„ç»‡å¸æˆ·:

```
$ sem connect ORGANIZATION.semaphoreci.com ACCESS_TOKEN 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œåˆå§‹åŒ–æ‚¨æƒ³è¦è¿æ¥åˆ° Semaphore çš„ Git å­˜å‚¨åº“ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªç©ºçš„ Git å­˜å‚¨åº“ä¸­è¿™æ ·åš:

```
$ sem init
Project is created. You can find it at https://ORGNAME.semaphoreci.com/projects/PROJECTNAME.

To run your first pipeline execute:

  git add .semaphore/semaphore.yml && git commit -m "First pipeline" && git push 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥å‘½ä»¤åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ª deploy key å’Œ webhookï¼Œè¿™æ · Semaphore å°±å¯ä»¥åœ¨ä»£ç å‘ç”Ÿå˜åŒ–æ—¶è®¿é—®æ‚¨çš„ä»£ç ï¼Œå¹¶åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šåˆ›å»ºä¸€ä¸ªç®¡é“å®šä¹‰æ–‡ä»¶`.semaphore/semaphore.yml`ã€‚

### [](#authenticating-with-kubernetes-using-a-semaphore-secret)ä½¿ç”¨ä¿¡å·é‡ç§˜å¯†å‘ Kubernetes è®¤è¯

è®©æˆ‘ä»¬ç¼–è¾‘`semaphore.yml`å¹¶æŒ‡å¯¼ Semaphore å¦‚ä½•ä¸ Kubernetes å¯¹è¯ã€‚

ä¿¡å·é‡å·²ç»[æä¾›äº† kubectl é¢„è£…](https://docs.semaphoreci.com/article/32-ubuntu-1804-image)ã€‚æ‰€ä»¥å‰©ä¸‹çš„å°±æ˜¯åœ¨ä¿¡å·é‡ç¯å¢ƒä¸­å®‰å…¨åœ°ä¸Šä¼  Kubernetes é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬é€šå¸¸é€šè¿‡åˆ›å»ºä¸€ä¸ª[ç§˜å¯†](https://docs.semaphoreci.com/article/62-concepts#secrets)æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç§˜å¯†å¯ä»¥æ˜¯ç¯å¢ƒå˜é‡å’Œæ–‡ä»¶é›†åˆã€‚åˆ›å»ºåï¼Œå®ƒå¯ç”¨äºç»„ç»‡å†…çš„æ‰€æœ‰é¡¹ç›®ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸºäºå•ä¸ªæ–‡ä»¶çš„ç§˜å¯†ã€‚ä½¿ç”¨ sem åˆ›å»º:

```
$ sem create secret do-k8s --file ~/.kube/do-kubernetes.yaml:/home/semaphore/.kube/dok8s.yaml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„å‘½ä»¤[åŸºäºæœ¬åœ°æ–‡ä»¶](https://docs.semaphoreci.com/article/66-environment-variables-and-secrets#a-shortcut-for-creating-file-based-secrets)åˆ›å»ºä¸€ä¸ªç§˜å¯†ï¼Œå¹¶æŒ‡ç¤º Semaphore åœ¨`/home/semaphore/.kube/dok8s.yaml`ä¸­ä½¿å…¶å¯ç”¨ã€‚`/home/semaphore/`æ˜¯è¿è¡Œæ‰€æœ‰ CI/CD ä½œä¸šçš„é»˜è®¤ç›®å½•ã€‚

æŒ‚è½½è¿™ä¸ªç§˜å¯†å¹¶ä½¿å…¶åœ¨ CI/CD ä½œä¸šä¸­å¯ç”¨çš„å®Œæ•´ä¿¡å·é‡é…ç½®å¦‚ä¸‹:

```
# .semaphore/semaphore.yml
version: v1.0
name: Hello Kubernetes
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Talk to K8s
    task:
      secrets:
        - name: do-k8s
      env_vars:
        - name: KUBECONFIG
          value: /home/semaphore/.kube/dok8s.yaml
      jobs:
      - name: Get nodes
        commands:
          - checkout
          - kubectl get nodes 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœè¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡çœ‹åˆ°ä¿¡å·é‡é…ç½®æ–‡ä»¶ï¼Œ[å¿«é€Ÿæµè§ˆä¸€ä¸‹æ¦‚å¿µ](https://docs.semaphoreci.com/article/62-concepts)ä¼šå¸®åŠ©ä½ ç†è§£å®ƒã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬åœ¨æœ¬ä¾‹ä¸­åº”ç”¨çš„è¦ç‚¹:

*   åœ¨`agent`éƒ¨åˆ†ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è¿è¡Œä»£ç å’Œå‘½ä»¤çš„ç¯å¢ƒã€‚æˆ‘ä»¬ç»“åˆäº†ä¸€ç§å¯ç”¨çš„[æœºå™¨ç±»å‹](https://docs.semaphoreci.com/article/20-machine-types)å’Œ[æ“ä½œç³»ç»Ÿæ˜ åƒ](https://docs.semaphoreci.com/article/32-ubuntu-1804-image)ã€‚
*   åœ¨`secrets`éƒ¨åˆ†ï¼Œæˆ‘ä»¬æŒ‚è½½åˆšåˆšåˆ›å»ºçš„ç§˜å¯†ï¼Œå¹¶ä½¿ç”¨å®ƒæä¾›çš„æ–‡ä»¶æ¥å®šä¹‰`env_vars`éƒ¨åˆ†ä¸­çš„`KUBECONFIG`ç¯å¢ƒå˜é‡ã€‚
*   æˆ‘ä»¬çš„ç®¡é“æœ‰ä¸€ä¸ªå—å’Œä¸€ä¸ªä½œä¸šï¼Œæˆ‘ä»¬ä» GitHub ä¸‹è½½ä»£ç å¹¶è¿è¡Œ`kubectl get nodes`ã€‚

è¿è¡Œ`git push`,æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªåŸºæœ¬çš„ç®¡é“åœ¨ Semaphore ä¸Šè¿è¡Œ:

[![Hello Kubernetes pipeline](../Images/f8e3ba21fc9a35862d4fbfced6d493b6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--riYDkzEt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ijhj1ti87gxn6vwhvmo3.png)

å•å‡»â€œè·å–èŠ‚ç‚¹â€æŸ¥çœ‹ä½œä¸šæ—¥å¿—:

[![Hello Kubernetes job](../Images/968a46ba940a6731c5e469b3b698a88d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--jMk70IGc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8dmiqmd3wzasa86zll2b.png)

å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹äº†ï¼è®©æˆ‘ä»¬é€šè¿‡å»ºç«‹ä¸€ä¸ªå®é™…çš„é¡¹ç›®æ¥ç»§ç»­ã€‚

## [](#set-up-continuous-integration-for-a-sinatra-microservice)ä¸º Sinatra å¾®æœåŠ¡è®¾ç½®æŒç»­é›†æˆ

æˆ‘ä»¬çš„ Sinatra åº”ç”¨æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå…·æœ‰æœ€å°çš„é…ç½®å’Œä¸€ä¸ª RSpec æµ‹è¯•å¥—ä»¶:

```
.
â”œâ”€â”€ Gemfile
â”œâ”€â”€ Gemfile.lock
â”œâ”€â”€ README.md
â”œâ”€â”€ app.rb
â”œâ”€â”€ config.ru
â””â”€â”€ spec
    â”œâ”€â”€ app_spec.rb
    â””â”€â”€ spec_helper.rb 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬æ¸…é™¤å‰é¢çš„`semaphore.yml`å¹¶è¾“å…¥ä»¥ä¸‹é…ç½®æ¥è¿è¡Œ CI:

```
# .semaphore/semaphore.yml
version: v1.0
name: CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Install dependencies
    task:
      jobs:
        - name: bundle install
          commands:
            - checkout
            - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-master
            - bundle install --deployment --path .bundle
            - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) .bundle

  - name: Tests
    task:
      jobs:
        - name: rspec
          commands:
            - checkout
            - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-master
            - bundle install --deployment --path .bundle
            - bundle exec rspec 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†æˆ‘ä»¬çš„å®çŸ³[å­˜å‚¨åœ¨ä¿¡å·é‡ç¼“å­˜](https://docs.semaphoreci.com/article/68-caching-dependencies)ä¸­ï¼Œä»¥é¿å…æ¯æ¬¡æäº¤æ—¶ä»å¤´å¼€å§‹è¿è¡Œ`bundle install`ã€‚

å‡ºäºæ¼”ç¤ºçš„ç›®çš„ï¼Œæˆ‘ä»¬å°†ä¾èµ–é¡¹çš„å®‰è£…å’Œè¿è¡Œæµ‹è¯•åˆ†å¼€åœ¨ä¸åŒçš„é¡ºåºå—ä¸­ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬åˆäºŒä¸ºä¸€ã€‚

æœ‰å¿…è¦åœ¨ç¬¬äºŒä¸ªå—ä¸­è¿è¡Œ`bundle install`ï¼Œå³ä½¿`cache restore`åœ¨é‚£ä¸ªç‚¹æ€»æ˜¯ä¼šæ¢å¤å®çŸ³åŒ…ã€‚è¿™å¯¹äº Bundler æ¥è¯´æ˜¯ä¸€ä¸ªé™åˆ¶ï¼Œä½†å¥½çš„ä¸€é¢æ˜¯å‘½ä»¤ä¼šå¾ˆå¿«é€€å‡ºã€‚

å½“æ‚¨å°†æ–°çš„`semaphore.yml`æ¨é€åˆ° GitHub æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªçœŸæ­£çš„ CI ç®¡é“åœ¨ Semaphore ä¸Šæˆå½¢:

[![Continuous integration pipeline](../Images/9e005bc3d645817dfa5fbd1ed0fb67b7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Os89FfIR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/zgyf9u26vruqg3lfn10t.png)

## [](#push-docker-image-to-docker-hub-container-registry)å°† Docker æ˜ åƒæ¨é€åˆ° Docker Hub å®¹å™¨æ³¨å†Œè¡¨

éƒ¨ç½²åˆ° Kubernetes éœ€è¦æˆ‘ä»¬å°† Docker æ˜ åƒæ¨é€åˆ°å®¹å™¨æ³¨å†Œä¸­å¿ƒã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Docker Hubã€‚å¯¹äºå…¶ä»–æ³¨å†Œä¸­å¿ƒæä¾›è€…ï¼Œè¯¥è¿‡ç¨‹éå¸¸ç›¸ä¼¼ã€‚

è¿™äº›æŒ‡ä»¤å°†é€‚ç”¨äºä»»ä½• Docker å›¾åƒã€‚å…³äºè¾›çº³ç‰¹æ‹‰çš„å»ºè®®ï¼Œè¯·æŸ¥çœ‹æˆ‘ä¹‹å‰çš„å¸–å­:

[![markoa image](../Images/fded043eaf4dbceeb727380e471e4424.png)](/markoa) [## Dockerize a Sinatra å¾®æœåŠ¡

### é©¬å°”ç§‘Â·é˜¿çº³æ–¯å¡”ç´¢å¤« 2 æœˆ 18 æ—¥ 192 åˆ†é’Ÿé˜…è¯»

#ruby #docker #devops](/markoa/dockerize-a-sinatra-microservice-29l8)

æ¨é€è‡³å…¬å…±æˆ–ç§æœ‰çš„å®¹å™¨æ³¨å†Œä¸­å¿ƒéœ€è¦èº«ä»½éªŒè¯ã€‚ä¾‹å¦‚ï¼Œå½“ä½ åœ¨ Mac ä¸Šä½¿ç”¨ Docker Desktop æ—¶ï¼Œä½ ä¼šè¢«è‡ªåŠ¨è®¤è¯ï¼Œå¹¶ä¸ Docker Hub è¿›è¡Œé€šä¿¡ã€‚åœ¨ CI/CD ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰§è¡Œ`docker push`ä¹‹å‰æä¾›å‡­è¯å¹¶è¿›è¡Œèº«ä»½éªŒè¯ã€‚

éµå¾ªä¿¡å·é‡æ–‡æ¡£ä¸­çš„ [Docker Hub æŒ‡ä»¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç§˜å¯†ã€‚](https://docs.semaphoreci.com/article/70-dockerhub)

æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶`secret.yml` :

```
# secret.yml
apiVersion: v1alpha
kind: Secret
metadata:
  name: my-dockerhub
data:
  env_vars:
    - name: DOCKER_USERNAME
      value: "YOUR  USERNAME"
    - name: DOCKER_PASSWORD
      value: "YOUR  PASSWORD" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨ sem CLI åˆ›å»ºå¯†ç ï¼Œå¹¶åœ¨å®Œæˆååˆ é™¤æºæ–‡ä»¶:

```
$ sem create -f secret.yml
$ rm secret.yml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥ä½¿ç”¨
æ¥éªŒè¯å®ƒçš„å·¥ä½œæƒ…å†µ

```
$ sem get secrets
NAME               AGE
my-dockerhub   11s

$ sem get secret markoa-dockerhub
apiVersion: v1beta
kind: Secret
metadata:
  name: my-dockerhub
  id: 89596f93-f2ca-4414-88be-e9602174034a
  create_time: "1550149760"
  update_time: "1550149760"
data:
  env_vars:
  - name: DOCKER_USERNAME
    value: xxx
  - name: DOCKER_PASSWORD
    value: xxx
  files: [] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ç°åœ¨æœ‰äº†ä»ä¿¡å·é‡ä½œä¸šæ¨é€åˆ° Docker Hub æ‰€éœ€çš„ä¸œè¥¿ã€‚

é€šè¿‡ Docker æ„å»ºå’Œæ¨é€æ“ä½œï¼Œæˆ‘ä»¬è¿›å…¥äº†é¡¹ç›®çš„äº¤ä»˜é˜¶æ®µã€‚[æˆ‘ä»¬å°†é€šè¿‡ä¿ƒé”€æ´»åŠ¨](https://docs.semaphoreci.com/article/67-deploying-with-promotions)æ‰©å±• CI æ¸ é“ï¼Œå¹¶åˆ©ç”¨å®ƒæ¥å¯åŠ¨ä¸‹ä¸€é˜¶æ®µã€‚

åœ¨`semaphore.yml`çš„åº•éƒ¨ï¼Œå®šä¹‰ä¸€ä¸ªä¿ƒé”€:

```
# .semaphore/semaphore.yml
# ...
promotions:
  - name: Dockerize
    pipeline_file: docker-build.yml
    auto_promote_on:
      - result: passed 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†ä¸Šé¢æŒ‡å®šçš„`auto_promote_on`,æˆ‘ä»¬çš„ Dockerize ç®¡é“å°†åœ¨æ¯ä¸ªåˆ†æ”¯çš„æ¯ä¸ªå˜æ›´ä¸Šè¿è¡Œã€‚æ‚¨å¯ä»¥ä½¿ç”¨[é™„åŠ æ¡ä»¶](https://docs.semaphoreci.com/article/50-pipeline-yaml#promotions)å®šåˆ¶è¯¥è¡Œä¸ºã€‚

è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸‹ Dockerize ç®¡é“:

```
# .semaphore/docker-build.yml
version: v1.0
name: Docker build
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
blocks:
  - name: Build
    task:
      secrets:
        - name: my-dockerhub
      jobs:
      - name: Docker build
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - checkout
          - docker pull semaphoredemos/semaphore-demo-ruby-kubernetes:latest || true
          - docker build --cache-from semaphoredemos/semaphore-demo-ruby-kubernetes:latest -t semaphoredemos/semaphore-demo-ruby-kubernetes:$SEMAPHORE_WORKFLOW_ID .
          - docker images
          - docker push semaphoredemos/semaphore-demo-ruby-kubernetes:$SEMAPHORE_WORKFLOW_ID 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ç¬¬ä¸€ä¸ªå‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åœ¨`my-dockerhub` secret ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡å‘ Docker Hub è®¤è¯ã€‚

æˆ‘ä»¬ä½¿ç”¨ [Docker å±‚ç¼“å­˜](https://docs.semaphoreci.com/article/81-docker-layer-caching)æ¥åŠ é€Ÿå®¹å™¨æ„å»ºè¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°è¯•ä»æ³¨å†Œè¡¨ä¸­æå–ä¸€ä¸ªå…ˆå‰æ„å»ºçš„æ˜ åƒã€‚å¦‚æœè¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¿è¡Œæ­¤æ“ä½œï¼Œæ­¤æ­¥éª¤å°†è¢«è·³è¿‡ï¼Œä¸ä¼šå¤±è´¥ã€‚

é€šè¿‡å°†`--cache-from`æ ‡å¿—ä¸`docker build`ä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç”¨å·²æå–å›¾åƒä¸­çš„å›¾å±‚ï¼Œä»è€Œæ›´å¿«åœ°æ„å»ºæ–°çš„å›¾å±‚ã€‚

åœ¨`docker push`å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`SEMAPHORE_WORKFLOW_ID`ç¯å¢ƒå˜é‡åœ¨æ¯æ¬¡æ„å»ºåäº§ç”Ÿä¸€ä¸ªç‹¬ç‰¹çš„å·¥ä»¶ã€‚å®ƒæ˜¯æ¯ä¸ªä¿¡å·é‡ä½œä¸šä¸­å¯ç”¨çš„ç¯å¢ƒå˜é‡ä¹‹ä¸€ï¼›[å®Œæ•´åˆ—è¡¨è§æ–‡æ¡£](https://docs.semaphoreci.com/article/12-environment-variables)ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åˆ›å»ºæœ€æ–°æ ‡ç­¾çš„æ–°ç‰ˆæœ¬ã€‚åªæœ‰åœ¨æˆåŠŸéƒ¨ç½²åï¼Œæˆ‘ä»¬æ‰ä¼šè¿™æ ·åšã€‚

ä¸€æ—¦ç”¨æ‚¨è‡ªå·±çš„åç§°æ›¿æ¢äº†æ˜ åƒåç§°ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼äºä»¥ä¸‹çŠ¶æ€çš„ç®¡é“:

[![Docker build pipeline](../Images/75dba9c3cbda7c99f35002acccbf64c2.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--XuoJPdTE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6sv1xhsjhiwnq4dl7mar.png)

ä½œä¸šæ—¥å¿—æ˜¾ç¤ºå·²ç»åˆ›å»ºå¹¶æ¨é€äº†å®¹å™¨æ˜ åƒ:

[![Docker build job](../Images/a35f16d0271e4ba14861da4804d429de.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--HnMrJvZQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/18ip58aijazb30jxybyf.png)

æ‚¨çš„ Docker æ³¨å†Œè¡¨åŒ…å«æœ€æ–°çš„å›¾åƒ:

[![Pushed container image on Docker Hub](../Images/592209d3fb4de375dd243c458fc9c1a7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PYVSj3Zz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/r1hkjnprzn8rythuxw82.png)

## [](#deploy-to-kubernetes)éƒ¨ç½²åˆ° Kubernetes

å›åˆ° DigitalOcean çš„ Kubernetes é›†ç¾¤é¡µé¢ï¼Œâ€œå…¥é—¨â€éƒ¨åˆ†åŒ…æ‹¬â€œéƒ¨ç½²å·¥ä½œè´Ÿè½½â€çš„ç¤ºä¾‹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸º nginx æä¾›çš„ç¤ºä¾‹ï¼Œå¹¶ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¿®æ”¹å®ƒã€‚

åœ¨ç¤ºä¾‹é…ç½®ä¸­ï¼Œæ‚¨ä¼šæ³¨æ„åˆ°å¯¹æºå®¹å™¨å›¾åƒçš„å¼•ç”¨:

```
# ...
    spec:
      containers:
        - name: nginx
          image: library/nginx 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ‚¨çš„ Docker æ˜ åƒæ˜¯ç§æœ‰çš„ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦å¯ç”¨ Kubernetes é›†ç¾¤æ¥é€šè¿‡ Docker æ³¨å†Œä¸­å¿ƒè¿›è¡Œèº«ä»½éªŒè¯ã€‚æ–¹æ³•æ˜¯ï¼Œå†æ¬¡åˆ›å»ºä¸€ä¸ªç§˜å¯†ï¼Œåªæ˜¯è¿™æ¬¡æ˜¯åœ¨ Kubernetes é›†ç¾¤çš„ä¸€ç«¯ã€‚å‡ºäºæ¼”ç¤ºçš„ç›®çš„ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œå³ä½¿æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨çš„å›¾åƒæ˜¯å…¬å¼€çš„ã€‚

åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨ Kubernetes é›†ç¾¤ä¸Šåˆ›å»ºä¸€ä¸ª`docker-registry`ç±»å‹çš„ç§˜å¯†:

```
$ kubectl create secret docker-registry dockerhub-user --docker-server=https://index.docker.io/v1/ --docker-username=YOUR_DOCKER_HUB_USERNAME --docker-password=YOUR_DOCKER_HUB_PASSWORD --docker-email=YOUR_EMAIL` 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ:
æ¥éªŒè¯è¿™ä¸ªç§˜å¯†

```
$ kubectl get secret dockerhub-user --output=yaml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å’Œä¿¡å·é‡ä¸€æ ·ï¼ŒKubernetes çš„ç§˜å¯†æ˜¯ base64 ç¼–ç çš„ï¼Œè¾“å‡ºç±»ä¼¼äº:

```
apiVersion: v1
data:
  .dockerconfigjson: eyJhdXRocyI6eyJodHR...
kind: Secret
metadata:
  creationTimestamp: 2019-02-08T10:18:52Z
  name: dockerhub-user
  namespace: default
  resourceVersion: "7431"
  selfLink: /api/v1/namespaces/default/secrets/dockerhub-user
  uid: eec7c39e-2b8a-11e9-a804-1a46bc991881
type: kubernetes.io/dockerconfigjson 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#write-a-deployment-manifest)ç¼–å†™éƒ¨ç½²æ¸…å•

åœ¨æ‚¨çš„å­˜å‚¨åº“ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œä¾‹å¦‚åä¸º`deployment.yml` :

```
# deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: semaphore-demo-ruby-kubernetes
spec:
  replicas: 1
  selector:
    matchLabels:
      app: semaphore-demo-ruby-kubernetes
  template:
    metadata:
      labels:
        app: semaphore-demo-ruby-kubernetes
    spec:
      containers:
        - name: semaphore-demo-ruby-kubernetes
          image: semaphoredemos/semaphore-demo-ruby-kubernetes:$SEMAPHORE_WORKFLOW_ID
      imagePullSecrets: # if using a private image
        - name: dockerhub-user 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ DigitalOcean æä¾›çš„ nginx ç¤ºä¾‹ç›¸æ¯”ï¼Œæˆ‘ä»¬å‡ ä¹åªæ›¿æ¢äº†åº”ç”¨ç¨‹åºå’Œå›¾åƒåç§°ã€‚å› ä¸º Semaphore ä½¿ç”¨`SEMAPHORE_WORKFLOW_ID`ç¯å¢ƒå˜é‡æ¥æ ‡è®°å›¾åƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿä½¿ç”¨å®ƒã€‚

ç°åœ¨å‡ºç°çš„éƒ¨ç½²é…ç½®æ–‡ä»¶æ˜¯**è€Œä¸æ˜¯**æœ‰æ•ˆçš„ YMLã€‚è®¡åˆ’æ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º [envsubst](https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html) çš„ Linux å®ç”¨ç¨‹åº(ä¹Ÿå¯ä»¥é€šè¿‡ Homebrew åœ¨ Mac ä¸Šè·å¾—)æ¥æ›¿æ¢ä¿¡å·é‡ CI/CD ä½œä¸šä¸­çš„å€¼`$SEMAPHORE_WORKFLOW_ID`ã€‚

ç„¶è€Œï¼Œå¦‚æœæ²¡æœ‰ Kubernetes è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆ‘ä»¬çš„éƒ¨ç½²æ¸…å•è¿˜ä¸å®Œæ•´ã€‚å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸­:

```
# deployment.yml
# ...
--------

apiVersion: v1
kind: Service
metadata:
  name: semaphore-demo-lb
spec:
  selector:
    app: semaphore-demo-ruby-kubernetes
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 4567 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡ç”¨`latest`æ›¿æ¢`$SEMAPHORE_WORKFLOW_ID`å¹¶è¿è¡Œ:
ï¼Œæ‚¨å¯ä»¥åœ¨æœ¬åœ°æœºå™¨ä¸ŠéªŒè¯ Kubernetes é…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ

```
$ kubectl apply -f deployment.yml
$ kubectl get services
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE
semaphore-demo-ruby-kubernetes     LoadBalancer   10.245.117.152   68.183.249.106   80:30569/TCP   5d
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#define-a-semaphore-deployment-pipeline)å®šä¹‰ä¸€ä¸ªä¿¡å·é‡éƒ¨ç½²ç®¡é“

æˆ‘ä»¬æ­£åœ¨è¿›å…¥ CI/CD é…ç½®çš„æœ€åé˜¶æ®µã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨`semaphore.yml`ä¸­å®šä¹‰äº†ä¸€ä¸ª CI ç®¡é“ï¼Œåœ¨`docker-build.yml`ä¸­å®šä¹‰äº†ä¸€ä¸ª`Docker build`ç®¡é“ã€‚æˆ‘ä»¬å°†å®šä¹‰ç¬¬ä¸‰ä¸ªä»`Docker build`æ‰‹åŠ¨è§¦å‘çš„ç®¡é“ï¼Œå®ƒå°†éƒ¨ç½²åˆ° Kubernetesã€‚

é¦–å…ˆå®šä¹‰æ‰‹åŠ¨ä¿ƒé”€:

```
# .semaphore/docker-build.yml
# ...
promotions:
  - name: Deploy to Kubernetes
    pipeline_file: deploy-k8s.yml 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œè®©æˆ‘ä»¬å®šä¹‰éƒ¨ç½²ç®¡é“ã€‚å®ƒæœ‰ä¸¤ä¸ªå·¥ä½œ:åº”ç”¨ä¸€ä¸ªæ–°çš„ Kubernetes é…ç½®å’Œåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„`latest`å®¹å™¨æ˜ åƒï¼Œæˆ‘ä»¬å°†å®ƒè§†ä¸º Git ä¸­çš„ä¸»åˆ†æ”¯(æ‚¨çš„å®è·µå¯èƒ½æœ‰æ‰€ä¸åŒ)ã€‚

```
# .semaphore/deploy-k8s.yml
version: v1.0
name: Deploy to Kubernetes
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy to Kubernetes
    task:
      secrets:
        - name: do-k8s
      env_vars:
        - name: KUBECONFIG
          value: /home/semaphore/.kube/dok8s.yaml
      jobs:
      - name: Deploy
        commands:
          - checkout
          - kubectl get nodes
          - kubectl get pods
          - envsubst < deployment.yml | tee deployment.yml
          - kubectl apply -f deployment.yml

  - name: Tag latest release
    task:
      secrets:
        - name: dockerhub-users
      jobs:
      - name: docker tag latest
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - docker pull semaphoreci-demos/semaphore-demo-ruby-kubernetes:$SEMAPHORE_WORKFLOW_ID
          - docker tag semaphoreci-demos/semaphore-demo-ruby-kubernetes:$SEMAPHORE_WORKFLOW_ID semaphoreci-demos/semaphore-demo-ruby-kubernetes:latest
          - docker push semaphoreci-demos/semaphore-demo-ruby-kubernetes:latest 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦æˆ‘ä»¬å°†æ–°ç‰ˆæœ¬çš„é…ç½®æ¨é€åˆ° GitHubï¼ŒSemaphore å°±ä¼šè¿è¡Œæˆ‘ä»¬çš„ç®¡é“ã€‚Docker æ„å»ºç®¡é“æˆåŠŸå®Œæˆåï¼Œå•å‡»â€œPromoteâ€æŒ‰é’®è§¦å‘éƒ¨ç½²:

[![Launched deployment to Kubernetes](../Images/9e947f4d856e5caab9055529e8547953.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Hb5d0Q-z--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/qdomze3sbj0vxm4oj9hy.png)

æ‚¨ç°åœ¨å¯ä»¥è¿è¡Œ`kubectl get services`æˆ–æ‰“å¼€ DigitalOcean >ç½‘ç»œé€‰é¡¹å¡éƒ¨åˆ†çš„è´Ÿè½½å¹³è¡¡å™¨åˆ—è¡¨æ¥æŸ¥æ‰¾æ‚¨çš„å¾®æœåŠ¡çš„å…¬å…± IP åœ°å€:

[![IP address from load balancer](../Images/74dda75e30efb97b3fa7be61f5255add.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--cR66wyqf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/osa990bz6lbu1oxh5p43.png)

å¹¶æµ‹è¯•å‡ºæ¥:

```
$ curl 68.183.251.210
hello world :)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­å–œä½ ï¼ä½ ç°åœ¨æœ‰äº†ä¸€ä¸ªå…¨è‡ªåŠ¨çš„è¿ç»­è¾“é€ç®¡é“ã€‚

## [](#deploy-a-demo-app-for-yourself)ä¸ºè‡ªå·±éƒ¨ç½²ä¸€ä¸ªæ¼”ç¤º app

éšæ„æ´¾ç”Ÿå‡º[semaphore-demo-ruby-kubernetes](https://github.com/semaphoreci-demos/semaphore-demo-ruby-kubernetes)å­˜å‚¨åº“ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Semaphore é¡¹ç›®å°†å…¶éƒ¨ç½²åˆ°æ‚¨çš„ Kubernetes å®ä¾‹ä¸Šã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ä½ å¯ä»¥åšå‡ºçš„æ½œåœ¨æ”¹å˜çš„æƒ³æ³•:

*   å¼•å…¥æš‚å­˜ç¯å¢ƒ
*   é¦–å…ˆæ„å»ºä¸€ä¸ª Docker æ˜ åƒï¼Œå¹¶åœ¨å…¶ä¸­è¿è¡Œæµ‹è¯•(éœ€è¦ Dockerfile çš„å¼€å‘ç‰ˆæœ¬ï¼Œå› ä¸ºåœ¨ä¸ºç”Ÿäº§åˆ¶ä½œæ˜ åƒæ—¶æœ€å¥½é¿å…å®‰è£…å¼€å‘å’Œæµ‹è¯•ä¾èµ–é¡¹)ã€‚
*   ç”¨æ›´å¤šçš„å¾®æœåŠ¡æ‰©å±•é¡¹ç›®ã€‚

è¿™ç¯‡æ–‡ç« æ˜¯åŸºäº CI/CD ä¸Šçš„ YouTube è§†é¢‘ç³»åˆ— Semaphore Uncut çš„ä¸€é›†:

[https://www.youtube.com/embed/hi-OPGpecXQ](https://www.youtube.com/embed/hi-OPGpecXQ)

æ„Ÿè°¢é˜…è¯»ï¼ğŸ™Œè¯·ç»™æˆ‘åé¦ˆï¼Œæˆ‘å¾ˆä¹æ„å›ç­”ä½ è¯„è®ºä¸­çš„ä»»ä½•é—®é¢˜ã€‚

è¦äº†è§£æ›´å¤šæ·±å…¥çš„å†…å®¹ï¼Œè¯·ç‚¹å‡»è¿™é‡Œå…³æ³¨æˆ‘ï¼Œæˆ–è€…[åœ¨ Kubernetes](https://eepurl.com/dLkTuw) ä¸Šæ³¨å†Œ Semaphore çš„å…è´¹ CI/CD ç”µå­ä¹¦ã€‚â¤ï¸

*åŸè½½äº[æ——è¯­åšå®¢](https://semaphoreci.com/blog/cicd-microservices-digitalocean-kubernetes)* ã€‚