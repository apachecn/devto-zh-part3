# å¤„ç†åµŒå¥—å›è°ƒ

> åŸæ–‡:[https://dev.to/zellwk/dealing-with-nested-callbacks-55o2](https://dev.to/zellwk/dealing-with-nested-callbacks-55o2)

JavaScript æ˜¯ä¸€ç§å¥‡æ€ªçš„è¯­è¨€ã€‚å¶å°”ï¼Œä½ å¿…é¡»å¤„ç†ä¸€ä¸ªå›è°ƒï¼Œè¿™ä¸ªå›è°ƒåœ¨å¦ä¸€ä¸ªå›è°ƒä¸­ã€‚

äººä»¬äº²åˆ‡åœ°ç§°è¿™ç§æ¨¡å¼ä¸º*å›è°ƒåœ°ç‹±*ã€‚

çœ‹èµ·æ¥æœ‰ç‚¹åƒè¿™æ ·:

```
firstFunction(args, function() {
  secondFunction(args, function() {
    thirdFunction(args, function() {
      // And so on...
    });
  });
}); 
```

è¿™æ˜¯ç»™ä½ çš„ JavaScriptã€‚çœ‹åˆ°åµŒå¥—å›è°ƒæ˜¯ä»¤äººéš¾ä»¥ç½®ä¿¡çš„ï¼Œä½†æˆ‘ä¸è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªâ€œåœ°ç‹±â€ã€‚å¦‚æœä½ çŸ¥é“å¦‚ä½•å¤„ç†ï¼Œè¿™ä¸ªâ€œåœ°ç‹±â€æ˜¯å¯ä»¥æ§åˆ¶çš„ã€‚

## [](#on-callbacks)è¿›è¡Œå›è°ƒ

å¦‚æœä½ æ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å‡è®¾ä½ çŸ¥é“ä»€ä¹ˆæ˜¯å›è°ƒã€‚å¦‚æœä½ ä¸çŸ¥é“ï¼Œè¯·åœ¨ç»§ç»­ä¹‹å‰é˜…è¯»[è¿™ç¯‡æ–‡ç« ](https://zellwk.com/blog/callbacks)ä¸­å…³äºå›è°ƒçš„ä»‹ç»ã€‚åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬è®¨è®ºä»€ä¹ˆæ˜¯å›è°ƒï¼Œä»¥åŠä¸ºä»€ä¹ˆåœ¨ JavaScript ä¸­ä½¿ç”¨å›è°ƒã€‚

## [](#solutions-to-callback-hell)è§£å†³å›è°ƒåœ°ç‹±

å›è°ƒåœ°ç‹±æœ‰å››ç§è§£å†³æ–¹æ¡ˆ:

1.  å†™è¯„è®º
2.  å°†å‡½æ•°æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°
3.  åˆ©ç”¨æ‰¿è¯º
4.  ä½¿ç”¨å¼‚æ­¥/ç­‰å¾…

åœ¨æˆ‘ä»¬æ·±å…¥ç ”ç©¶è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ„å»ºä¸€ä¸ªå›è°ƒåœ°ç‹±ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºå¤ªæŠ½è±¡äº†ï¼Œçœ‹ä¸åˆ°`firstFunction`ã€`secondFunction`ã€`thirdFunction`ã€‚æˆ‘ä»¬æƒ³æŠŠå®ƒå…·ä½“åŒ–ã€‚

## [](#constructing-a-callback-hell)æ„ç­‘å›è°ƒåœ°ç‹±

è®©æˆ‘ä»¬æƒ³è±¡æˆ‘ä»¬æ­£åœ¨åšä¸€ä¸ªæ±‰å ¡ã€‚è¦åšä¸€ä¸ªæ±‰å ¡ï¼Œæˆ‘ä»¬éœ€è¦ç»å†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

1.  è·å–é…æ–™(æˆ‘ä»¬å‡è®¾è¿™æ˜¯ä¸€ä¸ªç‰›è‚‰æ±‰å ¡)
2.  ç…®ç‰›è‚‰
3.  ä¹°æ±‰å ¡é¢åŒ…
4.  æŠŠç†Ÿç‰›è‚‰æ”¾åœ¨å°åœ†é¢åŒ…ä¹‹é—´
5.  ä¸Šæ±‰å ¡

å¦‚æœè¿™äº›æ­¥éª¤æ˜¯åŒæ­¥çš„ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„å‡½æ•°:

```
const makeBurger = () => {
  const beef = getBeef();
  const patty = cookBeef(beef);
  const buns = getBuns();
  const burger = putBeefBetweenBuns(buns, beef);
  return burger;
};

const burger = makeBurger();
serve(burger); 
```

ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œå‡è®¾æˆ‘ä»¬ä¸èƒ½è‡ªå·±åˆ¶ä½œæ±‰å ¡ã€‚æˆ‘ä»¬å¿…é¡»æŒ‡å¯¼åŠ©æ‰‹åšæ±‰å ¡çš„æ­¥éª¤ã€‚åœ¨æˆ‘ä»¬æŒ‡ç¤ºåŠ©æ‰‹ä¹‹åï¼Œæˆ‘ä»¬å¿…é¡»*ç­‰å¾…*åŠ©æ‰‹å®Œæˆï¼Œç„¶åæ‰èƒ½å¼€å§‹ä¸‹ä¸€æ­¥ã€‚

å¦‚æœæˆ‘ä»¬æƒ³åœ¨ JavaScript ä¸­ç­‰å¾…ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å›è°ƒã€‚è¦åšæ±‰å ¡ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆå¾—åˆ°ç‰›è‚‰ã€‚æˆ‘ä»¬åªæœ‰æ‹¿åˆ°ç‰›è‚‰åæ‰èƒ½ç…®ç‰›è‚‰ã€‚

```
const makeBurger = () => {
  getBeef(function(beef) {
    // We can only cook beef after we get it.
  });
}; 
```

ä¸ºäº†çƒ¹é¥ªç‰›è‚‰ï¼Œæˆ‘ä»¬éœ€è¦å°†`beef`ä¼ é€’ç»™`cookBeef`å‡½æ•°ã€‚ä¸ç„¶æ²¡ä»€ä¹ˆå¥½ç…®çš„ï¼ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»ç­‰ç‰›è‚‰ç†Ÿäº†ã€‚

ä¸€æ—¦ç‰›è‚‰ç†Ÿäº†ï¼Œæˆ‘ä»¬å°±æœ‰å°é¢åŒ…äº†ã€‚

```
const makeBurger = () => {
  getBeef(function(beef) {
    cookBeef(beef, function(cookedBeef) {
      getBuns(function(buns) {
        // Put patty in bun
      });
    });
  });
}; 
```

æ‹¿åˆ°å°é¢åŒ…åï¼Œæˆ‘ä»¬éœ€è¦æŠŠé¦…é¥¼æ”¾åœ¨å°é¢åŒ…ä¸­é—´ã€‚è¿™å°±æ˜¯æ±‰å ¡å½¢æˆçš„åœ°æ–¹ã€‚

```
const makeBurger = () => {
  getBeef(function(beef) {
    cookBeef(beef, function(cookedBeef) {
      getBuns(function(buns) {
        putBeefBetweenBuns(buns, beef, function(burger) {
          // Serve the burger
        });
      });
    });
  });
}; 
```

ç»ˆäºå¯ä»¥ä¸Šæ±‰å ¡äº†ï¼ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ä»`makeBurger`è¿”å›`burger`ï¼Œå› ä¸ºå®ƒæ˜¯å¼‚æ­¥çš„ã€‚æˆ‘ä»¬éœ€è¦æ¥å—ä¸€ä¸ªå›è°ƒæ¥æä¾›æ±‰å ¡ã€‚

```
const makeBurger = nextStep => {
  getBeef(function (beef) {
    cookBeef(beef, function (cookedBeef) {
      getBuns(function (buns) {
        putBeefBetweenBuns(buns, beef, function(burger) {
          nextStep(burger)
        })
      })
    })
  })
}

// Make and serve the burger
makeBurger(function (burger) => {
  serve(burger)
}) 
```

(æˆ‘å¾ˆä¹æ„åšè¿™ä¸ªå›è°ƒåœ°ç‹±çš„ä¾‹å­ğŸ˜†).

## [](#first-solution-to-callback-hell-write-comments)å…ˆè§£å›è°ƒåœ°ç‹±:å†™è¯„è®º

å›è°ƒåœ°ç‹±å¾ˆå®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬å¯ä»¥è¯»å®ƒã€‚åªæ˜¯...çœ‹èµ·æ¥ä¸å¤ªå¥½ã€‚

å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡é˜…è¯»`makeBurger`ï¼Œä½ å¯èƒ½ä¼šæƒ³â€œä¸ºä»€ä¹ˆæˆ‘ä»¬åšä¸€ä¸ªæ±‰å ¡éœ€è¦è¿™ä¹ˆå¤šå›è°ƒï¼Ÿæ²¡é“ç†å•Šï¼â€ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥ç•™ä¸‹æ³¨é‡Šæ¥è§£é‡Šä½ çš„ä»£ç ã€‚

```
// Makes a burger
// makeBurger contains four steps:
//   1\. Get beef
//   2\. Cook the beef
//   3\. Get buns for the burger
//   4\. Put the cooked beef between the buns
//   5\. Serve the burger (from the callback)
// We use callbacks here because each step is asynchronous.
//   We have to wait for the helper to complete the one step
//   before we can start the next step
const makeBurger = nextStep => {
  getBeef(function(beef) {
    cookBeef(beef, function(cookedBeef) {
      getBuns(function(buns) {
        putBeefBetweenBuns(buns, beef, function(burger) {
          nextStep(burger);
        });
      });
    });
  });
}; 
```

ç°åœ¨ï¼Œä¸å…¶æƒ³â€œwtfï¼Ÿ!"å½“ä½ çœ‹åˆ°å›è°ƒåœ°ç‹±çš„æ—¶å€™ï¼Œä½ å°±æ˜ç™½ä¸ºä»€ä¹ˆè¦è¿™æ ·å†™äº†ã€‚

## [](#second-solution-to-callback-hell-split-the-callbacks-into-different-functions)å›è°ƒåœ°ç‹±ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆ:å°†å›è°ƒæ‹†åˆ†æˆä¸åŒçš„å‡½æ•°

æˆ‘ä»¬çš„å›è°ƒåœ°ç‹±ä¾‹å­å·²ç»æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚è®©æˆ‘å‘æ‚¨å±•ç¤ºä¸€æ­¥ä¸€æ­¥çš„å‘½ä»¤å¼ä»£ç ï¼Œæ‚¨å°±ä¼šæ˜ç™½ä¸ºä»€ä¹ˆäº†ã€‚

å¯¹äºæˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡å›è®¿ï¼Œæˆ‘ä»¬å¿…é¡»å»å†°ç®±æ‹¿ç‰›è‚‰ã€‚å¨æˆ¿é‡Œæœ‰ä¸¤å°å†°ç®±ã€‚æˆ‘ä»¬éœ€è¦å»æ­£ç¡®çš„å†°ç®±ã€‚

```
const getBeef = nextStep => {
  const fridge = leftFright;
  const beef = getBeefFromFridge(fridge);
  nextStep(beef);
}; 
```

è¦ç…®ç‰›è‚‰ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç‰›è‚‰æ”¾å…¥çƒ¤ç®±ï¼›æŠŠçƒ¤ç®±è°ƒåˆ° 200 åº¦ï¼Œç­‰ 20 åˆ†é’Ÿã€‚

```
const cookBeef = (beef, nextStep) => {
  const workInProgress = putBeefinOven(beef);
  setTimeout(function() {
    nextStep(workInProgress);
  }, 1000 * 60 * 20);
}; 
```

ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ‚¨å¿…é¡»åœ¨`makeBurger`ä¸­å†™ä¸‹è¿™äº›æ­¥éª¤ä¸­çš„æ¯ä¸€æ­¥...æ‚¨å¯èƒ½ä¼šè¢«å¤§é‡çš„ä»£ç å“æ™•ï¼

å…³äºå°†å›è°ƒåˆ†è§£æˆæ›´å°å‡½æ•°çš„å…·ä½“ä¾‹å­ï¼Œä½ å¯ä»¥é˜…è¯»æˆ‘çš„å›è°ƒæ–‡ç« ä¸­çš„è¿™ä¸€å°éƒ¨åˆ†ã€‚

## [](#third-solution-to-callback-hell-use-promises)å›æ‹¨åœ°ç‹±çš„ç¬¬ä¸‰ä¸ªåŠæ³•:ç”¨æ‰¿è¯º

æˆ‘å‡è®¾ä½ çŸ¥é“ä»€ä¹ˆæ˜¯æ‰¿è¯ºã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·[çœ‹è¿™ç¯‡æ–‡ç« ](https://zellwk.com/blog/js-promises/)ã€‚

æ‰¿è¯ºå¯ä»¥è®©å›æ‹¨å˜å¾—æ›´å®¹æ˜“ç®¡ç†ã€‚æ‚¨çœ‹åˆ°çš„ä¸æ˜¯ä¸Šé¢çš„åµŒå¥—ä»£ç ï¼Œè€Œæ˜¯:

```
const makeBurger = () => {
  return getBeef()
    .then(beef => cookBeef(beef))
    .then(cookedBeef => getBuns(beef))
    .then(bunsAndBeef => putBeefBetweenBuns(bunsAndBeef));
};

// Make and serve burger
makeBurger().then(burger => serve(burger)); 
```

å¦‚æœä½ åˆ©ç”¨äº†å•å‚æ•°é£æ ¼çš„æ‰¿è¯ºï¼Œä½ å¯ä»¥æŠŠä¸Šé¢çš„ä¿®æ”¹æˆ:

```
const makeBurger = () => {
  return getBeef()
    .then(cookBeef)
    .then(getBuns)
    .then(putBeefBetweenBuns);
};

// Make and serve burger
makeBurger().then(serve); 
```

æ›´å®¹æ˜“é˜…è¯»å’Œç®¡ç†ã€‚

ä½†é—®é¢˜æ˜¯å¦‚ä½•å°†åŸºäºå›è°ƒçš„ä»£ç è½¬æ¢æˆåŸºäºæ‰¿è¯ºçš„ä»£ç ã€‚

### [](#converting-callbacks-to-promises)å°†å›ç”µè½¬åŒ–ä¸ºæ‰¿è¯º

ä¸ºäº†å°†å›è°ƒè½¬æ¢ä¸ºæ‰¿è¯ºï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªå›è°ƒåˆ›å»ºä¸€ä¸ªæ–°çš„æ‰¿è¯ºã€‚å½“å›æ‹¨æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…‘ç°æ‰¿è¯ºã€‚æˆ–è€…æˆ‘ä»¬å¯ä»¥`reject`æ‰¿è¯ºå¦‚æœå›è°ƒå¤±è´¥ã€‚

```
const getBeefPromise = _ => {
  const fridge = leftFright;
  const beef = getBeefFromFridge(fridge);

  return new Promise((resolve, reject) => {
    if (beef) {
      resolve(beef);
    } else {
      reject(new Error("No more beef!"));
    }
  });
}; 
```

```
const cookBeefPromise = beef => {
  const workInProgress = putBeefinOven(beef);

  return new Promise((resolve, reject) => {
    setTimeout(function() {
      resolve(workInProgress);
    }, 1000 * 60 * 20);
  });
}; 
```

å®é™…ä¸Šï¼Œå¤è¯•å¯èƒ½å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†ã€‚å¦‚æœä½¿ç”¨ Nodeï¼Œæ¯ä¸ªåŒ…å«å›è°ƒçš„å‡½æ•°å°†å…·æœ‰ç›¸åŒçš„è¯­æ³•:

1.  å›è°ƒå°†æ˜¯æœ€åä¸€ä¸ªå‚æ•°
2.  å›è°ƒæ€»æ˜¯æœ‰ä¸¤ä¸ªå‚æ•°ã€‚è¿™äº›è®ºç‚¹ä¹Ÿæ˜¯åŒæ ·çš„é¡ºåºã€‚(é¦–å…ˆæ˜¯é”™è¯¯ï¼Œç„¶åæ˜¯æ‚¨æ„Ÿå…´è¶£çš„å†…å®¹)ã€‚

```
// The function that's defined for you
const functionName = (arg1, arg2, callback) => {
  // Do stuff here
  callback(err, stuff);
};

// How you use the function
functionName(arg1, arg2, (err, stuff) => {
  if (err) {
    console.error(err);
  }
  // Do stuff
}); 
```

å¦‚æœä½ çš„å›è°ƒæœ‰ç›¸åŒçš„è¯­æ³•ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼äº [ES6 Promisify](https://www.npmjs.com/package/es6-promisify) æˆ– [Denodeify](https://www.npmjs.com/package/denodeify) (de-node-ify)çš„åº“æ¥å›è°ƒæ‰¿è¯ºã€‚å¦‚æœä½¿ç”¨ Node v8.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ [util.promisify](https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original) ã€‚

ä»–ä»¬ä¸‰ä¸ªéƒ½å·¥ä½œã€‚æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨ä»»ä½•åº“ã€‚å°½ç®¡æ¯ç§æ–¹æ³•ä¹‹é—´æœ‰ç»†å¾®çš„å·®åˆ«ã€‚æˆ‘ä¼šè®©ä½ å»æ£€æŸ¥ä»–ä»¬çš„æ–‡æ¡£ã€‚

## [](#fourth-solution-to-callback-hell-use-asynchronous-functions)å›è°ƒåœ°ç‹±çš„ç¬¬å››ç§è§£å†³æ–¹æ¡ˆ:ä½¿ç”¨å¼‚æ­¥å‡½æ•°

è¦ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸¤ä»¶äº‹:

1.  å¦‚ä½•å°†å›ç”µè½¬åŒ–ä¸ºæ‰¿è¯º(é˜…è¯»ä¸Šæ–‡)
2.  å¦‚ä½•ä½¿ç”¨å¼‚æ­¥å‡½æ•°([éœ€è¦å¸®åŠ©å°±çœ‹è¿™ä¸ª](https://zellwk.com/blog/async-await))ã€‚

æœ‰äº†å¼‚æ­¥å‡½æ•°ï¼Œä½ å¯ä»¥å†™`makeBurger`å°±å¥½åƒå®ƒåˆæ˜¯åŒæ­¥çš„ä¸€æ ·ï¼

```
const makeBurger = async () => {
  const beef = await getBeef();
  const cookedBeef = await cookBeef(beef);
  const buns = await getBuns();
  const burger = await putBeefBetweenBuns(cookedBeef, buns);
  return burger;
};

// Make and serve burger
makeBurger().then(serve); 
```

è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹`makeBurger`åšä¸€ä¸ªæ”¹è¿›ã€‚ä½ å¤§æ¦‚å¯ä»¥åŒæ—¶ç»™`getBuns`å’Œ`getBeef`æ‰¾ä¸¤ä¸ªå¸®æ‰‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç”¨`Promise.all`æ¥`await`ä»–ä»¬ä¿©ã€‚

```
const makeBurger = async () => {
  const [beef, buns] = await Promise.all(getBeef, getBuns);
  const cookedBeef = await cookBeef(beef);
  const burger = await putBeefBetweenBuns(cookedBeef, buns);
  return burger;
};

// Make and serve burger
makeBurger().then(serve); 
```

(æ³¨æ„:ä½ å¯ä»¥å¯¹æ‰¿è¯ºåšåŒæ ·çš„äº‹æƒ…...ä½†æ˜¯è¯­æ³•æ²¡æœ‰ async/await å‡½æ•°é‚£ä¹ˆå¥½å’Œæ¸…æ™°)ã€‚

## [](#wrapping-up)æ”¶å°¾

å›è°ƒåœ°ç‹±æ²¡æœ‰ä½ æƒ³çš„é‚£ä¹ˆåœ°ç‹±ã€‚æœ‰å››ç§ç®€å•çš„æ–¹æ³•æ¥ç®¡ç†å›è°ƒåœ°ç‹±:

1.  å†™è¯„è®º
2.  å°†å‡½æ•°æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°
3.  åˆ©ç”¨æ‰¿è¯º
4.  ä½¿ç”¨å¼‚æ­¥/ç­‰å¾…

* * *

æ„Ÿè°¢é˜…è¯»ã€‚è¿™ç¯‡æ–‡ç« æœ€åˆå‘è¡¨åœ¨æˆ‘çš„åšå®¢ä¸Šã€‚å¦‚æœä½ æƒ³è¦æ›´å¤šçš„æ–‡ç« æ¥å¸®åŠ©ä½ æˆä¸ºä¸€ä¸ªæ›´å¥½çš„å‰ç«¯å¼€å‘è€…ï¼Œè¯·æ³¨å†Œ[æˆ‘çš„æ—¶äº‹é€šè®¯](https://zellwk.com)ã€‚