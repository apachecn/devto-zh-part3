# Rails å‰–ææ•…äº‹ï¼Œæˆ–è€…æˆ‘å¦‚ä½•æŠ“ä½ Faker è¯•å›¾æ•™æˆ‘çš„åº”ç”¨æ¾³å¤§åˆ©äºšä¿šè¯­

> åŸæ–‡:[https://dev . to/evil mars an/rails-profiling-story-or-how-I-catched-faker-try-to-teach-my-app-Australia n-slang-8ai](https://dev.to/evilmartians/rails-profiling-story-or-how-i-caught-faker-trying-to-teach-my-app-australian-slang-8ai)

å¾ˆä¹…ä»¥å‰(å®é™…ä¸Šæ˜¯å‡ å¤©å‰)æˆ‘ä¸€ç›´åœ¨åšä¸€ä¸ªå°çš„é‡æ„ä»»åŠ¡:å°† [`factory_bot`](https://github.com/thoughtbot/factory_bot) é›†æˆåˆ°é‚®ä»¶é¢„è§ˆä¸­ã€‚

çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡:åŠ è½½`factory_bot_rails`å¹¶åŒ…å«è¯­æ³•æ–¹æ³•:

```
# spec/mailers/previews/application_preview.rb

require "factory_bot_rails"

class ApplicationPreview < ActionMailer::Preview
  include FactoryBot::Syntax::Methods

  private

  # user record for previews
  def user
    @user ||= build_stubbed :user
  end
end 
```

ä¹‹åï¼Œæˆ‘æ£€æŸ¥äº†æœ¬åœ°çš„ä¸€åˆ‡æ­£å¸¸ï¼Œå‘ç°äº†ä¸€äº›å¥‡æ€ªçš„äº‹æƒ…:

[![mailer preview](../Images/19acef67da9dff65724e6ad00604848a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--vN-falof--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/1ocu4gtknx72rm2xypl1.png)

å“‡ï¼æˆ‘ä»¬æœ‰å¾ˆå¤šåœ°æ–¹ï¼åœ¨æˆ‘ä»¬çš„çº¯è‹±æ–‡åº”ç”¨ç¨‹åºä¸­ï¼å¤ªæ£’äº†ã€‚
*ä¸ï¼Œä¸æ˜¯*ã€‚

æˆ‘å¾ˆå¿«æ‰¾åˆ°äº†å®ƒçš„æ¥æº:æˆ‘ä»¬å·¥å‚ä½¿ç”¨çš„ [`faker`](https://github.com/stympy/faker) å®çŸ³ã€‚

æˆ‘æ£€æŸ¥äº†å›è´­åè®®ï¼Œæœ‰ç‚¹æƒŠè®¶:

```
require 'i18n'

#...

I18n.load_path += Dir[File.join(mydir, 'locales', '**/*.yml')]
I18n.reload! if I18n.backend.initialized? 
```

Faker ä¼šåŠ è½½å®ƒæ‰€æœ‰çš„è¯­è¨€ç¯å¢ƒæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸å…è®¸ä½ é€‰æ‹©ä½ å”¯ä¸€æƒ³è¦çš„è¯­è¨€ç¯å¢ƒã€‚å¯¹æˆ‘æ¥è¯´ï¼Œé‚£æ˜¯ä¸€ç§æ„æƒ³ä¸åˆ°çš„è¡Œä¸ºã€‚

**æ³¨æ„:**æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® [`config.i18n.available_locales`](https://guides.rubyonrails.org/i18n.html#configure-the-i18n-module) æ¥æ˜ç¡®æŒ‡å®šæ‚¨è¦åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å“ªäº›è¯­è¨€ç¯å¢ƒï¼›å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæ‰€æœ‰åŠ è½½çš„è¯­è¨€ç¯å¢ƒéƒ½æ˜¯å¯ç”¨çš„ã€‚

æˆ‘å†³å®šæ£€æŸ¥åŠ è½½ä¸€å †ä¸å¿…è¦çš„ YML æ–‡ä»¶å¯¹åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶é—´çš„å½±å“ã€‚

ç”±äº`i18n`ä¼šå»¶è¿ŸåŠ è½½è¯­è¨€ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘åœ¨æˆ‘çš„`rspec_helper.rb`ä¸­æ·»åŠ äº†ä¸‹é¢ä¸€è¡Œæ¥å¼ºåˆ¶åŠ è½½:

```
# add to rails_helper.rb
I18n.backend.load_translations 
```

æ³¨æ„:ç”±äºæˆ‘ä»¬åœ¨å·¥å‚ä¸­ä½¿ç”¨`faker`,æˆ‘ä»¬å‡ ä¹åœ¨æ¯ä¸ªæµ‹è¯•ä¸­éƒ½éœ€è¦åŒºåŸŸè®¾ç½®ã€‚

æˆ‘çš„åŒ…ä¸­å·²ç»æœ‰äº† [`test-prof`](https://test-prof.evilmartians.io/#/) ï¼Œæ‰€ä»¥åˆ†æå¼•å¯¼æ—¶é—´å°±åƒè¿è¡Œè¿™ä¸ªå‘½ä»¤ä¸€æ ·ç®€å•:

```
$ SAMPLE=1 TEST_STACK_PROF=boot TEST_STACK_PROF_FORMAT=json bundle exec rspec 
```

è®©æˆ‘è§£é‡Šä¸€ä¸‹è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…ã€‚

æˆ‘ä»¬â€œå‘Šè¯‰â€æµ‹è¯•æ•™æˆä½¿ç”¨[å †æ ˆæ•™æˆ](https://github.com/tmm1/stackprof)å’Œ[å¼•å¯¼æ¨¡å¼](https://test-prof.evilmartians.io/#/stack_prof?id=profiling-application-boot)æ¥åˆ†ææˆ‘ä»¬çš„æµ‹è¯•è¿è¡Œã€‚

åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ`stackprof`åœ¨åŠ è½½ä¹‹åç«‹å³å¼€å§‹æ”¶é›†æ ·æœ¬ï¼Œå¹¶åœ¨ç¬¬ä¸€æ¬¡æµ‹è¯•è¿è¡Œä¹‹å‰åœæ­¢(æ›´å‡†ç¡®åœ°è¯´ï¼Œåœ¨ RSpec `before(:suite)`é’©å­ä¸­)ã€‚

æˆ‘ä»¬è¿˜ä¼ é€’`SAMPLE=1`æ¥åªæ‰§è¡Œä¸€ä¸ªéšæœºæµ‹è¯•(è¿™ä¸ªç‰¹æ€§ä¹Ÿæ˜¯ç”±æµ‹è¯•æ•™æˆæä¾›çš„[):æˆ‘ä»¬ä¸å…³å¿ƒä¸€ä¸ªç‰¹å®šçš„ä¾‹å­ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ†æå¼•å¯¼æ—¶é—´ã€‚](https://test-prof.evilmartians.io/#/tests_sampling)

æœ€åï¼Œ`TEST_STACK_PROF_FORMAT`ç”¨äºç”Ÿæˆ JSON æ ¼å¼çš„å‰–ææŠ¥å‘Š(ç‰¹æ€§[å·²ç»æ·»åŠ ](https://github.com/tmm1/stackprof/pull/103)åˆ°`stackprof`æœ¬èº«ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å‘å¸ƒ)ã€‚

å¦‚ä½•å¤„ç†è¿™ä¸ª JSON æŠ¥å‘Šï¼Ÿè®©æˆ‘ä»¬æŠŠå®ƒè½½å…¥[é€Ÿåº¦èŒƒå›´](https://www.speedscope.app)ï¼

[Speedscope](https://www.speedscope.app) æ˜¯ä¸€ä¸ªç«ç„°å›¾æŸ¥çœ‹å™¨ï¼Œå®ƒå¯è§†åŒ–äº†ç”±æµè¡Œçš„åˆ†æå™¨(åŒ…æ‹¬`stackprof`)ç”Ÿæˆçš„ JSON æŠ¥å‘Šã€‚

æ³¨:ä»€ä¹ˆæ˜¯ç«ç„°å›¾ï¼Œå¦‚ä½•é˜…è¯»ï¼ŸæŸ¥çœ‹[â€œå®˜æ–¹æ–‡ä»¶â€](http://www.brendangregg.com/flamegraphs.html)ä»¥åŠ[ç±³å“ˆÂ·é›·å¡å°”](https://www.youtube.com/watch?v=6uKZXIwd6M0)çš„è¿™ç¯‡æ¼”è®²ã€‚

è¿™å°±æ˜¯æˆ‘çš„å‘ç°:

<figure>

[![flame graph with default faker](../Images/635aa4f6e69e7cecd4b30640ac1eb77e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--j0jo2iv0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7m0izg2gzfo7ec0a84kg.png)

<figcaption>Default Faker behaviour (loading all translations)</figcaption>

</figure>

æˆ‘ä»¬èŠ±äº†å¤§çº¦ 1.1 ç§’æ¥åŠ è½½åŒºåŸŸè®¾ç½®ã€‚

å¦‚æœæˆ‘ä»¬åªåŠ è½½è‹±æ–‡æ–‡ä»¶(ç”¨[è¿™ä¸ªè¡¥ä¸](https://gist.github.com/palkan/79fc88207dc856532fb777b8204f7131))ä¼šæ€ä¹ˆæ ·ï¼Ÿ

<figure>

[![flame graph with slim faker](../Images/8ff3cab8ea9de424e3e8a8257c466f40.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DqIDSDIV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/9i3hzx4r32f4xjewx9rl.png)

<figcaption>Patched Faker (loading only English translations)</figcaption>

</figure>

åŠ è½½è¯­è¨€ç¯å¢ƒåªèŠ±äº†å¤§çº¦ 0.4 ç§’ã€‚

çœ‹èµ·æ¥æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ğŸ˜•

å¦‚æœæˆ‘ä»¬æ·»åŠ  [`bootsnap`](https://github.com/Shopify/bootsnap) ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸â€œä¿®è¡¥â€`faker`çš„æƒ…å†µä¸‹è·å¾—ç›¸åŒçš„ç»“æœ:

<figure>

[![flame graph with bootsnap](../Images/cee25ae9a250ba0f56550760be763a75.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--BFR7S7FH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dr450wbfa6z6h8sh6una.png)

<figcaption>Default Faker with Bootsnap</figcaption>

</figure>

ä¹Ÿè®¸ï¼Œæˆ‘ä»¬æµªè´¹äº†å¾ˆå¤šè®°å¿†ï¼Ÿ

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ [`memory_profiler`](https://github.com/SamSaffron/memory_profiler) gem:
æ¥æµ‹é‡å†…å­˜å ç”¨

```
require "memory_profiler"

MemoryProfiler.report do
  I18n.backend.load_translations
end.yield_self(&:pretty_print) 
```

åŠ è½½æ‰€æœ‰å¯ç”¨è¯­è¨€ç¯å¢ƒæ—¶:

```
retained objects by gem
-----------------------------------
    147586  psych
      5462  i18n-1.5.3
         2  activesupport-6.0.0.beta1

retained objects by class
-----------------------------------
    148628  String
      2550  Array
      1022  Symbol
       848  Hash
         2  Proc 
```

å’Œè‹±æ–‡ç‰ˆ:

```
retained objects by gem
-----------------------------------
     44301  psych
      3418  i18n-1.5.3
         2  activesupport-6.0.0.beta1

retained objects by class
-----------------------------------
     45240  String
      1202  Array
       910  Symbol
       367  Hash
         2  Proc 
```

å› æ­¤ï¼Œ2.6MB ä¸ 7.8MB ä¹‹é—´çš„å·®å¼‚å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚åˆæ¥äº†ã€‚

æˆ‘ä»¬å¿…é¡»æ‰¿è®¤ï¼Œåœ¨è¿™ä¸ªç‰¹æ®Šçš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ä¾§å†™æ²¡æœ‰å‘ç°ä»»ä½•é‡å¤§é—®é¢˜ã€‚

è¿™ä¹Ÿå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå¹¸ç¦çš„ç»“å±€ğŸ™‚)

å¦å¤–ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹è¿™äº›å…³äºæµ‹è¯•æ•™æˆç®€ä»‹çš„å¸–å­:[â€œæ…¢çº¢å®çŸ³æµ‹è¯•çš„å¥½åŒ»ç”Ÿâ€](https://evilmartians.com/chronicles/testprof-a-good-doctor-for-slow-ruby-tests)å’Œ[â€œçº¢å®çŸ³æµ‹è¯•çš„å·¥å‚ç–—æ³•â€](https://evilmartians.com/chronicles/testprof-2-factory-therapy-for-your-ruby-tests-rspec-minitest)ã€‚

P.P.S .æ˜¯çš„ï¼ŒFaker çœŸçš„å¾ˆæ”¯æŒ[æ¾³æ´²ä¿šè¯­](https://github.com/stympy/faker/blob/e2081e7989344c7f11990d974266ea728531f42c/lib/locales/en-au-ocker.yml)ã€‚

* * *

é˜…è¯»æ›´å¤šå…³äº https://evilmartians.com/chronicles çš„æ–‡ç« ï¼