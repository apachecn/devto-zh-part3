# ç”¨ç±»å‹è„šæœ¬è§£ç  JSON

> åŸæ–‡:[https://dev . to/joannlennas/decoding-JSON-with-typescript-1jjc](https://dev.to/joanllenas/decoding-json-with-typescript-1jjc)

Typescript éå¸¸é€‚åˆä¸º JavaScript ç¨‹åºå¢åŠ ç±»å‹å®‰å…¨ï¼Œä½†æ˜¯å°±å…¶æœ¬èº«è€Œè¨€ï¼Œå®ƒä¸è¶³ä»¥ä¿è¯å®ƒåœ¨è¿è¡Œæ—¶ä¸ä¼šå´©æºƒã€‚

æœ¬æ–‡å±•ç¤ºäº† [JSON è§£ç å™¨](https://github.com/joanllenas/ts.data.json)å¦‚ä½•å¸®åŠ©å°† TypeScript ç¼–è¯‘æ—¶ä¿è¯æ‰©å±•åˆ°è¿è¡Œæ—¶ç¯å¢ƒã€‚

## [](#runtime-vs-compile-time)è¿è¡Œæ—¶ vs ç¼–è¯‘æ—¶

æ‚¨æ­£åœ¨å¼€å‘çš„åº”ç”¨ç¨‹åºä¸ç”¨æˆ·æ‰“äº¤é“ï¼Œå› æ­¤æ‚¨åˆ›å»ºäº†ä¸€ä¸ª`User`ç±»å‹:

```
interface User {
   firstName: string;
   lastName: string;
   picture: string;
   email: string;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å°†ä½¿ç”¨è¿™ä¸ªç±»å‹æ¥æ³¨é‡Š`/me` API ç«¯ç‚¹ç»“æœï¼Œç„¶åæ‚¨å°†ä½¿ç”¨è¿™ä¸ª`User`åšå„ç§å„æ ·çš„äº‹æƒ…ï¼Œä½†æ˜¯è®©æˆ‘ä»¬é›†ä¸­åœ¨åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶åŒºåŸŸ:

*   å®ƒå°†æ˜¾ç¤º`firstName` + `lastName`çš„è¿æ¥ã€‚
*   åœ¨`firstName` + `lastName`ä¸‹é¢ä½ ä¹Ÿè¦æ˜¾ç¤º`email`ã€‚
*   æœ€åï¼Œæ‚¨å¸Œæœ›æ˜¾ç¤ºç”¨æˆ·çš„`picture`,æˆ–è€…å¦‚æœä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤å›¾åƒã€‚

ä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿé¦–å…ˆï¼Œ`User`ç±»å‹æ²¡æœ‰è¯´æ˜äº‹å®ï¼Œå®ƒæ²¡æœ‰è¡¨è¾¾ API å¯ä»¥è¿”å›çš„`User` *å½¢çŠ¶*çš„æ‰€æœ‰æ’åˆ—ã€‚
æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­:

```
// The result has null properties
{ firstName: "John", lastName: null, picture: null, email: "john@example.com" }

// The API returned null
null

// The result has undefined properties
{ firstName: "John", lastName: "Doe", email: "john@example.com" }

// The API contract changed and the UI team wasn't notified
{ fName: "John", lName: "Doe", picture: 'pic.jpg', email: "john@example.com" } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![alt text](../Images/978472a9ba7b355010088a5d858fafcb.png "Who cares?")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--65YoeCWi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/se4dj39r4rjs7qqhs986.jpg)

ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹æŠ€æœ¯æ¥å¤„ç†è¿™äº›é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥`if`è¯­å¥èƒŒåçš„`null` / `undefined`ï¼Œä½†æ˜¯ï¼Œå½“å…¶ä»–äººæƒ³è¦åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨`/me`ç»“æœæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¹Ÿè®¸ä½ çš„åŒäº‹ä¿¡ä»»`User`ç±»å‹çš„äººï¼Œä¸ºä»€ä¹ˆä¸å‘¢ï¼Ÿæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæˆ‘ä»¬ä¸ºè¿è¡Œæ—¶é”™è¯¯å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å‘é‡ã€‚

## [](#enter-json-decoders)è¿›å…¥ Json è§£ç å™¨

æ‚¨ä½¿ç”¨ Json è§£ç å™¨æ¥ç¡®ä¿ç»™å®šçš„è¿è¡Œæ—¶å€¼ç¬¦åˆç‰¹å®šçš„ç¼–è¯‘æ—¶ç±»å‹ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå®ƒè¿˜ä¸ºæ‚¨æä¾›äº†åº”ç”¨è½¬æ¢ã€æ•…éšœè½¬ç§»ç­‰ç­‰çš„å·¥å…·ã€‚

å¤šäºäº† Elmï¼ŒJson è§£ç å™¨æœ€è¿‘å˜å¾—æµè¡Œèµ·æ¥ã€‚
Elm çš„ Json è§£ç å™¨æ˜¯è¯¥è¯­è¨€çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä»¬è¢«å¹¿æ³›ç”¨äºç¡®ä¿ JS åˆ° Elm çš„é¡ºç•…é€šä¿¡ã€‚

Json è§£ç å™¨èƒŒåçš„æƒ³æ³•æ˜¯ä½ æœ‰ä¸€ä¸ªåŸºæœ¬è§£ç å™¨çš„é›†åˆ(`string`ã€`number`ã€`boolean`ã€`object`ã€`array`...)å¯ä»¥ç»„æˆæ›´å¤æ‚çš„è§£ç å™¨ã€‚

## [](#stateoftheart-json-decoder-libraries)æœ€å…ˆè¿›çš„ JSON è§£ç å™¨åº“

æœ‰å‡ ä¸ª JSON è§£ç åº“ï¼Œä½†æ˜¯å½“æˆ‘ä¸ä¹…å‰è¿›è¡Œç ”ç©¶æ—¶ï¼Œæœ‰ä¸€ä¸ªéå¸¸çªå‡ºã€‚Daniel Van Den Eijkel åˆ›é€ äº†ä¸€äº›ä¸œè¥¿ï¼Œæ—¢ä¿ç•™äº† Elm è§£ç åº“çš„åŸåˆ™ï¼Œåˆç¬¦åˆæ‰“å­—ç¨¿çš„ä¹ æƒ¯ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªåº“æ²¡æœ‰è¢«ç»´æŠ¤å’Œå‘å¸ƒï¼Œæ‰€ä»¥æˆ‘å†³å®šåˆ†å‰å®ƒï¼Œæ¶¦è‰²å®ƒï¼Œå¹¶ä»¥åç§° [ts.data.json](https://github.com/joanllenas/ts.data.json) ä½œä¸º npm åŒ…å‘å¸ƒã€‚
æˆ‘å¯¹è¿™ä¸ªåº“çš„è´¡çŒ®æ˜¯æ–‡æ¡£ã€æ›´å¥½çš„é”™è¯¯æŠ¥å‘Šã€å•å…ƒæµ‹è¯•ã€API æ”¹è¿›ã€ä¸€äº›æ–°çš„è§£ç å™¨å’Œå‘å¸ƒ npm åŒ…ã€‚

## [](#using-json-decoders)ä½¿ç”¨ JSON è§£ç å™¨

å®‰è£…åº“:

```
npm install ts.data.json --save 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#decoding-basics)è§£ç åŸºç¡€çŸ¥è¯†

åœ¨å®ç°æˆ‘ä»¬çš„è‡ªå®šä¹‰`User`è§£ç å™¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä»å¤´åˆ°å°¾å°è¯•è§£ç ä¸€ä¸ª`string`ã€‚

```
import { JsonDecoder } from 'ts.data.json';

console.log( JsonDecoder.string.decode('Hi!') ); // Ok({value: 'Hi!'}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®Œäº†ï¼ğŸ‰

### [](#unwrapping-decoder-results)è§£åŒ…è§£ç ç»“æœ

æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ï¼Œè§£ç è¿‡ç¨‹æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚

*   é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨`JsonDecoder.string`å£°æ˜è§£ç å™¨ã€‚
*   å…¶æ¬¡ï¼Œæˆ‘ä»¬æ‰§è¡Œè§£ç å™¨ï¼Œç”¨`*.decode('Hi!')`ä¼ é€’ä¸€ä¸ª JavaScript å€¼ï¼Œå®ƒè¿”å›åŒ…è£…åœ¨`Ok`å®ä¾‹ä¸­çš„ç»“æœã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†ç»“æœåŒ…è£…åœ¨ä¸€ä¸ª`Ok`å®ä¾‹ä¸­ï¼Ÿå› ä¸ºä¸‡ä¸€å¤±è´¥ï¼Œæˆ‘ä»¬ä¼šå°†ç»“æœåŒ…è£…åœ¨ä¸€ä¸ª`Err`å®ä¾‹ä¸­ã€‚
è®©æˆ‘ä»¬çœ‹çœ‹`decode()`çš„ç­¾åæ˜¯ä»€ä¹ˆæ ·å­çš„:

```
decode(json: any): Result<a> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`Result<a>`æ˜¯`Ok`å’Œ`Err`çš„è”åˆç±»å‹ã€‚

```
type Result<a> = Ok<a> | Err; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¸ä¼šä½¿ç”¨`decode()`ï¼Œç›¸åæˆ‘ä»¬å¯èƒ½ä¼šæƒ³è¦ä½¿ç”¨`decodePromise()`ã€‚
è®©æˆ‘ä»¬çœ‹çœ‹`decodePromise()`çš„ç­¾åæ˜¯ä»€ä¹ˆæ ·å­çš„:

```
decodePromise<b>(json: any): Promise<a> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨`decodePromise()` :
ä»å¤´åˆ°å°¾è§£ç ä¸€ä¸ª`string`

```
import { JsonDecoder } from 'ts.data.json';

const json = Math.random() > 0.5 ? 'Hi!' : null;
JsonDecoder.string.decodePromise(json)
  .then(value => {
    console.log(value);
  })
  .catch(error => {
    console.log(error);
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€åŠæ—¶é—´æˆ‘ä»¬ä¼šé€šè¿‡`then()`è·¯çº¿å¾—åˆ°`Hi!`ï¼Œä¸€åŠæ—¶é—´æˆ‘ä»¬ä¼šé€šè¿‡`catch()`è·¯çº¿å¾—åˆ°`null is not a valid string`ã€‚

æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†åŸºç¡€çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬è®¤çœŸèµ·æ¥ï¼Œæ„å»ºæˆ‘ä»¬çš„å®šåˆ¶`User`è§£ç å™¨ã€‚

### `User`è§£ç å™¨

é™¤äº†åŸå§‹è§£ç å™¨:

*   `JsonDecoder.string: Decoder<string>`
*   `JsonDecoder.number: Decoder<number>`
*   `JsonDecoder.boolean: Decoder<boolean>`

è¿˜æœ‰å…¶ä»–æ›´å¤æ‚çš„è§£ç å™¨ï¼Œå¯¹äºæˆ‘ä»¬çš„`User`ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`JsonDecoder.object`è§£ç å™¨:

*   `JsonDecoder.object<a>(decoders: DecoderObject<a>, decoderName: string): Decoder<a>`

> #### [](#whats-that-raw-decoderltagt-endraw-thing-all-decoders-are-returning)æ‰€æœ‰è§£ç å™¨éƒ½åœ¨é€€çš„é‚£ä¸ª`Decoder<a>`æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ
> 
> è§£ç å™¨æœ‰è§£ç ç‰¹å®šå€¼çš„é€»è¾‘ï¼Œä½†ä»–ä»¬ä¸çŸ¥é“å¦‚ä½•æ‰§è¡Œå®ƒï¼Œè¿™å°±æ˜¯`Decoder`ç±»çš„ç”¨é€”ã€‚
> `Decoder<a>`æ‹¥æœ‰æ‰§è¡Œã€è§£åŒ…ã€é“¾æ¥å’Œè½¬æ¢è§£ç å™¨/è§£ç å™¨å€¼çš„æ–¹æ³•ã€‚

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢å­¦åˆ°çš„æ‰€æœ‰æŠ€å·§ä»å¤´åˆ°å°¾è§£ç ä¸€ä¸ª`User`:

```
import { JsonDecoder } from 'ts.data.json';

interface User {
  firstName: string;
  lastName: string;
}

const userDecoder = JsonDecoder.object<User>(
  {
    firstName: JsonDecoder.string,
    lastName: JsonDecoder.string
  },
  'User'
);

const validUser = {
  firstName: 'Nils',
  lastName: 'Frahm'
};

const invalidUser = {
  firstName: null,
  lastName: 'Wagner'
};

const json = Math.random() > 0.5 ? validUser : invalidUser;

userDecoder
  .decodePromise(json)
  .then(value => {
    console.log(value);
  })
  .catch(error => {
    console.log(error);
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€åŠæ—¶é—´æˆ‘ä»¬ä¼šå¾—åˆ°`{firstName: "Nils", lastName: "Frahm"}`ï¼Œä¸€åŠæ—¶é—´æˆ‘ä»¬ä¼šå¾—åˆ°`<User> decoder failed at key "firstName" with error: null is not a valid string`ã€‚`JsonDecoder`æ©æŠ¤æˆ‘ä»¬ã€‚

## [](#going-down-the-rabbit-hole)ä¸‹å…”å­æ´

æˆ‘ä»¬åˆšåˆšå¼€å§‹äº†è§£è¿™ä¸ªåº“çš„çš®æ¯›ï¼Œä½ èƒ½æƒ³åˆ°çš„æ¯ç§ç±»å‹éƒ½æœ‰è§£ç å™¨ã€‚æ‚¨è¿˜å¯ä»¥è§£ç :

*   æ•°ç»„
*   å­—å…¸
*   é€’å½’æ•°æ®ç»“æ„
*   ç©º
*   ä¸æ˜ç¡®çš„

å’Œå…¶ä»–æ–°å¥‡çš„ä¸œè¥¿ã€‚

å» [GitHub repo](https://github.com/joanllenas/ts.data.json) äº†è§£ä¸€ä¸‹å§ï¼