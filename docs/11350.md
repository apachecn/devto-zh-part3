# å¯¹å…³é”®æ¼æ´çš„å‰–æ

> åŸæ–‡:[https://dev . to/Turner j/the-anatomy-of-a-critical-vulnerability-51fe](https://dev.to/turnerj/the-anatomy-of-a-critical-vulnerability-51fe)

**æ³¨æ„:è¿™ä¸€ç‚¹åœ¨è¢«å‘ç°åç«‹å³è¢«è´Ÿè´£ä»»åœ°æŠ«éœ²ç»™äº† SilverStripeã€‚æˆªè‡³ 2 æœˆ 18 æ—¥ï¼Œsilver stripe(CVE-2019-5715/SS-2018-021)å·²ç»å…¬å¼€æŠ«éœ²äº†[ï¼Œå‘å¸ƒäº†æ‰€æœ‰æ”¯æŒç‰ˆæœ¬çš„è¡¥ä¸ã€‚](https://www.silverstripe.org/download/security-releases/ss-2018-021)**

åœ¨æˆ‘è¿‡å» 7 å¹´å·¥ä½œçš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨ PHP å»ºç«‹ç½‘ç«™ï¼Œç‰¹åˆ«æ˜¯ T2 çš„ SilverStripeã€‚åœ¨æˆ‘ç¦»å¼€ä¹‹å‰ï¼Œç»™åŒäº‹ä»¬çš„æœ€åä¸€ä¸ªå°æƒŠå–œæ˜¯ï¼Œæˆ‘å‘ç°äº† SQL æ³¨å…¥çš„ä¸€ä¸ªæ¼æ´ã€‚

åœ¨è¯¦ç»†ä»‹ç»å®‰å…¨æ¼æ´ä¹‹å‰ï¼Œæˆ‘éœ€è¦è§£é‡Šä¸€ä¸‹ SilverStripeã€‚

## [](#silverstripe)é“¶è‰²æ¡çº¹

SilverStripe æ˜¯ä¸€ä¸ªå¼€æºçš„ PHP å†…å®¹ç®¡ç†ç³»ç»Ÿã€‚åœ¨å®ƒçš„æ ¸å¿ƒï¼Œæœ‰ä¸€ä¸ª`DataObject`ç±»ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰å†™å…¥æ•°æ®åº“çš„ä¸œè¥¿éƒ½ä½¿ç”¨å®ƒã€‚é‚£å°±æ˜¯ä»ä½ çš„`HomePage`ç­åˆ°ä½ çš„`ImageSlide`ç­å†åˆ°ä½ çš„`Member`ç­ã€‚

å…¸å‹çš„`DataObject`å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·(ä¸ºäº†ç®€æ´ï¼Œå»æ‰äº†åç§°ç©ºæ ¼):

```
class MyCustomObject extends DataObject
{
    private $db = [
        'MyProperty' => 'Varchar'
    ];

    private $has_many = [
        'Slides' => ImageSlide::class
    ];
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æ‚¨æ‹¥æœ‰è¿™äº›å¯¹è±¡ä¹‹ä¸€çš„å®ä¾‹æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç¥å¥‡çš„æ–¹æ³•è¯»/å†™`MyProperty`:

```
$myPropertyVal = $myCustomObject->MyProperty;
$slides = $myCustomObject->Slides();

$myCustomObject->MyProperty = 'Hello world!';
$myCustomObject->write(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯è·å–å’Œè®¾ç½®å€¼çš„ä¸»è¦æ–¹å¼ã€‚è¿˜æœ‰å…¶ä»–å¸®åŠ©æ–¹æ³•å¯ä»¥ä»æ•°ç»„ç­‰ä¸­æ‰¹é‡è®¾ç½®è¿™äº›å€¼ã€‚

è¿™å°±æ˜¯ä½ æ‰€éœ€è¦çŸ¥é“çš„ï¼Œæ¥ç†è§£å³å°†åˆ°æ¥çš„é—®é¢˜çš„è¦ç‚¹ã€‚

## [](#discovery)å‘ç°

è™½ç„¶æˆ‘ç¡®å®å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†åœ¨å‘ç°è¿‡ç¨‹ä¸­æœ‰ä¸¤ä»¶é‡è¦çš„äº‹æƒ…éœ€è¦æåŠ:

*   æˆ‘ä»¬çš„ä¸€ä¸ªç«™ç‚¹æ­£åœ¨é€šè¿‡ä¸€ä¸ªè‡ªåŠ¨æ¼æ´æµ‹è¯•ç³»ç»Ÿè¿›è¡Œå®‰å…¨å®¡è®¡ã€‚ä¸€ä¸ªç‰¹å®šå°è¯•çš„é”™è¯¯ç»™æˆ‘æŒ‡å‡ºäº†æ­£ç¡®çš„æ–¹å‘ã€‚
*   å½“æˆ‘å‘ SilverStripe æŠ«éœ²è¿™ä¸€é—®é¢˜æ—¶ï¼Œä»–ä»¬å‘ç°äº†è¿›ä¸€æ­¥æ‰©å±•è¿™ä¸€æ¼æ´çš„é—®é¢˜ã€‚

ç”±è‡ªåŠ¨å®‰å…¨å®¡è®¡è§¦å‘çš„é”™è¯¯ä¸åä¸º [SwipeStripe](https://github.com/swipestripe/silverstripe-swipestripe) çš„ SilverStripe æ¨¡å—æœ‰å…³ï¼Œä½†è¿™ä¸æ˜¯è¯¥æ¨¡å—çš„é”™è¯¯ï¼Œåªæ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æœ€åˆé€šè¿‡è¯¥æ¨¡å—æš´éœ²å‡ºæ¥ã€‚

æœ‰ä¸€ä¸ªå¸¦æœ‰ç‰¹å®š`update`æ–¹æ³•çš„`OrderForm`ç±»ï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å¼€å§‹:

```
public function update(SS_HTTPRequest $request) {
    if ($request->isPOST()) {
        $member = Customer::currentUser() ? Customer::currentUser() : singleton('Customer');
        $order = Cart::get_current_order();
        //Update the Order 
        $order->update($request->postVars());
        $order->updateModifications($request->postVars())
            ->write();
        $form = OrderForm::create(
            $this->controller, 
            'OrderForm'
        )->disableSecurityToken();
        // $form->validate();
        return $form->renderWith('OrderFormCart');
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å¯¹`$order`å¯¹è±¡çš„`update`å‡½æ•°è°ƒç”¨æ˜¯ä¸€ä¸ªå†…ç½®çš„ SilverStripe å‡½æ•°ï¼Œåœ¨è¿™é‡Œä½ ä¼ é€’ä¸€ä¸ªå­—æ®µæ•°ç»„ï¼Œå®ƒä¼šä¸ºä½ è®¾ç½®å®ƒä»¬ã€‚å°† POST å˜é‡ç›´æ¥ä¼ é€’ç»™å®ƒæ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„æƒ³æ³•(æ‚¨åº”è¯¥æ­£ç¡®åœ°æ£€æŸ¥æ‚¨çš„å­—æ®µ),ä½†æ˜¯æˆ‘ç¦»é¢˜äº†ã€‚

SilverStripe é€šå¸¸ä¼šå®‰å…¨åœ°å‡†å¤‡æŸ¥è¯¢ï¼Œæ‰€ä»¥ SQL æ³¨å…¥ä¸ä¼šå‘ç”Ÿï¼Œä½†æœ‰ä¸€ä¸ªè¾¹ç¼˜æƒ…å†µï¼Œå®ƒä¸å·¥ä½œã€‚

äº‹å®è¯æ˜ï¼Œå¦‚æœæ‚¨çš„ POST è¯·æ±‚çœ‹èµ·æ¥ä¸åƒ`SomeProperty=1`è€Œæ›´åƒ`SomeProperty[MySneakySQLStatement]=1`ï¼Œäº‹æƒ…å°±ä¼šå˜å¾—å¥‡æ€ªï¼Œè·³è¿‡å‡†å¤‡å¥½çš„è¯­å¥çš„å·¥ä½œæ–¹å¼ï¼Œå¹¶åœ¨åŸå§‹æŸ¥è¯¢ä¸­ç»“æŸã€‚

è¿™ä¸ªé—®é¢˜å‡ºç°åœ¨è¿™é‡Œæ˜¯å› ä¸º`postVars`å°†`SomeProperty[MySneakySQLStatement]=1`è¿”å›åˆ°ç±»ä¼¼äº
çš„ä¸œè¥¿

```
{  "SomeProperty":  {  "MySneakySQLStatement":  1  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœåœ¨å†…éƒ¨å®ƒçœ‹èµ·æ¥æ›´åƒä¸‹é¢è¿™æ ·ï¼Œå®ƒå¯èƒ½ä¸ä¼šæˆä¸ºä¸€ä¸ªé—®é¢˜:

```
{  "SomeProperty[MySneakySQLStatement]":  1  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè¦çœŸæ­£åˆ©ç”¨æ¼æ´ï¼Œæ¯”ä»…ä»…åœ¨å­—æ®µåä¸­æ·»åŠ  SQL æŸ¥è¯¢ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯æ‚¨å·²ç»æ˜ç™½äº†ã€‚

æˆ‘æŠŠæˆ‘æ‰€çŸ¥é“çš„ä¸€åˆ‡éƒ½äº¤ç»™äº† SilverStripeï¼Œä»–ä»¬ä»é‚£é‡Œæ¥æ‰‹ï¼Œå‘ç°è¿™ä¸ªé—®é¢˜æ¯”çœ‹èµ·æ¥è¦å¤§ä¸€äº›ã€‚

## [](#the-actual-issue)å®é™…å‘è¡Œ

å°±åˆ©ç”¨è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•è€Œè¨€ï¼Œæˆ‘æ²¡æœ‰é”™ï¼Œä½†è¿™ä¸æ˜¯å”¯ä¸€çš„æ–¹æ³•ã€‚äº‹å®è¯æ˜ï¼Œæˆ‘å‰é¢æåˆ°çš„`update`å‡½æ•°å¹¶ä¸æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œè€Œæ˜¯å®ƒæ‰€ä¾èµ–çš„ä»£ç åŸºæœ¬ä¸Šæ”¯æŒæ‰€æœ‰å¯¹æ•°æ®åº“çš„å†™å…¥ã€‚

åœ¨ SilverStripe å…³äºè¿™ä¸ªé—®é¢˜çš„åšå®¢æ–‡ç« ä¸­ï¼Œä»–ä»¬å£°æ˜:

> DataObject ä¸Šçš„ç›´æ¥èµ‹å€¼(update()ã€é€šè¿‡æ–¹æ³•è°ƒç”¨çš„ setterã€é€šè¿‡é­”æœ¯æ–¹æ³•çš„ setter)å’Œé—´æ¥èµ‹å€¼(å¦‚ Form->saveInto())éƒ½ä¼šå—åˆ°å½±å“ã€‚

æ‰€ä»¥ä¸ä»…ä»…æ˜¯æˆ‘æœ€åˆæ³¨æ„åˆ°çš„`update`æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„å†™ä½œæ–¹æ³•éƒ½å—åˆ°äº†å½±å“ï¼è¿™ä¸ª bug åˆšåˆšä»â€œä¸å¥½ï¼Œä½†ä¸å¤ªå¯èƒ½å½±å“å¾ˆå¤šäººâ€å˜æˆäº†â€œå“¦ï¼Œè¿™å¯èƒ½ä¼šå½±å“æ¯ä¸ªäººâ€ã€‚

ä»–ä»¬åœ¨åšå®¢ä¸Šå†™é“:

> è¯¥æ¼æ´ä¸æ”¯æ’‘ DataObject é€»è¾‘çš„ DBField ç±»æœ‰å…³ã€‚SilverStripe 3 ä¸­çš„å¤§å¤šæ•° DBField ç±»å‹éƒ½ä¼šå—åˆ°å½±å“ã€‚åœ¨ SilverStripe 4 ä¸­ï¼Œåªæœ‰ DBYear å­—æ®µç±»å‹è¢«ç¡®è®¤ä¼šå—åˆ°å½±å“ï¼Œè¿™å°†æˆ‘ä»¬å½“å‰å‘å¸ƒç³»åˆ—ä¸­çš„å½±å“é™åˆ¶åœ¨ç›¸å¯¹ä¸å¸¸è§çš„ç”¨ä¾‹ä¸­ã€‚

è™½ç„¶ä»ç„¶æ˜¯ä¸€ä¸ªä¸¥é‡çš„æ¼æ´ï¼Œä½†é€šè¿‡å…¶ä»–ä¿®å¤å’Œæ”¹è¿›ï¼ŒSilverStripe çš„æœ€æ–°ä¸»è¦ç‰ˆæœ¬(ç‰ˆæœ¬ 4)å—åˆ°çš„å½±å“è¾ƒå°ï¼Œè¿™æ˜¯ä¸€ä»¶å¥½äº‹ã€‚

## [](#the-fix)ä¿®ç½—

è¯¥ä¿®å¤å®é™…ä¸Šç›¸å½“å°ï¼Œåˆ†ä¸º 5 ä¸ªæ–‡ä»¶(é’ˆå¯¹ SilverStripe 4)ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ã€‚

è¿™å®é™…ä¸Šç›¸å½“äºé‡å¤æ£€æŸ¥å­—æ®µèµ‹å€¼ä¸æ˜¯æ•°ç»„ã€‚

ä¾‹å¦‚ï¼Œåœ¨`DataObject`ç±»çš„ä¸€éƒ¨åˆ†:

```
// Make sure none of our field assignment are arrays
foreach ($manipulation as $tableManipulation) {
    if (!isset($tableManipulation['fields'])) {
        continue;
    }
    foreach ($tableManipulation['fields'] as $fieldValue) {
        if (is_array($fieldValue)) {
            user_error(
                'DataObject::writeManipulation: parameterised field assignments are disallowed',
                E_USER_ERROR
            );
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#conclusion)ç»“è®º

æ€»æ˜¯ï¼Œæ€»æ˜¯ï¼Œæ€»æ˜¯è´Ÿè´£ä»»åœ°æŠ«éœ²å®‰å…¨é—®é¢˜ã€‚æ„Ÿè°¢ Mattã€Maximeã€Ingo å’Œ SilverStripe çš„æ‰€æœ‰äººæµ‹è¯•å¹¶è§£å†³äº†è¿™ä¸ªæ¼æ´ï¼ğŸ™‚

å¯¹äº SilverStripe ç”¨æˆ·ï¼Œä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ‰€æœ‰å®‰å…¨å‘å¸ƒ[æˆ–è€…åœ¨è¿™é‡Œ](https://www.silverstripe.org/download/security-releases/)æŸ¥çœ‹å®‰å…¨å‘å¸ƒæµç¨‹[ã€‚](http://docs.silverstripe.org/en/contributing/release_process/)