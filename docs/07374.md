# æ„šè ¢è¿è¡Œæ—¶éƒ¨:äº‘ä¸Šè¿è¡Œçš„å¤å¤ Python

> åŸæ–‡:[https://dev . to/Google cloud/Ministry-of-silly-runtimes-vintage-python-on-cloud-3b9d](https://dev.to/googlecloud/ministry-of-silly-runtimes-vintage-python-on-cloud-run-3b9d)

## [](#introducing-cloud-run)å¼•å…¥äº‘è¿è¡Œ

ä»Šå¤©ï¼Œè°·æ­Œå®£å¸ƒæ¨å‡º [Cloud Run](http://cloud.google.com/run) ï¼Œè¿™æ˜¯ä¸€æ¬¾éå¸¸ç®€æ´çš„äº§å“:

1)ä½ å†™ä¸€ä¸ªæœåŠ¡/åº”ç”¨/å‡½æ•°/ä»»ä½•ä¸œè¥¿æ¥ç›‘å¬`$PORT`ä¸Šçš„ HTTP è¯·æ±‚ï¼›
2)ä½ å†™ä¸€ä¸ª`Dockerfile`ä»ä»»ä½•åŸºç¡€é•œåƒç»§æ‰¿ï¼Œå®‰è£…ä»»ä½•å¿…è¦çš„ä¾èµ–ï¼Œå¯åŠ¨ä½ çš„æœåŠ¡ï¼›
3)æ‚¨å°†æ˜ åƒéƒ¨ç½²åˆ°äº‘è¿è¡Œï¼Œå®ƒå¯ä»¥æŒ‰éœ€æ‰©å±•(ç”šè‡³æ‰©å±•åˆ°é›¶)ã€‚

åŸºæœ¬ä¸Šï¼Œå®ƒæ˜¯â€œæ— æœåŠ¡å™¨ Docker å®¹å™¨å³æœåŠ¡â€,è¿™æ­£æ˜¯æˆ‘è®¤ä¸º PaaS/FaaS å¼€å‘ç¤¾åŒºç°åœ¨å¯ä»¥ä½¿ç”¨çš„ï¼ŒåŸå› å¦‚ä¸‹:

**æœ€æƒ¯ç”¨çš„è¿è¡Œæ—¶å¯èƒ½**
è¿™é‡Œæ²¡æœ‰ç‰¹å®šäºä¾›åº”å•†çš„æ€ªå¼‚ä¹‹å¤„ã€‚çœŸçš„ï¼Œæ²¡æœ‰æ¯”ä½¿ç”¨`FROM python:3.7`æˆ–è€…ä»»ä½•ä½ æƒ³ä½¿ç”¨çš„å…¶ä»–åŸºæœ¬å›¾åƒæ›´ä¹ æƒ¯çš„äº†ã€‚

**æ— éœ€ä¸ºé—²ç½®è™šæ‹Ÿæœºä»˜è´¹çš„å¯å®šåˆ¶æ€§**
å¦‚æœæ‚¨çš„ç‰¹å®šå·¥ä½œè´Ÿè½½ä¸ç¬¦åˆé€šå¸¸æä¾›çš„æœ€â€œå¸¸è§â€è¿è¡Œæ—¶çš„èŒƒå›´ï¼Œé‚£ä¹ˆåœ¨æ­¤ä¹‹å‰ï¼Œæ‚¨çš„æœ€ä½³é€‰æ‹©æ˜¯å¯åŠ¨ä¸€ä¸ªå®šåˆ¶è™šæ‹Ÿæœºï¼Œè¯¥è™šæ‹Ÿæœºä¸ä¼šæ‰©å±•åˆ°é›¶ï¼Œå¹¶ä¸”ä¼šèŠ±è´¹å¤§é‡æ—¶é—´å¤„äºé—²ç½®çŠ¶æ€ã€‚æœ‰äº† Cloud Runï¼Œä½ å¯ä»¥ä½¿ç”¨`Dockerfile`éšå¿ƒæ‰€æ¬²åœ°å®šåˆ¶ä½ çš„è¿è¡Œæ—¶ã€‚

**å®¹å™¨åŒ–æ„å‘³ç€å¯ç§»æ¤æ€§**
ç”¨æ ‡å‡†å®šä¹‰ä½ çš„è¿è¡Œæ—¶`Dockerfile`æ„å‘³ç€ä½ å¯ä»¥æŠŠå®ƒå¸¦åˆ°ä»»ä½•åœ°æ–¹â€”â€”*ç”šè‡³æœ¬åœ°*â€”â€”è¿™æ„å‘³ç€ä½ ä¸ä¼šè¢«æŸä¸ªç‰¹å®šçš„ä¾›åº”å•†æ‰€æŸç¼šï¼Œä½ çš„åº”ç”¨ç¨‹åºçš„æœ¬åœ°å¼€å‘æ˜¯å†…ç½®çš„ï¼Œä¸éœ€è¦åšä»»ä½•ç‰¹æ®Šçš„äº‹æƒ…ã€‚

è¿™äº›éƒ½å¾ˆæ£’ï¼Œå®ƒä»¬è‚¯å®šä¼šå¸®åŠ©å¼€å‘äººå‘˜åšä¼Ÿå¤§çš„äº‹æƒ…...

...ä½†æ˜¯å¦‚æœä½ æƒ³ç”¨å®ƒåšä¸€äº›çœŸæ­£æ„šè ¢çš„äº‹æƒ…å‘¢ï¼Ÿ

## [](#introducing-the-first-python-1x-serverless-runtime)æ¨å‡ºé¦–ä¸ª Python 1.x æ— æœåŠ¡å™¨è¿è¡Œæ—¶

å½“æˆ‘ç¬¬ä¸€æ¬¡å¼€å§‹ç© Cloud Run æ—¶ï¼Œæˆ‘çœŸçš„æƒ³æµ‹è¯•ä¸€ä¸‹æˆ‘å¯ä»¥ç”¨å®ƒåšä»€ä¹ˆçš„æé™ã€‚æˆ‘çœŸçš„å¯ä»¥è¿è¡Œæˆ‘æƒ³è¦çš„ä»»ä½•è¿è¡Œæ—¶å—ï¼Ÿæˆ‘å¯ä»¥è¿è¡Œä¸€ä¸ªè¶…ç°ä»£çš„ Python 3.8.0a3 alpha ç‰ˆæœ¬å—ï¼Ÿ(æ˜¯)ã€‚é‚£ä¹ˆï¼ŒPython çš„â€œå¤å¤â€ç‰ˆæœ¬æ€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘å¯ä»¥å°†è¿è¡Œåœ¨ Python 1.x ä¸Šçš„â€œHello Worldâ€åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Cloud run å—ï¼ŸğŸ¤”

#### [](#searching-for-vintage-images)æœç´¢â€œå¤å¤â€å›¾ç‰‡

ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä¸º Python 1.x æ‰¾åˆ°ä¸€ä¸ªåŸºç¡€å›¾åƒã€‚å®˜æ–¹ Python Docker images åªå‘å¸ƒ 2.7 åŠä»¥ä¸Šç‰ˆæœ¬çš„å›¾åƒï¼Œæ‰€ä»¥è¿æ°”ä¸å¥½ã€‚æˆ‘åœ¨å…¶ä»–åœ°æ–¹æ‰¾ä¸åˆ°å®ƒï¼Œæ‰€ä»¥çœ‹èµ·æ¥æˆ‘ä¸å¾—ä¸è‡ªå·±ä»å¤´å¼€å§‹æ„å»ºåŸºç¡€æ˜ åƒã€‚

#### [](#searching-for-vintage-source)æœç´¢â€œå¹´ä»½â€æ¥æº

ä»å¤´æ„å»ºåŸºç¡€æ˜ åƒæ„å‘³ç€æˆ‘å¿…é¡»:

a)æ‰¾åˆ° Python 1.x ç‰ˆæœ¬çš„æ—§æºä»£ç ï¼›b)è®©å®ƒåœ¨ç°ä»£å‘è¡Œç‰ˆçš„åŸºç¡€æ˜ åƒä¸Šç¼–è¯‘ï¼›å‘å¸ƒè¿™ä¸ªæ–°çš„åŸºç¡€æ˜ åƒã€‚

æ‰¾åˆ°æºå¤´æœ‰ç‚¹å›°éš¾ã€‚ç°ä»£ Python ç‰ˆæœ¬çš„æºä»£ç å‘è¡¨åœ¨[https://www.python.org/downloads/source/](https://www.python.org/downloads/source/)ä¸Šï¼Œä½†è¿™åªèƒ½è¿½æº¯åˆ° 2001 å¹´ 6 æœˆ 22 æ—¥å‘å¸ƒçš„ Python 2.0.1ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘æ‰¾åˆ°äº†[https://legacy.python.org/download/releases/src/](https://legacy.python.org/download/releases/src/)ï¼Œå…¶ä¸­åŒ…å«äº†è¿œè‡³ Python 1.0.1 çš„æºä»£ç ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å‘å¸ƒäº 25 å¹´å‰çš„ 1994 å¹´ 2 æœˆ 15 æ—¥ã€‚

æˆ‘å†³å®šå°è¯•ä»¥æœ€æ–°çš„ Ubuntu å‘è¡Œç‰ˆä¸ºç›®æ ‡ï¼Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œåªéœ€ä¸€äº›å°è¡¥ä¸ï¼Œæˆ‘å°±èƒ½è®© Python 1.0.1ã€1.1ã€1.2 å’Œ 1.3 åœ¨ Ubuntu 18.04 ä¸‹ç¼–è¯‘ã€‚

#### [](#publishing-some-vintage-images)å‘å¸ƒä¸€äº›â€œè€å¤è‘£â€å›¾ç‰‡

æˆ‘åœ¨ [`vintage-python`](https://hub.docker.com/r/dustingram/vintage-python) åº“ä¸‹å‘å¸ƒäº†è¿™äº›ç»“æœæ„å»ºçš„ Docker å›¾åƒï¼Œæ‰€ä»¥è¿™æ„å‘³ç€ä½ ç°åœ¨å¯ä»¥éšæ—¶å¯åŠ¨ä¸€ä¸ªè€å¼çš„ Python REPL:

```
$ docker run -it dustingram/vintage-python:1.0.1
Python 1.0.1 (Feb 23 2019)
Copyright 1991-1994 Stichting Mathematisch Centrum, Amsterdam
>>> print "Hello world!"
Hello world! 
```

è¿™ä¹Ÿæ„å‘³ç€æˆ‘å¯ä»¥åœ¨æˆ‘çš„`Dockerfile`ä¸­åš`FROM dustingram/vintage-python:1.0.1`ï¼Œè¿™æ˜¯å‘æ‹¥æœ‰æˆ‘æ„šè ¢çš„è¿è¡Œæ—¶è¿ˆå‡ºçš„ä¸€å¤§æ­¥ã€‚

#### [](#searching-for-an-http-server)æœç´¢ HTTP æœåŠ¡å™¨

æˆ‘ä¸€å¿ƒæƒ³è¦ Python 1.0.1ï¼Œä½†æ˜¯åœ¨æ„è¯†åˆ° Python ç›´åˆ° Python 1.3 æ‰é™„å¸¦ HTTP æœåŠ¡å™¨ä¹‹åï¼Œæˆ‘å†³å®šä½¿ç”¨å®ƒï¼Œè€Œä¸æ˜¯è¯•å›¾å°† HTTP æœåŠ¡å™¨ç§»æ¤åˆ°æ—§ç‰ˆæœ¬ã€‚

åœ¨ Python 1.3 ä¸­ï¼Œæˆ‘å¯ä»¥è¿™æ ·å†™:

```
import sys
from BaseHTTPServer import HTTPServer
from SimpleHTTPServer import SimpleHTTPRequestHandler

class MyHandler(SimpleHTTPRequestHandler):
    protocol_version = "HTTP/1.1"

    def do_GET(self):
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()
        self.wfile.write("Hello from Python " + sys.version)

if __name__ == '__main__':
    print('Running...')
    HTTPServer(('0.0.0.0', 8080), MyHandler).serve_forever() 
```

è¿™å°†åœ¨ç«¯å£ 8080 ä¸Šè®¾ç½®ä¸€ä¸ªåŸºæœ¬çš„ HTTP/1.1 æœåŠ¡å™¨ï¼Œç”¨ç»™å®šçš„æ¶ˆæ¯å“åº”æ¯ä¸ªè¯·æ±‚ã€‚æˆ‘*çœŸçš„*æƒ³è¦è¯æ˜è¿™æ˜¯ä¸€ä¸ªæœåŠ¡äºè¯·æ±‚çš„ Python çš„ç»å…¸ç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘åœ¨å“åº”ä¸­åŒ…å«äº†`sys.version`ã€‚

#### [](#containerizing-some-vintage-python)å°†ä¸€äº›å¤å¤èŸ’è›‡è£…ç®±

åœ¨å°†å…¶ä¿å­˜ä¸º`app.py`ä¹‹åï¼Œå‰©ä¸‹è¦åšçš„å°±æ˜¯å†™å…¥`Dockerfile`ã€‚å› ä¸ºæˆ‘çš„åº”ç”¨ç¨‹åºæ²¡æœ‰ä»»ä½•ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥äº‘è¿è¡Œå¿«é€Ÿå…¥é—¨ä¸­çš„`Dockerfile`éå¸¸æ¥è¿‘[çš„`Dockerfile`](https://cloud.google.com/run/docs/quickstarts/build-and-deploy)

```
FROM dustingram/vintage-python:1.3

# Copy local code to the container image.
ENV APP_HOME /app
WORKDIR $APP_HOME
COPY . .

# Service must listen to $PORT environment variable.
# This default value facilitates local development.
ENV PORT 8080

# Run the web service on container startup.
CMD ["python", "app.py"] 
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»æˆ‘çš„ vintage Python æ˜ åƒç»§æ‰¿ï¼Œå°†æˆ‘çš„`app.py`å¤åˆ¶åˆ°å®¹å™¨ä¸­ï¼Œè®¾ç½®`PORT`ç¯å¢ƒå˜é‡(ç”¨äºæœ¬åœ°å¼€å‘)ï¼Œç„¶åé€šè¿‡è¿è¡Œ`python app.py`å¯åŠ¨æœåŠ¡å™¨ã€‚

#### [](#deploying-some-vintage-python)éƒ¨ç½²ä¸€äº›è€å¼èŸ’è›‡

å¯¹äºäº‘è¿è¡Œï¼Œæœ‰ä¸€ä¸ªä¸¤æ­¥éƒ¨ç½²:

ä½¿ç”¨äº‘æ„å»ºæ„å»ºå¹¶æäº¤æ‚¨çš„æ˜ åƒ:

```
$ gcloud builds submit --tag gcr.io/my_project_id/helloworld 
```

ç„¶åï¼Œå°†æäº¤çš„æ˜ åƒéƒ¨ç½²åˆ°äº‘è¿è¡Œ:

```
$ gcloud beta run deploy --image gcr.io/my_project_id/helloworld 
```

ç„¶åå°±å±•å¼€äº†ï¼

è¯·çœ‹è¿™é‡Œ:[https://helloworld-bpzdnjbrsq-uc.a.run.app/](https://helloworld-bpzdnjbrsq-uc.a.run.app/)

## [](#conclusion)ç»“è®º

Cloud Run ç»å¯¹è¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥è¿è¡Œæˆ‘å¯ä»¥ä½¿ç”¨çš„ä»»ä½•è¿è¡Œæ—¶â€”â€”ç”šè‡³æ˜¯ Python æœ€å¤è€çš„ç‰ˆæœ¬ä¹‹ä¸€ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä¸ä¼šé¼“åŠ±ä»»ä½•äººåœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ Python 1.x:ä»»ä½•è¶…è¿‡å…¶ EOL çš„ç‰ˆæœ¬æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸å¯ç»´æŠ¤çš„ï¼Œå¹¶ä¸”åŠŸèƒ½ä¸¥é‡å—é™ã€‚

ä»è¿™é‡Œï¼Œæ‚¨å¯ä»¥:

*   å…³äºè¿è¡Œæ—¶çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§[`vintage-python`Github repo](https://github.com/di/vintage-python)ï¼›
*   åœ¨ä½ è‡ªå·±æ„šè ¢çš„é¡¹ç›®ä¸­ä½¿ç”¨ [`vintage-python`å›¾ç‰‡](https://hub.docker.com/r/dustingram/vintage-python)ï¼›
*   å‚è§[äº‘è¿è¡Œå¿«é€Ÿå…¥é—¨](https://cloud.google.com/run/docs/quickstarts/build-and-deploy)ï¼›
*   åœ¨ Twitter ä¸Šå…³æ³¨æˆ‘ã€‚