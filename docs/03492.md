# ç¦»å¼€ä¸»çº¿ç¨‹æ¸²æŸ“ä½ çš„å›¾å½¢

> åŸæ–‡:[https://dev . to/ya shints/off screen canvas-render-your-graphics-off-the-main-thread-1732](https://dev.to/yashints/offscreencanvas-render-your-graphics-off-the-main-thread-1732)

åœ¨ç½‘é¡µä¸Šæ¸²æŸ“å›¾åƒå¯èƒ½æ˜¯ä¸€é¡¹è®¡ç®—é‡éå¸¸å¤§çš„æ“ä½œã€‚è¿™ä½¿å¾—åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œè¿™ç±»æ“ä½œæ›´åŠ å›°éš¾ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šé™ä½æ¸²æŸ“é€Ÿåº¦æˆ–å½±å“ç”¨æˆ·ä½“éªŒã€‚

# [](#background)èƒŒæ™¯

[Canvas](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/canvas) åœ¨æˆ‘çœ‹æ¥æ˜¯æœ€æœ‰è¶£çš„ HTML å…ƒç´ ä¹‹ä¸€ã€‚ä½¿ç”¨å®ƒæœ€æ™®éçš„åŸå› æ˜¯ç»˜åˆ¶å›¾å½¢æˆ–åŠ¨ç”»ã€‚

æ¥è‡ªè°·æ­Œå¼€å‘è€…ç½‘ç«™:

> å®ƒé€šå¸¸ç”¨äºåœ¨å¯Œåª’ä½“ web åº”ç”¨ç¨‹åºå’Œåœ¨çº¿æ¸¸æˆä¸­åˆ›å»ºæ¼‚äº®çš„ç”¨æˆ·ä½“éªŒã€‚

äº‹å®ä¸Šï¼Œæ‚¨å¯ä»¥ç¼–å†™è„šæœ¬ï¼Œæé«˜äº†æ ‡å‡†ï¼Œä½¿å…ƒç´ æ›´åŠ æœ‰è¶£ã€‚è¿™åœ¨å¾ˆå¤šæƒ…å†µä¸‹ç»™äº†ä½ å¾ˆå¤§çš„çµæ´»æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬ä»Šå¤©ä¸»è¦å…³æ³¨åŠ¨ç”»æˆ–è€…æ¸²æŸ“ã€‚

# [](#problem)é—®é¢˜

åŒæ—¶ï¼Œæ‰§è¡Œ JavaScript æ˜¯ç”¨æˆ·ä½“éªŒé—®é¢˜æœ€å¸¸è§çš„æ¥æºä¹‹ä¸€ã€‚å› ä¸ºæ‰€æœ‰çš„ JavaScript ä»£ç [éƒ½åœ¨ä¸ç”¨æˆ·äº¤äº’ç›¸åŒçš„çº¿ç¨‹](https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop)ä¸Šè¿è¡Œï¼Œè¿™äº›ç¹é‡çš„è®¡ç®—æ“ä½œé™¤äº†å½±å“å®é™…å’Œæ„ŸçŸ¥çš„æ€§èƒ½ä¹‹å¤–ï¼Œè¿˜ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚

# [](#example)ä¸¾ä¾‹

ä¸ºäº†ç»™ä½ ä¸€ä¸ªä½¿ç”¨ canvas æœ‰å¤šç®€å•çš„ä¾‹å­ï¼Œè€ƒè™‘ä¸‹é¢çš„ä»£ç :

```
<canvas id="canvas" width="300" height="300">
  An alternative text describing what your canvas
  displays.
</canvas> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ‚¨çš„ JavaScript æ–‡ä»¶ä¸­:

```
var mainCanvas = document.getElementById(
  'myCanvas'
)
var mainContext = mainCanvas.getContext('2d')

var canvasWidth = mainCanvas.width
var canvasHeight = mainCanvas.height

var angle = 0

var requestAnimationFrame =
  window.requestAnimationFrame ||
  window.mozRequestAnimationFrame ||
  window.webkitRequestAnimationFrame ||
  window.msRequestAnimationFrame

function drawCircle() {
  mainContext.clearRect(
    0,
    0,
    canvasWidth,
    canvasHeight
  )

  // color in the background
  mainContext.fillStyle = '#EEEEEE'
  mainContext.fillRect(
    0,
    0,
    canvasWidth,
    canvasHeight
  )

  // draw the circle
  mainContext.beginPath()

  var radius =
    25 + 150 * Math.abs(Math.cos(angle))
  mainContext.arc(
    225,
    225,
    radius,
    0,
    Math.PI * 2,
    false
  )
  mainContext.closePath()

  // color in the circle
  mainContext.fillStyle = '#006699'
  mainContext.fill()

  angle += Math.PI / 64

  requestAnimationFrame(drawCircle)
}

drawCircle() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

[https://codepen.io/yashints/embed/wbWppN?height=600&default-tab=result&embed-version=2](https://codepen.io/yashints/embed/wbWppN?height=600&default-tab=result&embed-version=2)

ç°åœ¨è®©æˆ‘ä»¬ç»™è¿™æ®µä»£ç æ·»åŠ ä¸€ç‚¹å˜åŒ–ã€‚è®©æˆ‘ä»¬åœ¨åŠ¨ç”»è¿è¡Œçš„åŒæ—¶è¿è¡Œä¸€äº›ä»£ç ã€‚æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæŒ‰é’®å’Œä¸€ä¸ªè°ƒç”¨å‡½æ•°æ¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å¤„ç†ç¨‹åºğŸ¤·â€â™‚ï¸.æ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹æ·»åŠ æŒ‰é’®:

```
<button type="button" id="make-busy">
  Hit the main thread!
</button> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬ç”¨é€’å½’å‡½æ•°å®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—ã€‚ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨`requestAnimationFrame`æ¥ç¡®ä¿è¿™æ®µä»£ç åœ¨ä¸‹ä¸€æ¬¡å¯ç”¨çš„é‡ç”»ä¸­è¿è¡Œã€‚è¦äº†è§£æ›´å¤šå…³äº`requestAnimationFrame`çš„ä¿¡æ¯ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹[çš„æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame)ã€‚

```
function fibonacci(num) {
  if (num <= 1) return 1

  return fibonacci(num - 1) + fibonacci(num - 2)
}

document
  .querySelector('#make-busy')
  .addEventListener('click', () => {
    document.querySelector('#busy').innerText =
      'Main thread working...'
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        fibonacci(40)
        document.querySelector(
          '#busy'
        ).innerText = 'Done!'
      })
    })
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨å¦‚æœä½ ç‚¹å‡»æŒ‰é’®ï¼Œä½ ä¼šçœ‹åˆ°åŠ¨ç”»ä¼šåœ¨è°ƒç”¨`fibonacci`å‡½æ•°è¿”å›ååœæ­¢å¹¶æ¢å¤ã€‚

[https://codepen.io/yashints/embed/QREBrx/?height=600&default-tab=result&embed-version=2](https://codepen.io/yashints/embed/QREBrx/?height=600&default-tab=result&embed-version=2)

æ‚¨å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œå¦‚æœç”¨æˆ·åœ¨æ‚¨çš„ web åº”ç”¨ç¨‹åºä¸­é¢ä¸´ç±»ä¼¼çš„æƒ…å†µï¼Œä»–ä»¬ä¼šæœ‰ä»€ä¹ˆæ ·çš„æ„Ÿå—ã€‚è¿™æ­£æ˜¯`OffscreenCanvas`å¯ä»¥å¸®å¿™çš„æ—¶å€™ã€‚

# [](#offscreencanvas)å±å¹•å¤–ç”»å¸ƒ

ç›´åˆ°æœ€è¿‘ï¼Œcanvas çš„ç»˜å›¾åŠŸèƒ½ç›´æ¥ä¾èµ–äº`<canvas>`å…ƒç´ ï¼Œè¿™æ„å‘³ç€å®ƒå°†ä¾èµ–äº DOM(æ–‡æ¡£å¯¹è±¡æ¨¡å‹)ã€‚`OffscreenCanvas`å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡å°† DOM å’Œ Canvas API çš„æ“ä½œç§»å‡ºå±å¹•ï¼Œå°†å®ƒä»¬è§£è€¦ã€‚

æ›´æœ‰è¶£çš„æ˜¯ï¼Œç”±äºå‰é¢æåˆ°çš„åˆ†ç¦»ï¼Œæ¸²æŸ“æ“ä½œç°åœ¨å¯ä»¥åœ¨ worker å†…éƒ¨è¿è¡Œã€‚ä»…æ­¤ä¸€ç‚¹å°±ä¸ºå„ç§æ€§èƒ½æ”¹è¿›æ‰“å¼€äº†å¯èƒ½æ€§ä¹‹é—¨ã€‚

## [](#using-it-in-a-worker)åœ¨å·¥äººä¸­ä½¿ç”¨å®ƒ

ç½‘ç»œå·¥ä½œè€…æ˜¯ç½‘ç»œç‰ˆçš„å¤šçº¿ç¨‹ã€‚å®ƒä»¬å…è®¸ä½ åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œä»£ç /ä»»åŠ¡(åˆååå°ğŸ˜).æ—¢ç„¶ DOM å’Œ Canvas API ä¹‹é—´çš„è§£è€¦å·²ç»å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ worker å†…éƒ¨è¿è¡Œå®ƒäº†ã€‚

é€šè¿‡æ‰©å±•æˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ç›¸åŒåŠ¨ç”»çš„å¦ä¸€ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘ä»¬å°†åœ¨ web worker çš„`OffscreenCanvas`ä¸­è¿›è¡Œæ¸²æŸ“ã€‚

æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªè„šæœ¬(æˆ‘å·²ç»å‘½åä¸º`animation.js`)ä¸­è®¾ç½®æˆ‘ä»¬çš„å·¥äººä»£ç ï¼Œä»¥ä¾¿ä»¥åä½¿ç”¨ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†åŠ¨ç”»ä»£ç ç§»åŠ¨åˆ°å®ƒè‡ªå·±çš„æ–‡ä»¶ä¸­ã€‚ç„¶åè®©æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„å·¥äººä»£ç :

```
let animationWorker = null
self.onmessage = function(e) {
  switch (e.data.msg) {
    case 'start':
      if (!animationWorker) {
        importScripts(
          e.data.origin + '/animation.js'
        )
        animationWorker = new ThemedAnimation(
          e.data.canvas.getContext('2d')
        )
      }
      animationWorker.start()
      break
    case 'stop':
      if (!animationWorker) {
        return
      }
      animationWorker.stop()
      break
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ï¼Œä½ å¯ä»¥å¹¶æ’åˆ›å»ºä¸¤ä¸ªç”»å¸ƒå…ƒç´ :

```
<main>
  <section class="support">
    Your browser does not support OffscreenCanvas.
  </section>
  <div>
    <h1>Canvas on main thread</h1>
    <p>
      Interaction is blocked when a theme is
      loading
    </p>
    <canvas
      id="canvas-window"
      width="400"
      height="400"
    ></canvas>
  </div>
  <div>
    <h1>Canvas on worker thread</h1>
    <p>
      Interaction works even if a theme is loading
    </p>
    <canvas
      id="canvas-worker"
      width="400"
      height="400"
    ></canvas>
  </div>
</main> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œä»ä¸Šé¢çš„è„šæœ¬æ ‡ç­¾ä¸­åˆ›å»º workerï¼Œè¯·æ±‚ä¸€ä¸ªåŠ¨ç”»å¸§(æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨äº†`setTimeOut`),å¹¶åŒæ—¶åœ¨ä¸¤ä¸ªç”»å¸ƒä¸­è¿è¡ŒåŠ¨ç”»ã€‚

```
document
  .querySelector('main')
  .classList.toggle(
    'supported',
    'OffscreenCanvas' in window
  )
document
  .querySelector('#make-busy')
  .addEventListener('click', () => {
    document.querySelector('#busy').innerText =
      'Main thread working...'
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        Animation.fibonacci(40)
        document.querySelector(
          '#busy'
        ).innerText = 'Done!'
      })
    })
  })

const canvas = document.querySelector('#case1')
const animationWindow = new Animation(
  document
    .querySelector('#canvas-window')
    .getContext('2d')
)
animationWindow.start()
const workerCode = document.querySelector(
  '#workerCode'
).textContent
const blob = new Blob([workerCode], {
  type: 'text/javascript',
})
const url = URL.createObjectURL(blob)
const worker = new Worker(url)
const offscreen = document
  .querySelector('#canvas-worker')
  .transferControlToOffscreen()
const urlParts = location.href.split('/')
if (urlParts[urlParts.length - 1].indexOf('.') !== -1) {
  urlParts.pop()
}
worker.postMessage(
  {
    msg: 'start',
    origin: urlParts.join('/'),
    canvas: offscreen,
  },
  [offscreen]
)
URL.revokeObjectURL(url) // cleanup 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬çœ‹çœ‹è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æ£€æµ‹è¿™ä¸ªç‰¹æ€§(OffscreenCanvas è¿˜ä¸å®Œå…¨æ”¯æŒ)ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºæŒ‰é’®æŒ‚æ¥ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼Œç»™ä¸»çº¿ç¨‹å¢åŠ ä¸€äº›è´Ÿè½½ã€‚è¿™å°†ç»™æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­çš„åŠ¨ç”»æ¸²æŸ“å¸¦æ¥ä¸€äº›å‹åŠ›ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°ç”»å¸ƒå¹¶åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡ŒåŠ¨ç”»ä»£ç ï¼Œä¹‹åï¼Œæˆ‘ä»¬åœ¨ worker ä¸­åšåŒæ ·çš„äº‹æƒ…ã€‚é™¤äº†æˆ‘ä»¬å¿…é¡»å‘æˆ‘ä»¬çš„å·¥äººå‘é€ä¸€ä¸ªæ¶ˆæ¯æ¥å¼€å§‹(æ³¨æ„å·¥äººä»£ç ä¸­çš„å¼€å…³æƒ…å†µ)ã€‚

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œç¡®ä¿ä¸è¦é”™è¿‡ä»£ç ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå³åœ¨ç”»å¸ƒä¸Šè°ƒç”¨`transferControlToOffscreen`ã€‚è¿™å°±æ˜¯`OffscreenCanvas`çš„ç¥å¥‡ä¹‹å¤„ã€‚è¯¥æ–¹æ³•å°†æˆ‘ä»¬çš„å¸¸è§„ canvas è½¬æ¢ä¸º OffscreenCanvas å®ä¾‹ã€‚

å‡ºäºæŸç§åŸå› ï¼Œæˆ‘ä¸èƒ½åœ¨è¿™é‡ŒåµŒå…¥ä¸€ä¸ª`iframe`ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨æˆ‘çš„åšå®¢ä¸Šçœ‹åˆ°[çš„ç»“æœã€‚](https://yashints.dev/blog/2019/05/11/offscreen-canvas)

åªæ˜¯åœ¨è¿™é‡Œå¢åŠ äº†ä¸€ä¸ªæˆªå›¾ğŸ˜Šã€‚

[![OffscreenCanvas demo](../Images/818ca48d52dc8ed94da6d4ad81bfe072.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fjMb5Rdy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/tclrt44gs320lj9g8jvb.JPG)

# [](#summary)æ€»ç»“

æˆ‘ä»¬çœ‹åˆ°äº†ä½¿ç”¨`OffscreenCanvas`ä¸åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œç›¸åŒç¨‹åºç›¸æ¯”ï¼Œåœ¨æ¸²æŸ“å¹³æ»‘åº¦ä¸Šçš„å·®å¼‚ã€‚è¿™ä¸ªæƒŠäººçš„ç‰¹æ€§å¯ä»¥å’Œæˆ‘ä¹‹å‰åœ¨å‘å¸ƒçš„å…³äºç½‘ç»œæ€§èƒ½çš„æ–‡ç« ä¸­çš„å…¶ä»–æŠ€æœ¯ä¸€èµ·ä½¿ç”¨ï¼Œå¸®åŠ©ä½ æ‹¥æœ‰ä¸€ä¸ªæ›´å¿«çš„ç½‘ç«™å’Œæ›´å¿«ä¹çš„ç”¨æˆ·ğŸ˜Šã€‚