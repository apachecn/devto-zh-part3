# JS é£æ ¼çš„ LexingğŸ˜

> åŸæ–‡:[https://dev.to/areknawo/lexing-in-js-style-b5e](https://dev.to/areknawo/lexing-in-js-style--b5e)

**è¿™ç¯‡æ–‡ç« æ‘˜è‡ª[æˆ‘çš„åšå®¢](https://areknawo.com)ï¼Œæ‰€ä»¥è¯·åŠ¡å¿…æŸ¥çœ‹æ›´å¤šæœ€æ–°å†…å®¹ğŸ˜‰**

è¿™ç¯‡æ–‡ç« æ˜¯ AIM é¡¹ç›®ç³»åˆ—æ–‡ç« çš„å»¶ç»­ï¼Œæ‰€ä»¥å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯»è¿‡,[ä»¥å‰çš„æ–‡ç« ,](https://areknawo.com/tag/aim),æˆ‘ä¼šç»™ä½ ä¸€äº›ç­”æ¡ˆã€‚å’Œ*ä¸ºä»€ä¹ˆï¼Ÿ*æé—®ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæ˜¯æ—¶å€™çœŸæ­£å¼€å§‹ç¼–å†™ AIM è¯­è¨€äº†ï¼æˆ‘å°†ä»åˆ›å»ºä¸€ä¸ª **lexer** å¼€å§‹ã€‚ä¸€ä¸ª**è¯æ³•åˆ†æå™¨**ï¼Œæˆ–è€…å¦‚æœä½ ä¸å–œæ¬¢é…·åå­—- **è®°å·èµ‹äºˆå™¨**ï¼Œæ˜¯ä¸€ä¸ªå°†äººç±»å¯è¯»æ–‡æœ¬è½¬æ¢æˆä¸€ç³»åˆ—**è®°å·**çš„å·¥å…·ï¼Œç”¨äºä»¥åçš„å¤„ç†ã€‚å®ƒè¢«ç”¨äºåˆ›å»ºç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿç”¨äºæ–‡æœ¬å¤„ç†å’Œå…¶ä»–å„ç§äº‹æƒ…ã€‚æ‰€ä»¥ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ä»…ä»…é€‚ç”¨äºåˆ›å»ºç¼–ç¨‹è¯­è¨€ã€‚ç°åœ¨ï¼Œçœ‹çœ‹è¿™é‡Œçš„ä¾‹å­:

```
"128 + 428" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŸºæœ¬çš„ï¼Œè¶…çº§ç®€å•çš„ä¸¤ä¸ªæ•°ç›¸åŠ ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†å®ƒå˜æˆ**ä»¤ç‰Œ** :
çš„å½¢å¼

```
["128", "+", "428"] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¤ç‰Œä¸ä¸€å®šåªæœ‰å­—ç¬¦ä¸²ã€‚è¿™äº›å¯ä»¥æ˜¯ä¾‹å¦‚åŒ…å«é™„åŠ çš„**å…ƒæ•°æ®**çš„**å¯¹è±¡**ä»¥ä¾›ä»¥åä½¿ç”¨ã€‚æœ¬æ•™ç¨‹å°†å±•ç¤ºå¦‚ä½•å®ç°ä¸€ä¸ªåŸºæœ¬çš„ lexer æ¥ä»ä¸Šé¢çš„ä¸€ç§å½¢å¼è½¬æ¢åˆ°å¦ä¸€ç§å½¢å¼ã€‚

# [](#tooling)å·¥è£…

è‡ªç„¶ï¼Œæœ‰å¾ˆå¤šå›¾ä¹¦é¦†å’Œå…¶ä»–æ›´å¤§çš„åˆ›ä½œæ¥å¤„ç†è¿™ç±»äº‹æƒ…ã€‚æœ€å—æ¬¢è¿çš„åŒ…æ‹¬ **moo** å’Œ **lex** ã€‚ç”šè‡³æœ‰å®Œæ•´çš„å·¥å…·åŒ…æ¥å¸®åŠ©ä½ åˆ›å»º**è¯æ³•åˆ†æå™¨å’Œè§£æå™¨**ï¼Œä¾‹å¦‚ **nearley** å’Œ **jison** ã€‚æ­¤å¤–ï¼Œå¯¹äºè¯¥é¢†åŸŸå…¶ä»–æ›´ä¸“ä¸šçš„è¯­è¨€(å¦‚ C/C++)æ¥è¯´ï¼Œè¿™äº›åˆ—è¡¨å¯èƒ½ä¼šé•¿å¾—å¤šï¼Œä½†è¿™æ¬¡æ˜¯ JavaScriptï¼Œæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´æ˜¯ TypeScriptã€‚ğŸ˜€åˆ©ç”¨è¿™äº›ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“å¾ˆå¿«åœ°å®Œæˆå·¥ä½œã€‚ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯æœ¬æ•™ç¨‹å’Œæ•´ä¸ª AIM é¡¹ç›®çš„ç›®çš„ï¼Œåªæ˜¯ä½¿ç”¨ä¸åŒçš„åº“ã€‚ä¸ï¼Œè¿™å°†ä»**å¼€å§‹è‡ªåŠ¨æ‰§è¡Œ**ã€‚ç°åœ¨-è®©æˆ‘ä»¬å¼€å§‹å§ï¼

# [](#definition)å®šä¹‰

è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„**è¯æ³•åˆ†æå™¨**åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­ã€‚
**åº”è¯¥æ˜¯**:

*   ä»¥å¯ç§»æ¤å’Œå¯æ‰©å±•çš„å½¢å¼å®ç°æ‰€æœ‰çš„ç›®æ ‡è¯­æ³•ï¼›
*   é€ä¸ªæ ‡è®°åœ°æ¸è¿›æ‰«æç»™å®šæ–‡æœ¬ï¼›
*   æœ‰è¿­ä»£å¤„ç†è¿‡çš„ä»¤ç‰Œçš„å¥½æ–¹æ³•ï¼›
*   æä¾›ä»¤ç‰ŒåŠå…¶åˆ—è¡¨çš„åŸºæœ¬ç‰ˆæœ¬çš„æ–¹æ³•ã€‚

è¿™æ˜¯éå¸¸åŸºæœ¬çš„ä¸œè¥¿â€”â€”æ‚¨åº”è¯¥ä»æ­£ç¡®æ„å»ºçš„ lexer ä¸­æœŸå¾…çš„ä¸€åˆ‡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šå¦‚ä½•å‡†ç¡®åœ°åˆ›å»ºæˆ‘ä»¬çš„ lexerã€‚è¿™ç§è½¯ä»¶æœ‰ 3 ç§æ ‡å‡†è§£å†³æ–¹æ¡ˆ:

*   é€šè¿‡ä½¿ç”¨å¤šä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼›
*   é€šè¿‡ä½¿ç”¨å•ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼›
*   é€šè¿‡é€å­—ç¬¦é˜…è¯»æ–‡æœ¬ã€‚

è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒç§é€‰æ‹©ã€‚é¦–å…ˆï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤„ç†æ–‡æœ¬éå¸¸å®¹æ˜“ã€‚å®ƒä»¬è®©æˆ‘ä»¬å¯ä»¥éšæ—¶éšåœ°è½»æ¾æ‰©å±•æˆ‘ä»¬çš„è¯­æ³•ã€‚æ­¤å¤–ï¼Œå½“è¯­æ³•éœ€è¦æ”¹å˜æˆ–å‘å±•æ—¶ï¼Œé€å­—ç¬¦é˜…è¯»æ–‡æœ¬ä¸æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚æœ€åï¼Œå¯¹äºç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œå•ä¸ª regexp åº”è¯¥å¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚

# [](#lets-code)å’±ä»¬ç ï¼

æˆ‘å†³å®šå°†ä»£ç åˆ†æˆ 3 ä¸ªåŸºæœ¬æ–‡ä»¶:

*   *grammar.ts* -å®šä¹‰è¯­æ³•ä»¥å¤‡åç”¨çš„æ–‡ä»¶ï¼Œ
*   *lexer . ts*â€”â€”åŸºç¡€`Lexer`ç­çš„åœ°æ–¹ï¼Œ
*   *token.ts -* ä¸º`Token`é˜¶å±‚å‡†å¤‡çš„åœºæ‰€ã€‚

## [](#lexerts)lexer.ts

æˆ‘å°†ä»å®šä¹‰`Lexer`ç±»åŠå…¶æ–¹æ³•å¼€å§‹:

```
import Token from "./token";

export interface GrammarStruct {
  id: string;
  match: string;
}

export default class Lexer {
  private index: number = 0;
  private expr: string = "";
  private regex?: RegExp;
  public tokens: Token[] = [];
  public column: number = 1;
  public line: number = 1;
  public data: string = "";
  public grammar: GrammarStruct[] = [
    {
      id: "newline",
      match: "\\n"
    },
    {
      id: "whitespace",
      match: "\\s"
    }
  ];

  private getRegex() {}
  public loadDefinition(def: GrammarStruct) {}
  public loadGrammar(grammar: GrammarStruct[]) {}
  public loadData(data: string) {}
  public next() {}
  public processAll() {}
  public update() {}
  public empty() {}
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬è¿›ä¸€æ­¥ç ”ç©¶è¿™ä¸ªæ ·æ¿æ–‡ä»¶ï¼Œå¹¶åœ¨åé¢ä»‹ç»åˆ—å‡ºçš„æ–¹æ³•çš„ä»£ç ã€‚

å¼€å¤´æ ‡è®°äº†ä¸€ä¸ªå¯¼å…¥çš„**æ ‡è®°**ç±»å’Œå®šä¹‰çš„`GrammarStruct`æ¥å£ï¼Œç”¨äºæŒ‡å®šå•æ ‡è®°åŒ¹é…çš„ regexp å®¹å™¨åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­ã€‚æ¥ä¸‹æ¥æ˜¯`Lexer`ç±»ï¼Œå®ƒçš„å±æ€§å¾ˆå°‘ï¼Œåå­—æœ¬èº«å°±è¯´æ˜äº†ä¸€åˆ‡ã€‚å…¶ä¸­ 3 ä¸ªè¢«æ ‡è®°ä¸º**ç§æœ‰**ï¼Œå³`index`ã€`expr`å’Œ`regex`ï¼Œå› ä¸ºè¿™äº›æ˜¯ç”± lexer å¤„ç†çš„ï¼Œä¸åº”åœ¨å®ƒä¹‹å¤–ä½¿ç”¨ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­è®¨è®ºæ–¹æ³•ã€‚

```
// ...
private getRegex() {
    if (!this.regex) {
      this.regex = new RegExp(this.expr, "gmu");
      console.log(this.regex);
    }
    this.regex.lastIndex = this.index;
    return this.regex;
  }
// ...

12345678910 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬ä¸€ä¸ªå†…éƒ¨æ–¹æ³•`getRegex()`ç”¨äºä»ä¼ é€’çš„`expr`(ä»è¿æ¥çš„`GrammarStruct`åŒ¹é…å™¨ç”Ÿæˆ)ä¸­ç”Ÿæˆå•ä¸ª regexpï¼Œå¹¶ç¡®ä¿å½“ regexp éœ€è¦é‡æ–°ç”Ÿæˆæ—¶(å½“æ·»åŠ æ–°çš„`GrammarStruct`)æ­£ç¡®è®¾ç½® lastIndexã€‚

```
// ...
public loadDefinition(def: GrammarStruct) {
    if (this.expr.length > 0) this.expr += "|";
    this.expr += `(${def.match})`;
    this.regex = undefined;
    this.grammar.push(def);

    return this;
}

public loadGrammar(grammar: GrammarStruct[]) {
    for (const def of grammar) {
      this.loadDefinition(def);
    }

    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`loadDefinition()`å’Œ`loadGrammar()`å‡½æ•°è´Ÿè´£åŠ è½½`GrammarStruct` sï¼Œå³å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªåŒ¹é…è¡¨è¾¾å¼ã€‚`loadDefinition()`åŠ è½½å•ä¸ª`GrammarStruct`(åŒ¹é…å™¨å®šä¹‰)ï¼Œè€Œ`loadGrammar()`åŠ è½½å®ƒä»¬çš„æ•°ç»„(æ•´ä¸ªè¯­æ³•)ã€‚`this`æ˜¯ä¸ºäº†æ›´å®¹æ˜“é“¾æ¥è€Œè¿”å›çš„(ä¹Ÿé€‚ç”¨äºå…¶ä»–æ–¹æ³•)ã€‚

```
// ...
public loadData(data: string) {
    this.data += data;

    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¡¾åæ€ä¹‰â€”â€”ä¸º lexer åŠ è½½æ›´å¤šæ•°æ®ã€‚æ•°æ®åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé™„åŠ åœ¨æ›´é•¿çš„å­—ç¬¦ä¸²åé¢ã€‚

```
// ...
public next() {
    const regex = this.getRegex();
    const match = regex.exec(this.data);
    if (match) {
      const length = match[0].length;
      const token = this.grammar[match.indexOf(match[0], 1) - 1];
      const id = token.id;
      this.index += length;
      this.tokens.push(
        new Token(
          {
            column: this.column,
            line: this.line,
            value: match[0],
            length,
            id
          },
          this
        )
      );
      if (id === "newline") {
        this.column = 1;
        this.line++;
      } else if (id === "whitespace") {
        this.column++;
      } else {
        this.column += length;
      }

      return this.tokens[this.tokens.length - 1];
    }
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¯”ä»¥å‰çš„ä»»ä½•ä¸€ç§æ–¹æ³•éƒ½è¦å¤æ‚ä¸€äº›ã€‚ä½†æ˜¯è¿™ä¸ªä¹Ÿæ²¡æœ‰ä»€ä¹ˆç¥å¥‡çš„ã€‚å®ƒåªæ˜¯ä½¿ç”¨ regexp åŒ¹é…æ•°æ®ä¸­çš„ä¸‹ä¸€ä¸ªä»¤ç‰Œï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå¹¶æ ¹æ®ç”Ÿæˆçš„æ•°æ®å‘åˆ—è¡¨ä¸­æ·»åŠ æ–°çš„`Token`ï¼Œå³å…¶**ä½ç½®**ã€**é•¿åº¦**å’Œ **ID** ã€‚å®ƒè¿˜æ£€æŸ¥ä»»ä½•**æ¢è¡Œç¬¦**å’Œ**ç©ºç™½ç¬¦**(å®ƒä»¬çš„åŒ¹é…ç¬¦åœ¨`Lexer`ä¸­é»˜è®¤é¢„å®šä¹‰)ï¼Œå¹¶æ­£ç¡®å¤„ç†å®ƒä»¬ä»¥è®¡ç®—æ¯ä¸ªæ ‡è®°çš„ä½ç½®(è¡Œå·å’Œåˆ—å·)ã€‚

```
// ...
public processAll() {
    for (let i = 0; i < Infinity; i++) {
      const token = this.next();
      if (!token) break;
    }

    return this.tokens;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`processAll()`åªæ˜¯ä»`next()`æ–¹æ³•æ´¾ç”Ÿå‡ºæ¥çš„ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒæ‰€åšçš„å°±æ˜¯åŒ¹é…æ‰€æä¾›æ•°æ®ä¸­æ‰€æœ‰å¯èƒ½çš„æ ‡è®°ï¼Œç›´åˆ°æ‰¾ä¸åˆ°æ ‡è®°ï¼Œç„¶åç«‹å³è¿”å›å®ƒä»¬çš„å®Œæ•´åˆ—è¡¨ã€‚

```
// ...
public update() {
    this.tokens = this.tokens
      .filter(token => {
        return token.value && token.value !== "";
      })
      .sort((a, b) => {
        const line = a.line - b.line;
        const column = a.column - b.column;
        return line === 0 ? column : line;
      })
      .map((token, index, tokens) => {
        if (index > 0) {
          const previous = tokens[index - 1];
          if (previous.id === "newline") {
            return token.moveTo(previous.line + 1, 1, false);
          }
          return token.moveTo(
            previous.line,
            previous.column + previous.length,
            false
          );
        } else {
          return token.moveTo(1, 1, false);
        }
      });

    return this;
  }
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`update()`æ˜¯æ¸¸æˆä¸­çš„å¦ä¸€ä¸ªå¤§ç©å®¶ã€‚å®ƒä»¥ä¸€ç§ç®€æ´ã€å®ç”¨çš„æ–¹å¼å¯¹ä»¤ç‰Œæ•°ç»„è¿›è¡Œæ’åºå’Œæ’åˆ—ã€‚é¦–å…ˆï¼Œæ ¹æ®**ä¸ºç©º** -æ²¡æœ‰å€¼çš„ä»¤ç‰Œè¿‡æ»¤æ•°ç»„ã€‚æ¥ä¸‹æ¥ï¼Œä»–ä»¬æŒ‰ç…§å„è‡ªçš„ä½ç½®è¿›è¡Œæ’åºã€‚æœ€åï¼Œå¯¹æ ‡è®°è¿›è¡Œæ˜ å°„ï¼Œä½¿å®ƒä»¬ä»ç¬¬ 1 è¡Œå’Œç¬¬ 1 åˆ—å¼€å§‹æ’åˆ—ï¼Œè¿™éœ€è¦æ£€æŸ¥æ¢è¡Œç¬¦å’Œç©ºæ ¼ã€‚è¿™ä¸ªæ–¹æ³•åœ¨å¤§å¤šæ•°çš„`Token`ç±»æ–¹æ³•ä¸­éƒ½æœ‰ä½¿ç”¨ã€‚

```
// ...
public empty() {
    this.data = "";
    this.line = 1;
    this.column = 1;
    this.index = 0;
    this.tokens = [];

    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`empty()`æ–¹æ³•å…³é—­åˆ—è¡¨ã€‚å®ƒä¼šæ¸…ç©º`Lexer`çš„æ•°æ®ä»¥ä¾›é‡ç”¨(è¯­æ³•å®šä¹‰ä»ç„¶è¢«åŠ è½½)ã€‚

`Lexer`è¯¾åˆ°æ­¤ç»“æŸï¼è¿™å¹¶æ²¡æœ‰é‚£ä¹ˆå¤æ‚â€”â€”å¦‚æœçœŸçš„å¤æ‚çš„è¯ï¼ä½†ä¸€åˆ‡éƒ½åº”è¯¥æ˜¯è¿™æ ·çš„â€”â€”ä¸ºä»€ä¹ˆè¦æŠŠè¿™ä¹ˆå®¹æ˜“è§£å†³çš„äº‹æƒ…å˜æˆå¤§é—®é¢˜å‘¢ï¼Ÿå½“ç„¶ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›æ”¹è¿›ï¼Œä½†åŸºæœ¬æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚

## [](#tokents)token.ts

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†æ›´ç®€å•çš„`Token`ç±»ã€‚åŸºæœ¬ä¸Šæ˜¯è¿™æ ·çš„:

```
import Lexer from "./lexer";

interface TokenData {
  value: string;
  id: string;
  line: number;
  column: number;
  length: number;
}
export default class Token implements TokenData {
  public value: string;
  public id: string;
  public line: number;
  public column: number;
  public length: number;
  private lexer: Lexer;

  public constructor(params: TokenData, ctx: Lexer) {
    this.lexer = ctx;
    this.set(params, false);
  }
  public setValue(newValue: string, update = true) {}
  public moveTo(line?: number, column?: number, update = true) {}
  public moveBy(line?: number, column?: number, update = true) {}
  public set(params: Partial<TokenData>, update = true) {}
  public remove() {}
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æœ€å¼€å§‹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨äºç±»å‹å®šä¹‰ç›®çš„çš„`Lexer`ç±»çš„å¯¼å…¥å’Œ`TokenData`æ¥å£çš„å£°æ˜ï¼Œå®ƒå®šä¹‰äº†åˆ›å»ºæ–°ä»¤ç‰Œæ‰€éœ€çš„æ‰€æœ‰å€¼ã€‚`Token` class åªä¸è¿‡æ˜¯ä¸€ä¸ªç®€å•çš„åŸºæœ¬æ•°æ®æ”¶é›†å™¨ï¼Œå¸¦æœ‰ä¸€äº›è¾…åŠ©å‡½æ•°ã€‚`Lexer`éœ€è¦ä½œä¸ºæ‰€è°“çš„*ä¸Šä¸‹æ–‡*æ¥ä¼ é€’ï¼Œä»¥ä¾¿å…¶æ–¹æ³•ä¸`Token` API è¿›è¡Œåç»­äº¤äº’ã€‚

```
// ...
public setValue(newValue: string, update = true) {
    this.value = newValue;
    this.length = newValue.length;
    if (update) {
      this.lexer.update();
    }
    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åšå®ƒåº”è¯¥åšçš„äº‹æƒ…â€”â€”è®¾ç½®ä»¤ç‰Œçš„å€¼å’Œé•¿åº¦ã€‚è¿™æ˜¯è®¸å¤šæ ‡è®°ç¼–è¾‘æ–¹æ³•ä¸­çš„ä¸€ç§ï¼Œå¯ä»¥é€‰æ‹©ç”¨äºç”Ÿæˆæ ‡è®°çš„åŸºæœ¬ç‰ˆæœ¬ã€‚å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œé»˜è®¤å€¼ä¸º`true`ï¼ŒæŒ‡ç¤º`Lexer`æ˜¯å¦åº”è¯¥åœ¨æ‰€æœ‰å…¶ä»–ä»»åŠ¡ä¹‹åè°ƒç”¨`update()`æ–¹æ³•ã€‚

```
// ...
public moveTo(line?: number, column?: number, update = true) {
    line && (this.line = line);
    column && (this.column = column);
    if (update) {
      this.lexer.update();
    }
    return this;
}

public moveBy(line?: number, column?: number, update = true) {
    line && (this.line += line);
    column && (this.column += column);
    if (update) {
      this.lexer.update();
    }
    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`moveTo()`å’Œ`moveBy()`æ˜¯ç”¨äºé‡æ–°å®šä½å·²ç»åŒ¹é…çš„ä»¤ç‰Œçš„å®ç”¨æ–¹æ³•ã€‚`moveTo()`å°†ä»¤ç‰Œç§»åŠ¨åˆ°æŒ‡å®šçš„è¡Œå’Œåˆ—ï¼Œ`moveBy()`å°†ä»¤ç‰Œç§»åŠ¨ç»™å®šçš„è¡Œæ•°å’Œåˆ—æ•°ã€‚ç§»åŠ¨è¢«æŒ‡ç¤ºåï¼Œä»¤ç‰Œé€šè¿‡`Lexer`çš„`update()`æ–¹æ³•åœ¨æ•°ç»„ä¸­ç§»åŠ¨ã€‚

```
// ...
public set(params: Partial<TokenData>, update = true) {
    this.value = params.value || this.value;
    this.id = params.id || this.id;
    this.line = params.line || this.line;
    this.column = params.column || this.column;
    this.length = params.length || this.length;
    if (update) {
      this.lexer.update();
    }
    return this;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`set()`ç”¨äºåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­è®¾ç½®ä¸åŒçš„ä»¤ç‰Œå€¼ã€‚

```
// ...
public remove() {
    this.value = undefined;
    this.id = undefined;
    this.line = undefined;
    this.column = undefined;
    this.length = undefined;
    this.lexer.update();
 }
 // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`remove()`åˆ é™¤æ‰€æœ‰ä»¤ç‰Œçš„å€¼ï¼Œå¹¶è¿è¡Œ`update()`æ–¹æ³•ï¼Œå…¶ä¸­ä»¤ç‰Œç”±äºç¼ºå°‘å€¼è€Œè¢«ä»åˆ—è¡¨ä¸­è¿‡æ»¤æ‰ã€‚

æ‰€ä»¥ï¼Œ`Token`ç±»ä¸»è¦æä¾›äº†ä¸€äº›ç¼–è¾‘æ•°æ®çš„æ–¹æ³•ã€‚å¯èƒ½å¹¶ä¸æ€»æ˜¯éœ€è¦å®ƒï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠŸèƒ½ã€‚

## [T1ã€‘grammar . ts](#grammarts)

```
import { GrammarStruct } from "./lexer";

const grammar: GrammarStruct[] = [
  // Comments
  {
    id: "single_line_comment_begin",
    match: ">>>"
  },
  {
    id: "multi_line_comment_begin",
    match: ">>"
  },
  {
    id: "multi_line_comment_end",
    match: "<<"
  }
  // ...
]

export default grammar; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ *grammar.ts* æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸ºå¯¹è±¡æ•°ç»„å®šä¹‰äº†æˆ‘ä»¬çš„è¯­æ³•ã€‚æˆ‘ä»¬æä¾›`id`ä½œä¸ºåŒ¹é…æ ‡è®°ç±»å‹çš„æ ‡è¯†ç¬¦ï¼Œå¹¶æä¾›`match`ä½œä¸ºå­—ç¬¦ä¸²å½¢å¼çš„ regexpï¼Œç”¨äºä»¥åçš„è¿æ¥ã€‚è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ã€‚å› ä¸ºæˆ‘ä»¬å®Œæ•´çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä»¥çº¿æ€§æ–¹å¼ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å¿…é¡»ä¿æŒ`GrammarStruct`åŒ¹é…å™¨çš„æ­£ç¡®é¡ºåºã€‚

# [](#in-one-piece)æµ·è´¼ç‹

ä»¥ä¸Šæ‰€æœ‰ä»£ç æ”¾åœ¨ä¸€èµ·å(ä½ å¯ä»¥åœ¨ [**AIM** multi-repo](https://github.com/areknawo/AIM) çš„ **core** åŒ…ä¸­æ‰¾åˆ°å®Œæ•´çš„æºä»£ç )æ˜¯æ—¶å€™ä½¿ç”¨è¿™ä¸ªåˆ›ä½œäº†ï¼è¿™ä¸€åˆ‡éƒ½å½’ç»“ä¸ºä¸‹é¢çš„ä»£ç :

```
import Lexer from "../src/lexer";
import grammar from "../src/grammar";

const AIMLexer = new Lexer().loadGrammar(grammar);
AIMLexer.loadData("public variable #int32 = 1")
AIMLexer.processAll() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæˆ‘å¯èƒ½ä¼šåœ¨è¿™é‡Œç»“æŸè¿™ä¸ªæ•…äº‹ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ä½ çœ‹ï¼Œlexer åªç”¨äºå°†çº¿æ€§æ–‡æœ¬å¤„ç†æˆä¸€ä¸ªæ ‡è®°æ•°ç»„ã€‚è¿™æ˜¯å¦ä¸€ä¸ªå·¥å…·çš„å·¥ä½œ- **è§£æå™¨** -ä»¥æ­£ç¡®çš„æ–¹å¼è¯»å–/å¤„ç†å®ƒä»¬ã€‚ä¸è¿™ä¸ªé—®é¢˜ç‰¹åˆ«ç›¸å…³çš„ä¸€ä¸ªæ–¹é¢æ˜¯æˆ‘ä»¬è¯­æ³•ä¸­çš„**å­—ç¬¦ä¸²**çš„å®ç°ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨ AIM ä¸­åˆ›å»ºç±»ä¼¼ JS æ¨¡æ¿æ–‡å­—çš„æƒ³æ³•ã€‚å¦‚ä½•ç”¨ä¸€ä¸ª regexp åŒ¹é…æ‰€æœ‰çš„å¯èƒ½æ€§ï¼Œä¾‹å¦‚è½¬ä¹‰å€¼ã€å­—ç¬¦å’Œå®šä½ç‚¹ï¼Ÿ

```
"text\$${value}text"

1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç®€å•çš„å›ç­”å°±æ˜¯**ä½ ä¸**ã€‚ä¹Ÿè®¸è§£å†³æ–¹æ¡ˆå¯¹ä½ ä»¬ä¸­çš„ä¸€äº›äººæ¥è¯´æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†å®ƒç¡®å®éœ€è¦æˆ‘è¿›è¡Œä¸€äº›æ·±å…¥çš„æ€è€ƒ(å¾ˆå¯èƒ½æˆ‘ä¸å¤Ÿå¼€æ˜)ã€‚ä½ å¿…é¡»ä¸€ä¸ªå­—ç¬¦æ¥ä¸€ä¸ªå­—ç¬¦åœ°å¤„ç†å­—ç¬¦ä¸²**(è‡³å°‘è¿™æ˜¯æˆ‘æƒ³å‡ºæ¥çš„)ã€‚ä¾‹å¦‚ï¼Œçœ‹çœ‹æˆ‘çš„è¯­æ³•å®šä¹‰æ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚** 

```
[
    // ...
    {
        id: "char",
        match: `(?<=(?:(?:\\b|^)["'\`])|[\\x00-\\x7F])[\\x00-\\x7F](?=(?:[\\x00-\\x7F]+)?["'\`](?:\\b|$))`
    },
    // ...
    // Anchors and brackets
    {
        id: "string_anchor",
        match: "['`\"]"
    }
    // ...
] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æŠŠå­—ç¬¦ä¸²åˆ†æˆäº†é”šå’Œå­—ç¬¦ã€‚è¿™æ ·ï¼Œå½“æˆ‘å°†å®ƒä¸ä»»ä½•ç»™å®šçš„å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…æ—¶ï¼Œæˆ‘ä¼šæ”¶åˆ°è®¸å¤šä¸åŒçš„æ ‡è®°ï¼Œè¿™äº›æ ‡è®°æœ‰`id` of **char** å’Œ...é‚£å®Œå…¨æ²¡é—®é¢˜ï¼ç¨åæˆ‘å¯ä»¥ç”¨è§£æå™¨å°†å®ƒå¤„ç†æˆæœ€ç»ˆçš„ã€å¥½çœ‹çš„ã€å¿«é€Ÿçš„å½¢å¼ã€‚

# [](#its-only-the-beginning)è¿™åªæ˜¯å¼€å§‹

ç‰¹åˆ«æ˜¯ä¸è§£æå™¨å’Œç¼–è¯‘å™¨ç›¸æ¯”ï¼Œlexer åªæ˜¯å°èœä¸€ç¢Ÿã€‚ä½†æ˜¯æŠŠæ‰€æœ‰çš„è°œé¢˜æ”¾åœ¨æ­£ç¡®çš„åœ°æ–¹çœŸçš„å¾ˆé‡è¦ã€‚åªæœ‰åŸºç¡€ç‰¢å›ºäº†ï¼Œå¡”æ‰ä¸ä¼šå€’ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘è®¤ä¸º lexer çš„ä»£ç å¯èƒ½ä¼šå‘ç”Ÿä¸€äº›å˜åŒ–(ä¸»è¦æ˜¯åœ¨ç¼–å†™è§£æå™¨çš„æ—¶å€™)ï¼Œä½†ä¸»è¦æ€æƒ³å°†ä¿æŒä¸å˜ã€‚

åŒæ ·ï¼Œå¦‚æœä½ æƒ³çœ‹å®Œæ•´çš„ä»£ç ï¼Œå» [**AIM** å›è´­](https://github.com/areknawo/AIM)ã€‚å¦‚æœä½ æƒ³æ›´å¯†åˆ‡åœ°è·Ÿè¸ª AIM å¼€å‘çš„è¿‡ç¨‹ï¼Œå¯ä»¥è€ƒè™‘*å¼€å§‹å›è´­*æˆ–è€…*åœ¨ [Twitter](https://twitter.com/areknawo) ä¸Šå…³æ³¨æˆ‘ã€‚*ğŸ’¡