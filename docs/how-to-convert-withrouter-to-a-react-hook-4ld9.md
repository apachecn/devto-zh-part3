# å¦‚ä½•å°† withRouter è½¬æ¢æˆ React é’©å­ï¼Ÿ

> åŸæ–‡ï¼š<https://dev.to/charlesstover/how-to-convert-withrouter-to-a-react-hook-4ld9>

æ–°ç‰ˆæœ¬ 16.7 ä¸­ React æŒ‚é’©çš„æœ€å¤§å¥½å¤„ä¹‹ä¸€æ˜¯æ¶ˆé™¤äº†å¯¹é«˜é˜¶ç»„ä»¶çš„ä¾èµ–ã€‚åœ¨å°†æˆ‘çš„ç±»çŠ¶æ€ç§»æ¤åˆ°å‡½æ•°é’©å­çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¾ˆé«˜å…´æœ‰æœºä¼šå°†æˆ‘çš„[å’Œ-router](https://github.com/CharlesStover/with-router/blob/master/README.md) é«˜é˜¶ç»„ä»¶ç§»æ¤åˆ°ä¸€ä¸ªé’©å­ä¸Šã€‚æˆ‘ä¸€ç›´åœ¨ä½¿ç”¨è¿™ä¸ªå®šåˆ¶çš„å®ç°æ¥é‡æ–°å‘ˆç°æˆ‘çš„ç»„ä»¶ã€‚`react-router`çš„å†…ç½®`withRouter` HOC ä¸ä¼šåœ¨è·¯çº¿æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ª[éš¾ä»¥è§£å†³çš„é—®é¢˜](https://github.com/ReactTraining/react-router/blob/master/packages/react-router/docs/guides/blocked-updates.md)ã€‚

è¿™ç¯‡æ–‡ç« åº”è¯¥ä½œä¸ºå®ç°å…·æœ‰å‘å¸ƒ-è®¢é˜…åŠŸèƒ½çš„ React æŒ‚é’©çš„æ•™ç¨‹ã€‚Pub-sub æ˜¯â€œå‘å¸ƒ-è®¢é˜…â€çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ç¼–ç¨‹æ–¹æ³•ï¼Œå…¶ä¸­å½“æ›´æ–°å‘å¸ƒæ—¶ï¼Œä¸€ç»„è®¢é˜…è¿›ç¨‹å¾—åˆ°é€šçŸ¥ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå½“ä½ç½®æ”¹å˜æ—¶(å‘å¸ƒçš„äº‹ä»¶)ï¼Œæˆ‘æƒ³é‡æ–°å‘ˆç°æˆ‘çš„ç»„ä»¶(ä¾¦å¬å™¨è®¢é˜…)ã€‚

æœ€ç»ˆäº§å“éœ€è¦ React Router v4.4 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå› ä¸º React Router çš„æ—©æœŸç‰ˆæœ¬ä¸å…¬å¼€è·¯ç”±å™¨ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥ä¾¦å¬ä½ç½®å˜åŒ–ã€‚å¦‚æœæ‚¨æ— æ³•è®¿é—® React è·¯ç”±å™¨çš„æœ€æ–°ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥æ”¶å¬çª—å£å†å²çŠ¶æ€ä½œä¸ºæ›¿ä»£æ–¹æ³•ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨ä¸`react-router`ç›¸åŒçš„â€œçœŸå®çš„å•ä¸€æ¥æºâ€,ç¡®ä¿æˆ‘çš„çŠ¶æ€æ€»æ˜¯åŒæ­¥çš„ã€‚

ä½ å¯ä»¥åœ¨ NPM ä¸Šé€šè¿‡ [use-react-router è‡ªå·±ä½¿ç”¨è¿™ä¸ªåŒ…ï¼Œæˆ–è€…è´¡çŒ®ç»™](https://www.npmjs.com/package/use-react-router)[å¼€æº GitHub åº“](https://github.com/CharlesStover/use-react-router)ï¼Œæˆ–è€…ä»¥å…¶ä»–æ–¹å¼çª¥æ¢å®ƒã€‚

# ç”¨æˆ·ä½“éªŒğŸ™ƒ

æˆ‘å¼€å§‹æ¯ä¸ªé¡¹ç›®æ—¶éƒ½ä¼šé—®è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œâ€œæˆ‘æƒ³åšä»€ä¹ˆï¼Ÿâ€è¿™å¹¶ä¸æ„å‘³ç€ï¼Œâ€œæˆ‘æƒ³å¦‚ä½•å®ç°è¿™ä¸ªç‰¹æ€§ï¼Ÿâ€è¿™æ„å‘³ç€ï¼Œä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œæˆ‘å¤šä¹ˆå¸Œæœ›è¿™ä¸ªç‰¹æ€§å·²ç»å®ç°äº†ã€‚æˆ‘å¸Œæœ›*å’Œ*åšäº›ä»€ä¹ˆæ‰èƒ½åœ¨å°†æ¥ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Ÿå¦‚ä½•è®©*ç›´è§‚*å’Œ*å¥½ç”¨*ï¼Ÿ

å¹¸è¿çš„æ˜¯ï¼Œ`withRouter`ä¸æ˜¯ä¸€ä¸ªå›°éš¾çš„å®ç°ï¼Œæ‰€ä»¥å®ƒçš„é’©å­ä¹Ÿä¸æ˜¯ã€‚

æˆ‘æƒ³ä»é»˜è®¤çš„åŒ…å¯¼å‡ºä¸­å¯¼å…¥ä¸€ä¸ªé’©å­ã€‚

```
import useReactRouter from 'use-react-router'; 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘æƒ³è°ƒç”¨é‚£ä¸ªé’©å­ï¼Œç„¶å*ç»“æŸå®ƒ*ã€‚

```
const { history, location, match } = useReactRouter(); 
```

Enter fullscreen mode Exit fullscreen mode

è¿™å°†æˆ‘çš„ç»„ä»¶ä¸­çš„å†å²ã€ä½ç½®å’Œæ¯”èµ›é“å…·æ•´ç†å‡ºæ¥ï¼Œå¹¶å…è®¸æˆ‘æŒ‘é€‰æˆ‘æƒ³è¦å­˜åœ¨çš„ã€‚

æˆ‘ä¸å¸Œæœ›å¿…é¡»å®ç°è¿›ä¸€æ­¥çš„é€»è¾‘æ¥é‡æ–°æ¸²æŸ“ä½ç½®çš„å˜åŒ–ã€‚æˆ‘å¸Œæœ›è¯¥åŠŸèƒ½å·²ç»å®ç°ï¼Œè¿™ä¸`react-router`çš„ç‰¹è®¾å®ç°å½¢æˆé²œæ˜å¯¹æ¯”ã€‚é‚£åªæ˜¯ä¸ªäººå–œå¥½ï¼Œä½ å¯èƒ½åè€Œä¼šèµåŒä»–ä»¬çš„å®ç°ã€‚æœ¬æ•™ç¨‹å°†è®¨è®ºå¦‚ä½•å®ç°è¿™ä¸¤è€…ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ç‰¹æ€§è¯·æ±‚ï¼Œå¹¶ä¸”ä¸æˆ‘çš„ä¸ªäººç”¨ä¾‹é«˜åº¦ç›¸å…³ã€‚

# å®ç°

## ä»å±å…³ç³»ğŸ‘¶

é¦–å…ˆï¼Œæˆ‘ä»¬çš„ä¾èµ–ã€‚

æˆ‘ä»¬å°†éœ€è¦æ¥è‡ª`react-router`åŒ…çš„è·¯ç”±å™¨ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºå®ƒåŒ…å«æˆ‘ä»¬æƒ³è¦åœ¨ç»„ä»¶ä¸­è®¿é—®çš„æ•°æ®ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†éœ€è¦æ¥è‡ª react åŒ…çš„`useContext`é’©å­æ¥â€œæŒ‚é’©â€è·¯ç”±å™¨ä¸Šä¸‹æ–‡ã€‚å› ä¸ºæˆ‘ä»¬æ­£åœ¨å®ç°å‘å¸ƒ-è®¢é˜…åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ React å†…ç½®çš„`useEffect`æŒ‚é’©ã€‚è¿™å°†å…è®¸æˆ‘ä»¬è®¢é˜…å’Œå–æ¶ˆè®¢é˜…çš„ä½ç½®å˜åŒ–ã€‚

```
import { useContext, useEffect } from 'react';
import { __RouterContext } from 'react-router'; 
```

Enter fullscreen mode Exit fullscreen mode

æœ€åï¼Œæˆ‘å°†ä» [`use-force-update` NPM åŒ…](https://www.npmjs.com/package/use-force-update)ä¸­å¯¼å…¥`useForceUpdate`ã€‚è¿™ä»…ä»…æ˜¯è°ƒç”¨`useState`é’©å­æ¥å¼ºåˆ¶é‡æ–°æ¸²æŸ“çš„ç®€å†™ï¼Œå½“ä½ç½®æ”¹å˜æ—¶æˆ‘ä»¬å°†ä¼šè¿™æ ·åšã€‚

```
import useForceUpdate from 'use-force-update'; 
```

Enter fullscreen mode Exit fullscreen mode

## é’©å­ğŸ£

å¯¼å…¥ä¾èµ–é¡¹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™é’©å­

```
const useReactRouter = () => {
  const forceUpdate = useForceUpdate();
  const routerContext = useContext(__RouterContext);
  /* TODO */
  return routerContext;
}; 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘ä»¬é¦–å…ˆå®ä¾‹åŒ–æˆ‘ä»¬å°†éœ€è¦çš„æ‰€æœ‰å…¶ä»–é’©å­ã€‚ç°åœ¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå½“è¢«è°ƒç”¨æ—¶ï¼Œé‡æ–°å‘ˆç°ç»„ä»¶ã€‚`routerContext`ç°åœ¨æ˜¯`react-router`ä¸Šä¸‹æ–‡çš„å†…å®¹:ä¸€ä¸ªå…·æœ‰`history`ã€`location`å’Œ`match`å±æ€§çš„å¯¹è±¡â€”â€”ä¸æ‚¨æœŸæœ›ä»`withRouter`è·å¾—çš„é“å…·å®Œå…¨ç›¸åŒã€‚

**å¦‚æœæ‚¨ä¸æƒ³è¦é‡æ–°æ¸²æŸ“åŠŸèƒ½ï¼Œ**æ‚¨å¯ä»¥åœ¨æ­¤åœæ­¢ã€‚æ‚¨å¯ä»¥åˆ é™¤`forceUpdate`å˜é‡ã€`useEffect`å¯¼å…¥å’Œ[T2 ä¾èµ–](https://www.npmjs.com/package/use-force-update)ã€‚æˆ‘å»ºè®®åœ¨æ‚¨çš„ç»„ä»¶ä¸­ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„`useReactRouter`é’©å­æ¥è°ƒç”¨`useContext`,ä»…ä»…æ˜¯å› ä¸º`__RouterContext`åç§°å’Œ`@next` semvar å½“å‰éœ€è¦è®¿é—® React Router v4.4ã€‚è®¿é—®è¿™ä¸ªä¸Šä¸‹æ–‡å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨å•ä¸ªåŒ…ä¸­è¿›è¡Œè°ƒæ•´æ¯”åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨çš„æ¯ä¸ªä¾èµ–äºè·¯ç”±å™¨çš„ç»„ä»¶ä¸­è¿›è¡Œè°ƒæ•´è¦ç®€å•å¾—å¤šã€‚å¯¹äºå¼€å‘äººå‘˜æ¥è¯´,`useReactRouter`æ¯”`useContext(__RouterContext)`æ›´åŠ ç›´è§‚â€”â€”é¢å¤–çš„ä¸Šä¸‹æ–‡å¯¼å…¥æ˜¯å¤šä½™ä¸”ä¸å˜çš„ã€‚

## Pub-SubğŸ“°

ä¸ºäº†å®ç°å‘å¸ƒ-è®¢é˜…è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦`useEffect`ã€‚è¿™å°†å…è®¸æˆ‘ä»¬åœ¨ç»„ä»¶å®‰è£…æ—¶è®¢é˜…ï¼Œåœ¨ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…ã€‚ç†è®ºä¸Šï¼Œå¦‚æœè·¯ç”±å™¨ä¸Šä¸‹æ–‡å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå°†å–æ¶ˆè®¢é˜…æ—§çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶é‡æ–°è®¢é˜…æ–°çš„ä¸Šä¸‹æ–‡(å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¿™æ˜¯ä¸€ç§ç†æƒ³çš„è¡Œä¸º)ï¼Œä½†æ²¡æœ‰ç†ç”±å‡è®¾è¿™ç§æƒ…å†µä¼šå‘ç”Ÿã€‚

å°†æˆ‘ä»¬çš„`/* TODO */`æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹:

```
useEffect(
  () => {
    // TODO: subscribe
    return () => {
      // TODO: unsubscribe
    };
  },
  [ /* TODO: memoization parameters here */ ]
); 
```

Enter fullscreen mode Exit fullscreen mode

`useEffect`é‡‡ç”¨ä¸€ä¸ªå°†æ‰§è¡Œæ¯æ¬¡å®‰è£…å’Œæ›´æ–°çš„å‡½æ•°ã€‚å¦‚æœè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‡½æ•°å°†æ‰§è¡Œæ¯æ¬¡å¸è½½å’Œé¢„æ›´æ–°ã€‚

å…¶ä¸­`effect1`æ˜¯å¤–éƒ¨å‡½æ•°,`effect2`æ˜¯å†…éƒ¨å‡½æ•°ï¼Œç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œå¦‚ä¸‹:

```
mount > effect1 ... effect2 > update > effect1 ... effect2 > unmount 
```

Enter fullscreen mode Exit fullscreen mode

å¤–éƒ¨å‡½æ•°åœ¨è£…è½½æˆ–æ›´æ–°åç«‹å³æ‰§è¡Œã€‚å†…éƒ¨å‡½æ•°*ç­‰å¾…*,ç›´åˆ°ç»„ä»¶å°†è¦æ›´æ–°æˆ–å¸è½½æ‰æ‰§è¡Œã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ç»„ä»¶å®‰è£…åè®¢é˜…ä½ç½®æ›´æ”¹ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½å‰å–æ¶ˆè®¢é˜…ä½ç½®æ›´æ”¹ã€‚

`useEffect`çš„è®°å¿†æ•°ç»„è¯´â€œä¸è¦åœ¨æ›´æ–°æ—¶æ‰§è¡Œè¿™äº›æ•ˆæœå‡½æ•°ï¼Œé™¤éè¿™ä¸ªå‚æ•°æ•°ç»„å·²ç»æ”¹å˜ã€‚â€æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥é¿å…ä»…ä»…å› ä¸ºç»„ä»¶è¢«é‡æ–°æ¸²æŸ“è€ŒæŒç»­è®¢é˜…å’Œå–æ¶ˆè®¢é˜…ä½ç½®å˜åŒ–ã€‚åªè¦è·¯ç”±å™¨ä¸Šä¸‹æ–‡æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦æ”¹å˜æˆ‘ä»¬çš„è®¢é˜…ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ memoization æ•°ç»„å¯ä»¥åŒ…å«ä¸€ä¸ªå•é¡¹:`[ routerContext ]`ã€‚

```
useEffect(
  function subscribe() {
    // TODO
    return function unsubscribe() {
      // TODO
    };
  },
  [ routerContext ]
); 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚ä½•è®¢é˜…ä½ç½®æ›´æ”¹ï¼Ÿé€šè¿‡å‘`routerContext.history.listen`ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨æ¯æ¬¡è·¯ç”±å™¨å†å²æ”¹å˜æ—¶æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œçš„å‡½æ•°å°±æ˜¯ç®€å•çš„`forceUpdate`ã€‚

```
useEffect(
  function subscribe() {
    routerContext.history.listen(forceUpdate);
    return unsubscribe() {
      // TODO
    };
  },
  [ routerContext ]
); 
```

Enter fullscreen mode Exit fullscreen mode

ä½ å¦‚ä½•é€€è®¢ä½ç½®å˜åŒ–ï¼Ÿæˆ‘ä»¬ä¸èƒ½åªè®©è¿™ä¸ªè®¢é˜…åœ¨ç»„ä»¶å¸è½½åå­˜åœ¨â€” `forceUpdate`ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯ä¸ä¼šæœ‰ç»„ä»¶æ›´æ–°ï¼

`routerContext.history.listen`è¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…å‡½æ•°ï¼Œå½“è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä»äº‹ä»¶ä¸­åˆ é™¤è®¢é˜…ç›‘å¬å™¨(`forceUpdate`)ã€‚

```
useEffect(
  () => {
    const unsubscribe = routerContext.history.listen(forceUpdate);
    return () => {
      unsubscribe();
    };
  },
  [ routerContext ]
); 
```

Enter fullscreen mode Exit fullscreen mode

å¹¶ä¸æ˜¯è¯´è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³è®©è¿™æ®µä»£ç æ›´çŸ­ä¸€ç‚¹ï¼Œä½ å¯ä»¥:

```
useEffect(
  () => {
    const unsubscribe = routerContext.history.listen(forceUpdate);
    return unsubscribe;
  },
  [ routerContext ]
); 
```

Enter fullscreen mode Exit fullscreen mode

è¿˜æœ‰æ›´çŸ­çš„:

```
useEffect(
  () => routerContext.history.listen(forceUpdate),
  [ routerContext ]
); 
```

Enter fullscreen mode Exit fullscreen mode

# ä½•å»ä½•ä»ï¼ŸğŸ”®

ç”±`react-router`åŒ…æä¾›çš„`withRouter`çš„ç‰¹å®šå®ç°ä»ç»„ä»¶å±æ€§ä¸­æå–`history`ã€`location`å’Œ`match`ï¼Œå¹¶èµ‹äºˆå®ƒä»¬æ¯”ä¸Šä¸‹æ–‡ API å€¼æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚è¿™å¯èƒ½æ˜¯å› ä¸º`<Route>`ç»„ä»¶æä¾›äº†è¿™äº›ä½œä¸ºé“å…·ï¼Œè€Œ`match`çš„å€¼éœ€è¦æ¥è‡ª`Route`çš„è·¯å¾„è§£é‡Šã€‚

è™½ç„¶æˆ‘è¿˜æ²¡æœ‰åœ¨æˆ‘çš„åŒ…ä¸­åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä½†æˆ‘è®¤ä¸ºä¸‹ä¸€æ­¥åº”è¯¥æ˜¯ä½¿ç”¨æŒ‚é’©ç»„ä»¶çš„é“å…·ä½œä¸º`useReactRouter`çš„å‚æ•°ï¼Œå…è®¸å®ƒä½¿ç”¨ç›¸åŒçš„é“å…·ä¼˜å…ˆçº§ã€‚

# ç»“è®ºğŸ”š

å¦‚æœä½ æƒ³ä¸ºè¿™ä¸ªå¼€æºåŒ…åšè´¡çŒ®ï¼Œæˆ–è€…åœ¨*æ‰“å­—ç¨¿*ä¸­çœ‹åˆ°å®ƒï¼Œä½ å¯ä»¥åœ¨ GitHub ä¸Šç»™å®ƒåŠ æ˜Ÿã€åˆ†å‰ã€æ‰“å¼€é—®é¢˜ï¼Œæˆ–è€…ä»¥å…¶ä»–æ–¹å¼[æŸ¥çœ‹å®ƒã€‚æ‚¨å¯ä»¥é€šè¿‡ NPM](https://github.com/CharlesStover/use-react-router/blob/master/src/use-react-router.ts) ä¸Šçš„ [`use-react-router`è‡ªè¡Œä½¿ç”¨è¯¥å¥—é¤ã€‚](https://www.npmjs.com/package/use-react-router)

å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·éšæ„ç»™å®ƒä¸€ä¸ªå¿ƒå½¢æˆ–ç‹¬è§’å…½ã€‚åˆå¿«åˆç®€å•ï¼Œè¿˜å…è´¹ï¼å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–ç›¸å…³çš„å¥½å»ºè®®ï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºä¸­ç•™ä¸‹ã€‚

è¦é˜…è¯»æ›´å¤šæˆ‘çš„ä¸“æ ï¼Œä½ å¯ä»¥åœ¨ [LinkedIn](https://www.linkedin.com/in/charles-stover) ã€ [Medium](https://medium.com/@Charles_Stover) å’Œ [Twitter](https://twitter.com/CharlesStover) ä¸Šå…³æ³¨æˆ‘ï¼Œæˆ–è€…[åœ¨ CharlesStover.com](https://charlesstover.com/)ä¸ŠæŸ¥çœ‹æˆ‘çš„ä½œå“é›†ã€‚