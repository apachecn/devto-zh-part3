# ç¬¬ 008 é›†-ä¸­é—´ä»¶-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°è¿‡åº¦æ€æˆ®

> åŸæ–‡:[https://dev.to/joaofbantunes/episode-008-ä¸­é—´ä»¶-aspnet-core-from-0-to-over kill-3d a3](https://dev.to/joaofbantunes/episode-008---middlewares---aspnet-core-from-0-to-overkill-3da3)

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ ASP.NET æ ¸å¿ƒçš„ä¸­é—´ä»¶ï¼Œå¦‚ä½•åˆ›å»ºå®ƒä»¬å¹¶åœ¨è¯·æ±‚å¤„ç†ç®¡é“ä¸­ä½¿ç”¨å®ƒä»¬ã€‚å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/YU28TJWARg0](https://www.youtube.com/embed/YU28TJWARg0)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚

## [T1ã€‘ç®€ä»‹](#intro)

æˆ‘ä»¬åœ¨ç¬¬å››é›†ä¸­ç®€å•ä»‹ç»äº†ä¸­é—´ä»¶ï¼Œå½“æ—¶æˆ‘ä»¬è°ˆåˆ°äº†`Program`å’Œ`Startup`ç±»ã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†é‡æ¸©ä¸­é—´ä»¶çš„è¯é¢˜ï¼Œå¹¶è®¨è®ºæ„å»ºä¸­é—´ä»¶çš„é€‰æ‹©ã€‚

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œä¸­é—´ä»¶çš„åŸºæœ¬æ€æƒ³æ˜¯å®ƒä»¬åƒé“¾ä¸€æ ·å·¥ä½œâ€”â€”ä¸€ä¸ªä¸­é—´ä»¶è¢«è°ƒç”¨ï¼Œå®ƒå¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œç„¶åå°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæœ€ååœ¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å®Œæˆæ—¶åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚å¯èƒ½ä¼šå‡ºç°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æ²¡æœ‰è¢«è°ƒç”¨çš„æƒ…å†µï¼Œä¾‹å¦‚åœ¨æˆæƒä¸­é—´ä»¶ä¸­ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰é€šè¿‡èº«ä»½éªŒè¯ï¼Œå®ƒå¯ä»¥ç«‹å³åœæ­¢è¯·æ±‚ï¼Œè‡ªå·±è¿”å›ä¸€ä¸ªå“åº”ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å½¢è±¡æ¥è¯´æ˜è¡Œä¸ºï¼Œæ¥è‡ªå®˜æ–¹çš„ [docs](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/index?view=aspnetcore-2.1) ã€‚

[![request handling pipeline](../Images/70e3607179c0e8f79dae48541536db62.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--0jCJWOas--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/bipm4s93oyqqnpwz291o.png)

ä¸­é—´ä»¶å¯ä»¥æ˜¯ç®€å•çš„äº‹æƒ…ï¼Œåªæ˜¯ä¸ºäº†ä¸°å¯Œè¯·æ±‚å¤„ç†ç®¡é“â€”â€”æ·»åŠ ä¸€äº›å¤´ã€è¿‡æ»¤æœªæˆæƒçš„è®¿é—®ã€æ”¶é›†ä¸€äº›æŒ‡æ ‡ç­‰â€”â€”åˆ°å®ç°å®Œæ•´çš„è¯·æ±‚å¤„ç†é€»è¾‘â€”â€”å¥åº·æ£€æŸ¥çš„ç«¯ç‚¹ã€æä¾›é™æ€æ–‡ä»¶ã€MVCğŸ™‚ç­‰ã€‚

è¦åˆ›å»ºä¸­é—´ä»¶ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªé€‰é¡¹å¯ä»¥å¼€å§‹:

*   åœ¨å†…åµŒåŒ¿åå‡½æ•°ä¸­å®ç°é€»è¾‘(å°±åƒæˆ‘ä»¬åœ¨ç¬¬ 4 é›†çœ‹åˆ°çš„ä¾‹å­)
*   åœ¨ä¸“é—¨çš„ç±»ä¸­å®ç°é€»è¾‘

åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹ç”¨è¿™ä¸¤ç§é€‰é¡¹å®ç°ä¸­é—´ä»¶çš„ä¸€äº›ç®€å•ä¾‹å­ã€‚

## [](#appuse)appã€‚ä½¿ç”¨

é‰´äºæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶åœ¨ç®¡é“ä¸­ç”¨`app.Use`å®ç°å’Œæ³¨å†Œï¼Œé™¤äº†åœ¨è¿™é‡Œæ·»åŠ ä»£ç ä»¥ä¾›å‚è€ƒä¹‹å¤–ï¼Œå°±ä¸å†èµ˜è¿°äº†ğŸ™‚

`Startup.cs`

```
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    //...

    app.Use(async (context, next) =>
    {
        context.Response.OnStarting(() =>
        {
            context.Response.Headers.Add("X-Powered-By", "ASP.NET Core: From 0 to overkill");
            return Task.CompletedTask;
        });

        await next.Invoke();
    });

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå®ƒæ³¨å†Œäº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶`HttpContext`å’Œ`Func`æ¥è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚ç„¶åå®ç°ï¼Œå—¯ï¼Œæˆ‘ä»¬åšæˆ‘ä»¬æƒ³åšçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåªæ˜¯æ·»åŠ ä¸€ä¸ªå“åº”å¤´ï¼ŒåŒæ—¶é€šè¿‡è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè®©ç®¡é“çš„å…¶ä½™éƒ¨åˆ†æ­£å¸¸å·¥ä½œã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬æ³¨å†Œä¸­é—´ä»¶çš„é¡ºåº(åœ¨`Configure`æ–¹æ³•ä¸­)å®šä¹‰äº†å®ƒä»¬åœ¨å¤„ç†è¯·æ±‚æ—¶çš„è¿è¡Œé¡ºåºï¼Œæ‰€ä»¥**é¡ºåºä¸**å¹¶ä¸ç›¸å…³ã€‚

## [](#appusemiddleware)appã€‚ä½¿ç”¨ä¸­é—´ä»¶

é€šè¿‡`app.Use`ï¼Œæˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ªåŸºäº lambda çš„ä¸­é—´ä»¶ã€‚è¦æ³¨å†Œä¸€ä¸ªåŸºäºç±»çš„ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`app.UseMiddleware<T>`æ‰©å±•æ–¹æ³•ã€‚

å½“åˆ›å»ºåŸºäºç±»çš„ä¸­é—´ä»¶æ—¶ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªé€‰æ‹©:

*   åŸºäºçº¦å®šçš„æ¿€æ´»â€”â€”æˆ‘ä»¬æŒ‰ç…§çº¦å®šå®ç°è¿™ä¸ªç±»ï¼Œæ‰€æœ‰çš„ä¸€åˆ‡éƒ½ä¼šè‡ªåŠ¨è¿è¡Œ
*   åŸºäºå·¥å‚çš„æ¿€æ´»â€”â€”ä¸­é—´ä»¶ç±»å®ç°äº†`IMiddleware`,æ‰€ä»¥æˆ‘ä»¬å¾—åˆ°äº†æ›´â€œæ­£å¸¸â€çš„ä½“éªŒï¼Œå°±åƒæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç»§æ‰¿è‡ª`Controller`ç±»çš„æ§åˆ¶å™¨(é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™ä¹Ÿä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡éµå¾ªä¸€äº›çº¦å®šæ¥å®ç°æ§åˆ¶å™¨)

### [](#conventionbased-activated-middleware)åŸºäºçº¦å®šçš„æ¿€æ´»ä¸­é—´ä»¶

å¯¹äºä¸€ä¸ªåŸºäºçº¦å®šçš„æ¿€æ´»ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬åº”è¯¥éµå¾ªä¸€äº›è§„åˆ™ï¼Œè¿™æ ·å°±å¯ä»¥äº†ã€‚ä¸€ä¸ªåŸºæœ¬çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚

```
public class SampleConventionActivatedMiddleware
{
    private readonly RequestDelegate _next;

    public SampleConventionActivatedMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // do stuff before the next middleware executes
        await _next(context);
        // do stuff after the next middleware executes
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªå§”æ‰˜æ¥è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæˆ‘ä»¬å­˜å‚¨å®ƒä»¥ä¾¿åœ¨å¤„ç†è¯·æ±‚æ—¶ä½¿ç”¨ã€‚

ç„¶åæˆ‘ä»¬æœ‰ä¸€ä¸ª`InvokeAsync`æ–¹æ³•ï¼Œå®ƒè·å–`HttpContext`ä½œä¸ºå‚æ•°ã€‚è¿™å¯èƒ½å·²ç»å‘Šè¯‰äº†æˆ‘ä»¬ä¸€äº›äº‹æƒ…ï¼Œä¹ä¸€çœ‹å¯èƒ½å¹¶ä¸å®Œå…¨æ¸…æ¥šâ€”â€”ç®¡é“ä¸­ä½¿ç”¨çš„ä¸­é—´ä»¶å®ä¾‹åŸºæœ¬ä¸Šæ˜¯å•ä¾‹çš„ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æ„å»ºçš„ã€‚

è®©æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚

```
public class RequestTimingAdHocMiddleware
{
    private readonly RequestDelegate _next;
    private int _requestCounter; 

    public RequestTimingAdHocMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context, ILogger<RequestTimingAdHocMiddleware> logger)
    {
        var watch = Stopwatch.StartNew();
        await _next(context);
        watch.Stop();
        Interlocked.Increment(ref _requestCounter);
        logger.LogWarning("Request {requestNumber} took {requestTime}ms", _requestCounter, watch.ElapsedMilliseconds);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ï¼Œä¸­é—´ä»¶å®ä¾‹æ˜¯å•ä¾‹çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æœ‰ä¸€äº›ä¾èµ–é¡¹ï¼Œè€Œä¸æ˜¯åƒå¾€å¸¸ä¸€æ ·åœ¨æ„é€ å‡½æ•°ä¸­è·å¾—å®ƒä»¬ï¼Œæˆ‘ä»¬åœ¨`InvokeAsync`æ–¹æ³•ä¸­å£°æ˜æˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥æ ¹æ®è¯·æ±‚è¿›è¡Œè§£æã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å‘ç”Ÿçš„äº‹æƒ…æ˜¯,`_requestCounter`å­—æ®µå°†è®°å½•åœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…é€šè¿‡ä¸­é—´ä»¶çš„æ‰€æœ‰è¯·æ±‚ï¼Œå› ä¸ºå®ƒæ˜¯å•ä¾‹çš„ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨`InvokeAsync`ä¸Šæ³¨å…¥äº†ä¸€ä¸ªæ—¥å¿—è®°å½•å™¨ä½œä¸ºä¾èµ–é¡¹ã€‚

æ ·æœ¬æ—¥å¿—è¾“å‡º:

```
11:38:09 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingAdHocMiddleware Warn Request 1 took 1ms
11:38:15 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingAdHocMiddleware Warn Request 2 took 0ms
11:38:19 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingAdHocMiddleware Warn Request 3 took 0ms 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†è®©æ‰€æœ‰è¿™äº›å·¥ä½œï¼Œæˆ‘ä»¬å½“ç„¶éœ€è¦åœ¨è¯·æ±‚å¤„ç†ç®¡é“ä¸­æ³¨å†Œä¸­é—´ä»¶:

`Startup.cs`

```
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    //...

    app.UseMiddleware<RequestTimingAdHocMiddleware>();

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#factorybased-activated-middleware)å·¥å‚æ¿€æ´»ä¸­é—´ä»¶

åŸºäºç±»çš„ä¸­é—´ä»¶çš„å¦ä¸€ä¸ªé€‰æ‹©æ˜¯å®ç°`IMiddleware`æ¥å£ã€‚ç»§ç»­æˆ‘ä»¬ç”¨äºåŸºäºçº¦å®šçš„æ–¹æ³•çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¾—åˆ°:

```
public class RequestTimingFactoryMiddleware : IMiddleware
{
    private readonly ILogger<RequestTimingFactoryMiddleware> _logger;
    private int _requestCounter; 

    public RequestTimingFactoryMiddleware(ILogger<RequestTimingFactoryMiddleware> logger)
    {
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        var watch = Stopwatch.StartNew();
        await next(context);
        watch.Stop();
        Interlocked.Increment(ref _requestCounter);
        _logger.LogWarning("Request {requestNumber} took {requestTime}ms", _requestCounter, watch.ElapsedMilliseconds);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é©¬ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ›´ä¼ ç»Ÿçš„ç±»å¸ƒå±€ï¼Œåœ¨æ„é€ å‡½æ•°å’Œå®ç°æ¥å£çš„`InvokeAsync`æ–¹æ³•ä¸­æ³¨å…¥äº†ä¾èµ–å…³ç³»ã€‚

åœ¨è¿™ç§ç±»å‹çš„ä¸­é—´ä»¶ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸç”±æˆ‘ä»¬å†³å®šï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ DI ä¸­æ³¨å†Œå®ƒï¼Œè€Œä¸ä»…ä»…æ˜¯åƒåœ¨åŸºäºçº¦å®šçš„ä¸­é—´ä»¶ä¸­é‚£æ ·åœ¨è¯·æ±‚å¤„ç†ç®¡é“ä¸­æ³¨å†Œã€‚

`Startup.cs`

```
public class Startup
{
    //...

    public void ConfigureServices(IServiceCollection services)
    {
        //...

        services.AddTransient<RequestTimingFactoryMiddleware>();

        //...
    }

    //...

    public void Configure(IApplicationBuilder app, IHostingEnvironment env)
    {
        //...

        app.UseMiddleware<RequestTimingFactoryMiddleware>();

        //...
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºè¯¥ç±»è¢«æ³¨å†Œä¸ºç¬æ€ç±»ï¼Œæ‰€ä»¥è¯·æ±‚è®¡æ•°å™¨ä¸ä¼šåœ¨è¯·æ±‚ä¹‹é—´ä¿æŒä¸å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ä¸‹é¢çš„æ—¥å¿—è¾“å‡º:

```
11:52:06 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingFactoryMiddleware Warn Request 1 took 0ms
11:52:07 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingFactoryMiddleware Warn Request 1 took 0ms
11:52:08 CodingMilitia.PlayBall.GroupManagement.Web.Demo.Middlewares.RequestTimingFactoryMiddleware Warn Request 1 took 0ms 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#apprun)appã€‚å¥”è·‘

å›åˆ°ä½¿ç”¨åŒ¿åå‡½æ•°ä½œä¸ºä¸­é—´ä»¶ï¼Œé™¤äº†`app.Use`æ‰©å±•æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜æœ‰`app.Run`ã€‚åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è¦å°†ä¸€ä¸ªå‡½æ•°æ³¨å†Œä¸ºç»ˆç«¯ä¸­é—´ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä¼šå°†è¯·æ±‚ä¼ é€’ç»™é“¾ä¸­ä»»ä½•è·Ÿåœ¨å®ƒåé¢çš„ä¸­é—´ä»¶ã€‚å®ƒåŸºæœ¬ä¸Šå’Œ`app.Use`ä¸€æ ·ï¼Œæ²¡æœ‰è°ƒç”¨è¿‡`next`å‚æ•°ğŸ˜›

ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨è¯·æ±‚å¤„ç†ç®¡é“é…ç½®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ«å°¾æ·»åŠ ä¸€äº›å†…å®¹:

`Startup.cs`

```
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    //...

    app.Run(async (context) =>
    {
        await context.Response.WriteAsync("No middlewares could handle the request");
    });    
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ä¸­é—´ä»¶èƒ½å¤Ÿå®Œå…¨å¤„ç†è¯·æ±‚ï¼Œç‰¹åˆ«æ˜¯ MVC ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬ä¼šå‘å‡ºä¸€ä¸ª(éå¸¸ç®€å•çš„)å“åº”é€šçŸ¥è¿™ä¸ªäº‹å®ã€‚

## [](#appmap-and-appmapwhen)appã€‚åœ°å›¾å’Œ appã€‚MapWhen

æˆ‘ä»¬å¯ç”¨çš„å¦ä¸€å¯¹æœ‰è¶£çš„æ‰©å±•æ–¹æ³•æ˜¯`Map`å’Œ`MapWhen`ã€‚è¿™äº›æ–¹æ³•å…è®¸æˆ‘ä»¬åœ¨ç»™å®šçš„æ¡ä»¶ä¸‹åœ¨è¯·æ±‚å¤„ç†ç®¡é“ä¸­åˆ›å»ºåˆ†æ”¯ã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€äº›ä¾‹å­ã€‚

### [](#appmap)appã€‚åœ°å›¾

`Map`å…è®¸æˆ‘ä»¬ä¸ºç»™å®šçš„è·¯å¾„åˆ†æ”¯ç®¡é“ã€‚

`Startup.cs`

```
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    //...

    app.Map("/ping", builder =>
    {
        builder.UseMiddleware<RequestTimingFactoryMiddleware>();
        builder.Run(async (context) => { await context.Response.WriteAsync("pong from path"); });
    }); 

    //... 
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºä¾‹ï¼Œå¯¹äºå¯¹`/ping`çš„ä»»ä½•è¯·æ±‚ï¼Œä¸éµå¾ªé€šå¸¸çš„ç®¡é“ï¼Œè€Œæ˜¯ä½¿ç”¨ lambda å‚æ•°ä¸­é…ç½®çš„ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬è®©ä¹‹å‰å¼€å‘çš„`RequestTimingFactoryMiddleware`æ‰§è¡Œï¼ŒåŠ ä¸Šä¸€ä¸ªç»ˆç«¯ä¸­é—´ä»¶ä»¥ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯å“åº”ã€‚

### [](#appmapwhen)appã€‚MapWhen

`MapWhen`çš„å·¥ä½œæ–¹å¼ä¸`Map`éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å®šä¹‰å…¶ä»–æ¡ä»¶ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶ä½¿ç”¨è·¯å¾„ã€‚ä¸ºäº†å®šä¹‰æ¡ä»¶ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è·å–ä¸€ä¸ª`HttpContext`å‚æ•°å¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦åº”è¯¥ä½¿ç”¨åˆ†æ”¯ã€‚

`Startup.cs`

```
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    //...

    app.MapWhen(
        context => context.Request.Headers.ContainsKey("ping"),
        builder =>
        {
            builder.UseMiddleware<RequestTimingAdHocMiddleware>();
            builder.Run(async (context) => { await context.Response.WriteAsync("pong from header"); });
        });

    //... 
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªä¾‹å­ä¸ä¸Šä¸€ä¸ªéå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ¡ä»¶æ¥æ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªåä¸º`ping`çš„è¯·æ±‚å¤´ã€‚å¦‚æœå¤´å­˜åœ¨ï¼Œé‚£ä¹ˆä½¿ç”¨åˆ†æ”¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…ˆå‰å®ç°çš„`RequestTimingAdHocMiddleware`,åŠ ä¸Šå¦ä¸€ä¸ªç»ˆç«¯ä¸­é—´ä»¶æ¥è¾“å‡ºä¸€ä¸ªç®€å•çš„å“åº”æ¶ˆæ¯ã€‚

## [](#outro)å…¶ä»–

è¿™æ ·åšæ˜¯ä¸ºäº†å¿«é€Ÿäº†è§£ä¸­é—´ä»¶çš„å®ç°ã€‚è¿™å¾ˆç®€å•ï¼Œæˆ‘è®¤ä¸ºæ²¡æœ‰ä»€ä¹ˆæ›´å¤æ‚çš„äº†ã€‚è¦æ„å»ºæ›´å¤æ‚çš„ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è®¾ç½®å®ƒä»¬çš„åˆå§‹æ­¥éª¤ä¸Šæ·»åŠ æ›´å¤šçš„é€»è¾‘ã€‚

æ­£å¦‚æˆ‘åœ¨æœ¬ç³»åˆ—çš„å…¶ä»–å¸–å­ä¸­æ‰€è¯´ï¼Œä¸æˆ‘å‘å¸ƒçš„è¿™äº›å¿«é€Ÿæµè§ˆç›¸æ¯”ï¼Œå®˜æ–¹çš„[æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-2.1)å¾ˆå¯èƒ½ä¼šæœ‰æ›´å¤šçš„ä¿¡æ¯ğŸ˜‰ã€‚

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode008)ã€‚

è¯·å‘é€ä»»ä½•åé¦ˆï¼Œä»¥ä¾¿æˆ‘å¯ä»¥æ”¹è¿›å’Œè°ƒæ•´ä¸‹ä¸€é›†ã€‚

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼