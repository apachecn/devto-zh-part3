# ä»…åœ¨å¿…è¦æ—¶åœ¨èŠ‚ç‚¹ä¸­é‡å»º

> åŸæ–‡:[https://dev . to/samthor/rebuild-only-when-needly-in-node-506 e](https://dev.to/samthor/rebuild-only-when-necessary-in-node-506e)

å¦‚æœä½ çš„é¡¹ç›®éœ€è¦ä¸€äº›æ—¶é—´æ¥å‡†å¤‡â€”â€”å¯èƒ½æ˜¯ç¼–è¯‘æˆ–è€…é‡å†™â€”â€”ä½ å¯èƒ½éœ€è¦ç­‰å¾…æ›´é•¿çš„æ—¶é—´ã€‚è¿™è®©æˆ‘ä»¬æƒ³åˆ°äº†è°·æ­Œçš„åœ£è¯è€äººè¿½è¸ªå™¨ğŸ…ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é—­åŒ…ç¼–è¯‘å™¨æ¥æ„å»ºå¤§å¤šæ•°æ¸¸æˆã€‚Closure æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¼˜åŒ–å™¨ï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä»¥é€Ÿåº¦è‘—ç§°ã€‚

æ‰€ä»¥è¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜æ˜¯:ç¼“æ…¢çš„æ„å»ºä¸€ç‚¹ä¹Ÿä¸å¥½ç©ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åªåœ¨éœ€è¦çš„æ—¶å€™è¿è¡Œå®ƒä»¬ï¼ğŸ‰

## [](#the-watch-primitive)æ‰‹è¡¨åŸå§‹äºº

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ NodeJS' `fs.watch`å‡½æ•°æ¥é€šçŸ¥æˆ‘ä»¬æ˜¯å¦å®é™…éœ€è¦ï¼Œè€Œä¸æ˜¯æ¯æ¬¡åŠ è½½ç¼–è¯‘åçš„èµ„æºæˆ–æ‰‹åŠ¨é‡æ–°è¿è¡Œè„šæœ¬æ—¶éƒ½æ„å»ºæ¸¸æˆã€åœºæ™¯æˆ–ä»£ç åº“ã€‚

ä»è¡¨é¢ä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥å‘Šè¯‰æ‚¨ç£ç›˜ä¸Šçš„æ–‡ä»¶ä½•æ—¶å‘ç”Ÿäº†å˜åŒ–ã€‚è¿™æ ·ç”¨:

```
const fs = require('fs');
fs.watch('yourfile.txt', (eventType, filename) => {
  // something happened to 'yourfile.txt': Â¯\_(ãƒ„)_/Â¯
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯ä¸€ä¸ªè¶…çº§æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒè¦æ±‚ä½ çš„æ“ä½œç³»ç»Ÿè®©*ä½ *çŸ¥é“ä»€ä¹ˆæ—¶å€™å‘ç”Ÿäº†å˜åŒ–(è€Œä¸æ˜¯åè¿‡æ¥ï¼Œä½ çš„ç¨‹åºå¿…é¡»ä¸æ–­æ£€æŸ¥)ã€‚

### [](#build-usage)æ„å»ºç”¨æ³•

å‡è®¾ä½ æ­£åœ¨ç¼–è¯‘ä¸€äº›å°‘äº†[CSS](http://lesscss.com)çš„æ–‡ä»¶ã€‚æ‚¨å¯ä»¥é€šè¿‡ç¼–è¯‘ä¸€ä¸ªæ–‡ä»¶`entrypoint.less`æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¯¥æ–‡ä»¶å…·æœ‰ä¾èµ–å…³ç³»:

```
const less = require('less');

less.render(`@import 'entrypoint.less';`).then((output) => {
  console.info(output.css);

  // contains all files that were imported, e.g:
  //   entrypoint.less => main.less => body.less
  // will result in ['entrypoint.less', 'main.less', 'body.less']
  const files = output.imports;
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Less å°†ä¸ºæˆ‘ä»¬æä¾›å®ƒåœ¨æ„å»ºä¸­ä½¿ç”¨çš„æ–‡ä»¶çš„ç®€å•åˆ—è¡¨ã€‚å…¶ä»–ä¸€äº›å·¥å…·å¯èƒ½ä¼šä¸ºæ‚¨æä¾›ä¸€ä¸ª[æºæ˜ å°„](https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map)ï¼Œå…¶ä¸­ä¹ŸåŒ…å«åŸå§‹æ–‡ä»¶çš„åç§°ã€‚

å¦‚æœè¿™äº›æ–‡ä»¶ä¸­çš„**ä»»ä½•ä¸€ä¸ª**å‘ç”Ÿå˜åŒ–ï¼Œæœ€ç»ˆè¾“å‡ºæ— æ•ˆï¼Œæˆ‘ä»¬è¦é‡æ–°æ„å»ºã€‚å®é™…ä¸Šï¼Œè¿™åªæ˜¯æ„å‘³ç€åœ¨æ¯ä¸ªæ–‡ä»¶ä¸Šè°ƒç”¨`fs.watch`:ğŸ‘€

```
 const files = output.imports;
  files.forEach((file) => {
    fs.watch(file, () => rebuildIsNeededCallback());
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™åœ¨æŠ€æœ¯ä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å®ƒå¹¶ä¸é€‚åˆæ•´ä¸ªæ„å»ºç³»ç»Ÿã€‚è¯·ç»§ç»­é˜…è¯»ï¼ğŸ˜„ğŸ‘

### [](#caveats)å‘Šè¯«

è™½ç„¶`fs.watch`æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å‡½æ•°ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸€äº›é™åˆ¶ã€‚è¿™äº›å¯ä»¥å½’ç»“ä¸ºå‡ ç‚¹:

*   å¹¶ä¸æ€»æ˜¯èƒ½ä¿è¯å‘Šè¯‰ä½ å“ªä¸ªæ–‡ä»¶å·²ç»è¢«ä¿®æ”¹äº†
*   åœ¨ Linuxã€macOS å’Œå…¶ä»–ç³»ç»Ÿä¸Šï¼Œ`fs.watch`è·Ÿåœ¨è¢«ç›‘è§†æ–‡ä»¶çš„*ç´¢å¼•èŠ‚ç‚¹*ä¹‹å
    *   ...å¦‚æœä¸€ä¸ªæ–‡ä»¶è¢«ç§»åŠ¨åˆ°äº†æ–°çš„ä½ç½®ï¼Œä½ ä¼šå¾—åˆ°é€šçŸ¥
    *   ...å¦‚æœä¸€ä¸ªæ–‡ä»¶è¢«*æ›¿æ¢äº†*ï¼Œä½ ä¼šè¢«é€šçŸ¥ä¸€æ¬¡ï¼Œä½†æ˜¯æ–°æ–‡ä»¶ä¸ä¼šè¢«è‡ªåŠ¨è§‚çœ‹
*   å½“ä½ ä¸å†éœ€è¦å®ƒçš„æ—¶å€™ï¼Œä½ éœ€è¦åœ¨ç»“æœä¸Šè°ƒç”¨`.close()`â€”â€”å¦‚æœä½ å¿˜è®°äº†ï¼Œä½ çš„ç¨‹åºå°†ä¿æŒæ‰“å¼€çš„ç›‘å¬å™¨

å®é™…ä¸Šï¼Œè¿™äº›è­¦å‘Šæ„å‘³ç€ä½ åº”è¯¥æŠŠæ¯ä¸ªå¯¹`fs.watch`çš„è°ƒç”¨ä½œä¸ºä¸€æ¬¡æ€§çš„æç¤ºäº‹æƒ…å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚ğŸ’­è¯·è¿™æ ·æƒ³:æ‚¨ä¸èƒ½ç¡®å®šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Œä½†è¿™å€¼å¾—ä¸€æŸ¥ï¼

å°†`fs.watch`è§†ä¸ºä¸€æ¬¡æ€§äº‹ä»¶çš„å¦ä¸€ä¸ªç†ç”±æ˜¯:å¦‚æœä½ çš„ä¾èµ–å…³ç³»*é€šè¿‡æ·»åŠ æˆ–åˆ é™¤æ–‡ä»¶è€Œæ”¹å˜äº†*ï¼Œé‡ç½®ä½ æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯èƒ½æ¯”è¯•å›¾ä¿æŒæœ€æ–°æ›´å®¹æ˜“ã€‚ğŸ¤“

## [](#watch-helper)æ‰‹è¡¨åŠ©æ‰‹

è®©æˆ‘ä»¬æŠŠä¸Šé¢çš„çŸ¥è¯†æ”¾åœ¨ä¸€ä¸ªå°åŠ©æ‰‹é‡Œï¼Œå½“ä»£ç å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šå¸®åŠ©ä½ *ä½¿*ä»£ç æ— æ•ˆã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨åœ£è¯è€äººè¿½è¸ªå™¨ä¸­æ‰€åšçš„ï¼›æˆ‘ä»¬ä¿ç•™æ„å»ºè¾“å‡ºï¼Œç›´åˆ°å®ƒä¸å†æœ‰æ•ˆ(å› ä¸ºåº•å±‚æºä»£ç å·²ç»æ”¹å˜)ã€‚

ğŸš¨ä½ å¯èƒ½ä¼šè¯´â€œä¸ºä»€ä¹ˆ*ä½¿*æ— æ•ˆï¼Œè€Œä¸åªæ˜¯è¿›è¡Œä¸€æ¬¡å®Œå…¨çš„é‡å»ºï¼Ÿâ€é™¤éä½ éœ€è¦å°½å¯èƒ½å¿«åœ°è¾“å‡ºï¼Œå¦åˆ™æ¯æ¬¡ä¿å­˜éƒ½è¦è¿è¡Œä¸€ä¸ªæ˜‚è´µçš„ç¼–è¯‘æ­¥éª¤ã€‚

å› æ­¤ï¼Œä¸‹é¢çš„`watch`æ–¹æ³•å°†æ¥å—ä¸€ä¸ªè·¯å¾„åˆ—è¡¨ï¼Œè§‚å¯Ÿå®ƒä»¬ï¼Œå¹¶åœ¨å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘ç”Ÿå˜åŒ–(æˆ–è€…è¶…æ—¶)æ—¶è°ƒç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°:

```
function watch(paths, done, timeout=0) {
  let watchers;
  let timeoutId;
  const finish = () => {
    // To finish, we close watchers (because it's not clear
    // what state they are in), cancel the timeout callback,
    // and let the user know something changed.
    watchers.forEach((w) => w.close());
    clearTimeout(timeoutId);
    done();
  };

  if (timeout > 0) {
    // If a timeout is given, 'succeed' after ~timeout. This is
    // useful to *always* rebuild or invalidate after a time.
    timeoutId = setTimeout(finish, timeout);
  }
  watchers = paths.map((p) => fs.watch(p, finish));
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€å®šè¦çœ‹ä¸€ä¸‹ä»£ç ğŸ‘†ï¼Œå› ä¸ºæˆ‘å·²ç»ç•™ä¸‹äº†ä¸€äº›è§£é‡Šå®ƒåšä»€ä¹ˆçš„è¯„è®ºã€‚è®©æˆ‘ä»¬æŠŠè¿™ä¸ªå’Œä¸Šé¢çš„ä¾‹å­æ”¾åœ¨ä¸€èµ·ã€‚

## [](#less-is-more)å°‘å³æ˜¯å¤š

é‚£ä¹ˆï¼Œå½“ä¾èµ–å…³ç³»æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿è¾“å‡ºæ— æ•ˆå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤ä¸ªæ–¹æ³•å’Œä¸€ä¸ªç¼“å­˜å˜é‡æ¥å®ç°è¿™ä¸€ç‚¹:

*   ç¡®ä¿åŒ…å«ç»“æœçš„`Promise`å¯ç”¨ï¼›å’Œ
*   `buildCSS`åœ¨éœ€è¦æ—¶å®é™…é‡å»º(å› ä¸ºè¿™æ˜¯`async`ï¼Œå®ƒè¿”å›ä¸€ä¸ª`Promise`)ã€‚

```
let compileCache;

async function buildCSS() {
  console.debug('rebuilding CSS...');
  const output = await less.render(`@import 'entrypoint.less';`);

  watch(output.imports, () => {
    compileCache = null;  // force a rebuild next time
  }, 60 * 1000);

  return output.css;
}

// call getCSS whenever you need CSS, and it'll always be up-to-date
function getCSS() {
  if (!compileCache) {
    compileCache = buildCSS();
  }
  return compileCache;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼Œåªç¼“å­˜ä¸€ä¸ªç»“æœ:å¦‚æœæ‚¨æƒ³æ‰©å±•å®ƒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè¾“å‡ºå­—å…¸ï¼Œå¦‚æœå®ƒä»¬çš„ä¾èµ–å…³ç³»å‘ç”Ÿå˜åŒ–ï¼Œæ¯ä¸ªè¾“å‡ºéƒ½å¯ä»¥å¤±æ•ˆã€‚

### [](#finally)ç»ˆäº

ä¸ºäº†æœ€ç»ˆå°†`getCSS`è¿æ¥åˆ°è¿™ä¸ªä¸–ç•Œï¼Œæˆ‘ç°åœ¨å°†å‘æ‚¨æœ€å–œæ¬¢çš„ NodeJS æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œè¿™æ ·å½“æˆ‘åŠ è½½æ¯”å¦‚è¯´`/compiled.css`æ—¶ï¼Œå®ƒå°†è¿”å›`getCSS`çš„ç»“æœï¼Œç¡®ä¿ç¼–è¯‘åçš„ç‰ˆæœ¬æ€»æ˜¯æœ€æ–°çš„ã€‚åœ¨[æ³¢å°”å¡](https://github.com/lukeed/polka)ä¸­ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒ:

```
polka()
  .get('/compiled.css', (req, res) => {
    res.end(getCSS());
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ æƒ³çŸ¥é“æ›´å¤šä½ å¯ä»¥å®‰è£…å¼€å‘æœåŠ¡å™¨æ¥åšè¿™ä»¶äº‹çš„æ–¹æ³•ï¼Œè¯·åœ¨ä¸‹é¢å‘Šè¯‰æˆ‘ï¼ğŸ’¬

## [](#thanks)æ„Ÿè°¢

å¦‚æœä½ ç›´æ¥ä½¿ç”¨ä¸€ä¸ªç°ä»£çš„æ‰“åŒ…ç³»ç»Ÿ(æˆ–è€…æ„å»ºå·¥å…·)ï¼Œé‚£ä¹ˆè¿™ä¸ªå·¥å…·å¯èƒ½å·²ç»åœ¨ä½¿ç”¨`fs.watch`äº†ã€‚ç„¶è€Œï¼Œæˆ‘ä»ç„¶å¸Œæœ›æ‚¨å·²ç»äº†è§£äº†å¦‚ä½•ä½¿ç”¨`fs.watch`æ¥æ”¹è¿›æ‚¨çš„æ„å»ºç³»ç»Ÿï¼

è¯´å¥é¢˜å¤–è¯:æˆ‘ä¸ªäººå·²ç»ä¸å†ä½¿ç”¨åƒ`gulp`å’Œ`grunt`è¿™æ ·çš„æ„å»ºå·¥å…·ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨å®šåˆ¶çš„æ„å»ºå·¥å…·*æˆ–è€…æŒ‰éœ€æ‰§è¡Œç¼–è¯‘çš„*ç½‘ç»œæœåŠ¡å™¨(ç”±`fs.watch`æä¾›æ”¯æŒï¼Œå°±åƒæˆ‘ä»¬åœ¨åœ£è¯è€äººè¿½è¸ªå™¨ä¸­æ‰€åšçš„é‚£æ ·)ã€‚

one