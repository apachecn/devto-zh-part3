# ä½¿ç”¨ SQLAlchemy è¡¨è¾¾å¼è¯­è¨€ä½œä¸º Python ä»£ç è¿›è¡ŒæŸ¥è¯¢

> åŸæ–‡:[https://dev . to/hackersandslackers/queries-as-python-code-with-sqlalchemys-expression-language-4c CD](https://dev.to/hackersandslackers/queries-as-python-code-with-sqlalchemys-expression-language-4ccd)

[![Queries as Python Code with SQLAlchemy's Expression Language](../Images/06279150528ba5b14f3590d9c1c27273.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--wiMqO2t0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://hackersandslackers-cdn.storage.googleapis.com/2019/07/sqlalchemy-queries.jpg)

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ SQLAlchemy ä¹‹æ—…å·²ç»æ¶µç›–äº†ç®¡ç†æ•°æ®åº“è¿æ¥å’Œæ¨¡å‹åˆ›å»ºã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¦‚ä½•ä»æ•°æ®åº“ä¸­æå–æˆ‘ä»¬æƒ³è¦çš„æ•°æ®å‘¢ï¼Ÿ

SQLAlchemy çš„ ORM æŸ¥è¯¢ API ç®€åŒ–äº†æˆ‘ä»¬ç¼–å†™æ•°æ®åº“æŸ¥è¯¢çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†æ£€ç´¢æ•°æ®çš„æ–¹æ³•é“¾æ¥åœ¨ä¸€èµ·ï¼Œåœ¨ SQLAlchemy ä¼šè¯ä¸Šæ„é€ æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯ç¼–å†™åŸå§‹çš„ SQL æŸ¥è¯¢ã€‚æˆ‘ä»¬å°†æ·±å…¥ SQLAlchemy ä¸°å¯Œçš„æŸ¥è¯¢ APIï¼Œäº†è§£æŸ¥è¯¢æ•°æ®çš„æ‰€æœ‰æ–¹æ³•ã€‚

### [](#create-a-session)åˆ›å»ºä¼šè¯

æˆ‘ä»¬åœ¨ä¹‹å‰çš„[å¸–å­](https://hackersandslackers.com/implement-sqlalchemy-orm/)ä¸­ä»‹ç»äº† SQLAlchemy ä¼šè¯åˆ›å»ºï¼Œå¹¶åœ¨ä¹‹å‰çš„å¸–å­[ä¸­è§£é‡Šäº†å¼•æ“çš„æ¦‚å¿µã€‚å¦‚æœä½ è·³è¿‡äº†è¿™äº›å¸–å­ï¼Œä¸è¦ã€‚ä»¥ä¸‹ä¸ºæ–‡æ¡ˆ+é¢é£Ÿç¤¼é‡:](https://hackersandslackers.com/python-database-management-sqlalchemy/) 

<figure>

```
"""Database engine & session creation."""
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine(
    'mysql+pymysql://user:password@host:3600/database',
    echo=True
)
Session = sessionmaker(bind=engine)
session = Session() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>database.py</figcaption>

</figure>

## [](#basic-query-syntax)åŸºæœ¬æŸ¥è¯¢è¯­æ³•

è®©æˆ‘ä»¬å¿«é€Ÿç†Ÿæ‚‰ä¸€ä¸‹ SQLAlchemy çš„æŸ¥è¯¢ API çš„åŸºæœ¬ç»“æ„ã€‚SQLAlchemy **session** å¯¹è±¡æœ‰ä¸€ä¸ª`query()`æ–¹æ³•ï¼Œå®ƒæ¥å—æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„æ•°æ®æ¨¡å‹çš„ *raw* ç±»ã€‚ä¸‹é¢æ˜¯åœ¨`Customer`æ¨¡å‹ä¸Šè¿è¡Œçš„ä¸€ä¸ªæŸ¥è¯¢çš„å¼€å§‹ï¼›æˆ–è€…æ¢å¥è¯è¯´ï¼Œå¯¹**å®¢æˆ·** SQL è¡¨çš„æŸ¥è¯¢:

<figure>

```
"""Construct database queries from SQLAlchemy sessions."""
from .database import session
from .models import Customer

# Example structure of an ORM query records = session
    .query(Customer)
    .FUNCTION() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Select records from a SQLAlchemy session</figcaption>

</figure>

åœ¨æˆ‘ä»¬çš„**ä¼šè¯**ä¸­è°ƒç”¨`.query(Customer)`ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æŸ¥è¯¢ï¼Œç›´åˆ°æˆ‘ä»¬å‘é“¾ä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚æ‰€æœ‰ä¼šè¯æŸ¥è¯¢éƒ½ä»¥å½¢æˆ/é¢„æµ‹æŸ¥è¯¢ç»“æœçš„æœ€ç»ˆæ–¹æ³•ç»“æŸ:

*   `all()`å°†è¿”å›*æ‰€æœ‰ä¸æˆ‘ä»¬çš„æŸ¥è¯¢åŒ¹é…çš„*è®°å½•ä½œä¸ºå¯¹è±¡åˆ—è¡¨ã€‚å¦‚æœæˆ‘ä»¬åœ¨ä¸Šé¢çš„æŸ¥è¯¢ä¸­ä½¿ç”¨ **all** ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°æ‰€æœ‰ Python æ•°æ®ç±»å‹ä¸º`List[Customer]`çš„å®¢æˆ·è®°å½•ã€‚
*   `first()`è¿”å›ä¸æŸ¥è¯¢åŒ¹é…çš„ç¬¬*æ¡*è®°å½•ï¼Œä¸ç®¡æœ‰å¤šå°‘æ¡è®°å½•ä¸æŸ¥è¯¢åŒ¹é…(ä»€ä¹ˆæ„æˆâ€œç¬¬ä¸€æ¡â€å–å†³äºæ‚¨çš„è¡¨æ˜¯å¦‚ä½•æ’åºçš„)ã€‚è¿™ç›¸å½“äºå°†`LIMIT 1`æ·»åŠ åˆ° SQL æŸ¥è¯¢ä¸­ã€‚ç»“æœï¼Œè¿”å›çš„ Python ç±»å‹å°†æ˜¯`Customer`ã€‚
*   `one()`å¯¹äºæˆ‘ä»¬æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢ä¸­æœ€å¤šåº”è¯¥å­˜åœ¨ä¸€æ¡è®°å½•çš„æƒ…å†µéå¸¸æœ‰ç”¨(æƒ³è±¡ä¸€ä¸‹é€šè¿‡ä¸»é”®è¿›è¡ŒæŸ¥è¯¢)ã€‚åœ¨åˆ›å»ºè®°å½•ä¹‹å‰éªŒè¯è®°å½•æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè¿™ç§è¯­æ³•éå¸¸æœ‰ç”¨ã€‚
*   å¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ï¼Œ`scalar()`è¿”å›å•ä¸ªå€¼ï¼Œå¦‚æœæ²¡æœ‰å€¼ï¼Œåˆ™ **None** ï¼Œå¦‚æœè¿”å›å¤šä¸ªè®°å½•ï¼Œåˆ™å¼•å‘å¼‚å¸¸ã€‚
*   `get([VALUE(S)])`æ ¹æ®æ¨¡å‹çš„ä¸»é”®è¿›è¡Œæœç´¢ï¼Œä»¥è¿”å›ä¸»é”®ç­‰äºæ‰€æä¾›å€¼çš„è¡Œã€‚åœ¨éœ€è¦æœç´¢å¤šä¸ªå¤–é”®çš„æƒ…å†µä¸‹ï¼Œ`get()`ä¹Ÿæ¥å—å…ƒç»„ã€‚æœ€åï¼Œ`get()`èƒ½å¦*ä¹Ÿèƒ½*æ¥å—å­—å…¸å¹¶è¿”å›åˆ—(å­—å…¸é”®)ä¸æä¾›çš„å€¼åŒ¹é…çš„è¡Œã€‚

ä¸ºäº†åˆ›å»ºæ›´å¤æ‚çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬å°†é€šè¿‡åœ¨åŸå§‹æŸ¥è¯¢ä¸Šé“¾æ¥æ–¹æ³•æ¥æ·»åŠ æŸ¥è¯¢:

<figure>

```
"""Construct database queries from SQLAlchemy sessions."""
from .database import session
from .models import Customer

# Example structure of an ORM query records = session
    .query(Customer)
    .METHOD_1()
    .METHOD_2()
    .FUNCTION() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Complex SELECT query</figcaption>

</figure>

### [](#query-results)æŸ¥è¯¢ç»“æœ

å¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªè¿”å›å¤šæ¡è®°å½•çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦éå†å®ƒä»¬æ¥æŸ¥çœ‹ç»“æœ:

<figure>

```
"""Construct database queries from SQLAlchemy sessions."""
from .database import session
from .models import Customer

# Fetch all customer records records = session
    .query(Customer)
    .all()

# Loop over records for record in records:
    print(record) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Fetch all customer records and print the output</figcaption>

</figure>

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSQLAlchemy ORM å°†è¿”å›ä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œè¿™æ„å‘³ç€ä¸Šè¿°æ“ä½œå°†äº§ç”Ÿä»¥ä¸‹è¾“å‡º:

<figure>

```
<Customer model 1>
<Customer model 2>
<Customer model 3>
<Customer model 4>
<Customer model 5>
<Customer model 6>
<Customer model 7>
<Customer model 8>
<Customer model 9>
<Customer model 10> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output of a session query</figcaption>

</figure>

å¦‚æœä½ æƒ³å¾—åˆ°å­—å…¸ï¼Œä½¿ç”¨å†…ç½®çš„`__dict__`æ–¹æ³•:

<figure>

```
...

records = session
    .query(Customer)
    .all()

for record in records:
    pp.pprint(record. __dict__ ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>View query results as dictionaries</figcaption>

</figure>

ç›¸åï¼Œè¿™å°†ä¸ºæ¯ä¸€è¡Œè¿”å›å­—å…¸å¯¹è±¡:

<figure>

```
{ '_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7f98c8221748>,
    'email': 'kpaladini5i@senate.gov',
    'first_name': 'Kenna',
    'id': 199,
    'join_date': datetime.datetime(2019, 4, 19, 0, 0),
    'last_name': 'Paladini',
    'preferred_language': 'Bulgarian'}
{ '_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7f9918192d68>,
    'email': 'rlebrun5j@narod.ru',
    'first_name': 'Rriocard',
    'id': 200,
    'join_date': datetime.datetime(2015, 6, 8, 0, 0),
    'last_name': 'Le Brun',
    'preferred_language': 'Khmer'},
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output of a session query as dictionaries</figcaption>

</figure>

å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼Œåªæ¥æ”¶æ‚¨æƒ³è¦/éœ€è¦çš„åˆ—:

<figure>

```
...

# Fetch all customers records = session.query(Customer).all()

# Loop through records for record in records:
    recordObject = {
        'name': record.name,
        'position': record.position,
        'team_name': record.team.name,
        'team_city': record.team.city
    }
    print(recordObject) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Deserialize results of a query</figcaption>

</figure>

è¿™è¾“å‡ºäº†ä¸€äº›æ›´æ¸…æ™°çš„ä¸œè¥¿:

<figure>

```
{ 'email': 'kpaladini5i@senate.gov',
    'first_name': 'Kenna',
    'join_date': datetime.datetime(2019, 4, 19, 0, 0),
    'last_name': 'Paladini',
    'preferred_language': 'Bulgarian'}
{ 'email': 'rlebrun5j@narod.ru',
    'first_name': 'Rriocard',
    'join_date': datetime.datetime(2015, 6, 8, 0, 0),
    'last_name': 'Le Brun',
    'preferred_language': 'Khmer'},
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output of query deserialization</figcaption>

</figure>

## [](#filtering-results)è¿‡æ»¤ç»“æœ

å¯èƒ½åœ¨æŸ¥è¯¢ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯`filter()`æ–¹æ³•ã€‚`filter()`ç›¸å½“äº SQL **WHERE** å­å¥ï¼Œåªè¿”å›ç¬¦åˆæˆ‘ä»¬æƒ³è¦çš„æ¡ä»¶çš„è¡Œ:

<figure>

```
...

# Fetch records where `first_name` is `Carl` records = session
    .query(Customer)
    .filter(Customer)
    .first_name == 'Carl')
    .all() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Select all customers named Carl</figcaption>

</figure>

### [](#filterby)filter_by()

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`filter_by()`æ–¹æ³•ç¼–å†™ä¸Šé¢çš„æŸ¥è¯¢ï¼Œå°±åƒè¿™æ ·:

<figure>

```
...

# Fetch records where `first_name` is `Carl` records = session
    .query(Customer)
    .filter_by(first_name="Carl")
    .all() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Filter with `filter_by`</figcaption>

</figure>

ä¸`filter()`ä¸åŒï¼Œ`filter_by()`æ¥å—å…³é”®å­—å‚æ•°(æ³¨æ„è¿™é‡Œçš„è¯­æ³•å·®å¼‚:`filter()`æ£€æŸ¥é’ˆå¯¹åˆ—å¯¹è±¡çš„æ¡ä»¶ï¼Œè€Œ`filter_by()`æŸ¥æ‰¾åŒ¹é…æˆ‘ä»¬ä¼ é€’çš„å‚æ•°çš„åˆ—)ã€‚`filter_by()`åªèƒ½æœç´¢ç²¾ç¡®çš„å€¼ï¼Œæ˜¯ç®€å•è¿‡æ»¤æŸ¥è¯¢çš„ä¸€ç§ç®€å†™æ–¹å¼ã€‚

### [](#like)å–œæ¬¢()

æˆ‘ä»¬å¯ä»¥åšçš„ä¸ä»…ä»…æ˜¯è¿‡æ»¤ç®€å•çš„æ¡ä»¶ã€‚SQLAlchemy æœ‰ä¸€ä¸ª`like()`æ–¹æ³•ï¼Œå…¶å·¥ä½œæ–¹å¼ä¸ SQL çš„`LIKE` :
ç›¸åŒ

<figure>

```
...

# Fetch records where `first_name` begins with the letter `J` records = session
    .query(Customer)
    .filter(Customer.first_name.like('J%'))
    .all() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Select customer records where first names begin with "J"</figcaption>

</figure>

æ­£å¦‚æ‰€æ–™ï¼Œè¿™å°†ç»™å‡ºå®¢æˆ·åå­—ä»¥ **J** :
å¼€å¤´çš„æ‰€æœ‰è¡Œ

<figure>

```
{ 'email': 'jpugsley9@netvibes.com',
    'first_name': 'Jarid',
    'join_date': datetime.datetime(2017, 10, 11, 0, 0),
    'last_name': 'Pugsley',
    'preferred_language': 'Burmese'}
{ 'email': 'jdymockek@is.gd',
    'first_name': 'Jeanna',
    'join_date': datetime.datetime(2017, 11, 13, 0, 0),
    'last_name': 'Dymocke',
    'preferred_language': 'Malayalam'}
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output</figcaption>

</figure>

### [](#highlevel-query-methods)é«˜å±‚æŸ¥è¯¢æ–¹å¼

é™¤äº†`filter()`ä¹‹å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªæˆ‘ä»¬åº”è¯¥ç†Ÿæ‚‰çš„åŸºæœ¬æ–¹æ³•ã€‚å…¶ä¸­æ¯ä¸ªéƒ½å¯¹åº”äºæ‚¨å¯èƒ½ç†Ÿæ‚‰çš„ SQL å…³é”®å­—:

*   `limit([INTEGER])`:å°†è¡Œæ•°é™åˆ¶ä¸ºæ‰€æä¾›çš„æœ€å¤§å€¼ã€‚
*   `order_by([COLUMN])`:æŒ‰æä¾›çš„åˆ—å¯¹ç»“æœè¿›è¡Œæ’åºã€‚
*   `offset([INTEGER])`:ä»ç¬¬*è¡Œç¬¬ n* è¡Œå¼€å§‹æŸ¥è¯¢ã€‚

ä¸‹ä¸€éƒ¨åˆ†åŒ…æ‹¬æ‰§è¡Œæ¨¡å‹ä¹‹é—´çš„è¿æ¥æŸ¥è¯¢ï¼Œè¿™è¦æ±‚æˆ‘ä»¬é¦–å…ˆå®šä¹‰æ¨¡å‹ä¹‹é—´çš„å…³ç³»ã€‚ç›®å‰äº‹æƒ…æœ‰ç‚¹æ··ä¹±ï¼Œå› ä¸ºæˆ‘å®é™…ä¸Šè¦åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« çš„[æ‰æŠ¥é“è¿™ä¸ªã€‚æŠ±æ­‰ï¼Œè¿™é‡Œå¾ˆä¹±ï¼Œæˆ‘æ­£åœ¨åŠªåŠ›ï¼](https://hackersandslackers.com/sqlalchemy-data-models)

## [](#performing-joins-amp-unions)æ‰§è¡ŒåŠ å…¥&å·¥ä¼š

æˆ‘ä»¬ä¹‹å‰å·²ç»æ¶‰åŠåˆ°äº†ä¸€äº›è¿æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬å°†æŠŠå®ƒæå‡ä¸€ä¸ªæ¡£æ¬¡ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ­£åœ¨ä½¿ç”¨çš„æ•°æ®æ¨¡å‹:ä¸€ä¸ªç”¨äº**å®¢æˆ·**ï¼Œä¸€ä¸ªç”¨äº**è®¢å•**ã€‚æ¯ä½é¡¾å®¢

<figure>

```
...
import pprint
from .models import Order, Customer

pp = pprint.PrettyPrinter(indent=4)

# Execute a SELECT query on JOINed tables records = session
    .query(Customer)
    .join(Order, Order.customer_id == Customer.id)
    .all()

# Loop through results for record in records:
    record_object = {
        'first_name': record.first_name,
        'last_name': record.last_name,
        'email': record.email,
        'preferred_language': record.preferred_language,
        'join_date': record.join_date,
        'orders': []
    }
    for order in record.order:
        order = {
            'order_price': order.price,
            'currency': order.currency,
            'purchase_date': order.purchase_date,
            'product': order.product
        }
        record_object['orders'].append(order)
        pp.pprint(record_object) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Join records from different tables and deserialize records</figcaption>

</figure>

æˆ‘ä»¬ä½¿ç”¨`join()`æ–¹æ³•æ‰§è¡Œè¿æ¥ã€‚æˆ‘ä»¬ä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬å°†åœ¨â€œå³è¾¹â€åŠ å…¥çš„æ•°æ®æ¨¡å‹ç„¶åæˆ‘ä»¬æŒ‡å®šæˆ‘ä»¬å°†åŠ å…¥çš„å†…å®¹:æˆ‘ä»¬çš„**è®¢å•**æ¨¡å‹çš„ **customer_id** åˆ—ï¼Œä»¥åŠæˆ‘ä»¬çš„**å®¢æˆ·**æ¨¡å‹çš„ **id** åˆ—ã€‚

æˆ‘ä»¬çš„å¤–éƒ¨å¾ªç¯ç»™æˆ‘ä»¬æ¯ä¸ªå®¢æˆ·ï¼Œæˆ‘ä»¬çš„å†…éƒ¨å¾ªç¯å°†æ¯ä¸ªè®¢å•æ·»åŠ åˆ°é€‚å½“çš„å®¢æˆ·ã€‚æŸ¥çœ‹ä¸€ä¸ªç¤ºä¾‹è®°å½•:

<figure>

```
{ 'email': 'jtinline16@arizona.edu',
    'first_name': 'Jerry',
    'join_date': datetime.datetime(2016, 10, 27, 0, 0),
    'last_name': 'Tinline',
    'preferred_language': 'Icelandic',
    'orders': [{'currency': 'IDR',
                'order_price': 34.24,
                'product': 'Beer - Corona',
                'purchase_date': datetime.datetime(2019, 5, 5, 0, 0)},
               {'currency': 'GEL',
                'order_price': 25.75,
                'product': 'Creamers - 10%',
                'purchase_date': datetime.datetime(2019, 1, 27, 0, 0)}]} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output</figcaption>

</figure>

æˆ‘ä»¬çš„æœ‹å‹ Jerry æœ‰ä¸¤ä»½è®¢å•:ä¸€ä»½æ˜¯ä¸€äº› Coronasï¼Œå¦ä¸€ä»½æ˜¯ creamersã€‚å¼€å§‹å§ï¼Œæ°ç‘ã€‚

### [](#outer-joins)å¤–éƒ¨è”æ¥

é™¤äº†ç®€å•çš„è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯­æ³•æ‰§è¡Œå¤–éƒ¨è¿æ¥:

<figure>

```
...
from .models import ExampleModel1, ExampleModel2

# Execute an outer JOIN records = session
    .query(ExampleModel1)
    .outerjoin(ExampleModel2)
    .all() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Perform an outer join</figcaption>

</figure>

### [](#unions)å·¥ä¼š

æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡Œ UNION å’Œ UNION all:

<figure>

```
...
from .models import ExampleModel1, ExampleModel2

# Execute a UNION records = ExampleModel1.union(ExampleModel2) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Perform a union</figcaption>

</figure>

è¦æ‰§è¡Œ union allï¼Œåªéœ€ç”¨`union_all()`æ›¿æ¢`union()`ï¼

## [](#aggregate-functions-and-stats)èšåˆå‡½æ•°å’Œç»Ÿè®¡æ•°æ®

ä¸æ‰€æœ‰ç±»ä¼¼ SQL çš„æŸ¥è¯¢è¯­è¨€ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡Œä¸€äº›èšåˆç»Ÿè®¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·:

*   `count([COLUMN])`:ç»Ÿè®¡ä¸€åˆ—ä¸­çš„è®°å½•æ•°ã€‚
*   `count(distinct([COLUMN]))`:ç»Ÿè®¡ä¸€åˆ—ä¸­*æ¡ä¸åŒçš„*æ¡è®°å½•çš„æ•°é‡ã€‚
*   `sum([COLUMN])`:å°†ä¸€åˆ—ä¸­çš„æ•°å€¼ç›¸åŠ ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬å¦‚ä½•æ‰§è¡Œä¸€ä¸ªå¯¹ä¸€åˆ—ä¸­çš„å€¼è¿›è¡Œè®¡æ•°çš„æŸ¥è¯¢:

<figure>

```
...
from sqlalchemy import func

# Count number of records with a `first_name` value records = session
    .query(func.count(Customer.first_name))
    .all()   

for record in records:
    print(record) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Aggregate queries</figcaption>

</figure>

å“ªäº›è¾“å‡º:

<figure>

```
(200,) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Output</figcaption>

</figure>

è¿™ä¸ªæŸ¥è¯¢å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹ä¸ºåªè®¡ç®—ä¸åŒçš„å€¼:

<figure>

```
...
from sqlalchemy import func
from sqlalchemy import distinct

# Count number of DISTINCT `first_name` values records = session
    .query(func.count(distinct(Customer.first_name)))
    .all()

for record in records:
    print(record) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Query to aggregate distinct results</figcaption>

</figure>

### [](#using-groupby)ä½¿ç”¨ Group_by()

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹åŸºäºèšåˆçš„æŸ¥è¯¢ä½¿ç”¨`group_by()`æ–¹æ³•ã€‚`group_by()`çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äºæˆ‘ä»¬å¯¹ SQL å’Œ Pandas çš„æœŸæœ›:

<figure>

```
...

# Execute a `GROUP BY` aggregation query records = session
    .query(func.count(Customer.first_name))
    .group_by(Customer.first_name)
    .all() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>"Group by" aggregation</figcaption>

</figure>

## [](#mutations)çªå˜

æˆ‘ä»¬å·²ç»èŠ±äº†å¤§é‡çš„æ—¶é—´æ¥ç ”ç©¶å¦‚ä½•ä»æ•°æ®åº“ä¸­æå–æ•°æ®ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ˆåˆ°ä¿®æ”¹æˆ‘ä»¬çš„æ•°æ®ï¼æˆ‘ä»¬ä»Šå¤©è®®ç¨‹çš„æœ€åä¸€é¡¹æ˜¯ç ”ç©¶å¦‚ä½•ä½¿ç”¨ SQLAlchemy ORM æ·»åŠ ã€åˆ é™¤å’Œæ›´æ”¹è®°å½•ã€‚

### [](#inserting-rows)æ’å…¥è¡Œ

æˆ‘ä»¬æ·»åŠ æ•°æ®çš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`add()`æ–¹æ³•ã€‚`add()`æœŸæœ›ä¸€ä¸ªç±»çš„å®ä¾‹(ç‰¹åˆ«æ˜¯æ•°æ®æ¨¡å‹)è¢«ä¼ é€’ï¼Œå¹¶å°†åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¡Œä½œä¸ºç»“æœ:

<figure>

```
from .database import session
from .models import Customer

# Inserting records via data models customer = Customer(
    first_name='Todd',
    last_name='Birchard',
    email='fake@example.com',
    preferred_language='English',
    join_date=datetime.now()
)
session.add(customer)
session.commit() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Insert records via ORM</figcaption>

</figure>

æ·»åŠ æ•°æ®çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`insert()`æ–¹æ³•ã€‚ä¸`add()`ä¸åŒï¼Œ`insert()`åœ¨ SQLAlchemy **è¡¨**å¯¹è±¡ä¸Šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”ä¸ä¾èµ–äºæ¥æ”¶æ•°æ®æ¨¡å‹ã€‚`insert()`ä¸æ˜¯ ORM çš„ä¸€éƒ¨åˆ†:

<figure>

```
...

# Inserting records via SQLAlchemy `Table` objects insert = [TABLE]
    .insert()
    .values(
        first_name='Todd',
        last_name='Jack Jones',
        email='fake@example.com',
        preferred_language='English',
        join_date=datetime.now()
    ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Insert records</figcaption>

</figure>

### [](#updating)æ›´æ–°

åŸºäº`insert()`çš„è¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åŠ å…¥`update()`æ–¹æ³•æ¥æ›´æ”¹ç°æœ‰è®°å½•çš„å€¼ã€‚æˆ‘ä»¬ç”¨`where()`æ–¹æ³•æ¥æŒ‡å®šå“ªäº›è¡Œåº”è¯¥è¢«æ›´æ–°:

<figure>

```
...

# Updating records via SQLAlchemy `Table` objects result = [TABLE]
    .update()
    .where([TABLE].c.name == 'Todd')
    .values(email='newemail@example.com') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Update records</figcaption>

</figure>

### [](#deleting)åˆ é™¤

åœ¨æˆ‘ä»¬æ‰§è¡Œçš„ä»»ä½•æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ `delete()`æ–¹æ³•æ¥åˆ é™¤è¯¥æŸ¥è¯¢ä¸­åŒ…å«çš„*æ‰€æœ‰è¡Œ*(å°å¿ƒï¼).ä¸‹é¢çš„ä»£ç åˆ é™¤äº†**åå­—**åˆ—åŒ…å«å€¼â€œå¡å°”â€çš„æ‰€æœ‰è®°å½•:

<figure>

```
...

# Delete records where `first_name` is `Carl` result = session
    .query(Customer)
    .filter(Customer.first_name == 'Carl')
    .delete() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figcaption>Delete records</figcaption>

</figure>

`delete()`æ¥å— **synchronize_session** å‚æ•°ï¼Œè¯¥å‚æ•°å†³å®šå¦‚ä½•å¤„ç†åˆ é™¤:

*   åœ¨æäº¤ä¼šè¯ä¹‹å‰ï¼Œ`False`ä¸ä¼šæ‰§è¡Œåˆ é™¤ã€‚
*   `'fetch'`é€‰æ‹©æ‰€æœ‰è¦åˆ é™¤çš„è¡Œï¼Œå¹¶åˆ é™¤åŒ¹é…çš„è¡Œã€‚
*   `'evaluate'`å°†è¯„ä¼°å½“å‰ä¼šè¯ä¸­çš„å¯¹è±¡ï¼Œä»¥ç¡®å®šåº”åˆ é™¤å“ªäº›è¡Œã€‚

## [](#never-stop-exploring%E2%84%A2)æ°¸ä¸åœæ­¢æ¢ç´¢

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬çœç•¥äº†å¾ˆå¤šå†…å®¹ã€‚è¿˜æœ‰å¾ˆå¤šå¾ˆé…·çš„æ–¹æ³•å¯ä»¥æ¢ç´¢ï¼Œæ¯”å¦‚`correlate()`æ–¹æ³•ã€‚åœ¨ SQLAlchemy ä¸­ï¼Œä½ ç°åœ¨å·²ç»è¶³å¤Ÿå±é™©äº†ï¼Œä½†æ˜¯æˆ‘é¼“åŠ±ä»»ä½•äººæµè§ˆä¸€ä¸‹[æŸ¥è¯¢æ–‡æ¡£](https://docs.sqlalchemy.org/en/13/orm/query.html)ï¼Œæ‰¾åˆ°æˆ‘ä»¬åœ¨è¿™é‡Œæ²¡æœ‰è¯¦ç»†è®¨è®ºçš„é…·ä¸œè¥¿ã€‚

æˆ‘ä»åœ¨åŠªåŠ›å°†è¿™ç¯‡æ–‡ç« çš„æºä»£ç æ”¾åœ¨ä¸‹é¢çš„ Github repo ä¸­ã€‚å‰å‡ ç« çš„èµ„æ–™ä¹Ÿå¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°ã€‚åŒæ—¶ï¼Œæˆ‘ä¸ºæˆ‘çš„ç³Ÿç³•è¡¨ç°é“æ­‰:

## ![GitHub logo](../Images/75095a8afc1e0f207cda715962e75c8d.png)/[sqlalchemy-tutorial](https://github.com/hackersandslackers/sqlalchemy-tutorial)

### ğŸ§ªğŸ”¬ä½¿ç”¨ SQLAlchemy è¿æ¥ã€æŸ¥è¯¢å…³ç³»æ•°æ®åº“å¹¶ä¸ä¹‹äº¤äº’ã€‚

<article class="markdown-body entry-content container-lg" itemprop="text">

# SQLAlchemy æ•™ç¨‹

[![Python](../Images/91eac0264bc3c2568bdd56361da1d1ae.png)](https://camo.githubusercontent.com/0b153563dd844ea8bbae9bf9d219c0d9930aa35e7d2ed0e07638a2caa3745902/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f507974686f6e2d76253545332e382d626c75652e7376673f6c6f676f3d707974686f6e266c6f6e6743616368653d74727565266c6f676f436f6c6f723d776869746526636f6c6f72423d356538316163267374796c653d666c61742d73717561726526636f6c6f72413d346335363661)[![SQLAlchemy](../Images/1723cabc44962dff2d2950b3c1d95405.png)](https://camo.githubusercontent.com/424e1a71c7e887f61c0f663ed11eab714a5dc2f4b93862cfd20eeab74517b58f/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f53514c416c6368656d792d76253545312e342e302d626c75652e7376673f6c6f6e6743616368653d74727565266c6f676f3d707974686f6e267374796c653d666c61742d737175617265266c6f676f436f6c6f723d776869746526636f6c6f72423d35653831616326636f6c6f72413d346335363661)[![PyMySQL](../Images/3feff7a175a540e1c892ce78f090ce77.png)](https://camo.githubusercontent.com/fdebcbd844cbae276b85296fea82e5730245a6f89610e81fa3b540a01ea62e19/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f50794d7953514c2d76253545312e302e302d7265642e7376673f6c6f6e6743616368653d74727565267374796c653d666c61742d737175617265266c6f676f3d7363616c61266c6f676f436f6c6f723d776869746526636f6c6f72413d34633536366126636f6c6f72423d626636313661)[![GitHub Last Commit](../Images/ce450f99c39c42faeca9f81fb73c2c1d.png)](https://camo.githubusercontent.com/556bded58c9998ff95a5c6abd94d070c459b92b20b2a0977dc3a2f94af805fbe/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6173742d636f6d6d69742f676f6f676c652f736b69612e7376673f7374796c653d666c61742d73717561726526636f6c6f72413d34633536366126636f6c6f72423d613362653863266c6f676f3d476974487562)[![GitHub Issues](../Images/b51c92f47428b4e575d45f7be4c1e2e1.png)](https://github.com/hackersandslackers/sqlalchemy-tutorial/issues)[![GitHub Stars](../Images/8df379b96bf69df566c3607586fcb4f3.png)](https://github.com/hackersandslackers/sqlalchemy-tutorial/stargazers)[![GitHub Forks](../Images/d8103d43bdbf0b4b95b37afb2ff84af6.png)](https://github.com/hackersandslackers/sqlalchemy-tutorial/network)

[![SQLAlchemy Tutorial](../Images/18eb72b96df491820eb93712bdc663e3.png)T2ã€‘](https://github.com/hackersandslackers/sqlalchemy-tutorial/blob/master/.github/sqlalchemy@2x.jpg?raw=true)

è¿™ä¸ªå­˜å‚¨åº“åŒ…å«å…³äº SQLAlchemy çš„å››éƒ¨åˆ†æ•™ç¨‹ç³»åˆ—çš„æºä»£ç :

1.  [ä½¿ç”¨ SQLAlchemy ç®€åŒ– Python ä¸­çš„æ•°æ®åº“](https://hackersandslackers.com/python-database-management-sqlalchemy)
2.  ç”¨ SQLAlchemy å®ç°ä¸€ä¸ª ORM
3.  [SQLAlchemy æ•°æ®æ¨¡å‹ä¸­çš„å…³ç³»](https://hackersandslackers.com/sqlalchemy-data-models)
4.  [ç”¨ SQLAlchemy æ„å»ºæ•°æ®åº“æŸ¥è¯¢](https://hackersandslackers.com/database-queries-sqlalchemy-orm)

# å…¥é—¨æŒ‡å—

åˆ†ä¸¤æ­¥åœ¨æœ¬åœ°è¿›è¡Œè®¾ç½®:

### ç¯å¢ƒå˜é‡

ç”¨æ‚¨çš„å€¼æ›¿æ¢ **.env.example** ä¸­çš„å€¼ï¼Œå¹¶å°†è¯¥æ–‡ä»¶é‡å‘½åä¸º**ã€‚ç¯å¢ƒ**:

*   `SQLALCHEMY_DATABASE_URI`:SQL æ•°æ®åº“çš„è¿æ¥ URIã€‚
*   `SQLALCHEMY_DATABASE_PEM` *ã€å¯é€‰ã€‘*:éœ€è¦ SSL è¿æ¥çš„æ•°æ®åº“çš„ PEM å¯†é’¥ã€‚

è®°ä½æ°¸è¿œä¸è¦æäº¤ä¿å­˜åœ¨ã€‚Github çš„ env æ–‡ä»¶ã€‚

### è£…ç½®

ä½¿ç”¨`make deploy`å¼€å§‹è¿è¡Œ:

```
$ git clone https://github.com/hackersandslackers/sqlalchemy-tutorial.git
$ cd sqlalchemy-tutorial
$ make deploy
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

* * *

**é»‘å®¢å’Œæ‡’é¬¼**æ•™ç¨‹å…è´¹ã€‚å¦‚æœä½ è§‰å¾—è¿™ä¸ªæ•™ç¨‹æœ‰å¸®åŠ©ï¼Œä¸€ä¸ª[çš„å°é¢æèµ ](https://www.buymeacoffee.com/hackersslackers)å°†ä¼šéå¸¸æ„Ÿè°¢ï¼Œè®©æˆ‘ä»¬ç»§ç»­åšç”Ÿæ„ã€‚æ‰€æœ‰çš„æ”¶ç›Šéƒ½æµå‘äº†å’–å•¡ï¼Œæ‰€æœ‰çš„å’–å•¡éƒ½æµå‘äº†æ›´å¤šçš„å†…å®¹ã€‚

</article>

[View on GitHub](https://github.com/hackersandslackers/sqlalchemy-tutorial)