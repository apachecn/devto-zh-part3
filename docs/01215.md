# ä½¿ç”¨ Azure å‡½æ•°è¿›è¡Œè¿œç¨‹ NLOG æ—¥å¿—è®°å½•(ç¬¬äºŒéƒ¨åˆ†)â€”â€”å°†æ•°æ®æŒä¹…åŒ–åˆ° Azure Cosmos DB ä¸­ã€‚

> åŸæ–‡:[https://dev . to/yerac/remote-nlog-logging-with-azure-functions-part-two-persisting-data-into-azure-cosmos-d b-4od 3](https://dev.to/yerac/remote-nlog-logging-with-azure-functions-part-two-persisting-data-into-azure-cosmos-db-4od3)

å…è´£å£°æ˜:è¿™ä¸ªåšå®¢å¯¹æˆ‘æ¥è¯´æ›´åƒæ˜¯ä¸€ä¸ªâ€œå¿ƒç†ç¬”è®°â€ã€‚æˆ‘ä¸æ˜¯è¿™æ–¹é¢çš„ä¸“å®¶ï¼ŒCosmos DB å¯¹æˆ‘æ¥è¯´è¿˜æ˜¯æ–°çš„(å‡ ä¸ªå°æ—¶å‰)ã€‚å¦‚æœæˆ‘å®Œå…¨æ²¡æœ‰æŠ“ä½è¦ç‚¹ï¼Œè¯·å†™ä¿¡ç»™æˆ‘ğŸ™‚

[ä¸Šæ¬¡](https://dev.to/wabbbit/remote-nlog-logging-with-azure-functions-part-one-ko-temp-slug-3060401)ï¼Œæˆ‘è¿æ¥äº†ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ C# Azure å‡½æ•°æ¥æ¥å—æ¥è‡ª NLOG web æœåŠ¡ç›®æ ‡çš„è¯·æ±‚ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘å°†å°è¯•å°†ä¼ å…¥çš„æ—¥å¿—ä¿¡æ¯æŒä¹…åŒ–(æ’å…¥)åˆ° Azure Cosmos æ•°æ®åº“å®¹å™¨ä¸­ï¼Œç›´æ¥ä» VS ä»£ç ä¸­çš„ Azure å‡½æ•°å¼€å§‹ã€‚

## [](#setting-up-cosmos-db-databases-and-containers)è®¾ç½® Cosmos DBã€æ•°æ®åº“å’Œå®¹å™¨ã€‚

é¦–å…ˆï¼Œæˆ‘å°†åœ¨ Azure é—¨æˆ·ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ Cosmos DBï¼Œæ–¹æ³•æ˜¯ä»èµ„æºé¢æ¿ä¸­é€‰æ‹©â€œAzure Cosmos DB â€,ç„¶åé€‰æ‹©â€œæ–°å»ºâ€ã€‚

åœ¨æ­¤é¡µé¢ä¸Šï¼Œæˆ‘éœ€è¦æŒ‡å®š:

*   è®¢é˜…:æ‚¨çš„ Azure è®¢é˜…å°†åœ¨ä¸‹åˆ›å»ºæ­¤ã€‚
*   èµ„æºç»„:æ‚¨åº”è¯¥å·²ç»æœ‰äº†ä¸€ä¸ªä¸æ‚¨ä¹‹å‰åˆ›å»ºçš„ Azure å‡½æ•°ç›¸åŒ¹é…çš„èµ„æºç»„ã€‚
*   å®ä¾‹è¯¦ç»†ä¿¡æ¯
    *   å¸æˆ·å:è¿™å°†ä½œä¸º URL çš„å‰ç¼€ï¼Œå³**å¸ƒæ‹‰**documents.azure.com
    *   API:å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘å°†ä½¿ç”¨ Core(SQL ),è¿™æ ·æˆ‘å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–‡æ¡£æ•°æ®åº“å¹¶ä½¿ç”¨ SQL è¯­æ³•è¿›è¡ŒæŸ¥è¯¢ã€‚
*   åœ°ç‚¹:é€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åœ°ç‚¹ã€‚
*   å…¶ä»–é€‰é¡¹:å…¶ä»–é€‰é¡¹å¦‚åœ°ç†å†—ä½™ç­‰å¯ä»¥æš‚æ—¶ç¦ç”¨ã€‚

é€‰æ‹©â€œå®¡æŸ¥å’Œåˆ›å»ºâ€ï¼Œç„¶ååœ¨ä¸‹ä¸€ä¸ªå±å¹•ä¸Šé€‰æ‹©â€œåˆ›å»ºâ€ï¼Œå‰ææ˜¯æ‚¨å¯¹è¾“å…¥å†…å®¹æ„Ÿåˆ°æ»¡æ„ã€‚

[![](../Images/c09884405033d706a12a20fead4f4007.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--9X_K9-Fd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i2.wp.com/yer.ac/blog/wp-content/uploads/2019/05/image-12.png%3Ffit%3D700%252C257)

å½“å®ƒå¯ä»¥ä½¿ç”¨æ—¶ï¼Œå°†åˆ‡æ¢åˆ°â€œæ‚¨çš„éƒ¨ç½²å·²ç»å®Œæˆâ€ã€‚ä¸ä¼šè¶…è¿‡å‡ åˆ†é’Ÿã€‚

ç‚¹å‡»â€œè½¬åˆ°èµ„æºâ€ï¼Œæˆ–è€…é€šè¿‡èµ„æºç®¡ç†å™¨å¯¼èˆªåˆ°æ–°çš„ Cosmos DBï¼Œå°†ä¼šä¸ºè¿™ä¸ªæ•°æ®åº“åŠ è½½ä¸€ä¸ªå¿«é€Ÿå¯åŠ¨çª—å£ã€‚ç„¶è€Œï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªâ€œå®¹å™¨â€ã€‚é€‰æ‹©æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ Azure Cosmos DB å¸æˆ·ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©â€œæ·»åŠ å®¹å™¨â€ã€‚

[![](../Images/1245e18045dd9649a007ec8ae3161556.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--TqhfqfgW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i0.wp.com/yer.ac/blog/wp-content/uploads/2019/05/image-13.png%3Fw%3D840)

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€äº›è¾“å…¥:

*   æ•°æ®åº“ IDã€‚æˆ‘æ²¡æœ‰æ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªã€‚å¦‚æœæ‚¨å·²ç»æœ‰ä¸€ä¸ªï¼Œè¯·åœ¨æ­¤æŒ‡å®šåç§°ã€‚
*   ååé‡:400 RU(è¯·æ±‚å•ä½/ç§’)å¯¹äºæˆ‘çš„åŸºæœ¬æµ‹è¯•å’Œæ“ä½œæ¥è¯´åº”è¯¥è¶³å¤Ÿäº†ã€‚
*   å®¹å™¨ ID:æˆ‘æŒ‡å®šäº†ä¸€ä¸ªå®¹å™¨ IDï¼Œå®ƒä½äºæ–°çš„/ç°æœ‰çš„æ•°æ®åº“ä¸­ã€‚ **azlogger** æ˜¯æˆ‘æƒ³è¦æ‰€æœ‰æ—¥å¿—ç›¸å…³æ•°æ®çš„åœ°æ–¹ï¼Œè¿˜æœ‰ä¸€ä¸ªå®¹å™¨ **azlogger-logs** æ¥å­˜æ”¾æˆ‘å°†è¦å­˜å‚¨çš„æ—¥å¿—ã€‚
*   åˆ†åŒºé”®:æˆ‘ä½¿ç”¨â€œloggerNameâ€ä½œä¸ºæˆ‘çš„åˆ†åŒºé”®ã€‚è§è¿™ä¸ª[è§†é¢‘](https://azure.microsoft.com/en-us/resources/videos/azure-documentdb-elastic-scale-partitioning/)äº†è§£ä¿¡æ¯ï¼Œä½†æœ¬è´¨ä¸Šæˆ‘ç›¸ä¿¡è¿™æ˜¯ä¸ºäº†ç®¡ç†åˆ†åŒºï¼Œå¦‚æœæ•°æ®è¶…è¿‡é™åˆ¶ï¼Œæ‰€ä»¥åˆ†åŒºå¯ä»¥åˆ†ç»„(ï¼Ÿ)æ­£ç¡®(~10GBï¼Ÿ).**è€å®è¯´ï¼Œå¦‚æœæ²¡æœ‰è¯»æ›´å¤šçš„ä¹¦ï¼Œæˆ‘ä¸èƒ½ 100%ç¡®å®šã€‚**æˆ‘åˆšå»äº†ä¸€ä¸ªæ¨èçš„é”€å”®è®¢å•å²—ä½ã€‚

## [](#updating-the-azure-function-to-connect-with-cosmos-db)æ›´æ–° Azure å‡½æ•°ä»¥è¿æ¥ Cosmos DB

æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ CosmosDB åŒ…ï¼Œå› æ­¤åœ¨ç»ˆç«¯ä¸­è¿è¡Œ:

`dotnet add package Microsoft.Azure.WebJobs.Extensions.CosmosDB`

ç°åœ¨æˆ‘éœ€è¦è®¾ç½®è§£å†³æ–¹æ¡ˆï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä½¿ç”¨ Cosmos DBã€‚

åœ¨`local.settings.json`ä¸­ï¼Œæˆ‘æ·»åŠ äº†æˆ‘çš„è¿æ¥å­—ç¬¦ä¸²:

```
{ "IsEncrypted": false, "Values": { "AzureWebJobsStorage": "", "FUNCTIONS\_WORKER\_RUNTIME": "dotnet", "MyCosmosDBConnection": "\<conn string\>" } } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¶ä¸­è¿æ¥å­—ç¬¦ä¸²å€¼æ¥è‡ªæ‚¨çš„ Cosmos ä»ªè¡¨æ¿ï¼Œåœ¨â€œKeysâ€->â€œPrimary connection stringâ€ä¸‹

ç°åœ¨æˆ‘éœ€è¦ä¸€ä¸ª C#æ¨¡å‹æ¥ç»‘å®šã€‚æˆ‘ç”¨å¿…éœ€çš„å­—æ®µåˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ LogDetail ç±»ã€‚æ³¨æ„ï¼Œæˆ‘åœ¨å­—æ®µä¸Šä½¿ç”¨äº† JsonProperty é¡¹ã€‚æˆ‘é˜…è¯»äº†å…³äºæ³¨é‡Šé™¤ ID ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹çš„è¦æ±‚çš„ç›¸äº’çŸ›ç›¾çš„åšå®¢å¸–å­ï¼Œä½†æ˜¯æˆ‘å‘ç°æš‚æ—¶ä¿ç•™å®ƒæ²¡æœ‰ä»€ä¹ˆåå¤„ã€‚

```
public class LogDetail{ [JsonProperty("id")] public string Id { get; set; } [JsonProperty("timestamp")] public string Timestamp; [JsonProperty("logName")] public string LogName; [JsonProperty("logLevel")] public string LogLevel; [JsonProperty("message")] public string Message; } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æ˜¯æ›´æ–°ä¸»æ–¹æ³•/å‡½æ•°çš„æ—¶å€™äº†ï¼è¿™å¯¹æˆ‘æ¥è¯´å®é™…ä¸Šæ˜¯æœ€éš¾çš„éƒ¨åˆ†(éƒ¨åˆ†åŸå› æ˜¯ç¼ºä¹è¿™é¡¹æŠ€æœ¯çš„ç»éªŒ)ï¼Œæ–‡æ¡£æœ‰ç‚¹æ··ä¹±ã€è¯¯å¯¼ï¼Œå¹¶ä¸”é€šå¸¸é’ˆå¯¹ç‰¹å®šçš„åœºæ™¯ã€‚

æˆ‘ä¸ç¡®å®š*å¯¹*æœ‰å¤šæ­£ç¡®ï¼Œä½†æ˜¯æˆ‘æœ€ç»ˆæ”¹å˜äº†æˆ‘çš„ main æ–¹æ³•ï¼Œä½¿å®ƒå˜æˆ:

```
public static class Log { [FunctionName("Log")] public static **void** AcceptLogRequest( [HttpTrigger(AuthorizationLevel.Anonymous, "get", "post", Route = "Log")] HttpRequest req, **[CosmosDB( databaseName: "azlogger", collectionName: "azlogger-logs", ConnectionStringSetting = "MyCosmosDBConnection", Id = "{sys.randguid}", PartitionKey ="/loggerName" )] out** LogDetail logDetail, ILogger log) { log.LogInformation("HTTP trigger fired for log entry."); string timestamp = req.Form["timestamp"]; string loggerName = req.Form["loggerName"]; string loggerLevel = req.Form["loggerLevel"]; string message = req.Form["message"]; var res = $"{timestamp} | {loggerName} | {loggerLevel.ToUpper()} | {message}"; log.LogInformation(res); logDetail = new LogDetail(); logDetail.Timestamp = timestamp; logDetail.LogLevel = loggerLevel; logDetail.LogName = loggerName; logDetail.Message = message; } } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸»è¦å˜åŒ–æ˜¯:

*   ä½¿å…¶æˆä¸ºå°†æ•°æ®ä¿å­˜åˆ° CosmosDb çš„åŒæ­¥ void æ–¹æ³•ï¼Œè¿™åœ¨å¾®è½¯æ–‡æ¡£[è¿™é‡Œ](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-cosmosdb-v2)ä¸­è¢«æ¨èã€‚å¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œä½†å®ƒçš„å·¥ä½œï¼Œå¹¶ç¬¦åˆä»–ä»¬çš„æ–‡ä»¶ã€‚
*   å°†`LogDetail logdetail`æ›´æ”¹ä¸º`out LogDetail logDetail`
*   æ·»åŠ  Cosmos DB æ³¨é‡Š(è§ä¸‹æ–‡)

CosmosDB æ³¨é‡Šæœ‰ä»¥ä¸‹é€‰é¡¹:

*   **databaseName** :è¿™æ˜¯ä¸Šä¸€æ­¥å»ºç«‹çš„æ•°æ®åº“çš„ä¸»æ•°æ®åº“åã€‚
*   **é›†åˆåç§°**:è¿™æ˜¯ä¸Šä¸€æ­¥è®¾ç½®çš„ _ **å®¹å™¨** _ åç§°
*   **ConnectionStringSetting** :ä¸Šä¸€æ­¥æ”¾åœ¨`local.settings.json`é‡Œé¢çš„ app è®¾ç½®åã€‚
*   **id** :è®°å½•çš„ id æ¡ç›®ã€‚ä¸ºæ­¤æˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå†…ç½®çš„ç³»ç»Ÿå‚æ•° **`{sys.randguid}`**
*   **åˆ†åŒºé”®**:æˆ‘åœ¨ä¹‹å‰çš„è®¾ç½®æ­¥éª¤ä¸­æŒ‡å®šçš„åˆ†åŒºé”®ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘è°ƒè¯•(æˆ–éƒ¨ç½²)è¿™ä¸ª Azure å‡½æ•°ï¼Œå¹¶è®©æˆ‘çš„åº”ç”¨ç¨‹åºæ’å…¥ä¸€å † NLOG æ¡ç›®ï¼Œå®ƒç°åœ¨åº”è¯¥ä¼šåœ¨ä¸€ä¸ª Cosmos DB å®¹å™¨ä¸­åˆ›å»ºä¸€äº›æ¡ç›®ã€‚

è¦æŸ¥çœ‹ç»“æœï¼Œæˆ‘å¯ä»¥åœ¨ Azure é—¨æˆ·ä¸Šè¿›å…¥ Cosmos DB å¹¶é€‰æ‹©â€œæ•°æ®æµè§ˆå™¨â€ã€‚ä»è¿™é‡Œå¼€å§‹ï¼Œå¯ä»¥æ‰©å±•æ•°æ®åº“å’Œå®¹å™¨ä»¥æ˜¾ç¤ºå®¹å™¨ä¸­çš„â€œé¡¹ç›®â€â€”â€”åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæ˜¯ NLOG æ¡ç›®çš„è´Ÿè½½ã€‚

[![](../Images/195cfb502e1d69849273050b5f05c40b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Ncy0n1at--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i1.wp.com/yer.ac/blog/wp-content/uploads/2019/05/image-15.png%3Ffit%3D700%252C345)

## [](#conclusion)ç»“è®º

ç°åœ¨è¿˜ä¸ºæ—¶è¿‡æ—©ï¼Œä½†æ˜¯ä½¿ç”¨æœ€æ–°çš„å·¥å…·éƒ¨ç½²ä¸€ä¸ªæ–°çš„ Azure åŠŸèƒ½æ˜¯éå¸¸å®¹æ˜“çš„ï¼Œå”¯ä¸€çœŸæ­£çš„å›°éš¾ä¼¼ä¹æ˜¯åœ¨ Azure ä¸­ç¡®å®šåˆé€‚çš„æ–‡æ¡£(ä»æˆ‘çš„ç»éªŒæ¥çœ‹ä¸€ç›´éƒ½æ˜¯è¿™æ ·ï¼)

ä¸‹ä¸€æ­¥å°†æ˜¯ç ”ç©¶è®¡æ—¶å™¨ä¸Šçš„ Azure å‡½æ•°è§¦å‘å™¨ï¼Œä»¥äº§ç”Ÿ MI æŠ¥å‘Šï¼Œæˆ–è€…åŸºäºæ—¶é—´/åŠ¨ä½œçš„è§¦å‘å™¨ï¼Œä»¥å°†æ•è·çš„äº‹ä»¶è½¬å‘ç»™é€‚å½“çš„äººã€‚

ä½¿ç”¨ Azure å‡½æ•°çš„è¿œç¨‹ NLOG æ—¥å¿—(ç¬¬äºŒéƒ¨åˆ†)â€”â€”å°†æ•°æ®æŒä¹…åŒ–åˆ° Azure Cosmos DB ä¸­ã€‚æœ€æ—©å‡ºç°åœ¨ [yer.ac |ä¸€ä¸ªå¼€å‘è€…çš„å†’é™©ï¼Œç­‰ç­‰ã€‚](http://yer.ac/blog)ã€‚