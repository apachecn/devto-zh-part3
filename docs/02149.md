# ç®€å•æ˜äº†åœ°ç”¨ Apollo æœåŠ¡å™¨å°†è¿œç¨‹æ¨¡å¼è¿æ¥åˆ°æœ¬åœ°æ¨¡å¼

> åŸæ–‡:[https://dev . to/bidah/simple-and-the-point-stitching-remote-schema-into-local-schema-with-Apollo-server-24in](https://dev.to/bidah/simple-and-to-the-point-stitching-remote-schema-into-local-schema-with-apollo-server-24in)

*å°é¢ç…§ç‰‡ç”±[ä¸¤æŠŠæ¡¨æ–§å’Œçš®é©åˆ¶å“](https://unsplash.com/photos/9wNcZprwco8)åœ¨ Unsplash ä¸Š*

åœºæ™¯:æ‚¨åœ¨ Apollo æœåŠ¡å™¨ä¸Šè¿è¡Œäº†ç¬¬ä¸€ä¸ªæ¨¡å¼ï¼Œä½†æ˜¯å‡ºç°äº†ä¸€ä¸ªæ–°çš„ GraphQL APIï¼Œæ‚¨éœ€è¦ç«‹å³åœ¨å®¢æˆ·æœºä¸Šä½¿ç”¨å®ƒï¼Œè€Œä¸éœ€è¦å¤ªå¤šçš„è¯¢é—®ã€‚

æœ¬æ•™ç¨‹å°†å°è¯•è®©ä½ å°½å¿«ä» A ç‚¹åˆ°è¾¾ B ç‚¹ã€‚æˆ‘ä»¬å°†åˆ¶ä½œä¸€ä¸ªå°çš„ API æ¥è§£å†³æˆ‘ä»¬çš„é—®é¢˜å¹¶ä¾›å°†æ¥é‡ç”¨ã€‚ä½ å¯ä»¥é©¬ä¸Šä½¿ç”¨å®ƒï¼Œä½†æˆ‘ä»¬ä¼šä¸€æ­¥ä¸€æ­¥åœ°è§£é‡Šæ¯ä¸€ä¸ªéƒ¨åˆ†ï¼Œä»¥è·å¾—å†…éƒ¨å·¥ä½œåŸç†ã€‚

æ³¨æ„:
ç¼åˆæœ¬åœ°æ¨¡å¼å’Œè¿œç¨‹æ¨¡å¼ï¼Œæˆ‘è®¤ä¸ºï¼Œåœ¨ä½ **å¼€å§‹ç¼åˆ**çš„æƒ…å†µä¸‹ï¼Œæ•ˆæœéå¸¸å¥½ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ‚¨å·²ç»æœ‰äº†ç¬¬ä¸€ä¸ªæ¨¡å¼å¹¶æ­£åœ¨è¿è¡Œã€‚å¦‚æœå‡ºç°ä¸€ä¸ª GraphQL æœåŠ¡ï¼Œåªéœ€åœ¨ä¸Šé¢æ·»åŠ è¿™ä¸ªæ–°çš„è¿œç¨‹æ¨¡å¼ï¼Œå°±å¯ä»¥å¼€å§‹ä½¿ç”¨å®ƒäº†ã€‚

æˆ‘å‘Šè¯‰ä½ è¿™ä¸ªæ˜¯å› ä¸ºæœ‰å¦ä¸€ç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¯åŠ¨å¦ä¸€ä¸ªå¾®æœåŠ¡æ¥ä½œä¸ºæˆ‘ä»¬ä¸¤ä¸ª API çš„ä»£ç†(æœ¬åœ°å’Œè¿œç¨‹æ¨¡å¼ç°åœ¨éƒ½æ˜¯è¿œç¨‹çš„)ã€‚æˆ‘è®¤ä¸ºå½“æ‚¨æœ‰å¤ªå¤šæœåŠ¡æ—¶ï¼Œè¿™å¯èƒ½ä¼šå·¥ä½œå¾—å¾ˆå¥½ï¼Œä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬åªä½¿ç”¨æˆ‘ä»¬å½“å‰çš„æœåŠ¡å™¨ï¼Œå¹¶åœ¨å…¶ä¸Šæ·»åŠ ä¸€ä¸ªæ–°çš„è¿œç¨‹æ¨¡å¼æ¥å¢å¼ºå®ƒã€‚é€Ÿåº¦æ›´å¿«ï¼Œå°‘è¿è¡Œä¸€ä¸ªæœåŠ¡ï¼Œå¾ˆæœ‰æ•ˆã€‚

ç°åœ¨æˆ‘ä»¬åº”è¯¥å·²ç»ä¸ºæˆ‘ä»¬çš„æœåŠ¡å™¨è®¾ç½®å¥½äº†ã€‚

```
const server = new ApolloServer({ typeDefs, resolvers });

server.listen().then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†ç”¨è¿™ä¸ªæ¨¡å—æ›¿æ¢ä»¥å‰çš„ä»£ç ã€‚

```
const { ApolloServer, makeExecutableSchema } = require('apollo-server')
const { HttpLink } = require('apollo-link-http')
const {
  introspectSchema,
  makeRemoteExecutableSchema,
  mergeSchemas,
} = require('graphql-tools')
const fetch = require('node-fetch')

async function startServer({
  localSchema: { resolvers, typeDefs },
  remoteSchema: { uri },
}) {
  const remoteHttpLink = new HttpLink({
    uri,
    fetch,
  })

  const remoteSchemaInstrospection = await introspectSchema(remoteHttpLink)

  const remoteSchemaExecutable = makeRemoteExecutableSchema({
    schema: remoteSchemaInstrospection,
    link: remoteHttpLink,
  })

  const localSchema = makeExecutableSchema({
    typeDefs,
    resolvers,
  })

  const mergedSchemas = mergeSchemas({
    schemas: [localSchema, remoteSchemaExecutable],
  })

  const server = new ApolloServer({ schema: mergedSchemas })

  return await server.listen()
}

module.exports = startServer 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é¦–å…ˆï¼Œæˆ‘ä»¬å°†å‘æˆ‘ä»¬çš„å¤–éƒ¨ GraphQL API å‘å‡ºä¸€ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬å‘é…ç½®å¯¹è±¡ä¼ é€’æˆ‘ä»¬çš„`uri`å’Œå¯¹`fetch`åº“çš„å¼•ç”¨ã€‚

```
 const remoteHttpLink = new HttpLink({
    uri,
    fetch,
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä½¿ç”¨`instrospectionSchema`å‡½æ•°ä»è¿œç¨‹ GraphQL æœåŠ¡ä¸­æ£€ç´¢æ¨¡å¼ã€‚å”¯ä¸€çš„å‚æ•°æ˜¯æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„`HttpLink`å®ä¾‹ã€‚

```
 const remoteSchemaInstrospection = await introspectSchema(remoteHttpLink) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬åœ¨è‡ªçœä¹‹åå¾—åˆ°äº†æˆ‘ä»¬çš„æ¨¡å¼ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬ä»ç„¶ç¼ºå°‘ä½¿å®ƒå¯æ‰§è¡Œã€‚æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªä¸¤æ­¥èµ°çš„è¿‡ç¨‹ã€‚å¯æ‰§è¡Œæ€§å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿç¨åå°†å®ƒä¸æˆ‘ä»¬çš„æœ¬åœ°æ–‡ä»¶åˆå¹¶ã€‚

```
 const remoteSchemaExecutable = makeRemoteExecutableSchema({
    schema: remoteSchemaInstrospection,
    link: remoteHttpLink,
  }) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨`makeExecutableSchema`åˆ›å»ºæœ¬åœ°æ¨¡å¼ï¼Œç”¨æˆ‘ä»¬çš„`typeDefs`å’Œ`resolvers`ä¼ é€’ä¸€ä¸ªé…ç½®å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå°±åƒæˆ‘ä»¬åœ¨å¼€å§‹çœ‹åˆ°çš„å…¸å‹çš„æœåŠ¡å™¨é…ç½®å¯¹è±¡ä¸€æ ·ã€‚

```
const localSchema = makeExecutableSchema({
  typeDefs,
  resolvers,
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨`mergeSchemas`å’Œ
åˆå¹¶ä¸¤ä¸ªæ¨¡å¼

```
const mergedSchemas = mergeSchemas({
  schemas: [localSchema, remoteSchemaExecutable],
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨é…ç½®å¯¹è±¡ä¸­å°†å®ƒä¼ é€’ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼Œå¹¶åƒå¾€å¸¸ä¸€æ ·å¯åŠ¨å®ƒè°ƒç”¨`listen`ã€‚

```
const server = new ApolloServer({ schema: mergedSchemas })

return await server.listen() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å®Œæˆäº†æ¨¡å—åˆ†è§£ğŸ™Œã€‚ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨å®ƒï¼

`startServer`æœ‰ä¸€ä¸ªé…ç½®å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¯¥å¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§:

*   `localSchema`æœ‰ä¸¤æŠŠé’¥åŒ™çš„ç‰©ä½“ã€‚`resolvers`å’Œ`typeDefs`ã€‚
*   `remoteSchema`ä¸€é”®å¯¹è±¡ã€‚`uri`:æˆ‘ä»¬å¤–éƒ¨ GraphQL API çš„å­—ç¬¦ä¸²ã€‚

```
startServer({
  localSchema: {
    resolvers,
    typeDefs,
  },
  remoteSchema: {
    uri: 'https://01uhb.sse.codesandbox.io/',
  },
}).then(({ url }) => {
  console.log(`ğŸš€  => Server ready at ${url}`)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»…æ­¤è€Œå·²ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å½“å‰çš„æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ä¸¤ç§æ¨¡å¼ã€‚

è‡ªå·±ç©å§ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰ GraphQL æœåŠ¡å™¨å’Œæˆ‘ä»¬çš„æ¨¡å—çš„ä»£ç æ²™ç®±ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªç–‘é—®ã€‚`hello`æ˜¯æœ¬åœ°çš„ï¼Œå¹¶ä¸”æ­£åœ¨åˆå¹¶`goodbye`æŸ¥è¯¢ã€‚

[https://codesandbox.io/embed/apollo-server-pu0gu](https://codesandbox.io/embed/apollo-server-pu0gu)

å¯ä»¥åœ¨è¿™é‡ŒæŠ“å–å¤–éƒ¨ Graphql æœåŠ¡:[https://codesandbox.io/s/apollo-server-01uhb](https://codesandbox.io/s/apollo-server-01uhb)

è¿™åªæ˜¯å¼€å§‹ã€‚ä»è¿™é‡Œå¼€å§‹ï¼Œä½ æœ‰å¾ˆå¤šéœ€è¦è°ƒæ•´å’Œå­¦ä¹ çš„åœ°æ–¹ã€‚

å¦‚æœä¸€äº›ç±»å‹åœ¨æ¨¡å¼ä¹‹é—´é‡å¤ä¼šæ€æ ·ï¼Ÿå¦‚æœæˆ‘éœ€è¦åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­ä½¿ç”¨ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœç±»å‹ä½œä¸ºå‚æ•°ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

æ–°çš„æŒ‘æˆ˜å¸¦æ¥äº†æ‰©å±•å’Œä½¿ç”¨ç»„åˆæ¨¡å¼çš„æ–°æ–¹æ³•ã€‚å¸Œæœ›è¿™å¼ å›¾æ˜¯ä½ ç¼çº«ä¹‹æ—…çš„ç¬¬ä¸€æ­¥ï¼