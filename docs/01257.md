# æµ‹è¯•ä¸»é¢˜åˆ‡æ¢åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/email 2 vimalraj/test-the-theme-toggle-app-4f6n](https://dev.to/email2vimalraj/test-the-theme-toggle-app-4f6n)

åœ¨æˆ‘ä¹‹å‰çš„[æ–‡ç« ](https://dev.to/email2vimalraj/toggle-theme-using-react-hooks-2ibe)ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªå…·æœ‰ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½çš„åº”ç”¨ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œè®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªç‰¹æ€§ã€‚

æˆ‘å°†ä½¿ç”¨ [react-testing-library](https://github.com/testing-library/react-testing-library) å’Œ [jest-dom](https://github.com/testing-library/jest-dom) ä½œä¸º`react-testing-library`çš„ä¼™ä¼´åº“ï¼Œåˆ©ç”¨ jest çš„å®šåˆ¶ dom å…ƒç´ åŒ¹é…å™¨ã€‚

è®©æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªåº“ä½œä¸ºå¼€å‘ä¾èµ–é¡¹æ¥å®‰è£…ã€‚

```
npm install -D react-testing-library jest-dom 
```

è‡ªä»æˆ‘ä»¬ä½¿ç”¨äº†`create-react-app`ï¼Œåœ¨ä»–ä»¬çš„æ–‡æ¡£ç«™ç‚¹[è¿™é‡Œ](https://facebook.github.io/create-react-app/docs/running-tests)æœ‰ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç« å¼€å§‹è¿è¡Œæµ‹è¯•ã€‚æˆ‘å¼ºçƒˆå»ºè®®æˆ‘çš„è¯»è€…é€šè¯»ä¸€éæ–‡æ¡£ã€‚

æ­£å¦‚è¿™é‡Œæåˆ°çš„ï¼Œè®©æˆ‘ä»¬åœ¨`src`ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`setupTests.js`ã€‚

```
import "react-testing-library/cleanup-after-each";
import "jest-dom/extend-expect"; 
```

*   ç¬¬ä¸€æ¬¡å¯¼å…¥ç¡®ä¿åœ¨æ¯æ¬¡æµ‹è¯•è¿è¡Œåç§»é™¤ç”±`react-testing-library`æ¸²æŸ“çš„ç»„ä»¶ã€‚
*   ç¬¬äºŒä¸ªå¯¼å…¥è®©æˆ‘ä»¬ä½¿ç”¨`jest-dom`çš„è‡ªå®šä¹‰åŒ¹é…å™¨ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨å®ƒæ¥æ–­è¨€ã€‚

åœ¨ç¼–å†™æµ‹è¯•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åœ¨`header`ä¸­æ·»åŠ ä¸€ä¸ªå±æ€§`data-testid`ï¼Œåœ¨`App.js`ç»„ä»¶ä¸­æ·»åŠ `button`ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
<header className="App-header" style={{ backgroundColor: theme.backgroundColor,
color: theme.color }} data-testid="header">
  <button type="button"
    onClick={toggle} style={{ backgroundColor: theme.backgroundColor, color: theme.color, outline: 'none' }} data-testid="toggle-theme-btn" > 
... 
```

æˆ‘ä»¬å°†ä½¿ç”¨`data-testid`å±æ€§æ¥æŸ¥æ‰¾æµ‹è¯•ä¸­çš„å…ƒç´ ã€‚

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•ã€‚å»åˆ é™¤`App.test.js`ä¸Šçš„æ‰€æœ‰å†…å®¹ï¼Œè¿›è¡Œä»¥ä¸‹æµ‹è¯•:

```
import React from "react";
import { render } from "react-testing-library";
import App from "./App";

test("renders with light mode default", () => {
  const { getByTestId } = render(<App />);
  expect(getByTestId("toggle-theme-btn")).toBeInTheDocument();
  expect(getByTestId("header")).toHaveStyle("background-color: white");
}); 
```

åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€è¡Œï¼Œæˆ‘ä»¬æ¸²æŸ“æˆ‘ä»¬çš„`App`ç»„ä»¶ï¼Œç„¶åæˆ‘ä»¬æ–­è¨€æ˜¯å¦æœ‰ä¸€ä¸ª`Toggle theme`æŒ‰é’®ï¼Œé»˜è®¤çš„`background color`æ˜¯ä½¿ç”¨å„è‡ªçš„`data-testid`çš„`white`

è®©æˆ‘ä»¬è¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹è¿è¡Œæ˜¯å¦æˆåŠŸã€‚

```
npm run test 
```

ä¸‡å²ã€‚ï¼ï¼æµ‹è¯•è¿è¡ŒæˆåŠŸï¼

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ å¦ä¸€ä¸ªæµ‹è¯•æ¥éªŒè¯å•å‡»åˆ‡æ¢æŒ‰é’®æ˜¯å¦ä¼šæ”¹å˜èƒŒæ™¯é¢œè‰²ã€‚

```
test("toggles the theme", () => {
  const { getByTestId } = render(<App />);
  const toggleBtn = getByTestId("toggle-theme-btn");
  fireEvent.click(toggleBtn);
  expect(getByTestId("header")).toHaveStyle("background-color: black");
  fireEvent.click(toggleBtn);
  expect(getByTestId("header")).toHaveStyle("background-color: white");
}); 
```

ç¡®ä¿ä»`react-testing-library`ä¸­å¯¼å…¥`fireEvent`ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹è¿è¡Œç»“æœã€‚æ–°æ·»åŠ çš„æµ‹è¯•å¤±è´¥äº† [![ğŸ˜Ÿ](../Images/d41db192203e25b1f81485fe4ddd11ad.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--2xnchDwe--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f61f.png) ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

```
âœ• toggles the theme (29ms)

  â— toggles the theme

    expect(element).toHaveStyle()

    - Expected

    - background-color: black;
    + background-color: white;

      13 | const toggleBtn = getByTestId('toggle-theme-btn')
      14 | fireEvent.click(toggleBtn)
    > 15 | expect(getByTestId('header')).toHaveStyle('background-color: black')
         | ^
      16 | fireEvent.click(toggleBtn)
      17 | expect(getByTestId('header')).toHaveStyle('background-color: white')
      18 | })

      at Object.toHaveStyle (src/App.test.js:15:33) 
```

æ‰§è¡Œå †æ ˆè·Ÿè¸ªæ˜¾ç¤º`background-color`ä»ç„¶æ˜¯`white`ã€‚è¿™æ„å‘³ç€åœ¨è§¦å‘ä¸€ä¸ª`click`äº‹ä»¶åï¼Œ`localStorage`çš„`setItem`æ–¹æ³•æ²¡æœ‰è¢«æ­£ç¡®è§¦å‘ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥æ¨¡æ‹Ÿæˆ‘ä»¬çš„`localStorage`ï¼Œå› ä¸ºæµ‹è¯•ä¸èƒ½åœ¨çœŸæ­£çš„æµè§ˆå™¨ä¸Šæ‰§è¡Œï¼Œä¹Ÿæ²¡æœ‰`Storage`ã€‚ç°åœ¨æ‰“å¼€ä½ çš„`setupTests.js`,æ·»åŠ ä¸‹é¢å‡ è¡Œ:

```
let store = {};

// Mock the `localStorage.getItem` method to return the value stored in the given key
jest.spyOn(Storage.prototype, "getItem").mockImplementation(key => {
  return store[key];
});

// Mock the `localStorage.setItem` method to insert a given value into the given key
jest.spyOn(Storage.prototype, "setItem").mockImplementation((key, value) => {
  return (store[key] = value + "");
});

// Mock the `localStorage.clear` method to clear the `store`
jest.spyOn(Storage.prototype, "clear").mockImplementation(() => {
  store = {};
}); 
```

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼Œçœ‹çœ‹ç»“æœã€‚è¿˜æ˜¯å› ä¸ºåŒæ ·çš„åŸå› å¤±è´¥ã€‚è®©æˆ‘ä»¬ç”¨`theme-context.js`ä¸­è‘—åçš„`console.log`è¯­å¥æ·»åŠ ä¸€äº›è°ƒè¯•ç‚¹ã€‚

æˆ‘åœ¨æˆ‘ä»¬çš„`ThemeProvider`å‡½æ•°ä¸­çš„`toggle`æ–¹æ³•ä¸­æ·»åŠ äº†ä»¥ä¸‹è¯­å¥:

```
console.log(">>> clicked"); 
```

è®©æˆ‘ä»¬çœ‹çœ‹è¿è¡Œç»“æœï¼Œå¹¶æ³¨æ„è¯¥è¯­å¥æ˜¯å¦è¢«æ‰“å°å‡ºæ¥ã€‚æ„å¤–çš„æ˜¯ï¼Œä¸æ˜¯ï¼

åŸå› æ˜¯æµ‹è¯•ä¸­çš„`App`ç»„ä»¶æ²¡æœ‰ç”¨`ThemeProvider`åŒ…è£…ã€‚æˆ‘ä»¬åº”è¯¥æŠŠå®ƒåŒ…èµ·æ¥ã€‚å°±è¿™ä¹ˆåŠå§ã€‚

ä¸€æ—¦æ‚¨å®Œæˆï¼Œæ‚¨çš„æµ‹è¯•å¿…é¡»é€šè¿‡ï¼Œæ·»åŠ çš„`console.log`è¯­å¥åº”è¯¥æ‰“å°ä¸¤æ¬¡ï¼ï¼ï¼

å¹²å¾—å¥½ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸€ä¸ªæµ‹è¯•ä¸­ç”¨`ThemeProvider`åŒ…è£…`App`ç»„ä»¶å—ï¼Ÿæˆ‘å¬åˆ°ä½ è¯´é‚£å¾ˆç—›è‹¦ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆã€‚

æ‰€ä»¥æˆ‘åœ¨[æ¨ç‰¹](https://twitter.com/email2vimalraj/status/1131496659685220352)ä¸Šå‘[è‚¯ç‰¹](https://twitter.com/kentcdodds)æå‡ºäº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ç«‹å³å¾—åˆ°äº†å›åº”ã€‚

> æ²¡é”™ã€‚æˆ‘å»ºè®®åŒ…è£…ï¼Œä½†ç§»åŠ¨ä¹Ÿå¯ä»¥ã€‚åœ¨è¿™é‡Œäº†è§£æ›´å¤šå…³äºæ— ç—›è‹¦åŒ…è£…çš„ä¿¡æ¯:[https://testing-library . com/docs/react-testing-library/setup # custom-render](https://testing-library.com/docs/react-testing-library/setup#custom-render)

å› æ­¤ï¼Œæ ¹æ®ä¸Šè¿°å†…å®¹ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•å®ç”¨ç¨‹åºæ–‡ä»¶æ¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æ¸²æŸ“æ–¹æ³•ã€‚åˆ›å»ºä¸€ä¸ªåä¸º`src/test-util.js`çš„æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import React from "react";
import { render } from "react-testing-library";
import { ThemeProvider } from "./theme-context";

const AllMyProviders = ({ children }) => {
  return <ThemeProvider>{children}</ThemeProvider>;
};

const MyCustomRender = (component, options) =>
  render(component, { wrapper: AllMyProviders, ...options });

// re-export everything from the `react-testing-library`
export * from "react-testing-library";

// export our custom render method
export { MyCustomRender as render }; 
```

è®©æˆ‘ä»¬è¿›è¡Œæµ‹è¯•ï¼Œå¹¶åšä¸€äº›æ›´æ”¹:

æ›¿æ¢

```
import { render, fireEvent } from "react-testing-library"; 
```

éšç€

```
import { render, fireEvent } from "./test-utils"; 
```

ç„¶åï¼Œåœ¨æ‰€æœ‰æµ‹è¯•ä¸­ç§»é™¤`App`ç»„ä»¶çš„`ThemeProvider`åŒ…è£…ã€‚ç°åœ¨æ‰§è¡Œæ‚¨çš„æµ‹è¯•ï¼Œçœ‹çœ‹ã€‚

æµ‹è¯•åº”è¯¥è¿è¡Œè‰¯å¥½ã€‚ä»Šå¤©åˆ°æ­¤ä¸ºæ­¢ã€‚å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·ç‚¹å‡»èµå¹¶åˆ†äº«ã€‚