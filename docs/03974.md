# åœ¨ä¼ä¸šç¯å¢ƒä¸­ä½¿ç”¨è§’å½¢

> åŸæ–‡:[https://dev . to/angular/working-with-angular-forms-in-a-an-enterprise-environment-p2m](https://dev.to/angular/working-with-angular-forms-in-an-enterprise-environment-p2m)

åœ¨æˆ‘ä»¬å…¬å¸ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹å°±åœ¨æ£±è§’åˆ†æ˜çš„å¤–å½¢ä¸Šè‹¦è‹¦æŒ£æ‰ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é¦–å…ˆä¸€å¤´æ‰è¿›å»ï¼Œæ²¡æœ‰è°ˆè®ºæˆ‘ä»¬å°†å¦‚ä½•åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨å®ƒã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº†æˆ‘ä»¬ç›®å‰å¦‚ä½•ä½¿ç”¨è§’å½¢æ¥æé«˜æ•ˆç‡ã€‚

## [](#a-bit-of-background)æœ‰ç‚¹èƒŒæ™¯

ä»»ä½•è¿‡å»å‚ä¸è¿‡ caliber é¡¹ç›®çš„äººéƒ½çŸ¥é“ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå¾ˆå¯èƒ½åŒ…å«å¤§é‡å¤æ‚çš„è¡¨å•ã€‚æˆ‘ä»¬ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘ä»¬åœ¨åŒ»ç–—é¢†åŸŸåŠªåŠ›ä½¿å®¢æˆ·ç®¡ç†æ›´å®¹æ˜“ã€‚æˆ‘ä»¬æ¯å¤©éƒ½ä¼šæ¥è§¦åˆ°è¡¨å•ï¼Œç®€å•çš„è¡¨å•å’Œæ›´å¤æ‚çš„è¡¨å•ã€‚

ä½œä¸ºä¸€ä¸ªå¼€å§‹æ–°é¡¹ç›®çš„æ–°å›¢é˜Ÿï¼Œæˆ‘ä»¬åŒæ„ä½¿ç”¨[ååº”å¼è¡¨å•](https://angular.io/guide/reactive-forms)ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰å°±è¡¨å•å’Œè¡¨å•éªŒè¯è¾¾æˆä¸€è‡´ã€‚åœ¨å‡ æ¬¡å†²åˆºä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹æ³¨æ„åˆ°æˆ‘ä»¬å†™äº†å¾ˆå¤š(ç›¸åŒçš„)ä»£ç ï¼Œéƒ½åƒ HTML ä¸€æ ·æœ‰æ£±è§’ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä¸€äº›è®¾è®¡åé¦ˆï¼Œå¹¶æ³¨æ„åˆ°æˆ‘ä»¬ä¸å¾—ä¸æ¥è§¦è®¸å¤šä»£ç æ¥ä½¿ä¸€åˆ‡æ­£ç¡®ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¼€å§‹è®¤ä¸ºåº”è¯¥æœ‰æ›´å¥½çš„æ–¹å¼æ¥å¤„ç†è¡¨å•çš„åœ°æ–¹ã€‚

## [](#input-form-fields)è¾“å…¥è¡¨å•å­—æ®µ

æˆ‘ä»¬å¼€å§‹ç¼–å†™è¾“å…¥è¡¨å•å­—æ®µï¼Œå…¶ä¸­åŒ…å«è´Ÿè´£å­—æ®µè¡Œä¸ºçš„æ‰€æœ‰ç¼–æ’ä»£ç ã€‚è¿™äº›å­—æ®µçš„ç¬¬ä¸€æ¬¡è¿­ä»£åŒ…æ‹¬å°†è¡¨å•æ§ä»¶å’Œè¡¨å•ç»„ä½œä¸ºè¾“å…¥ä¼ é€’ç»™è¿™äº›æ§ä»¶ã€‚è™½ç„¶è¿™åœ¨å¼€å§‹æ—¶æœ‰æ•ˆï¼Œä½†å¹¶ä¸æ˜¯å¾ˆå¥½ã€‚æˆ‘ä»¬æ€»æ˜¯è¢«æé†’å°†è¡¨å•ç»„ä¼ é€’åˆ°è¡¨å•åŸŸï¼Œå› ä¸ºè¿™ä¸æ˜¯é»˜è®¤çš„â€œè§’åº¦æ–¹å¼â€ã€‚å¯¹äºä¸€äº›æ§ä»¶ï¼Œæˆ‘ä»¬æœ€ç»ˆåœ¨è¡¨å•åŸŸç»„ä»¶ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå†…éƒ¨è¡¨å•ï¼Œå®ƒå¿…é¡»ä¸ä¸»ç»„ä»¶ä¿æŒåŒæ­¥ï¼Œéšä¹‹è€Œæ¥çš„æ˜¯æ‰€æœ‰çš„é—®é¢˜å’Œè®¨åŒçš„ä»£ç ã€‚

ç»è¿‡ä¸€äº›è¿­ä»£ï¼Œæˆ‘ä»¬äº†è§£äº†[æ§åˆ¶å€¼å­˜å–å™¨](https://angular.io/api/forms/ControlValueAccessor) sï¼Œè¿™ä¸ [NgControl](https://angular.io/api/forms/NgControl) ä¸€èµ·æ‰“å¼€äº†å¯èƒ½æ€§ã€‚ä» Angular æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª CVA æœ‰ä»¥ä¸‹ API:

```
interface ControlValueAccessor {
  /**
  * Writes a new value to the element.
  *
  * This method is called by the forms API to write to the view when programmatic changes from model to view are requested.
  */
  writeValue(obj: any): void

  /**
  * Registers a callback function that is called when the control's value changes in the UI.
  *
  * This method is called by the forms API on initialization to update the form model when values propagate from the view to the model.
  * When implementing the `registerOnChange` method in your own value accessor, save the given function so your class calls it at the appropriate time.
  */
  registerOnChange(fn: any): void

  /**
  * Registers a callback function is called by the forms API on initialization to update the form model on blur.
  *
  * When implementing `registerOnTouched` in your own value accessor, save the given function so your class calls it when the control should be considered blurred or "touched".
  */
  registerOnTouched(fn: any): void

  /**
  * Function that is called by the forms API when the control status changes to or from 'DISABLED'. Depending on the status, it enables or disables the appropriate DOM element.
  */
  setDisabledState(isDisabled: boolean)?: void
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç§ç»„åˆå…è®¸æˆ‘ä»¬åƒä»¥å‰ä¸€æ ·ä½¿ç”¨è‡ªå®šä¹‰è¡¨å•å­—æ®µï¼Œä½†å…¶ä¸­åŒ…å«æ›´å¤šåŠŸèƒ½ã€‚ä»£ç çœ‹èµ·æ¥ä¹Ÿå¹²å‡€äº†å¾ˆå¤šã€‚ä¸ºå¼€å‘äººå‘˜å’Œæˆ‘ä»¬çš„ç”¨æˆ·è€ƒè™‘ä¸€ä¸ªæ ‡å‡†åŒ–çš„è¡Œä¸ºå’Œå¯è§†åŒ–ï¼Œä¾‹å¦‚è¡¨å•éªŒè¯ï¼Œä»¥åŠå°†æ ‡ç­¾ç»‘å®šåˆ°æ­£ç¡®çš„è¾“å…¥å­—æ®µã€‚å¯¹äºæ¯ç§ç±»å‹çš„æ§ä»¶ï¼Œæˆ‘ä»¬éƒ½åˆ›å»ºäº†è‡ªå·±çš„å®ç°ï¼Œå¹¶ä»¥ä¸€ä¸ªæŠ½è±¡ç±»`BaseFormField`ç»“æŸï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬åœ¨æ¯ä¸ªè¡¨å•å­—æ®µä¸­éœ€è¦çš„é€šç”¨ä»£ç ã€‚

```
export abstract class BaseFormField implements ControlValueAccessor, DoCheck {
  @Input() label: string
  @Input() ariaLabel: string
  // giving the possibility to override the default error messages
  @Input() errorMessages: { [key: string]: string } = {}

  @Output() change = new EventEmitter<any>()

  // generate a unique id for each control
  id = generateControlId()

  value: any
  text: string
  disabled = false
  required = false

  onChange = (_value: any) => {}
  onTouched = () => {}

  constructor(@Optional() @Self() public controlDir: NgControl) {
    // bind the CVA to our control
    controlDir.valueAccessor = this
  }

  ngDoCheck() {
    if (this.controlDir.control instanceof FormControl) {
      // check if this field is required or not to display a 'required label'
      const validator =
        this.controlDir.control.validator &&
        this.controlDir.control.validator(new FormControl(''))
      this.required =
        Boolean(validator && validator.hasOwnProperty('required')) ||
        Boolean(validator && validator.hasOwnProperty('selectedCount'))
    }
  }

  get hasErrors() {
    return (
      this.controlDir.control &&
      this.controlDir.control.touched &&
      this.controlDir.control.errors
    )
  }

  // implementation of `ControlValueAccessor`
  writeValue(value: any): void {
    this.value = value
    if (typeof value === 'string') {
      this.text = value
    }

    this.onChange(this.value)
    this.change.emit(this.value)
  }

  registerOnChange(fn: any): void {
    this.onChange = fn
  }

  registerOnTouched(fn: () => void): void {
    this.onTouched = fn
  }

  setDisabledState(disabled: boolean): void {
    this.disabled = disabled
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨è¿™äº›è¡¨å•åŸŸç»„ä»¶æ¥å®ç°è·¨è¡¨å•åŸŸçš„é€šç”¨è¡Œä¸º:

*   æˆ‘ä»¬å°†æ ‡ç­¾ç»‘å®šåˆ°æ­£ç¡®çš„è¡¨å•åŸŸï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºæ¯ä¸ªè¡¨å•åŸŸç”Ÿæˆä¸€ä¸ªæƒŸä¸€çš„ id æ¥å®ç°è¿™ä¸€ç‚¹
*   å½“è¡¨å•åŸŸæ˜¯å¯é€‰çš„æ—¶ï¼Œæˆ‘ä»¬å°†å…¶é™„åŠ åˆ°è¡¨å•åŸŸçš„æ ‡ç­¾ä¸Š
*   æˆ‘ä»¬ä»¥é€šç”¨çš„æ–¹å¼æ˜¾ç¤ºéªŒè¯æ¶ˆæ¯ï¼Œåœ¨éœ€è¦æ—¶å¯ä»¥é€‰æ‹©è¦†ç›–é»˜è®¤çš„éªŒè¯æ¶ˆæ¯
*   å½“ä¸€ä¸ªè¡¨å•è¢«ç¦ç”¨æ—¶ï¼Œæˆ‘ä»¬ç¦ç”¨è¡¨å•åŸŸ

å¤é€‰æ¡†åˆ—è¡¨çš„å®ç°å¦‚ä¸‹:

```
@Component({
  selector: 'checkbox-list',
  template: `
    <div class="form-part" [class.field-error]="hasErrors">
      <label *ngIf="label"
        >{{ label }}<small *ngIf="!required"> (Optional)</small></label
      >
      <div class="checkbox-list" [ngClass]="alignment">
        <div class="checkbox-placeholder" *ngFor="let item of items">
          <mat-checkbox
            [checked]="isChecked(item.value)"
            (change)="change($event, item.value)"
            (blur)="onTouched()"
            [disabled]="disabled"
            >{{ item.label }}
          </mat-checkbox>
        </div>
      </div>
      <error-message-container
        [control]="controlDir.control"
        [errorMessages]="errorMessages"
      >
      </error-message-container>
    </div>
  `,
})
export class CheckboxListComponent extends BaseListField {
  @Input() items: Item[]
  @Input() alignment: 'horizontal' | 'vertical' = 'horizontal'

  isChecked(value: any) {
    return (
      this.controlDir.control &&
      this.controlDir.control.value &&
      this.controlDir.control.value.includes(value)
    )
  }

  change(event: MatCheckboxChange, value: any) {
    if (event.checked) {
      this.writeValue((this.value || []).concat(value))
    } else {
      this.writeValue(this.value.filter((v: any) => v !== value))
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¤é€‰æ¡†åˆ—è¡¨å­—æ®µç»„ä»¶å¯ä»¥åƒæ™®é€šè¾“å…¥å­—æ®µä¸€æ ·ä½¿ç”¨:

```
<checkbox-list
  formControlName="allergies"
  label="Allergies"
  alignment="horizontal"
  [items]="allergies"
></checkbox-list> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#form-directives)è¡¨å•æŒ‡ä»¤

é€šè¿‡éµå¾ªä¸Šé¢çš„å®è·µï¼Œå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤æ¥æ‰©å±•è¿™äº›æ§ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¡«å……ä¸€ä¸ªå•é€‰åˆ—è¡¨æˆ–ä¸€ä¸ªé€‰æ‹©æ¡†ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä¸ºæˆ‘ä»¬çš„é¡¹ç›®èµ‹å€¼ã€‚

```
@Directive({
  selector: 'radio-list[relation-list]',
})
export class RadioRelationDirective {
  constructor(private host: RadioListComponent) {
    this.host.items = [
      { label: 'Partner', value: Relation.Partner },
      { label: 'Child', value: Relation.Child },
      { label: 'Parent', value: Relation.Parent },
    ]
  }
}

@Directive({
  selector: 'select-field[relation-list]',
})
export class SelectRelationDirective {
  constructor(private host: SelectFieldComponent) {
    this.host.items = [
      { label: 'Partner', value: Relation.Partner },
      { label: 'Child', value: Relation.Child },
      { label: 'Parent', value: Relation.Parent },
    ]
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#supercharged-control-value-accessors)è¶…å……æ§åˆ¶å€¼å­˜å–å™¨

CVA å…è®¸æˆ‘ä»¬åˆ›å»ºé€šç”¨çš„å¯é‡ç”¨ç»„ä»¶ï¼Œæƒ³è±¡ä¸€ä¸ªæ™®é€šäººçš„ç»„ä»¶è¦æ±‚ä¸ªäººä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬äº†è§£ CVA æ°ç—‡ä¹‹å‰ï¼Œæˆ‘ä»¬å¤šæ¬¡å®æ–½äº†è¿™äº›æ§åˆ¶ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ç¼ºç‚¹ã€‚æ¯å½“ä¸€ä¸ªæ–°çš„æ ‡ç­¾å‡ºç°æ¥æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µï¼Œè°ƒæ•´éªŒè¯ï¼Œæˆ–è€…æ”¹å˜ä¸€ä¸ªè¡¨å•å­—æ®µçš„è¡Œä¸ºï¼Œæˆ‘ä»¬å°±ä¼šå¿˜è®°åœ¨å¦ä¸€ä¸ªä½ç½®æ›´æ–°ä¸€ä¸ªè¡¨å•ã€‚é€šè¿‡ä½¿ç”¨ CVAï¼Œè¿™æ˜¯å¯ä»¥é¿å…çš„ã€‚å®ƒå…è®¸æˆ‘ä»¬å®šä¹‰è¡¨å•æ¨¡æ¿ï¼Œå¹¶å®šä¹‰å¸¦æœ‰å†…ç½®éªŒè¯çš„è¡¨å•ç»„ã€‚è¿™æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå› ä¸ºè¿™ä¹Ÿå¯ä»¥ç”¨é»˜è®¤ç»„ä»¶æ¥å®Œæˆã€‚ä¸åŒä¹‹å¤„åœ¨äºçˆ¶ç»„ä»¶ï¼Œåœ¨çˆ¶ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¡¨å•ç»„ä¸­å®šä¹‰ CVA æ¥å°†å…¶ç”¨ä½œæ™®é€šçš„è¡¨å•å­—æ®µã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºä¸€ä¸ªè¡¨å•çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶æŠŠå®ƒä½œä¸ºä¸€ä¸ªæ™®é€šçš„è¡¨å•åŸŸæ¥ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„è¡¨å•æ¥è¯¢é—®è¿™ä¸ªäººçš„å§“å’Œåï¼Œé‚£ä¹ˆå®ç°å¦‚ä¸‹:

```
@Component({
  selector: 'person-simple',
  template: `
    <div [formGroup]="form" class="form">
      <form-field
        formControlName="firstName"
        label="First name"
      ></new-form-field>
      <form-field
        formControlName="name"
        label="Name"
      ></new-form-field>
    </div>
  `,
  providers: [
    {
      provide: NG_VALIDATORS,
      useExisting: forwardRef(() => PersonSimpleComponent),
      multi: true,
    },
    {
      provide: NG_VALUE_ACCESSOR,
      useExisting: forwardRef(() => PersonSimpleComponent),
      multi: true,
    },
  ],
})
export class PersonSimpleComponent
  implements OnDestroy, ControlValueAccessor, Validator {
  destroy = new Subject()
  form = this.fb.group({
    name: [null, [Validators.required, Validators.minLength(2)]],
    firstName: [null, [Validators.required, Validators.minLength(2)]],
  })
  onTouched = () => {}

  constructor(private fb: FormBuilder) {}

  ngOnDestroy() {
    this.destroy.next()
    this.destroy.complete()
  }

  writeValue(value: any) {
    if (value) {
      this.form.setValue(value, { emitEvent: false })
    }
  }

  registerOnChange(fn: any) {
    this.form.valueChanges.pipe(takeUntil(this.destroy)).subscribe(fn)
  }

  registerOnTouched(fn: any) {
    this.onTouched = fn
  }

  setDisabledState(disabled: boolean) {
    disabled ? this.form.disable() : this.form.enable()
  }

  validate(control: AbstractControl): ValidationErrors | null {
    if (control.touched) {
      ValidationUtils.touchAllFormElements(this.form)
    }

    if (this.form.valid) {
      return null
    }

    return {
      'person-error': {
        value: this.form.value,
      },
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å…è®¸æˆ‘ä»¬åœ¨çˆ¶è¡¨å•ä¸­ä½¿ç”¨è¿™ä¸ªç»„ä»¶::

```
<person-simple formControlName="person1"></person-simple>
<person-simple formControlName="person2"></person-simple> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸¤ä¸ªäººåœ¨çˆ¶è¡¨å•ç»„ä¸­è¢«å®šä¹‰ä¸ºè¡¨å•æ§ä»¶:

```
form = this.fb.group({
  person1: [null],
  person2: [null],
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

äº§ç”Ÿäº†ä¸‹é¢çš„è¡¨å•å€¼:

```
{  "person1":  {  "name":  "Sarah",  "firstName":  "Smith"  },  "person2":  {  "name":  "John",  "firstName":  "Smith"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#form-validation)è¡¨å•éªŒè¯

åœ¨å‰é¢çš„ä»£ç ç‰‡æ®µä¸­å·²ç»å¯ä»¥çœ‹åˆ°å…³äºéªŒè¯çš„ä¸€ç¥ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¬¡æ„Ÿå—åˆ°äº†æ¯æ¬¡å¿…é¡»å®ç°è¡¨å•éªŒè¯æ—¶ç¼–å†™å’Œç»´æŠ¤ç›¸åŒä»£ç çš„ç—›è‹¦ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªé”™è¯¯å®¹å™¨ï¼Œå®ƒå”¯ä¸€çš„èŒè´£å°±æ˜¯æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚

```
@Component({
  selector: 'error-message-container',
  template: `
    <div
      class="error-message"
      [style.visibility]="control.touched ? 'visible' : 'hidden'"
    >
      {{ control.errors | humanizeMessages: errorMessages }}
    </div>
  `,
})
export class ErrorMessageContainerComponent {
  @Input() control: FormControl
  @Input() errorMessages?: { [key: string]: string }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª`humanizeFormMessages`ç®¡é“æ¥å°†é”™è¯¯æ˜ å°„åˆ°ä¸€æ¡äººç±»å‹å¥½çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬æ³¨å…¥åŒ…å«é»˜è®¤æ¶ˆæ¯çš„`FormMessages`ã€‚å¦‚æœé»˜è®¤è¡Œä¸ºæ²¡æœ‰ä¾‹å¤–ï¼Œä¼ä¸šç¯å¢ƒå°±ä¸æ˜¯ä¼ä¸šç¯å¢ƒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ç‰¹å®šäºæ¡ˆä¾‹çš„æ¶ˆæ¯è¦†ç›–é»˜è®¤æ¶ˆæ¯ã€‚

```
@Pipe({ name: 'humanizeFormMessages' })
export class HumanizeFormMessagesPipe implements PipeTransform {
  constructor(@Inject(FormMessages) private messages) {}

  transform(
    validationErrors: ValidationErrors,
    overriddenMessages: { [key: string]: string }
  ) {
    if (!validationErrors) {
      return ''
    }

    // Allow the possibility to override messages
    const messages = {
      ...this.messages,
      ...overriddenMessages,
    }

    const messageKey = Object.keys(validationErrors)[0]
    const getMessage = messages[messageKey]
    const message = getMessage
      ? getMessage(validationErrors[messageKey])
      : 'Invalid field'
    return message
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#creating-wizards-with-raw-formgroupdirective-endraw-)ç”¨`FormGroupDirective`åˆ›é€ å¥‡æ‰

ä¸ºäº†è®©å¤§çš„å‘å¯¼è¡¨å•æ›´å®¹æ˜“ç®¡ç†ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬åˆ†æˆäº†å¤šä¸ªå°æ­¥éª¤ã€‚å¯¹äºå‘å¯¼ä¸­çš„æ¯ä¸€æ­¥ï¼Œæˆ‘ä»¬éƒ½åˆ›å»ºå®ƒè‡ªå·±çš„ç‹¬ç«‹å½¢å¼ã€‚å‘å¯¼çª—ä½“æ˜¯ç”±æ‰€æœ‰è¿™äº›å°çª—ä½“ç¼åˆåœ¨ä¸€èµ·ç»„æˆçš„ã€‚è¿™æé«˜äº†å¯ç»´æŠ¤æ€§å’Œæµ‹è¯•èƒ½åŠ›ã€‚é€šè¿‡è¿™ç§æ¾æ•£è€¦åˆï¼Œå¯¹è¡¨å•è¿›è¡Œä¸€äº›ä¿®æ”¹å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œæ‚¨å¯ä»¥é€‰æ‹©åœ¨ä¸åŒçš„å±å¹•ä¸­é‡å¤ä½¿ç”¨æ­¥éª¤è¡¨å•ï¼Œä¾‹å¦‚åœ¨å‘å¯¼ä¸­ä½¿ç”¨è¡¨å•ï¼Œä»¥åŠå°†è¡¨å•ä½œä¸ºç‹¬ç«‹çš„è¡¨å•ä½¿ç”¨ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½¿ç”¨ [FormGroupDirective](https://angular.io/api/forms/FormGroupDirective) ä½œä¸º [ControlContainer](https://angular.io/api/forms/ControlContainer) ï¼Œå¹¶é€šè¿‡ [viewProviders](https://angular.io/api/core/Component#viewproviders) æä¾›å®ƒä»¬(è€Œä¸æ˜¯é€šè¿‡`providers`)ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨ç»„ä»¶å†…éƒ¨æ³¨å…¥`FormGroupDirective`å¹¶å°†å­è¡¨å•é™„åŠ åˆ°å…¶çˆ¶è¡¨å•ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­è¿™æ˜¯å‘å¯¼ã€‚

```
@Component({
  selector: 'child-form',
  templateUrl: './child-form.component.html',
  styleUrls: ['./child-form.component.scss'],
  viewProviders: [
    { provide: ControlContainer, useExisting: FormGroupDirective },
  ],
})
export class ChildFormComponent implements OnInit {
  form = this.fb.group({
    firstName: [null, [Validators.required]],
    lastName: [null, [Validators.required]],
  })

  constructor(
    private parentForm: FormGroupDirective,
    private fb: FormBuilder
  ) {}

  ngOnInit() {
    this.parentForm.form.addControl('person', this.form)
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#testing-forms)æ£€æµ‹è¡¨æ ¼

ä¸ºäº†æµ‹è¯•æˆ‘ä»¬çš„è¡¨å•ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†[@ angular-extensions/testing-library](https://github.com/angular-extensions/testing-library)ï¼Œè¿™æ˜¯ä¸€ä¸ªå›´ç»• [dom-testing-library](https://github.com/kentcdodds/dom-testing-library) çš„ Angular åŒ…è£…å™¨ã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•æµ‹è¯•å®ç°ç»†èŠ‚ï¼Œä¹Ÿæ— æ³•æŒ‰ç…§ç”¨æˆ·ä½¿ç”¨è¡¨å•çš„æ–¹å¼æµ‹è¯•è¡¨å•ã€‚

æˆ‘ä»¬é€šè¿‡ä½¿ç”¨è¡¨å•æ ‡ç­¾å¯¼èˆªåˆ°è¡¨å•å­—æ®µï¼Œé€šè¿‡å•å‡»æäº¤æŒ‰é’®æäº¤è¡¨å•ã€‚æˆ‘ä»¬ä¸å…³å¿ƒè¡¨å•ç»„ä»¶çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯ç”¨æˆ·çœ‹åˆ°äº†ä»€ä¹ˆã€‚

```
test('login form submits using the component syntax', async () => {
  const fakeUser = { username: 'jackiechan', password: 'hiya! ğŸ¥‹' }
  const login = {
    emit: jest.fn(),
  }

  const { getByLabelText, getByText, input } = await createComponent(
    {
      component: LoginFormComponent,
      parameters: {
        login,
      },
    },
    {
      declarations: [LoginFormComponent],
      imports: [ReactiveFormsModule],
    }
  )

  input(getByLabelText('Username'), {
    target: {
      value: '',
    },
  })

  // If the text is not found the test will fail
  getByText('Username is required')

  input(getByLabelText('Username'), {
    target: {
      value: fakeUser.username,
    },
  })

  input(getByLabelText('Password'), {
    target: {
      value: fakeUser.password,
    },
  })

  submit(getByText('Create new account'))

  expect(login.emit).toHaveBeenCalledTimes(1)
  expect(login.emit).toHaveBeenCalledWith(fakeUser)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€äº›èµ„æº

*   [Angular Formsâ€“Angular connect 2017](https://www.youtube.com/watch?v=CD_t3m2WMM8&)ä½œè€…[å¡æ‹‰Â·åŸƒé‡Œå…‹æ£®](https://twitter.com/karaforthewin)
*   [åœ¨ä»¥è§’åº¦å½¢å¼å®ç° ControlValueAccessor æ—¶å†ä¹Ÿä¸è¦è¢«å¼„ç³Šæ¶‚äº†](https://blog.angularindepth.com/never-again-be-confused-when-implementing-controlvalueaccessor-in-angular-forms-93b9eee9ee83)ä½œè€… [Max Koretskyi](https://twitter.com/maxkoretskyi)
*   [é€šè¿‡](https://netbasal.com/make-your-angular-forms-error-messages-magically-appear-1e32350b7fa5) [Netanel Basal](https://twitter.com/NetanelBasal) è®©ä½ çš„è§’å½¢é”™è¯¯ä¿¡æ¯ç¥å¥‡çš„å‡ºç°
*   [Angular:åµŒå¥—æ¨¡æ¿é©±åŠ¨è¡¨å•](https://medium.com/@a.yurich.zuev/angular-nested-template-driven-form-4a3de2042475)ä½œè€…[é˜¿åˆ—å…‹è°¢Â·ç¥–è€¶å¤«](https://twitter.com/yurzui)
*   [é‡Šæ”¾åŠ›é‡ğŸ’ªå½¢å¼ä¸è§’åº¦çš„ååº”å½¢å¼](https://blog.angularindepth.com/unleash-the-power-of-forms-with-angulars-reactive-forms-d6be5918f408)ä½œè€…[è¥¿è¾¾å°”ç‰¹Â·é˜¿æ°æ‹‰](https://twitter.com/SiddAjmera)
*   [æ½œå…¥æ— åŠŸå½¢ç›¸](https://blog.angularindepth.com/dive-into-reactive-forms-cfc9adbb4467)ç”±[æ— åŠŸç‹](https://twitter.com/thekiba_io)
*   [æ§åˆ¶å€¼å­˜å–å™¨â€”â€”å°±åƒç©ºé—´ä¸­çš„è™«æ´ï¼Œå¯¹ä½ çš„å½¢å¼æ¥è¯´ï¼Œåªæ˜¯æ›´æœ‰ç”¨è€Œå·²](https://www.youtube.com/watch?v=kVbLSN0AW-Y)ä½œè€…[è©¹å¦®å¼—Â·ç“¦å¾·æ‹‰](https://twitter.com/likeOMGitsFEDAY)