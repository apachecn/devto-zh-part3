# çº¯è„šæœ¬é“¶è¡Œå½¢

> åŸæ–‡:[https://dev.to/riccardoodone/bank-kata-in-purescript-3dmp](https://dev.to/riccardoodone/bank-kata-in-purescript-3dmp)

ä½ å¯ä»¥ç»§ç»­åœ¨è¿™é‡Œé˜…è¯»æˆ–è€…[è·³è½¬åˆ°æˆ‘çš„åšå®¢](https://odone.io/posts/2019-03-13-bank-kata-in-purescript.html)æ¥è·å¾—å®Œæ•´çš„ä½“éªŒï¼ŒåŒ…æ‹¬ç¾å¦™çš„ç²‰è‰²ã€è“è‰²å’Œç™½è‰²è°ƒè‰²æ¿ã€‚

* * *

[![](../Images/0136869e66db77c7f67250c9edde36d2.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--MLZLt5r6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2Awy9M28S1h8KHOav3b2DBBw.jpeg)

## [T1ã€‘ç®€ä»‹](#intro)

æˆ‘åœ¨ FP æ–¹é¢å¾ˆçƒ‚ï¼Œæˆ‘éå¸¸éœ€è¦ä½ çš„ä¸€äº›åé¦ˆã€‚æ‰€ä»¥è¯·ä¸è¦å¯¹ä»£ç ç”Ÿæ°”ã€‚å¦‚æœä½ æœ‰ä»»ä½•åé¦ˆï¼Œè¯·åˆ†äº«ï¼ï¼

## [](#the-kata)æ­¦å£«å½¢

è®©æˆ‘ä»¬é¦–å…ˆé€šè¿‡å¤åˆ¶/ç²˜è´´ç‰›é€¼çš„[æ­¦å£«é“æ—¥å¿—](http://kata-log.rocks/banking-kata)æ¥ä»‹ç»æ­¦å£«é“:

> ç¼–å†™ä¸€ä¸ªæä¾›ä»¥ä¸‹æ–¹æ³•çš„ç±»å¸æˆ· void deposit(int) void å–æ¬¾(int) String printStatement()

ä¸€ä¸ªç¤ºä¾‹è¯­å¥æ˜¯:

```
Date Amount Balance
24.12.2015 +500 500
23.8.2016 -100 400 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#types)ç±»å‹

`void deposit(int)`å’Œ`void withdraw(int)`æ˜¯ä¸çº¯å‡½æ•°ã€‚äº‹å®ä¸Šï¼Œä»–ä»¬æ¥å—ä¸€ä¸ª`int`å¹¶è¿”å›`void`ã€‚ä»–ä»¬èƒ½åšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…çš„å”¯ä¸€æ–¹æ³•æ˜¯æ”¹å˜ä¸€äº›çŠ¶æ€ã€‚

`String printStatement()`ä¹Ÿä¸çº¯æ´ã€‚äº‹å®ä¸Šï¼Œå®ƒä¼šæ— ä¸­ç”Ÿæœ‰åœ°è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å®ƒåšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…çš„å”¯ä¸€æ–¹æ³•æ˜¯è®¿é—®æŸä¸ªçŠ¶æ€ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†æŠŠ`printStatement`å½“ä½œ`void printStatement()`æ¥å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥å‡½æ•°å°†åœ¨æ§åˆ¶å°ä¸­æ‰“å°è¯¥è¯­å¥ã€‚åŸå› æ˜¯ä¸çŸ¥é“è¦ä¸ç„¶æ€ä¹ˆç¼–ç ã€‚

åœ¨ PureScript ä¸­è¯»/å†™çŠ¶æ€çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨[çŠ¶æ€å•å­è½¬æ¢å™¨](https://pursuit.purescript.org/packages/purescript-transformers/4.2.0/docs/Control.Monad.State.Trans#t:StateT) ( `StateT`)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹ç±»å‹:

```
deposit :: Int -> StateT (Array Transaction) Effect Unit

withdraw :: Int -> StateT (Array Transaction) Effect Unit

printStatement :: StateT (Array Transaction) Effect Unit 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬çš„ä¸‰ä¸ªå‡½æ•°å°†åœ¨`StateT (Array Transaction) Effect Unit`ç¯å¢ƒä¸­å‘æŒ¥ä½œç”¨ã€‚æ›´ç®€å•åœ°è¯´ï¼Œæ¯ä¸ªå‡½æ•°å°†èƒ½å¤Ÿæ“ä½œä¸€ç»„äº‹åŠ¡(çŠ¶æ€)ï¼Œå†™å…¥æ§åˆ¶å°æˆ–è·å–æ—¥æœŸæ—¶é—´(`Effect`ä¸­çš„ä¸€å…ƒæ“ä½œ)ï¼Œå¹¶æœ€ç»ˆä¸è¿”å›ä»»ä½•å†…å®¹(`Unit`)ã€‚

è¿™é‡Œæˆ‘ä»¬æœ‰`Transaction` :
çš„ç±»å‹

```
data Transaction
 = Deposit Info
 | Withdraw Info

type Info =
 { timestamp :: DateTime
 , amount :: Int
 } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#implementation)å®ç°

å…ˆè¯´`deposit` :

```
deposit :: Int -> StateT (Array Transaction) Effect Unit
deposit amount = do
 ts <- lift nowDateTime
 let t = Deposit { timestamp: ts, amount: amount }
 modify_ \ts -> ts <> [t] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› ä¸ºæˆ‘ä»¬å¤„äºä¸€å…ƒç¯å¢ƒ(`StateT (Array Transaction) Effect Unit`)ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸€ä¸ª`do`æ¥æ‰“å¼€å‡½æ•°ã€‚

ç„¶åæˆ‘ä»¬ä½¿ç”¨`nowDateTime :: Effect DateTime`æ¥è·å–å½“å‰çš„æ—¥æœŸæ—¶é—´ã€‚è¿™é‡Œå”¯ä¸€çš„é—®é¢˜æ˜¯æˆ‘ä»¬éœ€è¦é¦–å…ˆåœ¨`StateT (Array Transaction) Effect Unit`åˆ°è¾¾`lift nowDateTime`ã€‚è¿™æ˜¯å› ä¸ºåœ¨`do`å—ä¸­ï¼Œæ¯ä¸ªä¸€å…ƒæ“ä½œ(å³é`let`æ“ä½œ)éƒ½å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ä¸€å…ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€`lift nowDateTime`å’Œ`modify_ \ts -> ts <> [t]`éƒ½æœ‰ç±»å‹`StateT (Array Transaction) Effect a`ã€‚

ä¹‹åï¼Œ`timestamp`å’Œ`amount`æ­£ç¡®çš„å­˜æ¬¾è¢«åˆ†é…ç»™`t`ã€‚

æœ€åï¼Œ [`modify_`](https://pursuit.purescript.org/packages/purescript-transformers/4.2.0/docs/Control.Monad.State#v:modify_) ç”¨äºé€šè¿‡è¿½åŠ æ–°çš„äº‹åŠ¡`t`æ¥è®¿é—®å½“å‰çŠ¶æ€`ts`(äº‹åŠ¡æ•°ç»„)ã€‚

`withdraw`å·®ä¸å¤š:

```
withdraw :: Int -> StateT (Array Transaction) Effect Unit
withdraw amount = do
 ts <- lift nowDateTime
 let t = Withdraw { timestamp: ts, amount: amount }
 modify_ \ts -> ts <> [t] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åï¼Œæˆ‘ä»¬æœ‰`printStatement` :

```
printStatement :: StateT (Array Transaction) Effect Unit
printStatement = do
 s <- gets toStatement
 lift $ log s 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬ä¸€è¡Œä½¿ç”¨ [`gets`](https://pursuit.purescript.org/packages/purescript-transformers/4.2.0/docs/Control.Monad.State#v:gets) è·å–çŠ¶æ€(äº‹åŠ¡æ•°ç»„)å¹¶é€šè¿‡`toStatement :: Array Transaction -> String`è¿è¡Œå®ƒã€‚è¿™æ„å‘³ç€`gets toStatement`æœ‰ç±»å‹`Effect String`ï¼Œè€Œ`s`æœ‰ç±»å‹`String`ã€‚

æœ€åä¸€æ¡çº¿åœ¨`StateT (Array Transaction) Effect Unit`å¤„æå‡`log s :: Effect Unit`ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒå°†`s`æ‰“å°åˆ°æ§åˆ¶å°ã€‚

`toStatement`çš„å®ç°æ²¡é‚£ä¹ˆé‡è¦ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­:

```
toStatement :: Array Transaction -> String
toStatement =
 fst <<< foldl fnc (Tuple "" 0)
 where
 fnc (Tuple s i) (Deposit d) =
 Tuple (s <> "\n" <> joinWith " " [show d.timestamp, show d.amount, show $ i + d.amount]) (i + d.amount)
 fnc (Tuple s i) (Withdraw w) =
 Tuple (s <> "\n" <> joinWith " " [show w.timestamp, "-" <> show w.amount, show $ i - w.amount]) (i - w.amount) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#fire-it-up)ç‚¹ç«å§

ç°åœ¨æˆ‘ä»¬å¯ä»¥å†™ç±»ä¼¼äº
çš„ä¸œè¥¿

```
do
 deposit 500
 withdraw 100
 printStatement 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¶ç±»å‹ä¸º`StateT (Array Transaction) Effect Unit`ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ [`evalStateT`](https://pursuit.purescript.org/packages/purescript-transformers/4.2.0/docs/Control.Monad.State.Trans#v:evalStateT) æ¥è¿è¡Œè®¡ç®—ã€‚æ³¨æ„ï¼Œä¸‹é¢çš„ä»£ç è¿”å›äº†`Effect Unit`ã€‚

```
flip evalStateT [] do
 deposit 500
 withdraw 100
 printStatement 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#show-me-the-code)æ˜¾ç¤ºä»£ç 

è¿™é‡Œæˆ‘ä»¬æœ‰æ‰€æœ‰çš„ä»£ç 

```
data Transaction
  = Deposit Info
  | Withdraw Info

type Info =
  { timestamp :: DateTime
  , amount    :: Int
  }

deposit :: Int -> StateT (Array Transaction) Effect Unit
deposit amount = do
  ts <- lift nowDateTime
  let t = Deposit { timestamp: ts, amount: amount }
  modify_ \ts -> ts <> [t]

withdraw :: Int -> StateT (Array Transaction) Effect Unit
withdraw amount = do
  ts <- lift nowDateTime
  let t = Withdraw { timestamp: ts, amount: amount }
  modify_ \ts -> ts <> [t]

printStatement :: StateT (Array Transaction) Effect Unit
printStatement = do
  s <- gets toStatement
  lift $ log s

toStatement :: Array Transaction -> String
toStatement =
  fst <<< foldl fnc (Tuple "" 0)
  where
  fnc (Tuple s i) (Deposit d) =
    Tuple (s <> "\n" <> joinWith " " [ show d.timestamp, show d.amount, show $ i + d.amount]) (i + d.amount)
  fnc (Tuple s i) (Withdraw w) =
    Tuple (s <> "\n" <> joinWith " " [ show w.timestamp, "-" <> show w.amount, show $ i - w.amount]) (i - w.amount)

main :: Effect Unit
main = do
  flip evalStateT [] do
    deposit 500
    withdraw 100
    printStatement 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#outro)å…¶ä»–

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªå¸–å­ï¼Œå¹¶æƒ³å¸®åŠ©ä¼ æ’­è¿™ä¸ªæ¶ˆæ¯ï¼Œè¯·å‘å‡ºä¸€äº›å£°éŸ³ğŸ¤˜ä½†å‰ææ˜¯ä½ çœŸçš„å–œæ¬¢å®ƒã€‚å¦åˆ™ï¼Œè¯·éšæ—¶è¯„è®ºæˆ–å‘æ¨ç‰¹ç»™æˆ‘ä»»ä½•å»ºè®®æˆ–åé¦ˆã€‚

æ„Ÿè°¢åˆ©äºšå§†Â·æ ¼é‡ŒèŠ¬(Liam Griffin)å¯å‘æˆ‘ç”¨çº¯è„šæœ¬çš„æ–¹å¼å°è¯•è¿™ä¸ªç»ƒä¹ ï¼Œè€Œ[åœ¨ Haskell](https://medium.com/@Gryff/bank-kata-in-haskell-dealing-with-state-3364c13b994f) çš„å¸–å­ã€‚

æœ€åï¼Œæˆ‘æƒ³å¯¹ BusConf å’Œæ‰€æœ‰æ”¯æŒæˆ‘çš„ PureScript ä¹‹æ—…çš„äººå¤§å£°ç–¾å‘¼ã€‚ä½ çœŸæ£’ï¼

å¦‚æœä½ æ¸´æœ›æ›´å¤šï¼Œçœ‹çœ‹æˆ‘ä»¬å¦‚ä½•åœ¨åç»­æµ‹è¯•ä»£ç :[åœ¨ PureScript ä¸­æµ‹è¯•é“¶è¡Œå½¢](https://dev.to/riccardoodone/testing-bank-kata-in-purescript-16k8)ã€‚

* * *

ä»æˆ‘ä¸ªäººçš„ç”µå­é‚®ä»¶ä¸­è·å–æœ€æ–°å†…å®¹ã€‚ç”¨ä½ çš„æƒ³æ³•å›å¤ã€‚è®©æˆ‘ä»¬äº’ç›¸å­¦ä¹ ã€‚è®¢é˜…æˆ‘çš„ [PinkLetter](https://odone.io#newsletter) ï¼