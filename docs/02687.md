# ä½¿ç”¨ç”Ÿç‰©è®¡é‡æç¤ºä¿æŠ¤æ•°æ®

> åŸæ–‡:[https://dev . to/rani lch/securing-data-with-biometric prompt-35mo](https://dev.to/ranilch/securing-data-with-biometricprompt-35mo)

åœ¨ Android 9 Pie ä¹‹å‰ï¼Œå®ç°æŒ‡çº¹æ‰«æå¯¹è¯æ¡†çš„é€‰é¡¹æœ‰:

*   ä»å¤´å¼€å§‹æ„å»ºæ‚¨è‡ªå·±çš„
*   å¤åˆ¶ Google çš„[ç¤ºä¾‹å®ç°](https://github.com/googlesamples/android-FingerprintDialog)
*   ä½¿ç”¨ä¸€äº›éå®˜æ–¹çš„å›¾ä¹¦é¦†

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸¤ç§é€‰æ‹©éƒ½ä¸å¤ªå¥½ã€‚å½“ç„¶ï¼Œé™¤éä½ æœ‰éå¸¸å…·ä½“çš„ UI éœ€æ±‚ï¼Œå¹¶ä¸”**éœ€è¦**æ¥æ„å»ºä½ è‡ªå·±çš„ UIã€‚ä½†æ˜¯å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œæœ‰ä¸€ä¸ªé€šç”¨çš„å¯¹è¯æ¡†å°±è¶³å¤Ÿäº†ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå®˜æ–¹çš„å°±æ›´å¥½äº†ã€‚

å¹¸è¿çš„æ˜¯ï¼Œè‡ªä» Android 9 Pie ä»¥æ¥ï¼ŒGoogle å·²ç»å¼•å…¥äº†ç”Ÿç‰©è®¡é‡æç¤ºæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ æ•´åˆå®ƒã€‚

å¹³å¿ƒè€Œè®ºï¼Œå…³äºè¿™ä¸ªé—®é¢˜å·²ç»æœ‰ä¸€äº›å¾ˆæ£’çš„åšå®¢æ–‡ç« äº†ã€‚ä½†æ˜¯é™¤äº†è£èª‰ä¹‹å¤–ï¼Œæˆ‘é‡åˆ°çš„äººç¼ºå°‘ä¸€äº›ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¡«è¡¥è¿™äº›ç©ºç™½ã€‚

Mark Ellison çš„æ–‡ç« å¾ˆæ£’ï¼Œä½†æ˜¯ä»–çš„ä¾‹å­åªé€‚ç”¨äº Android 9 Pieï¼Œå¹¶æ²¡æœ‰è§£å†³åŠ å¯†æ•°æ®çš„é—®é¢˜ã€‚ [Natig Babayev çš„å¸–å­](https://medium.com/mindorks/fingerprint-authentication-using-biometricprompt-compat-1466365b4795)ä¹Ÿå¾ˆç²¾å½©ï¼Œä½†å®ƒæ²¡æœ‰å±•ç¤ºå¦‚ä½•å°è£…å®ƒï¼Œä¹Ÿæ²¡æœ‰è§£å†³åŠ å¯†é—®é¢˜ã€‚

ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘æ¬¢è¿ï¼Œå¹¶å®é™…ä¸Šå¯»æ±‚åé¦ˆï¼Œæ‰€ä»¥è¯·éšæ„æ‰¹è¯„ã€‚

## [](#the-basics)åŸºç¡€çŸ¥è¯†

ç”±äºå¤§å¤šæ•° Android è®¾å¤‡åˆ¶é€ å•†è¦ä¹ˆåŠªåŠ›ï¼Œè¦ä¹ˆæ•…æ„é˜»æ­¢ï¼Œå°†ä»–ä»¬çš„è®¾å¤‡å‡çº§åˆ°æ–°çš„ Android ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä»ç„¶è¢«è¿«æ”¯æŒæ—§çš„ Android ç‰ˆæœ¬ã€‚

å¹¸è¿çš„æ˜¯ï¼Œè°·æ­Œæ­£åœ¨ç”¨ä»–ä»¬çš„ **AndroidX** åº“(ä»¥å‰è¢«ç§°ä¸ºæ”¯æŒåº“)åšç¹é‡çš„å·¥ä½œ

å› æ­¤ï¼Œé¦–å…ˆä½ éœ€è¦æ·»åŠ ä¸€ä¸ª**é™„åŠ ä¾èµ–é¡¹**æ¥åˆ©ç”¨æ—§ç‰ˆæœ¬ Android ä¸Šçš„ç”Ÿç‰©è¯†åˆ«æç¤ºã€‚

```
implementation 'androidx.biometric:biometric:1.0.0-alpha04' 
```

### [](#the-basic-components)åŸºæœ¬ç»„ä»¶

ç”Ÿç‰©è¯†åˆ«æç¤ºä¸­æ¶‰åŠçš„ä¸»è¦ç±»æ˜¯ï¼Œå¤šä¹ˆä»¤äººæƒŠè®¶ï¼Œå«åš`androidx.biometric.BiometricPrompt`ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å…¶å”¯ä¸€çš„å…¬å…±æ„é€ å‡½æ•°æ¥åˆ›å»ºå®ä¾‹:

```
/**
 * ...
 * 
 * @param fragmentActivity A reference to the client's activity.
 * @param executor An executor to handle callback events.
 * @param callback An object to receive authentication events.
 */
public BiometricPrompt(@NonNull FragmentActivity fragmentActivity,
                       @NonNull Executor executor, 
                       @NonNull AuthenticationCallback callback) 
```

ç¬¬ä¸‰ä¸ªå‚æ•°:`AuthenticationCallback`æ˜¯ä¸€ä¸ªæŠ½è±¡çš„é™æ€ç±»ï¼Œæœ‰ä¸‰ä¸ªéæŠ½è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä»æŠ€æœ¯ä¸Šæ¥è¯´æˆ‘ä»¬ä¸éœ€è¦é‡å†™å…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚

æ‰€ä»¥ä¸ºäº†ä¸€ä¸ªç®€å•çš„â€œhello-worldâ€æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªåŒ¿åå¯¹è±¡ï¼Œè€Œä¸ç”¨è¦†ç›–ä»»ä½•ä¸œè¥¿ã€‚

```
BiometricPrompt(fragmentActivity, executor, 
    object : BiometricPrompt.AuthenticationCallback() {}) 
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦æè¿°æç¤ºç¬¦æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚è¿™å°±æ˜¯`BiometricPrompt.PromptInfo`å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚å®ƒæ–¹ä¾¿åœ°æä¾›äº†ä¸€ä¸ªæ„å»ºå™¨ç±»:

```
val cancelString = activity.getString(android.R.string.cancel)
BiometricPrompt.PromptInfo.Builder()
    .setTitle("Prompt Title") // required
    .setSubtitle("Prompt Subtitle")
    .setDescription("Prompt Description: lorem ipsum")
    .setNegativeButtonText(cancelString) // required
    .build() 
```

åªèƒ½é…ç½®è¿™ä¹ˆå¤šã€‚è¿™åº”è¯¥æ˜¯ä¸è¨€è‡ªæ˜çš„ã€‚åªæœ‰*æ ‡é¢˜*å’Œ*å¦å®šæŒ‰é’®æ–‡æœ¬*æ˜¯å¿…éœ€çš„ã€‚

è¦å¯åŠ¨æç¤ºç¬¦ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯è°ƒç”¨ authenticate æ–¹æ³•ã€‚

```
val biometricPrompt = BiometricPrompt(...)
val promptInfo = BiometricPrompt.PromptInfo.Builder()...

biometricPrompt.authenticate(promptInfo) 
```

<figure>![](../Images/77edad426e81694703c2aa7498749548.png)

<figcaption>left: BiometricPrompt on Android 7 Nougat / right: BiometricPrompt on Android 9 Pie</figcaption>

</figure>

* * *

## [](#encryption)åŠ å¯†

åœ¨æˆ‘çœ‹æ¥ï¼ŒåŠ å¯†æ•°æ®é¦–å…ˆæ˜¯ä½¿ç”¨ç”Ÿç‰©è®¤è¯çš„æ ¸å¿ƒã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæœ‰æ•ˆçš„æç¤ºï¼Œæˆ‘ä»¬åº”è¯¥ç ”ç©¶ä¸€ä¸‹ã€‚

**âš ï¸ *é‡è¦å£°æ˜* âš ï¸æˆ‘ä¸æ˜¯æ·±å…¥çš„å®‰å…¨ä¸“å®¶ï¼ä»£ç ï¼Œç‰¹åˆ«æ˜¯é€‰æ‹©çš„åŠ å¯†å‚æ•°ï¼Œæ˜¯åŸºäºè°·æ­Œä¹‹å‰æåˆ°çš„[æ ·æœ¬](https://github.com/googlesamples/android-FingerprintDialog)ï¼Œåªæ˜¯é€‚åº”äº†æ–°çš„ç”Ÿç‰©è®¡é‡æç¤ºã€‚**

### [](#%C2%A0key-amp-cipher)é”®&å¯†ç 

ä¸ºäº†åŠ å¯†æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª**å¯†é’¥**å’Œä¸€ä¸ª**å¯†ç **ã€‚

```
fun createKey(): SecretKey {
  val algorithm = KeyProperties.KEY_ALGORITHM_AES
  val provider = "AndroidKeyStore"
  val keyGenerator = KeyGenerator.getInstance(algorithm, provider)

  val keyName = "MY_KEY"
  val purposes = KeyProperties.PURPOSE_ENCRYPT or KeyProperties.PURPOSE_DECRYPT
  val keyGenParameterSpec = KeyGenParameterSpec.Builder(keyName, purposes)
          .setBlockModes(BLOCK_MODE)
          .setEncryptionPaddings(PADDING)
          .setUserAuthenticationRequired(true)
          .build()

  keyGenerator.init(keyGenParameterSpec)
  return keyGenerator.generateKey()
}

fun getEncryptCipher(key: Key): Cipher {
  val algorithm = KeyProperties.KEY_ALGORITHM_AES
  val blockMode = KeyProperties.BLOCK_MODE_CBC
  val padding = KeyProperties.ENCRYPTION_PADDING_PKCS7
  return Cipher.getInstance("$algorithm/$blockMode/$padding").apply { 
    init(Cipher.ENCRYPT_MODE, key) 
  }
} 
```

è¿™é‡Œçš„ä¸»è¦å†…å®¹æ˜¯å¯†é’¥åˆ›å»ºæœŸé—´çš„`setUserAuthenticationRequired(true)`æ–¹æ³•è°ƒç”¨:

> è®¾ç½®è¯¥å¯†é’¥æ˜¯å¦ä»…åœ¨ç”¨æˆ·é€šè¿‡èº«ä»½éªŒè¯åæ‰è¢«æˆæƒä½¿ç”¨ã€‚
> 
> é»˜è®¤æƒ…å†µä¸‹ï¼Œæ— è®ºç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯ï¼Œè¯¥å¯†é’¥éƒ½è¢«æˆæƒä½¿ç”¨ã€‚

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€:è¦ä½¿ç”¨å¯†é’¥ï¼Œä½ å¿…é¡»æä¾›ä¸€ç§å½¢å¼çš„è®¤è¯ï¼Œå³ä½ çš„æŒ‡çº¹ã€‚å¦‚éœ€è¿›ä¸€æ­¥è§£é‡Šï¼Œè¯·å‚è€ƒ [Android æ–‡æ¡£](https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec.Builder#setUserAuthenticationRequired(boolean))ğŸ”

ç”±äºæ²¡æœ‰æŒ‡å®šå¯†é’¥é•¿åº¦ï¼ŒAndroid ä½¿ç”¨é»˜è®¤çš„å¯†é’¥é•¿åº¦:å¯¹äº AESï¼Œå®ƒè¢«è®¾ç½®ä¸º 128 ä½ã€‚æœ‰å…³ Android ä¸ŠåŠ å¯†æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ[æ–‡æ¡£](https://developer.android.com/guide/topics/security/cryptography)ğŸ”

### [](#using-the-cipher-to%C2%A0encrypt)ä½¿ç”¨å¯†ç å™¨è¿›è¡ŒåŠ å¯†

è¦ä½¿ç”¨å¯†ç åŠ å¯†æ•°æ®ï¼Œåªéœ€è°ƒç”¨å®ƒçš„`doFinal(byte[] input)`æ–¹æ³•ã€‚ä¸ºäº†ä»¥åçš„è§£å¯†ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒå¯†ç çš„åˆå§‹åŒ–å‘é‡ã€‚

```
val clearTextData: ByteArray
val encryptedData: ByteArray = cipher.doFinal(clearTextData)

// save encrypted data & init vector: i.e. in shared preferences
val dat = Base64.encodeToString(encryptedData, Base64.DEFAULT)
val iv  = Base64.encodeToString(cipher.iv, Base64.DEFAULT)
sharedPreferences.edit {
    putString(ENCRYPTED_DATA, dat)
    putString(INITIALIZATION_VECTOR, iv)
} 
```

## [](#decryption)è§£å¯†

è¦è§£å¯†åŠ å¯†æ•°æ®ï¼Œä½ éœ€è¦

*   ä»¥å‰åˆ›å»ºçš„ SecretKey
*   å…ˆå‰ä½¿ç”¨çš„åˆå§‹åŒ–å‘é‡
*   è§£å¯†å¯†ç 

```
fun getKey(): Key? {
  val keyStore: KeyStore = KeyStore.getInstance("AndroidKeyStore").apply { 
    load(null) 
  }
  return keyStore.getKey("MY_KEY", null)
}

fun getDecryptCipher(key: Key, iv: ByteArray): Cipher {
  val algorithm = KeyProperties.KEY_ALGORITHM_AES
  val blockMode = KeyProperties.BLOCK_MODE_CBC
  val padding = KeyProperties.ENCRYPTION_PADDING_PKCS7
  return Cipher.getInstance("$algorithm/$blockMode/$padding").apply { 
    init(Cipher.DECRYPT_MODE, key, IvParameterSpec(iv)) 
  }
} 
```

### [](#using-the-cipher-to%C2%A0decrypt)ä½¿ç”¨å¯†ç å™¨è§£å¯†

è¿™éå¸¸ç®€å•ï¼Œç±»ä¼¼äºåŠ å¯†è°ƒç”¨

```
val encryptedData: ByteArray = getEncryptedData()
val clearTextData: ByteArray = cipher.doFinal(encryptedData) 
```

* * *

## [](#tink-different)â€œå®å®â€ä¸åŒ

å°±åƒæˆ‘å‰é¢æåˆ°çš„ï¼Œæˆ‘ä¸æ˜¯ä¸€ä¸ªæ·±å…¥çš„å®‰å…¨ä¸“å®¶ã€‚å¯¹äºåƒæˆ‘(å’Œå…¶ä»–äºº)è¿™æ ·çš„äººæ¥è¯´ï¼Œè°·æ­Œåˆ›é€ äº† Tinkï¼Œç›®çš„æ˜¯ä½¿åŠ å¯†æ›´ç®€å•ï¼Œæ›´éš¾è¢«æ»¥ç”¨ã€‚

æœ‰äº† Tink çš„ Android é£æ ¼`com.google.crypto.tink:tink-android:1.2.2`ï¼Œæ•´ä¸ªåŠ å¯†/è§£å¯†å¯ä»¥åˆ†è§£æˆæ›´ç®€å•ã€æ›´å®¹æ˜“ç†è§£çš„ä»£ç :

```
Config.register(TinkConfig.LATEST)

val keysetHandle = AndroidKeysetManager.Builder()
        .withSharedPref(activity, TINK_KEYSET_NAME, null)
        .withKeyTemplate(AeadKeyTemplates.AES256_GCM)
        .withMasterKeyUri(MASTER_KEY_URI)
        .build().keysetHandle

val aead = AeadFactory.getPrimitive(keysetHandle)
val encrypted = aead.encrypt("SECRET!".toByteArray(), null)
val cleartext = aead.decrypt(encrypted, null) 
```

æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„å¾ˆå¤šå†…éƒ¨ä¿¡æ¯ç°åœ¨éƒ½è¢«éšè—äº†:å¯†ç ã€åˆå§‹åŒ–å‘é‡ã€åŠ å¯†å‚æ•°ç­‰ç­‰ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œä¹‹å‰è®¨è®ºçš„æ ‡å¿—`setUserAuthenticationRequired`æ²¡æœ‰è®¾ç½®ï¼Œå¹¶ä¸”ç›®å‰ä¸å¯èƒ½å°†è¿™ä¸ª AEAD(å¸¦æœ‰ç›¸å…³æ•°æ®çš„è®¤è¯åŠ å¯†)ä¼ é€’ç»™ç”Ÿç‰©è®¡é‡æç¤ºè¿›è¡Œâ€œè®¤è¯â€ã€‚

ä¸ºæ­¤ï¼Œæˆ‘åœ¨ Github ä¸Šåˆ›å»ºäº†ä¸€ä¸ª[é—®é¢˜ã€‚å½“æœ‰å…³äºæ­¤äº‹çš„æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä¼šå†™ä¸€ç¯‡åç»­æ–‡ç« ã€‚](https://github.com/google/tink/issues/211)

* * *

## [](#tying-things%C2%A0together)æŠŠäº‹æƒ…è”ç³»åœ¨ä¸€èµ·

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå·¥ä½œæç¤ºï¼Œå¹¶äº†è§£äº†å¦‚ä½•åŠ å¯†æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸¤è€…ç»“åˆèµ·æ¥ã€‚åªéœ€å°†åŠ å¯†/è§£å¯†æ‰€éœ€çš„å¯†ç ä¼ é€’ç»™ç”Ÿç‰©è®¡é‡æç¤º:

```
val promptCrypto = BiometricPrompt.CryptoObject(cipher)
biometricPrompt.authenticate(promptInfo, promptCrypto) 
```

ä½ ä¼ å…¥çš„ CryptoObject å°†è¢«â€œè§£é”â€(è¿˜è®°å¾—æˆ‘ä»¬åœ¨åˆ›å»ºå¯†é’¥æ—¶è®¾ç½®çš„æ ‡å¿—)å¹¶è¢«ä¼ é€’ç»™ä¹‹å‰çœ‹åˆ°çš„`AuthenticationCallback`
çš„`onAuthenticationSucceeded`å›è°ƒæ–¹æ³•

```
override fun onAuthenticationSucceeded(result: BiometricPrompt.AuthenticationResult) {
    super.onAuthenticationSucceeded(result)
    result.cryptoObject?.cipher?.let { cipher ->
        // encrypt or decrypt data with cipher
    }
} 
```

### [](#handling-errors)å¤„ç†é”™è¯¯

é™¤äº† succeeded å›è°ƒæ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸¤ç§é’ˆå¯¹å¤±è´¥å°è¯•çš„å›è°ƒæ–¹æ³•:

`onAuthenticationFailed` *ã€å½“ç”Ÿç‰©ç‰¹å¾æœ‰æ•ˆä½†æœªè¢«è¯†åˆ«æ—¶è°ƒç”¨ã€‘*ã€‚è¿™å¯èƒ½ä¸æ˜¯ä½ éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œå› ä¸ºæç¤ºç¬¦ä¸­å·²ç»å®ç°äº†ä¸€ä¸ªé»˜è®¤åŠ¨ç”»ã€‚

`onAuthenticationError` *"é‡åˆ°ä¸å¯æ¢å¤çš„é”™è¯¯ä¸”æ“ä½œå®Œæˆæ—¶è°ƒç”¨ã€‚ä¸ä¼šå¯¹è¯¥å¯¹è±¡æ‰§è¡Œä»»ä½•è¿›ä¸€æ­¥çš„æ“ä½œ"*

é”™è¯¯å›è°ƒæ–¹æ³•æä¾›äº†å¯ä»¥ç”¨æ¥å¤„ç†ä¸åŒé”™è¯¯å’Œæ˜¾ç¤ºåé¦ˆçš„`int errCode, CharSequence errString`ã€‚ä¾‹å¦‚

```
override fun onAuthenticationError(errorCode: Int, 
                                   errorString: CharSequence) {
    super.onAuthenticationError(errorCode, errString)
    when (errorCode) {
        ...
        BiometricPrompt.ERROR_TIMEOUT -> // user fell asleep ;-)
        ...
    }
} 
```

å‚è€ƒ [Android æ–‡æ¡£ï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„é”™è¯¯ä»£ç ](https://developer.android.com/reference/android/hardware/biometrics/BiometricPrompt.html#BIOMETRIC_ERROR_CANCELED)ã€‚

### [](#build-for-convenience)ä¸ºäº†æ–¹ä¾¿è€Œå»ºé€ 

ä¸ã€‚å°½ç®¡æœ‰å¾ˆå¤šä¸åŒçš„é”™è¯¯å¯ä»¥ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«æç¤ºæ¥å¤„ç†ï¼Œä½†æˆ‘è®¤ä¸ºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ åªéœ€è¦å¤„ç†ä¸¤ç§æƒ…å†µã€‚åŠ å¯†/è§£å¯†éƒ½æœ‰æ•ˆğŸ‘æˆ–è€…æ²¡æœ‰ğŸ‘

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¸å®ç°ä¸€ä¸ªæ”¯æŒç±»ï¼Œä¸ºè¿™ä¸¤ç§æƒ…å†µæä¾›æ–¹ä¾¿ï¼Œå¹¶å°è£…æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„æ‰€æœ‰å†…å®¹ã€‚API å»ºè®®:

```
fun encryptPrompt(data: ByteArray,
                  failedAction: () -> Unit,
                  successAction: () -> Unit)

fun decryptPrompt(failedAction: () -> Unit,
                  successAction: (ByteArray) -> Unit) 
```

æ‰€ä»¥åœ¨`AuthenticationCallback`çš„`succeeded`å’Œ`error`å›è°ƒä¸­æˆ‘ä»¬å¯ä»¥åšåˆ°ä»¥ä¸‹å‡ ç‚¹:

#### [](#%C2%A0encrypt-case)åŠ å¯†å¤§å°å†™

```
fun onAuthenticationSucceeded(result: AuthenticationResult) {
    super.onAuthenticationSucceeded(result)
    result.cryptoObject?.cipher?.let { resultCipher ->
        val iv = resultCipher.iv
        val encryptedData = resultCipher.doFinal(data)
        saveEncryptedData(encryptedData, iv)
        activity.runOnUiThread { successAction() }
    }
}

fun onAuthenticationError(errCode: Int, errStr: CharSequence) {
    super.onAuthenticationError(errCode, errStr)
    Log.d(TAG, "Authentication error. $errStr ($errCode)")
    activity.runOnUiThread { failedAction() }
} 
```

#### [](#decrypt-case)è§£å¯†æ¡ˆä¾‹

```
fun onAuthenticationSucceeded(result: AuthenticationResult) {
    super.onAuthenticationSucceeded(result)
    result.cryptoObject?.cipher?.let { cipher ->
        val encrypted = getEncryptedData()
        val decryptedData = cipher.doFinal(encrypted)
        activity.runOnUiThread { successAction(decryptedData) }
    }
}

fun onAuthenticationError(errCode: Int, errStr: CharSequence) {
    super.onAuthenticationError(errCode, errStr)
    Log.d(TAG, "Authentication error. $errStr ($errCode)")
    activity.runOnUiThread { failedAction() }
} 
```

### [](#usage)ç”¨æ³•

è¿™å°†ä½¿æ‚¨èƒ½å¤Ÿæ–¹ä¾¿åœ°ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«æç¤º:

```
val promptManager = BiometricPromptManager(fragmentActivity)
promptManager.encryptPrompt(
    data = secureText.toByteArray(),
    failedAction = { showToast("encrypt failed") },
    successAction = { showToast("encrypt success") }
)

promptManager.decryptPrompt(
    failedAction = { showToast("decrypt failed") },
    successAction = { showToast("decrypt success: $it") }
) 
```

### [](#alternatives)æ›¿ä»£å“

å½“ç„¶ï¼Œå¦‚æœä½ éœ€è¦æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†æˆ–è€…ä¸å–œæ¬¢è¿™ç§é£æ ¼ï¼Œä½ ä¹Ÿå¯ä»¥

*   ä½¿ç”¨è‡ªå®šä¹‰å“åº”ä»£ç å’Œ/æˆ–åœ¨ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸­å®Œæˆæ‰€æœ‰å·¥ä½œ
*   æ·»åŠ ä¸åŒçš„å›è°ƒæ“ä½œ(é’ˆå¯¹ä¸åŒçš„é”™è¯¯)
*   å°†é”™è¯¯ä»£ç ä¼ é€’ç»™ failedAction

* * *

## [](#issues)é—®é¢˜

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘åœ¨ Android 8 å’Œæ›´æ—©ç‰ˆæœ¬çš„ä¸€ä¸ªç‰‡æ®µä¸­ä½¿ç”¨ AndroidX ç”Ÿç‰©è¯†åˆ«æç¤ºæ—¶é‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ã€‚

```
java.lang.IllegalStateException: FragmentManager is already executing transactions 
```

æ® Stackoverflow ä¸Šçš„å…¶ä»–äººè¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹æ˜¯åœ¨æœ€æ–°çš„ alpha04 ç‰ˆæœ¬ä¸­å¼•å…¥çš„

*   [https://stack overflow . com/questions/55683300/Android-crashed-after-updating-androidx-biometric-to-1-0-0-alpha 04](https://stackoverflow.com/questions/55683300/android-crashed-after-updating-androidx-biometric-to-1-0-0-alpha04)
*   [https://stack overflow . com/questions/55934108/fragment manager-is-already-executing-transactions-when-executing-biometric prompt](https://stackoverflow.com/questions/55934108/fragmentmanager-is-already-executing-transactions-when-executing-biometricprompt)

è¦â€œè§£å†³â€è¿™ä¸ªé—®é¢˜:æ‚¨å¯ä»¥ä½¿ç”¨å¤„ç†ç¨‹åºäººå·¥å»¶è¿Ÿè°ƒç”¨ï¼Œæˆ–è€…æ¢å¤åˆ° alpha03 ç‰ˆæœ¬ã€‚

```
Handler().postDelayed({
        // launch biometric prompt for Fragment 
}, 0) 
```

* * *

å®Œæ•´çš„ä»£ç å¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ°:

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png)/[å®‰å“-æ ·æœ¬-ç”Ÿç‰©è¯†åˆ«-æç¤º](https://github.com/stravag/android-sample-biometric-prompt)

### ç”Ÿç‰©è¯†åˆ«æç¤ºç¤ºä¾‹åº”ç”¨ç¨‹åº

<article class="markdown-body entry-content container-lg" itemprop="text">

# å®‰å“-æ ·æœ¬-ç”Ÿç‰©è¯†åˆ«-æç¤º

ç”Ÿç‰©è¯†åˆ«æç¤ºç¤ºä¾‹åº”ç”¨ç¨‹åº

</article>

[View on GitHub](https://github.com/stravag/android-sample-biometric-prompt)

ç¼–ç å¿«ä¹ï¼

* * *

[![](../Images/1727c187ca740efdac8522e2f3b1985a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--1VdXQu0f--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/iu22ph3ksl2bsooujzi7.gif)