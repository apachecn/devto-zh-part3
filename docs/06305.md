# æˆ‘å¦‚ä½•è§£å†³è¿™ä¸ªä¸å¯èƒ½çš„ SQL æŸ¥è¯¢ï¼Ÿ

> åŸæ–‡:[https://dev . to/Andy/how-I-do-solve-this-impossible-SQL-query-275k](https://dev.to/andy/how-i-do-solve-this-impossible-sql-query-275k)

æ‰€ä»¥æˆ‘è¯•ç€ä» dev.to çš„æ•°æ®åº“é‡Œæ”¶é›†ä¸€äº›æ•°æ®ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒSQL ä¸æ˜¯æˆ‘çš„å¼ºé¡¹ï¼Œæˆ‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„ Ruby + Rails ç«¯ã€‚ä¸å¯èƒ½å¯èƒ½ä¸æ˜¯ä¸€ä¸ªæ°å½“çš„è¯ï¼Œä½†å¯¹æˆ‘æ¥è¯´ä¼¼ä¹ä¸å¤ªå¯èƒ½ï¼Œå› ä¸ºæˆ‘å·²ç»ä¸ºæ­¤å·¥ä½œäº† 4 ä¸ªå°æ—¶ã€‚ğŸ˜­

æˆ‘æƒ³ä»å‡ ä¸ªè¡¨ä¸­è·å–æ•°æ®:

*   `articles`è¡¨ã€
*   `collections`è¡¨ã€
*   `reactions`è¡¨ï¼Œå’Œ
*   `page_views`è¡¨ã€‚

`articles`è¡¨ä¸­æœ‰æˆ‘éœ€è¦çš„å‡ åˆ—:`id`ã€`title`ã€`published_at`ã€`positive_reactions_count`å’Œ`cached_tag_list`ã€‚

`collections`è¡¨åªæœ‰ä¸€ä¸ªæˆ‘éœ€è¦çš„åˆ—:`slug`ã€‚è¿™ä¸`articles`æ‰€åœ¨çš„`articles.collection_id = collections.id`æœ‰ç›´æ¥å…³ç³»ã€‚

`reactions`è¡¨ä¸`articles`è¡¨çš„å¤šæ€å…³ç³»ï¼Œå…¶ä¸­ä¸€ä¸ª`reaction`æœ‰ä¸€ä¸ª`reactable_id = articles.id`å’Œ`reactable_type = 'Article'`ã€‚æˆ‘éœ€è¦`SUM`ç»Ÿè®¡æ¯ä¸ªå¸–å­çš„èµã€ç‹¬è§’å…½å’Œé˜…è¯»åˆ—è¡¨ååº”çš„æ€»æ•°ã€‚

`page_views`è¡¨æœ‰æˆ‘éœ€è¦çš„ä¸‰åˆ—:`counts_for_number_of_views`ã€`time_tracked_in_seconds`ã€`referrer`ã€‚è¿™ä¸`articles`æ‰€åœ¨çš„`page_views.article_id = articles.id`æœ‰ç›´æ¥å…³ç³»ã€‚æˆ‘éœ€è¦å°†`counts_for_number_of_views`å’Œ`AVG`çš„`time_tracked_in_seconds`å‘ä¸Š`SUM`ã€‚

æˆ‘å°è¯•æ˜¾ç¤ºå¦‚ä¸‹æ‰€ç¤ºçš„è¡¨æ ¼ç»“æœ:

| æ–‡ç«  id | æ ‡é¢˜ | å‘å¸ƒäº | ç¼“å­˜æ ‡ç­¾åˆ—è¡¨ | ç³»åˆ— _ æ ‡é¢˜ | æ€»ååº” | æ€»ç‚¹èµæ•° | åˆè®¡ _ ç‹¬è§’å…½ | æ€»è®¡ _ ä¹¦ç­¾ | æ€»æµè§ˆé‡ | å¹³å‡èŠ±è´¹æ—¶é—´(ç§’) | æ¨èäºº |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| one | è¿™ä¸ªå¸–å­ | 2019-04-18 | sqlï¼Œpostgresqlï¼Œå¸®åŠ© | " SQL å¸®åŠ©" | one | one | one | five | Thirty | [https://dev.to](https://dev.to) |  |

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ— æ•ˆçš„æŸ¥è¯¢â€”â€”è¿˜æœ‰ä¸€äº›æˆ‘ä¸ç†è§£çš„å¯æ€•çš„å˜ä½“â€”â€”çœ‹èµ·æ¥åƒè¿™æ ·:

```
SELECT articles.id,
      articles.title,
      articles.published_at,
      articles.positive_reactions_count AS total_reactions,
      articles.cached_tag_list,
      collections.slug AS series_title,
      (SELECT COUNT(reactions.id) from reactions where reactions.category = 'like' AND reactions.reactable_id = articles.id AND reactions.reactable_type = 'Article') AS total_likes,
      (SELECT COUNT(reactions.id) from reactions where reactions.category = 'unicorn' AND reactions.reactable_id = articles.id AND reactions.reactable_type = 'Article') AS total_unicorns,
      (SELECT COUNT(reactions.id) from reactions where reactions.category = 'readinglist' AND reactions.reactable_id = articles.id AND reactions.reactable_type = 'Article') AS total_bookmarks,
      (SELECT SUM(page_views.counts_for_number_of_views) from page_views where page_views.article_id = articles.id) AS total_views,
      (SELECT AVG(page_views.time_tracked_in_seconds) from page_views where page_views.article_id = articles.id) AS total_views,
FROM articles
FULL JOIN collections ON collections.id = articles.collection_id
INNER JOIN reactions ON reactions.reactable_id = articles.id AND reactions.reactable_type = 'Article'
INNER JOIN page_views ON page_views.article_id = articles.id
WHERE articles.user_id = my_id
  AND articles.published = TRUE 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘è®¤ä¸ºæŸ¥è¯¢å’Œç¤ºä¾‹ç»“æœè¡¨æœ‰åŠ©äºæˆ‘è¯•å›¾æè¿°çš„å†…å®¹ã€‚è¿™è‚¯å®šè¶…å‡ºäº†æˆ‘çš„èƒ½åŠ›èŒƒå›´ï¼Œä½†ä¹Ÿè®¸æ¯”æˆ‘æƒ³è±¡çš„è¦å®¹æ˜“å¾—å¤šï¼Ÿ

## [](#update)æ›´æ–°:

æˆ‘æ·»åŠ äº†ä¸€ä¸ªé¢å¤–çš„`AND articles.id = my_article_id`æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚çœ‹èµ·æ¥å®ƒè·‘äº†ï¼ç„¶è€Œï¼Œç”±äºæŸç§åŸå› ï¼Œæˆ‘å¾—åˆ°äº† 952 è¡Œã€‚æˆ‘è®¤ä¸ºæˆ‘çš„åŠ å…¥ç”¨æ³•å¯èƒ½ä¸æ­£ç¡®...