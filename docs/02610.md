# ç”¨ ES6 Javascript ä¸­çš„ç”Ÿæˆå™¨å–æ¶ˆæ‰¿è¯º

> åŸæ–‡:[https://dev . to/tuanphuncz/canceling-promises-with-generators-in-es6-JavaScript-d01](https://dev.to/tuanphungcz/canceling-promises-with-generators-in-es6-javascript-d01)

åœ¨æˆ‘ä¹‹å‰å…³äºçš„åšæ–‡ä¸­ï¼Œæˆ‘è§£é‡Šäº† ES6 Javascript ä¸­ç”Ÿæˆå™¨çš„åŸºç¡€çŸ¥è¯†ã€‚å¦‚æœä½ æ²¡æœ‰è¯»è¿‡ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹çœ‹ğŸ‘‰[äº†è§£ ES6 Javacsript ä¸­çš„ç”Ÿæˆå™¨](https://dev.to/phung_cz/understanding-generators-in-es6-javascript-7fm)

ä½ ä»¬ä¸­çš„è®¸å¤šäººè¦æ±‚å‘ç”µæœºçš„çœŸå®ä½¿ç”¨æ¡ˆä¾‹ï¼Œæ‰€ä»¥æˆ‘å°†å±•ç¤ºæˆ‘é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚

# [](#introduction)ç®€ä»‹

ä½†æ˜¯ä¸ºäº†è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å¿…é¡»è¯´å‡ å¥æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„äº§å“ **Mews Navigator** ã€‚

> Navigator å…è®¸æ‚¨åœ¨çº¿åŠç†ç™»æœºæ‰‹ç»­ï¼Œå®‰å…¨åœ°å­˜å‚¨æ‚¨çš„ä¿¡ç”¨å¡è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶è®©æ‚¨å®Œå…¨æ§åˆ¶æ‚¨æƒ³è¦å…±äº«çš„ä¿¡æ¯ã€‚

ç°åœ¨ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨é€šè¿‡åº”ç”¨ç¨‹åºè¿›è¡Œåœ¨çº¿ç™»è®°ï¼Œå¹¶ä¸”æ­£åœ¨è¿›è¡Œæ”¯ä»˜æ­¥éª¤ã€‚

æ‰€ä»¥ä¸€æ—¦ä½ ç‚¹å‡»ä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªåŠ è½½å™¨ï¼Œç„¶åæ˜¯ä½ çš„æ”¯ä»˜å¡åˆ—è¡¨ï¼Œéå¸¸ç›´æ¥ï¼Œå¯¹å—ï¼Ÿ

[![Navigator payment step in online check-in](../Images/2ad7cd1826840049d23f07f514ef0783.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--lB4cRC2O--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://s3.gifyu.com/images/May-17-2019-00-31-08.gif)

## [](#rendering-the-payment-route)æ¸²æŸ“ä»˜æ¬¾è·¯çº¿

å®é™…ä¸Šï¼Œå¼•æ“ç›–ä¸‹çš„æƒ…å†µè¦å¤æ‚ä¸€äº›ã€‚åœ¨å‘ˆç°ç»„ä»¶ä¹‹å‰ï¼Œéœ€è¦è§£å†³å‡ ä¸ªæ­¥éª¤ã€‚

```
// Let's say user goes to this url:
// www.mews.li/navigator/check-in/payment/:reservationId

// 1\. This will check if the user is signed in.
// If yes go render <Dashboard /> if not go to <SignIn />
authAction(); // async

// 2\. We need to fetch the reservations
fetchReservations(); // async

// 3\. We need to check if `reservationId` and
// route itself is valid (If all checks pass go to next one)
isReservationIdValid({ reservations, currentReservation }); // sync

// 4\. Fetch paymentcards
fetchPaymentCards(); // async

// 5\. Fetching hotel entitites
fetchHotels(); // async

// 6\. Some of hotels uses PCI proxy vault, if it does,
// we need to initialize PCI proxy script.
doesHotelUsePciProxy({ hotels, hotelId }); // sync

// 7\. Fetch and init the script
initPciProxy(); // async 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å‘ˆç°ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›æ£€æŸ¥å’Œä¸€äº› API è·å–ã€‚

> é—®é¢˜æ˜¯ï¼Œå¦‚æœè¿™äº›æ£€æŸ¥ä¸­çš„ä»»ä½•ä¸€ä¸ªå¯èƒ½å¤±è´¥ï¼Œå¹¶ä¸”åŸºäºå“ªäº›æ£€æŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬å°†é‡å®šå‘åˆ°ä¸€ä¸ªç‰¹å®šçš„æ¡ˆä¾‹ã€‚

é‚£ä¹ˆå¦‚ä½•åœ¨ä¸ä½¿ç”¨ä»»ä½•å¤–éƒ¨åº“çš„æƒ…å†µä¸‹è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿè¿˜è®°å¾—ä¸Šæ¬¡æˆ‘ç»™ä½ ä»¬çœ‹è¿™ä¸ª[ä¾‹å­](https://dev.to/phung_cz/understanding-generators-in-es6-javascript-7fm)å—ï¼Ÿ

```
function* avengersGenerator() {
  yield "Hulk"; // Pausing the execution
  yield "Thor";
  yield "Iron man";
  return "Ultron"; // Exiting of finishing the generator
  yield "Spiderman";
}

const iterator = avengersGenerator();

iterator.next(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[æŸ¥çœ‹ codesandbox ä¸­çš„æºä»£ç ](https://codesandbox.io/s/7jkr9y3o81)

çœ‹ä¸€ä¸‹`return`çš„è¯´æ³•ã€‚è¿™å°†åœæ­¢æ‰§è¡Œå¹¶å¿½ç•¥åœ¨`return`è¯­å¥ä¹‹åçš„æ‰€æœ‰å†…å®¹ã€‚

è¿™ç»™äº†æˆ‘ä»¬é‡å¤æ‰¿è¯ºå’Œå–æ¶ˆæ‰¿è¯ºé“¾ä¸­ä»»ä½•åœ°æ–¹çš„å¯èƒ½æ€§ã€‚

## [](#proof-of-concept)æ¦‚å¿µè¯æ˜

è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„ç”¨ä¾‹åˆ›å»ºä¸€äº›è¶³å¤Ÿé€šç”¨çš„ä¸œè¥¿æ¥è§£å†³è·¯ç”±ä¸­çš„è¿™ç§æƒ…å†µã€‚è¦ç‚¹æ˜¯:

*   èƒ½å¤Ÿå¤„ç†åŒæ­¥å’Œå¼‚æ­¥åŠŸèƒ½(API è°ƒç”¨)
*   æŸäº›æ£€æŸ¥ä¸€å¤±è´¥ï¼Œä»£ç å°±è¿”å›é‡å®šå‘ã€‚
*   è¶³å¤Ÿé€šç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡ç”¨å…¶ä»–è·¯çº¿ã€‚

æ‰€ä»¥æˆ‘æ‰“å¼€ä»£ç æ²™ç®±ï¼Œæƒ³å‡ºäº†è¿™ä¸ªè§£å†³æ–¹æ¡ˆğŸ‘‰ [Codesandbox](https://codesandbox.io/s/understanding-generators-8oe8q)

æ­£å¦‚æ‚¨åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬æœ‰å¤šä¸ªæ“ä½œå’Œä¸€äº›æ£€æŸ¥ã€‚æˆ‘ä»¬å¯ä»¥ç»•è¿‡åº”è¯¥å¤±è´¥çš„æ£€æŸ¥ï¼Œä»£ç çš„å…¶ä½™éƒ¨åˆ†ä¸ä¼šæ‰§è¡Œã€‚

[![Navigator payment step in online check-in](../Images/86a52cacf9c7cffba1245238a974e665.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--Fwc2tUZX--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://s3.gifyu.com/images/generator-example.gif) 
[æŸ¥çœ‹ codesandbox ä¸­çš„æºä»£ç ](https://codesandbox.io/s/understanding-generators-8oe8q)

è¿™æ˜¯ä»£ç ä¸­ä»˜æ¬¾æ­¥éª¤è·¯çº¿çš„å®ç°ç¤ºä¾‹ã€‚

```
function* paymentRouteGenerator() {
  yield authAction();
  yield fetchReservations();
  yield isReservationIdValid();

  yield fetchPaymentCards();
  yield fetchHotels();
  yield doesHotelUsePciProxy({ hotelId });
  yield initPciProxy();
}

const CHECK_IN_PAYMENT_ROUTE = {
  name: Route.CheckInPayment,
  path: "/:reservationId",
  action: resolveAction(
    generatorWrapper(paymentRouteGenerator),
    renderComponent(() => <CheckInPaymentStep />)
  )
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å¿…é¡»ä¸ºæˆ‘ä»¬çš„ç”Ÿæˆå™¨ç¼–å†™ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚è¿™æ˜¯`magic`å‘ç”Ÿçš„åœ°æ–¹ã€‚æˆ‘å·²ç»åœ¨ä¸‹é¢çš„è¯„è®ºä¸­è§£é‡Šäº†æ¯ä¸€æ­¥ã€‚

```
const generatorWrapper = generator => context => {
  // 1\. Creating an iterator
  const iterator = generator(context);

  // 3\. This function except yielded as a argument
  const handle = yielded => {
    const handleWithRedirectCheck = route => {
      // 4\. Here is where the magic happens, we check if there is a redirect, if yes,
      // it would redirect (cancel) and will not execute the rest of the generator
      if (get("redirect", route)) {
        return route;
      }
      // Otherwise continue
      return handle(iterator.next());
    };
    // Exit if we are at the end of the generator
    if (yielded.done) {
      return;
    }

    // Handling the async case if action/check is a promise
    if (isPromise(yielded.value)) {
      return yielded.value.then(handleWithRedirectCheck);
    }
    // If its not a promise, we can call handleWithRedirectCheck directly
    return handleWithRedirectCheck(yielded.value);
  };

  // 2\. Handling the iterator
  return handle(iterator.next());
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[æŸ¥çœ‹ codesandbox ä¸­çš„æºä»£ç ](https://codesandbox.io/s/understanding-generators-8oe8q)

ç°åœ¨ï¼Œæˆ‘åªæ˜¯åœ¨ç©å®ƒï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ä»»ä½•æ›´å¥½çš„è§£å†³æ–¹æ³•ï¼Œä¸€å®šè¦å‘Šè¯‰æˆ‘ã€‚ğŸ˜‰

* * *

## [](#thanks-for-reading)æ„Ÿè°¢é˜…è¯»

è®©æˆ‘çŸ¥é“ä½ å¯¹è¿™ä¸ª**å‘ç”µæœºç³»åˆ—**çš„çœ‹æ³•ã€‚å¦‚æœä½ çˆ±å®ƒï¼Œä½ çŸ¥é“è¯¥æ€ä¹ˆåšï¼åˆ†äº«ç»™ä½ çš„æœ‹å‹å’ŒåŒäº‹ã€‚

å¦‚æœä½ å¸Œæœ›æˆ‘åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æ¶‰åŠä¸€äº›è¯é¢˜ï¼Œè¯·åœ¨è¿™é‡Œçš„ [dev.to](https://dev.to/phung_cz) æˆ– twitter [@phung_cz](https://twitter.com/phung_cz) ä¸Šç»™æˆ‘å‘æ¶ˆæ¯ï¼Œæˆ–è€…å¦‚æœä½ æœ‰ä»»ä½•å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹é¢å‘è¡¨è¯„è®ºã€‚

ä¸‹æ¬¡è§ï¼Œç»§ç»­é»‘âœŒ

* * *

çœ‹ä¸€ä¸‹æˆ‘ä»¬æ­£åœ¨å»ºé€ ä»€ä¹ˆ [@ Mews systems](https://github.com/MewsSystems/developers) æˆ‘ä»¬ä¹Ÿåœ¨[æ‹›è˜å¼€å‘äººå‘˜](https://github.com/MewsSystems/developers)å’Œå…¶ä»–èŒä½çš„äººå‘˜ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ã€‚