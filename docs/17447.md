# åœ¨ Next.js ä¸­è‡ªåŠ¨ç”Ÿæˆ sitemap.xml

> åŸæ–‡:[https://dev . to/embiem/auto-generate-sitemap XML-in-nextjs-2nh 1](https://dev.to/embiem/auto-generate-sitemapxml-in-nextjs-2nh1)

ä¸‡å²ï¼æ‚¨ä¸ºè‡ªå·±æ¼‚äº®ä¸”é«˜æ€§èƒ½çš„ Next.js ç½‘ç«™åˆ›å»ºäº†æ‰€æœ‰çš„ç»„ä»¶å’Œæ ·å¼ã€‚ç°åœ¨æ€ä¹ˆåŠï¼Ÿ

åœ¨ä½ å¯¼å‡ºçš„åŒ…çš„æ ¹ç›®å½•ä¸‹æœ‰ä¸€äº›ä½ æƒ³è¦æœåŠ¡çš„å…³é”®æ–‡ä»¶ï¼Œä½†æ˜¯ Next.js åªæ”¯æŒä»`/static`æ–‡ä»¶å¤¹ä¸­å¼€ç®±å¤åˆ¶æ–‡ä»¶ã€‚ä½†æ˜¯å¦‚ä½•æ·»åŠ ä¸€ä¸ª`sitemap.xml`ï¼Œå³ä½¿æ˜¯ä»¥ä¸€ç§è‡ªåŠ¨çš„å¹¶ä¸”æ€»æ˜¯æœ€æ–°çš„æ–¹å¼ï¼Ÿ

è®©æˆ‘å‘æ‚¨å±•ç¤ºå¦‚ä½•ä¸ºä¸€ä¸ªåä¸ºâ€œyarn exportâ€çš„ Next.js é¡¹ç›®è®¾ç½®è¿™ä¸ªã€‚

## [](#basic-sitemapxml-structure)åŸºæœ¬ sitemap.xml ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€çœ‹åŸºæœ¬ç«™ç‚¹åœ°å›¾éœ€è¦çš„ä¿¡æ¯ã€‚

ä¸€åˆ—ï¼›ä¸€æ ...

*   æ¯ä¸ªå¯ç”¨é¡µé¢çš„ URLï¼Œ
*   å’Œä¸€ä¸ªä¼´éšçš„æ—¥æœŸï¼Œè®©æœç´¢å¼•æ“æœºå™¨äººçŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªé¡µé¢ï¼Œä»¥åŠå®ƒæœ€åä¸€æ¬¡æ›´æ”¹çš„æ—¶é—´ã€‚

å°±æ˜¯è¿™æ ·ï¼å¦‚æœä½ æƒ³äº†è§£æ›´å¤šä¿¡æ¯ï¼Œä½ å¯ä»¥æŸ¥çœ‹è°·æ­Œçš„â€œå»ºç«‹å¹¶æäº¤ç½‘ç«™åœ°å›¾â€ç½‘ç«™ã€‚

## [](#gathering-needed-info)æ”¶é›†æ‰€éœ€ä¿¡æ¯

åœ¨æˆ‘ä»¬å°†æ–‡ä»¶å†™å…¥å¯¼å‡º/è¾“å‡ºæ–‡ä»¶å¤¹ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å®é™…è·å–æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯:é¡µé¢ url å’Œæœ€åä¿®æ”¹æ—¥æœŸã€‚

ä¸ºæ­¤ï¼Œæˆ‘æ„å»ºäº†è¿™ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›/pages æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰æ–‡ä»¶çš„è·¯å¾„:

```
module.exports = () => {
  const fileObj = {};

  const walkSync = dir => {
    // Get all files of the current directory & iterate over them
    const files = fs.readdirSync(dir);
    files.forEach(file => {
      // Construct whole file-path & retrieve file's stats
      const filePath = `${dir}${file}`;
      const fileStat = fs.statSync(filePath);

      if (fileStat.isDirectory()) {
        // Recurse one folder deeper
        walkSync(`${filePath}/`);
      } else {
        // Construct this file's pathname excluding the "pages" folder & its extension
        const cleanFileName = filePath
          .substr(0, filePath.lastIndexOf("."))
          .replace("pages/", "");

        // Add this file to `fileObj`
        fileObj[`/${cleanFileName}`] = {
          page: `/${cleanFileName}`,
          lastModified: fileStat.mtime
        };
      }
    });
  };

  // Start recursion to fill `fileObj`
  walkSync("pages/");

  return fileObj;
}; 
```

è¿™ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æˆ‘å†™çš„æ—¶å€™æˆ‘çš„ç½‘ç«™æ˜¯è¿™æ ·çš„:

```
{
  "/blog/auto-generate-sitemap-in-next-js": {
    "page": "/blog/auto-generate-sitemap-in-next-js",
    "lastModified": "2018-10-03T00:25:30.806Z"
  },
  "/blog/website-and-blog-with-next-js": {
    "page": "/blog/website-and-blog-with-next-js",
    "lastModified": "2018-10-01T17:04:52.150Z"
  },
  "/blog": {
    "page": "/blog",
    "lastModified": "2018-10-03T00:26:02.134Z"
  },
  "/index": {
    "page": "/index",
    "lastModified": "2018-10-01T17:04:52.153Z"
  }
} 
```

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†æ„å»ºç½‘ç«™åœ°å›¾æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼

## [](#creating-the-file-when-exporting)å¯¼å‡ºæ—¶åˆ›å»ºæ–‡ä»¶

åœ¨ Next.js ä¸­ï¼Œå½“æ‚¨åˆ›å»ºé™æ€æ–‡ä»¶åŒ…æ—¶ï¼Œé€šå¸¸ä¼šè¿è¡Œ`yarn build && yarn export`ã€‚æˆ‘ä»¬å¸Œæœ›åœ¨å¯¼å‡ºåæŒ‚æ¥ï¼Œåœ¨/out æ–‡ä»¶å¤¹ä¸­åˆ›å»º sitemap.xml æ–‡ä»¶ã€‚

ä¸ºäº†æŒ‚é’©åˆ° package.json ä¸­å®šä¹‰çš„ä»»ä½•è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ å¦ä¸€ä¸ªåŒåçš„è„šæœ¬ï¼Œä½†ä»¥â€œpostâ€ä¸ºå‰ç¼€ï¼›

æ–°çš„ package.json è„šæœ¬éƒ¨åˆ†å°†å¦‚ä¸‹æ‰€ç¤º:

```
...  "scripts":  {  "dev":  "next",  "build":  "next build",  "start":  "next start",  "export":  "next export",  "postexport":  "node scripts/postExport.js"  },  ... 
```

æˆ‘é€‰æ‹©åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹â€œscripts â€,å¹¶åœ¨é‚£é‡Œåˆ›å»ºâ€œpostExport.jsâ€æ–‡ä»¶ã€‚è¿™ä¸ªè„šæœ¬ç°åœ¨å°†åœ¨æ¯æ¬¡â€œçº±çº¿å¯¼å‡ºâ€è°ƒç”¨åè¿è¡Œã€‚

## [](#generate-the-sitemapxml-contents)ç”Ÿæˆ sitemap.xml å†…å®¹

è¿™ä¸ª`scripts/postExport.js`æ–‡ä»¶å°†åˆ©ç”¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„å‡½æ•°æ¥è·å–æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯:

```
const pathsObj = getPathsObject(); 
```

ç„¶åï¼Œæˆ‘ä»¬å°†åˆ›å»º sitemap.xml å†…å®¹å’Œæ–‡ä»¶:

```
const sitemapXml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset > ${Object.keys(pathsObj).map(
    path => `<url>
    <loc>https://embiem.me${path}</loc>
    <lastmod>${
      formatDate(new Date(pathsObj[path].lastModified))
    }</lastmod>
  </url>`
  )} </urlset>`;

fs.writeFileSync("out/sitemap.xml", sitemapXml); 
```

å°±æ˜¯è¿™æ ·ï¼å·®ä¸å¤šå§ã€‚æˆ‘ç¡®å®ä½¿ç”¨äº†ä¸€ä¸ª formatDate å‡½æ•°æ¥è·å¾—æˆ‘ä»¬çš„æ—¥æœŸæ‰€éœ€çš„å­—ç¬¦ä¸²æ ¼å¼ã€‚

ä½ å¯ä»¥åªåšä¸€ä¸ª`.substr()`ï¼Œå› ä¸º`pathsObj[path].lastModified`å·²ç»åŒ…å«äº†ä¸€ä¸ª ISO æ ¼å¼çš„æ—¥æœŸï¼Œæˆ–è€…ä½¿ç”¨åƒ [date-fns](https://date-fns.org/) è¿™æ ·çš„åº“ã€‚æˆ‘å†³å®šä»ç½‘ä¸Šå¤åˆ¶ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆ:

```
module.exports = function formatDate(date) {
  var d = new Date(date),
    month = "" + (d.getMonth() + 1),
    day = "" + d.getDate(),
    year = d.getFullYear();

  if (month.length < 2) month = "0" + month;
  if (day.length < 2) day = "0" + day;

  return [year, month, day].join("-");
}; 
```

ç°åœ¨è¿è¡Œ`yarn export`ï¼Œåœ¨`out/sitemap.xml`å‡ºç°ä¸€ä¸ªæ–‡ä»¶ï¼

## [](#challenge-create-robotstxt)æŒ‘æˆ˜ï¼åˆ›å»ºæœºå™¨äºº. txt

åŸºäºæ­¤ï¼Œä½ ç°åœ¨åº”è¯¥å¾ˆå®¹æ˜“ç”¨ä½ æƒ³è¦çš„å†…å®¹åˆ›å»ºä¸€ä¸ª robots.txtã€‚

å¦‚æœä½ æƒ³çŸ¥é“æˆ‘æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ç½‘ç«™çš„å›è´­ä¸­çš„[è„šæœ¬æ–‡ä»¶å¤¹ã€‚](https://github.com/embiem/embiem-website/tree/master/scripts)

è®©æˆ‘çŸ¥é“ä½ æ˜¯å¦ä¼šç”¨ä¸åŒçš„æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## [](#afterword)åè®°

è¿™æ˜¯æˆ‘åœ¨è¿™ä¸ªç¤¾åŒºçš„ç¬¬ä¸€ä¸ªå¸–å­ğŸ‘‹ã€‚æˆ‘è®¡åˆ’åœ¨æœªæ¥å‘å¸ƒæ›´å¤šå†…å®¹ã€‚ä½ å¯ä»¥åœ¨æˆ‘çš„[åšå®¢](https://embiem.me/blog/auto-generate-sitemap-in-next-js/)ä¸Šæ‰¾åˆ°åŸå¸–ã€‚