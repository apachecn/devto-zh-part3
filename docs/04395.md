# ç¬¬ 020 é›†-å‰ç«¯å’Œ HttpClient çš„åç«¯-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£

> åŸæ–‡:[https://dev . to/joaofbantunes/episode-020-the-back end-for-frontend-and-the-httpclient-ASP-net-core-from-0-to-overkill-39e 3](https://dev.to/joaofbantunes/episode-020-the-backend-for-frontend-and-the-httpclient-asp-net-core-from-0-to-overkill-39e3)

åœ¨è¿™ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä¸º frontend æ„å»ºæˆ‘ä»¬çš„åç«¯ï¼Œè¿™å°†åœ¨ Vue.js å‰ç«¯åº”ç”¨ç¨‹åºå’Œæˆ‘ä»¬å°†å¼€å‘çš„åç«¯ API ä¹‹é—´æ¶èµ·ä¸€åº§æ¡¥æ¢ã€‚ç›®å‰ï¼Œè¿™ä¸»è¦æ˜¯åœ¨ ASP.NET æ ¸å¿ƒä¸­ç©`HttpClient`çš„å€Ÿå£ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨æœªæ¥æ”¹è¿› BFFï¼Œä¸ºä¸éœ€è¦é¢å¤–é€»è¾‘çš„è¯·æ±‚æä¾›ä¸€äº›ä»£ç†åŠŸèƒ½ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/A8ZCVzeqFtA](https://www.youtube.com/embed/A8ZCVzeqFtA)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨è¿™ä¸€é›†ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä¸º frontend æ„å»ºæˆ‘ä»¬çš„åç«¯ï¼Œè¿™å°†åœ¨ Vue.js å‰ç«¯åº”ç”¨ç¨‹åºå’Œæˆ‘ä»¬å°†å¼€å‘çš„åç«¯ API ä¹‹é—´æ¶èµ·ä¸€åº§æ¡¥æ¢ã€‚

å‰ç«¯çš„åç«¯(æˆ‘ä»¬ç§°ä¹‹ä¸º BFF)å¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å½“æˆ‘ä»¬å¤„ç†ç”±å¤šä¸ªæœåŠ¡ç»„æˆçš„åº”ç”¨ç¨‹åºæ—¶ï¼Œå®ƒä¼šå¾ˆæœ‰ç”¨ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¼€å‘ PlayBall åº”ç”¨ç¨‹åºçš„ç›®æ ‡ã€‚

æ‹¥æœ‰ BFF çš„ä¸»è¦ç›®çš„æ˜¯åœ¨å‰ç«¯å’Œåç«¯ä¹‹é—´åˆ›å»ºä¸€ä¸ªæ›´ç®€å•çš„æ¥å£ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼ŒVue.js åº”ç”¨ç¨‹åºå¾ˆå¯èƒ½æ˜¯æˆ‘ä»¬å°†å¼€å‘çš„å”¯ä¸€å‰ç«¯ï¼Œä½†æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬ä¼šæœ‰æ›´å¤šçš„é€‰æ‹©(Androidï¼ŒiPhoneï¼Œæ™ºèƒ½æ‰‹è¡¨ï¼Œç”µè§†ï¼Œ...)ï¼ŒBFF å°†å…è®¸æˆ‘ä»¬ä¸ºç‰¹å®šå‰ç«¯åˆ›å»ºå®šåˆ¶çš„ APIï¼Œç®€åŒ–å®¢æˆ·ç«¯è®¾å¤‡ä¸­çš„å·¥ä½œï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å™¨ä¸­å®Œæˆï¼Œæ›´æ¥è¿‘æ”¯æŒæœåŠ¡ã€‚

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šåªæ˜¯åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶ä»¥æ­¤ä¸ºå€Ÿå£åœ¨ ASP.NET æ ¸å¿ƒä¸­æ‘†å¼„`HttpClient`,çœ‹çœ‹æœ€è¿‘å‡ºç°çš„ä¸€äº›ç›¸å…³çš„ä½¿ç”¨æ¨¡å¼ã€‚æœªæ¥æˆ‘ä»¬å°†æ”¹è¿› BFFï¼Œè¿™æ ·å¯¹æœåŠ¡çš„ç®€å•è°ƒç”¨å¯ä»¥è¢«è‡ªåŠ¨ä»£ç†ï¼Œå…è®¸æˆ‘ä»¬åªåœ¨éœ€è¦ä¸ºå‰ç«¯å®šåˆ¶ API æ—¶ç¼–å†™ä»£ç ã€‚

ä¸ºäº†åœ¨æœªæ¥æ”¹è¿› BFFï¼Œæˆ‘ä»¬å°†æ¢ç´¢ [ProxyKit](https://github.com/damianh/ProxyKit) å’Œ [Ocelot](https://github.com/ThreeMammals/Ocelot) (æˆ–è€…åœ¨é‚£ä¹‹å‰å‡ºç°çš„å…¶ä»–é¡¹ç›®)ï¼Œä½†é‚£æ˜¯å¦ä¸€ä¸ªæ—¶é—´çš„ä¸»é¢˜ğŸ™‚ã€‚

## [](#new-project)æ–°å»ºé¡¹ç›®

å› ä¸ºå‰ç«¯çš„åç«¯æ˜¯ç‰¹å®šäº...å‰ç«¯(ğŸ™ƒ)ï¼Œæˆ‘ä»¬å°†å®ƒæ”¾åœ¨ Vue.js åº”ç”¨ç¨‹åºæ—è¾¹ï¼Œåœ¨åŒä¸€ä¸ª [GitHub å­˜å‚¨åº“](https://github.com/AspNetCoreFromZeroToOverkill/WebFrontend)ä¸­ã€‚

è¿™å°†æ˜¯ä¸€ä¸ª ASP.NET æ ¸å¿ƒ 2.2 åº”ç”¨ç¨‹åºï¼Œå°±åƒæˆ‘ä»¬åœ¨è¿‡å»çš„å‰§é›†ä¸­å¼€å‘çš„ [GroupManagement](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement) æœåŠ¡ã€‚åœ¨å›è´­åè®®ä¸­ï¼Œæˆ‘ä»¬ä¼šæœ‰ä»¥ä¸‹ç»“æ„:

```
.
â”œâ”€â”€ client
|   â”œâ”€â”€ Vue.js application files
|   â””â”€â”€ ...
â”œâ”€â”€ server
|   â”œâ”€â”€ src
|   |   â””â”€â”€ CodingMilitia.PlayBall.WebFrontend.BackForFront.Web
|   |       â”œâ”€â”€ CodingMilitia.PlayBall.WebFrontend.BackForFront.Web.csproj
|   |       â”œâ”€â”€ BFF application files
|   |       â””â”€â”€ ...
|   â”œâ”€â”€ CodingMilitia.PlayBall.WebFrontend.BackForFront.sln
|   â””â”€â”€ .gitignore
â”œâ”€â”€ LICENSE
â””â”€â”€ README 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨å¼€å§‹è¿™ä¸€é›†çš„ä¸»è¦ç›®æ ‡(ç©`HttpClient`)ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åšä¸€äº›åˆå§‹è®¾ç½®ã€‚ä»`Startup`ç±»å¼€å§‹ï¼Œæˆ‘ä»¬å¸Œæœ›è®© MVC å·¥ä½œï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨æ§åˆ¶å™¨ä¸­å®ç°â€œä»£ç†â€é€»è¾‘ã€‚æˆ‘ä»¬åœ¨è¿‡å»å·²ç»çœ‹åˆ°äº†è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªå¤ä¹ :

`Startup.cs`

```
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services
            .AddMvc()
            .SetCompatibilityVersion(CompatibilityVersion.Version_2_2);

            // ...
    }

    public void Configure(IApplicationBuilder app, IHostingEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }

        app.UseMvc();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…³äºåº”ç”¨ç¨‹åºçš„ç»„ç»‡ï¼Œè¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª`Features`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­æŒ‰ç‰¹æ€§åˆ’åˆ†å†…å®¹ï¼Œè€Œä¸æ˜¯â€œç»å…¸â€`Controllers`ã€`Models`å’Œ`Views`æ–‡ä»¶å¤¹ã€‚ç°åœ¨`GroupManagement`æœåŠ¡åªæœ‰ç»„é€»è¾‘ï¼Œæ‰€ä»¥ BFF åªæœ‰ä¸€ä¸ª`Groups`æ–‡ä»¶å¤¹ï¼Œæœ‰ä¸€ä¸ª`GroupsController`å’Œä¸€ä¸ª`GroupModel`ã€‚æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°æ§åˆ¶å™¨ï¼Œä½†æ˜¯å…³äº`GroupModel`ï¼Œå®ƒæ˜¯ç»„ç®¡ç†æœåŠ¡ä¸­çš„ä¸€ä¸ªç²¾ç¡®å‰¯æœ¬ã€‚

`Features\Groups\GroupModel.cs`

```
public class GroupModel
{
    public long Id { get; set; }
    public string Name { get; set; }
    public string RowVersion { get; set; }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#implementing-the-requests)å®ç°è¯·æ±‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„`GroupsController`å®ç°ï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•æ»¡è¶³è¯·æ±‚çš„ã€‚è¿™çœŸçš„æ˜¯é”…ç‚‰æ¿ä»£ç ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†åœ¨åé¢çš„ä¸€é›†é‡Œè¯•å›¾æ‘†è„±å®ƒï¼Œä½†æˆ‘è®¤ä¸ºå®ƒå€¼å¾—ä¸€ç›®äº†ç„¶ã€‚

åœ¨æ·±å…¥ç ”ç©¶ä»£ç ä¹‹å‰ï¼Œè¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹:

*   æˆ‘ä»¬å°†æŠŠ`HttpClient`ä½œä¸ºæ„é€ å‡½æ•°ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œç¨åæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•é…ç½®å®ƒã€‚`HttpClient`å¸¦æœ‰é¢„å…ˆé…ç½®çš„ç»„ç®¡ç†æœåŠ¡çš„åŸºå€ã€‚
*   æˆ‘ä»¬ç°åœ¨ä¸ä¼šæ‹…å¿ƒå¤„ç†é”™è¯¯ï¼Œä½†æˆ‘ä»¬å°†æ¥è‚¯å®šä¼šè¿™æ ·åšã€‚

è®©æˆ‘ä»¬ä»è·å–æ‰€æœ‰ç»„çš„æ“ä½œå¼€å§‹ã€‚

`Features\Groups\GroupsController.cs`

```
[Route("groups")]
public class GroupsController : ControllerBase
{
    private const string BaseAddress = "/groups";
    private readonly HttpClient _httpClient;

    public GroupsController(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    [HttpGet]
    [Route("")]
    public async Task<ActionResult<IReadOnlyCollection<GroupModel>>> GetAllAsync(CancellationToken ct)
    {
        var response = await _httpClient.GetAsync(BaseAddress, ct);
        var result = await response.Content.ReadAsAsync<IReadOnlyCollection<GroupModel>>(ct);
        return Ok(result);
    }

    // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æƒ³æŒ‡å‡ºçš„ç¬¬ä¸€ä»¶äº‹æ˜¯`GetAllAsync`æ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œå› ä¸ºåœ¨æœ¬ç³»åˆ—ä¸­æˆ‘è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡å®ƒã€‚é€šå¸¸ï¼Œå½“å®ç°ä¸€ä¸ª API åŠ¨ä½œæ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†è¿”å›çš„æ¨¡å‹æŒ‡å®šä¸ºè¿”å›ç±»å‹ï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬éœ€è¦è¿”å›ä¸€ä¸ªä¸åŒçš„çŠ¶æ€ä»£ç (æ¯”å¦‚ 500ã€404 ç­‰)ï¼Œæˆ‘ä»¬ä¼šå°†å…¶å£°æ˜ä¸ºä¸€ä¸ª`IActionResult`ã€‚

æ˜¯ä¸€ä¸ªæœ‰è¶£çš„å°è¯¾å ‚ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸¤å…¨å…¶ç¾ã€‚å¦‚æœæˆ‘ä»¬è¦è¿”å›ä¸€ä¸ª`NotFound()`ï¼Œå®ƒä¼šå·¥ä½œå¾—å¾ˆå¥½ï¼Œå¦‚æœæˆ‘ä»¬è¦ç›´æ¥è¿”å›ä¸€ä¸ªæ¨¡å‹ï¼Œå®ƒä¹Ÿä¼šå·¥ä½œå¾—å¾ˆå¥½ã€‚è¿™æ˜¯å› ä¸ºå®ƒæœ‰éšå¼æ“ä½œç¬¦æ¥è¿›è¡Œè¿™äº›è½¬æ¢ã€‚æ‹è§’å¤„çš„ç®±å­å°±æ˜¯ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„é‚£ä¸ªã€‚éšå¼æ“ä½œç¬¦ä¸ä¸æ¥å£ä¸€èµ·å·¥ä½œï¼Œå› æ­¤æœ‰äº†`return Ok(result)`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ç”¨`GroupModel[]`ä»£æ›¿ï¼Œå®ƒä¼šå·¥ä½œå¾—å¾ˆå¥½ã€‚

å…³äº HTTP è¯·æ±‚ï¼Œæˆ‘è®¤ä¸ºæ²¡æœ‰ä»€ä¹ˆå¥‡æ€ªçš„äº‹æƒ…å‘ç”Ÿã€‚æˆ‘ä»¬ç”¨åŸºå€å‘å‡ºä¸€ä¸ª GET è¯·æ±‚ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³åˆ—å‡ºå¯ç”¨çš„ç»„ï¼Œç„¶åè¯»å– JSON å“åº”ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿”å›å®ƒã€‚è¿™äº›æ¨¡å‹å®Œå…¨åŒ¹é…ï¼Œå› æ­¤ä¸éœ€è¦ä»»ä½•æ˜ å°„é€»è¾‘ã€‚

ç»§ç»­æ‰§è¡Œâ€œæŒ‰ id è·å–â€æ“ä½œã€‚

`Features\Groups\GroupsController.cs`

```
// ...
[HttpGet]
[Route("{id}")]
public async Task<ActionResult<GroupModel>> GetByIdAsync(long id, CancellationToken ct)
{
    var response = await _httpClient.GetAsync($"{BaseAddress}/{id}", ct);
    if(response.StatusCode == HttpStatusCode.NotFound)
    {
        return NotFound();
    }
    var result = await response.Content.ReadAsAsync<GroupModel>(ct);
    return result;
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œæ›´å¤šçš„æ˜¯ç›¸åŒçš„ã€‚æˆ‘ä»¬åœ¨å‘å‡ºè¯·æ±‚ä¹‹å‰åšäº†ä¸€äº›é¢å¤–çš„ url ç»„åˆï¼Œç„¶åæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦å¾—åˆ°äº† 404ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶ä¼ æ’­è¯¥çŠ¶æ€ï¼Œå¦åˆ™æˆ‘ä»¬è§£æå“åº”å¹¶è¿”å›å®ƒï¼Œå¦‚æ‚¨æ‰€è§ï¼Œåˆ©ç”¨äº†æ¨¡å‹çš„éšå¼è½¬æ¢ã€‚

å…¶ä½™çš„æ“ä½œå¤§åŒå°å¼‚ï¼Œæ‰€ä»¥æˆ‘å°±æŠŠå®ƒä»¬æ”¾åœ¨è¿™é‡Œä¾›å‚è€ƒã€‚

`Features\Groups\GroupsController.cs`

```
// ...
[HttpPut]
[Route("{id}")]
public async Task<ActionResult<GroupModel>> UpdateAsync(long id, GroupModel model, CancellationToken ct)
{
    var response = await _httpClient.PutAsJsonAsync($"{BaseAddress}/{id}", model, ct);
    if (response.StatusCode == HttpStatusCode.NotFound)
    {
        return NotFound();
    }
    var result = await response.Content.ReadAsAsync<GroupModel>(ct);
    return result;
}

[HttpPut]
[HttpPost]
[Route("")]
public async Task<ActionResult<GroupModel>> AddAsync(GroupModel model, CancellationToken ct)
{
    var response = await _httpClient.PostAsJsonAsync(BaseAddress, model, ct);
    var result = await response.Content.ReadAsAsync<GroupModel>(ct);
    return CreatedAtAction(nameof(GetByIdAsync), new { id = result.Id }, result);
}

[HttpDelete]
[Route("{id}")]
public async Task<IActionResult> RemoveAsync(long id, CancellationToken ct)
{
    await _httpClient.DeleteAsync($"{BaseAddress}/{id}", ct);
    return NoContent();
}
// ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#using-the-httpclient-before-aspnet-core-21)ä½¿ç”¨ http client(ASP.NET æ ¸å¿ƒ 2.1 ä¹‹å‰)

åœ¨çœ‹æˆ‘ä»¬å°†å¦‚ä½•ä½¿ç”¨`HttpClient`ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç®€å•åœ°è®¨è®ºä¸€ä¸‹åœ¨ aside æ ¸å¿ƒ 2.1 ä¹‹å‰å®ƒé€šå¸¸æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚

æˆ‘åœ¨è¿‡å»çš„[å¸–å­](https://blog.codingmilitia.com/2016/10/27/redirect-how-you-should-not-use-httpclient)ä¸­æåˆ°è¿‡è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯ä½¿ç”¨`HttpClient`å¹¶ä¸åƒä¸€å¼€å§‹äººä»¬æœŸæœ›çš„é‚£æ ·ç®€å•ã€‚

`HttpClient`å®ç°äº†`IDisposable`æ¥å£ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è®¤ä¸ºä½¿ç”¨å®ƒçš„æœ€ä½³æ–¹å¼æ˜¯å°†å®ƒåŒ…è£…åœ¨ä¸€ä¸ª`using`å—ä¸­ï¼Œåœ¨é‚£é‡Œå‘å‡ºæ‰€éœ€çš„è¯·æ±‚ï¼Œç„¶åå°†å…¶å¤„ç†æ‰ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸æ˜¯æœ€å¥½çš„æ–¹æ³•ï¼Œå› ä¸ºå³ä½¿æˆ‘ä»¬å¤„ç†äº†å®ƒï¼Œå®ƒç”¨æ¥å‘å‡ºè¯·æ±‚çš„å¥—æ¥å­—ä¹Ÿä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œå®ƒä¼šä¿æŒæ‰“å¼€ä¸€æ®µæ—¶é—´ã€‚è¿™å¯èƒ½å¯¹è´Ÿè½½ä¸å¤ªé‡çš„åº”ç”¨ç¨‹åºæ²¡æœ‰å½±å“ï¼Œä½†æ˜¯å¦‚æœæœ‰è¶³å¤Ÿçš„è´Ÿè½½ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹çœ‹åˆ°ç”±äºè¿™ç§è¡Œä¸ºå¯¼è‡´çš„ç«¯å£è€—å°½(æ›´å¤šä¿¡æ¯[è¿™é‡Œ](https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/))ã€‚

çŸ¥é“äº†è¿™äº›ï¼Œæœ‰ä»€ä¹ˆè§£å†³åŠæ³•ï¼Ÿå—¯ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ª`HttpClient`å¹¶å…±äº«å®ƒ(æˆ–è‡³å°‘æœ‰é™æ•°é‡çš„å®ä¾‹)ã€‚ç”¨æ¥å‘å‡ºè¯·æ±‚çš„æ–¹æ³•(`GetAsync`ã€`PostAsync`ç­‰ç­‰)æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥è¿™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œåªè¦æˆ‘ä»¬å°å¿ƒå¤„ç†å…¶ä»–çš„ä¸œè¥¿(ä¾‹å¦‚ï¼Œå¼„ä¹±`BaseAddress`å’Œ`DefaultRequestHeaders`)ã€‚è¿™å¹¶ä¸ç†æƒ³ï¼Œä½†æ˜¯çŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå¯¹å—ï¼Ÿ

å½“æˆ‘ä»¬ä¼¼ä¹æ‰¾åˆ°äº†ä¸€ä¸ªä¸é”™çš„è§£å†³æ–¹æ¡ˆæ—¶ï¼Œå¦ä¸€ä¸ªé—®é¢˜å´å›°æ‰°ç€æˆ‘ä»¬ï¼å¦‚æœæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¿ç•™å®¢æˆ·ç«¯ï¼Œæœ€ç»ˆçš„ DNS å˜åŒ–æ˜¯ä¸ä¼šè¢«æ£€æµ‹åˆ°çš„(æ›´å¤šä¿¡æ¯[è¿™é‡Œ](http://byterot.blogspot.com/2016/07/singleton-httpclient-dns.html))ï¼åŒæ ·ï¼Œæˆ‘ä»¬é€šè¿‡æ‘†å¼„`ServicePointManager`æ‰¾åˆ°äº†å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å‡†å¤‡å¥½äº†(åŒæ ·ï¼Œç‚¹å‡»[è¿™é‡Œ](http://byterot.blogspot.com/2016/07/singleton-httpclient-dns.html)äº†è§£æ›´å¤šç»†èŠ‚)ã€‚

ä½†æ˜¯æœ‰å¾ˆå¤šå¥‡æ€ªçš„äº‹æƒ…è¦ç»å†ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–æˆ‘ä¸çŸ¥é“çš„é—®é¢˜ã€‚å¹¸è¿çš„æ˜¯ï¼Œåœ¨ ASP.NET æ ¸å¿ƒ 2.1 ä¸­ï¼Œå‡ºç°äº†ä¸€ç»„æ–°çš„ç‰¹æ€§æ¥ç¼“è§£è¿™ç§ç—›è‹¦ï¼Œä¸»è¦æ˜¯æ–°çš„`HttpClientFactory`ã€‚

## [](#using-the-httpclient)ä½¿ç”¨ HttpClient

æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½å‘å‡ºè¯·æ±‚çš„æ§åˆ¶å™¨ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†è¿‡å»ä½¿ç”¨`HttpClient`æ‰€é¢ä¸´çš„ä¸€äº›é—®é¢˜ï¼Œæ‰€ä»¥ç°åœ¨æ˜¯æ—¶å€™çœ‹çœ‹å¦‚ä½•åœ¨ ASP.NET æ ¸å¿ƒ> = 2.1 ä¸­ä½¿ç”¨å®ƒäº†ã€‚

> åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»æ–°çš„`HttpClient`å’Œ`HttpClientFactory`ä½¿ç”¨æ¨¡å¼ï¼Œæˆ‘åªæ˜¯ç”¨å®ƒä»¬æ¥å®ç°æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­éœ€è¦çš„ä¸œè¥¿ï¼Œä½†æ˜¯ä¸ºäº†æ›´è¯¦ç»†åœ°é˜…è¯»ï¼Œå²è’‚å¤«Â·æˆˆç™»æœ‰ä¸€ä¸ªå¾ˆæ£’çš„ç³»åˆ—æ–‡ç« ï¼Œä½ å¯ä»¥çœ‹çœ‹ï¼Œä»[è¿™ä¸ª](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore)å¼€å§‹ã€‚

æ­£å¦‚æˆ‘ç®€å•æåˆ°çš„ï¼Œæœ‰ä¸€ç§æ–°ç±»å‹å«åš`HttpClientFactory`ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†`HttpClient`çš„å®ä¾‹ã€‚å‰é¢æåˆ°çš„å…³äº`HttpClient`çš„é—®é¢˜å¹¶ä¸ç›´æ¥æºäºå®ƒï¼Œè€Œæ˜¯æºäºå®ƒåœ¨å†…éƒ¨ç”¨æ¥å‘å‡ºè¯·æ±‚çš„`HttpClientHandler`ã€‚æœ‰äº†è¿™äº›æ–°ç‰¹æ€§ï¼Œè¿™äº›å¤„ç†ç¨‹åºå°±è¢«`HttpClient`å…±äº«å’Œä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬çœŸçš„ä¸éœ€è¦æ‹…å¿ƒå¦‚ä½•å¤„ç†å®¢æˆ·ç«¯(åŒæ ·ï¼Œè¦è·å¾—æ›´è¯¦ç»†çš„è§£é‡Šï¼Œè¯·æŸ¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore))ã€‚

æˆ‘ä»¬å¯ä»¥å°†å·¥å‚ç›´æ¥æ³¨å…¥åˆ°éœ€è¦å‘å‡ºè¯·æ±‚çš„ç±»ä¸­ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥å°†ç±»é…ç½®ä¸ºæˆ‘é”®å…¥çš„ clientï¼Œç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­è·å–`HttpClient`è€Œä¸éœ€è¦å·¥å‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç±»å‹åŒ–å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å½“ç„¶ä¹Ÿæœ‰å·¥å‚æ›´å—æ¬¢è¿çš„æƒ…å†µã€‚

åœ¨`Startup`ç±»ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºç±»å‹åŒ–å®¢æˆ·ç«¯æ·»åŠ é…ç½®ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services
        .AddHttpClient<GroupsController>((serviceProvider, client) => 
        {
            // TODO: use serviceProvider to fetch the base address from configuration
            client.BaseAddress = new Uri("http://localhost:5002");
        });
    //... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°½ç®¡è¿™æ®µä»£ç åªæ˜¯è®¾ç½®äº†åŸºå€ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é…ç½®å®¢æˆ·ç«¯çš„å„ä¸ªæ–¹é¢ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿™äº›é…ç½®å§”æ‰˜ç»™å°†è¦ä½¿ç”¨çš„å®é™…ç±»ï¼Œæˆ‘ä¼šè¯´è¿™æ˜¯ä¸€ä¸ªåå¥½é—®é¢˜ï¼Œæˆ–è€…åœ¨æŸäº›æƒ…å†µä¸‹ä¸€ä¸ªæ¯”å¦ä¸€ä¸ªæ›´æœ‰æ„ä¹‰ã€‚

è¿™åº”è¯¥æ˜¯è®©å®ƒè¿è¡Œçš„æ–¹æ³•ï¼Œä½†äº‹å®å¹¶éå¦‚æ­¤ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ˜¯å°†`HttpClient`æ³¨å…¥åˆ°ä¸€ä¸ªâ€œæ™®é€šâ€çš„ç±»ä¸­ï¼Œè€Œæ˜¯å°†å®ƒæ³¨å…¥åˆ°ä¸€ä¸ªæ§åˆ¶å™¨ä¸­ã€‚æ§åˆ¶å™¨æ²¡æœ‰åƒæˆ‘ä»¬æ³¨å†Œçš„å…¶ä»–ç±»ä¸€æ ·æ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ä½œä¸ºæœåŠ¡ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åƒè¿™æ ·è¿è¡Œåº”ç”¨ç¨‹åºå¹¶å‘`http://localhost:5000/groups`å‘å‡ºè¯·æ±‚ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç±»ä¼¼
çš„é”™è¯¯

```
An unhandled exception occurred while processing the request.
InvalidOperationException: Unable to resolve service for type 'System.Net.Http.HttpClient' while attempting to activate 'CodingMilitia.PlayBall.WebFrontend.BackForFront.Web.Features.Groups.GroupsController'. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†èƒ½å¤Ÿåˆ©ç”¨å¸¦æœ‰æ§åˆ¶å™¨çš„ç±»å‹åŒ–å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›åˆ°`ConfigureServices`ä¸­çš„ MVC é…ç½®ï¼Œå¹¶æ·»åŠ ä¸€è¡Œé¢å¤–çš„ä»£ç æ¥å°†æ§åˆ¶å™¨æ³¨å†Œä¸ºæœåŠ¡ï¼Œè¿™æ ·æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥å¾ˆå¥½åœ°è¿æ¥èµ·æ¥ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services
        .AddMvc()
        .SetCompatibilityVersion(CompatibilityVersion.Version_2_2)
        .AddControllersAsServices();
    //... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿˜æœ‰å…¶ä»–ç±»ä¼¼çš„æ–¹æ³•ï¼Œæ¯”å¦‚`AddTagHelpersAsServices`ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨åªéœ€è¦æ§åˆ¶å™¨ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥å†æ¬¡æµ‹è¯•ï¼Œä¸€åˆ‡éƒ½åº”è¯¥åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œã€‚

## [](#using-polly-to-add-retry-logic)ä½¿ç”¨ Polly æ·»åŠ é‡è¯•é€»è¾‘

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¿«é€Ÿæµè§ˆçš„æœ€åä¸€ä»¶äº‹æ˜¯ä½¿ç”¨[æ³¢åˆ©](https://github.com/App-vNext/Polly)è®©`HttpClient`åœ¨è¯·æ±‚å¤±è´¥æ—¶é‡è¯•ã€‚

> æˆ‘æœ‰ä¸€ä¸ªå…³äºæ³¢åˆ©çš„æ—§å¸–å­([è¿™é‡Œ](https://blog.codingmilitia.com/2016/11/08/simpler-error-handling-in-net-applications-using-polly))å’Œè§†é¢‘([è¿™é‡Œ](https://youtu.be/wBZmdx-5-Cs))ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å¿«é€Ÿæµè§ˆä¸€ä¸‹ Polly å’Œ ASP.NET æ ¸å¿ƒä¸­çš„ HttpClient ä¹‹é—´æœ€è¿‘å¢åŠ çš„é›†æˆã€‚Polly æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œä¸ä»…ä»…æ˜¯æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­ç®€å•ä»‹ç»çš„é‡è¯•ã€‚

è¦è¿›è¡Œ Polly `HttpClient`é›†æˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…`Microsoft.Extensions.Http.Polly` NuGet åŒ…ã€‚ç„¶ååœ¨`Startup`ç±»ä¸­æ·»åŠ å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±ä¸‡äº‹ä¿±å¤‡äº†ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services
        .AddHttpClient<GroupsController>((serviceProvider, client) => {/*...*/})
        .AddPolicyHandler(
            HttpPolicyExtensions
            .HandleTransientHttpError()
            .WaitAndRetryAsync(5, attempt => TimeSpan.FromSeconds(attempt))); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`AddPolicyHandler`æ˜¯æˆ‘ä»¬å®‰è£…çš„ NuGet åŒ…çš„æ‰©å±•æ–¹æ³•ã€‚å®ƒå…è®¸æˆ‘ä»¬é…ç½®åº”ç”¨äº`HttpClient`çš„ç­–ç•¥ã€‚ç­–ç•¥æ˜¯ä¸€ä¸ª Polly æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­åŒ…è£…ä¸€ä¸ªåŠ¨ä½œæ‰§è¡Œï¼Œå‘å®ƒæ·»åŠ ä¸€äº›é¢å¤–çš„è¡Œä¸ºï¼Œå³å®ç°ä¸€äº›å¼¹æ€§æ¨¡å¼ã€‚ç­–ç•¥çš„ä¸€äº›ä¾‹å­æ˜¯é‡è¯•ã€æ–­è·¯æˆ–è¶…æ—¶ã€‚

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ¥è‡ªæ–‡æ¡£çš„æš‚æ—¶æ€§ HTTP é”™è¯¯é…ç½®äº†ä¸€ä¸ªé‡è¯•ç­–ç•¥:èŒƒå›´åœ¨ 500(æœåŠ¡å™¨é”™è¯¯)å’Œ 408(è¯·æ±‚è¶…æ—¶)ã€‚æˆ‘ä»¬æœ‰å¾ˆå¤šé…ç½®é‡è¯•çš„é€‰é¡¹ï¼Œæ¯”å¦‚ç«‹å³é‡è¯•ã€ä¸€æ®µæ—¶é—´åé‡è¯•ã€å‡ºé”™æ—¶æ€»æ˜¯é‡è¯•ã€é‡è¯•è‹¥å¹²æ¬¡ï¼Œä»¥åŠå…¶ä»–ä¸€äº›é€‰é¡¹ã€‚

è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯åœ¨æ¯æ¬¡å¤±è´¥åé‡è¯•ä¹‹å‰ç­‰å¾…ï¼Œæœ€å¤š 5 æ¬¡é‡è¯•ã€‚æ¯æ¬¡è¯·æ±‚å¤±è´¥æ—¶ï¼Œåœ¨é‡è¯•ç§’æ•°åé‡è¯•ï¼Œæˆ–è€…æ›´æ¸…æ¥šåœ°è¯´ï¼Œç¬¬ä¸€æ¬¡é‡è¯•å°†ç­‰å¾… 1 ç§’ï¼Œæœ€åä¸€æ¬¡é‡è¯•å°†ç­‰å¾… 5 ç§’ã€‚

è¦çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°ç»„ç®¡ç†æœåŠ¡ï¼Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼Œæ·»åŠ ä¸€äº›éšæœºçš„å¼‚å¸¸ç­‰ç­‰ğŸ™‚ã€‚

## [](#outro)å…¶ä»–

è¿™æ ·åšæ˜¯ä¸ºäº†å…ˆçœ‹çœ‹å‰ç«¯çš„åç«¯ï¼Œæˆ–è€…æ›´å¥½çš„æ˜¯ï¼Œä¸€ä¸ªä½¿ç”¨`HttpClient`çš„å€Ÿå£ğŸ˜›ã€‚å¦‚æœä½ è®¤ä¸ºæˆ‘ä»¬åœ¨è¿™é‡Œå®ç°çš„æœ‰ç‚¹å‚»ï¼Œé‚£ä¹ˆ...å¯èƒ½æ˜¯è¿™æ ·ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å·¥å…·æ¥ä¸ºæˆ‘ä»¬åšè¿™ç§ä»£ç†ï¼Œè€Œä¸éœ€è¦ç¼–å†™å¤§é‡çš„ boiler plate ä»£ç ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ç°åœ¨æˆ‘è®¤ä¸ºåº”è¯¥æŒ‡å‡º`HttpClient`çš„æ–°ä½¿ç”¨æ¨¡å¼ï¼Œå†æ¬¡æé†’é”™è¯¯ä½¿ç”¨å®ƒå¯èƒ½å¸¦æ¥çš„éº»çƒ¦ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨ç»•è¿‡åç«¯ï¼Œè®©å‰ç«¯è´Ÿè´£è°ƒç”¨æ‰€æœ‰éœ€è¦çš„æœåŠ¡ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸ºè¿™å°†åœ¨æœªæ¥ç»™æˆ‘ä»¬å¸¦æ¥æ›´å¤šçš„çµæ´»æ€§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºåƒè®¤è¯å’Œæˆæƒè¿™æ ·çš„äº‹æƒ…(æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€é›†çœ‹åˆ°)ï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬ä¸ä¸å…¬å¼€ HTTP API çš„æœåŠ¡è¿›è¡Œäº¤äº’(ä¾‹å¦‚ï¼Œæˆ‘å¾ˆç¡®å®šæˆ‘ä»¬å°†åœ¨æŸä¸ªæ—¶å€™ä½¿ç”¨ [gRPC](https://grpc.io/) )ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [ä½ ç”¨é”™äº† HttpClientï¼Œè¿™ä¼šç ´åä½ è½¯ä»¶çš„ç¨³å®šæ€§](https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/)
*   [Singleton HttpClientï¼Ÿå°å¿ƒè¿™ç§ä¸¥é‡çš„è¡Œä¸ºä»¥åŠå¦‚ä½•ä¿®å¤å®ƒ](http://byterot.blogspot.com/2016/07/singleton-httpclient-dns.html)
*   [ASP.NET æ ¸å¿ƒ 2.1 ä¸­çš„ http client factory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore)
*   [æ³¢åˆ©](https://github.com/App-vNext/Polly)
*   æ›´ç®€å•çš„é”™è¯¯å¤„ç†ã€‚ä½¿ç”¨ Polly çš„. NET åº”ç”¨ç¨‹åº
*   [ProxyKit](https://github.com/damianh/ProxyKit)
*   [è±¹çŒ«](https://github.com/ThreeMammals/Ocelot)

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/WebFrontend/tree/episode020)ã€‚

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼