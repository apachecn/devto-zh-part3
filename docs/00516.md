# Kentico 12:è®¾è®¡æ¨¡å¼ç¬¬ 4 éƒ¨åˆ†â€”â€”å‘ CMS æ·»åŠ ä¾èµ–æ³¨å…¥

> åŸæ–‡:[https://dev . to/seangwright/kentico-12-design-patterns-part-4-adding-dependency-injection-to-the-CMS-35a](https://dev.to/seangwright/kentico-12-design-patterns-part-4-adding-dependency-injection-to-the-cms-35a)

<figure>

[![](../Images/db59641fe8120a468df56a4d6c96f078.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--hcr5xcZT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/liul85lqvqkm9bymb72m.jpg)

<figcaption>Photo by [Rich Tervet](https://unsplash.com/@richtervet) on [Unsplash](https://unsplash.com)</figcaption>

</figure>

æ—¢ç„¶ Kentico å·²ç»æˆæƒå…¶å¼€å‘äººå‘˜ä½¿ç”¨ ASP.NET MVC æ„å»ºåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ¡†æ¶æ‰€é¼“åŠ±çš„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µã€‚ğŸ‘

éšç€æˆ‘ä»¬çš„åº“å’Œä»£ç åº“æ”¹å˜ä»¥åˆ©ç”¨è¿™äº›æ¨¡å¼å’Œå®è·µï¼Œæˆ‘ä»¬èƒ½åœ¨åŸºäº ASP.NET ç½‘ç»œè¡¨å•çš„ CMS åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å¦‚ä½•å®ç°è¿™ä¸€ç‚¹ï¼ŸğŸ¤”

å¯¹äºä¾èµ–æ³¨å…¥çš„æ¨¡å¼ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼ğŸ™Œ

æˆ‘ä»¬æ¥çœ‹çœ‹å§ï¼

## [](#the-pattern)å›¾æ ·

MVC é¼“åŠ±çš„æ¨¡å¼ä¹‹ä¸€æ˜¯[æ§åˆ¶åè½¬](https://en.wikipedia.org/wiki/Inversion_of_control) (IoC)ã€‚è¿™ç§æ¨¡å¼å¯ä»¥é€šè¿‡[ä¾èµ–æ³¨å…¥](https://en.wikipedia.org/wiki/Dependency_injection) (DI)æ¥å®ç°ï¼Œæ—¢æœ‰æ¡†æ¶ç±»å‹ï¼Œä¹Ÿæœ‰è‡ªå®šä¹‰çš„ç”¨æˆ·å®šä¹‰ç±»å‹ã€‚

åœ¨åº”ç”¨ç¨‹åºæ¡†æ¶ä¸­ï¼Œå®Œæˆ IoC çš„æ–¹å¼é€šå¸¸æ˜¯å…è®¸æ¡†æ¶åˆ›å»ºå’Œè°ƒç”¨ç”±å¼€å‘äººå‘˜åˆ›å»ºçš„ç‰¹å®šå…¥å£ç‚¹ç±»å‹â€”â€”ä»é‚£é‡Œæˆ‘ä»¬çš„ä»£ç æ‰§è¡Œï¼Œç›´åˆ°å®ƒè¿”å›ã€‚

IoC å…è®¸æˆ‘ä»¬ä»¥ä¼˜é›…çš„æ–¹å¼ä½¿ç”¨ DIï¼Œå› ä¸ºæ¡†æ¶è´Ÿè´£è°ƒç”¨æˆ‘ä»¬çš„ä»£ç (IoC)â€”â€”å› æ­¤å®ƒä¹Ÿå¯ä»¥è´Ÿè´£åˆ›å»ºæˆ‘ä»¬çš„ä»£ç æ‰€ä¾èµ–çš„ä¸œè¥¿(DI)ã€‚

### MVC ä¸­çš„ DI

åœ¨ MVC åº”ç”¨ç¨‹åºä¸­ï¼Œå…¶ä¸­ä¸€ä¸ªå…¥å£ç‚¹ç±»å‹æ˜¯`System.Web.Mvc.Controller`ç±»ï¼Œæ‰€æœ‰çš„å®šåˆ¶æ§åˆ¶å™¨éƒ½ä»è¯¥ç±»ç»§æ‰¿è€Œæ¥ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­`UserController`æœ‰(2)ä¸ªä¾èµ–å…³ç³»ï¼Œ`IUserContext`å’Œ`IEmailService` :

```
public class UserController : Controller
{
    public UserController(IUserContext userContext, IEmailService emailService)
    {
        // ...
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ MVC å†³å®š HTTP è¯·æ±‚åº”è¯¥ç”±`UserController`å¤„ç†æ—¶ï¼Œå®ƒéœ€è¦èƒ½å¤Ÿæ„é€ `UserController`çš„å®ä¾‹ã€‚MVC åŸºäº URL æˆ–è¯·æ±‚ä½“æ¨¡å¼åšå‡ºè¿™ä¸ªå†³å®šï¼Œè¿™äº›æ¨¡å¼æ˜ å°„åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­çš„è·¯ç”±çº¦å®šæˆ–é…ç½®ã€‚

> è¦æŸ¥çœ‹æ··åˆäº†çº¦å®šå’Œé…ç½®çš„è·¯ç”±é…ç½®æ¨¡å¼ï¼Œè¯·é˜…è¯»æˆ‘åœ¨æœ¬ç³»åˆ—ä¸­çš„ä¸Šä¸€ç¯‡æ–‡ç« ã€‚ğŸ’ª
> 
> [![seangwright](../Images/e9e13f3e057a4f58b01316c7a9d6eeea.png)](/seangwright) [## Kentico 12:è®¾è®¡æ¨¡å¼ç¬¬ 3 éƒ¨åˆ†-æç¤ºå’ŒæŠ€å·§ï¼Œåº”ç”¨ç¨‹åºç»“æ„
> 
> ### Sean g . Wright 6 æœˆ 1 æ—¥ 197 åˆ†é’Ÿé˜…è¯»
> 
> #mvc #designpatterns #kentico #aspnet](/seangwright/kentico-12-design-patterns-part-3-tips-and-tricks-application-structure-1l2o)

å¦‚æœæˆ‘ä»¬é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥æ¥ä½¿ç”¨ DIï¼ŒMVC æ˜¯å¦‚ä½•è®¡ç®—å‡ºå¦‚ä½•åˆ›å»ºæˆ‘ä»¬çš„æ§åˆ¶å™¨ç±»çš„ä¾èµ–å…³ç³»çš„ï¼Ÿæˆ–è€…è¿™äº›ç±»çš„ä¾èµ–å…³ç³»ï¼Ÿ

è¿™ä¸ªé€’å½’é—®é¢˜ç”± IoC å®¹å™¨è§£å†³ã€‚IoC å®¹å™¨è¢«é…ç½®ä¸ºâ€œçŸ¥é“â€å¦‚ä½•æ„é€ åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„ä»»ä½•ç±»å‹çš„è¢«è®¤ä¸ºæ˜¯ä¾èµ–çš„å®ä¾‹ã€‚è¿™ç§ç±»å‹çš„é…ç½®é€šå¸¸è¢«ç§°ä¸ºâ€œæ³¨å†Œâ€ã€‚

å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå½“ MVC éœ€è¦åˆ›å»ºæˆ‘ä»¬çš„`UserController`çš„å®ä¾‹æ—¶ï¼Œå®ƒä¼šæœ‰æ•ˆåœ°å°è¯•ä» IoC å®¹å™¨ä¸­è·å–ä¸€ä¸ªå®ä¾‹ã€‚

IoC å®¹å™¨è®¡ç®—å‡ºåˆ›å»ºä¸€ä¸ª`UserController`æ‰€éœ€çš„æ•´ä¸ªä¾èµ–é“¾ï¼Œåˆ›å»ºä¸€ä¸ªï¼Œç„¶åå°†å®ƒè¿”å›ç»™æ¡†æ¶ä»£ç ã€‚

> å½“ä½¿ç”¨ IoC å’Œ DI æ—¶ï¼Œæˆ‘ä»¬çš„ä»£ç ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ä¾èµ–é¡¹ã€‚
> 
> ç›¸åï¼Œæ‰€æœ‰çš„ä¾èµ–å¿…é¡»ä»æ›´é«˜çš„åœ°æ–¹æä¾›ç»™æˆ‘ä»¬çš„ä»£ç ã€‚è¿™æ˜¯å¯¹æˆ‘ä»¬è‡ªå·±ä»£ç çš„ä¾èµ–æ€§çš„â€œæ§åˆ¶â€çš„â€œå€’ç½®â€ã€‚ğŸ˜®

### [](#di-in-web-forms)DI åœ¨ Web è¡¨å•ä¸­

ASP.NET Web è¡¨å•æ¶æ„æ˜¯åŸºäº`Page`å’Œ`UserControl`ç±»å‹çš„ã€‚

> å½“ä½¿ç”¨ Kentico æ—¶ï¼Œæˆ‘ä»¬ç›¸åº”åœ°ä½¿ç”¨`CMSPage`å’Œ`CMSAbstractWebPart`ç±»ã€‚

è¿™ä¸¤ç§ç±»å‹éƒ½éœ€è¦å…¬å…±çš„æ— å‚æ•°æ„é€ å‡½æ•°ã€‚

å¦‚æœæˆ‘ä»¬å°†ä¾èµ–é¡¹æŒ‡å®šä¸ºæ„é€ å‡½æ•°å‚æ•°ä¼šå‘ç”Ÿä»€ä¹ˆï¼ŸWeb çª—ä½“æ¡†æ¶å°†æ— æ³•åˆ›å»ºè¯¥ç±»å‹çš„å®ä¾‹ï¼Œè¯·æ±‚å°†å¤±è´¥å¹¶å‡ºç°å¼‚å¸¸ï¼ğŸ¤¦ğŸ½â€â™€ï¸

ASP.NET Web Forms ä¸æ˜¯ä¸º MVC é¼“åŠ±çš„æ¨¡å¼å’Œå®è·µè®¾è®¡çš„ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€æˆ‘ä»¬é™·å…¥äº†åƒµå±€ã€‚

## [](#the-library-autofac)åº“- Autofac

å»ºç«‹äº†è®¾è®¡æ¨¡å¼åï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£å¦‚ä½•é…ç½®å®ƒï¼Œä¸æ˜¯é’ˆå¯¹ MVCï¼Œè€Œæ˜¯é’ˆå¯¹ ASP.NET Web Formsï¼Œè¿™æ˜¯ Kentico å†…å®¹ç®¡ç†åº”ç”¨ç¨‹åºæ‰€åŸºäºçš„æ¡†æ¶ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ [Autofac](https://autofac.org/) ä½œä¸ºæˆ‘ä»¬çš„ IoC å®¹å™¨é€‰æ‹©ã€‚

> . NET ä¸­æœ‰è®¸å¤š IoC å®¹å™¨åº“ã€‚Daniel Palme çš„è¿™ä¸ªåŸºå‡†åšå®¢åŒ…å«äº†ä¸€ä¸ªéå¸¸å®Œæ•´çš„æœ€è‘—åçš„åº“çš„åˆ—è¡¨ã€‚
> 
> åœ¨è¿‡å»ï¼Œæˆ‘ä¸»è¦ä½¿ç”¨çš„æ˜¯ç®€å•æ³¨å…¥å™¨ï¼Œå› ä¸ºå®ƒæœ‰å¾ˆå¥½çš„æ€§èƒ½ã€ç®€å•çš„ API å’Œå®¹å™¨éªŒè¯ç‰¹æ€§ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å›¾ä¹¦é¦†ï¼Œ[é›†è£…ç®±éªŒè¯ä¹Ÿå¾ˆæ£’](https://simpleinjector.readthedocs.io/en/latest/using.html#verifying-the-container-s-configuration)ã€‚ğŸ‘Œ
> 
> ä¹Ÿå°±æ˜¯è¯´ï¼ŒAutoFac æä¾›äº†ä¸€äº›å¾ˆå¥½çš„ API æ¥ç®€åŒ–ä¸€äº›é—®é¢˜ã€‚NET åº”ç”¨ç¨‹åºæ¡†æ¶éœ€è¦å¼€å‘äººå‘˜é¢å¯¹ã€‚å®ƒä¹Ÿæ˜¯ Kentico åœ¨å…¶ç¤ºä¾‹ Dancing Goat ç«™ç‚¹ä¸­ä½¿ç”¨çš„ IoC å®¹å™¨ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨(2)ä¸ª NuGet åŒ…(æŒ‡å®šç‰ˆæœ¬):

1.  è¿™æ˜¯ä¸»è¦çš„ IoC å®¹å™¨åº“ï¼Œä¸åº”ç”¨æ¡†æ¶æ— å…³ã€‚

2.  [Autofacã€‚è¿™æ˜¯ç”¨äº Autofac çš„ ASP.NET ç½‘ç»œè¡¨å•é›†æˆåŒ…ã€‚](https://www.nuget.org/packages/Autofac.Web/)

Web Forms é›†æˆåŒ…å…è®¸æˆ‘ä»¬ä»¥å‡ ç§ä¸åŒçš„æ–¹å¼æ‰§è¡Œ DIã€‚

1.  å±æ€§æ³¨å…¥â€”â€”å°† IoC å®¹å™¨è§£æçš„å®ä¾‹åˆ†é…ç»™ Web è¡¨å•`Page`æˆ–`UserControl`å®ä¾‹çš„å…¬å…±å±æ€§ã€‚âœ”

2.  å±æ€§ç‰¹æ€§æ³¨å…¥-åŒä¸Šï¼Œä½†åªæœ‰åœ¨ç‰¹å®šçš„å±æ€§è¢«åº”ç”¨åˆ°é‚£äº›é¡µé¢æˆ–æ§ä»¶æ—¶ã€‚âœ”

3.  ç©ºå±æ€§/å±æ€§æ³¨å…¥â€”â€”ä½¿ç”¨ä¸Šé¢çš„ä»»ä½•ä¸€ç§æ–¹æ³•ï¼Œåªæœ‰å½“å±æ€§åœ¨èµ‹å€¼æ—¶æ˜¯`null`æ—¶ï¼Œæ‰èµ‹å€¼ä¸€ä¸ªè§£æçš„å®ä¾‹ã€‚âœ”

æˆ‘ä»¬å°†ä½¿ç”¨ç¬¬äºŒä¸ªé€‰é¡¹ï¼Œæ‚¨å¯ä»¥åœ¨ [Autofac çš„æ–‡æ¡£](https://autofac.readthedocs.io/en/latest/integration/webforms.html)ä¸­æ¢ç´¢å…¶ä»–ä¸¤ä¸ªé€‰é¡¹ã€‚

> **æ›´æ–°(2019/07/09)** :å½“ä½¿ç”¨ä¸Šè¿°ç¬¬ä¸€ä¸ªé€‰é¡¹æ—¶ï¼ŒKentico åœ¨ CMS(æŠ¥å‘Šæ¨¡å—)çš„æŸäº›æ–¹é¢å­˜åœ¨é—®é¢˜ã€‚åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œå®ƒæ˜¯æœ‰æ•ˆçš„ï¼Œä½†å¹¶ä¸å®Œå…¨æœ‰æ•ˆï¼Œè¿™è¿˜ä¸å¤Ÿå¥½ï¼å› æ­¤ï¼Œè™½ç„¶æˆ‘æœ€åˆæ¨èç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œä½†æˆ‘ç°åœ¨æ¨èç¬¬äºŒä¸ªã€‚
> 
> æ„Ÿè°¢ Luminary çš„ [Tony å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼](https://www.luminary.com/tony)

ç»§ç»­å°† NuGet åŒ…å®‰è£…åˆ°`CMSApp`é¡¹ç›®ä¸­ã€‚

> åœ¨ä¸­ç®¡ç† NuGet åŒ…ã€‚å¦‚æœæ‚¨ä½¿ç”¨ NET Framework é¡¹ç›®ä¼šå®¹æ˜“å¾—å¤šã€‚NET åŠŸèƒ½å’Œå·¥å…·ã€‚æŸ¥çœ‹æˆ‘çš„å¸–å­ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚ğŸ’ª
> 
> [![seangwright](../Images/e9e13f3e057a4f58b01316c7a9d6eeea.png)](/seangwright) [## è‚¯è’‚ç§‘ 12 çº§å›¾ä¹¦é¦†ä¸ç°ä»£ã€‚ç½‘ç»œæ ¸å¿ƒåŠŸèƒ½
> 
> ### Sean g . Wright 6 æœˆ 1 æ—¥ 1915 åˆ†é’Ÿé˜…è¯»
> 
> #csharp #dotnet #dotnetcore #kentico](/seangwright/kentico-12-class-libraries-with-modern-net-core-features-34n5)

å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼

> è‹±å¯¸ NET 4.7.2 [ä¸€ä¸ªåŸºäºæ„é€ å™¨çš„ DI è§£å†³æ–¹æ¡ˆå·²ç»è¢«æ·»åŠ åˆ° ASP.NET](https://docs.microsoft.com/en-us/dotnet/framework/whats-new/#aspnet)ä¸­ç”¨äº Web è¡¨å•ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå¯ä»¥è¢«ç”¨ä½œä¸€ä¸ªé’©å­ç‚¹ï¼Œå¸¦æœ‰ä¸€ä¸ªé€‚é…å™¨å±‚ï¼Œæ¥é›†æˆä¸€ä¸ª IoC å®¹å™¨ã€‚
> 
> è¿™é‡Œæ˜¯ä¸€ä¸ªé›†æˆäº† SimpleInjector çš„[ä¾‹å­ã€‚](https://gist.github.com/ndc/7334d459c3eb0be594aad3973a488cad)
> 
> æˆ‘å°†ç»§ç»­ä½¿ç”¨å±æ€§æ³¨å…¥ï¼Œå› ä¸ºå®ƒæ˜¯ Autofac æ”¯æŒçš„ï¼Œæ— éœ€å®šåˆ¶ã€‚

## [](#the-implementation-kentico-12-cms)å®æ–½â€”â€”è‚¯å¸ç§‘ 12 CMS

Autofac æ–‡æ¡£å¯¹å¦‚ä½•é…ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¼€å§‹ä½¿ç”¨è¿™ä¸ªåº“æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ¼”ç¤ºï¼Œæˆ‘å°†æ€»ç»“ä¸‹é¢çš„æ­¥éª¤ã€‚

### [](#configuring-the-project)é…ç½®é¡¹ç›®

é¦–å…ˆï¼Œå°†ä»¥ä¸‹ ASP.NET æ¨¡å—æ¡ç›®æ·»åŠ åˆ°`<configuration><system.webServer><modules>`èŠ‚ç‚¹ä¸‹çš„åº”ç”¨ç¨‹åº`web.config`ä¸­ã€‚

```
<add
    name="ContainerDisposal"
    type="Autofac.Integration.Web.ContainerDisposalModule, Autofac.Integration.Web"
    preCondition="managedHandler"/>
<add
    name="PropertyInjection"
    type="Autofac.Integration.Web.Forms.AttributedInjectionModule, Autofac.Integration.Web"
    preCondition="managedHandler"/> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œæ›´æ–°æˆ‘ä»¬åœ¨`Global.asax.cs`ä¸­çš„`Global`ç±»æ¥æ”¯æŒ Autofacã€‚

```
// Add the IContainerProviderAccessor interface
public class Global : CMSHttpApplication, IContainerProviderAccessor
{
    static Global()
    {
        /// leave existing code
    }

    // Holds the application container
    private static IContainerProvider containerProvider;

    // Used by Autofac to resolve dependencies via IContainerProviderAccessor
    public IContainerProvider ContainerProvider => containerProvider;

    // Creates a container builder, builds it, and then sets the container
    protected void Application_Start(object sender, EventArgs e)
    {
        var builder = new ContainerBuilder();

        var container = builder.Build();

        containerProvider = new ContainerProvider(container);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æ˜¯è¿™æ ·ï¼ç°åœ¨å·²ç»ä¸ºæˆ‘ä»¬çš„ CMS åº”ç”¨ç¨‹åºè®¾ç½®äº† DIï¼

...é™¤äº†æˆ‘ä»¬è¿˜æ²¡æœ‰æ³¨å†Œä»»ä½•ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ IoC å®¹å™¨å’Œå®ƒåˆ° Web è¡¨å•çš„é›†æˆç›®å‰æ²¡æœ‰å¤ªå¤§å¸®åŠ©ã€‚ğŸ˜‘

æ‰€ä»¥ï¼Œæˆ‘ä»¬ç”¨ Autofac æ³¨å†Œä¸€äº›ç±»å‹å§ï¼

### [](#registering-our-types)ç™»è®°æˆ‘ä»¬çš„ç±»å‹

æˆ‘ä»¬æƒ³ç™»è®°å“ªç§ç±»å‹ï¼Ÿ

ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ä½¿ç”¨æœ¬ç³»åˆ—ä¹‹å‰æ–‡ç« ä¸­çš„`ISiteContext`å’Œ`KenticoSiteContext`ç±»å‹å‘¢ï¼ŸğŸ˜Š

é¦–å…ˆï¼Œåˆ›å»º`ISiteContext`æ¥å£:

```
public interface ISiteContext
{
    string SiteName { get; }
    int SiteId { get; }
    SiteInfo Site { get; }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€Œç°åœ¨çš„`KenticoSiteContext`å®ç°:

```
public class KenticoSiteContext : ISiteContext
{
    public string SiteName => SiteContext.CurrentSiteName;

    public int SiteId => SiteContext.CurrentSiteID;

    public SiteInfo Site => SiteContext.CurrentSite;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢æˆ‘ä»¬å°†æ‰€æœ‰çš„ Autofac ç±»å‹æ³¨å†Œæ·»åŠ åˆ°æˆ‘ä»¬çš„`Global.asax.cs`æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯æˆ‘å»ºè®®å°†ç±»å‹æ³¨å†Œç§»åˆ°ä¸€ä¸ªä¸åŒçš„ç±»ä¸­ã€‚

æˆ‘é€šå¸¸åˆ›å»ºä¸€ä¸ª`DependencyResolverConfig.cs`ç±»(æˆ–ç±»ä¼¼çš„ä¸œè¥¿)ã€‚

åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨å†Œæˆ‘ä»¬çš„ç±»å‹ï¼Œç„¶åæ„å»ºå®¹å™¨:

```
public static class DependencyResolverConfig
{
    public static IContainer BuildContainer()
    {
        var builder = new ContainerBuilder();

        builder
            .RegisterSource<KenticoRegistrationSource>();

        builder
            .RegisterType<KenticoSiteContext>()
            .As<ISiteContext>();

        var container = builder.Build();

        return container;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> éšç€è¿™ä¸ªæ–‡ä»¶çš„æ³¨å†Œå’Œå¤æ‚æ€§çš„å¢é•¿ï¼Œæˆ‘æ€»æ˜¯å°†æ³¨å†Œè½¬ç§»åˆ°å•ç‹¬çš„ç±»ä¸­ï¼Œæ¯ä¸ªç±»å…³æ³¨åº”ç”¨ç¨‹åºçš„ç‰¹å®šéƒ¨åˆ†(ä¾‹å¦‚:åº”ç”¨ç¨‹åºã€æ•°æ®è®¿é—®ã€æˆæƒ)ã€‚
> 
> ä½ å¯ä»¥åœ¨ä¸­æ‰¾åˆ°ä¸€ä¸ª[çš„ä¾‹å­ã€‚](https://gist.github.com/seangwright/4918a5c5488a9bb617ebdf1c2557fe6b#file-dependencyresolverconfig-cs)

æ³¨æ„é‚£è¡Œ`builder.RegisterSource<KenticoRegistrationSource>();`ã€‚

è¿™å‘Šè¯‰ Autofacï¼Œå½“å®ƒä¸çŸ¥é“å¦‚ä½•è§£æç±»å‹æ—¶ï¼Œå°†å¯¹è¯¥ç±»å‹çš„å®ä¾‹çš„è¯·æ±‚è½¬å‘ç»™ Kenticoã€‚è¿™å¯ä»¥ä¸ºæˆ‘ä»¬è§£å†³çš„ä¸€ä¸ªç¤ºä¾‹ç±»å‹æ˜¯`CMS.Ecommerce.ICurrentShoppingCartService`ã€‚

> `KenticoRegistrationSource`çš„ä»£ç æœ‰ç‚¹é•¿ï¼Œæ‰€ä»¥å¯ä»¥åœ¨è¿™ä¸ªé‡Œæ‰¾åˆ°[ã€‚](https://gist.github.com/seangwright/4918a5c5488a9bb617ebdf1c2557fe6b#file-kenticoregistrationsource-cs)

ç°åœ¨æˆ‘ä»¬éœ€è¦æ›´æ–°`Global.asax.cs`æ–‡ä»¶ä¸­çš„`Global`ç±»ï¼Œä»¥ä½¿ç”¨æ–°çš„`DependencyResolverConfig`ç±»ã€‚å”¯ä¸€éœ€è¦åšçš„æ›´æ”¹æ˜¯ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢`Application_Start`æ–¹æ³•ã€‚

```
protected void Application_Start(object sender, EventArgs e)
{
    var container = DependencyResolverConfig.BuildContainer();

    containerProvider = new ContainerProvider(container);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#resolving-our-types-in-a-page)è§£æé¡µé¢ä¸­çš„ç±»å‹

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Web è¡¨å•ç±»ï¼Œå¹¶æµ‹è¯•è§£ææˆ‘ä»¬çš„ç±»å‹ã€‚

åœ¨åç§°ä¸º`DIPage`çš„`CMSApp -> CMSPages`ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ Web è¡¨å•é¡µé¢ã€‚ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢`DIPage.aspx.cs`çš„å†…å®¹ã€‚

```
[InjectPropertiesAttribute]
public partial class DIPage : CMSPage
{
    public ISiteContext SiteContext { get; set; }
    public ICurrentShoppingCartService CurrentShoppingCartService { get; set; }

    protected void Page_Load(object sender, EventArgs e)
    {
        var service = CurrentShoppingCartService;

        var cart = service.GetCurrentShoppingCart(
            CurrentUser, 
            SiteContext.SiteName);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†åœ¨ Visual Studio ä¸­åœ¨`Page_Load`æ–¹æ³•çš„å·¦æ‹¬å·ä¸Šè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¹¶è¿è¡Œ CMS é¡¹ç›®è¿›è¡Œè°ƒè¯•ã€‚

å½“æˆ‘ä»¬ç‚¹å‡»æ–­ç‚¹å¹¶å•æ­¥æ‰§è¡Œä»£ç æ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°`SiteContext`å’Œ`CurrentShoppingCartService`å±æ€§è¢«å¡«å……äº†æˆ‘ä»¬æœŸæœ›çš„å€¼ã€‚

ç›¸å½“ä¸é”™ï¼ğŸ˜ƒâœ¨

### [](#resolving-our-types-outside-of-pages-or-controls)è§£æé¡µé¢æˆ–æ§ä»¶ä¹‹å¤–çš„ç±»å‹

å½“æˆ‘ä»¬æƒ³ä» Kentico åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†è§£ææˆ‘ä»¬çš„ç±»å‹æ—¶ï¼Œæ¯”å¦‚ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Ÿ

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ DIï¼Œå› ä¸º Kentico åˆ›å»ºäº†å®šåˆ¶è°ƒåº¦ä»»åŠ¡ç±»çš„å®ä¾‹ã€‚ä¸ Autofac Web Forms é›†æˆåŒ…ä¸åŒï¼Œæˆ‘ä»¬æ— æ³•å‘Šè¯‰ Kentico ä» IoC å®¹å™¨ä¸­è§£ææ„é€ å‡½æ•°å‚æ•°æˆ–ç±»å±æ€§å€¼ã€‚ğŸ¤”

> Kentico ä¹¡äº²:å¦‚æœæœ‰ä¸€ç§æ–¹æ³•æ¥å®šåˆ¶è¿™äº›ç±»å‹çš„åˆ›ä½œï¼Œæˆ‘å¾ˆæƒ³çŸ¥é“ï¼

æˆ‘ä»¬å¯ä»¥åšçš„æ˜¯ä½¿ç”¨ Autofac å®¹å™¨ä½œä¸ºæœåŠ¡å®šä½å™¨ã€‚

> é€šå¸¸æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä½ç½®[è¢«è®¤ä¸ºæ˜¯åæ¨¡å¼](https://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/)ï¼Œä½†æ˜¯å½“ä½ åªè¢«æä¾›æŸ æª¬æ—¶ï¼Œä½ æˆ´ä¸Šæ‰‹å¥—ã€çœ¼ç½©ï¼Œç„¶åå¼€å§‹æ¦¨æ±ï¼ğŸ¥¤

ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„è°ƒåº¦ä»»åŠ¡ï¼Œè¿”å›å½“å‰è¯·æ±‚ç”¨æˆ·çš„è´­ç‰©è½¦ Idã€‚

```
public class GetCurrentUserShoppingCartIdTask : ITask
{
    private readonly ISiteContext siteContext;
    private readonly ICurrentShoppingCartService currentShoppingCartService;

    public GetCurrentUserShoppingCartIdTask()
    {
        // Get the instance of our application
        var application = HttpContext
                .Current
                .ApplicationInstance as IContainerProviderAccessor;

        // Get the global container from the application
        var container = application
                .ContainerProvider
                .ApplicationContainer;

        // Resolve our dependencies
        siteContext = container.Resolve<ISiteContext>();
        currentShoppingCartService = container.Resolve<ICurrentShoppingCartService>();
    }

    public string Execute(TaskInfo task)
    {
        string siteName = siteContext.SiteName;

        var cart = currentShoppingCartService.GetCurrentShoppingCart(
            MembershipContext.AuthenticatedUser, 
            siteName);

        return cart.ShoppingCartID.ToString();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯¹å·²ç»è§è¿‡çš„ä¸¤ç§ç±»å‹(`ISiteContext`å’Œ`ICurrentShoppingCartService`)è¿›è¡Œä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰é€šè¿‡ç±»æ„é€ å‡½æ•°æˆ–å…¬å…±å±æ€§è·å¾—å®ƒä»¬ï¼Œè€Œæ˜¯ç›´æ¥ä»å®¹å™¨ä¸­è§£æå®ƒä»¬ã€‚

> ä¸Šé¢çš„`IContainerProviderAccessor application`æ˜¯ä»æˆ‘ä»¬åœ¨`Global.asax.cs`ä¸­çš„`Global`ç±»åˆ›å»ºçš„åº”ç”¨ç¨‹åºçš„å®ä¾‹ï¼Œè€Œ`ILifetimeScope container`æ˜¯ Web Forms ä½¿ç”¨è‡ªå®šä¹‰çš„`Page`å’Œ`UserControl`ç±»å‹æ¥è·å–å±æ€§æ³¨å…¥å®ä¾‹çš„ç›¸åŒä¸œè¥¿ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­è§£æä¾èµ–å…³ç³»ï¼Œç„¶ååœ¨`Execute()`æ–¹æ³•ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

è¯¥æ„é€ å‡½æ•°ä¸­æœ‰å¾ˆå¤šç²˜åˆä»£ç ã€‚è®©æˆ‘ä»¬æŠŠä¸€äº›ç§»åˆ°ä¸€ä¸ªæ‰©å±•æ–¹æ³•ä¸­ã€‚

```
public static class TaskExtensions
{
    public static ILifetimeScope GetContainer(this ITask task, HttpContext context)
    {
        // Get the instance of our application
        var application = context
                .ApplicationInstance as IContainerProviderAccessor;

        // Get the global container from the application
        return application
                .ContainerProvider
                .ApplicationContainer;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬çš„æ„é€ å‡½æ•°å¦‚ä¸‹:

```
public GetCurrentUserShoppingCartIdTask()
{
    var container = this.GetContainer(HttpContext.Current);

    // Resolve our dependencies
    siteContext = container.Resolve<ISiteContext>();
    currentShoppingCartService = container.Resolve<ICurrentShoppingCartService>();
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> åªèƒ½åœ¨`ITask`ä¸Šè°ƒç”¨`GetContainer()`æ‰©å±•æ–¹æ³•ï¼Œè¿™å¯ä»¥é˜²æ­¢æœåŠ¡å®šä½å™¨æ¨¡å¼æ³„æ¼åˆ°æˆ‘ä»¬ä»£ç åº“çš„å…¶ä½™éƒ¨åˆ†ï¼ğŸ‘

æˆ‘æœ€åçš„å»ºè®®æ˜¯ï¼Œå°†`Execute()`æ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘è½¬ç§»åˆ°å¦ä¸€ä¸ªç±»ä¸­ï¼Œè¯¥ç±»éµå¾ª MVC-DI å’Œ[å•ä¸€è´£ä»»åŸåˆ™](https://en.wikipedia.org/wiki/Single_responsibility_principle)çš„æ¨¡å¼å’Œå®è·µã€‚

è¿™ä¸ªæ–°ç±»å°†æŠŠ`ISiteContext`å’Œ`ICurrentShoppingCartService`ä½œä¸ºæ„é€ å‡½æ•°ä¾èµ–é¡¹ï¼Œå¹¶æœ‰ä¸€ä¸ªç®€å•çš„ API(æœ€å¤šåªæœ‰å‡ ä¸ªæ–¹æ³•)æ¥å¤„ç†é¢„å®šçš„ä»»åŠ¡ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ IoC å®¹å™¨æ¥åˆ›å»ºå®ƒçš„å®ä¾‹ï¼Œè€Œä¸æ˜¯å®ƒçš„ä¾èµ–é¡¹ã€‚ç„¶åæˆ‘ä»¬åœ¨`ITask.Execute()`æ–¹æ³•ä¸­è°ƒç”¨å®ƒçš„æ–¹æ³•ã€‚

## [](#wrap-up)æ€»ç»“ä¸€ä¸‹ï¼

æˆ‘ä»¬å›é¡¾äº†ä»€ä¹ˆæ˜¯æ§åˆ¶åè½¬ï¼Œå®ƒå¦‚ä½•æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œä»¥åŠ ASP.NET MVC å¦‚ä½•ä½¿ç”¨è¿™äº›æ¦‚å¿µæ¥å¸®åŠ©å¼€å‘äººå‘˜åˆ›å»ºåº”ç”¨ç¨‹åºã€‚ğŸ§

å°½ç®¡ ASP.NET Web Forms ä¸æ”¯æŒè¿™ä¸¤ä¸ªç°æˆçš„æ¦‚å¿µï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ Autofac æ¥å¢å¼ºè¿™ä¸ªæ¡†æ¶ï¼Œä»¥å…è®¸å±æ€§æ³¨å…¥`Page`å’Œ`UserControl`ç±»å‹ã€‚ğŸ˜

æˆ‘ä»¬è¿˜çœ‹äº†ä¸€ä¸ªåœºæ™¯ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è§£å†³æˆ‘ä»¬æ— æ³•ä¸ IoC å®¹å™¨é›†æˆçš„ Kentico ç±»å‹ä¸­çš„æ³¨å†Œä¾èµ–é¡¹ã€‚ğŸ¤—

ç›¸åï¼Œæˆ‘ä»¬è¯´ [YOLOï¼å¹¶ä½¿ç”¨æœåŠ¡å®šä½å™¨æ¨¡å¼æ¥è§£ææˆ‘ä»¬çš„ç±»å‹ã€‚ğŸ˜œ](https://en.wikipedia.org/wiki/YOLO_(aphorism))

æˆ‘å¸Œæœ›è¿™ä¸ªæ¼”ç»ƒå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè§£é‡Šä¹Ÿå¾ˆæ¸…æ¥šï¼

è¿™æ˜¯æˆ‘å°†åšå®¢ä» [Medium](https://medium.com/@seangwright) åˆ‡æ¢åˆ° DEV åçš„ç¬¬ä¸€ç¯‡åšæ–‡ï¼Œæˆ‘æœŸå¾…ç€åœ¨æœªæ¥å†™æ›´å¤šã€‚

å…³äº Kentico è®¾è®¡æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·ç‚¹å‡» DEV ä¸Šçš„[æŸ¥çœ‹æˆ‘çš„ç³»åˆ—](https://dev.to/search?q=Kentico%2012%20-%20Design%20Patterns)æˆ– Kentico æ ‡ç­¾ã€‚

## # [è‚¯è’‚ç§‘](https://dev.to/t/kentico) <button name="button" type="button" data-info="{&quot;className&quot;:&quot;Tag&quot;,&quot;style&quot;:&quot;full&quot;,&quot;id&quot;:5339,&quot;name&quot;:&quot;kentico&quot;}" class="crayons-btn follow-action-button whitespace-nowrap c-btn--secondary fs-base " aria-label="Follow tag: kentico" aria-pressed="false">è·Ÿéš</button>