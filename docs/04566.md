# ç»™ Angular åº”ç”¨ç¨‹åºæ·»åŠ é‡Šæ”¾å¼€å…³â€”â€”ç®€å•çš„æ–¹æ³•

> åŸæ–‡:[https://dev . to/the Karel/adding-release-toggles-to-an-angular-app-the-easy-way-1caf](https://dev.to/thekarel/adding-release-toggles-to-an-angular-app-the-easy-way-1caf)

æœ¬æ•™ç¨‹é€‚ç”¨äºä»[ç”¨ Appknobsã€React & CLI](https://dev.to/thekarel/implementing-release-toggles-with-appknobs-react-cli-3b06) å®ç°é‡Šæ”¾åˆ‡æ¢çš„ Angularã€‚

## [](#lets-add-a-release-toggle)è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé‡Šæ”¾å¼€å…³

å½“ä½ è¿›è¡ŒåŸºäºä¸»å¹²çš„å¼€å‘æ—¶ï¼Œä½ çš„ä¸»åˆ†æ”¯ä¸­çš„ä»»ä½•ä¸œè¥¿â€”â€”é€šå¸¸æ˜¯ masterâ€”â€”éƒ½ä¼šè¢«æ¨å‘ç”Ÿäº§ã€‚åŒæ—¶ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨çŸ­å‘½çš„ç‰¹æ€§åˆ†æ”¯ï¼Œä¸€æ¬¡æ·»åŠ ä¸€äº›å°çš„æ”¹è¿›ï¼Œå¹¶ç»å¸¸é›†æˆ(åˆå¹¶)ã€‚ä¸ºäº†é˜²æ­¢åŠæˆå“ç‰¹å¾å‡ºç°åœ¨ç”Ÿäº§ä¸­ï¼Œä½ éœ€è¦ä½¿ç”¨*é‡Šæ”¾å¼€å…³*ã€‚è¿™äº›å¼€å…³â€”â€”ä¹Ÿç§°ä¸ºå‘å¸ƒæ ‡å¿—â€”â€”å°†å…è®¸æ‚¨éƒ¨ç½²ã€æ¼”ç¤ºå’Œç«¯åˆ°ç«¯æµ‹è¯•ç”±é€‰å®šç”¨æˆ·å¼€å‘çš„åŠŸèƒ½ï¼Œä½†å¯¹å…¶ä»–ä»»ä½•äººéšè—å®ƒã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ¦‚å¿µï¼Œä½†å¦‚æœä½ è¯•å›¾ä»å¤´å¼€å§‹å®ç°å®ƒï¼Œå°±ä¼šé‡åˆ°ä¸€äº›å›°éš¾ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Appknobs çš„ä¸¤ä¸ªå¼€æº NPM åŒ…æ¥å¿«é€Ÿå®Œæˆè¿™é¡¹å·¥ä½œ:UI çš„ [@appknobs/angular](https://www.npmjs.com/package/@appknobs/angular) å’Œå‘½ä»¤è¡Œçš„ [@appknobs/cli](https://www.npmjs.com/package/@appknobs/cli) ã€‚

## [](#create-a-new-project-optional)åˆ›å»ºæ–°é¡¹ç›®(å¯é€‰)

æˆ‘ä»¬å‡è®¾ä½ æœ‰ä¸€ä¸ªå·¥ä½œçš„ Angular 7 åº”ç”¨ç¨‹åºä¸ºæ–°çš„ç‰ˆæœ¬åˆ‡æ¢åšå¥½äº†å‡†å¤‡ã€‚å¦‚æœä½ éœ€è¦ä¸€ä¸ªå¿«é€Ÿæ²™ç›’ï¼Œä½¿ç”¨
ç”Ÿæˆä¸€ä¸ª

```
npm install -g @angular/cli
ng new my-sandbox --defaults 
```

æˆ–è€…ç”¨çº±çº¿:

```
yarn global add @angular/cli
ng config -g cli.packageManager yarn
ng new my-sandbox --defaults 
```

## [](#install-dependencies)å®‰è£…ä¾èµ–é¡¹

åœ¨ä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œå®‰è£…`@appknobs/angular`ã€`@appknobs/client`å’Œ`@appknobs/cli` :

```
npm install @appknobs/angular @appknobs/client && npm install -D @appknobs/cli 
```

æˆ–è€…

```
yarn add @appknobs/angular @appknobs/client && yarn add -D @appknobs/cli 
```

## [](#add-a-release-toggle)æ·»åŠ ä¸€ä¸ªé‡Šæ”¾å¼€å…³

`@appknobs/angular`å¸¦æœ‰ä¸€ä¸ªå£°æ˜æ€§çš„ç‰¹æ€§åˆ‡æ¢ç»„ä»¶`<ak-feature>`ã€‚åœ¨ä½ ç”¨`<ak-feature name='...'><YourSection /></ak-feature>`å°è£…äº†åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ä¹‹åï¼Œå®ƒå°±å˜æˆäº†ä¸€ä¸ªæ‰˜ç®¡ç‰¹æ€§ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹åˆ‡æ¢å‘å¸ƒã€‚

è¿™å–å†³äºä½ é€‰æ‹©ä½ çš„ç”¨æˆ·ç•Œé¢çš„ä¸€éƒ¨åˆ†éšè—åœ¨ä¸€ä¸ªå¼€å…³åé¢ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨æ²™ç›’ï¼Œè¯·æ‰“å¼€`src/app/app.component.html`å¹¶å°†å…¶æ›´æ”¹ä¸º

```
<div style="text-align:center">
  <h1>
    Welcome to {{ title }}!
  </h1>
  <img width="300" alt="Angular Logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/Angular_full_color_logo.svg/1200px-Angular_full_color_logo.svg.png">

  <ak-feature name="sandbox-message">
    <h1>I'm using release toggles in Angular!</h1>
  </ak-feature>
</div> 
```

è¿™æ®µä»£ç å°†`<h1>I'm using release toggles in Angular!</h1>`éšè—åœ¨é‡Šæ”¾å¼€å…³ä¹‹åã€‚æ˜¯çš„ï¼Œè¿™æœ‰ç‚¹ç®€å•ï¼Œä½†ä½œä¸ºä¸€ä¸ªä¾‹å­å¾ˆå¥½ã€‚`<ak-feature>`ç»„ä»¶å¯ä»¥åŒ…è£…ä½ çš„ UI å±‚æ¬¡ç»“æ„çš„ä»»ä½•éƒ¨åˆ†â€”â€”æ‰€ä»¥å®ƒå¾ˆçµæ´»ï¼Œå¯ä»¥æ»¡è¶³å¤æ‚çš„åœºæ™¯ã€‚

è¯·æ³¨æ„ï¼Œä¸€æ—¦åŠŸèƒ½è¢«ç®¡ç†ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯éšè—çš„ã€‚å› æ­¤æ‚¨çš„æ¶ˆæ¯æš‚æ—¶ä¸ä¼šæ˜¾ç¤ºã€‚

## [](#feature-flag-autodiscovery)ç‰¹å¾æ ‡å¿—è‡ªåŠ¨å‘ç°

ä½¿ç”¨`@appknobs/cli`-app knobs çš„å‘½ä»¤è¡Œç•Œé¢-è®©ç‰¹æ€§ç®¡ç†æœåŠ¡çŸ¥é“ä½ çš„å‘å¸ƒæ ‡å¿—ã€‚ä½¿ç”¨ Yarnï¼Œæ‚¨å¯ä»¥ç®€å•åœ°è¿è¡Œ`yarn knobs`æ¥è°ƒç”¨å®ƒï¼Œå¦åˆ™ï¼Œåœ¨æ‚¨çš„`package.json`ä¸­æ·»åŠ ä¸€è¡Œ...

```
 "scripts":  {  "knobs":  "knobs"  } 
```

â€¦ç„¶åè¿è¡Œ`npm run knobs`ã€‚å°†`@appknobs/cli`ä½œä¸ºä¸€ä¸ªå…¨å±€åŒ…å®‰è£…æˆ–è€…è¿è¡Œ`npx @appknobs/cli â€”help`ä¹Ÿå¯ä»¥ã€‚å¯¹äºä¸‹é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‡è®¾å®ƒæ˜¯ä¸€ä¸ªå…¨çƒåŒ…ã€‚

ä¸ºäº†è®©ä½ çš„ç”Ÿæ´»æ›´å®¹æ˜“ï¼ŒAppknobs å¯ä»¥æŸ¥çœ‹ä½ çš„ä»£ç åº“ï¼Œè‡ªåŠ¨æ‰¾åˆ°å¹¶æ³¨å†Œæ‰€æœ‰çš„ç‰¹æ€§æ ‡å¿—ã€‚æ— éœ€æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ã€‚

ä»é¡¹ç›®çš„é¡¶å±‚è°ƒç”¨`knobs parse src/`ï¼Œè¯¥å·¥å…·å°†å¼•å¯¼æ‚¨å®Œæˆæ•´ä¸ªè¿‡ç¨‹:

```
$ knobs parse src

You need to log in before you can upload feature flags from your project

? Would you like to log in or register now? â€¦
  Log in
â¯ Register
  Quit 
```

åŸºæœ¬ä¸Šï¼Œä½ éœ€è¦é€‰æ‹©*æ³¨å†Œ*ï¼Œè¾“å…¥ä½ çš„é‚®ç®±å’Œå¯†ç ï¼Œå›è½¦:

```
App name: my-sandbox
App ID: DfXPWwujs4YxZc2~Ay8~9
Framework: auto-guessing

Found the following feature flags:
ğŸ‘‰ sandbox-message

ğŸ‘ sandbox-message saved 
```

å¥½äº†ğŸ‘

ä½ çš„é‡Šæ”¾åˆ‡æ¢è¢«è‡ªåŠ¨å‘ç°å¹¶è®°å½•åœ¨ Appknobs æœåŠ¡ä¸­ã€‚

## [](#get-your-app-id)è·å–æ‚¨çš„åº”ç”¨ ID

è¯·è®°ä¸‹ä½ çš„åº”ç”¨ IDï¼Œå› ä¸ºä½ å¾ˆå¿«å°±ä¼šç”¨åˆ°å®ƒã€‚è¦åœ¨ä»¥åæ‰¾åˆ°å®ƒï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
$ knobs app-info

âœ” App name: my-app-xxx
âœ” appID: TfXPkjh3ysHYxZc2~Ay8~9 
```

## [](#get-your-api-key)è·å–æ‚¨çš„ API å¯†é’¥

æ‚¨å°†éœ€è¦ä¸€ä¸ª API å¯†é’¥æ¥ä»æ‚¨çš„åº”ç”¨ç¨‹åºè®¿é—® Appknobs æœåŠ¡ã€‚

CLI å†æ¬¡ä¸ºæ‚¨æœåŠ¡:

```
$ knobs apikey

âœ” Your API key is: 62zYKyP8f8sAqxpPoYAcm and is valid until Mon May 13 2019 
```

ğŸ’¡æç¤º:ä½ å¯ä»¥éšæ—¶å»æˆ‘ä»¬åœ¨ https://console.appknobs.io/çš„ç½‘ç»œæ§åˆ¶å°æ‰¾åˆ°è¿™äº›ä¿¡æ¯ã€‚

## [](#connect-to-appknobs-service)è¿æ¥ Appknobs æœåŠ¡

ä¸ºäº†ç¡®ä¿æ¯ä¸ªç‰¹æ€§åœ¨éœ€è¦æ—¶â€œç¿»è½¬â€,æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª**æœåŠ¡**,å®ƒä¼šè‡ªåŠ¨å°†æ›´æ”¹ä¼ æ’­ç»™æ‰€æœ‰çš„`<ak-feature>`ã€‚

åœ¨æœåŠ¡é…ç½®ä¸­ï¼Œæ‚¨**æ³¨å…¥æœåŠ¡å®¢æˆ·ç«¯**ï¼Œå®ƒå°†åœ¨è¿è¡Œæ—¶è·å–åº”ç”¨ç¨‹åºçš„å¯ç”¨åŠŸèƒ½åˆ‡æ¢ã€‚ä½ éœ€è¦ä¹‹å‰çš„`appId`å’Œ`apiKey`ã€‚

æœ€åï¼Œæ‚¨**å‘é€è¿è¡Œæ—¶ä¸Šä¸‹æ–‡**â€”â€”ä¾‹å¦‚ç”¨æˆ·åã€ä¸»æœºåã€cookie å€¼ç­‰ã€‚-æä¾›ç»™æœåŠ¡ä»¥å¯¹åº”ç”¨åŠŸèƒ½æ ‡å¿—çš„çŠ¶æ€åšå‡ºå†³å®šã€‚ä¸Šä¸‹æ–‡è´Ÿè½½çš„å†…å®¹å®Œå…¨ç”±æ‚¨å†³å®šã€‚ä¸‹é¢çš„ä¾‹å­å¾ˆç®€å•ï¼Œä½†æ˜¯ç°åœ¨æœ‰æ•ˆï¼Œå¹¶ä¸”å…è®¸ä½ ç»§ç»­å°è¯•ã€‚[åœ¨æˆ‘ä»¬ä¹‹å‰çš„åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°æ›´å¤šå…³äºæœ‰æ•ˆè½½è·å’Œæ¡ä»¶çš„ä¿¡æ¯ã€‚](https://dev.to/blog/getting-to-know-the-appknobs-console#define-the-conditions)

ğŸ’¡æç¤º:æŸ¥çœ‹ [`@appknobs/angular`](https://www.npmjs.com/package/@appknobs/angular) å’Œ [`@appknobs/client`](https://www.npmjs.com/package/@appknobs/client) æ–‡æ¡£ä»¥äº†è§£é«˜çº§ä¸»é¢˜ï¼Œæˆ–è€…çœ‹çœ‹æˆ‘ä»¬åœ¨[app knobs/app knobs-examples](https://github.com/appknobs/appknobs-examples)repo ä¸­çš„ä»£ç ç¤ºä¾‹ã€‚

å¯¹äºæ²™ç›’ç¤ºä¾‹ï¼Œ`src/app/app.module.ts`éœ€è¦åƒè¿™æ ·ä¿®æ”¹:

```
import { BrowserModule } from '@angular/platform-browser';
import { NgModule } from '@angular/core';

import { AppComponent } from './app.component';

// Import the Appknobs modules
import { newBrowserClient } from '@appknobs/client';
import { AppknobsModule} from '@appknobs/angular';

// Configure the client
const appknobsClient = newBrowserClient({
  appId: 'YOUR_APP_ID',
  apiKey: 'YOUR_API_KEY'
});

@NgModule({
  declarations: [
    AppComponent
  ],
  imports: [
    BrowserModule,
    // Inject the client
    AppknobsModule.forRoot({client: appknobsClient})
  ],
  providers: [],
  bootstrap: [AppComponent]
})
export class AppModule { } 
```

## [](#fetching-the-feature-list)æŠ“å–åŠŸèƒ½åˆ—è¡¨

æ‚¨å¯ä»¥éšæ—¶è·å–å·²å¯ç”¨åŠŸèƒ½çš„åˆ—è¡¨ã€‚ä¸€ä¸ªå¿«é€Ÿç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å¯åŠ¨æ—¶åšä¸€æ¬¡ï¼Œä½†æ˜¯å½“ç„¶ï¼Œè¿™å¯ä»¥åœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„ä»»ä½•æ—¶å€™é‡å¤ã€‚

å°†`AppknobsService`æ³¨å°„åˆ°`app.component.ts`ä¸­ï¼Œå¹¶æ‹¨æ‰“ç”µè¯:

```
import { Component, OnInit } from '@angular/core';

import {AppknobsService} from '@appknobs/angular';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent {
  title = 'my-sandbox';

  private appknobs = null;

  constructor(appknobs: AppknobsService) {
    this.appknobs = appknobs;
  }

  ngOnInit() {
    // A quick-and-easy way to toggle features by deployment target:
    this.appknobs.evaluate({hostname: document.location.hostname});
  }
} 
```

ä½¿ç”¨
å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº

```
ng serve 
```

## ä½ çš„ä»£ç å·²ç»å‡†å¤‡å¥½äº†

å¦‚å‰æ‰€è¿°ï¼Œé‡Šæ”¾åˆ‡æ¢èƒŒåçš„æ€æƒ³æ˜¯æ‚¨å¯ä»¥åœ¨ä¸æ”¹å˜ä»£ç çš„æƒ…å†µä¸‹æ”¹å˜ç‰¹æ€§çš„å¯è§æ€§ã€‚æ—¢ç„¶â€œæ²™ç›’-æ¶ˆæ¯â€åŠŸèƒ½ç°åœ¨å·²ç»è¢«ç®¡ç†äº†ï¼Œè®©æˆ‘ä»¬å‰å¾€ä½äº[https://console.appknobs.io/](https://console.appknobs.io/)çš„ web æ§åˆ¶å°å¹¶è®¾ç½®æ¡ä»¶ã€‚

ğŸ’¡æç¤º:`knobs console`å°†æ‰“å¼€ web UI

æœ‰ä¸€ä¸ª[web æ§åˆ¶å°](https://dev.to/blog/getting-to-know-the-appknobs-console)çš„è¯¦ç»†æŒ‡å—ï¼Œå¦‚æœéœ€è¦çš„è¯ä½ å¯ä»¥å‚è€ƒã€‚æ­¥éª¤éå¸¸ç®€å•:

*   å‚è§‚[https://console.appknobs.io/](https://console.appknobs.io/)
*   **ä½¿ç”¨æ‚¨çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•**
*   åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸‹â€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯â€œæˆ‘çš„æ²™ç›’â€â€”â€”ç‚¹å‡»**ç¼–è¾‘ç‰¹å¾**
*   åœ¨æ‚¨å®šä¹‰çš„ç‰¹æ€§ä¸‹â€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯â€œæ²™ç›’-æ¶ˆæ¯â€â€”â€”ç‚¹å‡»**ç¼–è¾‘æ¡ä»¶**

åœ¨**æ¡ä»¶è¡¨**ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ :

*   `hostname`ä½œä¸ºè´¢äº§
*   `Equal to`ä½œè°“è¯­
*   `localhost`ä½œä¸ºè®ºæ®

â€”ç„¶åä¿å­˜ã€‚

## [](#done)æå®š

é‡æ–°åŠ è½½æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œäº«å—æ‚¨çš„æƒŠäººæ¶ˆæ¯ï¼ğŸ¥‡

[![feature visible](../Images/6c3c17ff55ad59442cd93ad28bb83c10.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--59qiQ9mo--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/9e7ngen87b4ff8qlytvp.png)

å°è¯•å°†`app.component.ts`ä¸­çš„ä¸Šä¸‹æ–‡è´Ÿè½½è®¾ç½®ä¸ºå…¶ä»–å€¼ï¼Œä¾‹å¦‚`{hostname: 'example.com'}`ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

æ³¨æ„:è¯„ä¼°è¢«æœ‰æ•ˆè´Ÿè½½ç¼“å­˜ 1 åˆ†é’Ÿï¼Œå› æ­¤åœ¨æ§åˆ¶å°ä¸Šæ‰€åšçš„*æ›´æ”¹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ‰èƒ½åœ¨åº”ç”¨ç¨‹åºä¸­çœ‹åˆ°ã€‚*

å¸Œæœ›æœ¬æŒ‡å—å…è®¸æ‚¨ä½¿ç”¨å‘å¸ƒå¼€å…³å¼€å§‹ä¸€ä¸ªæ›´æœ‰æˆæ•ˆçš„ã€åŸºäºä¸»å¹²çš„å¼€å‘ä¹‹æ—…ã€‚å¦‚æœä½ å–œæ¬¢å®ƒï¼Œè¯·åˆ†äº«ï¼Œæˆ–è€…è®©æˆ‘çŸ¥é“æˆ‘æ˜¯å¦é”™è¿‡äº†ä»€ä¹ˆï¼