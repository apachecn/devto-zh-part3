# åˆ†å±‚è€ƒè¯•ç»“æ„æ€ä¹ˆç»å¯¹ä¹±ï¼Ÿ

> åŸæ–‡:[https://dev . to/water link/how-can-hierarchical-test-structure-absolute-make-a-mess-27fb](https://dev.to/waterlink/how-can-hierarchical-test-structure-absolutely-make-a-mess-27fb)

ä½ æ›¾ç»ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ xUnit é£æ ¼çš„æµ‹è¯•æ¡†æ¶ç¼–å†™è¿‡ä½ çš„å•å…ƒæµ‹è¯•å—ï¼Ÿ

é‚£ä¹ˆä½ å¯èƒ½çŸ¥é“ï¼Œéšç€æµ‹è¯•å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå®ƒä»¬æ”¶é›†çš„æ ·æ¿æ–‡ä»¶å’Œé‡å¤æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œè¦ä¹ˆåœ¨æµ‹è¯•æ–¹æ³•ä¸­ä¼ æ’­ï¼Œè¦ä¹ˆåœ¨è®¾ç½®å‡½æ•°ä¸­ä¼ æ’­ã€‚

ç°åœ¨ï¼Œå±‚æ¬¡åŒ–çš„ä¸Šä¸‹æ–‡æ¡†æ¶éå¸¸å¥å£®ï¼Œå¯ä»¥å‡è½»è¿™ç§æ ·æ¿é—®é¢˜å¹¶æ¶ˆé™¤è¿™ç§é‡å¤ã€‚å®ƒä»¬å…è®¸æ‚¨æ‹¥æœ‰åµŒå¥—çš„ä¸Šä¸‹æ–‡ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡éƒ½æœ‰è‡ªå·±çš„è®¾ç½®ï¼Œå¹¶â€œç»§æ‰¿â€çˆ¶ä¸Šä¸‹æ–‡çš„è®¾ç½®ã€‚

è¿™æ ·ï¼Œæ‚¨å¯ä»¥è¡¨è¾¾è®¸å¤šä¸åŒçš„åœºæ™¯ï¼Œè€Œæ— éœ€åœ¨æµ‹è¯•è®¾ç½®ä»£ç ä¸­é‡å¤ä¸€æ¬¡ã€‚

å¾ˆæ£’ï¼Œä¸æ˜¯å—ï¼Ÿ

ç°åœ¨ï¼Œå¦‚æœæˆ‘å‘Šè¯‰ä½ ï¼Œå±‚æ¬¡åŒ–çš„æµ‹è¯•ç»“æ„ä¼šå¯¼è‡´æ›´å¾®å¦™çš„é‡å¤(è¿™æœ¬æ¥æ˜¯åº”è¯¥é˜²æ­¢çš„),å¾ˆéš¾å‘ç°å’Œé‡æ„ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ

è®©æˆ‘ç»™ä½ ä¸€ä¸ªè¿‡äºç®€å•çš„ä¾‹å­:

## [](#two-fetchers-elusively-alike)ä¸¤ä¸ªèƒå„¿ï¼Œéš¾ä»¥æ‰æ‘¸åœ°ç›¸åƒ

å‰å‡ å¤©ï¼Œæˆ‘æ­£åœ¨å¼€å‘ä¸¤ä¸ªâ€œfetcherâ€ç±»ï¼Œå®ƒä»¬ä¸ç¬¬ä¸‰æ–¹ API çš„ HTTP å®¢æˆ·ç«¯å¯¹è¯ï¼ŒåŒ…å«éœ€è¦å®Œæˆçš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜å¯ä»¥å¤„ç†å³æ—¶çš„â€œæˆåŠŸâ€å’Œå¼‚æ­¥çš„â€œæ¥å—â€å“åº”ã€‚

ä»–ä»¬çš„ä»£ç éå¸¸ç›¸ä¼¼ï¼Œå¤„ç†å“åº”å’Œé‡æ–°è°ƒåº¦å¼‚æ­¥ä»»åŠ¡çš„æ•´ä¸ªé€»è¾‘éƒ½æ˜¯é‡å¤çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨äº§å“ä»£ç ä¸­çš„ä¸€ä¸ªå•ç‹¬çš„ collaborator å¯¹è±¡ä¸­å¯¹å…¶è¿›è¡Œäº†é‡æ„ã€‚

ç„¶åæˆ‘ä»¬æƒ³:â€œå—¯ï¼Œæˆ‘ä»¬åœ¨äº§å“ä»£ç ä¸­é‡æ„äº†å¤åˆ¶ã€‚æµ‹è¯•ä»£ç ä¸­è‚¯å®šä¼šæœ‰é‡å¤ã€‚æˆ‘ä»¬ä¹ŸæŠŠå®ƒå¼„å¹²å§ï¼â€

æ²¡é‚£ä¹ˆå¿«ï¼

å½“æˆ‘ä»¬å¼€å§‹å¹¶æ’é˜…è¯»ä¸¤ä¸ªæµ‹è¯•å¥—ä»¶æ—¶ï¼Œå‘ç°å®ƒä»¬çœ‹èµ·æ¥ä¸å¤ªåƒã€‚å¾ˆéš¾å‘ç°å’Œéš”ç¦»é‡å¤ã€‚

å®ƒä»¬æ˜¯ä»¥åˆ†å±‚çš„é£æ ¼ç¼–å†™çš„ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨äº†åµŒå¥—ä¸Šä¸‹æ–‡çš„å…¨éƒ¨åŠŸèƒ½ã€‚

ä¸‹é¢æ˜¯ç¬¬ä¸€ä¸ªæµ‹è¯•çš„ç®€åŒ–ç¤ºä¾‹(åœ¨ Kotlin ä¸­):

```
describe("FetcherOne") {
    lateinit var asyncQueue: AsyncQueue
    lateinit var fetcher: FetcherOne

    val client = Client()
        .withMockResponseStatus("accepted")

    // â€¦ more irrelevant variables here â€¦

    beforeEachTest {
        asyncQueue = AsyncQueue()
        fetcher = FetcherOne(asyncQueue, client)
    }

    describe("perform") {
        beforeEachTest {
            fetcher.perform()
        }

        it("tells client to do stuff") {
            assertThat(client.actions).contains("doStuff")
        }

        it("triggers an async polling job") {
            assertThat(asyncQueue).contains(fetcher::pollStatus)
        }

        // â€¦ more irrelevant tests here â€¦

        context("when there is no need to check for status") {
            beforeGroup {
                client.mockResponseStatus("successful")
            }

            it("does not trigger an async polling job") {
                assertThat(asyncQueue).isEmpty()
            }

            // â€¦ more irrelevant tests here â€¦
        }

        // â€¦ more irrelevant contexts here â€¦
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥æµ‹è¯•å¥—ä»¶ä»æ ¹ä¸Šä¸‹æ–‡å¼€å§‹ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œä¸ºæ‚¨çš„æµ‹è¯•å¥—ä»¶è®¾ç½®å…¨å±€é»˜è®¤å€¼ï¼Œå¹¶åœ¨åµŒå¥—çš„ä¸Šä¸‹æ–‡ä¸­è¦†ç›–å…¶ä¸­çš„ä¸€äº›ã€‚

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå…¸å‹çš„â€œå¿«ä¹è·¯å¾„â€åœºæ™¯ï¼Œç„¶åæ‚¨æœ‰æ›´å¤šçš„â€œç‰¹æ®Šæƒ…å†µâ€ï¼Œæ‚¨å°†ä½¿ç”¨åµŒå¥—ä¸Šä¸‹æ–‡ï¼Œè¿™æ˜¯å¾ˆå¥½çš„ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿ HTTP å®¢æˆ·ç«¯ä»¥â€œæ¥å—â€çŠ¶æ€è¿›è¡Œå“åº”:

```
val client = Client()
    .withMockResponseStatus("accepted") 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨å…¶ä¸­ä¸€ä¸ªåµŒå¥—ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å“åº”çŠ¶æ€è¦†ç›–ä¸ºâ€œæˆåŠŸâ€:

```
beforeGroup {
    client.mockResponseStatus("successful")
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®°ä½æ‰€æœ‰è¿™äº›ï¼Œçœ‹çœ‹ç¬¬äºŒä¸ªæµ‹è¯•å¥—ä»¶:

```
describe("FetcherTwo") {
    lateinit var asyncQueue: AsyncQueue
    lateinit var fetcher: FetcherTwo

    val client = Client()

    // â€¦ more irrelevant variables here â€¦

    beforeGroup {
        client.mockResponseStatus("successful")
    }

    beforeEachTest {
        asyncQueue = AsyncQueue()
        fetcher = FetcherTwo(asyncQueue, client)
    }

    describe("perform") {
        beforeEachTest {
            fetcher.perform()
        }

        it("tells client to do some other stuff") {
            assertThat(client.actions).contains("doSomeOtherStuff")
        }

        it("does not trigger an async polling job") {
            assertThat(asyncQueue).isEmpty()
        }

        // â€¦ more irrelevant tests here â€¦

        context("when there is a need to check operation status async") {
            beforeGroup {
                client.mockResponseStatus("accepted")
            }

            it("triggers an async job to check the last operation") {
                assertThat(asyncQueue).contains(fetcher::checkLastOperation)
            }

            // â€¦ more irrelevant tests here â€¦
        }

        // â€¦ more irrelevant contexts here â€¦
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œè¿™ä¸ªæµ‹è¯•å¥—ä»¶çš„ä½œè€…é€‰æ‹©äº†ä¸åŒçš„å“åº”çŠ¶æ€ä½œä¸ºé»˜è®¤çš„â€œå¿«ä¹ä¹‹è·¯â€åœºæ™¯â€”â€”â€œæˆåŠŸâ€:

```
val client = Client()

beforeGroup {
    client.mockResponseStatus("successful")
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*(å¹¶åœ¨æ­¤åŸºç¡€ä¸Šä½¿ç”¨äº†ä¸åŒçš„å˜²è®½é£æ ¼)*

å¹¶ä¸”åµŒå¥—ä¸Šä¸‹æ–‡å°†å“åº”çŠ¶æ€è¦†ç›–ä¸ºâ€œå·²æ¥å—â€çŠ¶æ€:

```
beforeGroup {
    client.mockResponseStatus("accepted")
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæœ‰äº†è¿™ä¸ªä¾‹å­ï¼Œä½ å°±å¯ä»¥åœ¨é¢ å€’ä¸€ä¸ªæµ‹è¯•å¥—ä»¶çš„é»˜è®¤å’Œå®šåˆ¶åœºæ™¯ä¹‹åï¼Œæ‰¾å‡ºå¦‚ä½•è¶³å¤Ÿå¿«åœ°é‡æ„å®ƒï¼Œå¯¹å—ï¼Ÿ

è¿™ä¸ªä¾‹å­å¾ˆç®€å•ã€‚æˆ‘ä»¬ä¹‹é—´çš„å…³ç³»æ›´å¤æ‚ã€‚å‡è®¾æ‚¨çš„å¼‚æ­¥è½®è¯¢å’Œé‡è¯•é€»è¾‘(æˆ‘ä»¬è¯•å›¾é‡æ„çš„å†…å®¹)ä¾èµ–äº 4 ä¸ªå› ç´ :

*   æ‚¨å°†æœ‰ 4 å±‚åµŒå¥—çš„ä¸Šä¸‹æ–‡ï¼Œå°†æ¯ä¸ªå…ƒç´ æè¿°ä¸ºæ•´ä¸ªåœºæ™¯çš„ä¸€éƒ¨åˆ†ï¼›
*   æ¯ä¸ªä¸Šä¸‹æ–‡å¯ä»¥é€‰æ‹©ä¸åŒçš„é»˜è®¤æƒ…å†µï¼Œè€Œä¸æ˜¯åº”è¯¥åœ¨å†…éƒ¨ä¸Šä¸‹æ–‡ä¸­è¦†ç›–å“ªäº›æƒ…å†µã€‚

å¦‚æ‚¨æ‰€è§ï¼Œè¿™å¾ˆå¿«å°±ä¼šå˜å¾—ä¸€å›¢ç³Ÿï¼Œå¹¶ä¸”å¾ˆéš¾é‡æ„ã€‚

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç»å…¸çš„å¹³é¢æµ‹è¯•ç»“æ„ï¼Œæˆ‘ä»¬ä¼šåœ¨æµ‹è¯•å¥—ä»¶ä¸­æœ‰ä¸€ç‚¹é‡å¤ï¼Œä½†æ˜¯å¹¶æ’æ¯”è¾ƒæµ‹è¯•å¥—ä»¶å¹¶é‡æ„å®ƒä»¬ä¼šå®¹æ˜“å¾—å¤šã€‚

è®©æˆ‘ç»™ä½ çœ‹ä¸€ä¸ªä¾‹å­:

```
describe("FetcherOne") {
    lateinit var asyncQueue: AsyncQueue
    lateinit var fetcher: FetcherOne

    val client = Client()

    beforeEachTest {
        asyncQueue = AsyncQueue()
        fetcher = FetcherOne(asyncQueue, client)
    }

    it("perform - calls client") {
        client.mockResponseStatus("accepted")

        fetcher.perform()

        assertThat(client.actions).contains("doStuff")
    }

    it("perform - triggers async polling job when accepted") {
        client.mockResponseStatus("accepted")

        fetcher.perform()

        assertThat(asyncQueue).contains(fetcher::pollStatus)
    }

    it("perform - does not trigger async job when successful") {
        client.mockResponseStatus("successful")

        fetcher.perform()

        assertThat(asyncQueue).isEmpty()
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¬¬äºŒä¸ªæµ‹è¯•å¥—ä»¶ç°åœ¨çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼(ä¸å€¼å¾—åœ¨è¿™é‡Œå±•ç¤ºï¼Œä½†æ˜¯å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œä½ å¯ä»¥[çœ‹åˆ°è¦ç‚¹](https://gist.github.com/waterlink/e26a4dc585b628d6eb6074b9383a209f))ã€‚

å¦‚æ‚¨æ‰€è§ï¼Œé‡æ„ä¸¤ä¸ªæµ‹è¯•å¥—ä»¶ä¹‹é—´çš„é‡å¤å‡ ä¹æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚

> ä½ æƒ³åœ¨ Kotlin ä¸­å­¦ä¹ æ›´å¤šå…³äºæµ‹è¯•å’Œ TDD çš„çŸ¥è¯†å—ï¼Ÿ
> 
> æˆ‘å·²ç»å†™äº†ä¸€ä¸ª 4 éƒ¨åˆ†(å…± 350 é¡µ)â€œ[ç»ˆææ•™ç¨‹:Kotlin](https://iwillteachyoukotlin.com) å…¥é—¨â€(+æ›´å¤šå³å°†åˆ°æ¥)ï¼Œä½ å¯ä»¥é€šè¿‡æˆä¸ºæˆ‘æ¯æœˆç®€è®¯çš„æˆå‘˜è·å¾—å…è´¹çš„å¥–é‡‘ã€‚
> 
> é™¤äº† Kotlinï¼Œå®ƒè¿˜æœ‰å¾ˆå¤šå¥½ä¸œè¥¿ï¼Œæ¯”å¦‚ TDDã€å¹²å‡€çš„ä»£ç ã€è½¯ä»¶æ¶æ„ã€ä¸šåŠ¡å½±å“ã€5 ä¸ªä¸ºä»€ä¹ˆã€éªŒæ”¶æ ‡å‡†ã€äººç‰©è§’è‰²ç­‰ç­‰ã€‚
> 
> â€”åœ¨è¿™é‡Œæ³¨å†Œï¼Œ[å¼€å§‹å­¦ä¹ å¦‚ä½•ä½¿ç”¨ TDD](https://iwillteachyoukotlin.com) æ„å»ºæˆç†Ÿçš„ Kotlin åº”ç”¨ç¨‹åºï¼

## [](#conclusion)ç»“è®º

ç°åœ¨ï¼Œæˆ‘ä¸æ˜¯æƒ³è®©ä½ ç›¸ä¿¡è¿™ç§æˆ–é‚£ç§é£æ ¼ã€‚æˆ‘åªæ˜¯æƒ³å‘Šè¯‰ä½ ï¼Œè¿™ä¸¤ç§é£æ ¼å„æœ‰ä¼˜ç¼ºç‚¹ã€‚

æ­£å¦‚æˆ‘ä»¬å·²ç»æ³¨æ„åˆ°çš„ï¼Œå³ä½¿æ˜¯é£æ ¼çš„åŠ›é‡ä¹Ÿå¯èƒ½ä¼šè®©ä½ æ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šã€‚æ‰€ä»¥è¦å°å¿ƒ:æƒåŠ›å¸¦æ¥è´£ä»»ã€‚

ä¸è¦è®©ä½ çš„å±‚æ¬¡æµ‹è¯•å¤ªå¤æ‚ï¼ŒåµŒå¥—å¤ªå¤šï¼

## [](#your-turn)è½®åˆ°ä½ äº†

å¦‚æœä½ å–œæ¬¢æˆ‘çš„æƒ³æ³•ï¼Œè€ƒè™‘ç»™è¿™ç¯‡æ–‡ç« å¾ˆå¤šå‘å±•çš„ååº”ğŸ˜Šè¯·åœ¨ä¸‹é¢çš„è¯„è®ºä¸­åˆ†äº«ä½ å¯¹è¿™ä¸¤ç§é£æ ¼çš„ä½“éªŒ:

ä½ è¿˜è®°å¾—å“ªäº›æ£˜æ‰‹çš„æµ‹è¯•æƒ…å†µï¼Ÿ

* * *

åŸè½½äº [HackerNoon](https://hackernoon.com/how-can-hierarchical-test-structure-absolutely-make-a-mess-f72f47b5bf57)
å›¾ç‰‡æ¥æº: [pexels](https://www.pexels.com/photo/abstract-close-up-cobweb-connection-276502/)