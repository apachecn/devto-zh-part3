# ä½¿ç”¨å¸¦æœ‰ Azure åŠŸèƒ½çš„å®ä½“æ¡†æ¶

> åŸæ–‡:[https://dev . to/azure/using-entity-framework-with-azure-functions-50aa](https://dev.to/azure/using-entity-framework-with-azure-functions-50aa)

<< Update: The instructions below are still good but I did update my sample to use .NET Core 3.1 here if interested: [https://github.com/jeffhollan/functions-chsarp-entitycore-3](https://github.com/jeffhollan/functions-chsarp-entitycore-3)>T3ã€‘

ä»Šå¹´ Build ä»¤äººå…´å¥‹çš„å‘å±•ä¹‹ä¸€æ˜¯åœ¨ Azure å‡½æ•°ä¸­æ”¯æŒ[ä¾èµ–æ³¨å…¥](https://aka.ms/functions-di-docs)ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥æ³¨å†Œå¹¶ä½¿ç”¨è‡ªå·±çš„æœåŠ¡ä½œä¸ºåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ã€‚è™½ç„¶æ‚¨è¿‡å»å·²ç»èƒ½å¤Ÿä½¿ç”¨ Entity Framework Coreï¼Œä½†æ˜¯ä¸ä¾èµ–æ³¨å…¥çš„ç»“åˆä½¿å¾—å®ƒæ›´åŠ é€‚åˆã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„ Azure å‡½æ•°ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å®ä½“æ¡†æ¶æ ¸å¿ƒä¸æœ‰çŠ¶æ€æ•°æ®è¿›è¡Œäº¤äº’ã€‚æˆ‘å°†åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„ APIï¼Œå®ƒå¯ä»¥åœ¨ Azure SQL æ•°æ®åº“ä¸­è·å–å’Œè®¾ç½®åšå®¢æ•°æ®ã€‚

## [](#adding-entity-framework-to-a-function-project)å‘åŠŸèƒ½é¡¹ç›®æ·»åŠ å®ä½“æ¡†æ¶

é¦–å…ˆï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„ v2ã€‚NET Core 2) Azure Functions é¡¹ç›®ã€‚æˆ‘é€‰æ‹©äº† HTTP è§¦å‘å™¨æ¨¡æ¿ä½œä¸ºå¼€å§‹ã€‚ä¸ºäº†ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæˆ‘éœ€è¦éªŒè¯ä¸¤ä»¶äº‹:

1.  `Microsoft.NET.Sdk.Functions`è‡³å°‘æ˜¯`1.0.28`
2.  å®‰è£…`Microsoft.Azure.Functions.Extensions`åŒ…æ¥æä¾›ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„ API

```
Update-Package  Microsoft.NET.Sdk.Functions  Install-Package  Microsoft.Azure.Functions.Extensions 
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®‰è£…å®ä½“æ¡†æ¶åº“ã€‚âš ï¸:è¿™äº›ç‰ˆæœ¬éå¸¸ç‰¹åˆ«ã€‚ä½ å°†è¿è¡Œçš„ç½‘ç»œã€‚å› æ­¤ï¼Œè¯·æ…é‡é€‰æ‹©æ‚¨çš„åº“ç‰ˆæœ¬ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œè¿™ä¸ª Azure æ­£åœ¨è¿è¡Œã€‚NET Core 2.2.3ï¼Œè¿™å°±æ˜¯æˆ‘è¦ç”¨çš„ã€‚

```
Install-Package  Microsoft.EntityFrameworkCore.SqlServer  -Version  2.2.3 
```

æˆ‘è¿˜æƒ³åˆ©ç”¨è®¾è®¡æ—¶è¿ç§»ï¼Œæ‰€ä»¥æˆ‘å°†å®‰è£…é©±åŠ¨å®ƒæ‰€éœ€çš„å·¥å…·ã€‚

```
Install-Package  Microsoft.EntityFrameworkCore.Design  -Version  2.2.3  Install-Package  Microsoft.EntityFrameworkCore.Tools  -Version  2.2.3 
```

### [](#add-the-entity-models)æ·»åŠ å®ä½“æ¨¡å‹

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä¸ºæˆ‘æƒ³è¦ä¸ä¹‹äº¤äº’çš„æ•°æ®æ¨¡å‹åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„`DbContext`ã€‚è®©æˆ‘ä»¬åªå…³æ³¨ç®€å•çš„åšå®¢å’Œå¸–å­å®ä½“ã€‚

```
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Text;

namespace functions_csharp_entityframeworkcore
{
    public class BloggingContext : DbContext
    {
        public BloggingContext(DbContextOptions<BloggingContext> options)
            : base(options)
        { }

        public DbSet<Blog> Blogs { get; set; }
        public DbSet<Post> Posts { get; set; }
    }

    public class Blog
    {
        public int BlogId { get; set; }
        public string Url { get; set; }

        public ICollection<Post> Posts { get; set; }
    }

    public class Post
    {
        public int PostId { get; set; }
        public string Title { get; set; }
        public string Content { get; set; }

        public int BlogId { get; set; }
        public Blog Blog { get; set; }
    }
} 
```

### [](#write-the-function-code-to-inject-the-entity-context)ç¼–å†™å‡½æ•°ä»£ç æ³¨å…¥å®ä½“ä¸Šä¸‹æ–‡

æˆ‘éœ€è¦éªŒè¯æˆ‘åœ¨å‡½æ•°ç±»ä¸­ä½¿ç”¨äº†æ„é€ å‡½æ•°ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥æ³¨å…¥æ­£ç¡®çš„ä¾èµ–é¡¹(åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯å®ä½“æ¡†æ¶ä¸Šä¸‹æ–‡)ã€‚è¿™æ„å‘³ç€å»æ‰ static å¹¶æ·»åŠ ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚æˆ‘è¿˜å°†ä¿®æ”¹æ„é€ å‡½æ•°æ¥æ¥å—ä¸Šé¢åˆ›å»ºçš„`BloggingContext`(å®ƒæœ¬èº«éœ€è¦æ³¨å…¥ä¸€ä¸ª`DbContextOptions<BloggingContext>`)ã€‚

```
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;

namespace functions_csharp_entityframeworkcore
{
    public class HttpTrigger
    {
        private readonly BloggingContext _context;
        public HttpTrigger(BloggingContext context)
        {
            _context = context;
        }

        [FunctionName("GetPosts")]
        public async Task<IActionResult> Get(
            [HttpTrigger(AuthorizationLevel.Function, "get", Route = "posts")] HttpRequest req,
            ILogger log)
        {
            log.LogInformation("C# HTTP trigger function processed a request.");

            // Code that returns posts - you can see this code by going
            // to the full sample linked at the bottom
            return new OkResult();
        }
    }
} 
```

ä¸ºäº†æ³¨å†Œç±»ä¼¼äº`BloggingContext`çš„æœåŠ¡ï¼Œæˆ‘åœ¨é¡¹ç›®ä¸­åˆ›å»ºäº†ä¸€ä¸ª`Startup.cs`æ–‡ä»¶ï¼Œå¹¶å®ç°äº†`FunctionsStartup`é…ç½®ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå±æ€§æ¥é€šçŸ¥å‡½æ•°ä¸»æœºï¼Œå®ƒå¯ä»¥åœ¨é‚£é‡Œè¿è¡Œæˆ‘çš„é…ç½®ã€‚

```
using Microsoft.Azure.Functions.Extensions.DependencyInjection;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using System;

[assembly: FunctionsStartup(typeof(functions_csharp_entityframeworkcore.Startup))]

namespace functions_csharp_entityframeworkcore
{
    class Startup : FunctionsStartup
    {
        public override void Configure(IFunctionsHostBuilder builder)
        {
            string SqlConnection = Environment.GetEnvironmentVariable("SqlConnectionString");
            builder.Services.AddDbContext<BloggingContext>(
                options => options.UseSqlServer(SqlConnection));
        }
    }
} 
```

### [](#enable-designtime-dbcontext-creation)å¯ç”¨è®¾è®¡æ—¶ DbContext åˆ›å»º

å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘æƒ³ä½¿ç”¨[è®¾è®¡æ—¶ DbContext åˆ›å»º](https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dbcontext-creation)ã€‚ç”±äºæˆ‘åœ¨è¿™é‡Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ ASP.NETï¼Œè€Œæ˜¯å®ç°äº† Azure Functions `Configure`æ–¹æ³•ï¼Œæ‰€ä»¥å®ä½“æ¡†æ¶ä¸ä¼šè‡ªåŠ¨å‘ç°æ‰€éœ€çš„`DbContext`ã€‚æ‰€ä»¥æˆ‘ä¼šç¡®ä¿å®ç°ä¸€ä¸ª`IDesignTimeDbContextFactory`æ¥é©±åŠ¨å·¥å…·ã€‚

```
public class BloggingContextFactory : IDesignTimeDbContextFactory<BloggingContext>
{
    public BloggingContext CreateDbContext(string[] args)
    {
        var optionsBuilder = new DbContextOptionsBuilder<BloggingContext>();
        optionsBuilder.UseSqlServer(Environment.GetEnvironmentVariable("SqlConnectionString"));

        return new BloggingContext(optionsBuilder.Options);
    }
} 
```

### [](#getting-the-project-dll-in-the-right-spot)è·å–é¡¹ç›®ã€‚dll æ”¾åœ¨æ­£ç¡®çš„ä½ç½®

æˆ‘è¿˜éœ€è¦åšæœ€åä¸€ä»¶äº‹ã€‚å½“æ‚¨æ„å»ºä¸€ä¸ª Azure Functions é¡¹ç›®æ—¶ï¼Œ`Microsoft.NET.Sdk.Functions`ä¼šå¯¹æ„å»ºå·¥ä»¶è¿›è¡Œä¸€äº›ç»„ç»‡ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆçš„åŠŸèƒ½é¡¹ç›®ç»“æ„ã€‚å…¶ä¸­ä¸€ä¸ªã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºè®¾è®¡æ—¶å·¥å…·ï¼Œå¦‚å®ä½“æ¡†æ¶è¿ç§»ï¼Œå®ƒæœŸæœ›ã€‚dll ä½äºç”Ÿæˆç›®æ ‡çš„æ ¹ä½ç½®ã€‚å› æ­¤ï¼Œä¸ºäº†ç¡®ä¿ä¸¤ä¸ªå·¥å…·éƒ½æ»¡æ„ï¼Œæˆ‘å°†æ·»åŠ ä¸€ä¸ªå¿«é€Ÿçš„åæœŸæ„å»ºäº‹ä»¶æ¥å¤åˆ¶ã€‚dll åˆ°æ ¹ç›®å½•ã€‚æˆ‘å°†è¿™ä¸ªæ·»åŠ åˆ°æˆ‘çš„é¡¹ç›®æ–‡ä»¶`.csproj`ä¸­ã€‚

```
<Target Name="PostBuild" AfterTargets="PostBuildEvent">
  <Exec Command="copy /Y &quot;$(TargetDir)bin\$(ProjectName).dll&quot; &quot;$(TargetDir)$(ProjectName).dll&quot;" />
</Target> 
```

## [](#adding-an-entity-framework-migration)æ·»åŠ å®ä½“æ¡†æ¶è¿ç§»

æˆ‘è¿›å…¥ Azure é—¨æˆ·ï¼Œåˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ Azure SQL æ•°æ®åº“ã€‚æˆ‘å°†è¿æ¥å­—ç¬¦ä¸²å¤åˆ¶åˆ°å¸¦æœ‰æ–°å€¼çš„`SqlConnectionString`æ–‡ä»¶ä¸­ã€‚æ‚¨å¯ä»¥åœ¨æˆ‘ä¹‹å‰çš„ä»£ç ç¤ºä¾‹ä¸­çœ‹åˆ°ï¼Œæˆ‘å°†å®ƒç”¨ä½œåŒ…å«è¿æ¥å­—ç¬¦ä¸²çš„ç¯å¢ƒå˜é‡ã€‚è¿™æ ·æˆ‘å°±ä¸å¿…å°†å®ƒç­¾å…¥æºä»£ç ç®¡ç†ğŸ¥½.

ä¸ºäº†ç¡®ä¿ CLI å·¥å…·ä¹Ÿå¯ä»¥ä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œè¿ç§»ï¼Œæˆ‘å°†æ‰“å¼€æˆ‘çš„åŒ…ç®¡ç†å™¨æ§åˆ¶å°ï¼Œå¹¶åœ¨æ·»åŠ è¿ç§»å’Œæ›´æ–°æ•°æ®åº“ä¹‹å‰è®¾ç½®ç¯å¢ƒå˜é‡ã€‚

```
$env:SqlConnectionString="Server=tcp:mySqlServerStuffxxx"  Add-Migration  InitialCreate  Update-Database 
```

å½“æµè§ˆ Azure é—¨æˆ·ä¸­çš„ SQL æ•°æ®åº“æ—¶ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°è¡¨è¢«æˆåŠŸåœ°åˆ›å»ºäº†ï¼

[![Post create tables create](../Images/74847ac712e1760382c1d0f5012fa68d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--E2bK_XNw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://i.imgur.com/PyDkh1p.png)

## [](#writing-the-function-app-and-publishing)ç¼–å†™åŠŸèƒ½ app å¹¶å‘å¸ƒ

é‚£æ˜¯æ‰€æœ‰çš„é‡æ´»ã€‚ç°åœ¨æˆ‘åªç¼–å†™äº†å‡ ä¸ªç®€å•çš„ HTTP è§¦å‘å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥è¿”å›æˆ‘æ³¨å…¥çš„`BloggerContext`å¹¶å‘å…¶ä¸­æ·»åŠ æ•°æ®ã€‚å½“è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘å¯ä»¥è°ƒç”¨ä¸åŒçš„`GET`å’Œ`PUT`æ–¹æ³•æ¥éªŒè¯æ•°æ®æ˜¯å¦è¢«æŒä¹…åŒ–å¹¶è¢«æ­£ç¡®è¿”å›ã€‚

å‘å¸ƒä¹‹åï¼Œæˆ‘åªè¦ç¡®ä¿ç”¨æˆ‘çš„ç”Ÿäº§ SQL è¿æ¥å­—ç¬¦ä¸²ä¸º`SqlConnectionString`è®¾ç½®åˆé€‚çš„åº”ç”¨ç¨‹åºè®¾ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å·¥ä½œäº†ï¼

ä½ å¯ä»¥åœ¨æˆ‘çš„ GitHub è´¦æˆ·ä¸Šçœ‹åˆ°å®Œæ•´çš„é¡¹ç›®ä»£ç 