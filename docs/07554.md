# åœ¨å¯ç”¨æ€§ç»„ä¸­é…ç½®åˆ†å‘æ•°æ®åº“

> åŸæ–‡:[https://dev . to/am2/configuring-the-distribution-database-in-an-avail ability-group-56pn](https://dev.to/am2/configuring-the-distribution-database-in-an-availability-group-56pn)

<figure>[![](../Images/9f5ff9737b0b73928a7e7bbd1c2e1938.png)](https://www.youtube.com/watch?v=5qSrmeiWsuc) 

<figcaption id="caption-attachment-1749">æˆ‘ğŸ’œå¤åˆ¶</figcaption>

</figure>

ä» SQL Server 2017 CU6 å’Œ SQL Server 2016 SP2-CU3 å¼€å§‹ï¼Œæ‚¨ç°åœ¨å¯ä»¥å°†åˆ†å‘æ•°æ®åº“é…ç½®ä¸ºå¯ç”¨æ€§ç»„(AG)çš„ä¸€éƒ¨åˆ†ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨çš„åˆ†å‘æ•°æ®åº“åªèƒ½æ˜¯ç‹¬ç«‹å®ä¾‹æˆ–æ•…éšœè½¬ç§»ç¾¤é›†å®ä¾‹(FCI)çš„ä¸€éƒ¨åˆ†ã€‚åœ¨è¿™ç¬¬ä¸€è½®ä¸­ï¼Œæœ‰ä¸€ä¸ªç›¸å½“å¤§çš„é™åˆ¶åˆ—è¡¨[&é™åˆ¶](https://docs.microsoft.com/en-us/sql/relational-databases/replication/configure-distribution-availability-group)ã€‚äº‹å®ä¸Šï¼Œæ‚¨ä¼šæ³¨æ„åˆ°â€œæ”¯æŒçš„åœºæ™¯â€åˆ—è¡¨æ¯”â€œé™åˆ¶æˆ–æ’é™¤â€åˆ—è¡¨è¦çŸ­

## [](#but-i-ran-into-a-problem)ä½†æ˜¯æˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜

æ˜¾ç„¶æˆ‘æœ‰é—®é¢˜ã€‚æˆ‘æ‰€æœ‰çš„åšå®¢å¸–å­éƒ½æ˜¯å› ä¸ºæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ã€‚é™¤äº†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€åˆ‡éƒ½å¾ˆå¥½â€¦æˆ‘åªæ˜¯ä¸æ˜ç™½ä¸ºä»€ä¹ˆã€‚

å›´ç»•å¤åˆ¶çš„å·¥å…·/å›¾å½¢ç”¨æˆ·ç•Œé¢å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„ã€‚è¿™æ„å‘³ç€æˆ‘æ¯éš”ä¸€æ®µæ—¶é—´å°±è¦é’»ç ”å‘è¡Œç‰ˆæ•°æ®åº“æ¥ç›´æ¥æŸ¥è¯¢å®ƒã€‚æœ‰æ—¶ï¼Œæˆ‘ä¼šè¿è¡Œè¿™æ ·çš„æŸ¥è¯¢æ¥è·å–å‡ºç‰ˆå•†åˆ—è¡¨:

```
SELECT  ServerID            = s.server_id, 
        ServerName          = s.name,
        p.*
FROM dbo.MSpublications AS p
JOIN sys.servers AS s ON s.server_id = p.publisher_id; 
```

è¿™ä¸€ç›´éå¸¸æœ‰æ•ˆï¼Œå¤šå¹´æ¥ä¸€ç›´æ˜¯æˆ‘çš„é¦–é€‰æŸ¥è¯¢ã€‚ä½†æ˜¯ï¼Œå½“åœ¨å¯ç”¨æ€§ç»„ä¸­æŸ¥çœ‹å…·æœ‰åˆ†å‘æ•°æ®åº“çš„ SQL Server 2017 åˆ†å‘æœåŠ¡å™¨æ—¶ï¼Œè¿™å¹¶ä¸å¥æ•ˆã€‚æ‰€æœ‰çš„å‡ºç‰ˆç‰©éƒ½æœ‰ä¸€ä¸ª 1 çš„`publisher_id`ï¼Œä½†æ˜¯åœ¨`sys.servers`ï¼Œ`server_id` 1 æ˜¯ä¸€ä¸ªéšæœºé“¾æ¥çš„æœåŠ¡å™¨ï¼Œç»å¯¹ä¸æ˜¯å‡ºç‰ˆå•†ã€‚ä½†æ˜¯å¤åˆ¶æ•ˆæœå¾ˆå¥½ã€‚å¯èƒ½å¤åˆ¶æ˜¯åœ¨å¦ä¸€ä¸ª AG å‰¯æœ¬ä¸Šè®¾ç½®çš„ï¼Œ`server_id` 1 å°±æ˜¯ä»é‚£é‡Œæ¥çš„ã€‚

æ²¡æœ‰ã€‚åœ¨å¦ä¸€ä¸ªå¤åˆ¶å“ä¸Šï¼Œæƒ…å†µæ˜¯ä¸€æ ·çš„ã€‚1 æ˜¯ä¸€ä¸ªéšæœºé“¾æ¥çš„æœåŠ¡å™¨ï¼Œä¸å¤åˆ¶å®Œå…¨æ— å…³ï¼Œæ›´ä¸ç”¨è¯´å‘å¸ƒè€…äº†ã€‚ä½†æ˜¯å¤åˆ¶å·¥ä½œéå¸¸å®Œç¾ã€‚ä¸€ä¸ªåœ¨ dev ä¸­æ‘†å¼„å®ƒçš„é˜Ÿå‹è¯å®ï¼Œå¦‚æœä»–æ›´æ–°äº†`publisher_id`æ¥åŒ¹é…æˆ‘ä»¬*è®¤ä¸º*åº”è¯¥åŠ å…¥çš„`server_id`ï¼Œå¤åˆ¶å°±ä¼šåœæ­¢å·¥ä½œã€‚æ‰€ä»¥ï¼Œ1 çš„`publisher_id`æ˜¯æ­£ç¡®çš„ã€‚æˆ–è€…ç‰¹åˆ«ã€‚ä½†ä¹Ÿè‚¯å®šä¸åŒäºæˆ‘åœ¨ SQL Server çš„æ—©æœŸç‰ˆæœ¬ä¸­çœ‹åˆ°çš„ã€‚

## [](#it-makes-sense-really)å¾ˆæœ‰é“ç†ï¼ŒçœŸçš„

æˆ‘æƒ³äº†æƒ³ï¼Œå‘è¡Œç‰ˆæ•°æ®åº“åœ¨ AG ä¸­ä¸èƒ½åŸºäº ID å€¼ç›´æ¥è¿æ¥åˆ°`sys.servers`,è¿™æ˜¯æœ‰é“ç†çš„ã€‚ä¸åŒçš„å‰¯æœ¬å¯èƒ½å…·æœ‰é¢„å…ˆå­˜åœ¨çš„é“¾æ¥æœåŠ¡å™¨ï¼Œå› æ­¤ä¸å¯èƒ½åœ¨æ‰€æœ‰åˆ†å‘æœåŠ¡å™¨å‰¯æœ¬ä¹‹é—´ä¿æŒ server_id åŒæ­¥ã€‚å¦‚æœä»…ä»…ä¾é æœåŠ¡å™¨åï¼Œé‚£å°±æ›´æœ‰æ„ä¹‰äº†ã€‚ä½†æ˜¯â€¦â€¦äº‹æƒ…ä¸æ˜¯è¿™æ ·çš„ã€‚è€Œ`dbo.MSpublications`å¹¶ä¸åŒ…å«æœåŠ¡å™¨åï¼Œå®ƒåªæ˜¯å¾—åˆ°äº†é‚£ä¸ªè¯¥æ­»çš„ ID å€¼ã€‚æ‰€ä»¥ï¼Œä¹Ÿè®¸åœ¨å‘è¡Œç‰ˆæ•°æ®åº“ä¸­æœ‰ä¸€ä¸ªè¡¨ï¼Œå®ƒä½¿ç”¨è¿™ä¸ªè¡¨æ¥ä»£æ›¿`sys.servers`ã€‚æœç„¶ï¼Œå®ƒå°±åœ¨é‚£é‡Œï¼Œè—åœ¨ä¼—ç›®ç½ç½ä¹‹ä¸‹:`dbo.MSreplservers`ã€‚æˆ‘åªéœ€è¦åœ¨`dbo.MSpublications`å’Œ`sys.servers`ä¹‹é—´æ·»åŠ ä¸€ä¸ªè¿æ¥ã€‚

```
SELECT  master_ServerID     = s.server_id, 
        master_ServerName   = s.name,
        dist_ServerID       = rs.srvid,
        dist_ServerName     = rs.srvname,
        p.*
FROM dbo.MSpublications AS p
JOIN dbo.MSreplservers AS rs ON rs.srvid = p.publisher_id
JOIN sys.servers AS s ON s.name = rs.srvname; 
```

äº‹åçœ‹æ¥ï¼Œè¿™å®é™…ä¸Šæ¯”æˆ‘è¿‡å»å†™çš„ä»£ç æ›´æœ‰æ„ä¹‰ã€‚å¯¹äºåŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œ`dbo.MSreplservers`ä¸­çš„`srvid`ä¸`sys.servers`ä¸­çš„`server_id`ä¸åŒï¼Œè¿™æœ‰ç‚¹ä»¤äººå›°æƒ‘ã€‚ä½†æ˜¯â€¦â€¦è¿™å°±æ˜¯ç”Ÿæ´»ã€‚AGs è®©ä¸€åˆ‡å˜å¾—æ›´å¤æ‚äº†ã€‚

åœ¨å¯ç”¨æ€§ç»„ä¸­é…ç½®åˆ†å¸ƒæ•°æ®åº“çš„å¸–å­[æœ€æ—©å‡ºç°åœ¨](https://am2.co/2019/04/configuring-the-distribution-database-in-an-availability-group/) [Andy M Mallon - AM](https://am2.co) ä¸Šã€‚