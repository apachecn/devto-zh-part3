# å°† Brotli æ·»åŠ åˆ°å·²ç»æ„å»ºçš„ NGINX å®ä¾‹ä¸­

> åŸæ–‡:[https://dev . to/majal/adding-brot Li-to-a-an-always-build-nginx-instance-1bje](https://dev.to/majal/adding-brotli-to-an-already-built-nginx-instance-1bje)

ä½ æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ NGINX å®ä¾‹ï¼Œå¹¶ä¸”æƒ³è¦æ·»åŠ  Brotli å‹ç¼©å—ï¼Ÿå¦‚æœæ‚¨ä¸æƒ³ä»æºä»£ç é‡æ–°ç¼–è¯‘ä¸€ä¸ªå®šåˆ¶çš„ web æœåŠ¡å™¨æˆ–è€…æ›¿æ¢æ‚¨çš„è‡ªåŠ¨æ›´æ–° repo-installed ç‰ˆæœ¬ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿä½ å¯ä»¥åˆ›å»ºåŠ¨æ€çš„ Brotli æ¨¡å—ï¼Œåªè¦ NGINX å‡çº§ï¼Œå®ƒå°±ä¼šå‡çº§ã€‚

ä¸‹é¢çš„ bash è„šæœ¬è§£é‡Šäº†å®‰è£…æ­¥éª¤ã€‚è¯·éšæ„ä¸€æ­¥ä¸€æ­¥åœ°å­¦ä¹ å’Œæ‰§è¡Œè¿™äº›ä»£ç ã€‚è¿™å¯èƒ½æœ‰åŠ©äºæ‚¨æ’é™¤ç³»ç»Ÿä¸­çš„ä»»ä½•å¼‚å¸¸ã€‚å¦åˆ™ï¼Œåªéœ€è¿è¡Œè„šæœ¬ã€‚

```
#!/bin/bash

# https://www.majlovesreg.one/tag/code/
# https://www.majlovesreg.one/adding-brotli-to-a-built-nginx-instance
# https://github.com/majal/maj-server/tree/master/nginx-modules-brotli

# Install needed development packages if not yet installed in the system
# sudo apt -y install git libpcre3 libpcre3-dev zlib1g zlib1g-dev openssl libssl-dev

# For predefined NGINX version, use:
# ngver=1.17.1

# For passing the version via the command line (i.e.: user@server:~$ ./mkbrotli 1.17.1), use:
ngver=$1

# For automated detection of currently installed NGINX version (not to be used for auto-updating, see hooks in post), use:
# ngver=$(nginx -v 2>&1 | grep -o '[0-9\.]*')

# Get configure parameters of installed NGINX. Not needed if NGINX was configured '--with-compat'.
# Uncomment one of the lines below if the script sucessfully builds modules but NGINX throws a "not binary compatible" error.
# confparams=$(nginx -V 2>&1 | grep -o -- '--prefix='.*)
# confparams=$(nginx -V 2>&1 | grep -o -- '--[^with]'.*)
# confparams=$(nginx -V 2>&1 | grep -- '--' | sed "s/.*' //")

# To manually set NGINX modules directory:
# moddir=/path/to/modules/directory

# To automatically select NGINX modules directory:
[ -d /usr/share/nginx/modules ] && moddir=/usr/share/nginx/modules
[ -d $(nginx -V 2>&1 | grep -o 'prefix=[^ ]*' | sed 's/prefix=//')/modules ] && moddir="$(nginx -V 2>&1 | grep -o 'prefix=[^ ]*' | sed 's/prefix=//')/modules"
[ -d $(nginx -V 2>&1 | grep -o 'modules-path=[^ ]*' | sed 's/modules-path=//') ] && moddir="$(nginx -V 2>&1 | grep -o 'modules-path=[^ ]*' | sed 's/modules-path=//')"
[ "${moddir}" ] || { echo '!! missing modules directory, exiting...'; exit 1; }

# Set temporary directory and build on it
builddir="$(mktemp -d)"
cd "${builddir}"

echo
echo '################################################################################'
echo
echo "Building Brotli for NGINX ${ngver}"
echo "Temporary build directory: ${builddir}"
echo "Modules directory: ${moddir}"
echo

# Download and unpack NGINX
wget https://nginx.org/download/nginx-${ngver}.tar.gz && { tar zxf nginx-${ngver}.tar.gz && rm nginx-${ngver}.tar.gz; } || { echo '!! download failed, exiting...'; exit 2; }

# Download, initialize, and make Brotli dynamic modules
git clone https://github.com/google/ngx_brotli.git
cd ngx_brotli && git submodule update --init && cd ../nginx-${ngver}
[ "${confparams}" ] && nice -n 19 ionice -c 3 ./configure --add-dynamic-module=../ngx_brotli "${confparams}" || nice -n 19 ionice -c 3 ./configure --with-compat --add-dynamic-module=../ngx_brotli
nice -n 19 ionice -c 3 make modules || { echo '!! configure or make failed, exiting...'; exit 4; }

# Replace Brotli in modules directory
[ -f "${moddir}/ngx_http_brotli_filter_module.so" ] && sudo mv "${moddir}/ngx_http_brotli_filter_module.so" "${moddir}/ngx_http_brotli_filter_module.so.old"
[ -f "${moddir}/ngx_http_brotli_static_module.so" ] && sudo mv "${moddir}/ngx_http_brotli_static_module.so" "${moddir}/ngx_http_brotli_static_module.so.old"
sudo cp objs/*.so "${moddir}/"
sudo chmod 644 "${moddir}/ngx_http_brotli_filter_module.so" || { echo '!! module permissions failed, exiting...'; exit 5; }
sudo chmod 644 "${moddir}/ngx_http_brotli_static_module.so" || { echo '!! module permissions failed, exiting...'; exit 6; }

# Clean up build files
cd "${builddir}/.."
sudo rm -r "${builddir}/ngx_brotli"
rm -r "${builddir}"

echo
echo "Sucessfully built and installed latest Brotli for NGINX ${ngver}"
echo "Modules can be found in ${moddir}"
echo "Next step: Configure dynamic modules and reload/restart NGINX."
echo
echo '################################################################################'
echo

# Start/restart NGINX.
# Not recommended if script is hooked since NGINX is automatically restarted by the package manager (e.g. apt) after an upgrade.
# Restarting NGINX before the upgrade could cause a module version mismatch.
# sudo nginx -t && { systemctl is-active nginx && sudo systemctl restart nginx || sudo systemctl start nginx; } || true
# echo
# systemctl --no-pager status nginx
# echo 
```

æ‚¨å¯ä»¥é€‰æ‹©é€šè¿‡è¿è¡Œä¸Šé¢çš„è„šæœ¬æ¥è‡ªåŠ¨å®‰è£…ã€‚åœ¨å…¶é»˜è®¤è®¾ç½®ä¸­ï¼Œå®ƒå°†å¤„ç†æ‚¨ä¼ é€’ç»™å®ƒçš„ç‰ˆæœ¬å·ã€‚è¦è·å¾—ä½ çš„ **NGINX çš„ç‰ˆæœ¬å·**ï¼Œè¿è¡Œè¿™ä¸ªå‘½ä»¤:

```
$ nginx -v
  nginx version: nginx/1.17.1 
```

ç”±äºæœ¬ä¾‹ä¸­çš„**ç‰ˆæœ¬**æ˜¯ 1.17.1ï¼Œåœ¨æ‚¨ä¸‹è½½äº†ä¸Šé¢çš„ bash è„šæœ¬ä¹‹åï¼Œè½¬åˆ°è„šæœ¬æ‰€åœ¨çš„ç›®å½•å¹¶è¿è¡Œè¿™äº›å‘½ä»¤:

```
$ chmod +x mkbrotli
$ ./mkbrotli 1.17.1 
```

ç°åœ¨ï¼Œå½“è„šæœ¬è‡ªåŠ¨ä¸ºæ‚¨ä¸‹è½½ã€æ„å»ºå’Œå®‰è£…åŠ¨æ€æ¨¡å—æ—¶ï¼Œæ‚¨å¯ä»¥æ”¾æ¾äº†ã€‚å¦‚æœè„šæœ¬å‡ºç°é”™è¯¯ï¼Œè¯·åœ¨è¯„è®ºä¸­è®©æˆ‘çŸ¥é“ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥å¯¹å®ƒè¿›è¡Œè°ƒæ•´ã€‚

### [](#activating-the-modules)

<center>æ¿€æ´»æ¨¡å—</center>

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ¨¡å—ï¼Œæ¿€æ´» Brotli å‹ç¼©éœ€è¦ä¸¤ä¸ªé…ç½®æ­¥éª¤ã€‚é¦–å…ˆï¼Œ**åŠ è½½ NGINX ä¸»é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å—**(æˆ‘çš„åœ¨`/etc/nginx/nginx.conf`)ã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤
è·å¾—æ‚¨çš„**é…ç½®æ–‡ä»¶è·¯å¾„**

```
$ nginx -V 2>&1 | grep -o 'conf-path=[^ ]*' | sed 's/conf-path=//' 
```

ç°åœ¨ç¼–è¾‘ NGINX çš„é…ç½®æ–‡ä»¶ã€‚åœ¨ä»»ä½• *`block { ... }`* ä¹‹å¤–ï¼Œä¹Ÿè®¸åœ¨æ–‡ä»¶çš„æœ€ä¸Šé¢ä¸€èŠ‚ï¼ŒåŠ ä¸Šè¿™å‡ è¡Œ:

```
# nginx/nginx.conf

load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

# http {
#   ...
# } 
```

ç¬¬äºŒï¼Œ**æ¿€æ´» Brotli** (å¹¶è®¾ç½®å…¶[é…ç½®æŒ‡ä»¤ï¼Œåˆåè®¾ç½®](https://github.com/google/ngx_brotli))æˆ–è€…åœ¨ NGINX çš„ conf æ–‡ä»¶çš„`http`å—ä¸­ï¼Œæˆ–è€…åœ¨ä½ çš„åŸŸé…ç½®çš„`server`å—ä¸­(ä¾‹å¦‚`nginx/sites-enabled/`ä¸­çš„æ–‡ä»¶)ã€‚è‡³äºæˆ‘ï¼Œæˆ‘æŠŠè¿™äº›æŒ‡ä»¤æ”¾åœ¨`nginx/snippets/`æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åœ¨æˆ‘çš„åŸŸé…ç½®ä¸­é€šè¿‡`include`è°ƒç”¨å®ƒä»¬ã€‚

```
# nginx/nginx.conf

# http {
#   ...

  brotli on;
  brotli_static on;
  brotli_types
    text/plain
    text/css
    text/xml
    text/javascript
    text/x-component
    application/xml
    application/xml+rss
    application/javascript
    application/json
    application/atom+xml
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-font-opentype
    application/x-font-truetype
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/octet-stream
    font/opentype
    font/truetype
    font/eot
    font/otf
    image/svg+xml
    image/x-icon
    image/vnd.microsoft.icon
    image/bmp;

#   ...
# } 
```

### [](#autoupdate-with-nginx)

<center>ç”¨ NGINX è‡ªåŠ¨æ›´æ–°</center>

åŠ¨æ€æ¨¡å—çš„ä¸€ä¸ªæ½œåœ¨é—®é¢˜æ˜¯å½“ NGINX é€šè¿‡ä¸€ä¸ªåŒ…ç®¡ç†å™¨(ä¾‹å¦‚`apt`ã€`yum`æˆ–`pacman`)è‡ªåŠ¨å‡çº§æ—¶ã€‚å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œæˆ‘çš„æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å‡çº§éƒ½æ˜¯ç”±è„šæœ¬è‡ªåŠ¨å®Œæˆçš„ã€‚ä½ çœ‹ï¼ŒåŠ¨æ€æ¨¡å—æ˜¯ç‰¹å®šäºç‰ˆæœ¬çš„ã€‚NGINX è¢«è®¾ç½®ä¸º**è€Œä¸æ˜¯**æ¥åŠ è½½ä¸ºä¸åŒç‰ˆæœ¬æ„å»ºçš„æ¨¡å—ã€‚é‚£ä¹ˆ Brotli æ¨¡å—**å¦‚ä½•å’Œ NGINX ä¸€èµ·è‡ªåŠ¨å‡çº§**ï¼Ÿ

ç­”æ¡ˆæ˜¯åœ¨å‡çº§è¿‡ç¨‹ä¸­æŒ‚æ¥è½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚åœ¨`apt`ä¸­ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªä¸¤æ­¥æˆ–ä¸‰æ­¥çš„è¿‡ç¨‹:

1.  **å°†**ä¸`apt`æŒ‚é’©ï¼Œè°ƒç”¨ä¸€ä¸ªå·¥äººè„šæœ¬ã€‚(æˆ–è€…ï¼Œé’©å­å¯ä»¥ç›´æ¥è°ƒç”¨`mkbrotli`,è¿™æ ·å°±ä¸éœ€è¦å·¥äººè„šæœ¬äº†ã€‚)

2.  **worker** è„šæœ¬è°ƒç”¨ä¸€ä¸ªæˆ–å¤šä¸ªæ„å»ºè„šæœ¬æ¥æ›´æ–°åŠ¨æ€æ¨¡å—ã€‚

3.  **æ„å»ºè„šæœ¬**å°†åœ¨ NGINX å‡çº§ä¹‹å‰æ„å»ºå¹¶å®‰è£…æ–°æ¨¡å—ã€‚

è¿™é‡Œæ˜¯æˆ‘çš„**é’©å­æ–‡ä»¶**åœ¨`/etc/apt/apt.conf.d/` :

```
# /etc/apt/apt.conf.d/05nginxmodules

// Hook to build and install dynamic modules before NGINX upgrades
// Script calls individual build scripts and passes back error codes
// Place this file in /etc/apt/apt.conf.d/

DPkg::Pre-Install-Pkgs {"/usr/local/sbin/nginx-mod-preinstall";}; 
```

æˆ‘ä½¿ç”¨çš„å·¥äººè„šæœ¬:

```
# /usr/local/sbin/nginx-mod-preinstall

#!/bin/bash
# Call NGINX module build scripts and pass error codes to apt hook

# Get NGINX version to upgrade to
read ngfile < <(grep '/nginx_') || exit 0
ngver=$(echo $ngfile | sed 's/-.*//' | sed 's/.*_//')

# List of build scripts to run:
/usr/local/sbin/mkbrotli $ngver || exit $?
# /usr/local/sbin/mkmodsec $ngver || exit $?
# /usr/local/sbin/mkpagespeed $ngver || exit $? 
```

æœ€åï¼Œè¿™éƒ¨ç”µå½±çš„**æ„å»ºè„šæœ¬**æ˜¯â€¦â€¦(è¯·å‡»é¼“)â€¦â€¦å½“ç„¶æ˜¯`mkbrotli`ã€‚ğŸ˜‰æˆ‘å¸Œæœ› Brotli åœ¨æœªæ¥èƒ½å¤Ÿå¾—åˆ° NGINX çš„åŸç”Ÿæ”¯æŒã€‚å¤ªç‰›é€¼äº†ã€‚ç›®å‰ï¼Œæˆ‘ä»¬æœ‰è¿™ä¸ªè§£å†³æ–¹æ³•ã€‚äº«å—å‹ç¼©ï¼

### [](#google-pagespeed)

<center>è°·æ­Œé¡µé¢é€Ÿåº¦</center>

å¦ä¸€ä¸ªæ—¨åœ¨åŠ å¿«ç½‘ç»œé€Ÿåº¦çš„é¡¹ç›®æ˜¯è°·æ­Œçš„æœ€ä½³å®è·µä¼˜åŒ–ï¼Œåä¸º [PageSpeed](https://developers.google.com/speed/pagespeed/module/) ã€‚æˆ‘è¿˜åˆ¶ä½œäº†ä¸€ä¸ª Bash è„šæœ¬ï¼Œç”¨äºåœ¨æ­£åœ¨è¿è¡Œçš„ NGINX æœåŠ¡å™¨ä¸Šè‡ªåŠ¨å®‰è£… PageSpeedã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œçœ‹çœ‹è¿™ç¯‡æ–‡ç« :[ä¸ºå·²ç»è¿è¡Œçš„ NGINX å®ä¾‹](https://www.majlovesreg.one/adding-pagespeed-to-a-running-nginx-instance)æ·»åŠ  PageSpeedã€‚

å°† Brotli æ·»åŠ åˆ°å·²ç»æ„å»ºå¥½çš„ NGINX å®ä¾‹ä¸­é¦–å…ˆå‡ºç°åœ¨ [Maj Loves Reg](https://www.majlovesreg.one) ä¸Šï¼Œç”± [Majal Mirasol](https://www.majlovesreg.one/author/majal) å‘å¸ƒã€‚