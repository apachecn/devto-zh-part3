# æˆ¿é—´+rx Javaâ€”â€”ç®€å•çš„æ•°æ®åº“è§‚å¯Ÿè€…

> åŸæ–‡:[https://dev . to/rduriancik/room-rx Java-simple-database-observer-4 hki](https://dev.to/rduriancik/room-rxjava-simple-database-observer-4hki)

æœ€è¿‘æˆ‘åœ¨åšä¸€ä¸ªé¡¹ç›®ï¼Œéœ€è¦æ ¹æ®æœ¬åœ°æ•°æ®åº“ä¸­çš„æ•°æ®å®æ—¶æ›´æ–° android åº”ç”¨ geofencesã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªé¡¹ç›®è¢«æ·»åŠ åˆ°æ•°æ®åº“ä¸­ï¼Œæˆ‘å¿…é¡»ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªåœ°ç†å›´æ ï¼Œæˆ–è€…å¦‚æœé¡¹ç›®è¢«ç§»é™¤ï¼Œåˆ™ç§»é™¤åœ°ç†å›´æ ã€‚

ä¸ºäº†å»ºç«‹æ•°æ®åº“ï¼Œæˆ‘å†³å®šä½¿ç”¨ [Room persistence åº“](https://developer.android.com/topic/libraries/architecture/room)å¹¶åˆ©ç”¨ [RxJava](https://github.com/ReactiveX/RxJava) ï¼Œå› ä¸ºå®ƒå·²ç»æ˜¯é¡¹ç›®çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ã€‚Room åœ¨ SQLite ä¸Šæä¾›äº†ä¸€ä¸ªéå¸¸å¥½çš„æŠ½è±¡å±‚ï¼Œå¾ˆå®¹æ˜“è®¾ç½®ï¼Œåœ¨ RxJava çš„å¸®åŠ©ä¸‹ï¼Œå®ƒå…è®¸å¼‚æ­¥è§‚å¯Ÿæ•°æ®ã€‚åœ¨è¿™ç¯‡ç²¾å½©çš„[æ–‡ç« ](https://medium.com/androiddevelopers/room-rxjava-acb0cd4f3757)ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°æ›´å¤šå…³äºå¦‚ä½•ä½¿ç”¨ RxJava è¿›è¡ŒæŸ¥è¯¢çš„ä¿¡æ¯ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è§‚å¯ŸæœåŠ¡ä¸­çš„æ•°æ®åº“ã€‚æˆ‘å‘ç°ï¼ŒRoom è®©æˆ‘å®æ—¶è§‚å¯Ÿæ‰€æœ‰æ•°æ®çš„å”¯ä¸€æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢ï¼Œåœ¨æ¯æ¬¡å‘ç”Ÿæ›´æ”¹æ—¶è¿”å›æ•°æ®åº“ä¸­æ‰€æœ‰é¡¹ç›®çš„åˆ—è¡¨ã€‚ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿ğŸ‘‡

```
@Query(â€œSELECT * FROM Tableâ€)
fun observeItems(): Flowable<List<Item>> 
```

ä½†ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘å¿…é¡»åœ¨æœåŠ¡ä¸­å­˜å‚¨åˆ—è¡¨çš„å‰¯æœ¬ï¼Œå¹¶ä¸æ”¶åˆ°çš„åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ‰¾å‡ºå“ªäº›é¡¹ç›®è¢«åˆ é™¤ï¼Œæˆ‘ä»¬çš„ updated è¡¥å……é“ã€‚

* * *

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå…³äºå¦‚ä½•æ„å»ºä¸€ä¸ªç®€å•çš„æ•°æ®åº“è§‚å¯Ÿå™¨çš„å¿«é€ŸæŠ€å·§ï¼Œå®ƒä¼šé€šçŸ¥æ‚¨æ­£åœ¨è¿›è¡Œçš„äº‹ä»¶ã€‚å‡ºäºæ¼”ç¤ºçš„ç›®çš„ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªæ¼”ç¤ºå¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åº(å°½ç®¡é€»è¾‘å¯èƒ½æ›´ç®€å•)ã€‚è¿™é‡Œå¯ä»¥æ‰¾åˆ°[ã€‚](https://github.com/rduriancik/Learning/tree/master/Android/RoomDbObserverDemo)

### [](#1-step)1ã€‚æ­¥éª¤

é¦–å…ˆï¼Œæˆ‘ä»¬å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„`Task`å®ä½“ï¼Œå®ƒä¿å­˜äº†æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ‰€æœ‰ä¿¡æ¯:

```
@Parcelize
@Entity
data class Task(
    var description: String,
    @PrimaryKey(autoGenerate = true) val id: Int = 0,
    val created: Long = System.currentTimeMillis(),
    var isDone: Boolean = false
) : Parcelable 
```

### [](#2-step)2ã€‚æ­¥éª¤

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬è®¾è®¡äº†`TaskDao`æ¥å£ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰çš„æ•°æ®æ“ä½œ/æ£€ç´¢æ–¹æ³•ï¼Œå¹¶è®¾ç½®äº†`TaskDatabase` :

```
@Dao
interface TaskDao {
    @Insert
    fun insertTask(task: Task): Completable

    @Update
    fun updateTask(task: Task): Completable

    @Query("SELECT * FROM Task")
    fun getAll(): Single<List<Task>>

    @Delete
    fun deleteTask(task: Task): Completable
 } 
```

```
@Database(entities = [Task::class], version = 1, exportSchema = false)
abstract class TaskDatabase : RoomDatabase() {
    abstract fun taskDao(): TaskDao
} 
```

æˆ‘ä»¬è§‚å¯Ÿå™¨åˆå§‹åŒ–æœ€é‡è¦çš„æ–¹æ³•æ˜¯`getAll()`ã€‚å®ƒå°†å…è®¸æˆ‘ä»¬åœ¨å®æ—¶è§‚æµ‹å‰æ£€ç´¢æ‰€æœ‰ä¿å­˜çš„æ•°æ®ã€‚å¦‚æ‚¨æ‰€è§ï¼Œå¯¹äºæ’å…¥ã€åˆ é™¤å’Œæ›´æ–°ç­‰åŸºæœ¬æ“ä½œï¼Œæˆ‘é€‰æ‹©äº†`Completable`ä½œä¸ºè¿”å›ç±»å‹ï¼Œå› ä¸ºå®ƒæœ€é€‚åˆæˆ‘ã€‚ä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨æƒ³è¦çš„ç±»å‹ï¼Œåªè¦å®ƒé€šçŸ¥æ‚¨æ“ä½œæ˜¯å¦æˆåŠŸã€‚

### [](#3-step)3ã€‚æ­¥éª¤

ä½œä¸ºè¿™ä¸€æ­¥çš„ç¬¬ä¸€ä»¶äº‹ï¼Œæˆ‘ä»¬åˆ›å»ºäº†`DatabaseEventType` enum ç±»ï¼Œå®ƒå­˜å‚¨äº†æˆ‘ä»¬æƒ³è¦è§‚å¯Ÿçš„æ‰€æœ‰å¯èƒ½äº‹ä»¶ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œäº‹ä»¶æ˜¯`INSERTED`ã€`UPDATED`ã€`REMOVED`ã€‚

```
enum class DatabaseEventType {
    INSERTED,
    UPDATED,
    REMOVED
} 
```

ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„æ³›å‹ç±»ï¼Œå®ƒå°†åŒ…è£…äº‹ä»¶å’Œå¯¼è‡´äº‹ä»¶çš„å€¼ã€‚

```
data class DatabaseEvent<T>(val eventType: DatabaseEventType, val value: T) 
```

### [](#4-step)4ã€‚æ­¥éª¤

æœ€åï¼Œå½“æˆ‘ä»¬å®ç°äº†æ‰€æœ‰å¿…è¦çš„ç»„ä»¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æœ€ç»ˆæ„å»ºæˆ‘ä»¬çš„è§‚å¯Ÿè€…äº†ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬åœ¨ä»»åŠ¡æ•°æ®åº“ä¸Šåˆ›å»ºä¸€ä¸ªå±‚ï¼Œä½œä¸ºå•ç‚¹æ§åˆ¶ã€‚

```
class TaskRepository private constructor(context: Context) {

    private val mTaskDao = Room.databaseBuilder(context, TaskDatabase::class.java, "tasks-database")
        .build()
        .taskDao()

    private val mObserverSubject = PublishSubject.create<DatabaseEvent<Task>>()

    fun addTask(task: Task): Completable {
        val insertEvent = DatabaseEvent(DatabaseEventType.INSERTED, task)
        return mTaskDao.insertTask(task)
            .doOnComplete { mObserverSubject.onNext(insertEvent) }
    }

    fun deleteTask(task: Task): Completable {
        val deleteEvent = DatabaseEvent(DatabaseEventType.REMOVED, task)
        return mTaskDao.deleteTask(task)
            .doOnComplete { mObserverSubject.onNext(deleteEvent) }
    }

    fun updateTask(task: Task): Completable {
        val updateEvent = DatabaseEvent(DatabaseEventType.UPDATED, task)
        return mTaskDao.updateTask(task)
            .doOnComplete { mObserverSubject.onNext(updateEvent) }
    }

    fun observeTasks(): Observable<DatabaseEvent<Task>> {
        return mTaskDao.getAll()
            .flatMapObservable { Observable.fromIterable(it) }
            .map { DatabaseEvent(DatabaseEventType.INSERTED, it) }
            .concatWith(mObserverSubject)
    }

    companion object {
        @Volatile
        private var instance: TaskRepository? = null

        fun getInstance(context: Context): TaskRepository {
            return instance ?: synchronized(this) {
                instance ?: TaskRepository(context.applicationContext).also { instance = it }
            }
        }
    }
} 
```

*mObserverSubject* æ˜¯ RxJava [PublishSubject](http://reactivex.io/RxJava/javadoc/io/reactivex/subjects/PublishSubject.html) è´Ÿè´£å®æ—¶è§‚å¯Ÿæ•°æ®åº“äº‹ä»¶ã€‚`addTask()`ã€`deleteTask()`ã€`updateTask()`ä¸‰ç§æ–¹æ³•éƒ½æ˜¯åˆ©ç”¨`TaskDao`è¿›è¡Œç»™å®šæ“ä½œã€‚å½“æˆ‘ä»¬çŸ¥é“æ“ä½œæˆåŠŸæ—¶(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯å½“`Completable`å®Œæˆæ—¶),æˆ‘ä»¬å‘è¿™ä¸ªä¸»é¢˜æäº¤ä¸€ä¸ª`DatabaseEvent`å¯¹è±¡ã€‚`PublishSubject`ä¸ä¿ç•™/ç¼“å­˜é¡¹ç›®ï¼Œå› æ­¤æ–°è®¢æˆ·ä¸ä¼šæ”¶åˆ°ä»»ä½•è¿‡å»çš„é¡¹ç›®ã€‚å½“æˆ‘ä»¬å¼€å§‹è§‚å¯Ÿæ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“å®ƒçš„å†…å®¹ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡`TaskDao`æ£€ç´¢æ¡ç›®ï¼Œå¹¶å°†å®ƒä»¬æ˜ å°„åˆ°`DatabaseEvent`ã€‚è¿™å°±æ˜¯`observeTasks()`æ–¹æ³•çš„ç›®çš„ã€‚

* * *

å°±è¿™æ ·ï¼Œæˆ‘ä»¬æ„å»ºäº†æˆ‘ä»¬çš„æ•°æ®åº“è§‚å¯Ÿè€…ã€‚ä»»ä½•æ—¶å€™æˆ‘ä»¬éœ€è¦è§‚å¯Ÿæ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è°ƒç”¨`observeTask()`æ–¹æ³•å¹¶è®¢é˜…`Observable`ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ç®€åŒ–ä½ çš„é¡¹ç›®ï¼Œæˆ–è€…æ›´å¥½åœ°ç†è§£å¦‚ä½•åˆ©ç”¨ RxJava å’Œ Roomã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæé—®ã€‚åœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ç”¨åç¨‹æ›¿æ¢ RxJavaã€‚