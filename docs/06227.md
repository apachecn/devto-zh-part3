# å…¨ Web App + CI/CD ç®¡é“ä»¥é”¤å­çš„æ–¹å¼ï¼ğŸ”¨ğŸ”¥ğŸ› 

> åŸæ–‡:[https://dev . to/nicki tax/full-we B- app-ci-CD-pipeline-in-a-hammer-way-39j 3](https://dev.to/nickitax/full-web-app-ci-cd-pipeline-in-a-hammer-way-39j3)

å¸¦æœ‰ NodeJS åç«¯+ CI/CD ç®¡é“çš„ VueJS åº”ç”¨ç¨‹åº:Hammer wayğŸ”¨ğŸ› 

* * *

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ç”¨ NodeJS åç«¯+å®Œæ•´çš„ CI/CD ç®¡é“æ„å»ºä¸€ä¸ªç®€å•çš„å…¨é¢çš„ Web åº”ç”¨é¡¹ç›®ã€‚

æˆ‘ç§°ä¹‹ä¸º**â€œé”¤é“â€**ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ä½¿ç”¨ Docker æˆ–è€…ä»»ä½•æ¶æ„...è¿™ä¸æ˜¯å¾ˆèŠ±ä¿ï¼Œä½†å®ƒçš„ä½œå“ _(ãƒ„)_/

åœ¨æœ¬æ•™ç¨‹çš„æœ€åï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šï¼Œå®Œå…¨è‡ªåŠ¨åŒ–çš„ç®¡é“å°†å»ºç«‹ï¼Œæµ‹è¯•å’Œéƒ¨ç½²åœ¨æ¯ä¸€ä¸ªæ¨ git ä»“åº“ï¼

è¿™ä¸¤ä¸ªé¡¹ç›®éƒ½å·²åœ¨æ­¤å¤„æä¾›:

åç«¯=> [è¿™é‡Œ](https://github.com/NickitaX/dev_to_tutorial_backend)
å‰ç«¯= > [å’Œè¿™é‡Œ](https://github.com/NickitaX/dev_to_tutorial_frontend)

(è¯·éšæ—¶æäº¤ PRs è¿›è¡Œæ”¹è¿›)

ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ

æˆ‘ä»¬èµ°å§ï¼ğŸ”¥

* * *

# ç¬¬ä¸€éƒ¨åˆ†:æˆ‘ä»¬çš„èŠ‚ç‚¹åç«¯ğŸ’»

* * *

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªè¶…çº§ç®€çº¦çš„ NodeJS åç«¯ï¼Œå®ƒå°†åšå”¯ä¸€çš„äº‹æƒ…:æœåŠ¡å‰ç«¯ã€‚
é¡¹ç›®ç»“æ„å¦‚ä¸‹:

```
./backend
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ circle.yml
â”œâ”€â”€ scripts
â”‚   â””â”€â”€ deploy.sh
â””â”€â”€ server.js 
```

æˆ‘ä»¬æ¥çœ‹çœ‹ server.js:

```
const express = require('express');

const path = require('path');

const http = require('http');

const app = express();

app.use(express.static('/home/deploy/frontend/'));

app.get('/', (req, res) =>  res.sendFile(path.join('/home/deploy/frontend/index.html')));

http.createServer(app).listen(8080); 
```

ä¸Šè¿°ä»£ç ä½¿ç”¨ express åº“ï¼Œè¯¥åº“åŠ è½½é™æ€æ–‡ä»¶å¤¹ä¸­å¼•ç”¨çš„**index.html**æ–‡ä»¶ï¼Œå¹¶åœ¨ç«¯å£ **8080** ä¸Šæä¾›æœåŠ¡ã€‚ä¸æ˜¯ç«ç®­ç§‘å­¦ï¼Œä½†æˆ‘ä»¬éœ€è¦ä»æŸä¸ªåœ°æ–¹å¼€å§‹...

deploy.sh å‘¢ï¼Ÿ

```
#!/usr/bin/env bash

ssh-keyscan -H "$1" >> ~/.ssh/known_hosts
ssh "deploy@$1" rm -rf ~/backend/*
scp -r ./server "deploy@$1:~/backend/"
scp -r ./package.json "deploy@$1:~/backend/"
scp -r ./package-lock.json "deploy@$1:~/backend/"
ssh $1 "cd /home/deploy/backend
                                   npm i
                                   forever stopall
                                   forever start server.js
                                   â€œ 
```

è¿™ä¸ª shell è„šæœ¬æ‰®æ¼”è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿçš„è§’è‰²ã€‚

åœ¨æˆ‘ä»¬æµè§ˆ shell ä»£ç ä¹‹å‰ï¼Œéœ€è¦æ¾„æ¸…ä¸€äº›æœåŠ¡å™¨è®¾ç½®:

åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å°†ä¸“é—¨ä¸ºæ­¤ç›®çš„åˆ›å»º **deploy** ç”¨æˆ·ï¼Œå¹¶ä¸ºæˆ‘ä»¬çš„ CI/CD ç®¡é“ç”Ÿæˆä¸€å¯¹ SSH å¯†é’¥(å°†å¾ˆå¿«å®Œæˆ)ã€‚

æˆ‘ä»¬è¿˜å°†å®‰è£…`forever js`ï¼Œå®ƒå°†åœ¨åå°è¿è¡Œ NodeJS è¿›ç¨‹ã€‚

ä¸»ç›®å½•ä¸‹ä¼šæœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹:**å‰ç«¯**å’Œ**åç«¯**ã€‚è¿™äº›æ˜¯ CI æœåŠ¡å™¨å°†æ–‡ä»¶å¤åˆ¶åˆ°çš„ä½ç½®ã€‚

> å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰ shell å˜é‡çš„äººæ¥è¯´:`$1`æ„å‘³ç€æˆ‘ä»¬å°†æŠŠæœåŠ¡å™¨ä¸»æœºåä½œä¸ºå‚æ•°ä¼ é€’ã€‚(å®ƒå°†è¢«æ‰§è¡Œä¸º:`bash deploy.sh my.awesome.website`ï¼Œè¿™é‡Œå°†æ”¾ç½®`my.awesome.website`è€Œä¸æ˜¯`$1`)ã€‚
> ç®€è€Œè¨€ä¹‹ï¼Œè¯¥è„šæœ¬åˆ é™¤æ—§ç‰ˆæœ¬çš„æœåŠ¡å™¨æ–‡ä»¶ï¼Œä» Git å­˜å‚¨åº“ä¸­å¤åˆ¶æ–°æ–‡ä»¶ï¼Œå¹¶é‡å¯ server.js çš„åå°è¿è¡Œè¿›ç¨‹

ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•ä¸ CircleCI æ•´åˆå‘¢ï¼Ÿä¸‹é¢æ˜¯æˆ‘ä»¬çš„ magic circle.yml é…ç½®æ–‡ä»¶:

```
version: 2
jobs:
  build:
    working_directory: ~/backend
    docker:
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: Install npm dependencies
          command: npm install
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - node_modules
  test:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - run:
          name: Test
          command: npm run test

  deploy:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - run:
          name: Deploy
          command: bash ./scripts/deploy.sh my.awesome.website

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - build
            - test
          filters:
            branches:
              only: master 
```

ä¸Šé¢çš„é…ç½®æ–‡ä»¶å£°æ˜äº†æˆ‘ä»¬ä» Git ä»“åº“ä¸­æå–çš„å·¥ä½œç›®å½•ï¼Œæµ‹è¯•å’Œéƒ¨ç½²æ­¥éª¤å°†è¿è¡Œæµ‹è¯•ï¼Œå¹¶æ‰§è¡Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ shell è„šæœ¬æ¥å¤åˆ¶æ–°æ–‡ä»¶ã€‚

å®ƒè¿˜åŒ…å«ç¯å¢ƒæè¿°ï¼Œå¦‚ docker å®¹å™¨ä¸Šå®‰è£…çš„èŠ‚ç‚¹ç‰ˆæœ¬ã€‚

å‰å®³ï¼æˆ‘ä»¬å®Œæˆäº†åç«¯ï¼é›…è™ï¼ğŸ‰

ç°åœ¨ï¼Œå°†æ‚¨çš„é¡¹ç›®æ¨é€åˆ°æ‚¨çš„ Git å­˜å‚¨åº“å§ï¼

* * *

# [](#part-two-quick-server-configuration)ç¬¬äºŒéƒ¨åˆ†:å¿«é€ŸæœåŠ¡å™¨é…ç½®ğŸ”‘

* * *

æ­£å¦‚æˆ‘æ‰€æ‰¿è¯ºçš„ï¼Œè¿™é‡Œæœ‰æ›´å¤šå…³äº Linux æœåŠ¡å™¨é…ç½®çš„å†…å®¹:

æˆ‘ä»¬éœ€è¦å®‰è£… node.js

[= >èŠ‚ç‚¹ JS](https://github.com/nodesource/distributions/blob/master/README.md)

ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å®‰è£…`forever.js`è¿›è¡Œåå°å¤„ç†(å¯èƒ½æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Œè¯·éšæ„è¯•éªŒ):

[= >æ°¸è¿œçš„ JS](https://github.com/foreverjs/forever)

æœ€åï¼Œä¸€å¯¹ SSH å¯†é’¥:

```
ssh-keygen -t rsa -C â€œamazing@dev.to" 
```

æ‚¨å°†å¾ˆå¿«éœ€è¦ä¸€ä¸ªç§é’¥æ¥å…è®¸ CircleCi åœ¨å®ä¾‹ä¸Šæ‰§è¡Œ SSH æ“ä½œã€‚

* * *

# [](#part-three-front-end)ç¬¬ä¸‰éƒ¨åˆ†:å‰ç«¯ï¼ğŸ˜

* * *

è¿™æ˜¯ä¸€ä¸ª VueJS å‰ç«¯çš„æ—¶ä»£ï¼

ä» VueJS å¼€å§‹çš„æœ€å¥½æ–¹æ³•æ˜¯ä½¿ç”¨ VueCLIã€‚å®‰è£…åï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ:
æ¥åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åº

```
vue create frontend 
```

(æ­¤å¤„å¯å…³æ³¨å®˜æ–¹æ–‡æ¡£:

ç”Ÿæˆä¸€ä¸ªé¡¹ç›®å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œæœ€åæˆ‘ä»¬ä¼šæœ‰ç±»ä¼¼çš„ç»“æ„:

```
./frontend
â”œâ”€â”€ README.md
â”œâ”€â”€ babel.config.js
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â””â”€â”€ src 
```

> ä¸è¦å¿˜è®°è¿è¡Œ`npm install`æ¥å®‰è£…æ‰€æœ‰çš„ä¾èµ–é¡¹ã€‚

è¦æµ‹è¯•æ‚¨çš„ awesome æ¨¡æ¿ç½‘ç«™ï¼Œè¯·è¿è¡Œ:`npm run serve`ã€‚

ä½ èƒ½çœ‹è§å®ƒå—ï¼Ÿå¤ªç¥å¥‡äº†ï¼ŒæˆåŠŸäº†ï¼å¹²å¾—å¥½ï¼

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›é­”æ³•â€¦ğŸ”®

è®©æˆ‘ä»¬åœ¨`src`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`scripts`ç›®å½•ï¼Œå¹¶å°†`deploy.sh`æ–‡ä»¶æ”¾åœ¨é‚£é‡Œï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:

```
#!/usr/bin/env bash
ls -l
ssh-keyscan -H "$1" >> ~/.ssh/known_hosts
ssh "deploy@$1" "rm -rf ~/frontend/*"
scp -r ./dist/static "deploy@$1:~/frontend/"
scp ./dist/index.html "deploy@$1:~/frontend/"
scp ./dist/service-worker.js "deploy@$1:~/frontend/" 
```

é•¿å¾—å·®ä¸å¤šå§ï¼Ÿè¿™ä¸ªè„šæœ¬å°†åˆ é™¤æ—§çš„å‰ç«¯ï¼Œå¹¶å¤åˆ¶æˆ‘ä»¬çš„ CircleCi åˆ›å»ºçš„æ–°æ–‡ä»¶ï¼

è¿™é‡Œæ˜¯æˆ‘ä»¬çš„`circle.yml`æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»º:

```
version: 2
jobs:
  deploy:
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm i
      - run:
          name: Package
          command: npm run build
      - run:
          name: Deploy
          command: bash ./scripts/deploy.sh my.awesome.website 

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - deploy:
          filters:
            branches:
              only: master 
```

æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œå®ƒçœ‹èµ·æ¥ä¸ä¹‹å‰çš„æœåŠ¡å™¨å‡ ä¹ä¸€æ ·ã€‚ç„¶è€Œï¼Œè¿™ä¸ªç‰ˆæœ¬é¦–å…ˆæ„å»ºæˆ‘ä»¬çš„å‰ç«¯é¡¹ç›®ï¼Œç„¶åæ‰§è¡Œéƒ¨ç½²ã€‚

æœ€ç»ˆçš„é¡¹ç›®ç»“æ„å°†å¦‚ä¸‹æ‰€ç¤º(ä½¿ç”¨æˆ‘ä»¬çš„æ–°æ–‡ä»¶):

```
./frontend
â”œâ”€â”€ README.md
â”œâ”€â”€ babel.config.js
â”œâ”€â”€ node_modules
â”œâ”€â”€ circle.yml
â”œâ”€â”€ scripts
â”‚   â””â”€â”€ deploy.sh
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â””â”€â”€ src 
```

æˆ‘ä»¬åšåˆ°äº†ï¼é›…è™ï¼

ç°åœ¨æ˜¯æœ€åä¸€éƒ¨åˆ†:CI é…ç½®(æœ¬ä¾‹ä¸­æ˜¯ CircleCi)

* * *

# ç¬¬å››éƒ¨åˆ†:CircleCiğŸ”„

* * *

ä¸€æ—¦æ‚¨ä½¿ç”¨ BitBucket ç™»å½•åˆ° [CircleCi](https://circleci.com) ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ·»åŠ æ‚¨çš„é¡¹ç›®:

[![Follow project](../Images/11da6644e65ff55c078a4a1a1a4e9fe4.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--h3wRcQkU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/sgexwlzepavaaho7d282.png)

ä½ è¿˜è®°å¾—æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆçš„ SSH å¯†é’¥å—ï¼Ÿç°åœ¨æˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒï¼

è½¬åˆ°ä¸¤ä¸ªé¡¹ç›®å„è‡ªçš„è®¾ç½®ï¼Œå¯¼èˆªåˆ°`SSH Permissions`é€‰é¡¹å¡ï¼Œå°†ç”Ÿæˆçš„ç§é’¥å¤åˆ¶/ç²˜è´´åˆ°é‚£é‡Œ:

[![SSH keys](../Images/5d1db4af5eb4ca220843e893a79806bc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--IES3RZFS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6wjr8v25u43npn0olm0d.png)

ç°åœ¨å°è¯•å°†ä»»ä½•æ›´æ”¹æ¨é€åˆ°å‰ç«¯æˆ–åç«¯é¡¹ç›®= >è¿™å°†è§¦å‘ä¸€ä¸ªæ„å»ºï¼Œæ‚¨çš„ Web åº”ç”¨ç¨‹åºå°†è‡ªåŠ¨æ›´æ–°:

[![First build](../Images/c0632dcd832f6fd5d4be6a37a46a05a5.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ZceYJb0X--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ytocgd2gfpwbt9x3u5hg.png)

æˆ‘ä»¬æˆåŠŸäº†ï¼ğŸ‰ğŸ‰ğŸ‰

[![Victory](../Images/4769cb7a82cbfe0b6b8d911cec0354c2.png)T2ã€‘](https://i.giphy.com/media/lnlAifQdenMxW/giphy.gif)

* * *

# [](#conclusion)ç»“è®ºğŸ•

* * *

è¿™ç§ç®¡é“é€‚åˆå°å‹ä¸ªäººé¡¹ç›®ï¼Œæˆ–è€…åªæ˜¯ä¸ºäº†ç†Ÿæ‚‰éƒ¨ç½²æ€æƒ³ã€‚ç¡®å®šçš„äº‹æƒ…:å‡ ä¹æœ¬æ•™ç¨‹çš„æ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥å‡çº§å’Œå¢å¼º:)å¦‚æœä½ æœ‰ä»»ä½•æƒ³æ³•æˆ–å‘ç°äº†ä¸€ä¸ª bug(æˆ‘æ•¢è‚¯å®šä»–ä»¬å¾ˆå°‘-ä¸è¦çŠ¹è±« rase PRsï¼)