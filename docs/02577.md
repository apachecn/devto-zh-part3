# åœ¨ Lambda ä¸­ä½¿ç”¨ Node.js æ—¶å¸¸è§é”™è¯¯

> [https://dev . to/oieduardorabelo/å¸¸è§é”™è¯¯-au-use-node-js-em-lambda-5dj 3](https://dev.to/oieduardorabelo/erros-comuns-ao-usar-node-js-em-lambda-5dj3)

AWS Lambda æ·»åŠ å¯¹ Node.js 8.10 çš„æ”¯æŒå·²ç»å…­ä¸ªæœˆäº†ã€‚æˆ‘å¾ˆé«˜å…´ç»ˆäºå¯ä»¥ç”¨**å¼‚æ­¥/awaitpo**ï¼Œ[æ¥ç®€åŒ–æˆ‘çš„ Lambda](https://serverless.com/blog/aws-lambda-node-8-support-what-changes-serverless-developers/) åŠŸèƒ½ã€‚

ä¸æ­¤åŒæ—¶ï¼Œæˆ‘å¸®åŠ©ä¸€äº›å®¢æˆ·å®Œæˆäº†ä»–ä»¬çš„é¡¹ç›®**ã€node . js 8.10ã€‘ã€‚æˆ‘åœ¨ä½¿ç”¨**ã€async/awaitã€‘**æ—¶æ³¨æ„åˆ°äº†ä¸€äº›åå¤å‡ºç°çš„é”™è¯¯ï¼Œæˆ‘å°†åœ¨ä¸‹é¢åˆ†äº«ã€‚**

 **# ä»ç„¶ä½¿ç”¨å›è°ƒ

å¾ˆå¤šäººè¿˜åœ¨ç”¨å›è°ƒå‡½æ•°**å¼‚æ­¥** :

```
module.exports.handler = async (event, context, cb) => {
  const response = {
    statusCode: 200,
    body: JSON.stringify({ message: 'hello world' })
  }

  cb(null, response)
} 
```

æœ€ç®€å•çš„é€‰æ‹©æ˜¯:

```
module.exports.handler = async (event, context) => {
  const response = {
    statusCode: 200,
    body: JSON.stringify({ message: 'hello world' })
  }

  return response
} 
```

# Esquecer de usar util . promisify

Node.js 8.10 ä¹‹å‰ï¼Œè½¯ä»¶åŒ… [Bluebird](http://bluebirdjs.com/docs/getting-started.html) å¡«è¡¥äº†å·¨å¤§çš„ç©ºç™½ã€‚å®ƒæä¾›äº†å°†åŸºäº**å›è°ƒ**çš„å‡½æ•°è½¬æ¢ä¸º**æ‰¿è¯º**çš„å®ç”¨ç¨‹åºã€‚ä½† Node.js 8.10 ä¸­çš„åŸç”Ÿæ¨¡å—**ã€utilã€‘**ç”¨çš„åŠŸèƒ½å¡«è¡¥äº†è¿™ä¸ªç©ºç™½ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†**æ¨¡å—çš„ **readFile** åŠŸèƒ½è½¬æ¢å¦‚ä¸‹:** 

```
const fs = require('fs')
const { promisify } = require('util')
const readFile = promisify(fs.readFile) 
```

ä¸ç”¨å†ç”¨è“é¸Ÿäº†ã€‚å‡å°‘äº†å¯¹æˆ‘ä»¬åŠŸèƒ½çš„ä¾èµ–ï¼Œæœ‰åŠ©äºå‡å°‘å†·å¯åŠ¨æ—¶é—´(â€œt0â€)ã€‚

# ä¸å¿…è¦çš„é¡ºåºç 

**ã€async/awaitã€‘**å…è®¸å†™å¼‚æ­¥ä»£ç ï¼Œå°±å¥½åƒå®ƒæ˜¯åŒæ­¥çš„ä¸€æ ·ï¼Œè¿™æ˜¯ä¸å¯æ€è®®çš„ã€‚æˆ‘ä»¬ä¸éœ€è¦å¤„ç†**å›è°ƒåœ°ç‹±**ï¼

å¦ä¸€æ–¹é¢ï¼Œåœ¨é€‚å½“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¿½ç•¥ä¸åŒæ—¶æ‰§è¡Œä»»åŠ¡çš„ä¼˜ç‚¹ã€‚

ä»¥ä¸‹åˆ—ä»£ç ä¸ºä¾‹:

```
async function getFixturesAndTeam(teamId) {
  const fixtures = await fixtureModel.fetchAll()
  const team = await teamModel.fetch(teamId)
  return {
    team,
    fixtures: fixtures.filter(x => x.teamId === teamId)
  }
} 
```

æ­¤åŠŸèƒ½æ˜“äºé˜…è¯»ï¼Œä½†å…¶å®ç°å‡ ä¹ä¸ç†æƒ³ã€‚ **teamModel.fetch** å¹¶ä¸å–å†³äºç»“æœ**fizzle del . fetchall**ï¼Œå› æ­¤å¿…é¡»åŒæ—¶è¿è¡Œã€‚

ä¸‹é¢æ˜¯ä½ å¯ä»¥æ”¹è¿›çš„æ–¹å¼:

```
async function getFixturesAndTeam(teamId) {
  const fixturesPromise = fixtureModel.fetchAll()
  const teamPromise = teamModel.fetch(teamId)

  const fixtures = await fixturesPromise
  const team = await teamPromise

  return {
    team,
    fixtures: fixtures.filter(x => x.teamId === teamId)
  }
} 
```

åœ¨æ­¤ç‰ˆæœ¬ä¸­ï¼Œ**fix emodel . fetchall**å’Œ**team model . fetch**åŒæ—¶å¯åŠ¨ã€‚

ä½¿ç”¨**åœ°å›¾** com **å¼‚æ­¥/await** æ—¶ä¹Ÿè¦å°å¿ƒã€‚ä»¥ä¸‹ç¤ºä¾‹å°†ä¾æ¬¡è°ƒç”¨æ¯ä¸ª**team model . fetch**:

```
async function getTeams(teamIds) {
  const teams = _.map(teamIds, id => await teamModel.fetch(id))
  return teams
} 
```

ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥å†™:

```
async function getTeams(teamIds) {
  const promises = _.map(teamIds, id => teamModel.fetch(id))
  const teams = await Promise.all(promises)
  return teams
} 
```

åœ¨ä¸Šä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† **teamIds** æ˜ å°„åˆ° promises æ•°ç»„ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **Promise.all** å°†æ­¤é˜µåˆ—è½¬æ¢ä¸ºè¿”å›å›¢é˜Ÿé˜µåˆ—çš„å•ä¸ª Promiseã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**team model . fetch**åŒæ—¶è°ƒç”¨ï¼Œå¯ä»¥æ˜¾ç€æ”¹å–„è¿è¡Œæ—¶é—´ã€‚

# async/await dentro de forEach

è¿™æ˜¯ä¸€ä¸ªç”šè‡³å¯ä»¥ä» Node.js ä¸Šæœ‰ç»éªŒçš„å¼€å‘è€…é‚£é‡Œå¾—åˆ°çš„æŠ€å·§ã€‚

é—®é¢˜æ˜¯è¿™æ ·çš„ä»£ç å¹¶ä¸åƒé¢„æœŸçš„é‚£æ ·è¿ä½œ:

```
[ 1, 2, 3 ].forEach(async (x) => {
  await sleep(x)
  console.log(x)
})

console.log('all done.') 
```

å½“ä½ è¿™æ ·åšæ—¶ï¼Œä½ ä¼šå¾—åˆ°ä»¥ä¸‹çš„è¾“å‡º:

```
all done. 
```

ä½ å¯ä»¥çœ‹åˆ°è¿™äº›æ–‡ç« ( [1](https://medium.com/@oieduardorabelo/javascript-armadilhas-do-asyn-await-em-loops-1cdad44db7f0) ï¼Œ)å¯¹ä¸ºä»€ä¹ˆä¸å·¥ä½œä½œå‡ºæ›´è¯¦ç»†çš„è§£é‡Šã€‚æš‚æ—¶ï¼Œè®°å¾—é¿å…åœ¨ä¸€ä¸ª **forEach** å†…ä½¿ç”¨**ã€å¼‚æ­¥/å”¤é†’ã€‘ï¼**

# Esquecer de usarã€‚promise()æ²¡æœ‰ AWS-SDK

æ‚¨çŸ¥é“ AWS SDK å®¢æˆ·æ”¯æŒ promises å›è°ƒå—ï¼Ÿè¦åœ¨ AWS SDK ä¸­ä½¿ç”¨**ã€async/awaitã€‘**ï¼Œè¯·æ·»åŠ ã€‚**æ‰¿è¯º()**å¯¹é¡¾å®¢æ–¹æ³•:

```
const AWS = require('aws-sdk')
const Lambda = new AWS.Lambda()

async function invokeLambda(functionName) {
  const req = {
    FunctionName: functionName,
    Payload: JSON.stringify({ message: 'hello world' })
  }
  await Lambda.invoke(req).promise()
} 
```

å¯¹**å›è°ƒ s** è¯´ä¸ï¼Œè€¶ï¼ğŸ‰

# å®Œæˆ

å°±æ˜¯è¿™æ ·ï¼è¿™äº›æ˜¯åœ¨ Lambda ä¸Šä½¿ç”¨ Node.js 8.10 æ—¶å¯ä»¥é¿å…çš„æœ€å¸¸è§é”™è¯¯ã€‚æœ‰å…³å¦‚ä½•åˆ›å»ºæ— æœåŠ¡å™¨ã€å¯æ‰©å±•ä¸”å¯ç”Ÿäº§çš„åº”ç”¨ç¨‹åºçš„æ›´å¤šæç¤ºï¼Œè¯·å‚é˜…[æˆ‘çš„è§†é¢‘è¯¾ç¨‹](https://bit.ly/production-ready-serverless)ï¼ï¼›-ä»€ä¹ˆ

# [t1ã€å­¦åˆ†ã€‘](#cr%C3%A9ditos-%EF%B8%8F)

*   [å…±åŒèŠ‚ç‚¹ 8 lambda](https://twitter.com/theburningmonk)ä¸­çš„é”™è¯¯ï¼ŒåŸç€ä½œè€…[ä¸¥ç¿ ç¿ ](https://twitter.com/theburningmonk)****