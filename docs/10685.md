# å¦‚ä½•ç”¨ LocalStack åœ¨æœ¬åœ°ä¼ªé€  AWS

> åŸæ–‡:[https://dev . to/good idea/how-to-fake-AWS-local-with-local stack-27me](https://dev.to/goodidea/how-to-fake-aws-locally-with-localstack-27me)

å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œä½ ä¼šå°½å¯èƒ½é¿å…ç™»å½• AWS æ§åˆ¶å°ã€‚æ‚¨æ˜¯å¦ä½¿ç”¨ 2FA è®¾ç½®äº†æ‚¨çš„ IAM root ç”¨æˆ·ï¼Œå¹¶åœ¨æ‚¨çš„ S3 å­˜å‚¨æ¡¶ä¸Šæ­£ç¡®é…ç½®äº† CORS å’Œ ACL è®¾ç½®ï¼Ÿ

# [](#nah)ğŸ¤·â€â™‚ï¸æ²¡æœ‰ã€‚

æˆ‘ä¹Ÿå–œæ¬¢è®©æˆ‘çš„æœ¬åœ°å¼€å‘ç¯å¢ƒå°½å¯èƒ½åœ°æ¥è¿‘å®ƒåœ¨ç”Ÿäº§ä¸­çš„å·¥ä½œæ–¹å¼ã€‚æ­¤å¤–ï¼Œæˆ‘ä¸€ç›´åœ¨å¯»æ‰¾æ–°çš„æ–¹æ³•æ¥å¡«æ»¡æˆ‘çš„å°ç¡¬ç›˜ã€‚æˆ‘æƒ³ä¸å‡ºæ¯”æŠŠä¸€å † S3 æœåŠ¡å™¨æ”¾åœ¨æˆ‘çš„ç”µè„‘é‡Œæ›´å¥½çš„æ–¹æ³•æ¥å®ç°ä»¥ä¸Šæ‰€æœ‰ç›®æ ‡ã€‚

æœ¬æ•™ç¨‹å°†ä»‹ç»å¦‚ä½•åœ¨èŠ‚ç‚¹åº”ç”¨ç¨‹åºä¸­è®¾ç½® [Localstack](https://github.com/localstack/localstack) ã€‚Localstack å…è®¸æ‚¨åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæ¨¡æ‹Ÿè®¸å¤š AWS æœåŠ¡ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬åªä½¿ç”¨ S3ã€‚æ­¤å¤–ï¼ŒLocalstack ä¸æ˜¯ç‰¹å®šäº Node çš„â€”â€”æ‰€ä»¥å³ä½¿æ‚¨ä¸åœ¨ Node ä¸­å·¥ä½œï¼Œæœ¬æ•™ç¨‹çš„å¤§éƒ¨åˆ†å†…å®¹ä»ç„¶æ˜¯ç›¸å…³çš„ã€‚è¿™ä¹ŸåŒ…æ‹¬äº†ä¸€ç‚¹å…³äº Docker çš„å†…å®¹â€”â€”å¦‚æœä½ çœŸçš„ä¸çŸ¥é“ä½ åœ¨ç”¨ Docker åšä»€ä¹ˆæˆ–è€…å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸è¦æ‹…å¿ƒã€‚æˆ‘ä¹Ÿä¸çŸ¥é“ã€‚

ä½ å¯ä»¥çœ‹åˆ°å®Œæˆä»£ç çš„[æ¼”ç¤ºæŠ¥å‘Š](https://github.com/good-idea/localstack-demo)ã€‚

è¿™ç§æ–¹æ³•çš„ä¸€äº›å¥½å¤„æ˜¯:

*   ä½ å¯ä»¥è„±æœºå·¥ä½œ
*   æ‚¨ä¸éœ€è¦å›¢é˜Ÿä¸­çš„æ¯ä¸ªäººéƒ½ä½¿ç”¨çš„å…±äº«â€œå¼€å‘â€æ¡¶
*   æ‚¨å¯ä»¥è½»æ¾æ“¦æ‹­å’Œæ›´æ¢æ‚¨çš„æœ¬åœ°æ°´æ¡¶
*   ä½ ä¸éœ€è¦æ‹…å¿ƒæ”¯ä»˜ AWS çš„ä½¿ç”¨è´¹
*   ä½ ä¸éœ€è¦ç™»å½• AWSğŸ˜›

## [](#initial-setup)åˆå§‹è®¾ç½®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›ä¸œè¥¿ã€‚

1.  å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… [Docker](https://docs.docker.com/install/) ã€‚
2.  å®‰è£… [AWS CLI](https://aws.amazon.com/cli/) ã€‚å°½ç®¡æˆ‘ä»¬ä¸ä¼šä¸â€œçœŸæ­£çš„â€AWS ä¸€èµ·å·¥ä½œï¼Œä½†æˆ‘ä»¬å°†ä½¿ç”¨å®ƒä¸æœ¬åœ° docker å®¹å™¨è¿›è¡Œå¯¹è¯ã€‚
3.  ä¸€æ—¦å®‰è£…äº† AWS CLIï¼Œè¿è¡Œ`aws configure`æ¥åˆ›å»ºä¸€äº›å‡­è¯ã€‚å³ä½¿æˆ‘ä»¬åœ¨å’Œæˆ‘ä»¬çš„â€œå‡â€æœ¬åœ°æœåŠ¡å¯¹è¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å‡­è¯ã€‚ä½ å¯ä»¥è¾“å…¥çœŸå®çš„å‡­è¯(å¦‚è¿™é‡Œæè¿°çš„)ï¼Œæˆ–è€…è™šæ‹Ÿçš„å‡­è¯ã€‚Localstack è¦æ±‚è¿™äº›ç»†èŠ‚å­˜åœ¨ï¼Œä½†å®é™…ä¸Šå¹¶ä¸éªŒè¯å®ƒä»¬ã€‚*æ„Ÿè°¢ [@alexiswilke](https://dev.to/alexiswilke) åœ¨è¯„è®ºä¸­æŒ‡å‡ºæˆ‘é”™è¿‡äº†è¿™ä¸€æ­¥ï¼*
4.  åšå‡ ä¸ªæ–‡ä»¶ã€‚ä¸ºæ‚¨çš„é¡¹ç›®åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­:`touch index.js docker-compose.yml .env && mkdir .localstack`
5.  å°†å›¾åƒæ·»åŠ åˆ°é¡¹ç›®ç›®å½•ä¸­ï¼Œå¹¶å°†å…¶é‡å‘½åä¸º`test-upload.jpg`
6.  `npm init`å»ºç«‹ä¸€ä¸ª package.jsonï¼Œç„¶å`npm install aws-sdk dotenv`

## [](#docker)ç å¤´å·¥äºº

(å£°æ˜:æˆ‘ä¸æ˜¯ç å¤´ä¸“å®¶ã€‚å¦‚æœä»»ä½•äººå¯¹å¦‚ä½•æ”¹è¿›æˆ–æ›´å¥½åœ°è§£é‡Šè¿™äº›æœ‰ä»»ä½•å»ºè®®ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼)

### [](#docker-config)Docker é…ç½®

ä½ å¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œè¿è¡Œ Localstackï¼Œä½†æ˜¯æˆ‘å–œæ¬¢ä½¿ç”¨ Dockerï¼Œå› ä¸ºå®ƒè®©æˆ‘è§‰å¾—è‡ªå·±å¾ˆèªæ˜ã€‚è¿™ä¹Ÿå¾ˆå¥½ï¼Œå› ä¸ºæ‚¨ä¸éœ€è¦æ‹…å¿ƒåœ¨æ‚¨çš„ç³»ç»Ÿä¸Šå®‰è£… Localstackã€‚æˆ‘æ›´å–œæ¬¢ä½¿ç”¨ docker-compose æ¥è®¾ç½®å®ƒã€‚ä»¥ä¸‹æ˜¯é…ç½®:

`docker-compose.yml`

```
version: '3.2'
services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack_demo
    ports:
      - '4563-4599:4563-4599'
      - '8055:8080'
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - './.localstack:/tmp/localstack'
      - '/var/run/docker.sock:/var/run/docker.sock' 
```

*(2019 . 8 . 10 ç¼–è¾‘:LocalStack ç°åœ¨æœ‰äº†æ›´å¤§èŒƒå›´çš„ç«¯å£ï¼Œä¸Šé¢çš„ yaml å·²ç»æ›´æ–°ä»¥åæ˜ è¿™ä¸€ç‚¹ã€‚æ„Ÿè°¢@arqez åœ¨è¯„è®ºé‡Œæåˆ°è¿™ä¸ª)*

æŠŠè¿™äº›çº¿åˆ†å¼€:

#### [](#-raw-image-localstacklocalstacklatest-endraw-)`image: localstack/localstack:latest`

ä½¿ç”¨ Dockerhub ä¸­æœ€æ–°çš„ [Localstack æ˜ åƒ](https://hub.docker.com/r/localstack/localstack/)

#### [](#-raw-containername-localstackdemo-endraw-)`container_name: localstack_demo`:

è¿™ä¸ºæˆ‘ä»¬çš„å®¹å™¨æä¾›äº†ä¸€ä¸ªç‰¹å®šçš„åç§°ï¼Œæˆ‘ä»¬å¯ä»¥ç¨ååœ¨ CLI ä¸­å¼•ç”¨å®ƒã€‚

#### [](#-raw-ports-4563459945634599-endraw-and-raw-80558080-endraw-)`ports: '4563-4599:4563-4599'`å’Œ`'8055:8080'`:

å½“ä½ çš„ docker å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰“å¼€å‡ ä¸ªç«¯å£ã€‚å·¦è¾¹**ä¸Šçš„æ•°å­—**å°†ä½ çš„`localhost`ä¸Šçš„ç«¯å£ç»‘å®šåˆ°é›†è£…ç®±å†…çš„ç«¯å£ï¼Œä¹Ÿå°±æ˜¯å³è¾¹**ä¸Šçš„æ•°å­—**ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªæ•°å­—å¯ä»¥ç›¸åŒï¼Œå³`8080:8080`ã€‚æˆ‘ç»å¸¸åœ¨`localhost:8080`ä¸Šè¿è¡Œä¸€äº›å…¶ä»–çš„ä¸œè¥¿ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘æŠŠé»˜è®¤è®¾ç½®æ”¹æˆäº†`8055:8080`ã€‚è¿™æ„å‘³ç€å½“æˆ‘åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­è¿æ¥åˆ°`http://localhost:8055`æ—¶ï¼Œå®ƒå°†ä¸å®¹å™¨ä¸Šçš„ç«¯å£`8080`å¯¹è¯ã€‚

è¡Œ`'4563-4584:4563-4584'`åšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æ˜¯ç»‘å®šäº†æ•´ä¸ªèŒƒå›´çš„ç«¯å£ã€‚Localstack å°†è¿™äº›ç‰¹å®šçš„ç«¯å£å·ç”¨ä½œå„ç§ API çš„ç«¯ç‚¹ã€‚ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°æ›´å¤šç›¸å…³å†…å®¹ã€‚

#### [](#-raw-environment-endraw-)`environment`

è¿™äº›æ˜¯æä¾›ç»™å®¹å™¨çš„ç¯å¢ƒå˜é‡ã€‚Localstack å°†ä½¿ç”¨è¿™äº›åœ¨å†…éƒ¨è®¾ç½®ä¸€äº›ä¸œè¥¿:

*   `SERVICES=s3`:æ‚¨å¯ä»¥å®šä¹‰è¦æ¨¡æ‹Ÿçš„ AWS æœåŠ¡åˆ—è¡¨ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨äº† S3ï¼Œä½†æ˜¯æ‚¨å¯ä»¥åŒ…å«é¢å¤–çš„ APIï¼Œä¾‹å¦‚`SERVICES=s3,lambda`ã€‚åœ¨ Localstack æ–‡æ¡£ä¸­æœ‰æ›´å¤šå…³äºè¿™æ–¹é¢çš„å†…å®¹ã€‚
*   ğŸ§»ç»™æˆ‘çœ‹æ‰€æœ‰çš„æ—¥å¿—ï¼
*   `DATA_DIR=/tmp/localstack/data`:è¿™æ˜¯ Localstack åœ¨å†…éƒ¨ä¿å­˜æ•°æ®*çš„ç›®å½•ã€‚æ›´å¤šå†…å®¹è¯·è§ä¸‹æœŸ:*

#### [](#-raw-volumes-endraw-)`volumes`

`'./.localstack:/tmp/localstack'`

è¿˜è®°å¾—å¤§çº¦ 2 ç§’å‰å°†`DATA_DIR`è®¾ç½®ä¸º`/tmp/localstack/data`çš„æ—¶å€™å—ï¼Ÿå°±åƒæˆ‘ä»¬åœ¨ç«¯å£ä¸Šä½¿ç”¨çš„`localhost:container`è¯­æ³•ä¸€æ ·ï¼Œè¿™å…è®¸ä½ çš„å®¹å™¨è®¿é—®ä½ ç¡¬ç›˜çš„ä¸€éƒ¨åˆ†ã€‚ä½ ç”µè„‘çš„ç›®å½•åœ¨å·¦è¾¹ï¼Œå®¹å™¨åœ¨å³è¾¹ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å‘Šè¯‰å®¹å™¨ä½¿ç”¨æˆ‘ä»¬çš„`.localstack`ç›®å½•ä½œä¸ºå®ƒçš„`/tmp/localstack`ã€‚è¿™å°±åƒä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œæˆ–ä¸€ä¸ªç¥å¥‡çš„é—¨æˆ·ï¼Œæˆ–ä»€ä¹ˆçš„ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ç¡®ä¿äº†ä¸€æ—¦å®¹å™¨é‡æ–°å¯åŠ¨ï¼Œå®¹å™¨åˆ›å»ºçš„ä»»ä½•æ•°æ®ä»ç„¶å­˜åœ¨ã€‚è¯·æ³¨æ„ï¼Œ`/tmp`ç»å¸¸è¢«æ¸…ç†ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå­˜å‚¨çš„å¥½åœ°æ–¹ã€‚å¦‚æœä½ æƒ³æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªæ›´å®‰å…¨çš„åœ°æ–¹

*   `'/var/run/docker.sock:/var/run/docker.sock'`

### [](#starting-our-container)å¯åŠ¨æˆ‘ä»¬çš„å®¹å™¨

ç°åœ¨æˆ‘ä»¬å·²ç»æŠŠ`docker-compose.yml`å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ—‹è½¬å®¹å™¨:`docker-compose up -d`ã€‚

ä¸ºäº†ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—® [http://localhost:8055](http://localhost:8055) æ¥æŸ¥çœ‹ Localstack çš„ web UIã€‚ç°åœ¨å®ƒçœ‹èµ·æ¥ä¼šå¾ˆç©º:

[![Empty Localstack UI](../Images/53d7b3a535d173165cce72b209456d52.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--MsDB3dmR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/0ym8w6yneym9nh98xo0e.png)

ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬çš„ S3 ç«¯ç‚¹ [http://localhost:4572](http://localhost:4572) å°†æ˜¾ç¤ºä¸€äº›åŸºæœ¬çš„ AWS ä¿¡æ¯:

[![Empty S3 bucket](../Images/1492a1d34be36a39a166ac632afdccf7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--WDHxMei9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/mmqvbgjrcgs2bhqguxi4.png)

(å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°ç±»ä¼¼çš„å†…å®¹ï¼Œè¯·æŸ¥çœ‹ docker å®¹å™¨çš„æ—¥å¿—)

## [](#working-with-localstack)ä½¿ç”¨æœ¬åœ°å †æ ˆ

AWS ç°åœ¨å°±åœ¨æˆ‘ä»¬çš„ç”µè„‘é‡Œé¢ã€‚ä½ å¯èƒ½å·²ç»æœ‰ç‚¹è§‰å¾—è‡ªå·±æ˜¯ä¸–ç•Œä¸Šæœ€å¯Œæœ‰çš„äººäº†ã€‚(å¦‚æœæ²¡æœ‰ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œç»§ç»­çœ‹å°±å¥½ğŸ˜›)

åœ¨å¼€å§‹ä¸Šä¼ æ–‡ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå’Œé…ç½®ä¸€ä¸ª bucketã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰å®‰è£…çš„ AWS CLI æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œä½¿ç”¨`--endpoint-url`æ ‡å¿—ä¸ Localstack å¯¹è¯ã€‚

1.  åˆ›å»ºä¸€ä¸ªæ¡¶:`aws --endpoint-url=http://localhost:4572 s3 mb s3://demo-bucket`
2.  å°†ä¸€ä¸ª [ACL](https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html) é™„åŠ åˆ° bucketï¼Œè¿™æ ·å®ƒå°±å¯è¯»äº†:`aws --endpoint-url=http://localhost:4572 s3api put-bucket-acl --bucket demo-bucket --acl public-read`

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è®¿é—® web UI æ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æˆ‘ä»¬çš„å­˜å‚¨æ¡¶:

[![Localstack UI with S3 Bucket](../Images/ab8c6dce33b923d95325b20f7bc26d9d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--z7RsBI_g--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/7lrpsp1n71xhead0xll1.png)

å¦‚æœæ‚¨åœ¨ docker è®¾ç½®ä¸­ä½¿ç”¨äº†`volumes`ï¼Œè®©æˆ‘ä»¬æš‚åœä¸€ä¼šå„¿ï¼Œçœ‹çœ‹`./.localstack/data`ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚

[![Localstack S3 JSON](../Images/37f71fea93aacf8711e5d864b11f5e00.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fpXcLthF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/12dwa5s12m1of06w4qcu.png)

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Localstack æ­£åœ¨è¿™ä¸ª JSON æ–‡ä»¶ä¸­è®°å½•æ‰€æœ‰çš„ API è°ƒç”¨ã€‚å½“å®¹å™¨é‡å¯æ—¶ï¼Œå®ƒå°†é‡æ–°åº”ç”¨è¿™äº›è°ƒç”¨â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨é‡å¯ä¹‹é—´ä¿å­˜æ•°æ®ã€‚ä¸€æ—¦æˆ‘ä»¬å¼€å§‹ä¸Šä¼ ï¼Œæˆ‘ä»¬å°†ä¸ä¼šåœ¨æ­¤ç›®å½•ä¸­çœ‹åˆ°æ–°æ–‡ä»¶ã€‚ç›¸åï¼Œæˆ‘ä»¬çš„ä¸Šä¼ å°†ä½œä¸ºåŸå§‹æ•°æ®è®°å½•åœ¨è¿™ä¸ªæ–‡ä»¶*ä¸­ã€‚(å¦‚æœæ‚¨æƒ³ä¸ä»–äººå…±äº«å®¹å™¨çš„çŠ¶æ€ï¼Œæ‚¨å¯ä»¥å°†è¯¥æ–‡ä»¶åŒ…å«åœ¨æ‚¨çš„ repo ä¸­â€”â€”ä½†æ˜¯å–å†³äºæ‚¨ä¸Šä¼ çš„é‡ï¼Œå®ƒå°†æˆä¸ºä¸€ä¸ªç›¸å½“å¤§çš„æ–‡ä»¶)*

å¦‚æœæ‚¨å¸Œæœ›ä»¥åèƒ½å¤Ÿâ€œæ¢å¤â€æ‚¨çš„å­˜å‚¨æ¡¶ï¼Œæ‚¨å¯ä»¥å¤‡ä»½è¯¥æ–‡ä»¶ã€‚å½“æ‚¨å‡†å¤‡å¥½æ¢å¤æ—¶ï¼Œåªéœ€åˆ é™¤æ›´æ–°çš„`s3_api_calls.json`æ–‡ä»¶ï¼Œç”¨æ‚¨çš„å¤‡ä»½æ›¿æ¢å®ƒï¼Œå¹¶é‡æ–°å¯åŠ¨æ‚¨çš„å®¹å™¨ã€‚

### [](#uploading-from-our-app)ä»æˆ‘ä»¬çš„åº”ç”¨ä¸Šä¼ 

æœ‰å¾ˆå¤š S3 ä¸Šä¼ æ•™ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸€èŠ‚ä¸ä¼šæ·±å…¥ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„`upload`å‡½æ•°ï¼Œå¹¶å°è¯•ä¸Šä¼ å‡ æ¬¡å›¾åƒã€‚

å°†è¿™äº›å†…å®¹å¤åˆ¶åˆ°ä»–ä»¬çš„æ–‡ä»¶ä¸­:

**ã€‚env** ï¼Œæˆ‘ä»¬çš„ç¯å¢ƒå˜é‡

```
AWS_ACCESS_KEY_ID='123'
AWS_SECRET_KEY='xyz'
AWS_BUCKET_NAME='demo-bucket' 
```

æ³¨æ„:ä½ çš„ AWS å¯†åŒ™&æ˜¯ä»€ä¹ˆå¹¶ä¸é‡è¦ï¼Œåªè¦å®ƒä»¬ä¸æ˜¯ç©ºçš„ã€‚

**aws.js** ï¼Œæˆ‘ä»¬ä¸Šä¼ åŠŸèƒ½çš„æ¨¡å—

```
const AWS = require('aws-sdk')
require('dotenv').config()

const credentials = {
   accessKeyId: process.env.AWS_ACCESS_KEY_ID,
   secretAccessKey: process.env.AWS_SECRET_KEY,
}

const useLocal = process.env.NODE_ENV !== 'production'

const bucketName = process.env.AWS_BUCKET_NAME

const s3client = new AWS.S3({
   credentials,
   /**
    * When working locally, we'll use the Localstack endpoints. This is the one for S3.
    * A full list of endpoints for each service can be found in the Localstack docs.
    */
   endpoint: useLocal ? 'http://localhost:4572' : undefined,
   /**
     * Including this option gets localstack to more closely match the defaults for
     * live S3\. If you omit this, you will need to add the bucketName to the `Key`
     * property in the upload function below.
     *
     * see: https://github.com/localstack/localstack/issues/1180
     */
   s3ForcePathStyle: true,
})

const uploadFile = async (data, fileName) =>
   new Promise((resolve) => {
      s3client.upload(
         {
            Bucket: bucketName,
            Key: fileName,
            Body: data,
         },
         (err, response) => {
            if (err) throw err
            resolve(response)
         },
      )
   })

module.exports = uploadFile 
```

*æ„Ÿè°¢ [@mcmule](https://dev.to/mcmule) å¯¹ä¸Šé¢`s3ForcePathStyle`é€‰é¡¹çš„æç¤ºã€‚å¦‚æœä½ å¾—åˆ°äº†ä¸€ä¸ª`ECONNREFUSED`é”™è¯¯ï¼Œçœ‹çœ‹[ä»–çš„è¯„è®º](https://dev.to/mcmule/comment/f841)*

**test-upload.js** ï¼Œå®ç°ä¸Šä¼ åŠŸèƒ½

```
const fs = require('fs')
const path = require('path')
const uploadFile = require('./aws')

const testUpload = () => {
   const filePath = path.resolve(__dirname, 'test-image.jpg')
   const fileStream = fs.createReadStream(filePath)
   const now = new Date()
   const fileName = `test-image-${now.toISOString()}.jpg`
   uploadFile(fileStream, fileName).then((response) => {
      console.log(":)")
      console.log(response)
   }).catch((err) => {
      console.log(":|")
      console.log(err)
   })
}

testUpload() 
```

`testUpload()`å‡½æ•°è·å–æ–‡ä»¶å†…å®¹ï¼Œæ ¹æ®å½“å‰æ—¶é—´ç»™å®ƒä¸€ä¸ªæƒŸä¸€çš„åç§°ï¼Œç„¶åä¸Šä¼ ã€‚è®©æˆ‘ä»¬è¯•ä¸€è¯•:

`node test-upload.js`

[![testing the upload](../Images/12a0e24e60430ebe7a01e688e6a0230e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CmUTD8dT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/yx94y5fj0j8rq4y67foy.png)

å¤åˆ¶å“åº”çš„`Location`å±æ€§ä¸­çš„ URLï¼Œå¹¶å°†å…¶ç²˜è´´åˆ°æµè§ˆå™¨ä¸­ã€‚æµè§ˆå™¨å°†ç«‹å³ä¸‹è½½å›¾åƒã€‚å¦‚æœä½ æƒ³åœ¨ä½ çš„æµè§ˆå™¨ä¸­çœ‹åˆ°å®ƒï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼ JS Bin:

[![I love my dog](../Images/09ff3eac64c081d80422448c50ec049a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--soDvnAT---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/v1vnvbzo7z0wlabm3o43.png)

ç„¶åï¼Œå¦‚æœä½ å†çœ‹ä¸€ä¸‹`.localstack/data/s3_api_calls.json`ï¼Œä½ ä¼šçœ‹åˆ°å®ƒå……æ»¡äº†å›¾åƒçš„äºŒè¿›åˆ¶æ•°æ®:

[![Image binary data](../Images/30a7db2c632afae707c07fc169106ff8.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--towKU0mr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/qcydypsebmmcb8r855jg.png)

**æœ€å**ï¼Œè®©æˆ‘ä»¬é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬çš„ä¸Šä¼ ä»ç„¶å·¥ä½œã€‚ä¸ºæ­¤ï¼Œè¿è¡Œ`docker restart localstack_demo`ã€‚é‡å¯åï¼Œè¿è¡Œ`docker logs -f localstack_demo`ã€‚è¿™å°†å‘æ‚¨æ˜¾ç¤ºå®¹å™¨çš„æ—¥å¿—(`-f`æ ‡å¿—å°†â€œè·Ÿéšâ€å®ƒä»¬)ã€‚

åœ¨åˆå§‹åŒ– Localstack ä¹‹åï¼Œå®ƒå°†é‡æ–°åº”ç”¨åœ¨`s3_api_calls.json`ä¸­æ‰¾åˆ°çš„ API è°ƒç”¨:

[![Localstack Logs](../Images/c5ac5000638ef70da04fa217434a1e3f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DDxb6DQb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ydjjg14zztr5vvqv9q6s.png)

å½“æ‚¨é‡æ–°åŠ è½½æµè§ˆå™¨æ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°å›¾åƒåƒä»¥å‰ä¸€æ ·å‡ºç°ã€‚

ğŸ‰å°±æ˜¯è¿™æ ·ï¼è°¢è°¢ä½ ç•™ä¸‹æ¥ã€‚è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªæ•™ç¨‹ï¼Œæˆ‘å¾ˆæƒ³çŸ¥é“ä½ çš„æƒ³æ³•ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼