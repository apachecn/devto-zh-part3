# å°†ç°æœ‰åŸé™…å®‰è£…å‡çº§åˆ°æ–°çš„å®‰è£…ç¨‹åº

> åŸæ–‡:[https://dev . to/firm house/upgrading-an-existing-intercity-installation-to-the-new-installer-1 cfk](https://dev.to/firmhouse/upgrading-an-existing-intercity-installation-to-the-new-installer-1cfk)

ä¸¤å¤©å‰ï¼Œæˆ‘å‘å¸ƒäº†ä¸€ä¸ªæ›´æ–°çš„æ›´ç®€å•çš„å®‰è£…æ–¹æ³•ï¼Œæˆ‘å°†å®ƒå‘å¸ƒåˆ°äº† Intercity çš„ä¸»åˆ†æ”¯:[æ›´æ–°äº† installing Intercity åˆ°ä¸€ä¸ªå‘½ä»¤](https://dev.to/firmhouse/updated-installing-intercity-to-a-single-command-3ah)ã€‚æ–°çš„å‘½ä»¤åœ¨å…¨æ–°çš„ LTS Ubuntu ä¸Šè¿è¡Œè‰¯å¥½ã€‚ğŸ•ºğŸ’ƒ

ç„¶è€Œï¼Œå¦‚æœä½ å·²ç»é€šè¿‡å‰é¢çš„ [docs/installation.md](https://github.com/intercity/intercity-next/blob/ba483a3ddbb63555834963abbff9efc88b04922e/doc/installation.md) ä¸­æè¿°çš„`intercity-server`å‘½ä»¤å®‰è£…äº† Intercityï¼Œä½ å°†ä¸å¾—ä¸æ‰§è¡Œä¸€äº›é¢å¤–çš„æ­¥éª¤ï¼Œå› ä¸ºæ•°æ®åº“è®¾ç½®æ˜¯ä¸åŒçš„ã€‚æ‚¨å¿…é¡»å°†å½“å‰çš„æ•°æ®åº“è¿ç§»åˆ°æ–°å®‰è£…çš„æ•°æ®åº“ä¸­ã€‚ä½ è‚¯å®šä¸æƒ³å¤±å»ä½ æ‰€æœ‰çè´µçš„åº”ç”¨ç¨‹åºé…ç½®è®¾ç½®å’Œç§˜å¯†ï¼

ä½ è¦åšçš„äº‹æƒ…å¦‚ä¸‹ã€‚æˆ‘å°†åœ¨ä¸‹é¢è¯¦ç»†è§£é‡Šæ¯ä¸ªæ­¥éª¤ã€‚

1.  é€šè¿‡`pg_dump`å¯¼å‡ºå½“å‰åŸé™…æ•°æ®åº“ã€‚
2.  åœæ­¢æ‚¨å½“å‰çš„åŸé™…å®‰è£…ã€‚
3.  é€šè¿‡æ–°çš„å®‰è£…ç¨‹åºå®‰è£…æ–°çš„åŸé™…åˆ—è½¦ã€‚
4.  å°†å…ˆå‰å®‰è£…çš„æ•°æ®åº“å¯¼å…¥æ–°å®‰è£…çš„æ•°æ®åº“ã€‚

åœ¨æ‰§è¡Œä¸Šè¿°æ­¥éª¤ä¹‹å‰:ç¡®ä¿æ‚¨æœ‰æœåŠ¡å™¨çš„å¤‡ä»½ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨æ‚¨çš„ VPS æä¾›å•†æˆ–äº‘çš„å¤‡ä»½/å¿«ç…§åŠŸèƒ½ã€‚

æ‚¨ä¹Ÿå¯ä»¥å°†ç›®å½•`/var/intercity/shared/postgres_data`å¤åˆ¶åˆ°`/var/intercity/shared/postgres_data_backup`ä¸­ï¼Œä¾‹å¦‚:

```
$ sudo cp -r /var/intercity/shared/postgres_data /var/intercity/shared/postgres_data_backup 
```

å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹å§:

## [](#export-the-current-database)å¯¼å‡ºå½“å‰æ•°æ®åº“

æŸ¥æ‰¾æ‚¨å½“å‰åŸé™…å®‰è£…çš„ Docker å®¹å™¨ ID:

```
$ sudo docker ps 
```

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:

```
db76d2869d40    local_intercity/app "/sbin/boot" 
```

â€œdb76d2869d40â€æ˜¯æ‚¨å½“å‰åŸé™…å®‰è£…çš„å®¹å™¨ IDã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªå‘½ä»¤ä¸­ä½¿ç”¨å®ƒæ¥è®¿é—®æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­çš„ shellï¼Œå¯¼å‡ºæ•°æ®åº“ï¼Œå¹¶å°†å…¶å¸¦å›æ‚¨çš„ä¸»æœºç³»ç»Ÿ:

```
$ sudo docker exec -it db76d2869d40 bash
(container) # su intercity
(container) $ cd /home/intercity
(container) $ pg_dump -U intercity -d intercity -f intercity.sql
(container) $ exit
(container) # cp /home/intercity/intercity.sql /shared
(container) # exit 
```

ç°åœ¨ï¼Œæ‚¨å·²ç»æˆåŠŸåœ°å°†æ•°æ®åº“ä»å½“å‰çš„åŸé™…ç¯å¢ƒå¯¼å‡ºåˆ°ä¸»æœºç³»ç»Ÿä¸Šçš„æ–‡ä»¶`intercity.sql`ä¸­ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­ä½¿ç”¨è¯¥æ–‡ä»¶å¯¼å…¥åˆ°æ‚¨çš„æ–°åŸé™…å®‰è£…ä¸­ã€‚

## [](#stop-your-current-installation)åœæ­¢å½“å‰å®‰è£…

æ‚¨å¯ä»¥ä½¿ç”¨åœ¨å‰é¢æ­¥éª¤ä¸­è·å–çš„å®¹å™¨ IDï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰å…¨åœ°åœæ­¢å½“å‰çš„åŸé™…:

```
$ sudo docker stop db76d2869d40 
```

## [](#install-intercity-via-the-new-installation-procedure)é€šè¿‡æ–°çš„å®‰è£…ç¨‹åºå®‰è£…åŸé™…

```
$ mkdir intercity
$ wget https://raw.githubusercontent.com/intercity/intercity-next/master/scripts/bootstrap.sh
$ sudo bash bootstrap.sh 
```

å‡ åˆ†é’Ÿåï¼Œæ‚¨çš„å®‰è£…æ­£åœ¨è¿è¡Œï¼Œâ€œåˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·â€å±å¹•åº”è¯¥åœ¨æ‚¨é…ç½®çš„åŸŸåä¸Šå¯è§ã€‚è¯·ç¡®è®¤æ‚¨çœ‹åˆ°äº†â€œåˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·â€å±å¹•ï¼Œä»¥ç¡®ä¿æ‚¨çš„æ–°å®‰è£…å®Œå…¨å¯åŠ¨ï¼

## [](#import-your-intercity-database)å¯¼å…¥æ‚¨çš„åŸé™…æ•°æ®åº“

ç°åœ¨æˆ‘ä»¬å°†æŠŠ`intercity.sql`æ•°æ®åº“å¯¼å…¥åˆ°æ–°çš„åŸé™…å®‰è£…ä¸­ã€‚

ä¸ºæ­¤ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
$ sudo -s
# cat /var/intercity/shared/intercity.sql | docker-compose exec db psql -U postgres -d intercity 
```

æ‚¨åº”è¯¥ä¼šåœ¨ç»ˆç«¯ä¸­çœ‹åˆ°å¾ˆå¤šè¾“å‡ºã€‚è¿™è¡¨ç¤ºæ­£åœ¨å¯¼å…¥æ•°æ®åº“ã€‚æ‚¨å¯èƒ½ä¼šåœ¨è¿™ä¸ªè¾“å‡ºä¸­çœ‹åˆ°å¾ˆå¤šé”™è¯¯ï¼Œå‘Šè¯‰æ‚¨å…³ç³»æˆ–ç´¢å¼•å·²ç»å­˜åœ¨ã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºæ¥è‡ªæ–°çš„åŸé™…å®‰è£…çš„å¹²å‡€å¼•å¯¼æ•°æ®åº“å·²ç»åˆ›å»ºäº†è¿™äº›ã€‚è¯¥å‘½ä»¤ç°åœ¨åªå¯¼å…¥æ•°æ®ã€‚

æ£€æŸ¥å¯¼å…¥æ˜¯å¦æˆåŠŸ:è½¬åˆ°æ‚¨çš„åŸé™…å®‰è£…æ‰€åœ¨çš„ URLã€‚æ‚¨ç°åœ¨åº”è¯¥å†æ¬¡çœ‹åˆ°å¸¸è§„ç™»å½•å±å¹•ï¼Œè€Œä¸æ˜¯â€œåˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·â€å±å¹•ã€‚å¦‚æœæ‚¨çœ‹åˆ°ç™»å½•å±å¹•:å¯¼å…¥æˆåŠŸï¼

* * *

å‰å®³ï¼æˆ‘å¸Œæœ›è¿™ä¸ªç¨‹åºå¯¹ä½ æœ‰ç”¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ–è€…å¦‚æœä½ å¾—åˆ°äº†é”™è¯¯:è®©æˆ‘çŸ¥é“ï¼