# ä½¿ç”¨ JWTã€Bcrypt å’Œ GraphQL Nexus å®ç°èº«ä»½éªŒè¯

> åŸæ–‡:[https://dev . to/novv um/implementing-authentic ation-using-jwt-bcrypt-and-graph QL-nexus-29n 6](https://dev.to/novvum/implementing-authentication-using-jwt-bcrypt-and-graphql-nexus-29n6)

æ‚¨å·²ç»å®Œæˆäº†åº”ç”¨ç¨‹åºæ¡†æ¶çš„ç¼–ç ï¼Œä½†æ˜¯è¿˜ç¼ºå°‘ä¸€æ ·ä¸œè¥¿â€”â€”èº«ä»½éªŒè¯ã€‚è¿™å¯ä»¥ä½¿ç”¨ [JSON Web ä»¤ç‰Œ](https://jwt.io/)å’Œ Bcrypt æ¥æ·»åŠ ã€‚å¯¹äºå¤§å¤šæ•°æ¨¡å¼æ„å»ºæ¡†æ¶æ¥è¯´ï¼Œæœ¬æ•™ç¨‹çš„åŸºç¡€åº”è¯¥æ˜¯ç›¸ä¼¼çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨ [GraphQL Nexus](https://nexus.js.org/) ã€‚æˆ‘ä»¬ä¹Ÿä½¿ç”¨ [Prisma](https://www.prisma.io/) ä½œä¸ºæˆ‘ä»¬çš„ ORMï¼Œä½†æ˜¯ä»»ä½•å…¶ä»–çš„ ORM æˆ–è€…æ•°æ®åº“ä¹Ÿå¯ä»¥ã€‚

æœ¬æ•™ç¨‹å‡è®¾æ‚¨äº†è§£ GraphQL çš„å˜å¼‚ã€æŸ¥è¯¢ã€è§£æå™¨å’Œä¸Šä¸‹æ–‡â€”â€”å¦‚æœæ‚¨ä¸äº†è§£ GraphQLï¼Œ [How to GraphQL](https://howtographql.com/) æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚

æœ€ç»ˆçš„åº”ç”¨ç¨‹åºå°†å…è®¸ç”¨æˆ·é€šè¿‡å­˜å‚¨å’Œä½¿ç”¨ JSON Web ä»¤ç‰Œæ¥åˆ›å»ºå¸æˆ·å’Œç™»å½•ã€‚jwt æ˜¯åŒ…å«è¦åœ¨å„æ–¹ä¹‹é—´ä¼ è¾“çš„ä¿¡æ¯çš„å­—ç¬¦ä¸²ï¼Œæ˜¯å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥å®‰å…¨åœ°å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å¹¶æä¾›æ•°å­—ç­¾åã€‚

æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†å…è®¸ç”¨æˆ·ä½¿ç”¨è¿™äº› jwt ç™»å½•å’Œæ³¨å†Œã€‚åœ¨åç«¯ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆè´Ÿè½½ï¼Œæ·»åŠ ä¸€ä¸ª JWT ç§˜å¯†ï¼Œå¹¶è®¾ç½®ç™»å½•å’Œæ³¨å†Œçªå˜ï¼Œä»¥æ­£ç¡®ç”Ÿæˆæˆæƒå¤´ã€‚åœ¨å‰ç«¯ï¼Œæˆ‘ä»¬å°†æŠŠä¸€ä¸ªæˆæƒä»¤ç‰Œä¼ é€’åˆ°æˆ‘ä»¬çš„å¤´ä¸­ï¼Œå¹¶è®¾ç½®æˆ‘ä»¬çš„æŸ¥è¯¢æ¥è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚

#### [](#backend)åç«¯

#### [](#1-installing-our-tools%C2%A0%F0%9F%9B%A0)1ã€‚å®‰è£…æˆ‘ä»¬çš„å·¥å…·ğŸ› 

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… Bcrypt å’Œ JSON Web ä»¤ç‰Œï¼

```
yarn add bcrypt jsonwebtoken 
```

ç°åœ¨ä½ å‡†å¤‡å¥½å»æŠ“ startedâœ¨äº†

#### [](#2-creating-our-jwt-secret%C2%A0)2ã€‚åˆ›é€ æˆ‘ä»¬æ™ºå¨æ±¤é€Šçš„ç§˜å¯†ğŸ—ï¸

æˆ‘ä»¬å¯ä»¥å»ºç«‹æˆ‘ä»¬çš„ JWT ç§˜å¯†â€”â€”åœ¨æˆ‘ä»¬çš„`config.ts`æ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†ä»¥ä¸‹å†…å®¹:

```
export default {  
  ...  
  jwt: {  
    JWT_SECRET: 'super-secret',  
  },  
} 
```

#### [](#3-creating-the-payload%C2%A0)3ã€‚åˆ›å»ºæœ‰æ•ˆè´Ÿè½½ğŸšš

ä¸ºäº†æ­£ç¡®åœ°å°†ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯è¿”å›ç»™è¯·æ±‚è€…ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆè´Ÿè½½ã€‚

```
export const UserLoginPayload = objectType({  
  name: 'UserLoginPayload',  
  definition: t =&gt; {  
    t.field('user', {  
      type: 'User',  
    })  
    t.string('token')  
  },  
}) 
```

æˆ‘ä»¬åœ¨è¿™é‡Œåšçš„æ˜¯åˆ›å»ºä¸€ä¸ªåä¸º`userLoginPayload`çš„å¯¹è±¡ç±»å‹ã€‚æˆ‘ä»¬å°†è¯¥ç±»å‹å®šä¹‰ä¸ºèƒ½å¤Ÿè¿”å›æˆ‘ä»¬çš„`User`å­—æ®µï¼Œä»¥åŠç”¨æˆ·æ³¨å†Œæˆ–ç™»å½•æ—¶ç”Ÿæˆçš„ä»¤ç‰Œã€‚

#### [](#4-setting-up-the-login-and-signup-mutations)4ã€‚è®¾ç½®ç™»å½•å’Œæ³¨å†Œçªå˜ğŸšªğŸš¶

ä¸ºäº†è®¾ç½®ç”¨æˆ·æ³¨å†Œå’Œç™»å½•ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ–°çš„å˜å¼‚å­—æ®µï¼Œ`userLogin`å’Œ`userRegister`ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿”å›ç±»å‹è®¾ç½®ä¸º`UserLoginPayload`æ¥è¿”å›`User`å’Œ`token`ï¼Œæˆ‘ä»¬çš„å‚æ•°æ˜¯ä»å‰ç«¯çš„ä¸€ä¸ªè¡¨å•ä¸­æ”¶é›†çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ä»¥ä¸‹æ˜¯ GraphQL Nexus ä¸­çš„çªå˜:

```
export const userLogin = mutationField('userLogin', {  
  type: UserLoginPayload,  
  args: {  
    username: stringArg({ required: true }),  
    password: stringArg({ required: true }),  
  },  
})

export const userRegister = mutationField('userRegister', {  
  type: UserLoginPayload,  
  args: {  
    username: stringArg({ required: true }),  
    password: stringArg({ required: true }),  
  },  
}) 
```

åœ¨è¿™ä¹‹åï¼Œä¸€ä¸ªè§£æå™¨è¢«æ·»åŠ åˆ°çªå˜ä¸­ã€‚

```
export const userLogin = mutationField('userLogin', {  
  type: UserLoginPayload,  
  args: {  
    username: stringArg({ required: true }),  
    password: stringArg({ required: true }),  
  },  
  resolve: async (root, args, context, info) =&gt; {  
    try {  
      const { password, ...user } = await context.prisma.user({  
        where: {  
          userName: args.username,  
        },  
      })  
      var validpass = await bcrypt.compareSync(args.password, password)  
      if (validpass) {  
        const token = jwt.sign(user, config.jwt.JWT_SECRET)  
        return {  
          user: user,  
          token,  
        }  
      }  
      return null  
    } catch (e) {  
      console.log(e)  
    }  
  },  
}) 
```

æˆ‘ä»¬å·²ç»æ·»åŠ äº†è§£æå™¨ã€‚è¿™å¯èƒ½æœ‰ç‚¹è®©äººä¸çŸ¥æ‰€æªï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒåˆ†æˆå‡ éƒ¨åˆ†ã€‚

```
const { password, ...user } = await context.prisma.user({  
        where: {  
          userName: args.username,  
        },  
      }) 
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¯•å›¾è·å¾—`User`æ•°æ®ã€‚`await context.prisma.users({where: {userName: args.username}`ä»æ•°æ®åº“ä¸­è·å–æˆ‘ä»¬çš„`User`ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯å­˜å‚¨åœ¨`password,Â ...user`ä¸­ã€‚æˆ‘ä»¬å·²ç»åˆ†ç¦»äº†å¯†ç ï¼Œå› æ­¤å®ƒä¸ä¼šåŒ…å«åœ¨æˆ‘ä»¬çš„ç”¨æˆ·å˜é‡æˆ– JSON Web ä»¤ç‰Œæ•°æ®ä¸­ï¼Œå¦‚ä¸‹ä¸€æ­¥æ‰€ç¤ºã€‚

```
var validpass = await bcrypt.compareSync(args.password, password)  
      if (validpass) {  
        const token = jwt.sign(user, config.jwt.JWT_SECRET)  
        return {  
          user: user,  
          token,  
        }  
      }  
      return null 
```

æˆ‘ä»¬ä½¿ç”¨ Bcrypt è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹æˆ‘ä»¬çš„å¯†ç å€¼æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœå¯†ç åŒ¹é…ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ JWT ç§˜å¯†å’Œ`user`ç”Ÿæˆä¸€ä¸ª JWTã€‚(å¦‚æœæˆ‘ä»¬æ²¡æœ‰äº‹å…ˆåˆ†ç¦»å¯†ç æ•°æ®ï¼Œå®ƒå°†ä¸ç”¨æˆ·æ•°æ®ä¸€èµ·è¿”å›å¹¶å­˜å‚¨åœ¨ JWT ä¸­ğŸ˜±ï¼)è™½ç„¶æœ€åï¼Œæˆ‘ä»¬ç°åœ¨è¿”å›æˆ‘ä»¬çš„æœ‰æ•ˆè½½è·(ä¸ JWT ä¸€èµ·çš„`user`æ•°æ®)ï¼

æ³¨å†Œçš„è¿‡ç¨‹ç›¸å¯¹ç±»ä¼¼ã€‚

```
export const userRegister = mutationField('userRegister', {  
  type: UserLoginPayload,  
  args: {  
    username: stringArg({ required: true }),  
    password: stringArg({ required: true }),  
  },  
  resolve: async (root, args, context) =&gt; {  
    try {  
      const existingUser = await context.prisma.user({  
        where: {  
          userName: args.username,  
        },  
      })  
      if (existingUser) {  
        throw new Error('ERROR: Username already used.')  
      }  
      var hash = bcrypt.hashSync(args.password, 10)

      const { password, ...register } = await context.prisma.createUser({  
        userName: args.username,  
        password: hash,  
      })  
      const token = jwt.sign(register, config.jwt.JWT_SECRET)  
      return {  
        user: register,  
        token: token,  
      }  
    } catch (e) {  
      console.log(e)  
      return null  
    }  
  },  
}) 
```

è®©æˆ‘ä»¬å†æ¥ä¸€æ¬¡ã€‚

```
const existingUser = await context.prisma.user({  
        where: {  
          userName: args.username,  
        },  
      })  
      if (existingUser) {  
        throw new Error('ERROR: Username already used.')  
      } 
```

ä¹‹å‰ï¼Œæˆ‘ä»¬æŸ¥è¯¢ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ã€‚è¿™ç›¸å¯¹æ¥è¯´æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ç°åœ¨å¦‚æœæœ‰ä¸œè¥¿è¿”å›ï¼Œæˆ‘ä»¬ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·åéƒ½åº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚

```
var hash = bcrypt.hashSync(args.password, 10)

      const { password, ...register } = await context.prisma.createUser({  
        userName: args.username,  
        password: hash,  
      }) 
```

æˆ‘ä»¬ä½¿ç”¨ bcrypt æ•£åˆ—ä¼ é€’ç»™è¡¨å•çš„å¯†ç ï¼Œä¼ é€’å¯†ç å’Œæˆ‘ä»¬æƒ³è¦ç”Ÿæˆçš„ salt é•¿åº¦ã€‚ä¹‹åï¼Œ`createUser`çªå˜ç”¨æˆ‘ä»¬çš„ç”¨æˆ·åå’Œæ–°æ•£åˆ—çš„å¯†ç åˆ›å»ºäº†ä¸€ä¸ªæ–°ç”¨æˆ·ã€‚

```
const token = jwt.sign(register, config.jwt.JWT_SECRET)  
      return {  
        user: register,  
        token: token,  
      } 
```

æœ‰æ•ˆè´Ÿè½½çš„ç”Ÿæˆå’Œè¿”å›æ–¹å¼ä¸ç”¨æˆ·ç™»å½•ç›¸åŒã€‚

#### [](#5-adding-user-to-the-context%C2%A0)5ã€‚å°†ç”¨æˆ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ğŸ§®

æˆ‘ä»¬çš„ç”¨æˆ·ç°åœ¨å¯ä»¥ç™»å½•å¹¶æ³¨å†Œäº†ï¼ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å’ŒæŸ¥çœ‹å™¨å­—æ®µæ¥å°†ä¿¡æ¯è¿”å›åˆ°å‰ç«¯ã€‚

è®©æˆ‘ä»¬ä»å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡å¼€å§‹ã€‚

```
export interface Context {  
  prisma: Prisma  
  currentUser: User  
}

export default async ({ req }) =&gt; {  
  const currentUser = await getUser(  
    req.get('Authorization'),  
    config.jwt,  
    prisma,  
  )  
  return {  
    prisma,  
    currentUser  
  }  
} 
```

è¿™é‡Œï¼Œæˆ‘ä»¬æ·»åŠ äº†ä»æˆ‘ä»¬çš„`Context`å¯¼å‡ºçš„`User`ç±»å‹çš„å˜é‡`currentUser`ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª`getUser`å‡½æ•°(æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€æ­¥è®¨è®ºå¦‚ä½•åˆ›å»ºè¿™ä¸ªå‡½æ•°â€”â€”æ€»ä¹‹ï¼Œå®ƒè¿”å›æˆ‘ä»¬çš„`User`ç±»å‹)é€šè¿‡ä¼ å…¥æˆ‘ä»¬çš„å¸¦æœ‰`req.get('Authorization')`çš„ä»¤ç‰Œ(å®ƒä»æˆ‘ä»¬çš„å¤´ä¸­è·å–æˆ‘ä»¬çš„ä»¤ç‰Œ)ã€æˆ‘ä»¬çš„ JWT ç§˜å¯†å’Œ Prisma å®¢æˆ·ç«¯æ¥è¿”å›æˆ‘ä»¬çš„ç”¨æˆ·ä¿¡æ¯ã€‚

#### [](#6-creating-a-getuser-function%C2%A0)6ã€‚åˆ›å»º getUser å‡½æ•°ğŸ‘¶

å› ä¸ºæˆ‘ä»¬å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»æ¶ˆæ¯å¤´ä¸­è·å–ç”¨æˆ·çš„ä»¤ç‰Œã€‚

```
export default async (authorization, secrets, prisma: Prisma) =&gt; {  
  const bearerLength = 'Bearer '.length  
  if (authorization && authorization.length &gt; bearerLength) {  
    const token = authorization.slice(bearerLength)  
    const { ok, result } = await new Promise(resolve =&gt;  
      jwt.verify(token, secrets.JWT_SECRET, (err, result) =&gt; {  
        if (err) {  
          resolve({  
            ok: false,  
            result: err,  
          })  
        } else {  
          resolve({  
            ok: true,  
            result,  
          })  
        }  
      }),  
    )  
    if (ok) {  
      const user = await prisma.user({  
        id: result.id,  
      })  
      return user  
    } else {  
      console.error(result)  
      return null  
    }  
  }  
  return null  
} 
```

è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ã€‚

```
const bearerLength = 'Bearer '.length  
  if (authorization && authorization.length &gt; bearerLength) {  
    const token = authorization.slice(bearerLength)  
    ...  
  }  
  return null  
} 
```

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€äº›åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥æ¥æŸ¥çœ‹ä»¤ç‰Œæ˜¯å¦æ¯”æˆ‘ä»¬çš„`Bearer`å­—ç¬¦ä¸²é•¿â€”â€”å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ‡æ‰`Bearer`å­—ç¬¦ä¸²æ¥æå–ä»¤ç‰Œã€‚

```
const { ok, result } = await new Promise(resolve =&gt;  
      jwt.verify(token, secrets.JWT_SECRET, (err, result) =&gt; {  
        if (err) {  
          resolve({  
            ok: false,  
            result: err,  
          })  
        } else {  
          resolve({  
            ok: true,  
            result,  
          })  
        }  
      })  
    ) 
```

ç°åœ¨æˆ‘ä»¬ç”¨æˆ‘ä»¬çš„ç§˜å¯†æ¥éªŒè¯ä»¤ç‰Œï¼Œå¹¶ç”¨ä¼ å…¥çš„ä»¤ç‰Œä»¥åŠæ¥è‡ªæˆ‘ä»¬çš„ JWT çš„`result`(è¿™æ˜¯æˆ‘ä»¬çš„`user`ç±»å‹)æ¥è§£ææˆ‘ä»¬çš„æ‰¿è¯ºã€‚

```
if (ok) {  
      const user = await prisma.user({  
        id: result.id,  
      })  
      return user  
    } else {  
      console.error(result)  
      return null  
    }  
  } 
```

æœ€åï¼Œå¦‚æœä»¤ç‰Œæœ‰æ•ˆï¼Œæˆ‘ä»¬ç”¨ä»ä»¤ç‰Œè·å¾—çš„ id æŸ¥è¯¢ç”¨æˆ·ï¼Œå¹¶è¿”å›å®ƒï¼

#### [](#7-creating-a-user-query-and-viewer-field%C2%A0)7ã€‚åˆ›å»ºç”¨æˆ·æŸ¥è¯¢å’ŒæŸ¥çœ‹å™¨å­—æ®µğŸ”¬

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŸ¥çœ‹å™¨å­—æ®µå’Œç”¨æˆ·æŸ¥è¯¢ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­æŸ¥è¯¢å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ã€‚

```
t.string('getCurrentUser', {  
  resolve: async (root, args, context, info) =&gt; {  
    return context.prisma.user  
  },  
}) 
```

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„æŸ¥è¯¢ï¼Œ`getCurrentUser`â€”â€”è¿™å°†è¿”å›æˆ‘ä»¬åœ¨`Context`å‡½æ•°ä¸­å¾—åˆ°çš„å€¼ï¼Œè¿™æ ·æˆ‘ä»¬ç°åœ¨å°±å¯ä»¥æ–¹ä¾¿åœ°æŸ¥è¯¢å½“å‰ç™»å½•çš„ç”¨æˆ·äº†ï¼

æœ€åï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æŸ¥è¯¢ä¸­æ·»åŠ ä¸€ä¸ª`viewer`å­—æ®µã€‚

```
t.field('viewer', {  
      type: 'User',  
      nullable: true,  
      resolve: (root, args, context) =&gt; {  
        return context.currentUser  
      },  
    }) 
```

è¿™åªæ˜¯è¿”å›æˆ‘ä»¬æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­çš„`currentUser`ã€‚

#### [](#frontend)å‰ç«¯

#### [](#1-login-and-registration)1ã€‚ç™»å½•å’Œæ³¨å†ŒğŸ’

æ—¢ç„¶æˆ‘ä»¬çš„åç«¯å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åœ¨åç«¯åˆ›å»ºçš„è§£æå™¨å®ç°ä¸€ä¸ªç®€å•çš„å‰ç«¯è§£å†³æ–¹æ¡ˆã€‚

```
const SIGNUP_MUTATION = gql`  
  mutation UserRegister($username: String!, $password: String!) {  
    userRegister(username: $username, password: $password) {  
      user {  
        id  
        userName  
      }  
      token  
    }  
  }  
`; 
```

è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„æ³¨å†Œå˜å¼‚ï¼Œåœ¨æäº¤è¡¨å•æ—¶åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·ã€‚æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬åœ¨åç«¯åˆ›å»ºçš„`userRegister`å‡½æ•°ï¼Œç®€å•åœ°ä¼ é€’ç”¨æˆ·åå’Œå¯†ç ï¼ŒåŒæ—¶è¿”å›ä»»ä½•æƒ³è¦çš„ä¿¡æ¯ã€‚

```
&lt;Mutation  
    mutation={SIGNUP_MUTATION}  
    onCompleted={data =&gt; _confirm(data)}  
  &gt;  
...  
&lt;/Mutation&gt; 
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ³¨å†Œçªå˜æ·»åŠ åˆ°ç”±`react-apollo`æä¾›çš„`Mutation`ç»„ä»¶ä¸­ã€‚å½“å˜å¼‚å®Œæˆåï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå‡½æ•°ä¸º`_confirm`ã€‚

```
_confirm = async data =&gt; {  
  const { token } = data.userLogin;  
  this._saveUserData(token);  
};

_saveUserData = async token =&gt; {  
  try {  
    await AsyncStorage.setItem(AUTH_TOKEN, token);  
  } catch (e) {  
    console.log("ERROR: ", e);  
  }  
}; 
```

æˆ‘ä»¬çš„`_confirm`å‡½æ•°æ‰€åšçš„æ˜¯è·å–æˆ‘ä»¬ä»çªå˜ä¸­è¿”å›çš„`data`ï¼Œå¹¶ä»ä¸­æå–ä»¤ç‰Œï¼Œå°†å…¶ä¼ é€’ç»™`_saveUserData`ã€‚è¿™ä¸ªå‡½æ•°å°†`token`å­˜å‚¨åœ¨`AsyncStorage`ä¸­(å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨ Native å¼€å‘ï¼Œä»¤ç‰Œå°†å­˜å‚¨åœ¨`LocalStorage`)ã€‚

è­¦å‘Š:é¡ºä¾¿æä¸€ä¸‹ï¼Œä½¿ç”¨ localStorage æ¥å­˜å‚¨æˆ‘ä»¬çš„ JWT å¹¶ä¸æ˜¯ç”Ÿäº§ä¸­çš„æœ€ä½³å®è·µâ€”â€”ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šç›¸å…³å†…å®¹ã€‚

ç™»å½•çš„è¿‡ç¨‹éå¸¸ç›¸ä¼¼ï¼Œæˆ‘ä»¬åªéœ€ç”¨æˆ‘ä»¬çš„`LOGIN_MUTATION`æ›¿æ¢æ‰æˆ‘ä»¬çš„`SIGNUP_MUTATION`ã€‚

#### [](#2-inserting-the-token-into-the-header%C2%A0)2ã€‚å°†ä»¤ç‰Œæ’å…¥æŠ¥å¤´ğŸ’¯

```
const authLink = setContext(async (_, { headers }) =&gt; {  
  const token = await AsyncStorage.getItem(AUTH_TOKEN);  
  return {  
    headers: {  
      ...headers,  
      authorization: token ? `Bearer ${token}` : ""  
    }  
  };  
}); 
```

æˆ‘ä»¬ä½¿ç”¨`apollo-link-context`çš„`setContext`å‡½æ•°æ¥è®¾ç½®åº”ç”¨ç¨‹åºçš„æ ‡é¢˜ã€‚æˆ‘ä»¬ä»`AsyncStorage`è·å–æˆæƒä»¤ç‰Œï¼Œç„¶åå°†å®ƒå­˜å‚¨åœ¨æˆ‘ä»¬çš„å¤´ä¸­ã€‚

#### [](#3-querying-for-user-info%C2%A0)3ã€‚æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ğŸ™†

ç”±äºæˆ‘ä»¬æ‰€æœ‰çš„è¾›å‹¤å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹æŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯â€”â€”æ˜¯çš„ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼

```
const GET_USER = gql`  
  query getUser {  
    viewer {  
      id  
    }  
  }  
`; 
```

#### [](#conclusion)ç»“è®º

è‡³æ­¤ï¼Œæ‚¨çš„èº«ä»½éªŒè¯è®¾ç½®å®Œæ¯•ï¼æˆ‘ä»¬ç°åœ¨å·²ç»åˆ›å»ºäº†è§£æå™¨æ¥è¿”å›æ‰€éœ€çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹æŸ¥è¯¢å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚æœ¬æ•™ç¨‹çš„çµæ„Ÿæ¥è‡ªæ–¯æ½˜å¡Â·å¡è‰çš„ä¼Ÿå¤§æ•™ç¨‹ï¼Œ[graph QL authentic ation with React Native&Apollo](https://medium.com/handlebar-labs/graphql-authentication-with-react-native-apollo-part-1-2-9613aacd80b3)â€”â€”å¦‚æœä½ æƒ³æ›´æ·±å…¥åœ°äº†è§£æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹ä¸­è®¨è®ºçš„å†…å®¹ï¼Œå¯ä»¥çœ‹ä¸€çœ‹ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·éšæ—¶å‘è¡¨è¯„è®ºï¼Œé€šè¿‡ [Twitter](http://twitter.com/novvumio) è”ç³»æˆ‘ä»¬ï¼Œæˆ–è€…é€šè¿‡[æˆ‘ä»¬çš„ç½‘ç«™](http://novvum.io)è”ç³»æˆ‘ä»¬ã€‚è°¢è°¢å¤§å®¶ï¼