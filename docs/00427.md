# reduce/inject ä¸­çš„æ§åˆ¶æµ(ruby)

> åŸæ–‡:[https://dev . to/XP bytes/control-flow-in-reduce-inject-ruby-25 B4](https://dev.to/xpbytes/control-flow-in-reduce-inject-ruby-25b4)

[`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) ( [`inject`](https://ruby-doc.org/core/Enumerable.html#method-i-inject) )æ˜¯å­˜åœ¨äº[å¯æšä¸¾](https://ruby-doc.org/core/Enumerable.html)æ¨¡å—ä¸Šçš„æœ€å¼ºå¤§çš„
æ–¹æ³•ä¹‹ä¸€ï¼Œè¿™æ„å‘³ç€
æ–¹æ³•å¯ç”¨äºåŒ…å«è¯¥æ¨¡å—çš„ä»»ä½•ç±»çš„ä»»ä½•å®ä¾‹ï¼Œ
åŒ…æ‹¬[æ•°ç»„](https://ruby-doc.org/core/Array.html)ï¼Œ[æ•£åˆ—](https://ruby-doc.org/core/Hash.html)ï¼Œ[é›†åˆ](https://ruby-doc.org/stdlib/libdoc/set/rdoc/Set.html)å’Œ
[èŒƒå›´](https://ruby-doc.org/core/Range.html)ã€‚

[`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) å¯ä»¥ç”¨åœ¨ [MapReduce](https://en.wikipedia.org/wiki/MapReduce) è¿‡ç¨‹ä¸­ï¼Œ
é€šå¸¸æ˜¯ç†è§£çš„åŸºç¡€ï¼Œæ˜¯å¯¹å€¼è¿›è¡Œåˆ†ç»„çš„å¥½æ–¹æ³•ï¼Œæˆ–è€…
è®¡ç®—å•ä¸ªå€¼(*å°†ä¸€ç»„å€¼å‡å°‘ä¸ºå•ä¸ªå€¼*)ç»™å®šä¸€ç»„
å€¼ã€‚

è¿™ç¯‡æ–‡ç« å¿«é€Ÿåœ°å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€æ¬¡ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) è¿­ä»£ä¸­è·³è¿‡å€¼/æœ‰æ¡ä»¶åœ°è¿”å›å€¼
ï¼Œä»¥åŠå¦‚ä½•æå‰ä¸­æ–­/è¿”å›ä¸€ä¸ª
ä¸åŒçš„å€¼å¹¶åœæ­¢è¿­ä»£ã€‚

[![Bridge In The Mist in Stockholm, Sweden](../Images/619839551ed119c7d00044480030e1bb.png "Photo by Anders JildÃ©n (https://unsplash.com/@andersjilden) on Unsplash (https://unsplash.com/)")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DWl4tjEV--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/6h5h6rrr3zuvh7sudfni.jpg)

## [](#recap)é‡è¿°ğŸ’¬

ä»æ–‡æ¡£ä¸­ï¼Œç»™å‡ºä¸€ä¸ªå®ä¾‹`enum`(ä¸€ä¸ª**å¯æšä¸¾**)è°ƒç”¨
`enum.reduce`:

```
# Combines all elements of <i>enum</i> by applying a binary
# operation, specified by a block or a symbol that names a
# method or operator. 
```

ä½¿ç”¨ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) çš„ä¸€ä¸ªä¾‹å­æ˜¯ç¼–å†™ä¸€ä¸ªå¯¹é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ æ±‚å’Œçš„å‡½æ•°:

```
##
# Sums each item in the enumerable (naive)
#
# @param [Enumerable] enum the enumeration of items to sum
# @return [Numeric] the sum
#
def summation(enum)
  sum = 0
  enum.each do |item|
    sum += item
  end
  sum
end

##
# Sums each item in the enumerable (reduce block)
#
# Each iteration the result of the block is the passed in previous_result.
#
# @param [Enumerable] enum the enumeration of items to sum
# @return [Numeric] the sum
#
def summation(enum)
  enum.reduce do |previous_result, item|
    previous_result + item
  end
end

##
# Sums each item in the enumerable (reduce method)
#
# Each iteration the :+ symbol is sent as a message to the current result with
# the next value as argument. The result is the new current result.
#
# @param [Enumerable] enum the enumeration of items to sum
# @return [Numeric] the sum
#
def summation(enum)
  enum.reduce(:+)
end

##
# Alias for enum.sum
#
def summation(enum)
  enum.sum
end 
```

[`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) å–ä¸€ä¸ªå¯é€‰çš„åˆå§‹å€¼ï¼Œç”¨æ¥ä»£æ›¿
é›†åˆçš„ç¬¬ä¸€é¡¹ï¼Œå½“ç»™å®šæ—¶ã€‚

## [](#how-to-control-the-flow)å¦‚ä½•æ§åˆ¶æµé‡ï¼Ÿ

å½“ä¸ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) ä¸€èµ·å·¥ä½œæ—¶ï¼Œä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±å¤„äºä¸¤ç§
æƒ…å†µä¹‹ä¸€:

*   æ‚¨å¸Œæœ›æœ‰æ¡ä»¶åœ°ä¸ºè¿­ä»£è¿”å›ä¸€ä¸ªä¸åŒçš„å€¼(ç”¨ä½œä¸‹ä¸€æ¬¡è¿­ä»£çš„åŸºç¡€å€¼)
*   æ‚¨å¸Œæœ›å°½æ—©çˆ†å‘(å®Œå…¨åœæ­¢è¿­ä»£)

### [](#next-%E2%8F%AD)æ¥ä¸‹æ¥â­

`next`å…³é”®å­—å…è®¸ä½ ä»`yield`å—æå‰è¿”å›ï¼Œè¿™æ˜¯ä»»ä½•æšä¸¾çš„
æƒ…å†µã€‚

æ¯”æ–¹è¯´ä½ å¯¹ä¸€ç»„æ•°å­—æ±‚å’Œï¼Œä½†è¦å¯¹ä»»æ„ **æ•°å­—çš„**ä¸€åŠ**ï¼Œä»¥åŠä»»æ„**å¥‡æ•°**æ•°å­—çš„**ä¸€åŠ**:**

 **```
def halfly_even_doubly_odd(enum)
  enum.reduce(0) do |result, i|
    result + i * (i.even? ? 0.5 : 2)
  end
end 
```

ä¸ç®—å¤ªåã€‚ä½†æ˜¯ç°åœ¨ï¼Œå¦ä¸€ä¸ªä¸šåŠ¡éœ€æ±‚å‡ºç°äº†ï¼Œå®ƒè¦æ±‚è·³è¿‡ 5:

```
def halfly_even_doubly_odd(enum)
  enum.reduce(0) do |result, i|
    if i < 5
      result
    else
      result + i * (i.even? ? 0.5 : 2)
    end
  end
end 
```

å‘ƒã€‚è¿™ä¸æ˜¯å¾ˆå¥½çš„ ruby ä»£ç ã€‚ä½¿ç”¨`next`å®ƒå¯èƒ½çœ‹èµ·æ¥åƒ:

```
def halfly_even_doubly_odd(enum)
  enum.reduce(0) do |result, i|
    next result if i < 5
    next result + i * 0.5 if i.even?
    result + i * 2
  end
end 
```

`next`åœ¨ä»»ä½•æšä¸¾ä¸­éƒ½æœ‰æ•ˆï¼Œæ‰€ä»¥å¦‚æœä½ åªæ˜¯ä½¿ç”¨
T1 å¤„ç†é¡¹ç›®ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒ:

```
(1..10).each do |num|
  next if num.odd?
  puts num
end
# 2
# 4
# 6
# 8
# 10
# => 1..10 
```

### [](#break)å‡»ç ´ğŸ›‘

ä¸ç”¨è·³åˆ°ä¸‹ä¸€é¡¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`break`å®Œå…¨åœæ­¢ä¸€ä¸ª
æšä¸¾å™¨çš„è¿­ä»£ã€‚

å¦‚æœæˆ‘ä»¬æœ‰å’Œä»¥å‰ä¸€æ ·çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»è¿”å›
å· **42** å¦‚æœé¡¹ç›®æ˜¯*æ­£å¥½ 7* ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒè¿™æ ·:

```
def halfly_even_doubly_odd(enum)
  enum.reduce(0) do |result, i|
    break 42 if i == 7
    next result if i < 5
    next result + i * 0.5 if i.even?
    result + i * 2
  end
end 
```

åŒæ ·ï¼Œè¿™é€‚ç”¨äºä»»ä½•å¾ªç¯ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ find æ¥å°è¯• [`find`](https://ruby-doc.org/core/Enumerable.html#method-i-find)
æšä¸¾ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶å¸Œæœ›*æ›´æ”¹é‚£ä¸ª
`find`çš„`return`å€¼*ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`break`æ¥è¿™æ ·åš:

```
def find_my_red_item(enum)
  enum.find do |item|
    break item.name if item.color == 'red'
  end
end

find_my_red_item([
  { name: "umbrella", color: "black" },
  { name: "shoe", color: "red" },
  { name: "pen", color: "blue" }
])
# => 'shoe' 
```

### [](#stopiteration)åœæ­¢è¿­ä»£

ä½ å¯èƒ½å¬è¯´è¿‡æˆ–è€…çœ‹è¿‡ [`raise StopIteration`](https://ruby-doc.org/core/StopIteration.html) ã€‚
è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥åœæ­¢æšä¸¾çš„è¿­ä»£ï¼Œ
å› ä¸ºå®ƒè¢« [`Kernel#loop`](https://ruby-doc.org/core/Kernel.html#method-i-loop) æ•è·ï¼Œä½†æ˜¯å®ƒçš„ç”¨ä¾‹è¢«é™åˆ¶ä¸º
æ‚¨ä¸åº”è¯¥è¯•å›¾ä½¿ç”¨`raise`æˆ– [`fail`](https://ruby-doc.org/core/Kernel.html#method-i-fail) æ¥æ§åˆ¶æµç¨‹ã€‚
[airbrake åšå®¢](https://airbrake.io/blog/ruby-exception-handling/stopiteration)æœ‰ä¸€ç¯‡å…³äºè¿™ä¸ª
ç”¨ä¾‹çš„[å¥½æ–‡ç« ](https://airbrake.io/blog/ruby-exception-handling/stopiteration)ã€‚

## [](#when-to-use-reduce)ä½•æ—¶ä½¿ç”¨ reduce

å¦‚æœä½ éœ€è¦ä¸€ä¸ªä½•æ—¶ä½¿ç”¨ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) çš„æŒ‡å—ï¼Œä¸ç”¨å†æ‰¾äº†ã€‚æˆ‘
ç”¨è¿™å››æ¡è§„åˆ™æ¥å†³å®šæˆ‘æ˜¯éœ€è¦ç”¨ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) è¿˜æ˜¯
[`each_with_object`](https://ruby-doc.org/core/Enumerable.html#method-i-each_with_object) è¿˜æ˜¯åˆ«çš„ä»€ä¹ˆã€‚

æˆ‘ç”¨ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) å½“:

*   *å°†*ä¸ªå€¼çš„é›†åˆå‡å°‘åˆ°ä¸€ä¸ª**æ›´å°çš„**ç»“æœ(ä¾‹å¦‚ 1 ä¸ªå€¼)
*   *åˆ†ç»„*å€¼çš„é›†åˆ(å¦‚æœå¯èƒ½ï¼Œä½¿ç”¨ [`group_by`](https://ruby-doc.org/core/Enumerable.html#method-i-group_by)
*   *æ”¹å˜*ä¸å¯å˜åŸè¯­/å€¼å¯¹è±¡(è¿”å›æ–°å€¼)
*   ä½ éœ€è¦ä¸€ä¸ª*æ–°å€¼*(ä¾‹å¦‚æ–°çš„[æ•°ç»„](https://ruby-doc.org/core/Array.html)æˆ–[æ•£åˆ—](https://ruby-doc.org/core/Hash.html))

### [](#alternatives)æ›¿ä»£å“ğŸ”€

å½“ç”¨ä¾‹ä¸ä¸Šé¢çš„æŒ‡å¯¼æ–¹é’ˆä¸åŒ¹é…æ—¶ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘
å®é™…ä¸Šéœ€è¦ [`each_with_object`](https://ruby-doc.org/core/Enumerable.html#method-i-each_with_object) ï¼Œå®ƒå…·æœ‰ç±»ä¼¼çš„
ç­¾åï¼Œä½†æ˜¯ä¸åŸºäºå—çš„`return`å€¼æ„å»ºæ–°å€¼ï¼Œ
è€Œæ˜¯ä½¿ç”¨é¢„å®šä¹‰çš„â€œå¯¹è±¡â€è¿­ä»£é›†åˆï¼Œä½¿å¾—åœ¨å—å†…ä½¿ç”¨é€»è¾‘æ›´åŠ å®¹æ˜“
:

```
doubles = (1..10).each_with_object([]) do |num, result|
  result << num* 2
  # same as result.push(num * 2)
end
# => [2, 4, 6, 8, 10, 12, 14, 16, 18, 20]

doubles_over_ten = (1..10).each_with_object([]) do |num, result|
  result << num * 2 if num > 5
end
# => [12, 14, 16, 18, 20] 
```

ä½¿ç”¨ [`each_with_object`](https://ruby-doc.org/core/Enumerable.html#method-i-each_with_object) æ—¶:

*   æ„å»ºæ–°çš„å®¹å™¨(ä¾‹å¦‚[æ•°ç»„](https://ruby-doc.org/core/Array.html)æˆ–[æ•£åˆ—](https://ruby-doc.org/core/Hash.html))ã€‚**æ³¨æ„**ä½ ä¸æ˜¯çœŸçš„*å‡å°‘*å½“å‰é›†åˆåˆ°ä¸€ä¸ª*æ›´å°çš„*ç»“æœï¼Œè€Œæ˜¯æœ‰æ¡ä»¶æˆ–æ— æ¡ä»¶çš„*æ˜ å°„*å€¼ã€‚
*   æ‚¨å¸Œæœ›å—ä¸­çš„é€»è¾‘ä¸é‡å¤ç»“æœå€¼(å› ä¸ºåœ¨ä½¿ç”¨ [`reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce) æ—¶ï¼Œæ‚¨çš„*å¿…é¡»*æä¾›ä¸€ä¸ªè¿”å›å€¼)

## [](#my-use-case)æˆ‘çš„ç”¨ä¾‹

æˆ‘ä½¿ç”¨`reduce`ç ”ç©¶æ§åˆ¶æµçš„åŸå› æ˜¯å› ä¸ºæˆ‘æ­£åœ¨é€šè¿‡è¡¨ç¤ºè¿ç§»è·¯å¾„çš„å€¼å¯¹è±¡åˆ—è¡¨è¿­ä»£
ã€‚åœ¨ä¸ä½¿ç”¨
[`lazy`](https://ruby-doc.org/core/Enumerator/Lazy.html) çš„æƒ…å†µä¸‹ï¼Œæˆ‘æƒ³è¦ä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥è¡¨ç¤ºè¿™äº›
è¿ç§»åº”è¯¥ä½•æ—¶è¿è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨äº†è¯­ä¹‰ç‰ˆæœ¬æ§åˆ¶ã€‚å¯æšä¸¾çš„è¿ç§»æ˜¯ä¸€ä¸ªé™„æœ‰è¯­ä¹‰ç‰ˆæœ¬çš„è¿ç§»æ’åºåˆ—è¡¨ã€‚

```
migrations.reduce(input) do |migrated, (version, migration)|
  migrated = migration.call(migrated)
  next migrated unless current_version.in_range?(version)
  break migrated
end 
```

å‡½æ•°`in_range?`åŸºäº
å½“å‰â€œè¾“å…¥â€ç‰ˆæœ¬å’Œè¿ç§»çš„è¯­ä¹‰ç‰ˆæœ¬æ¥ç¡®å®šæ˜¯å¦æ‰§è¡Œè¿ç§»ã€‚è¿™å°†
æ‰§è¡Œè¿ç§»ï¼Œç›´åˆ°â€œå½“å‰â€ç‰ˆæœ¬åœ¨èŒƒå›´å†…ï¼Œæ­¤æ—¶
å°†æ‰§è¡Œæœ€ç»ˆè¿ç§»å¹¶åœæ­¢ã€‚

æ›¿ä»£æ–¹æ¡ˆä¸å¤ªæœ‰åˆ©:

*   [`take_while`](https://ruby-doc.org/core/Enumerable.html#method-i-take_while) ã€ [`select`](https://ruby-doc.org/core/Enumerable.html#method-i-select) å’Œå¥½å‹èƒ½å¤Ÿ*è¿‡æ»¤*åˆ—è¡¨ï¼Œä½†æ˜¯éœ€è¦å¤šæ¬¡è¿­ä»£è¿ç§»é›†åˆ(è¿‡æ»¤ï¼Œç„¶åâ€œæ‰§è¡Œâ€)ï¼›
*   [`find`](https://ruby-doc.org/core/Enumerable.html#method-i-find) å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯æˆ‘éœ€è¦æ›´æ”¹è¾“å…¥ï¼Œè¿™å°†è¦æ±‚æˆ‘æœ‰ä¸€ä¸ªç°¿è®°å˜é‡æ¥è·Ÿè¸ªâ€œè¿ç§»â€ã€‚åœ¨ Ruby ä¸­ï¼Œç°¿è®°å˜é‡å‡ ä¹æ˜¯ä¸å¿…è¦çš„ã€‚

[![Photo called "Itâ€™s Own Kind of Tranquility", displaying a series of windmills on either side of a 'water street (canal)' in Alblasserdam, The Netherlands](../Images/16e5c8d87b0b4eb0d0d19f6b98451244.png "Photo by Vishwas Katti (https://unsplash.com/@vishkatti) on Unsplash (https://unsplash.com/)")T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--h_3a0nUn--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/rdbjr94rx7rp3ftw3rl0.jpg)

## [](#reference)å¼•ç”¨

*   [æ•°ç»„](https://ruby-doc.org/core/Array.html)
*   [å¯æšä¸¾](https://ruby-doc.org/core/Enumerable.html)
*   [å¯æšä¸¾# `each_with_object`](https://ruby-doc.org/core/Enumerable.html#method-i-each_with_object)
*   [å¯æšä¸¾# `find`](https://ruby-doc.org/core/Enumerable.html#method-i-find)
*   [å¯æšä¸¾# `group_by`](https://ruby-doc.org/core/Enumerable.html#method-i-group_by)
*   [å¯æšä¸¾# `inject`](https://ruby-doc.org/core/Enumerable.html#method-i-inject)
*   [å¯æšä¸¾# `lazy`](https://ruby-doc.org/core/Enumerator/Lazy.html)
*   [å¯æšä¸¾# `reduce`](https://ruby-doc.org/core/Enumerable.html#method-i-reduce)
*   [å¯æšä¸¾# `select`](https://ruby-doc.org/core/Enumerable.html#method-i-select)
*   [å¯æšä¸¾# `take_while`](https://ruby-doc.org/core/Enumerable.html#method-i-take_while)
*   [å“ˆå¸Œ](https://ruby-doc.org/core/Hash.html)
*   [å†…æ ¸# `fail`](https://ruby-doc.org/core/Kernel.html#method-i-fail)
*   [å†…æ ¸# `loop`](https://ruby-doc.org/core/Kernel.html#method-i-loop)
*   [èŒƒå›´](https://ruby-doc.org/core/Range.html)
*   [è®¾ç½®](https://ruby-doc.org/stdlib/libdoc/set/rdoc/Set.html)
*   [åœæ­¢è¿­ä»£](https://ruby-doc.org/core/StopIteration.html)**