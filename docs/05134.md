# è¯·ä¸è¦ç© proxyquire äº†

> åŸæ–‡:[https://dev . to/the kashey/please-stop-playing-with-proxy quire-11j 4](https://dev.to/thekashey/please-stop-playing-with-proxyquire-11j4)

> åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰:æˆ‘æ˜¯ 3 ä¸ªç”·å­©çš„çˆ¶äº²ï¼Œä»–ä»¬ç»å¸¸â€œ*ç©*â€ã€‚æˆ‘å–œæ¬¢çœ‹ä»–ä»¬æ€ä¹ˆç©ï¼Œä½†æ˜¯ä»–ä»¬å¹¶ä¸æ€»æ˜¯ä»¥ä¸€ç§å®‰é™çš„ç”šè‡³æ˜¯ T2 å®‰å…¨çš„æ–¹å¼ç©ã€‚æˆ‘ä»¬éƒ½æ˜¯å­©å­ï¼Œä½ çŸ¥é“ä¼šæ€æ ·ã€‚å­©å­ä»¬ä¸èƒ½åªæ˜¯åç€ï¼Œä¸èƒ½åœä¸‹æ¥ï¼Œä¸èƒ½å¬ã€‚æ”¾æ¾ï¼Œæˆ‘åªæ˜¯åœ¨å¼€ç©ç¬‘...

...æ‹œæ‰˜ï¼Œåˆ«ç© proxyquire äº†ã€‚åŸå› å¾ˆç®€å•æ˜äº†â€”â€”æ˜¯æ—¶å€™åœæ­¢ç©æ¸¸æˆäº†ã€‚ä¸ºäº†è§£é‡Š*æ¸¸æˆ*çš„å«ä¹‰ï¼Œæˆ‘åº”è¯¥è¦æ±‚ä½ åœæ­¢ä½¿ç”¨å¦ä¸€ä¸ªåº“- [rewire](https://github.com/jhnns/rewire) ã€‚å˜¿ï¼Œå­©å­ä»¬ï¼Œè¿™ä¸å†æœ‰è¶£äº†ã€‚

> æ˜¯æ—¶å€™åœæ­¢å½“å­©å­ï¼Œæ¥å—è´£ä»»äº†ã€‚ä¸ºäº†ä»€ä¹ˆï¼Ÿä¸ºä½ æ‹¥æœ‰çš„ä»£ç ï¼Œä¹Ÿä¸ºä½ å†™çš„ä»£ç ã€‚

æˆ‘ä»¬å…ˆææ¸…æ¥šä¸ºä»€ä¹ˆä½ å¯èƒ½ä¼šç”¨è¿™äº›`proxyquire`å’Œ`rewire`ï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªâ€œç”¨â€æ— éå°±æ˜¯å¼€ä¸ªç©ç¬‘ã€‚

## [](#lets-play)æˆ‘ä»¬æ¥ç©å§

æœ‰ä¸€ä¸ªæ¸¸æˆã€‚ä¸€æ¬¾**ä¾èµ–å˜²è®½**æ¸¸æˆã€‚æœ‰æ—¶è¢«ç§°ä¸ºä¾èµ–æ³¨å…¥æ¸¸æˆã€‚æœ‰äº›ç›’å­ç”šè‡³è¢«è´´ä¸Šåè½¬æ§åˆ¶æ¸¸æˆçš„æ ‡ç­¾ã€‚ä¸€ä¸ªéå¸¸å—æ¬¢è¿çš„æ²™ç›’ç­–ç•¥æ¸¸æˆï¼Œä½ åœ¨ä¸åŒçš„ç¯å¢ƒä¸­è¿è¡Œä½ çš„æ¨¡å—ä»£ç ï¼Œå¹¶è¯•å›¾æ‰¾åˆ°ç ´åå®ƒçš„æ¡ä»¶ã€‚

> ä¾èµ–æ¨¡ä»¿æ˜¯ä¸€ç§åœ¨æ²™ç›’ç¯å¢ƒä¸­è¿è¡Œä»£ç çš„èƒ½åŠ›ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç©ä¸€ä¸ª*æ”¹ç¼–ç‰ˆ*ã€‚å®ƒä»¥ [Rewire](https://github.com/jhnns/rewire#limitations) å‘½åâ€”â€”ä¸€æ ¹é­”æ–ï¼Œæ— å°½åŠ›é‡çš„æºæ³‰ã€‚ä¸€æ—¦ä½ éœ€è¦æ§åˆ¶ä½ çš„ä»£ç ï¼Œä¸€æ—¦ä½ éœ€è¦æ”¹å˜å®ƒçš„å·¥ä½œæ–¹å¼ï¼Œå°±ä½¿ç”¨å®ƒã€‚å®ƒç»™ä½ èƒ½åŠ›*é‡æ–°å¸ƒçº¿*(æ²¡é”™ï¼)ä¸€ä¸ªæ¨¡å—ï¼Œ*ä¸²*å®ƒï¼Œæˆä¸ºä¸€ä¸ªæœ¨å¶å¸ˆã€‚

## [](#is-it-sounds-like-fun)æ˜¯ä¸æ˜¯å¬èµ·æ¥å¾ˆå¥½ç©ï¼Ÿ

å¯¹æˆ‘æ¥è¯´-æ˜¯çš„ã€‚è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­-

*   æˆ‘ä»¬æƒ³è¦æµ‹è¯•ä¸€ä¸ªæ–‡ä»¶

```
var fs = require("fs"),
    path = "/somewhere/on/the/disk";

exports.readSomethingFromFileSystem = function(cb) {
    console.log("Reading from file system ...");
    fs.readFile(path, "utf8", cb);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   ä»¥åŠå¯¹è¯¥æ–‡ä»¶çš„æµ‹è¯•

```
// test/myModule.test.js
var rewire = require("rewire");

var myModule = rewire("../lib/myModule.js");

// and we could CONTROL IT!!!
myModule.__set__("path", "/dev/null");
myModule.__set__("fs", fsMock);

myModule.readSomethingFromFileSystem(function (err, data) {
    console.log(data); // YOOHOO!!
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬åˆšåˆš*é‡æ–°è¿æ¥äº†*ä¸€ä¸ªæ–‡ä»¶ï¼æˆ‘ä»¬æ”¹å˜äº†å†…éƒ¨å˜é‡çš„å€¼ï¼Œä½¿è¿™ä¸ªæ–‡ä»¶*å¯æµ‹è¯•*ã€‚æˆ‘ä»¬åœ¨è€ƒéªŒç¥ï¼Œä¸æ˜¯å—ï¼Ÿ

> TLï¼›åšå£«-ä¸ï¼Œæˆ‘ä»¬æ²¡æœ‰ã€‚æ³„æ¼çš„æŠ½è±¡ä»¥åŠå†…éƒ¨å˜é‡å’Œä¾èµ–å…³ç³»(å¥½å§ï¼Œæ˜¯å˜é‡)ä¹‹é—´æ²¡æœ‰åˆ†ç¦»ï¼Œå¹¶ä¸å¥½ç©ã€‚è¿™åœºæ¸¸æˆä¸ä¼šæœ‰å¥½ç»“æœ...

[![](../Images/26eeecfabf78c35e3e2d55f9feb9ca51.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--yfsEbAh7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/rm1qgxpcevsuj43u0jx2.jpg)

è¯·ä¸è¦è¯¯ä¼šï¼Œä½†`rewire`åªæ˜¯è¿åäº†æ‰€æœ‰æ—¢å®šçš„æ¨¡å¼ï¼Œåªèƒ½ç”±*å°å­©*ä½¿ç”¨ï¼Œä»–ä»¬ä¸åœ¨ä¹æ¸¸æˆè§„åˆ™ï¼Œåªæƒ³è®©*ç©*ã€‚

ä»ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°±åœ¨å­¦ä¹ å¦‚ä½•ç¼–ç ï¼Œä»¥åŠå¦‚ä½•â€œ*æ°å½“åœ°*â€â€”â€”ä»è¯­è¨€ç»“æ„åˆ°æ•°æ®ç®—æ³•å’Œæ¶æ„æ¨¡å¼ã€‚æˆ‘ä»¬æ­£åœ¨å­¦ä¹ ä»€ä¹ˆæ˜¯åçš„ï¼Œä»€ä¹ˆæ˜¯å¥½çš„ï¼Œä»€ä¹ˆæ˜¯å¯¹çš„ã€‚åƒ- *å…¨å±€*å’Œ *1000 è¡Œé•¿çš„æ–‡ä»¶*æ˜¯åçš„ï¼Œ*æ‰å®*æ˜¯å¥½çš„ï¼Œ*å¹²å‡€ä»£ç *æ˜¯å¯¹çš„ã€‚(å·¥ä½œå’Œå‘å¸ƒçš„ä»£ç æ›´å¥½)ã€‚

åäº‹å¤šï¼Œå¥½äº‹ä¹Ÿå¤šã€‚è€Œ**å¥½çš„**é€šå¸¸æ„å‘³ç€**ä¸¥æ ¼çš„**ã€‚ä¸¥æ ¼ï¼Œæ— èŠï¼Œæ‚²ä¼¤ï¼Œç´§å‡‘ï¼Œæ˜“äºç†è§£å’Œæ¨ç†ï¼Œæ˜“äºå¼€å§‹ï¼Œå¹¶è½¬ç§»åˆ°å¦ä¸€ä¸ªå›¢é˜Ÿã€‚*é…·è€Œç²—ç³™çš„*è§£å†³æ–¹æ¡ˆä¸æ˜¯æŸä¸ªäººã€ä»»ä½•äººéƒ½ä¼šè¯´â€œè°¢è°¢â€çš„ä¸œè¥¿ã€‚*(ä¼šæ›´æ¥è¿‘â€œ$%@#ä½ â€)*

> â€œä¸¥â€ä¸â€œæ ‡â€ã€‚è€Œä¸”ï¼Œå¦‚æœä½ èƒ½å¤Ÿä½¿ç”¨`rewire`ï¼Œ-ä½ çš„ä»£ç æ—¢ä¸æ˜¯â€œä¸¥æ ¼çš„â€ï¼Œä¹Ÿä¸æ˜¯â€œæ ‡å‡†çš„â€ã€‚

è®©æˆ‘æŠŠè¿™ç§æƒ…å†µå˜å¾—æ›´ç³Ÿ:

*   æ˜¾ç„¶ï¼Œå¦‚æœä½ ä½¿ç”¨`const`æ¥å£°æ˜å˜é‡ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šèµ·ä½œç”¨ï¼Œæ‰€ä»¥ä½ ä¸èƒ½å†ç”¨*æ¥æ”¹å˜*çš„å€¼ã€‚
*   æ˜¾ç„¶ï¼Œåœ¨å·´åˆ«å¡”å˜æ¢ä¹‹åï¼Œåªè¦å˜é‡åè¢«æ”¹å˜ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šèµ·ä½œç”¨ã€‚è¿™å°±æ˜¯[è®°è½½çš„](https://github.com/jhnns/rewire#limitations)é™åˆ¶ã€‚
*   æœ‰ä¸€ä¸ª [babel-rewire-plugin](https://github.com/speedskater/babel-plugin-rewire) å¯ä»¥æ‹¯æ•‘ä¸–ç•Œï¼Œä½†æ˜¯å®ƒèƒ½æ”¹å˜ä»€ä¹ˆå—ï¼Ÿ

> å› æ­¤ï¼Œæ ¹æ®è‡ªè¿°æ–‡ä»¶ï¼Œè¿™ä¸ªåº“â€œå¯¹äºç¼–å†™æµ‹è¯•æ˜¯æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯æ¨¡æ‹Ÿè¢«æµ‹æ¨¡å—çš„ä¾èµ–æ€§ã€‚â€ã€‚ä½†æ˜¯æˆ‘ä¼šè¯´- **ä¸**ã€‚è¿™ä¸**ä¾èµ–**çš„å˜²è®½æ¯«æ— å…³ç³»ã€‚

**æˆ‘åŠä½ â€”â€”åœæ­¢ä½¿ç”¨`rewire`** ã€‚æ˜¯çš„-è¿™æ˜¯ä¸€ä¸ªéå¸¸å—æ¬¢è¿çš„æ¸¸æˆï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæœ‰è¶£çš„æ¸¸æˆã€‚ä½†ç»“å±€ä¸ä¼šå¥½ã€‚è¯·åœä¸‹æ¥ã€‚æ²¡é”™ã€‚ç°åœ¨ã€‚

## [](#sinon-way)å¦åˆ™æ–¹å¼

åœ¨è·³åˆ°çœŸæ­£æœ‰è¶£çš„åœ°æ–¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´è¯´å¦ä¸€ä¸ªåº“ï¼Œå®ƒé€šå¸¸ç”¨äºâ€œæ¨¡æ‹Ÿâ€(æˆ–â€œå­˜æ ¹â€)ä¾èµ–å…³ç³»- [sinon](https://sinonjs.org) ã€‚

```
import * as Service from './serviceToMock'
import { someFunctionThatCallsMyOperation } from './controllerThatUsesTheService'
sinon.stub(Service, 'myOperation').return(5)
someFunctionThatCallsMyOperation() // Ends up receiving a 5 as answer 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…åƒ

```
var fs = require('fs');
sinon.stub(fs, 'readFileSync');
fs.readFileSync('/etc/pwd'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¸…æ¥šè¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿ`sinon.stub(x,y)`å°±æ˜¯`x[y]=Z`â€“è¿™æ˜¯ä¸€ä¸ªè¦†ç›–ï¼Œä¸€ä¸ªåªé€‚ç”¨äºå¯¼å‡ºå¯¹è±¡çš„é»‘å®¢ã€‚ä»é‡Œé¢çš„*æ”¹å˜ä¸€äº›ä¸œè¥¿çš„æ–¹æ³•ã€‚*

è¿™æ˜¯ä¸€æ¡é”™è¯¯çš„è·¯ï¼Œä¸€æ¡æ­»è·¯ã€‚Sinon æœ¬èº«æœ‰ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•[è®°å½•](https://sinonjs.org/how-to/link-seams-commonjs/)(å¬å¬ï¼Œå­©å­ï¼Œå¬å¬å¤§äººåœ¨è¯´ä»€ä¹ˆ)ï¼Œä½†ä½ ä»¬ä¸­çš„è®¸å¤šäººä»ç„¶åœ¨ç”¨`sinon`æ¥å˜²ç¬‘ã€‚ç”¨ sinon æ¥æ¨¡ä»¿ä¾èµ–æ˜¯ä¸å¯¹çš„ã€‚åªè¦æ¨¡å—å†…éƒ¨æ²¡æœ‰ç”µæºï¼Œå°±ä¸å¯èƒ½ã€‚

```
// lets extract to a local variable. There are many reasons to do it
const readFileSync = fs.readFileSync;

// for example this one
import {readFileSync} from 'fs';

// ...

sinon.stub(fs, 'readFileSync');
// ^ has no power this time ^ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¯ç§å·¥å…·éƒ½æœ‰ç›®æ ‡ï¼Œä¹Ÿæœ‰å±€é™æ€§ã€‚`sinon.sandbox`å¯èƒ½ä¼šæ¨¡ä»¿- *ç¯å¢ƒ*æ¯”å¦‚`timers`æˆ–è€…`server`ï¼Œä½†æ˜¯å¯¹ä½ è‡ªå·±çš„ä»£ç æœ‰ä¸€å®šçš„å½±å“åŠ›ã€‚

> æœ‰ä¸€ä¸ªç®€å•çš„è§„åˆ™æ¥å®šä¹‰æ¸¸æˆæ˜¯å¥½çš„ï¼Œè¿˜æ˜¯åçš„â€”â€”å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ç”¨ä¾‹ä¸èƒ½è¢«è§£å†³ï¼Œè¦æ±‚ä½ æ”¹å˜æ¸¸æˆè§„åˆ™(ä½ çš„ä»£ç )â€”â€”é‚£ä¹ˆè¿™ä¸ªæ¸¸æˆå°±æ˜¯åçš„ã€‚

æ­¤å¤–ï¼Œåšç±»ä¼¼äº`sinon.stub(fs, 'readFileSync');`çš„äº‹æƒ…ä¼šæ”¹å˜æ‰€æœ‰æ¨¡å—æ¶ˆè´¹è€…çš„`fs`ï¼Œè€Œä¸ä»…ä»…æ˜¯å½“å‰çš„`test`æˆ–å½“å‰çš„`subjects under test`ã€‚ä¾‹å¦‚ï¼Œé‚£æ€æ­»äº†æµ‹è¯•èµ›è·‘è€…â˜ ï¸.

ä¸ã€‚æ”¹å˜(å’Œä½¿ç”¨)*å…¨å±€å˜é‡*(ç”±äº`module cache`æ¨¡å—è¾“å‡ºæ˜¯å…¨å±€å˜é‡)ä¸æ˜¯æ­£ç¡®çš„æ–¹æ³•ã€‚é»‘å®¢æ”»å‡»*æœ¬åœ°*å˜é‡ä¹Ÿä¸æ˜¯ä¸€ä¸ªé€‰é¡¹â€”â€”å®ƒä»¬ä¹Ÿæ˜¯å…¨å±€å˜é‡ï¼Œåªæ˜¯æ¯”*æœ¬åœ°*å¤šä¸€ç‚¹ã€‚

åœ¨ç±»ä¸­æ¨¡ä»¿æŸäº›ä¸œè¥¿ç”šè‡³ä¸æ˜¯ä¸€ç§æ­£ç¡®çš„æ–¹æ³•ï¼Œåªè¦å®ƒåªèƒ½åœ¨å®ƒä»¬çš„æ„é€ ä¹‹åè¿›è¡Œâ€”â€”åƒ DI è¿™æ ·çš„æŠ€æœ¯ï¼Œä½ å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°è°ƒç”¨æ³¨å…¥æ‰€æœ‰çš„ä¾èµ–:

*   é¦–å…ˆâ€”â€”å¯èƒ½éœ€è¦æ›´æ”¹æ„é€ å‡½æ•°ç­¾åï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•ã€‚è‚¯å®šä¸é€‚ç”¨äºâ€œæŸäº›æ¡†æ¶â€(å¦‚ React)ï¼Œå®ƒä»¬å¯¹ç±»çš„å¤–è§‚æœ‰è‡ªå·±çš„çœ‹æ³•ã€‚
*   ç¬¬äºŒâ€”â€”æ²¡æœ‰ç±»å°±ç©ä¸å¥½(åœ¨æ€§èƒ½å’Œåƒåœ¾æ”¶é›†æ–¹é¢)ã€‚

æ‰€ä»¥ï¼Œåªè¦æˆ‘æåˆ°äº†ç±»...

## [](#a-secret-game)ç§˜å¯†æ¸¸æˆ

æœ‰äº›æ¸¸æˆè£…åœ¨ä¸€ä¸ªåˆ«è‡´çš„ç›’å­é‡Œè¿é€ã€‚å°±åƒ[ts-æ¨¡æ‹Ÿè¿›å£](https://github.com/EmandM/ts-mock-imports) -å¬å¬å®ƒçš„å£°éŸ³- `Intuitive mocking for Typescript class imports`...ä¸ºä»€ä¹ˆè¿™é‡Œæåˆ°â€œç±»â€å‘¢ï¼Ÿä¸€ä¸ªä¸åº”è¯¥å­˜åœ¨çš„é™åˆ¶ã€‚

```
// foo.js
export class Foo {
  constructor() {
    throw new Error();
  }
}

// bar.js
export class Bar {
  constructor() {
    const foo = new Foo();
  }
}

// test.js
import { ImportMock } from 'ts-mock-imports';
import { Bar } from './Bar';
import * as fooModule from '../src/foo';

// Throws error
const bar = new Bar();

const mockManager = ImportMock.mockClass(fooModule, 'Foo');

// No longer throws an error
const bar = new Bar();

// Call restore to reset to original imports
mockManager.restore(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æ¼‚äº®**ï¼Ÿä½†æ˜¯ä¸‹é¢æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç³–åé¢çš„ä¸€è¡Œã€‚

```
// https://github.com/EmandM/ts-mock-imports/blob/master/src/managers/mock-manager.ts#L17
this.module[this.importName] = this.stubClass; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç›´æ¥æ¨¡å—`exports`æ‰“è¡¥ä¸ã€‚è¿™ä¸ ESM æ¨¡å—æˆ– webpack ä¸å…¼å®¹ï¼Œåªè¦**å¯¼å‡ºæ˜¯ä¸å¯å˜çš„**ã€‚æˆ–è€…è‡³å°‘è¢«è®¤ä¸ºæ˜¯ä¸å¯å˜çš„ã€‚åŒæ ·çš„â€œè¥¿å†œâ€æ–¹å¼ã€‚

> è€Œä¸”ï¼Œä½†æ˜¯æ–¹å¼â€”â€”è¿™å¹¶ä¸â€œç¾å¥½â€ã€‚è¿™ä¸ªä¾‹å­æœ¬èº«è¡¨æ˜äº†è¿™ç§æ–¹æ³•æ˜¯å¤šä¹ˆçš„æ˜“å˜å’Œè„†å¼±ã€‚ä¸èƒ½å½±å“å·²ç»åˆ›å»ºçš„ç±»ã€‚

[![](../Images/000d4103eac9b1fb3e35ba6411576786.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--H_Z0h5nj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/fxiis6lgkyextyox0wze.jpg)

æ¨¡ä»¿ä¸€ä¸ªç±»çš„å¥½æ–¹æ³•æ˜¯- **ä»å®ƒç»§æ‰¿**ï¼Œå¹¶è¦†ç›–ä½ éœ€è¦çš„ç«¯ç‚¹ã€‚

1.  æ›´æ”¹`Bar`ã€‚æˆ‘ä»¬å¿…é¡»è¿™ä¹ˆåšï¼Œåªè¦æˆ‘ä»¬æ— æ³•ä¿®æ”¹èŒä¸š`constructor`ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹èŒä¸š`methods`åšä»»ä½•æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ã€‚

```
//bar.js
export class Bar {
-  constructor() {
-    const foo = new Foo();
-  } +  constructor() {
+    this.createFoo();
+  }
+  // just moved code to a separate function
+  createFoo() {
+    const foo = new Foo();
+  } } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£ä¹ˆæµ‹è¯•å¯èƒ½éå¸¸ç®€å•:

```
class TestBar extends Bar {
   createFoo() {
     spy.call();
   } 
}

// No longer throws an error
const bar = new TestBar();
expect(spy).to.be.called(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> JFYI:æˆ‘ä»¬å·²ç»æ”¹å˜äº†æ¸¸æˆè§„åˆ™(ä»£ç )ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è®©å®ƒæ›´å…·å¯æµ‹è¯•æ€§ï¼Œè€Œæ˜¯æ›´å…·â€œå¯æŒ‚é’©æ€§â€(æˆ–â€œå¯ä¿®è¡¥æ€§â€)ã€‚
> 
> PS: **React-Hot-Loader** å°±æ˜¯è¿™æ ·å·¥ä½œçš„â€”â€”å®ƒä»åŸºç¡€ç»„ä»¶ç»§æ‰¿`hot-reloable`ç»„ä»¶ï¼Œæ”¹å˜å®ƒå¯èƒ½æƒ³è¦çš„æ‰€æœ‰åœ°æ–¹ï¼Œæˆä¸º React å’Œä½ çš„ä»£ç ä¹‹é—´çš„`bridge`ã€‚

ä½†å®ƒå¹¶ä¸æ€»æ˜¯æœ‰æ•ˆâ€”â€”æˆ‘ä»¬èƒ½å¤Ÿ*ç¼åˆ* `Bar`ï¼Œä½†ä¸èƒ½`Foo`(è¿™æ˜¯â€œç¡¬â€è¿æ¥çš„)ï¼Œè€Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ¨¡ä»¿`Foo`ï¼Œä¾‹å¦‚ï¼Œå¦‚æœå®ƒå°†å¯¹`fs`åšäº›ä»€ä¹ˆã€‚

## [](#in-short)ç®€è€Œè¨€ä¹‹

ç®€è€Œè¨€ä¹‹ï¼Œä¸Šé¢æåˆ°çš„æ‰€æœ‰*æ¸¸æˆ*éƒ½ä¸æ˜¯ä¾èµ–å˜²è®½ï¼Œåªè¦å®ƒä»¬æ˜¯åœ¨*ç›®æ ‡*æ¨¡å—è¢«è¦æ±‚å¹¶åˆå§‹åŒ–åå·¥ä½œå¹¶åšä¸€äº›äº‹æƒ…ã€‚**å¤ªæ™šäº†**ã€‚ä»–ä»¬çš„å·¥ä½œåº”è¯¥åœ¨ç‰‡åˆ»ä¹‹å‰å®Œæˆã€‚

è®©æˆ‘é‡å¤ä¸€é- **å¤ªæ™šäº†ï¼**ã€‚

åªæ˜¯ RTFMã€‚çœŸçš„â€”â€”åœ¨è¿‡å»çš„ 30 å¹´é‡Œï¼Œæµ‹è¯•å’Œå˜²ç¬‘å·²ç»è¢«å¾ˆå¥½çš„å®šä¹‰å’Œäº†è§£äº†ã€‚è¯•ç€æ¥å—â€”â€”ä¸Šé¢åˆ—å‡ºçš„æ–¹æ³•ä¸ä»…ä»…æ˜¯*åæ¨¡å¼*(æˆ‘ä¸ç¡®å®šè¿™ä¸ªè¯æ˜¯ä»€ä¹ˆæ„æ€)â€”â€”å®ƒä»¬åªæ˜¯è™šå‡çš„æ–¹å¼ã€‚

> **å…³äº*ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¾èµ–å˜²è®½ï¼Œè€Œä¸æ˜¯å˜é‡é»‘å®¢*çš„éƒ¨åˆ†å·²ç»ç»“æŸ**ã€‚

# [](#proxyquire)Proxyquire

> **Proxyquire** æ˜¯ä¸€ä¸ªå¤è‘£ commonjs (nodejs)æ—¶ä»£çš„ç¥å™¨ã€‚å®ƒå¯ä»¥ç”¨æ¥æ”¹å˜ä¸€ä¸ªæ¨¡å—å¯¹å¦ä¸€ä¸ªæ¨¡å—çš„éœ€æ±‚æ–¹å¼ã€‚å­—é¢æ„æ€â€”â€”å¯ä»¥æ”¹å˜`require`å‡½æ•°çš„è¡Œä¸ºã€‚ç„¶å-ä½ å¯ä»¥åšä»»ä½•äº‹ï¼ç”¨`fake-fs`æ›¿æ¢`fs`ï¼Œæ¨¡ä»¿`fetch`ï¼Œæˆ–è€…ç”¨è‡ªå·±çš„å®ç°æ›¿æ¢å­æ¨¡å—ã€‚

Proxyquire è¦å¥½å¾—å¤šã€‚å®ƒä»ä¸è§¦åŠæ¨¡å—æœ¬èº«ï¼Œåªæ§åˆ¶å®ƒçš„å¤–éƒ¨ä¾èµ–ã€‚è¿™å°±åƒä¸€ä¸ª docker-compose â€” *â€œå˜¿ nodejsï¼ä½ èƒ½åœ¨ä¸åŒçš„ç¯å¢ƒä¸­è¿è¡Œè¿™ä¸ªæ¨¡å—å—ï¼Ÿ!"*

```
const myModule = proxyquire.load('./myModule', { // file to load
  'fs': myFakeFS  // dependency to replace
});

myModule === require('./myModule') // with 'fs' replaced by our stub 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®ƒå¾ˆæ¼‚äº®â€”â€”ä¿æŒåŸæ ·ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªä¸åŒçš„ç¯å¢ƒä¸­ï¼Œæ›¿æ¢å¤–éƒ¨æ¨¡å—ä¾èµ–â€”â€”`fs`â€”â€”æ­£å¦‚æˆ‘ä»¬æ‰€è¯´çš„ã€‚

è®©æˆ‘ä»¬å°è¯•ä¿®å¤ä¸Šé¢çš„`Foo-Bar`ç¤ºä¾‹:

```
const myModule = proxyquire.load('./Bar', { // file to load
  './Foo': myFakeFoo  // dependency to replace
});

// No longer throws an error, without any code changes this time.
const bar = new Bar(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> JFYI:æˆ‘ä»¬**æ²¡æœ‰**æ”¹å˜æ¸¸æˆè§„åˆ™(ä»£ç )ã€‚ä¾èµ–æ¨¡ä»¿å¯èƒ½éœ€è¦**ç§»åŠ¨**ä»£ç ï¼Œè€Œä¸æ˜¯æ”¹å˜å®ƒã€‚

è¿™ä¸ªç®€å•çš„èƒ½åŠ›è§£å†³äº†å¤§éƒ¨åˆ†é—®é¢˜ã€‚åªæœ‰ä¸€ä¸ªé™åˆ¶â€”â€”ä½ åªèƒ½æ¨¡ä»¿**æ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œä¿æŒæ¨¡å—æœ¬èº«ä¸å˜ã€‚å› æ­¤ï¼Œæ‚¨å¯èƒ½æƒ³è¦â€œæ¨¡ä»¿â€æˆ–â€œæ§åˆ¶â€çš„ä¸€åˆ‡éƒ½åº”è¯¥æ˜¯å¤–éƒ¨ä¾èµ–ã€‚è¿™å¯¼è‡´æ–‡ä»¶ä¹‹é—´æ›´åˆç†çš„ä»£ç åˆ†ç¦»â€”â€”ä½ æ ¹æ®æ–‡ä»¶çš„â€œå¯æ¨¡ä»¿æ€§â€åœ¨æ–‡ä»¶ä¹‹é—´åˆ†å‰²åŠŸèƒ½ï¼Œè¿™å°†æ¥è‡ªå¯æµ‹è¯•æ€§ï¼Œè¿™å°†åæ˜ ä½¿ç”¨æƒ…å†µã€‚ä¸€ä¸ªå®Œç¾çš„æ²™ç›’ï¼**

[![sand](../Images/1c23960ba5d412913cac9408c10e35fe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--taLrqX5M--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/94b4i0ywx3k21y37i5hw.jpg)

> æˆ‘çš„æ„æ€æ˜¯â€”â€”ä½ çš„æ–‡ä»¶åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼Œä½ æƒ³æ¨¡æ‹Ÿç¬¬ä¸€ä¸ªå‡½æ•°æ¥æµ‹è¯•ç¬¬äºŒä¸ªå‡½æ•°â€”â€”é‚£ä¹ˆç¬¬äºŒä¸ªå‡½æ•°ä¾èµ–äºç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œä½ å¯ä»¥è€ƒè™‘æŠŠå®ƒæå–å‡ºæ¥ä½œä¸ºå¦ä¸€ä¸ªæ–‡ä»¶çš„`explicit dependency`ã€‚æ¬ä¸œè¥¿ã€‚

å³ä½¿å®ƒå¯èƒ½éœ€è¦ä¸€äº›æ”¹å˜ä½ çš„ä»£ç -å®ƒä¸æ‰“ç ´æ¸¸æˆè§„åˆ™ï¼Œä¸ä½¿è¿™ä¸ªæ¸¸æˆæˆä¸ºä¸€ä¸ªåæ¸¸æˆã€‚å®ƒåªæ˜¯æ”¹å˜äº†ä½ æ€è€ƒçš„æ–¹å¼ã€‚

è€å®è¯´- `proxyquire`ä¾èµ–å˜²è®½çš„æ ‡å‡†æ˜¯ä¸€ä¸ªæ¦‚å¿µ:

*   èƒ½å¤Ÿæ¨¡æ‹Ÿä¾èµ–æ€§
*   ä½†åªæœ‰ç›´æ¥ä¾èµ–
*   å¹¶è®©ä½ æ§åˆ¶è¿‡ç¨‹ï¼Œåƒ`callThought`éƒ¨åˆ†å˜²è®½ã€‚

ä»è¿™ä¸ªè§’åº¦æ¥çœ‹- `proxyquire`æ˜¯ä¸€ä¸ªç›¸å½“å¯é¢„æµ‹çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒå°†æ‰§è¡Œè‰¯å¥½çš„æ ‡å‡†ï¼Œæ°¸è¿œä¸ä¼šè®©äººå¤±æœ›ã€‚

ğŸ¤·â€â™‚ï¸å¾ˆä¸å¹¸â€”â€”è¿™ä¸æ˜¯çœŸçš„ã€‚äº‹å®ä¸Šï¼Œå®ƒä¼šç ´åä½ çš„æµ‹è¯•ï¼Œå¹¶ä¸”æ¯”ä½ éœ€è¦çš„æ›´å®¹æ˜“é¢„æµ‹ã€‚

### [](#blow-up)ç‚¸äº†ï¼Ÿ

æ˜¯å•Šï¼æ„ŸæŸ“æ‚¨çš„è¿è¡Œæ—¶ã€‚è‡³æ­»æ–¹ä¼‘ã€‚

å…³é”®åœ¨äº`proxyquire`çš„å®ç°ç»†èŠ‚â€”â€”ä¸€æ—¦ä½ éœ€è¦æŸä¸ªåº”è¯¥è¢«æ›¿æ¢çš„æ–‡ä»¶ï¼Œå®ƒä¼šè¿”å›å®ƒçš„å¦ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä½ è¦æ±‚è¿”å›çš„é‚£ä¸ªç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯åŸæ¥çš„é‚£ä¸ªç‰ˆæœ¬ï¼Œä»¥åŠè¿™ä¸ªâ€œé‡æ–°å¸ƒçº¿â€çš„åˆå§‹æ–‡ä»¶ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªâ€œå¦ä¸€ä¸ªç‰ˆæœ¬â€è¢«ç¼“å­˜äº†ï¼Œä¸‹æ¬¡å…¶ä»–äººè¯·æ±‚ç›¸åŒçš„æ–‡ä»¶æ—¶ä¼šè¢«è¿”å›ã€‚

```
const myTestableFile = proxyquire.load('./myFile', {
   'fs': myMockedFs
});

const fs = require('fs'); // the same myMockedFs :) oh ğŸ’©! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŸºæœ¬ä¸Šè¿™å«â€œä¸­æ¯’â€ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¼šç ´åä½ å‰©ä¸‹çš„æµ‹è¯•ã€‚æ˜¾ç„¶ï¼Œæœ‰ä¸€ä¸ªå‘½ä»¤å¯ä»¥çº æ­£è¿™ç§è¡Œä¸º- `.noPreserveCache`ï¼Œå®ƒ(è¿™æ¬¡ä¸æ˜æ˜¾)æ˜¯é»˜è®¤ç¦ç”¨çš„ï¼Œæ‰€ä»¥æ‚¨å¿…é¡»æ‰‹åŠ¨ä¿®å¤æ‚¨çš„æµ‹è¯•ã€‚

å‡ ä¹æ¯ä¸ªäººéƒ½å’Œ`proxyquire`ä¸€èµ·æ¢è®¨è¿™ä¸ªé—®é¢˜ã€‚å‡ ä¹æ¯ä¸ªäººéƒ½å¿…é¡»åœ¨æ¯ä¸ªæµ‹è¯•ä¸­å¢åŠ ä¸€è¡Œä»£ç (ä»¥ä¿®å¤ç¼“å­˜)ã€‚å‡ ä¹æ¯ä¸ªäººä¹‹å‰éƒ½èŠ±äº†å‡ ä¸ªå°æ—¶ï¼Œè¯•å›¾ç†è§£è¿™ç§å¥‡æ€ªçš„è¡Œä¸ºï¼Œä»¥åŠä¸ºä»€ä¹ˆâ€œé‚£ä¸€ä¸ªâ€ä¹‹åçš„æ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥äº†ï¼Œä½†åªæ˜¯åœ¨æ‰¹é‡æ‰§è¡Œæ—¶ã€‚è¿™æ˜¯ä¸€ä¸ª:æ¡Œé¢ç¿»è½¬:ï¼Œä¸æ˜¯ä¸€ä¸ªä¹è¶£ã€‚

> åƒè¿™æ ·â€œæ˜æ˜¾â€å’Œâ€œç¾éš¾æ€§â€çš„é—®é¢˜å¾ˆå¸¸è§ã€‚

### [](#too-predictable)å¤ªå¯é¢„æµ‹äº†ï¼Ÿ

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯`proxyquire`æœ‰å¤šç®€å•ã€‚äº‹å®ä¸Šéå¸¸ç®€å•ã€‚å¦‚æœæ‚¨è¯·æ±‚æ›¿æ¢æŸæ ·ä¸œè¥¿ï¼Œé‚£ä¹ˆåªæœ‰ä¸æ‚¨çš„è¯·æ±‚å®Œå…¨åŒ¹é…çš„ä¸œè¥¿æ‰ä¼šè¢«æ‰§è¡Œã€‚

> (æ­¤å¤„å¿«é€Ÿå»ºè®®-å®ƒåº”è¯¥ä¸æ‚¨åœ¨åŸå§‹è¦æ±‚ä¸­ä½¿ç”¨çš„â€œæ–‡ä»¶åâ€å®Œå…¨ç›¸åŒ)

*   å¦‚æœä½ çš„æµ‹è¯•åœ¨å¦ä¸€ä¸ªç›®å½•ä¸­â€”â€”ä½¿ç”¨æºæ–‡ä»¶ä¸­çš„åå­—ã€‚
*   å¦‚æœæ‚¨çš„å¯¼å…¥ä½¿ç”¨ç»å¯¹è·¯å¾„â€”â€”ä½¿ç”¨...ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè¿™å°†è¢«ç”¨æ¥è¦æ±‚ä¸€ä¸ªçœŸæ­£çš„æ–‡ä»¶ï¼Œåœ¨ä¸€äº›(å·´åˆ«å¡”ï¼Ÿ)æ’ä»¶ä¼šç¿»è¯‘å®ƒã€‚
*   å¦‚æœä½ åœ¨æ–‡ä»¶åæˆ–æ–‡ä»¶è·¯å¾„ä¸ŠçŠ¯äº†é”™è¯¯ï¼Œé‚£ä¹ˆç¥ä½ å¥½è¿ï¼Œè°ƒè¯•æ„‰å¿«ï¼Œä¸ä¼šæœ‰ä»»ä½•å¸®åŠ©ã€‚

```
// './myFile'
import stuff from 'common/helpers';
....

// './myFile.test.js'
const myTestableFile = proxyquire.load('./myFile', {
  'common/helpers': mock // nope. You have to mock something else
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`babel`è½¬æ¢ä½ çš„`imports`æˆ–å…¶ä»– lib åšçš„åå­—è§£æåï¼Œç†è§£ä½ çš„â€œæ–‡ä»¶â€åå¯èƒ½æ˜¯ä¸€ä¸ªçœŸæ­£çš„é—®é¢˜ã€‚

å¾ˆæç¬‘ï¼Œä½†æ˜¯æ‰€æœ‰*å¸¸è§çš„*å˜²è®½åº“- [proxyquire](https://github.com/thlorenz/proxyquire) ã€ [mock-require](https://github.com/boblauer/mock-require) ã€[å˜²è®½](https://github.com/mfncooper/mockery)éƒ½æ²¡æœ‰è¯´å¯¹ã€‚å®ƒä»¬éƒ½è¦æ±‚æ‚¨â€œé¢„æµ‹â€æ–‡ä»¶åã€‚

ä¸åŒçš„æ¨¡å—åœ¨ä¸åŒçš„æ—¶é—´ä»¥ä¸åŒçš„æ–¹å¼å˜²è®½ã€‚å¤šæ•°è¦†ç›–`require` (module.load)ï¼Œå¹¶åœ¨ç¼“å­˜â€œä¹‹å‰â€å·¥ä½œã€‚å°‘æ•°äººåˆ©ç”¨`require.extensions`ï¼Œä½åœ¨ç¼“å­˜å¢™åé¢ã€‚ç”šè‡³æœ‰ä¸€ä¸ªåº“ï¼Œå®ƒæŠŠä½ çš„æ¨¡æ‹Ÿæ”¾åˆ°ç¼“å­˜ä¸­ï¼Œå› æ­¤æ²¡æœ‰çœŸæ­£çš„è¿è¡Œæ—¶ã€‚

> **å…³äº*çš„éƒ¨åˆ†æ²¡æœ‰å®Œç¾çš„å·¥å…·ï¼Œä½ åº”è¯¥çŸ¥é“ä½ çš„ä¸€ä¸ª*çš„å±€é™æ€§å·²ç»ç»“æŸ**ã€‚

è®©æˆ‘ä»¬æ”¹å˜æ¸¸æˆè§„åˆ™ã€‚è®©å®ƒæ›´å®‰å…¨ã€‚

# [](#game-mode-easy)æ¸¸æˆæ¨¡å¼:ç®€å•

ä½ ä¼šæƒŠè®¶åœ°å‘ç°ï¼Œé€šè¿‡å¢åŠ æ–°çš„æ¸¸æˆè§„åˆ™æ¥ä¿®æ­£æ¸¸æˆæ˜¯å¤šä¹ˆå®¹æ˜“

```
const myTestableFile = rewiremock(() => require('./myFile'), {
  'common/helpers': mock // ğŸ˜‰ that's all
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœè¿™è¿˜ä¸å¤Ÿçš„è¯:

```
const myTestableFile = rewiremock(() => require('./myFile'), () => {
  rewiremock(() => require('common/helpers')).with(mock) // ğŸ˜‰ that's 100% all
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯€çªå¾ˆç®€å•â€”â€”é€šè¿‡ä½¿ç”¨`require`ï¼Œè€Œä¸æ˜¯`fileName`ï¼Œå¯ä»¥è®©`nodejs`ä¸ºæˆ‘ä»¬è§£å†³*çš„æƒåˆ©* `filename`ã€‚

*   åŠ ä¸Š**è‡ªåŠ¨å®Œæˆ**
*   åŠ  cmd+å•å‡»(è½¬åˆ°)
*   åŠ ä¸Š**ç±»å‹**ï¼Œå¦‚æœä½ æœ‰çš„è¯ã€‚æˆ–è€…è‡³å°‘æ˜¯ jsdocã€‚
*   å¦å¤–ï¼Œåœ¨ Windows ä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½ éœ€è¦çš„æ–‡ä»¶è·¯å¾„æ˜¯`'./a/b.js'`ï¼Œä½†æ˜¯ä½ éœ€è¦çš„æ–‡ä»¶å®é™…ä¸Šæ˜¯`'a\b.js'`â€”â€”ç›¸ä¿¡æˆ‘â€”â€”è¿™å¤ªä¸åˆç†äº†ã€‚

ä½ çŸ¥é“ï¼Œä¸å…¶ä»–å›¾ä¹¦é¦†ç›¸æ¯”ï¼Œå®ƒå°±åƒä¸€ä¸ªé­”æœ¯ã€‚

[![pointing to a fairy land](../Images/00c37bc033873eed49b4ae77bece644a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qaFrbXUU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/87l05a62tir9r77l8we4.jpg)

## [](#rewiremock)rewiremock

æ˜¯çš„ï¼Œ [rewiremock](https://github.com/theKashey/rewiremock) æ˜¯ä¿®å¤æ¸¸æˆçš„ä¸€ç§æ–¹å¼ã€‚

*   åœ¨`nodejs`ã€`webpack`å’Œ [ESM](https://github.com/standard-things/esm) ç¯å¢ƒä¸‹å·¥ä½œã€‚
*   æœ‰ä¸¤ä¸ªä¸åŒçš„ API æ¥å¸®åŠ©ä»`proxyquire`æˆ–`mockery`è¿ç§»ã€‚
*   æ”¯æŒ webpack åˆ«åã€ts åˆ«åå’Œä»»ä½•å…¶ä»–åˆ«åã€‚
*   æ”¯æŒéš”ç¦»(ä½¿ç”¨éæ¨¡ä»¿ä¾èµ–)å’Œåå‘éš”ç¦»(ä¸ä½¿ç”¨æ¨¡ä»¿æ—¶)

ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œè¿™ç¯‡æ–‡ç« çš„ 90%éƒ½æ˜¯å…³äºä¸€äº›äº‹æƒ…æ˜¯å¦‚ä½•ä¸æ­£ç¡®çš„ã€‚ä½†æ˜¯ï¼Œå³ä½¿å®ƒä»¬æ˜¯â€”â€”ä¹Ÿæœ‰åŠæ³•è®©å®ƒå˜å¾—æ›´å¥½ã€‚è®©æµ‹è¯•ä¸é‚£ä¹ˆéš¾é—»å’Œç—›è‹¦ã€‚

ä½ å¯èƒ½ä¼šå¬åˆ°ï¼Œä¾èµ–å˜²è®½æ˜¯ä¸€ä»¶åäº‹ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æœä¸ä½¿ç”¨å®ƒï¼Œæˆ–è€…ä½¿ç”¨ä¸å½“ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šèµ°ä¸Šæ›´ç³Ÿç³•çš„é“è·¯ã€‚

æ˜“äºæ¨¡ä»¿çš„ä»£ç æ˜“äºæµ‹è¯•ã€‚ç»“æ„åˆç†ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½åº”è¯¥åˆ†å¼€ï¼Œæ”¾åœ¨å®ƒä»¬è‡ªå·±çš„åœ°æ–¹ã€‚åƒæ¸¸ä¹åœºä¸€æ ·...åœ¨å„¿ç«¥å®ˆåˆ™ä¹‹å‰...

> å¹¶ä¸”`rewiremock`ä¼šä¿è¯æ¸¸æˆçš„å®‰å…¨ã€‚ä¹Ÿå¾ˆæœ‰è¶£ã€‚

[![](../Images/57b0e5a36d1249a9e4c1e0941e075799.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--G4xeqBV9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/gz7x3qsukd4ma52xy9qx.jpg)

**é‚£å°±æ˜¯æ–‡ç« ç»“å°¾**ã€‚æˆ‘å·²ç»æŒ‡å‡ºäº†ä¸€ä¸ªå¸¸è§çš„å˜²å¼„/æµ‹è¯•æ¨¡å¼çš„é—®é¢˜ï¼Œå¹¶ç»™äº†ä½ ä¸€ä¸ªå‰è¿›çš„æ–¹å‘ã€‚å‰©ä¸‹çš„å°±é ä½ äº†ã€‚

ä½†æ˜¯å¦‚æœä½ æƒ³çŸ¥é“æ›´å¤šï¼Ÿ

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png) [å¡è¥¿](https://github.com/theKashey) / [é›·éŸ¦é›·è«å…‹](https://github.com/theKashey/rewiremock)

### åœ¨ Node.js æˆ– webpack ç¯å¢ƒä¸­æ¨¡ä»¿ä¾èµ–å…³ç³»çš„æ­£ç¡®æ–¹æ³•ã€‚

<article class="markdown-body entry-content container-lg" itemprop="text">

```
 /$      /$ /$                     /$      /$                     /$
                    | $  /$ | $|__/                    | $$    /$$                    | $
  /$$$   /$$$ | $ /$$| $ /$  /$$$   /$$$ | $$  /$$  /$$$   /$$$$| $   /$
 /$__  $ /$__  $| $/$ $ $| $ /$__  $ /$__  $| $ $/$ $ /$__  $ /$_____/| $  /$/
| $  \__/| $$$$| $$_  $$| $| $  \__/| $$$$| $  $$| $| $  \ $| $      | $$$/
| $      | $_____/| $$/ \  $$| $| $      | $_____/| $\  $ | $| $  | $| $      | $_  $ 
| $      |  $$$$| $/   \  $| $| $      |  $$$$| $ \/  | $|  $$$/|  $$$$| $ \  $
|__/       \_______/|__/     \__/|__/|__/       \_______/|__/     |__/ \______/  \_______/|__/  \__/ 
```

[![Build Status](../Images/2e13370ea4c673af8e8b80ddbc766015.png)](http://travis-ci.org/theKashey/rewiremock)[![coverage-badge](../Images/f31c972baa42b9b58a0cd15a84cc5a9c.png)](https://codecov.io/github/thekashey/rewiremock)[![version-badge](../Images/b0807fad9a27e235fa8af52375e62cc5.png)](https://www.npmjs.com/package/rewiremock)[![Greenkeeper badge](../Images/e27700db48274fed91e422f5b2ebc7f1.png)T11ã€‘](https://greenkeeper.io/)

# å¿«é€Ÿå¯åŠ¨

## 1.å®‰è£…

*   `yarn add --dev rewiremock`æˆ–`npm i --save-dev rewiremock`

## 2.è®¾ç½®

æˆ‘å»ºè®®ä¸è¦ç›´æ¥ä»æµ‹è¯•ä¸­å¯¼å…¥`rewiremock`ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª`rewiremock.js`æ–‡ä»¶â€¦

</article>

[View on GitHub](https://github.com/theKashey/rewiremock)

PS:å…³äºä¾èµ–å˜²è®½å’Œ rewiremock çš„é™„åŠ æ–‡ç« :

*   [å¦‚ä½•æ¨¡ä»¿ä¾èµ–ï¼Œä¸ºä»€ä¹ˆ](https://itnext.io/how-to-mock-dependency-in-a-node-js-and-why-2ad4386f6587)
*   [å•å…ƒæµ‹è¯•æ˜¯ç”Ÿäº§ä»£ç ](https://medium.com/techtrument/unit-tests-are-production-code-d256d86f073e)
*   [å¤©ç½‘çš„å•å…ƒæµ‹è¯•(å¦‚æœç”¨ JS ç¼–å†™)](https://itnext.io/unit-tests-for-skynet-written-in-js-6704265858a4)
*   [å˜²è®½æ˜¯ä¸€ç§ä»£ç æ°”å‘³](https://itnext.io/mocking-was-a-code-smell-7f93d8a5d6f2)