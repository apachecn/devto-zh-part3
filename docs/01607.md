# Angular & RxJS:æ£€æµ‹å†…å­˜æ³„æ¼

> åŸæ–‡:[https://dev . to/erxk/angular-rxjs-detecting-memory-leaks-48nl](https://dev.to/erxk/angular-rxjs-detecting-memory-leaks-48nl)

æˆ‘å·²ç»ä½¿ç”¨ RxJS æ„å»ºäº†ä¸€ä¸ªç¤ºä¾‹ Angular åº”ç”¨ç¨‹åºæ¥æ¨¡æ‹Ÿå„ç§å†…å­˜æ³„æ¼ã€‚è¿™äº›æŠ€æœ¯ä¸­çš„å¤§å¤šæ•°éƒ½é€‚ç”¨äºä»»ä½•ä½¿ç”¨ RxJS çš„åŸºäºç»„ä»¶çš„æ¡†æ¶ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½æºä»£ç :[**https://github.com/Everduin94/memory-leaks-rxjs**](https://github.com/Everduin94/memory-leaks-rxjs)ğŸš€

æˆ‘ä»¬å°†æ¶µç›–:

1.  æ£€æµ‹å†…å­˜æ³„æ¼çš„ç­–ç•¥
2.  å–æ¶ˆè®¢é˜…å’Œåƒåœ¾æ”¶é›†
3.  è§£å†³åŸºäºè®¢é˜…çš„å†…å­˜æ³„æ¼çš„è§£å†³æ–¹æ¡ˆ

### [](#strategies-for-detecting-a-memory-leak)æ£€æµ‹å†…å­˜æ³„æ¼çš„ç­–ç•¥

åœ¨è°·æ­Œæµè§ˆå™¨ä¸­ä½¿ç”¨è°·æ­Œæµè§ˆå™¨å¼€å‘å·¥å…·ğŸ›  (Ctrl+Shift+I)

[![](../Images/9a0af8778c690f1337ec9705e23932c7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--dByTQIuA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/642/1%2AVdpx6qWXaG8Vgr612FlMSg.png)

#### [](#allocation-timeline)**åˆ†é…æ—¶é—´çº¿ğŸ“ˆ**

åˆ†é…æ—¶é—´è¡¨å…è®¸æˆ‘ä»¬æŸ¥çœ‹å †çš„æœ€å°å¤§å°æ˜¯å¦éšç€æ—¶é—´çš„æ¨ç§»è€Œå¢é•¿ã€‚åœ¨åˆ›å»ºæˆ–é”€æ¯ä»»ä½•ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä»åŸºçº¿å¼€å§‹ã€‚

[![](../Images/2fa57dc135c79fa12316e1edde359309.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--2MHmIzCW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/789/1%2A1wJuyDE4eSxijssxdP8UKg.png)

ç°åœ¨ï¼Œå½“æ—¶é—´çº¿è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å°†å¤šæ¬¡åˆ›å»º/é”€æ¯ LargeLeak ç»„ä»¶ã€‚æ³¨æ„ï¼Œæˆ‘åœ¨è¿‡æ»¤å™¨ä¸­è¾“å…¥äº† largeï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ LargeLeakComponent çš„åˆ†é…

<figure>[![](../Images/646c2ffd0b2d8a4fae905fadd4a0285c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--jM4QcgnN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2Allr0aXPbsxkingnCbJ_WSg.png) 

<figcaption>æ”¾å¼€ç”µå­å…ƒä»¶ã€‚ts</figcaption>

</figure>

[![](../Images/8ea7eda4a0438ee911ed608d2724ae3c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--jKbxAz-w--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/792/1%2ABO3vR8RBXPWLFV0qjTsf9g.png)

ç°åœ¨æˆ‘ä»¬å›åˆ°èµ·ç‚¹(é”€æ¯ LargeLeakComponent) â†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†(å·¦ä¸Šè§’çš„ğŸ—‘åƒåœ¾æ¡¶å›¾æ ‡)â†’é‡æ–°å¯åŠ¨åˆ†é…æ—¶é—´çº¿(å·¦ä¸Šè§’çš„âš«åœˆå›¾æ ‡)ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æœ€å°å †å¤§å°å¢åŠ äº†ï¼Œåˆ†é…æ²¡æœ‰è¢«é‡Šæ”¾ã€‚

[![](../Images/fc781f98fd63c26be215265979c81cf0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--C5WNHYLR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/782/1%2AnBu2ckm9fsFgEgDTOfuEZw.png)

#### [](#heap-snapshot)**å †å¿«ç…§ğŸ“¸**

ä¸€æ—¦æˆ‘ä»¬ç¡®å®šäº†æ³„æ¼ï¼Œå †å¿«ç…§å°±éå¸¸æœ‰ç”¨ã€‚ä¸åŒäºåˆ†é…æ—¶é—´è¡¨ğŸŒï¼Œå½“æˆ‘ä»¬ä¸åº”ç”¨ç¨‹åºäº¤äº’æ—¶ï¼Œå †å¿«ç…§ä¸ä¼šå¯¼è‡´å»¶è¿Ÿã€‚æœ€ç»ˆï¼Œå¿«ç…§å’Œåˆ†é…æ—¶é—´è¡¨éƒ½å¯ä»¥ç”¨æ¥æ£€æµ‹æ³„æ¼ã€‚

åœ¨åº”ç”¨ç¨‹åºä¸­åšä»»ä½•äº‹æƒ…ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä»å †å¿«ç…§å¼€å§‹ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„åŸºçº¿æˆ–èµ·ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»åˆ†é…äº† 0 ä¸ª ServiceObservableLeak ç»„ä»¶ã€‚

<figure>[![](../Images/a9ce8df542f3e4287efe3ce0f78f555d.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--uoEaqslg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AoZswZXkVnYbHLQEfKK417w.png)

<figcaption>serviceobservableleak . ts</figcaption>

</figure>

[![](../Images/2047850d3de80299fc33a440a87931dc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PfF1Mzkh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/787/1%2AAdn3R1c5QUmygfjhN1F_uA.png)

å¤šæ¬¡åˆ‡æ¢åˆ›å»º/é”€æ¯åâ†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†ğŸ—‘â†’å¹¶æ‹æ‘„å¦ä¸€ä¸ªâš«.å¿«ç…§æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»„ä»¶æ²¡æœ‰é€šè¿‡åƒåœ¾æ”¶é›†æ¥é‡Šæ”¾ã€‚

[![](../Images/3342eea4f8be23a6b4d42727c1acd3d7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--3rjoz7M---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/798/1%2AJwsguLButwYr3KpMpymzsQ.png)

æ³¨æ„ï¼Œåªæœç´¢ç»„ä»¶å¹¶ä¸æ€»æ˜¯æŸ¥æ‰¾å†…å­˜æ³„æ¼çš„æœ‰æ•ˆæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å‡è®¾å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥æ£€æŸ¥å†…å­˜ä¸­çš„è®¢é˜…è€…æ•°é‡ã€‚ğŸ”ä½¿ç”¨å¿«ç…§æ¯”è¾ƒ(ç­›é€‰å™¨æ—è¾¹çš„ä¸‹æ‹‰èœå•)ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒä¸¤ä¸ªç‹¬ç«‹çš„å¿«ç…§ã€‚è¿™è¡¨æ˜æˆ‘ä»¬å·²ç»åˆ†é…äº† 30 ä¸ªè®¢æˆ·ï¼Œåˆ é™¤äº† 0 ä¸ªã€‚åœ¨â€œå–æ¶ˆè®¢é˜…å’Œåƒåœ¾æ”¶é›†â€ä¸­æœ‰æ›´å¤šå…³äºè¿™æ–¹é¢çš„å†…å®¹ã€‚

[![](../Images/b2df86833fd98c1ca106a85ffb4f62c3.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PSBleDN9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/910/1%2ADCa53K2eFIaHJL9f5d8Abw.png)

### [](#unsubscribe-and-garbage-collection)**é€€è®¢å’Œåƒåœ¾æ”¶é›†**

äººä»¬ç»å¸¸æåˆ°ï¼Œè®¢é˜…æŒæœ‰å¯¹ç»„ä»¶çš„å¼•ç”¨ã€‚å› æ­¤ï¼Œç»„ä»¶ä¸èƒ½è¢«é‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚ä¸èƒ½é‡Šæ”¾ä»»ä½•ä¸€ä¸ªç›¸äº’å¼•ç”¨çš„å¯¹è±¡ç§°ä¸ºå¾ªç¯ã€‚[ã€1ã€‘](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management)

å‘¨æœŸæ˜¯â€œå¼•ç”¨è®¡æ•°åƒåœ¾æ”¶é›†â€ç®—æ³•çš„ä¸€ä¸ªé™åˆ¶ã€‚ç°ä»£æµè§ˆå™¨ä½¿ç”¨â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ğŸ¯ã€‚æ ‡è®°å’Œæ¸…é™¤ç®—æ³•å°†ä»æ ¹(å…¨å±€å¯¹è±¡)æ”¶é›†æ‰€æœ‰ä¸å¯åˆ°è¾¾çš„å¯¹è±¡ã€‚è¿™è§£å†³äº†å¾ªç¯çš„å±€é™æ€§ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡æµ‹è¯•å±€éƒ¨æœ‰é™å¯è§‚å¯Ÿå€¼æ¥éªŒè¯åƒåœ¾æ”¶é›†å™¨å¤„ç†å‘¨æœŸçš„æƒ³æ³•ã€‚å½“æˆ‘ä»¬åˆ‡æ¢æœ¬åœ°æœ‰é™ç»„ä»¶â†’æ‰‹åŠ¨è¿è¡Œåƒåœ¾æ”¶é›†ğŸ—‘â†’æ—¶ï¼Œè·å–å †å¿«ç…§âš«.

<figure>[![](../Images/7020a06c2cd6bdab5eb943c93eeba9ce.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ZsC8Jiu8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AOlBEXQdubKn1SVmEJvKYRQ.png) 

<figcaption>ã€æœ‰é™å¯è§‚å¯Ÿæˆåˆ†ã€‚ts</figcaption>

</figure>

[![](../Images/c1c38c4196bb94b1a5b85bcda7a88d8b.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--599Z9_Uy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/797/1%2Ak0xqb0-41cnJzSwIBoxksQ.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»„ä»¶æ²¡æœ‰æ³„æ¼ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨è®¢é˜…ç®¡ç†ç­–ç•¥(æ¯”å¦‚å–æ¶ˆè®¢é˜…)ã€‚

> â€œæ‰€ä»¥æˆ‘å¯ä»¥è®©åƒåœ¾æ”¶é›†æ¥ç®¡ç†æˆ‘çš„è®¢é˜…ï¼Ÿâ€

**å·**

[![](../Images/79dd921cae4d629dca60306c2c80a876.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PCDyaHB3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/noiqrwv2m5su9mayim7p.gif)

å¦‚æœè®¢é˜…/ç»„ä»¶ä»ç„¶æœ‰ä¸€äº›å¯¹æ ¹çš„å¼•ç”¨ï¼Œå®ƒå°†ä¸ä¼šè¢«åƒåœ¾æ”¶é›†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å‰ä¸€ä¸ªç¤ºä¾‹çš„ ServiceObservableLeak ç»„ä»¶ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚å› ä¸ºæˆ‘ä»¬çš„ observable (observable$)æ˜¯åœ¨æœåŠ¡(SourceService)ä¸­åˆ†é…çš„ï¼Œæ‰€ä»¥ç»„ä»¶ä»ç„¶æœ‰ä¸€ä¸ªé€šè¿‡ observable è¿”å›åˆ°æ ¹çš„å¼•ç”¨ã€‚æˆ‘ä»¬éœ€è¦å–æ¶ˆè®¢é˜…ç»„ä»¶(ServiceObservableLeakComponent)æ‰èƒ½è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

[![](../Images/77f85c6b0cab4bb70f333117ac650469.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--ySc0K2Ey--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/726/1%2AB_TxSruza9lrfFtZLPdjBw.png)

ä¸ç®¡ç†è®¢é˜…æ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•ï¼Œåº”è¯¥é¿å…ã€‚ä»¥ FromEvent ç»„ä»¶ä¸ºä¾‹ã€‚è¯¥ç»„ä»¶åˆå§‹åŒ–ä¸€ä¸ªæœ¬åœ°å¯è§‚å¯Ÿå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨ FromEventComponent ä¸­ç›‘è§†æŒ‰é’®ä¸Šçš„ç‚¹å‡»äº‹ä»¶ã€‚

<figure>[![](../Images/728f256754871e11a67ef3b5ac5a1faf.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--jxo3ocX9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AkFLR2OrVSsqrc6z5SpWHJQ.png)

<figcaption>fromeventcomponent . ts</figcaption>

</figure>

[![](../Images/1cad829925a8057285c56c73a9b1bb27.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Txm4plkd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/919/1%2ANh5DWQ0OtThb0EiUD6_2mg.png)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç»„ä»¶è¢«é‡Šæ”¾ï¼Œä½†æ˜¯è®¢æˆ·æ²¡æœ‰è¢«é‡Šæ”¾ã€‚æ›´å¤æ‚çš„æ˜¯ï¼Œåªæœ‰å½“ç‚¹å‡»äº‹ä»¶è‡³å°‘è¢«è§¦å‘ä¸€æ¬¡æ—¶ï¼Œè®¢é˜…è€…æ‰ä¼šæ³„æ¼ã€‚è¿™é€ æˆäº†å¾ˆéš¾è·Ÿè¸ªçš„å†…å­˜æ³„æ¼ã€‚â€”è§£å†³æ–¹æ¡ˆæ˜¯å§‹ç»ˆç®¡ç†æ‚¨çš„è®¢é˜…ã€‚

### [](#solutions)**è§£å†³æ–¹æ¡ˆ**

[![](../Images/a5fe68ee9d3039f89916e2bcb37f95ae.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--6QBCYKiJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/q25altwpke5zxqse3xmf.gif)

æˆ‘è®¡åˆ’åœ¨ä»¥åçš„æ–‡ç« ä¸­æ›´è¯¦ç»†åœ°ä»‹ç»è¿™äº›æ–¹æ³•ã€‚ç°åœ¨ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¦‚è¿°ã€‚ğŸŒ

#### [](#unsubscribe)é€€è®¢

å–æ¶ˆè®¢é˜… ngOnDestroy æ–¹æ³•ä¸­çš„æ‰€æœ‰è®¢é˜…æ˜¯ä¸€ç§æœ‰æ•ˆçš„ç­–ç•¥ã€‚è¿™ç±»ä¼¼äºå¼‚æ­¥ç®¡é“åœ¨ç»„ä»¶çº§æ‰€åšçš„äº‹æƒ…ã€‚

[![](../Images/51c669b461c95376ede39d4c4a41b5c9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qvxOw8qW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AePafZp5DswpHRrjgxZM-lw.png)

#### [](#async-pipe)å¼‚æ­¥ç®¡é“

å°†æ ¹æ®ä¸ä¹‹å…³è”çš„ DOM å…ƒç´ çš„ç”Ÿå‘½å‘¨æœŸæ¥ç®¡ç†æ‚¨çš„è®¢é˜…ã€‚æ— è®ºåœ¨å“ªé‡Œå£°æ˜ï¼Œå¼‚æ­¥ç®¡é“éƒ½å°†è¿›è¡Œæ–°çš„è®¢é˜…ã€‚ä½¿ç”¨â€œasâ€é‡å¤ä½¿ç”¨æä¾›çš„å€¼ã€‚

[![](../Images/5f841c6a9f9c641c31441e4fe714ada7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8W_gWnUD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2Ah_gZJTcdaB39ejXkRQZnxQ.png)

#### [](#take)å–

takeã€takeUntil å’Œ takeWhile éƒ½å°†æ ¹æ®æ»¡è¶³çš„æ¡ä»¶è‡ªåŠ¨ç®¡ç†è®¢é˜…ã€‚ä¾‹å¦‚ï¼ŒtakeUntil å°†ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶ç»´æŒä¸€ä¸ªè®¢é˜…ï¼Œç›´åˆ°è¯¥å¯è§‚å¯Ÿå¯¹è±¡å‘å‡ºä¸€ä¸ªå€¼ã€‚

[![](../Images/6942600d9f7ffc0dda1f11440c028ec1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--502pfCEw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A6_XXCKo_cdGswxhwNyf55w.png)

* * *

### [](#resources-references)**èµ„æº/å‚è€ƒæ–‡çŒ®**

*   [1]:[https://developer . Mozilla . org/en-US/docs/Web/JavaScript/Memory _ Management](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management)
*   è¯­æ³•é«˜äº®å›¾åƒç”± [https://carbon.now.sh](https://carbon.now.sh/) ç”Ÿæˆ