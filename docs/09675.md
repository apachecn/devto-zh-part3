# ç”¨ Fetch(å’Œè‡ªå®šä¹‰ React æŒ‚é’©)å¤„ç†é”™è¯¯

> åŸæ–‡:[https://dev . to/p4lm/error-handling-with-fetch-and-custom-react-hook-1098](https://dev.to/p4lm/error-handling-with-fetch-and-custom-react-hook-1098)

javascript çš„`fetch`åŠŸèƒ½è®©æˆ‘å°è±¡æ·±åˆ»çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒçœ‹èµ·æ¥å¾€å¾€å¦‚æ­¤ç®€å•ã€‚

```
fetch('/something.json')
  .then(res => res.json())
  .then(json => {
    // do something useful here with json...
  }); 
```

å½“æˆ‘åœ¨ä¸€ä¸ªæ‹‰å–è¯·æ±‚ä¸­çœ‹åˆ°åŒæ ·çš„äº‹æƒ…æ—¶ï¼Œæˆ‘å¹¶æ²¡æœ‰è¢«æ·±æ·±æ‰“åŠ¨ã€‚ä¸ï¼Œä»…ä»…å› ä¸ºè¿™åœ¨æ™´å¤©æœ‰æ•ˆå¹¶ä¸æ„å‘³ç€ä½ å°±å®Œäº†ã€‚æ‚¨è¿˜éœ€è¦é”™è¯¯å¤„ç†ï¼æ˜ç¡®å¦‚ä½•å¤„ç†é”™è¯¯æ¯”è®©ç”¨æˆ·ç›¯ç€ä¸€ä¸ªæ— é™æ—‹è½¬çš„ä¸œè¥¿è¦å¥½å¾—å¤šã€‚

ç”±äºå¯¹äºé 2xx å“åº”ï¼Œ`fetch`ä¸ä¼šå°†æ‚¨æ‰”è¿›`catch`å­å¥ï¼Œæ‚¨éœ€è¦æ£€æŸ¥`ok`å±æ€§æˆ–æ£€æŸ¥`status`ä»¥è·å¾—ç‰¹å®šçš„çŠ¶æ€ä»£ç ã€‚ä½†æ˜¯`then`å’Œ`catch`å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å‡½æ•°è¿›è¡Œé”™è¯¯å¤„ç†ã€‚

```
let isLoading = true;
let hasError = false;
let data = {};

function handleFetchResponse(response) {
  hasError = !response.ok;
  isLoading = false;
  return response.ok && response.json ? response.json() : data;
}

function fetchData() {
  return fetch(url)
    .then(handleFetchResponse)
    .catch(handleFetchResponse);
}

fetchData().then(data => {
  // do something useful here with data...
}); 
```

å½“ç„¶ï¼Œè¿™å®Œå…¨å–å†³äºæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä½†å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯æœ€å°çš„é”™è¯¯å¤„ç†ã€‚ä¸ºäº†è®©å›¢é˜Ÿåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼Œæˆ‘å‘ç°æœ‰å¿…è¦å°†å…¶å°è£…æˆä¸€ä¸ªå¯é‡ç”¨çš„å‡½æ•°ã€‚æˆ‘ç›®å‰åœ¨ React ä»£ç åº“ä¸­å·¥ä½œï¼Œæ‰€ä»¥è¿™æ˜¯æˆ‘å†™çš„è‡ªå®šä¹‰é’©å­ã€‚

```
import { useEffect, useState } from "react";

/*  Example
    initialUrl: "/_api/jobs"
    initialData: [] //usually empty array or object
*/
export const useOurApi = (initialUrl, initialData) => {
  const [url, setUrl] = useState(initialUrl);
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);
  const [fetchedData, setFetchedData] = useState(initialData);

  useEffect(() => {
    let unmounted = false;

    const handleFetchResponse = response => {
      setHasError(!response.ok);
      setIsLoading(false);
      return response.ok && response.json ? response.json() : initialData;
    };

    const fetchData = () => {
      setIsLoading(true);
      return fetch(url, { credentials: 'include' })
        .then(handleFetchResponse)
        .catch(handleFetchResponse);
    };

    if (initialUrl)
      fetchData().then(data => !unmounted && setFetchedData(data));

    return () => {
      unmounted = true;
    };
  }, [url]);

  return { isLoading, hasError, setUrl, data: fetchedData };
}; 
```

è¿™æ ·ï¼Œå½“ä½¿ç”¨è¿™ä¸ªæ•°æ®è·å–å‡½æ•°æ—¶ï¼Œæ‚¨å¯ä»¥è·å¾—ä¸€ä¸ªç°æˆçš„é”™è¯¯æŒ‡ç¤ºå™¨å’Œä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨ã€‚åœ¨ä¸€ä¸ª(ç®€ä½“) *Jobs.jsx* ä¸­è¿™æ ·ä½¿ç”¨ã€‚

```
import React from "react";
import { useOurApi } from "../Common/Services/HttpService";
import { Spinner } from "../Common/Components/Spinner";
import { ErrorMessage } from "../Common/Components/ErrorMessage";
import { JobFeed } from "./JobFeed";

export default function Jobs() {
  const url = `/_api/jobs`;
  const { data, isLoading, hasError } = useOurApi(url, {});

  if (isLoading) return <Spinner />;

  if (hasError)
    return <ErrorMessage message={`Failed to fetch open jobs ğŸ˜Ÿ`} />;

  return (
    <div className="our-grid">
      <JobFeed jobs={data} />
    </div>
  );
} 
```