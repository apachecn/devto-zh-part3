# Elixir æµå’Œå¤§å‹ HTTP å“åº”:å¤„ç†æ–‡æœ¬

> åŸæ–‡:[https://dev . to/alvisesus/elixir-stream-and-large-http-responses-processing-text-4min](https://dev.to/alvisesus/elixir-stream-and-large-http-responses-processing-text-4min)

ä½ å¯¹ä»™ä¸¹å’Œå‡¤å‡°æœ‰çƒ­æƒ…å—ï¼Ÿè®¢é˜… Poeticoding æ—¶äº‹é€šè®¯ï¼ŒåŠ å…¥å¿«ä¹çš„æ™®é€šè¯»è€…ï¼Œé€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶æ–°å¸–å­ã€‚

*   ç¬¬ 1 éƒ¨åˆ†â€”[å³æ—¶å¤„ç†å¤§å‹ HTTP å“åº”çš„ Elixir æµ](https://www.poeticoding.com/elixir-streams-to-process-large-http-responses-on-the-fly/)
*   ç¬¬ 2 éƒ¨åˆ†â€”â€”æœ¬æ–‡

ä½ å¯ä»¥åœ¨[poeticoding/http stream _ articles](https://github.com/poeticoding/httpstream_articles)GitHub repo ä¸Šæ‰¾åˆ°è¿™ç¯‡æ–‡ç« å’Œä¸Šä¸€ç¯‡æ–‡ç« çš„ä»£ç ã€‚æ‚¨åœ¨è¿™ä¸ª repo ä¸­æ‰¾åˆ°çš„ä»£ç å¹¶ä¸æ„å‘³ç€ç”¨äºç”Ÿäº§ï¼Œåªæ˜¯è¿™äº›æ–‡ç« å®éªŒçš„ä¸€éƒ¨åˆ†ã€‚

[åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ](https://www.poeticoding.com/elixir-streams-to-process-large-http-responses-on-the-fly/)ä¸­ï¼Œæˆ‘ä»¬å°† [HTTP å¼‚æ­¥å“åº”](https://www.poeticoding.com/download-large-files-with-httpoison-async-requests/)å’Œ[ä½¿ç”¨ Elixir Streams å¤„ç†å¤§æ–‡ä»¶](https://www.poeticoding.com/processing-large-csv-files-with-elixir-streams/)çš„æ¦‚å¿µæ”¾åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿èƒ½å¤Ÿä½¿ç”¨æˆ‘ä»¬çš„ [HTTPStream æ¨¡å—](https://github.com/poeticoding/httpstream_articles)è½»æ¾ä¸‹è½½å’Œä¿å­˜å¤§æ–‡ä»¶ã€‚

æˆ‘ä»¬å›´ç»• HTTPoison æ„å»ºçš„æµèƒ½å¤Ÿå‘å‡º HTTP åˆ†å—å“åº”çš„å—ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬é¿å…äº†å°†æ•´ä¸ªå“åº”ä¿å­˜åˆ°å†…å­˜ä¸­æ‰€å¸¦æ¥çš„å·¨å¤§å†…å­˜å½±å“ã€‚

[åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ](https://www.poeticoding.com/elixir-streams-to-process-large-http-responses-on-the-fly/#first-ride)çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œæ¯ä¸ªå—éƒ½è¢«ä¼ è¾“åˆ°ç®¡é“çš„å‡½æ•°ä¸­ï¼Œä¿å­˜åˆ°æˆ‘ä»¬çš„æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œç„¶åè¿›è¡Œåƒåœ¾æ”¶é›†ã€‚ç„¶åï¼Œå¾ˆå®¹æ˜“æ·»åŠ å‹ç¼©ï¼Œåªéœ€åœ¨ç®¡é“ä¸­åŒ…å«`StreamGzip.gzip`å‡½æ•°ã€‚

# [](#text-response)æ–‡å­—å›åº”

ä»¥å‰ï¼Œæˆ‘ä»¬å°†å“åº”è§†ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†å‹ç¼©å§”æ‰˜ç»™`StreamGzip`åº“ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦å¤„ç†ä¸€ä¸ªå¤§çš„æ–‡æœ¬æ–‡ä»¶çš„è¡Œã€‚ä¸ºäº†è®©å®ƒæ›´æœ‰è¶£å’Œæ›´ç°å®ï¼Œæˆ‘ä»¬å°†ä»ä»£ç æŒ‘æˆ˜çš„ç¬¬ä¸€å¤©è·å¾—ä¸€äº›çµæ„Ÿã€‚è¿˜æœ‰[josÃ©Valim](https://www.twitch.tv/josevalim)åˆ¶ä½œçš„ä¸€äº›å¾ˆé…·çš„è§†é¢‘ï¼Œä»–åœ¨è§†é¢‘ä¸­ä½¿ç”¨äº† Elixir æ¥è§£å†³ä»£ç å‡ºç°çš„æŒ‘æˆ˜ã€‚

æˆ‘å·²ç»åœ¨è¿™ä¸ªé“¾æ¥
ç”Ÿæˆå¹¶ä¸Šä¼ äº†ä¸€ä¸ª **125Mb** çš„æ–‡æœ¬æ–‡ä»¶

```
https://poeticoding-data.sfo2.digitaloceanspaces.com/httpstream/numbers.txt 
```

ç”¨**3000 ä¸‡è¡Œ**ã€‚æ¯è¡Œæœ‰ä¸€ä¸ªä» **-1000** åˆ° **1000**
çš„éšæœºæ•´æ•°

```
767
138
-701
98
... 
```

æˆ‘ä»¬å¸Œæœ›:

*   **1ã€‚**åœ¨ä¸‹è½½çš„åŒæ—¶ï¼Œä¸€è¡Œä¸€è¡Œåœ°åŠ¨æ€å¤„ç†è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚
*   **2ã€‚** [å°±åƒæˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†](https://www.poeticoding.com/elixir-streams-to-process-large-http-responses-on-the-fly)ä¸­æ‰€åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…å¤§çš„å†…å­˜å³°å€¼(æˆ‘ä»¬æ— æ³•å°†å®Œæ•´çš„å“åº”åŠ è½½åˆ°å†…å­˜ä¸­)
*   **3ã€‚**æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³å¤„ç†å‰ 30 è¡Œæ–‡æœ¬ï¼Œæˆ‘ä»¬åªæƒ³ä¸‹è½½æ‰€éœ€çš„å‰å‡ ä¸ªå—ã€‚

ä¸ºäº†åšä¸€äº›æµ‹è¯•ï¼Œä½ è¿˜å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªæ›´å°çš„ç‰ˆæœ¬ **4.5Mb** å’Œ**100 ä¸‡è¡Œ**T4ã€‘

```
https://poeticoding-data.sfo2.digitaloceanspaces.com/httpstream/numbers_small.txt 
```

è¿™ä¸æ‚¨åœ¨[poeticoding/http stream _ articles](https://github.com/poeticoding/httpstream_articles)repo ä¸­æ‰¾åˆ°çš„ç›¸åŒã€‚

# [](#what-we-are-going-to-build)æˆ‘ä»¬è¦å»ºé€ ä»€ä¹ˆ

ä¸ºäº†é€è¡Œå¤„ç† HTTP å“åº”ï¼Œæˆ‘ä»¬éœ€è¦ç±»ä¼¼äº
çš„ä¸œè¥¿

```
File.stream! "numbers.txt" #, [], :line 
```

å®ƒåˆ›å»ºä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„æµï¼Œé»˜è®¤æƒ…å†µä¸‹å‘å‡ºæ¯ä¸€è¡Œã€‚æˆ‘ä»¬æƒ³å¯¹ HTTP å¼‚æ­¥å“åº”åšä¸€äº›ç±»ä¼¼çš„äº‹æƒ…ã€‚

æˆ‘ä»¬ä¸æƒ³æ”¹å˜å½“å‰çš„ HTTPStream æ¨¡å—å®ç°ï¼Œè€Œæ˜¯æƒ³å……åˆ†åˆ©ç”¨ Elixir æµçš„å¯ç»„åˆæ€§ï¼Œç¼–å†™ä¸€ä¸ªå‡½æ•°æ·»åŠ åˆ°ç®¡é“ä¸­ï¼Œå°†å—è½¬æ¢æˆè¡Œã€‚

# [](#chunks-to-lines)å¤§å—å»çº¹

å¥½çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨æˆ‘ä»¬å·²ç»ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å®Œæˆçš„å®ç°å‘¢ï¼Ÿ

å‰ä¸€ä¸ªå®ç°çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æ„å»ºçš„æµåœ¨ä¸åŒºåˆ†è¡Œçš„æƒ…å†µä¸‹å‘å‡ºå—ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§èƒ½å‘å‡ºçº¿æ¡è€Œä¸æ˜¯å—çŠ¶çš„çµè¯æµã€‚

ä¸å¹¸çš„æ˜¯ï¼Œè¿™å¹¶ä¸åƒçœ‹èµ·æ¥é‚£ä¹ˆå®¹æ˜“:å°†å—åˆ†æˆè¡Œæ˜¯ä¸å¤Ÿçš„ã€‚è¿™åªæœ‰åœ¨ä¸€ä¸ªç®€å•è€Œå…·ä½“çš„æƒ…å†µä¸‹æ‰æˆç«‹:

```
["767\n138\n","-701\n98\n","-504\n22"] 
```

å…¶ä¸­åˆ—è¡¨çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå—ï¼Œæ¯ä¸ªå—ä»¥ä¸€ä¸ªæ–°è¡Œç»“æŸã€‚åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ†å‰²æ¯ä¸ªå—ï¼Œè¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²ï¼Œè¾“å‡ºç»“æœ

```
iex> String.split("767\n138\n")
["767","138",""] 
```

ä½†é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯æ‰€æœ‰çš„å—éƒ½æ˜¯è¿™ç§å½¢å¼ã€‚å®é™…ä¸Šï¼ŒåŒä¸€è¡Œçš„å¤šä¸ªéƒ¨åˆ†æ›´æœ‰å¯èƒ½ä½äºä¸åŒçš„å—ä¸Š

```
["767\n13","8\n-701\n98\n-","504\n22"] 
```

æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰ä¸¤ä¸ªå—æ²¡æœ‰ä»¥æ¢è¡Œç¬¦`\n`ç»“æŸï¼Œç¬¬äºŒä¸ªå—ä»ä¸Šä¸€ä¸ªå—ä¸­å¼€å§‹çš„è¡Œçš„æœ€åä¸€éƒ¨åˆ†å¼€å§‹ã€‚

# [](#streamtransform)è½¬æ¢

æˆ‘ä»¬ç°åœ¨è¦å®ç°ä¸€ä¸ªå‡½æ•° [`HTTPStream.lines(chunks_enum)`](https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L58) ï¼Œå®ƒå°†ä¸€ä¸²ç»„å—ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸²è¡Œã€‚

[![Chunks to Lines](../Images/0db0f1b7fabf3f14b17a7afeccba569e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--R1M9KfAp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/chunks-to-lines-function.png)

ç„¶åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªå‡½æ•°ä½œä¸ºç®¡é“çš„ä¸€éƒ¨åˆ†ï¼Œæ–¹å¼å¦‚ä¸‹:

```
HTTPStream.get("https://.../numbers.txt")
|> HTTPStream.lines()
|> Stream.map(fn line -> ... end)
... 
```

æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨ [`Enum.reduce`](https://hexdocs.pm/elixir/Enum.html#reduce/3) ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯è´ªå©ªçš„ï¼Œå®ƒä¼šåœ¨å†…å­˜ä¸­ä¿å­˜æ‰€æœ‰çš„è¡Œã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ [`Stream.transform`](https://hexdocs.pm/elixir/Stream.html#transform/3) æ¥è¡¨ç¤ºæ‡’æƒ°

```
Stream.transform(enum, initial_accumulator, fn element, acc ->
...
{list_of_elements_to_emit, new_accumulator}
end) 
```

è¿”å›çš„å…ƒç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æˆ‘ä»¬å°†è¦å‘å‡ºçš„å…ƒç´ åˆ—è¡¨ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯è¡Œã€‚

[![accumulating final part of the chunk and using it when processing next chunk](../Images/e9fda3fe0cfe721f6215342ff63b1410.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--v3wFj8Hy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/lines_and_accumulator.png)

æˆ‘ä»¬ä»å›¾ä¸­çœ‹åˆ°ï¼Œç´¯åŠ å™¨`acc`æ˜¯ç¬¬ä¸€ä¸ªå—çš„æœ€åä¸€éƒ¨åˆ†ï¼Œå¹¶è¢«åŠ åˆ°ç¬¬äºŒä¸ªå—çš„å‰é¢ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåä¸º [`next_lines`](https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L77) çš„å‡½æ•°ï¼Œå®ƒå°†ä¸€ä¸ªå—åˆ†å‰²æˆå•ç‹¬çš„è¡Œï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„:æˆ‘ä»¬æƒ³è¦å‘å‡ºçš„è¡Œå’Œå—çš„æœ€åä¸€éƒ¨åˆ†ã€‚

```
Stream.transform(chunks_enum, "", fn chunk, prev ->
  {lines, last_part} = next_lines(chunk, prev)
  {lines, last_part}
end) 
```

æˆ‘ä»¬çš„åˆå§‹ç´¯åŠ å™¨æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚åœ¨å¤„ç†ç¬¬ä¸€ä¸ªå—æ—¶ï¼Œè¿™ä¸ªç©ºå­—ç¬¦ä¸²å°†ä½œä¸º`prev`ä¼ é€’ã€‚

# [](#recursive-implementation)é€’å½’å®ç°

æˆ‘ä»¬ç°åœ¨éœ€è¦ç¼–å†™ [`next_lines(chunk,prev)`](https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L78) å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€’å½’æ¥å®ç°å®ƒï¼Œéå†æ¯ä¸ª UTF-8 å­—ç¬¦æ¥å¯»æ‰¾æ¢è¡Œç¬¦ã€‚è®°ä½ï¼Œä¸ºäº†è¡¨ç°å¾—åƒ`File.stream!`ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¿ç•™æ–°è¡Œ`\n`ã€‚

```
# https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L78

def next_lines(chunk, prev), do: next_lines(chunk,prev,[])

def next_lines(<<"\n"::utf8, rest::binary>>, prev, lines) do
next_lines(rest,"",[prev <> "\n" | lines])
end

def next_lines(<<c::utf8, rest::binary>>, prev, lines) do
  next_lines(rest,<<prev::binary, c::utf8>>,lines)
end

def next_lines(<<>>, prev, lines), do: {Enum.reverse(lines), prev} 
```

å¥½å§ï¼Œè¿™é‡Œå‘ç”Ÿäº†å¾ˆå¤šäº‹æƒ…ã€‚è®©æˆ‘ä»¬ä»å¤´å¼€å§‹

*   **`next_lines(chunk,prev\\"")`**
    ç¬¬ä¸€ä¸ªä»å¥åªæ˜¯ä¸€ä¸ªå¸®æ‰‹ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª`chunk`ï¼Œå’Œç´¯åŠ å™¨`prev`ã€‚è¯¥å‡½æ•°è°ƒç”¨`next_lines/3`ï¼Œä¼ é€’ä¸€ä¸ªç©ºçš„è¡Œåˆ—è¡¨ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚

*   **`next_lines(<<"\n"::utf8, rest::binary>>, prev, lines)`**
    æˆ‘ä»¬æ­£åœ¨æ¨¡å¼åŒ¹é…ä¸€ä¸ª UTF-8 å­—ç¬¦åºåˆ—ã€‚åªæœ‰å½“æˆ‘ä»¬åˆ°è¾¾ä¸€ä¸ªæ¢è¡Œç¬¦æ—¶ï¼Œè¿™ä¸ªå‡½æ•°æ‰ä¼šè¢«è°ƒç”¨ã€‚ç„¶åæˆ‘ä»¬é€’å½’åœ°è°ƒç”¨`next_lines`ï¼Œä¼ é€’æˆ‘ä»¬éœ€è¦å¤„ç†çš„å—çš„`rest`ï¼Œå°†ç´¯åŠ å™¨è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²`""`ï¼Œä¼ é€’æˆ‘ä»¬å·²ç»é¢„å…ˆæ”¾ç½®äº†ç´¯åŠ è¡Œçš„è¡Œåˆ—è¡¨`prev`ã€‚

*   **`next_lines(<<c::utf8, rest::binary>>,prev,lines)`**
    ç”±äºæ¯æ¬¡`c`éƒ½æ˜¯æ¢è¡Œç¬¦ï¼Œæ‰€ä»¥ä¸Šé¢çš„å­å¥æ˜¯åŒ¹é…çš„ï¼Œåœ¨è¿™ä¸ªå­å¥`c != "\n"`ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠå®ƒè¿½åŠ åˆ°`prev`ä¸­ï¼Œå¹¶é€’å½’è°ƒç”¨`next_lines`éå†ç»„å—çš„`rest`ã€‚

*   **`next_lines(<<>>,prev,lines)`**
    `<<>>`æ˜¯ä¸€ä¸ªç©ºäºŒè¿›åˆ¶æ•°ï¼Œè¡¨ç¤ºæˆ‘ä»¬å·²ç»åˆ°è¾¾äº†ç»„å—çš„æœ«å°¾ã€‚å‡ºäºè¡¨æ¼”çš„åŸå› ï¼Œæˆ‘ä»¬å¯¹å°è¯è¿›è¡Œäº†ä¿®æ”¹ã€‚
    `[prev <> "\n" | lines]`æ¯”`lines ++ [prev]`å¿«ï¼Œå°¤å…¶æ˜¯`lines`å•å­å¤§çš„æ—¶å€™ã€‚å½“æˆ‘ä»¬åˆ°è¾¾é€’å½’æœ«å°¾æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åè½¬è¡Œåˆ—è¡¨ã€‚

è®©æˆ‘ä»¬åœ¨ iex ä¸Šè¯•è¯•è¿™ä¸ªåŠŸèƒ½

```
# ["767\n13","8\n-701\n98\n-","504\n22"]
iex> {lines, prev} = HTTPStream.next_lines "767\n13"
{["767\n"], "13"}
iex> {lines, prev} = HTTPStream.next_lines "8\n-701\n98\n-", prev
{["138\n", "-701\n", "98\n"], "-"}
iex> {lines, prev} = HTTPStream.next_lines "504\n22", prev
{["-504\n"], "22"}
iex> prev
"22" 
```

å®Œç¾ï¼Œæ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ğŸ‘ã€‚æˆ‘ä»¬éå†ç»„å—åˆ—è¡¨ï¼Œå°†è·å¾—çš„`prev`ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè°ƒç”¨ã€‚

# [](#-raw-httpstreamlines-endraw-)`HTTPStream.lines`

`next_lines`è¿”å›ä¼ é€’ç»™`Stream.transform/3`çš„ reducer å‡½æ•°ä¸­æˆ‘ä»¬éœ€è¦è¿”å›çš„åŒä¸€ä¸ªå…ƒç»„ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§ç®€æ´çš„æ–¹å¼å†™`HTTPStream.lines/1`

```
def lines(chunks_enum) do
chunks_enum
|> Stream.transform("",&next_lines/2)
end 
```

è®©æˆ‘ä»¬åœ¨ iex
ä¸Šè¯•è¯•å§

```
iex> ["767\n13","8\n-701\n98\n-","504\n22"] \
...> |> HTTPStream.lines() \
...> |> Enum.each(&IO.inspect/1)
"767\n"
"138\n"
"-701\n"
"98\n"
"-504\n"
:ok 
```

å—¯ğŸ¤” ...è¿™é‡Œæœ‰é—®é¢˜ã€‚æœ€åä¸€è¡Œ`"22"`ä¸è§äº†ã€‚

## [](#emitting-last-line)æ”¾å‡ºæœ€åä¸€è¡Œ

ä¹‹æ‰€ä»¥æ²¡æœ‰å‘å‡ºå®ƒï¼Œæ˜¯å› ä¸ºå®ƒæ²¡æœ‰ä»¥æ¢è¡Œç¬¦ç»“æŸï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªç´¯åŠ å™¨(`prev`)è¢«å¡ä½ã€‚æˆ‘ä»¬å¿…é¡»åœ¨æµç»“æŸæ—¶å‘å‡ºå®ƒï¼Œä½†æ˜¯ä½¿ç”¨`Stream.transform/3`reducer å‡½æ•°ä¸çŸ¥é“æµä»€ä¹ˆæ—¶å€™ç»“æŸï¼(å¦‚æœä½ çŸ¥é“æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æ•æ‰åˆ°æµçš„ç»“å°¾ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘)

ä¸ºäº†è®©`next_lines/2`çŸ¥é“æµä»€ä¹ˆæ—¶å€™åˆ°è¾¾äº†æœ«å°¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„ä¸€ä¸ªå˜é€šæ–¹æ³•æ˜¯åœ¨å—æµçš„æœ«å°¾æ·»åŠ ä¸€ä¸ª`:end`åŸå­ã€‚`next_lines/2`than have to handle the case with a specific å­å¥

```
def next_lines(:end,prev), do: { [prev], ""} 
```

å‘å‡ºæœ€åä¸€æ¡çº¿ã€‚ç´¯åŠ å™¨è¢«è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä½†æ­¤æ—¶å®ƒå¯ä»¥æ˜¯ä»»ä½•å€¼ã€‚

è®©æˆ‘ä»¬åœ¨ iex
ä¸Šå†è¯•ä¸€æ¬¡

```
iex> ["767\n13","8\n-701\n98\n-","504\n22", :end] \
...> |> HTTPStream.lines() \
...> |> Enum.each(&IO.inspect/1)
"767\n"
"138\n"
"-701\n"
"98\n"
"-504\n"
"22"
:ok 
```

å¤ªå¥½äº†ï¼ŒæˆåŠŸäº†ï¼ğŸ‰

ä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¦‚ä½•åœ¨ HTTP åˆ†å—å“åº”æµçš„æœ«å°¾æ·»åŠ ä¸€ä¸ª`:end`åŸå­å‘¢ï¼Ÿ

## [](#emitting-end-at-the-end-of-the-streamed-http-response)å‘å‡º:end åœ¨æµä¼ è¾“çš„ HTTP å“åº”çš„æœ«å°¾

> å¦‚æœä½ æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºåŒºåˆ†äº«ï¼ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»

æˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„ [`HTTPStream.get(url)`](https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L31) å‡½æ•°åšä¸€ä¸ªå°è€Œé‡è¦çš„æ”¹å˜ã€‚

```
# HTTPStream.get/1
def get(url) do
  Stream.resource(
    start_fun,

    # next_fun
    fn
      #first clause
%HTTPoison.AsyncResponse{id: id}=resp ->
    receive do
...
%HTTPoison.AsyncEnd{id: ^id}->
  # emitting :end
{[:end], {:end, resp}}
end

#second clause
    {:end, resp} -> 
    {:halt, resp}
end,

after_fun
  )
end 
```

*   **1ã€‚**å½“æˆ‘ä»¬æ”¶åˆ°`%HTTPoison.AsyncEnd{}`æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å·²ç»åˆ°è¾¾äº† HTTP å“åº”çš„æœ«å°¾ã€‚æˆ‘ä»¬ä¸åªæ˜¯æš‚åœæµï¼Œè€Œæ˜¯å‘å‡º`:end`å¹¶è®¾ç½®ä¸€ä¸ªæ–°çš„ç´¯åŠ å™¨`{:end, resp}`ï¼Œå…¶ä¸­`resp`æ˜¯`%HTTPoison.AsyncResponse{}`ç»“æ„ã€‚

*   **2ã€‚**å‘å°„`:end`åï¼Œå†æ¬¡è°ƒç”¨`next_fun`ã€‚è¿™æ¬¡ç´¯åŠ å™¨æ˜¯æˆ‘ä»¬åˆšåˆšè®¾ç½®çš„é‚£ä¸ªï¼Œ`{:end, resp}`ï¼Œå®ƒçš„æ¨¡å¼ä¸æˆ‘ä»¬çš„`next_fun`çš„ç¬¬äºŒä¸ªå­å¥ç›¸åŒ¹é…ã€‚

[![AsyncEnd, emits :end and :halt](../Images/9992edc13f883c4d9a81564939295d5f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s---dH7DZ-e--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/async_end__emits_end__halt.png)

æˆ‘ä¸å–œæ¬¢è¿™ä¸ªå˜åŒ–çš„ä¸€ç‚¹æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬æ€»æ˜¯å¿…é¡»å¤„ç†æœ€åçš„`:end`ï¼Œå°¤å…¶æ˜¯åœ¨å°†æµä¿å­˜åˆ°æ–‡ä»¶ä¸­çš„æ—¶å€™ã€‚

```
HTTPStream.get("https://.../large_image.tiff")
|> Stream.reject(&match?(:end,&1))
|> Stream.into(File.stream!("image.tiff.gz"))
|> Stream.run() 
```

ç¬¬äºŒè¡Œæ¨¡å¼ä¸­çš„å‡½æ•°åŒ¹é…æ¯ä¸ªå—å¹¶è¿‡æ»¤æ‰`:end`åŸå­ã€‚

é€šè¿‡ä¼ é€’ç»™ [`HTTPStream.get(url, emit_end)`çš„é€‰é¡¹æ¥å¯ç”¨å’Œç¦ç”¨æœ€ç»ˆçš„`:end`å¯èƒ½æ›´å¥½ï¼Œå°±åƒä½ åœ¨ GitHub](https://github.com/poeticoding/httpstream_articles/blob/36bc2167b7024a990b04b28f9447fb9bc0e0310e/lib/http_stream.ex#L3) ä¸Šçœ‹åˆ°çš„ç‰ˆæœ¬ã€‚

## [](#sum-numbers-in-30m-lines-remote-file)æ±‚å’Œ 30M è¡Œè¿œç¨‹æ–‡ä»¶ä¸­çš„æ•°å­—

è®©æˆ‘ä»¬ç”¨æˆ‘ä»¬å®ç°çš„ä¸œè¥¿æ¥å¤„ç†ä¸€ä¸ª 125MB çš„è¿œç¨‹æ–‡æœ¬æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å« **30M çš„**æ•°å­—ï¼Œæ¯ä¸ªæ•°å­—ç”±ä¸€ä¸ªæ–°è¡Œ`\n`åˆ†éš”ã€‚åœ¨åŠ¨æ€å¤„ç†è¿™äº›è¡Œæ—¶ï¼Œæˆ‘ä»¬å°†è¿™äº›æ•°å­—ç›¸åŠ å¾—åˆ°æ€»æ•°ã€‚

```
"https://poeticoding-data.sfo2.digitaloceanspaces.com/httpstream/numbers.txt"
|> HTTPStream.get()
|> HTTPStream.lines()
|> Stream.map(fn line-> 
case Integer.parse(line) do
{num, _} -> num
:error -> 0
end
end)
|> Enum.sum()
|> IO.puts()

## OUTPUT
STATUS: : 200
HEADERS: : [
  {"Content-Length", "131732144"},
  {"Accept-Ranges", "bytes"},
  {"Content-Type", "text/plain"},
  ...
]

12468816 
```

å¤ªæ£’äº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ç»“æœ: *12468816* ï¼ğŸ‰

ä½¿ç”¨ Erlang Observer æ—¶ï¼Œæˆ‘æœ‰æ—¶ä¼šçœ‹åˆ°ä¸€äº›å†…å­˜å³°å€¼(ä»ç„¶ä½äº 100Mb ),æœ‰æ—¶è¿™æ¡çº¿å‡ ä¹æ˜¯å¹³çš„ã€‚æˆ‘è®¤ä¸ºè¿™å¯èƒ½ä¸å¤§å—æœ‰å¤šå¤§æœ‰å…³ã€‚

[![memory spike](../Images/cabcc44ad330e4b82be11272af8fee5c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--eEovujo7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/erlang_observer_spike.png)

åœ¨ [GitHub repo ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª`memory_test.exs`](https://github.com/poeticoding/httpstream_articles/commit/cb6953847f49345d86ccf48905dfe777624eff45) è„šæœ¬ï¼Œç”¨æ¥æŸ¥çœ‹ä¸åŒå—å¤§å°çš„`HTTPStream.line`å†…å­˜åˆ†é…ã€‚å³ä½¿æ˜¯ä¸€ä¸ª 4.5Mb çš„æ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å¤¸å¤§å—çš„å¤§å°(åƒ`2_000_000`)ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå·¨å¤§çš„å†…å­˜å³°å€¼ã€‚ç”¨`2_000`çº¿å‡ ä¹æ˜¯å¹³çš„ã€‚

[![2mb vs 2kb chunk](../Images/57c306a3cba2741acd28876763ee740f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--1qi47CoR--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/2mb_vs_2kb__chunk.png)

å¦‚æœèƒ½åœ¨ HTTPoison é€‰é¡¹ä¸­è®¾ç½®ä¸€ä¸ªæœ€å¤§å—å¤§å°å°±å¤ªå¥½äº†ï¼Œä¸å¹¸çš„æ˜¯æˆ‘æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é€‰é¡¹å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

## [](#stringsplit)ä¸²éŸ³

è®©æˆ‘ä»¬çœ‹çœ‹ [`HTTPStream.lines(chunks)`](https://github.com/poeticoding/httpstream_articles/blob/master/lib/http_stream.ex#L63) å‡½æ•°çš„å¦ä¸€ç§å†™æ³•ã€‚åœ¨å‰é¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†é€’å½’æ¥éå†å—ä¸­çš„æ¯ä¸ªå­—ç¬¦å¹¶æŸ¥æ‰¾æ¢è¡Œç¬¦ã€‚

å¦‚æœæˆ‘ä»¬ä¸éœ€è¦ä¿ç•™æ¢è¡Œç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥å°† [`String.split/2`](https://hexdocs.pm/elixir/String.html#split/2) ä¸`Stream.transform/3`ä¸€èµ·ä½¿ç”¨ã€‚

```
def lines(enum) do
  enum
  |> Stream.transform("",fn 
    :end, prev -> 
      {[prev],""}
    chunk, prev ->
      [last_line | lines] = 
        String.split(prev <> chunk,"\n")
        |> Enum.reverse()
      {Enum.reverse(lines),last_line}
  end)
end 
```

è¿™ä¸ªæƒ³æ³•å’Œæˆ‘ä»¬ä¹‹å‰åšçš„å·®ä¸å¤šã€‚æˆ‘ä»¬å°†å—åˆ†æˆè¡Œï¼Œåˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ æˆä¸ºç´¯åŠ å™¨ï¼Œå®ƒè¿æ¥åˆ°ä¸‹ä¸€ä¸ªå—ã€‚

çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•æå–è¡Œåˆ—è¡¨çš„æœ€åä¸€é¡¹ã€‚

```
lines = String.split(prev <> chunk, "\n")
[last_line | rev_lines] = Enum.reverse(lines)
{ Enum.reverse(rev_lines), last_line } 
```

*   æˆ‘ä»¬æ‹†åˆ†ä¸²æ¥çš„å­—ç¬¦ä¸²`prev <> chunk`è·å¾—ä¸€ä¸ªè¡Œåˆ—è¡¨ã€‚æˆ‘ä»¬ç°åœ¨éœ€è¦å¾—åˆ°åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚
*   æˆ‘ä»¬åè½¬åˆ—è¡¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å…ƒç´ åˆ—è¡¨ã€‚ç°åœ¨ï¼Œ`Enum.reverse(lines)`çš„å¤´éƒ¨æ˜¯`lines`çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚
*   `rev_lines`æ˜¯æˆ‘ä»¬æƒ³è¦å‘å‡ºçš„è¡Œçš„åˆ—è¡¨ï¼Œä½†æ˜¯é¡ºåºä¸å¯¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘å‡º`Enum.reverse(rev_lines)`å¹¶å°†`last_line`è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç´¯åŠ å™¨ã€‚

[![split and extract last](../Images/3dad4f162f22c6e1683da33a2a7974ae.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--sA4aMG_2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/rev_lines.png)

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­

```
iex> chunks = ["767\n138\n-701\n98\n-5", "04\n22\n375"]
iex> [chunk | remaining_chunks] = chunks
iex> chunk
"767\n138\n-701\n98\n-5"

iex> lines = String.split(chunk,"\n")
["767", "138", "-701", "98", "-5"]
iex> [last_line | rev_lines] = Enum.reverse(lines)
["-5", "98", "-701", "138", "767"]
iex> last_line
"-5"
iex> lines_to_emit = Enum.reverse(rev_lines)
["767", "138", "-701", "98"]

#let's process another chunk
iex> [next_chunk | remaining_chunks] = remaining_chunks
iex> next_chunk
"04\n22\n375"
# we need to prepend last_line
iex> chunk = last_line <> next_chunk
"-504\n22\n375"
iex> lines = String.split(chunk,"\n")
["-504", "22", "375"] 
```

äº‹å®è¯æ˜ï¼Œè¿™ä¸ªå®ç°æ¯”å‰ä¸€ä¸ªå¿«å¾—å¤šã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä¸€äº›åŸºå‡†æµ‹è¯•

# [](#benchmark-raw-httpstreamline-endraw-)åŸºå‡†`HTTPStream.line`

å¦‚æœæ‚¨æƒ³åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šè¿è¡Œè¿™ä¸ªåŸºå‡†æµ‹è¯•ï¼Œæ‚¨å¯ä»¥åœ¨[poeticoding/http stream _ articles](https://github.com/poeticoding/httpstream_articles)ä¸Šæ‰¾åˆ°æ‰€æœ‰å†…å®¹ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ç”±
åˆ›å»ºçš„æµ

```
File.stream!("numbers_small.txt") 
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå‘å‡ºæ–‡ä»¶çš„è¡Œã€‚æˆ‘ä»¬æƒ³å¯¹æ¯”ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å’Œ`HTTPStream.line`çš„é€Ÿåº¦ã€‚

ä¸ä½¿ç”¨è¿œç¨‹æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ›´å°çš„~4Mb ç‰ˆæœ¬ï¼Œ`numbers_small.txt`ä½ å¯ä»¥åœ¨ GitHub repo ä¸Šæ‰¾åˆ°ã€‚

æˆ‘ä»¬ç°åœ¨éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥æ¨¡æ‹Ÿç”±`HTTPStream.get`äº§ç”Ÿçš„å—æµã€‚

```
chunk_stream = File.stream!("numbers_small.txt",[],16_000) 
```

å°†å—å¤§å°ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™`File.stream!/3`ï¼Œæµ(è€Œä¸æ˜¯è¡Œ)å°†å‘å‡ºå—(åœ¨æœ¬ä¾‹ä¸­ä¸º 16kb)ã€‚

åœ¨è„šæœ¬ [bench_lines.exs](https://github.com/poeticoding/httpstream_articles/blob/9bdff69e2a7db09b2af95dbcde75dc16143a2860/bench_lines.exs) ä¸­æˆ‘ä»¬ä½¿ç”¨äº†[Benchee](https://github.com/bencheeorg/benchee)T4ã€‘

```
# bench_lines.exs
chunk_stream = File.stream!("numbers_small.txt",[],16_000)
lines_stream = File.stream!("numbers_small.txt", [], :line)

stream_sum = fn enum ->
  enum
  |> Stream.map(fn line-> 
case Integer.parse(line) do
{num, _} -> num
:error -> 0
end
end)
|> Enum.sum()
end

Benchee.run(%{
"File.stream! :line" => fn ->
lines_stream 
|> stream_sum.()
end,
"with next_lines" => fn ->
chunk_stream
|> HTTPStream.lines(:next_lines)
|> stream_sum.()
end,
"with String.split" => fn ->
chunk_stream
|> HTTPStream.lines(:string_split)
|> stream_sum.()
end
},
  time: 10
) 
```

```
$ mix run bench_lines.exs

Name                        ips        average
with String.split          3.35      298.30 ms
File.stream! :line          2.08      481.22 ms
with next_lines            1.14      875.01 ms

Comparison:
with String.split          3.35
File.stream! :line          2.08 - 1.61x slower +182.93 ms
with next_lines            1.14 - 2.93x slower +576.71 ms 
```

æœ‰è¶£çš„æ˜¯ç‰ˆæœ¬`"with String.split"`ç”šè‡³æ¯”`"File.stream! :line"`è¿˜è¦å¿«ï¼Œè€Œæˆ‘ä»¬åšçš„ç¬¬ä¸€ä¸ªå®ç°æ˜¯æœ€æ…¢çš„ã€‚

è€å®è¯´ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆç‰ˆæœ¬`"with String.split"`æ˜¯æœ€å¿«çš„ä¸€ä¸ªã€‚ä¹Ÿè®¸æ˜¯å¯¹`String.split/2`å‡½æ•°çš„ä¸€äº›ä¼˜åŒ–ï¼Ÿå¦‚æœä½ å¯¹è¿™äº›ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œæˆ‘å·²ç»åœ¨ elixir è®ºå›ä¸Šå¼€äº†ä¸€ä¸ªå…³äºè¿™ä¸ªçš„è¯é¢˜:[ä»ä¸€ä¸ªå¤§å—çš„æšä¸¾ä¸­æµè¡Œ](https://elixirforum.com/t/streaming-lines-from-an-enum-of-chunks/21244/2)ã€‚

å°†å—å¤§å°ä»`16_000`å‡å°åˆ°`2_000`ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`"with String.split"`å’Œ`"with next_lines"`éƒ½æ¯”
å¿«ä¸€ç‚¹

```
chunk_stream = File.stream!("numbers_small.txt",[],2000)

Name                        ips        average  
with String.split          3.79      263.67 ms
File.stream! :line          2.06      484.98 ms
with next_lines            1.42      706.48 ms

Comparison:
with String.split          3.79
File.stream! :line          2.06 - 1.84x slower +221.31 ms
with next_lines            1.42 - 2.68x slower +442.81 ms 
```

å—è¶Šå°ï¼Œæ‰€æœ‰çš„æ‹†åˆ†ã€åè½¬å’Œè¿æ¥æ“ä½œéƒ½è¶Šå¿«ã€‚

# [](#sum-the-first-30-numbers)å¯¹å‰ 30 ä¸ªæ•°å­—æ±‚å’Œ

æˆ‘ä»¬æ„å»ºçš„è¡Œæµæ˜¯æƒ°æ€§çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åªè·å–å‰ 30 è¡Œå¹¶æš‚åœæµï¼Œè€Œä¸éœ€è¦ä¸‹è½½æ•´ä¸ª HTTP å“åº”ã€‚

å–å‰ 30 è¡Œæˆ‘ä»¬ç”¨ [`Enum.take/2`](https://hexdocs.pm/elixir/Enum.html#take/2) ã€‚

```
"https://poeticoding-data.sfo2.digitaloceanspaces.com/httpstream/numbers.txt"
|> HTTPStream.get()
|> HTTPStream.lines()
|> Stream.map(fn line-> 
case Integer.parse(line) do
{num, _} -> num
:error -> 0
end
end)

|> Enum.take(30)

|> Enum.sum()
|> IO.puts() 
```

ä½ å¯ä»¥åœ¨ [sum_30_lines.exs](https://github.com/poeticoding/httpstream_articles/blob/master/sum_30_lines.exs)
ä¸­æ‰¾åˆ°è¿™æ®µä»£ç 

```
$ mix run sum_30_lines.exs
STATUS: : 200
HEADERS: : [
  {"Content-Length", "131732144"},
  {"Accept-Ranges", "bytes"},
  {"Content-Type", "text/plain"},
  ...
]
END_FUN

1393 
```

åº”è¯¥ä¼šå¾ˆå¿«ã€‚ä¸€æ—¦ä½¿ç”¨äº† 30 è¡Œï¼Œæµå°±è¢«åœæ­¢ï¼ŒHTTP è¿æ¥è¢«å…³é—­ã€‚

ä½ å¯¹ä»™ä¸¹å’Œå‡¤å‡°æœ‰çƒ­æƒ…å—ï¼Ÿè®¢é˜… Poeticoding æ—¶äº‹é€šè®¯ï¼ŒåŠ å…¥å¿«ä¹çš„æ™®é€šè¯»è€…ï¼Œé€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶æ–°å¸–å­ã€‚