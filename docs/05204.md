# ä½¿ç”¨æ•…äº‹ä¹¦ä½œä¸ºè§†è§‰æµ‹è¯•å¹³å°

> åŸæ–‡:[https://dev . to/emasuriano/using-story book-as-a-powerful-visual-testing-platform-85c](https://dev.to/emasuriano/using-storybook-as-a-powerful-visual-testing-platform-85c)

æˆ‘ä½¿ç”¨è¿™ç§æµ‹è¯•ç­–ç•¥(ä¸æ›¿ä»£å…¶ä»–ç­–ç•¥)çš„ç»éªŒï¼Œä»¥åŠä¸æˆ‘å½“å‰å¼€å‘å·¥å…·çš„é›†æˆã€‚

æˆ‘çš„å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­ä¸€ç›´éƒ½æœ‰è§†è§‰æµ‹è¯•ï¼Œç›´åˆ°å‡ å‘¨å‰ï¼Œæˆ‘ç»ˆäºå†³å®šå°†å®ƒæ ‡è®°ä¸ºå®Œæˆã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†åˆ†äº«æˆ‘ä½¿ç”¨è¿™ç§æµ‹è¯•ç­–ç•¥çš„ç»éªŒ(å®ƒä¸ä¼šå–ä»£å…¶ä»–çš„æµ‹è¯•ç­–ç•¥)ä»¥åŠä¸æˆ‘å½“å‰çš„å¼€å‘å·¥å…·[æ•…äº‹ä¹¦](https://storybook.js.org/)çš„é›†æˆã€‚

å¦‚æœä½ ä¸çŸ¥é“æ•…äº‹ä¹¦æ˜¯ä»€ä¹ˆï¼Œè¿™æ˜¯ä»–ä»¬åœ¨å®˜ç½‘ä¸Šæä¾›çš„å®šä¹‰:

> Storybook æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œç”¨äºç‹¬ç«‹å¼€å‘ Reactã€Vue å’Œ Angular çš„ UI ç»„ä»¶ã€‚å®ƒä½¿æ„å»ºä»¤äººæƒŠå¹çš„ ui å˜å¾—æœ‰æ¡ç†å’Œé«˜æ•ˆã€‚

å…³äº**è§†è§‰æµ‹è¯•**ï¼Œè¿™æ˜¯ä¸€ç§æµ‹è¯•æ–¹æ³•ï¼ŒåŒ…æ‹¬æ‹æ‘„çœŸå®çš„å›¾ç‰‡ï¼Œç„¶åä¸ä¹‹å‰çš„ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒã€‚è¿™ç§æ¯”è¾ƒæ˜¯é€šè¿‡æ¯”è¾ƒä¸¤å¼ å›¾ç‰‡å¹¶æ£€æŸ¥åƒç´ æ˜¯å¦åŒ¹é…æ¥è¿›è¡Œçš„ã€‚

å¦‚æœä½ å·²ç»çŸ¥é“ [*å¿«ç…§æµ‹è¯•*](https://jestjs.io/docs/en/snapshot-testing) çš„æ¦‚å¿µï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚åŒºåˆ«åœ¨äºä½ æ¯”è¾ƒçš„æ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ä¸€äº›ç»“æœä»£ç ã€‚

<figure>[![Example of Visual Testing](../Images/332cd64a3bebf5b45394aba80b4ba661.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--GIkhwpuU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/0%2AQv-mDozlY2FZfkdr.png) 

<figcaption>è§†è§‰æµ‹è¯•å·®å¼‚çš„ä¾‹å­</figcaption>

</figure>

å¦‚æœä½ åœ¨æƒ³â€œä½†æ˜¯è¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯å¦‚ä½•è”ç³»åœ¨ä¸€èµ·çš„ï¼Ÿâ€ã€‚Storybook åšæŒç‹¬ç«‹å¼€å‘ç»„ä»¶ï¼Œè¿™æ˜¯è¿›è¡Œè§†è§‰æµ‹è¯•çš„æœ€ä½³æ–¹æ¡ˆï¼Œä»¥é¿å…å›¾åƒä¸­ä¸å¿…è¦çš„å·®å¼‚ã€‚å¯¹è¿™ç§æ–¹æ³•çš„ä¸€ç§æ€è€ƒæ–¹å¼å°±åƒæ˜¯ï¼Œ**æ•…äº‹ä¹¦ä¸­å®šä¹‰çš„æ¯ä¸ªæ•…äº‹**åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­éƒ½æ˜¯ä¸€ä¸ª**è§†è§‰æµ‹è¯•**ã€‚

åœ¨æ£€æŸ¥å®ç°ä¹‹å‰ï¼Œæœ€åä¸€ä»¶äº‹æ˜¯ï¼Œæˆ‘å°è¯•è¿‡ä¸€äº›ä¼˜ç§€çš„æœåŠ¡ï¼Œå®ƒä»¬å·¥ä½œå¾—éå¸¸å®Œç¾ï¼Œæ¯”å¦‚[ç€è¥¿](https://percy.io)ã€[åº”ç”¨å·¥å…·](https://applitools.com/)ç­‰ç­‰ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³å±•ç¤ºä¸€ä¸‹å®ç°å¯è§†åŒ–æµ‹è¯•å·¥ä½œæµçš„*æ‰‹å·¥æ–¹å¼*ï¼Œå®ƒå¯¹äºæåˆ°çš„æœåŠ¡æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ã€‚

[![Show time](../Images/8db856815ccf68977f27c44217cfc0f0.png)T2ã€‘](https://i.giphy.com/media/UDjF1zMreMld6/giphy.gif)

è®©æˆ‘ä»¬ä»ä¸€ä¸ªå…¨æ–°çš„é¡¹ç›®å¼€å§‹ï¼Œç”¨ [create-react-app](https://github.com/facebook/create-react-app) å¼•å¯¼å®ƒï¼Œå¹¶ä½¿ç”¨å®ƒçš„ CLI å®‰è£… Storybookã€‚

```
$ npx create-react-app visual-testing-with-storybook
$ cd visual-testing-with-storybook
$ npx -p @storybook/cli sb init 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ`yarn storybook`æ¥æ£€æŸ¥ä¸€åˆ‡æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„ä¸¤ä¸ªæ•…äº‹çš„ä¸»é¡µã€‚

<figure>[![](../Images/e9ce92a2e1158b7670384bc9da76579c.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--cAHgQ7wP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A31UV2T30NYUI0lIrm7JuOA.png) 

<figcaption>æ•…äº‹ä¹¦é¦–é¡µ</figcaption>

</figure>

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ç»„ä»¶ã€‚æˆ‘å†³å®šåˆ›å»ºä¸€ä¸ªåä¸º`DuplicationButton`çš„ç®€å•æŒ‰é’®ï¼Œç”¨æˆ·æ¯æ¬¡ç‚¹å‡»å®ƒæ—¶ï¼Œprops æä¾›çš„`children`éƒ½ä¼šè¢«å¤åˆ¶ã€‚ä¸æ˜¯çœŸçš„æœ‰ç”¨ï¼Œä½†å®ƒå°†ä½œä¸ºä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼

```
import React, { useState } from 'react';

const ButtonStyle = {
  padding: '10px',
  borderRadius: '5px',
  fontSize: '16px',
  border: 'pink 3px solid',
};

const DuplicationButton = ({ children }) => {
  const [count, setCount] = useState(1);

  return (
    <button style={ButtonStyle} onClick={() => setCount(count + 1)}>
      {new Array(count).fill(children)}
    </button>
  );
};

export default DuplicationButton; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬ä¸ºç»„ä»¶æ·»åŠ ä¸€äº›æ•…äº‹ã€‚

```
import React from 'react';
import { storiesOf } from '[@storybook/react](http://twitter.com/storybook/react)';
import DuplicationButton from './DuplicationButton';

storiesOf('DuplicationButton', module)
  .add('Good', () => (
    <DuplicationButton>
      <span role="img" aria-label="angel">
        ğŸ˜‡
      </span>
    </DuplicationButton>
  ))
  .add('Bad', () => (
    <DuplicationButton>
      <span role="img" aria-label="devil">
        ğŸ˜ˆ
      </span>
    </DuplicationButton>
  )); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯å®ƒåœ¨æ•…äº‹ä¹¦é‡Œçš„æ ·å­ã€‚

<figure>[![Demo DuplicationButton stories](../Images/3528a1e7886438bc2b89f0dea448b36f.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--CNcfKxVX--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn-images-1.medium.com/max/666/1%2AHAYpOidYjbMMumg3V9yFcA.gif) 

<figcaption>æ¼”ç¤ºå¤åˆ¶æŒ‰é’®æ•…äº‹</figcaption>

</figure>

### [](#generating-tests-based-on-stories)åŸºäºæ•…äº‹ç”Ÿæˆæµ‹è¯•ğŸ§ª

ä¸ºäº†åœ¨æ¯ä¸ªæ•…äº‹ä¸­å®ç°ä¸€ä¸ªæµ‹è¯•ï¼ŒStorybook ä¸­æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ’ä»¶å«åš [storyshots](https://www.npmjs.com/package/@storybook/addon-storyshots) ã€‚ä¸ºäº†å®‰è£…å®ƒï¼Œä½ éœ€è¦è¿è¡Œ:

```
$ yarn add -D @storybook/addon-storyshots react-test-renderer 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨åˆå§‹åŒ–`storyshots`çš„åœ°æ–¹åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ã€‚å§‘ä¸”ç§°ä¹‹ä¸º`storyshots.test.js`ã€‚

```
// src/storyshots.test.js 
**import** initStoryshots **from**'@storybook/addon-storyshots';  

initStoryshots({ _/\* configuration options \*/_ }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†è¿è¡Œå®ƒï¼Œæ‰§è¡Œ`yarn test`ã€‚ç°åœ¨ï¼Œå¯¹äºæ¯ä¸ªæ•…äº‹ï¼Œéƒ½æœ‰ä¸€ä¸ªä½¿ç”¨*å¿«ç…§*çš„æµ‹è¯•ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ£€æŸ¥æ•…äº‹çš„è¾“å‡º(ç»„ä»¶æ¸²æŸ“)æ˜¯ä»€ä¹ˆã€‚è¿™äº›*å¿«ç…§*å°†åœ¨æˆ‘ä»¬æ¯æ¬¡è¿è¡Œæµ‹è¯•æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚æœå®ƒä»¬ä¸ä¹‹å‰çš„æœ‰å·®å¼‚ï¼Œæµ‹è¯•å°†ä¼šå¤±è´¥ã€‚

<figure>[![Test result with storyshots](../Images/747216c5246cf237b12a67e2095da81f.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ccfM3qCv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1008/1%2Ad2UMLYiwjtxJMMzr2VGiog.png) 

<figcaption>æµ‹è¯•ç»“æœä¸æ•…äº‹é•œå¤´</figcaption>

</figure>

[![Visual Magic](../Images/1c84c354bf1d340d96202dd6a4a345f1.png)T2ã€‘](https://i.giphy.com/media/7SKOwf1nD6j6XhfLMG/giphy.gif)

#### [](#lets-get-visual)æˆ‘ä»¬æ¥ç›®æµ‹ä¸€ä¸‹ï¼ğŸŒˆ

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå‡½æ•°`initStoryshots`æ¥å—ä¸€ä¸ªå¸¦æœ‰é€‰é¡¹`test`çš„é…ç½®å¯¹è±¡ï¼Œè¯¥é€‰é¡¹å…è®¸æˆ‘ä»¬æ”¹å˜æ¯ä¸ªæ•…äº‹/æµ‹è¯•çš„æ¯”è¾ƒæ–¹æ³•ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªåä¸º[story shot-puppet er](https://www.npmjs.com/package/@storybook/addon-storyshots-puppeteer)çš„é™„åŠ ç»„ä»¶ï¼Œå®ƒä½œä¸ºåç§°çŠ¶æ€åˆ›å»ºäº†ä¸€ä¸ªæµè§ˆå™¨å®ä¾‹ï¼Œå¯¼èˆªåˆ°æ•…äº‹ï¼Œæ‹æ‘„ç…§ç‰‡å¹¶ä¸ä¹‹å‰çš„ç…§ç‰‡è¿›è¡Œæ¯”è¾ƒï¼ä¸ºäº†å®‰è£…å®ƒ:

```
$ yarn add -D @storybook/addon-storyshots-puppeteer 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨`storyshots`æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦è¦†ç›–`test`ä¸æ¥è‡ªæœ¨å¶å¸ˆé™„åŠ ç»„ä»¶çš„`imageSnapshot`çš„æ¯”è¾ƒã€‚æ­¤å¤–ï¼Œéœ€è¦æŒ‡å®šè¿è¡Œ storybook çš„ URLï¼Œä»¥ä¾¿çŸ¥é“å¯¼èˆªåˆ°å“ªé‡Œã€‚

```
// src/storyshots.test.js
import initStoryshots from '[@storybook/addon-storyshots](http://twitter.com/storybook/addon-storyshots)';
import { imageSnapshot } from '[@storybook/addon-storyshots-puppetee](http://twitter.com/storybook/addon-storyshots-puppetee)r';

initStoryshots({
  test: imageSnapshot({ storybookUrl: '[http://localhost:9009/'](http://localhost:9009/') }),
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰ä¸€ç‚¹è¦æä¸€ä¸‹ï¼Œç°åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¾èµ–äºè¿è¡Œ storybook çš„ä¸€ä¸ªå®ä¾‹ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘å»ºè®®åŒæ—¶ç®¡ç†ä¸¤ä¸ªç»ˆç«¯:åœ¨ä¸€ä¸ªç»ˆç«¯ä¸Šè¿è¡Œ yarn storybookï¼Œåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸Šè¿è¡Œ yarn testã€‚

<figure>[![Running visual testing along with Storybook](../Images/58df3a48f9b4c5494f6c390af55fe71b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--0fvGga0H--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A3RNCgIJ0rbkGdwcukmdcqA.png) 

<figcaption>éšç€æ•…äº‹ä¹¦è¿è¡Œè§†è§‰æµ‹è¯•</figcaption>

</figure>

æ—§çš„å¿«ç…§å·²ç»è¿‡æ—¶äº†(ä½ å¯ä»¥å®‰å…¨åœ°åˆ é™¤å®ƒä»¬)ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªåä¸º`\_\_image\_snapshots\_\_`çš„æ–°æ–‡ä»¶å¤¹ï¼Œæ¯ä¸ªæ•…äº‹éƒ½æœ‰ä¸€å¼ ç…§ç‰‡ã€‚æ¯æ¬¡ç»„ä»¶æ”¹å˜å®ƒæ‰€å‘ˆç°çš„å†…å®¹æ—¶ï¼Œæµ‹è¯•éƒ½ä¼šå¤±è´¥ï¼Œæ‚¨å¯ä»¥é€šè¿‡å­˜å‚¨çš„å›¾åƒå¿«ç…§å’Œæ–°å›¾åƒä¹‹é—´çš„è§†è§‰å·®å¼‚æ¥æ£€æŸ¥å®ƒã€‚

åœ¨ä¸‹é¢çš„åŒºåˆ«ä¸­ï¼Œæˆ‘æŠŠæŒ‰é’®çš„`border-color`ä»`pink`æ”¹æˆäº†`blue`ã€‚åŸæ¥çš„å›¾åƒå°†åœ¨å·¦è¾¹ï¼Œæ–°çš„åœ¨å³è¾¹ï¼Œä¸­é—´çš„åŒºåˆ«æ˜¯ä¸¤è€…éƒ½ç”¨çº¢è‰²å˜åŒ–ã€‚

<figure>[![Visual diffing in action](../Images/d051358b84e55b3a52ac460934f6dd6a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--B9GX7GTX--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A7Bwxj5LlRektVu42ZI5qKw.png) 

<figcaption>åŠ¨ä½œè§†è§‰å·®å¼‚</figcaption>

</figure>

### [](#running-on-ci)å¥”ä¸Šè¯å›çš„âš™ï¸

è®©ä¸¤ä¸ªç»ˆç«¯åŒæ—¶å¼€æ”¾ï¼Œè¿™æ˜¯æˆ‘ä»¬åªèƒ½åœ¨å¼€å‘ä¸­åšçš„äº‹æƒ…ã€‚ä½†æ˜¯å½“æ¶‰åŠåˆ°è‡ªåŠ¨åŒ–è¿™é¡¹ä»»åŠ¡æ—¶ï¼Œäº‹æƒ…å°±æœ‰ç‚¹æ£˜æ‰‹äº†ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæœ‰äººè€ƒè™‘åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶åˆ¶ä½œäº†ä¸€ä¸ªåä¸º[å¯åŠ¨-æœåŠ¡å™¨-æµ‹è¯•](https://github.com/bahmutov/start-server-and-test)çš„`npm`åŒ…ï¼Œå®ƒå°±æ˜¯è¿™ä¹ˆåšçš„ï¼æ‚¨éœ€è¦æŒ‡å®šå‘½ä»¤*â€œå¯åŠ¨æœåŠ¡å™¨â€*ï¼Œä¸€æ—¦æœåŠ¡å™¨å¯åŠ¨å¹¶è¿è¡Œï¼Œå®ƒå°†æ‰§è¡Œæ‚¨æŒ‡å®šçš„*â€œæµ‹è¯•â€*å‘½ä»¤ï¼Œä¸€æ—¦è¯¥è¿‡ç¨‹å®Œæˆï¼Œå®ƒå°†ç»ˆæ­¢æœåŠ¡å™¨ã€‚

```
yarn add start-server-and-test 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`package.json`ä¸­ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è„šæœ¬æ¥å¯åŠ¨ storybookï¼Œç„¶åç›‘å¬ç›´åˆ° [http://localhost:9009](http://localhost:9009) å¯åŠ¨å¹¶è¿è¡Œå¹¶æ‰§è¡Œæµ‹è¯•ã€‚

```
{  "scripts":  {  "test":  "react-scripts test --coverage",  "storybook":  "start-storybook -p 9009 -s public",  "test:ci":  "start-server-and-test storybook [http://localhost:9009](http://localhost:9009) test"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<figure>[![Test CI output](../Images/eae267f8ec52f8e3e0c91a9cc446b447.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--aJrQvkz1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AKekXGREL7z3wIjT3q_Q9cw.png) 

<figcaption>æµ‹è¯• CI è¾“å‡º</figcaption>

</figure>

### [](#interactive-visual-testing)äº’åŠ¨è§†è§‰æµ‹è¯•ğŸ•º

æœ‰æ—¶å€™ä½ æƒ³åœ¨æ‹ç…§å‰å’Œæ•…äº‹äº’åŠ¨ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ‚¨éœ€è¦éµå¾ªä¸€ç§ä¸åŒäºå‰é¢æ‰€ç¤ºçš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨åä¸º [jest-image-snapshot](https://github.com/americanexpress/jest-image-snapshot) çš„å®¢æˆ· jest åŒ¹é…å™¨å’Œä»»ä½•ç«¯åˆ°ç«¯æ¡†æ¶æ¥å®ç°è¿™ä¸€ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåª[çš„å‚€å„¡å¸ˆ](https://github.com/GoogleChrome/puppeteer)ã€‚

```
yarn add -D jest-image-snapshot pupetter 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†å¯ç”¨`jest-image-snapshot`ï¼Œä½ éœ€è¦ä»`jest`æ‰©å±•å‡½æ•°`expect`ã€‚ç”¨`create-react-app`å®ç°è¿™ä¸€ç‚¹çš„[æ¨èæ–¹å¼](https://facebook.github.io/create-react-app/docs/running-tests#src-setuptestsjs)æ˜¯åœ¨`src`ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`setupTests.js`çš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å°†åœ¨æ‰€æœ‰æµ‹è¯•å¼€å§‹ä¹‹å‰åŠ è½½ï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ªè‡ªå®šä¹‰åŒ¹é…å™¨ã€‚

```
// src/setupTests.js
import { toMatchImageSnapshot } from 'jest-image-snapshot';

expect.extend({ toMatchImageSnapshot }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨æˆ‘ä»¬è¦æ£€æŸ¥ DuplicationButton çš„è¡Œä¸ºæ—¶åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å½“ç”¨æˆ·ç‚¹å‡»å®ƒä¸¤æ¬¡æ—¶å®ƒæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚

```
// src/DuplicationButton.test.js
import puppeteer from 'puppeteer';

describe('<DuplicationButton />', () => {
  let page;

  beforeAll(async () => {
    // init puppeteer page
    let browser = await puppeteer.launch();
    page = await browser.newPage();
  });

  it('should duplicate content after clicking', async () => {
    // navigate to fullscreen story
    await page.goto(
      '[http://localhost:9009/iframe.html?id=duplicationbutton--good'](http://localhost:9009/iframe.html?id=duplicationbutton--good'),
    );

    // click on the button
    await page.click('button');

    // take screenshot and compare
    const screenshot = await page.screenshot();
    expect(screenshot).toMatchImageSnapshot();
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†è¿è¡Œè¿™ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨ Storybookï¼Œæˆ–è€…æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨`yarn test:ci`æ¥å®Œæˆå®ƒï¼å±å¹•æˆªå›¾å¦‚ä¸‹æ‰€ç¤º:

<figure>[![Interactive visual testing](../Images/3c4fcb96963bd651ea02293ab6159835.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--H1qjE2Px--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/800/1%2AWc6LOMI9Ggo4dOiPBpFdZg.png) 

<figcaption>äº’åŠ¨è§†è§‰æµ‹è¯•</figcaption>

</figure>

### [](#my-experience-working-with-visual-testing)æˆ‘ä»äº‹è§†è§‰æµ‹è¯•çš„ç»å†ğŸ™‹â€â™‚ï¸

ä¸æ‰€æœ‰æ–°æŠ€æœ¯/æ¡†æ¶ä¸€æ ·ï¼Œæˆ‘é¦–å…ˆå°è¯•äº†å¯è§†åŒ–æµ‹è¯•ï¼Œå¹¶åœ¨ä¸€ä¸ªé™„å¸¦é¡¹ç›®ä¸­å‘ç°äº†å¯èƒ½çš„æ”¹è¿›ã€‚è¿™ä¸ªé¡¹ç›®æœ¬èº«æ˜¯ä¸€ä¸ªç”¨ React å’Œ[æ ·å¼ç»„ä»¶](https://www.styled-components.com/)åˆ¶ä½œçš„å¤©æ°”å›¾æ ‡çš„é›†åˆï¼Œå«åš[å¤©æ°”æ ·å¼å›¾æ ‡](https://github.com/EmaSuriano/weather-styled-icon)ã€‚

<figure>[![weather-styled-icon showcase](../Images/06bc14230960e1bfa9d44a654a7212cb.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--oCICXHMQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn-images-1.medium.com/max/634/0%2ALhH0pCh9S5QYKROB.gif) 

<figcaption>å¤©æ°”-å›¾æ ‡å±•ç¤ºåŒº</figcaption>

</figure>

æˆ‘å¯¹è¿™ä¸ªåº“åšçš„ç¬¬ä¸€ä¸ªå‘å¸ƒï¼Œæˆ‘ç”¨`enzyme`å†™äº†æ‰€æœ‰çš„æµ‹è¯•ï¼Œéµå¾ªä¸€ä¸ªç»“æ„åŒ–æµ‹è¯•ç­–ç•¥ã€‚ç®€å•åœ°è¯´ï¼Œæˆ‘ç”¨`mount`æ¸²æŸ“ä¸€ä¸ªå›¾æ ‡ï¼Œç„¶åè¿è¡Œæ£€æŸ¥ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œä¸ºäº†æ£€æŸ¥å®ƒâ€œçœ‹èµ·æ¥â€å¦‚ä½•ï¼Œæˆ‘è¿è¡Œäº†ç»“æœæ ·å¼çš„`expect.toMatchSnapshot`ï¼Œæ­£å¦‚ä½ å¯ä»¥æƒ³è±¡çš„ï¼Œè¿™ç§æµ‹è¯•æ–¹å¼éå¸¸è€—æ—¶ï¼Œä½†å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯èƒ½å¤Ÿå®Œæˆæ‰€æœ‰çš„æµ‹è¯•ã€‚

å½“æˆ‘å†³å®šå°†`styled-components`çš„ç‰ˆæœ¬ä» v3 æ›´æ–°åˆ° v4 æ—¶ï¼Œé—®é¢˜å‡ºç°äº†ï¼Œå› ä¸ºæˆ‘æƒ³å¼€å§‹ä½¿ç”¨ä¸€äº›å¾ˆé…·çš„æ–° APIï¼Œæ¯”å¦‚`ThemeProvider`æˆ–`styled` API æ¥è®¾è®¡ç°æœ‰çš„`styled-component`ç»„ä»¶ã€‚

åœ¨æˆ‘å¯¹ä»£ç åšäº†æ‰€æœ‰çš„ä¿®æ”¹åï¼Œæˆ‘æ‰€æœ‰çš„æµ‹è¯•éƒ½è¢«ç ´åäº†ï¼Œå› ä¸ºæˆ‘ç§»åŠ¨ã€æ·»åŠ å’Œåˆ é™¤äº†ç»„ä»¶ï¼Œè€Œä¸”æˆ‘ä¿®æ”¹äº†å¤§éƒ¨åˆ†ç»„ä»¶çš„å†…éƒ¨å®ç°ã€‚æ­¤æ—¶ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘æ­£åœ¨æµ‹è¯•ç»„ä»¶çš„å®ç°ï¼Œè€Œä¸æ˜¯æˆ‘æ‰€æœŸæœ›çš„è¾“å‡ºã€‚

æ‰€ä»¥æˆ‘å†³å®šå°è¯•è§†è§‰æµ‹è¯•ï¼Œå› ä¸ºè¿™ä¼¼ä¹æ˜¯æœ€é€‚åˆæˆ‘çš„æƒ…å†µçš„æµ‹è¯•ç­–ç•¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘æƒ³æ£€æŸ¥å›¾æ ‡å’Œå®ƒä»¬çš„å˜åŒ–çœ‹èµ·æ¥æ˜¯ä»€ä¹ˆæ ·å­ã€‚æˆ‘éµå¾ªäº†ä¸Šé¢å·²ç»è§£é‡Šè¿‡çš„ç›¸åŒæ­¥éª¤ï¼Œæœ€ç»ˆæˆ‘ç”¨æ›´å°‘çš„ä»£ç å®Œæˆäº†ä¸€å¥—æ›´å¥½çš„æµ‹è¯•ã€‚è¿™æ˜¯åˆå¹¶æ‹‰å–è¯·æ±‚çš„è¡Œå·®ï¼

<figure>[![Visual testing lines diff weather-styled-icon](../Images/616b1f20aac141c536744154167f7853.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--n124NSWT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AAglowTdf-p9RC8T3608v9g.png) 

<figcaption>ç›®æµ‹çº¿æ¡å·®å¼‚å¤©æ°”-å›¾æ ‡</figcaption>

</figure>

### [](#dos-and-donts)åšä¸ä¸åšçš„âœï¸

æˆ‘è®¤ä¸ºè§†è§‰æµ‹è¯•æ˜¯ä¸€ç§å¾ˆå¥½çš„æµ‹è¯•æ–¹å¼ï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ è‡³å°‘åœ¨ä¸€ä¸ªå…¼èŒé¡¹ç›®ä¸­å°è¯•ä¸€ä¸‹ï¼Œä½ å¯ä»¥ç©ç©å®ƒï¼Œçœ‹çœ‹ä½ æ˜¯å¦å–œæ¬¢å®ƒã€‚ä½†æ˜¯ï¼Œæˆ‘æƒ³å¼ºè°ƒä¸€äº›å…³äºè¿™ä¸ªè¯é¢˜åº”è¯¥åšå’Œä¸åº”è¯¥åšçš„é‡è¦äº‹æƒ…:

*   âŒä¸ç”¨ä»£ç æ£€æŸ¥ä½ çš„ç»„ä»¶çš„é£æ ¼ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œæ‹ä¸‹ç»„ä»¶çš„çœŸå®å›¾åƒã€‚
*   âœ…:å¦‚æœä½ åœ¨ä½ çš„å¼€å‘å·¥ä½œæµç¨‹ä¸­ä½¿ç”¨ Storybookï¼Œä½ å¯ä»¥å¯¹æ‰€æœ‰çš„æ•…äº‹è¿›è¡Œä¸€æ¬¡å¯è§†åŒ–æµ‹è¯•ï¼Œè€Œä¸éœ€è¦ä»»ä½•å®é™…çš„åŠªåŠ›ã€‚
*   âŒè§†è§‰æµ‹è¯•ä¸ä¼šå–ä»£å…¶ä»–æµ‹è¯•ç­–ç•¥ï¼Œå®ƒåªæ˜¯åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­å¢åŠ äº†ä¸€ä¸ªæµ‹è¯•å±‚ã€‚
*   âœ…:ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°å°†å®ƒä¸ä½ å½“å‰çš„ç«¯åˆ°ç«¯æµ‹è¯•é›†æˆèµ·æ¥ã€‚

### [](#helpful-resources)æœ‰ç”¨çš„èµ„æºğŸ““

*   [é“¾æ¥åˆ°ç¤ºä¾‹é¡¹ç›®](https://github.com/EmaSuriano/visual-testing-storybook)
*   [å¤©æ°”é£æ ¼å›¾æ ‡](https://github.com/EmaSuriano/weather-styled-icon)
*   [è‡ªåŠ¨åŒ–è§†è§‰æµ‹è¯•â€”æ•…äº‹ä¹¦æ–‡æ¡£](https://storybook.js.org/docs/testing/automated-visual-testing/)
*   [è®²ç¬‘è¯çš„æœ¨å¶å¸ˆ](https://jestjs.io/docs/en/puppeteer)
*   [ç»“æ„æµ‹è¯•â€”æ•…äº‹ä¹¦æ–‡æ¡£](https://storybook.js.org/docs/testing/structural-testing/)
*   [åœ¨](https://facebook.github.io/create-react-app/docs/running-tests#src-setuptestsjs) [åˆ›å»º-ååº”-åº”ç”¨](https://facebook.github.io/create-react-app/docs/running-tests#src-setuptestsjs)ä¸­æ‰©å±• Jest é…ç½®