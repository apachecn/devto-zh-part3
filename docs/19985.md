# ä½¿ç”¨ Step å‡½æ•°å®‰æ’ç”µå­é‚®ä»¶ï¼Œæ— éœ€è½®è¯¢æ•°æ®åº“

> åŸæ–‡:[https://dev . to/pauls wail/schedule-emails-without-polling-a-database-using-step-functions-1b 10](https://dev.to/paulswail/schedule-emails-without-polling-a-database-using-step-functions-1b10)

å‘é€ç”µå­é‚®ä»¶æ˜¯ web åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªéå¸¸æ ‡å‡†çš„åŠŸèƒ½ã€‚ç”µå­é‚®ä»¶æœåŠ¡æä¾›å•†æä¾›ç®€å•çš„ APIï¼Œè®©ä½ åªç”¨å‡ è¡Œä»£ç å°±èƒ½å‘é€ä¸€å°ç”µå­é‚®ä»¶ã€‚

ä½†æ˜¯å°†å®ƒä»¬å®‰æ’åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´äº¤ä»˜è¦éº»çƒ¦å¾—å¤šã€‚æ¯”æ–¹è¯´ï¼Œä½ æƒ³è®©æ–°ç”¨æˆ·åœ¨å‡ å¤©å†…å®Œæˆä¸€ä¸ªå…¥èŒåºåˆ—ï¼Œæˆ–è€…ä½ å¯èƒ½éœ€è¦å‘é€ä¸€ä¸ªå…³äºç”¨æˆ·åœ¨ä½ çš„åº”ç”¨ä¸­åˆ›å»ºçš„ä»»åŠ¡æˆ–äº‹ä»¶çš„æé†’ã€‚ç°åœ¨ï¼Œæ‚¨å¿…é¡»:

*   åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ª`ScheduledEmails`è¡¨æ¥å­˜å‚¨æœªæ¥çš„æ¶ˆæ¯
*   åˆ›å»ºä¸€ä¸ª cron ä½œä¸šæ¥è½®è¯¢è¯¥è¡¨ä¸­æ˜¯å¦æœ‰åˆ°æœŸçš„ç”µå­é‚®ä»¶ï¼Œç„¶ååœ¨é‚®ä»¶é€è¾¾åæ¸…é™¤å®ƒä»¬
*   ç»´æŠ¤ cron ä½œä¸šå’Œè¿è¡Œçš„æœåŠ¡å™¨

å¯¹äºæœ¬åº”ç®€å•å¾—å¤šçš„äº‹æƒ…æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æµªè´¹ã€‚

ä½†æ˜¯æœ‰ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•...

é€šè¿‡ä½¿ç”¨ AWS[Î»](https://aws.amazon.com/lambda/)å’Œ[é˜¶è·ƒå‡½æ•°](https://aws.amazon.com/step-functions/)ï¼Œæ‚¨å¯ä»¥å¾—åˆ°ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ:

*   ä¸éœ€è¦æ•°æ®åº“
*   ä¸æ¶‰åŠè½®è¯¢
*   ä½ åªéœ€ä¸ºå®ƒçš„ä½¿ç”¨é‡ä»˜è´¹
*   ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªç®€å•çš„ API è°ƒç”¨æ¥è°ƒç”¨ Lambda(å®ƒå¯ä»¥è¢«è§†ä¸ºè‡ªå·±çš„å¾®æœåŠ¡)

å¦‚æœä½ æƒ³è·³åˆ°å®Œæ•´çš„ä»£ç åº“ï¼Œ[å»è¿™é‡Œ](https://github.com/paulswail/serverless-email-scheduler)ã€‚
å¦‚æœä½ åªæƒ³çŸ¥é“å…³é”®ç‚¹ï¼Œè¯·ç»§ç»­å…³æ³¨æˆ‘ï¼Œæˆ‘å°†å¸¦ä½ äº†è§£å¦‚ä½•ä½¿ç”¨ Node.js å’Œæ— æœåŠ¡å™¨æ¡†æ¶å®ç°è¿™ä¸€ç‚¹ã€‚

ğŸ“–**ç›¸å…³: *[ä¸ºä»€ä¹ˆæ— æœåŠ¡å™¨æ–°æ‰‹è¦ç”¨éƒ¨ç½²æ¡†æ¶](https://winterwindsoftware.com/serverless-newbies-should-use-framework/)ã€‚***

ä¾§è¾¹æ :è™½ç„¶æˆ‘åœ¨è¿™é‡Œä½¿ç”¨ç”µå­é‚®ä»¶ï¼Œä½†è¿™ç§æ–¹æ³•å¯ä»¥åº”ç”¨äºä½ çš„åº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œçš„ä»»ä½•æœªæ¥è®¡åˆ’ä»»åŠ¡ã€‚

## [](#getting-set-up)å¼€å§‹è®¾ç½®

é¦–å…ˆï¼Œ[å®‰è£…æ— æœåŠ¡å™¨æ¡†æ¶](https://serverless.com/framework/docs/providers/aws/guide/installation/)ã€‚
æˆ‘ä»¬ä¹Ÿå°†ä½¿ç”¨ [`serverless-step-functions`](https://github.com/horike37/serverless-step-functions) æ’ä»¶æ¥å…è®¸æˆ‘ä»¬åœ¨`serverless.yml`æ–‡ä»¶ä¸­è½»æ¾é…ç½®æˆ‘ä»¬çš„æ­¥éª¤åŠŸèƒ½ã€‚

## [](#configuring-the-step-functions-sequence)é…ç½®æ­¥è¿›åŠŸèƒ½é¡ºåº

[![Send Email Step Function State Machine](../Images/c7f6b5744b36167124b65959e4c30a11.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--kXFeC3Zg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://winterwindsoftware.com/img/blog-images/send-email-step-function.png)

åºåˆ—ä¸­æœ‰ä¸¤ç§çŠ¶æ€:

1.  `WaitForDueDate`:è¿™æ˜¯ä¸€ä¸ªç®€å•çš„[ç­‰å¾…](https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-wait-state.html)æ­¥éª¤ï¼Œä»è¾“å…¥å¯¹è±¡ä¸­è¯»å–ä¸€ä¸ª`dueDate`å­—æ®µï¼Œå¹¶ç­‰å¾…åˆ°è¯¥æ—¶é—´ï¼Œç„¶åè¿›å…¥ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚
2.  `SendEmail`:ä¸€ä¸ª Lambda å‡½æ•°ï¼Œå®ƒè°ƒç”¨ API æ¥å‘é€ç”µå­é‚®ä»¶ã€‚

è¿™äº›é…ç½®å¦‚ä¸‹:

```
# serverless.yml
# ...
stepFunctions:
  stateMachines:
    EmailSchedulingStateMachine:
      name: EmailSchedulingStateMachine
      definition:
        Comment: "Schedules  an  email  to  be  sent  at  a  future  date"
        StartAt: WaitForDueDate
        States:
          WaitForDueDate:
            Type: Wait
            TimestampPath: "$.dueDate"
            Next: SendEmail
          SendEmail:
            Type: Task
            Resource: "arn:aws:lambda:#{AWS::Region}:#{AWS::AccountId}:function:${self:service}-${opt:stage}-SendEmail"
            End: true 
```

## [](#create-the-sendemail-function)åˆ›å»º SendEmail åŠŸèƒ½

ä»¥ä¸‹ä»£ç ä¸º Lambda å‡½æ•°`SendEmail`å®šä¹‰äº†ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œè¯¥å‡½æ•°ç”±æ­¥éª¤å‡½æ•°é…ç½®ä¸­çš„ SendEmail çŠ¶æ€å¼•ç”¨ã€‚è¯¥åŠŸèƒ½ä½¿ç”¨ [AWS SES](https://aws.amazon.com/ses/) å‘é€ç”µå­é‚®ä»¶ã€‚

```
const AWS = require('aws-sdk');
const ses = new AWS.SES();
const { EMAIL_SENDER_ADDRESS } = process.env;

module.exports.handle = async (event) => {
    const result = await sendEmail(event.email);
    console.log('Sent email successfully', result);
    return result;
};

function sendEmail(email) {
    const params = {
        Destination: {
            ToAddresses: email.to,
        },
        Message: {
            Subject: {
                Data: email.subject,
            },
            Body: {
                Html: {
                    Data: email.htmlBody || email.textBody,
                },
                Text: {
                    Data: email.textBody || email.htmlBody,
                },
            },
        },
        Source: EMAIL_SENDER_ADDRESS,
    };
    return ses.sendEmail(params).promise();
} 
```

## [](#initiating-the-scheduling)å‘èµ·è°ƒåº¦

ç°åœ¨ SendEmail é€»è¾‘å·²ç»å®ç°å¹¶è¿æ¥åˆ° Step Functions çŠ¶æ€æœºï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ä»åº”ç”¨ç¨‹åºå¯åŠ¨ step function çš„æ–¹æ³•ã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨é˜¶è·ƒå‡½æ•° API ä¸­çš„ [`startExecution`](https://docs.aws.amazon.com/step-functions/latest/apireference/API_StartExecution.html) å‡½æ•°æ¥å®Œæˆçš„ã€‚

```
// schedule-email.js
const AWS = require('aws-sdk');
const stepfunctions = new AWS.StepFunctions();

module.exports.scheduleEmail = async (dueDate, email) => {
    const stateMachineArn = process.env.STATEMACHINE_ARN;
    const result = await stepfunctions.startExecution({
        stateMachineArn,
        input: JSON.stringify({
            dueDate, email
        }),
    }).promise();
    console.log(`State machine ${stateMachineArn} executed successfully`, result);
    return result;
}

// ----------------------------------------------
// your-app-module.js
const scheduleEmail = require('./schedule-email');
const email = {
    to: ['test@example.com'],
    subject: 'MyApp Onboarding Day 1 - Setting up your project',
    textBody: 'TEXT body.\nsecond line.',
    htmlBody: '<strong>HTML</strong> body<br>second line.'
};
const dueDate = '2018-11-16T13:55:25.000Z';
const result = await scheduleEmail(dueDate, email);

// result :
// {
//     "executionArn": "arn:aws:states:eu-west-1:123456789:execution:EmailSchedulingStateMachine:84b1f498-ab4d-4f69-a635-ab1fa5199e16",
//     "startDate": "2018-11-16T16:19:23.560Z"
// } 
```

æ‚¨éœ€è¦æ›´æ–°æ‚¨çš„åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œçš„ IAM è§’è‰²ï¼Œä»¥å…è®¸åœ¨`EmailSchedulingStateMachine`çŠ¶æ€æœºä¸Šæ‰§è¡Œ`states:StartExecution`æ“ä½œã€‚

## [](#what-if-i-need-to-cancel-a-scheduled-email?)å¦‚æœæˆ‘éœ€è¦å–æ¶ˆé¢„å®šçš„é‚®ä»¶æ€ä¹ˆåŠï¼Ÿ

`startExecution`è°ƒç”¨è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«è¿™æ¬¡æ‰§è¡Œçš„å”¯ä¸€çš„`executionArn`å­—ç¬¦ä¸²ã€‚å¦‚æœæ‚¨éœ€è¦å–æ¶ˆç”µå­é‚®ä»¶çš„èƒ½åŠ›ï¼Œæ‚¨å¯ä»¥å­˜å‚¨è¿™ä¸ª ARNï¼Œç„¶åç¨åå°†å®ƒä¼ é€’ç»™ [`stopExecution`](https://docs.aws.amazon.com/step-functions/latest/apireference/API_StopExecution.html) å‡½æ•°ï¼Œä»¥ä¾¿åœ¨å®ƒè¿›å…¥ SendEmail çŠ¶æ€ä¹‹å‰å–æ¶ˆæ‰§è¡Œ(å‡è®¾å®ƒè¿˜æ²¡æœ‰ç»“æŸ)ã€‚

## [](#try-it-out-for-yourself)è‡ªå·±å°è¯•ä¸€ä¸‹

å¦‚æœæ‚¨è®¤ä¸ºè¿™å¯¹æ‚¨æœ‰ç”¨ï¼Œé‚£ä¹ˆ[å…‹éš†è¿™ä¸ª repo](https://github.com/paulswail/serverless-email-scheduler) å¹¶è‡ªå·±éƒ¨ç½²å®ƒã€‚

æ‚¨å¯ä»¥åšå‡ºçš„ä¸€äº›æ½œåœ¨æ”¹è¿›:

*   æ·»åŠ å‘é€é‚®ä»¶å¤±è´¥æ—¶çš„é‡è¯•é€»è¾‘(`serverless-step-functions`æ’ä»¶æ”¯æŒçš„
*   æ”¯æŒé™¤ se ä¹‹å¤–çš„ç”µå­é‚®ä»¶æä¾›å•†

* * *

ğŸ’Œ ***å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥æ³¨å†Œ[åˆ°æˆ‘çš„å…³äºåœ¨ AWS ä¸­æ„å»ºæ— æœåŠ¡å™¨ç½‘ç»œåº”ç”¨çš„æ¯å‘¨æ—¶äº‹é€šè®¯](https://winterwindsoftware.com/newsletter/)ã€‚***
ä½ ä¹Ÿå¯èƒ½ä¼šå–œæ¬¢:

*   [æ‹…å¿ƒæ— æœåŠ¡å™¨å¸¦èµ°](https://winterwindsoftware.com/concerns-that-serverless-takes-away/)
*   [ç”Ÿäº§ä¸­çš„ AWS æ— æœåŠ¡å™¨åº”ç”¨æ¡ˆä¾‹ç ”ç©¶](https://winterwindsoftware.com/real-world-serverless-case-studies/)
*   [â€œæ— æœåŠ¡å™¨â€çš„ä¸åŒå®šä¹‰](https://winterwindsoftware.com/serverless-definitions/)

*åŸè½½äº winterwindsoftware.com*ã€‚