# æœç´¢ç¬¬ä¸€ä¸ªå…¬å…±ç‰ˆæœ¬

> åŸæ–‡:[https://dev . to/gill Christian/tsearch-first-public-version-50a](https://dev.to/gillchristian/tsearch-first-public-version-50a)

ä¸Šå‘¨åœ¨è¿™ä¸ª devlog çš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘åˆ†äº«äº†æˆ‘æ˜¯å¦‚ä½•æƒ³å‡ºä¸º TypeScript å‡½æ•°ç¼–å†™ä¸€ä¸ªæœç´¢å¼•æ“çš„æƒ³æ³•çš„ã€‚

ä»é‚£ä»¥åï¼Œæˆ‘ä¸€ç›´è‡´åŠ›äºå‘å¸ƒ PoC çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚æˆ‘å¾ˆé«˜å…´åœ°å‘Šè¯‰å¤§å®¶ï¼Œtsearch.io ä»æœ¬å‘¨ä¸€å¼€å§‹å°±å·²ç»ä¸Šçº¿äº†ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³åˆ†äº«æˆ‘æ˜¯å¦‚ä½•æ„å»ºè¿™ä¸ª PoC çš„ï¼Œä»¥åŠå®ƒçš„å±€é™æ€§ã€‚

æœ‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†:

1.  ä»ç›®å½•ä¸­çš„ ts æ–‡ä»¶(`.ts` & `.tsx`)çš„å¯¼å‡ºå‡½æ•°ä¸­æå–ç±»å‹ä¿¡æ¯çš„ cliã€‚
2.  å¯¹æå–çš„å‡½æ•°æ‰§è¡Œæœç´¢çš„èŠ‚ç‚¹æœåŠ¡å™¨ã€‚
3.  ä¸æœåŠ¡å™¨äº¤äº’çš„ web å®¢æˆ·ç«¯ã€‚

## [](#extracting-type-information)æå–ç±»å‹ä¿¡æ¯

ä¸ºäº†æå–æˆ‘ä½¿ç”¨çš„ç±»å‹ [ts-simple-ast](https://github.com/dsherret/ts-simple-ast) :

> TypeScript ç¼–è¯‘å™¨ API åŒ…è£…ã€‚æä¾›ä¸€ç§å¯¼èˆªå’Œæ“ä½œ TypeScript å’Œ JavaScript ä»£ç çš„ç®€å•æ–¹æ³•ã€‚

æƒ³æ³•å¾ˆç®€å•ï¼Œç”¨`ts-simple-ast`åŠ è½½ä¸€ä¸ªç›®å½•ï¼Œè¾“å‡ºæ‰€æœ‰å¯¼å‡ºå‡½æ•°çš„æ•°ç»„ã€‚

å‡è®¾æˆ‘ä»¬æœ‰æ¨¡å—`strs`ï¼Œåªæœ‰ä¸€ä¸ªå¯¼å‡ºçš„å‡½æ•°:

```
// ~/code/strs/src/index.ts

export function replace(search: RegExp, replace: string, str: string) {
  return str.replace(searchValue, replaceValue)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¾“å‡ºå°†ç±»ä¼¼äº:

```
[
  {
    name: 'replace',
    parameters: [
      {
        name: 'search',
        type: 'RegExp',
      },
      {
        name: 'replace',
        type: 'string',
      },
      {
        name: 'str',
        type: 'string',
      },
    ],
    returnType: 'string',
    module: 'some-module',
  }
] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ²¡æœ‰åŒ…æ‹¬ä»»ä½•ç±»å‹çš„é¢å¤–ä¿¡æ¯ï¼Œå¦‚æ³›å‹æˆ–ç¬¦å·ã€‚å¯¹äºæ›´â€œå¤æ‚â€çš„ç±»å‹(å¦‚æ•°ç»„ã€å‡½æ•°ã€è”åˆã€æ³›å‹ç­‰)ï¼Œè¿™å¾ˆé‡è¦ï¼Œå› ä¸ºåŒ¹é…ä¸èƒ½é€šè¿‡æ¯”è¾ƒç±»å‹åç§°çš„å­—ç¬¦ä¸²æ¥å®Œæˆã€‚ä¾‹å¦‚ï¼Œ`string | number`å’Œ`number | string`æ˜¯åŒä¸€ä¸ªç±»å‹ï¼Œä½†æ˜¯å¦‚æœç”¨åå­—æ¥æ¯”è¾ƒï¼Œå°±åƒæˆ‘ç°åœ¨åšçš„ï¼Œå®ƒä»¬å°±ä¸åŒ¹é…ã€‚

æå–ä¸€ä¸ªé¡¹ç›®çš„ç±»å‹çš„å¹³å‡æ—¶é—´å¤§çº¦æ˜¯ 10sã€‚è¿™å¯¹äºä¸€ä¸ªç›®å½•æ¥è¯´å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘æƒ³åœ¨æ‰€æœ‰å¯ç”¨çš„åŒ…ä¸­è¿è¡Œå®ƒğŸ‰

ä¸ºæ­¤ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ª [Go ç¨‹åº](https://github.com/gillchristian/ts-earch/blob/f2d4b3de75a6997b3fcc3ca755be2f1ecf2673f5/packages/cli/main.go),åœ¨æ¯ä¸ªåŒ…ä¸Šè¿è¡Œæå–å™¨ï¼Œç„¶åå°†æ‰€æœ‰è¾“å‡ºä¸€èµ·å†™å…¥ä¸€ä¸ª JSON æ–‡ä»¶ã€‚æˆ‘é€‰æ‹© Go æ˜¯å› ä¸ºå¹¶è¡Œè¿è¡Œå’ŒåŒæ­¥ä¸€åˆ‡æ˜¯å¤šä¹ˆå®¹æ˜“ã€‚

åœ¨æˆ‘çš„æœºå™¨ä¸Š(8 æ ¸ i7 ç¬¬ 7 ä»£ï¼Œ16GB RAM)ï¼Œåœ¨ 100% CPU ä½¿ç”¨ç‡ä¸‹è¿è¡Œäº†è¿‘ 3 ä¸ªå°æ—¶ï¼Œæ‰ä» DT ä¸­æå–å‡ºæ‰€æœ‰ç±»å‹ï¼Œäº§ç”Ÿäº†ä¸€ä¸ª 5.8mb çš„ JSON æ–‡ä»¶ã€‚ä¸€ç‚¹ä¹Ÿä¸å·®ï¼Œä½†æ˜¾ç„¶åœ¨ 500 å…†å†…å­˜å’Œ 1 æ ¸æ•°å­—æµ·æ´‹æ¶²æ»´ä¸Šåšä¸åˆ°ğŸ˜‚

## [](#searching)æœç´¢

æˆ‘æ²¡æœ‰æ”¯æŒå®é™…çš„ TS ç±»å‹ç­¾åï¼Œä¹Ÿæ²¡æœ‰è§£æå®ƒï¼Œè€Œæ˜¯æƒ³å‡ºäº†è¿™ä¸ªéå¸¸ç®€å•çš„æŸ¥è¯¢è¯­æ³•ï¼Œè§£æèµ·æ¥å¾ˆç®€å•ã€‚å‚æ•°ç±»å‹çš„é€—å·åˆ†éš”åˆ—è¡¨ã€ç®­å¤´(`=>`)å’Œè¿”å›ç±»å‹ã€‚ç¼ºç‚¹æ˜¯å®ƒä¸æ˜¯å¾ˆå¼ºå¤§ï¼Œç”šè‡³ä¸æ˜¯å¯¹æ‰€æœ‰æƒ…å†µéƒ½æœ‰ç”¨ï¼Œä½†å˜¿ï¼Œå®ƒæ¯•ç«Ÿæ˜¯ä¸€ä¸ªæ¦‚å¿µéªŒè¯ï¼

```
(search: RegExp, replace: string, str: string) => string
// would be
RegExp, string, string => string 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
<A>(xs: A[]) => A
// would be
A[] => A 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»ç„¶è®¤ä¸ºæŸç§è¯­æ³•å’Œä¸€äº›é€»è¾‘ç¼ºçœå€¼(ä¾‹å¦‚ï¼Œä½œä¸ºæ³›å‹çš„å•ä¸ªå¤§å†™å­—æ¯)å¯ä»¥äº§ç”Ÿæ¯”å®é™…æœ‰æ•ˆçš„ ts ç­¾åæ›´å¹²å‡€å’Œæ›´å®¹æ˜“çš„æœç´¢æ–¹å¼ã€‚

```
<A, B>(array: A[], fn: ((a: A) => B)) => B[]
// vs
A[], (A => B) => B[] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯ä½¿ç”¨æœ‰æ•ˆçš„ TS ä¹Ÿæœ‰å®ƒçš„ä¼˜ç‚¹ã€‚æ„å‘³ç€å°‘å­¦ä¸€æ ·ä¸œè¥¿ã€‚ç²˜è´´ä¸€ä¸ªç­¾åä¹Ÿå¯ä»¥è®©â„¢ï¸å·¥ä½œ

æŒ‰ç…§æœç´¢ç®—æ³•ï¼Œ[çš„ç¬¬ä¸€æ¬¡è¿­ä»£](https://github.com/gillchristian/ts-earch/blob/f2d4b3de75a6997b3fcc3ca755be2f1ecf2673f5/packages/search/src/index.ts#L24-L109)éå¸¸ç®€å•ï¼Œç”šè‡³æœ‰äº›å¹¼ç¨šã€‚æˆ‘æƒ³å‡ºäº†ä¸€ä¸ªåŠ æƒå‡½æ•°ï¼Œå¦‚æœè¿”å›ç±»å‹åŒ¹é…ï¼Œå°±ç»™`compared`èµ‹å€¼ï¼Œä»¥åŠæœ‰å¤šå°‘ç±»å‹çš„å‚æ•°ä¸`query`åŒ¹é…ã€‚

```
weight = 0
n = query.parameters.length

if n === compared.parameters.length
  weight += m/n // m: matches by position
  if weight > 0
    weight += m/n + 1 // m/n added twice
else
  weight += m/n // m: matches in any position

if query.returnType === compared.returnType
  weight += 2 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åå®ƒæŒ‘é€‰å¾—åˆ†è¶…è¿‡ 0 çš„å‰ 100 ä¸ªã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¥‡ç‰¹çš„æœç´¢ç®—æ³•ï¼Œä½†å®ƒå·²ç»ä¸ºç®€å•çš„æœç´¢æä¾›äº†ä¸€äº›åŒ¹é…(ä¾‹å¦‚ï¼Œ [`A[] => A`](https://tsearch.io/query?q=A%5B%5D%20%3D%3E%20A) ï¼Œ [`number => number[]`](https://tsearch.io/query?q=number%20%3D%3E%20number%5B%5D) )ã€‚

æˆ‘æ²¡æœ‰æåˆ°çš„ä¸€ä»¶é¢å¤–çš„äº‹æƒ…æ˜¯ï¼Œå¦‚æœæœç´¢æŸ¥è¯¢æ˜¯ä¸€ä¸ªå•è¯ï¼Œå®ƒå°†é€šè¿‡å‡½æ•°å’Œç±»å‹åç§°è¿›è¡Œæœç´¢ã€‚è¿™ä¸ªæƒ³æ³•ç›´æ¥æ¥è‡ªèƒ¡æˆˆã€‚

## [](#whats-next)æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

ä¸‹é¢æ˜¯æˆ‘æ¥ä¸‹æ¥è¦åº”å¯¹çš„ä¸€äº›æŒ‘æˆ˜:

*   è®¢é˜… DT repo å¹¶ä»…åœ¨å·²æ›´æ”¹çš„åŒ…ä¸Šè¿è¡Œæå–å™¨ã€‚
*   åˆ›å»ºå‘å¸ƒè‡ªå·±ç±»å‹çš„ TS é¡¹ç›®çš„ç®¡ç†åˆ—è¡¨ï¼Œå¹¶æ›´æ–°æå–å™¨æ¥è¿è¡Œå®ƒä»¬ã€‚
*   æå–å‡½æ•°ç±»å‹çš„æ›´å¤šä¿¡æ¯ã€‚
*   æ”¹è¿›æŸ¥è¯¢è¯­æ³•å’Œ/æˆ–æ”¯æŒæœ‰æ•ˆçš„ TS ç­¾åã€‚
*   ä½¿ TS è¯­ä¹‰æˆä¸ºæœç´¢ç®—æ³•çš„ä¸€éƒ¨åˆ†ã€‚

å½“ç„¶è¿˜æœ‰å¾ˆå¤§çš„æ”¹è¿›ç©ºé—´ï¼Œä½†æˆ‘å¾ˆé«˜å…´äººä»¬å·²ç»å¯¹è¿™ä¸ªæƒ³æ³•æ„Ÿå…´è¶£å¹¶å¼€å§‹å°è¯•ã€‚è¿™æ­£æ˜¯åœ¨æ—©æœŸé˜¶æ®µå°†é¡¹ç›®å…¬ä¹‹äºä¼—çš„ç›®æ ‡ã€‚

å¯¹äºé‚£äº›æ„¿æ„åšå‡ºè´¡çŒ®çš„äººï¼Œæˆ‘åœ¨å›è´­ä¸­åˆ›å»ºäº† [`help wanted`](https://github.com/gillchristian/ts-earch/labels/help%20wanted) æœŸï¼Œå¹¶å°†å¾ˆå¿«æ·»åŠ æ›´å¤šã€‚

æˆ‘æœŸå¾…å¾—åˆ°æ‚¨çš„åé¦ˆã€æ„è§å’Œå»ºè®®ã€‚

[ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼](https://www.youtube.com/watch?v=-O_cOnGrpY8)