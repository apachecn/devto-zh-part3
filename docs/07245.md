# Elixir ä¸­çš„å“ˆå¸Œæ–‡ä»¶

> åŸæ–‡ï¼š<https://dev.to/alvisesus/hashing-files-in-elixir-2pbb>

ä½ å¯¹ä»™ä¸¹å’Œå‡¤å‡°æœ‰çƒ­æƒ…å—ï¼Ÿè®¢é˜… Poeticoding æ—¶äº‹é€šè®¯ï¼ŒåŠ å…¥å¿«ä¹çš„æ™®é€šè¯»è€…ï¼Œé€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶æ–°å¸–å­ã€‚

**æ•£åˆ—å‡½æ•°**æ˜¯è½¬æ¢å¯å˜å¤§å°çš„å­—èŠ‚åºåˆ—(å­—ç¬¦ä¸²ã€æ–‡ä»¶å†…å®¹ç­‰)çš„å‡½æ•°ã€‚)åˆ°å›ºå®šå¤§å°çš„å­—èŠ‚åºåˆ—ï¼Œç§°ä¸º**æ‘˜è¦**ã€‚è¿™æ„å‘³ç€æ•£åˆ—ä»»ä½•é•¿åº¦çš„æ–‡ä»¶ï¼Œæ•£åˆ—å‡½æ•°å°†æ€»æ˜¯ä¸ºè¯¥æ–‡ä»¶è¿”å›ç›¸åŒçš„å”¯ä¸€å­—èŠ‚åºåˆ—ã€‚è¿™æ˜¯ä¸€ç§æ•°å­—æŒ‡çº¹ï¼Œé€šå¸¸ç”±é•¿åº¦åœ¨ 32 åˆ° 128 ä¸ªå­—ç¬¦ä¹‹é—´çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºã€‚

æ–‡ä»¶çš„æ•£åˆ—æ˜¯æœ‰ç”¨çš„ï¼Œä¾‹å¦‚ï¼Œäº†è§£ä¸¤ä¸ªæ–‡ä»¶çš„å†…å®¹æ˜¯å¦ç›¸åŒï¼Œæˆ–è€…å†…å®¹æ˜¯å¦åœ¨ä¸‹è½½æœŸé—´è¢«æŸåã€‚

æœ‰ä¸åŒçš„æ•£åˆ—å‡½æ•°ï¼ŒMD5ï¼ŒSHA-1ï¼ŒSHA-2ï¼ŒSHA-3 ç­‰ã€‚ä»–ä»¬ä¸­çš„è®¸å¤šäººéƒ½æœ‰é•¿ç”Ÿä¸è€è¯ã€‚

**æ›´æ–°**ğŸ‘¨â€ğŸ’»:æˆ‘æœ€åˆä½¿ç”¨ MD5 ç®—æ³•(è¿™æ˜¯åˆ—è¡¨ä¸­æœ€å¼±çš„ç®—æ³•)ç¼–å†™ä¸‹é¢çš„ç¤ºä¾‹ï¼Œåªæ˜¯å› ä¸ºæˆ‘è®¤ä¸ºå®ƒæ˜¯æœ€å¿«çš„ç®—æ³•ã€‚ [@Hauleth](https://twitter.com/Hauleth) æŒ‡å‡ºï¼Œç”±äº[è‹±ç‰¹å°” SHA æ‰©å±•](https://en.wikipedia.org/wiki/Intel_SHA_extensions)ï¼ŒSHA-1 å’Œ SHA-256 åœ¨æ–°çš„ CPU ä¸Šåº”è¯¥æ›´å¿«ï¼Œæ‰€ä»¥æˆ‘ç”¨ SHA-256 é‡å†™äº†ä¾‹å­

# æ•£åˆ—å­—ç¬¦ä¸²

è®©æˆ‘ä»¬å¼€å§‹ä½¿ç”¨ SHA-256 ç®—æ³•æ•£åˆ—ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```
iex> :crypto.hash(:sha256,"I love Elixir")
<<164, 35, 167, 235, 69, 224, 253, 77, 180, 92, 77, 172, 37,...>>
iex> :crypto.hash(:sha256,"I love Elixir!")
<<209, 119, 188, 230, 168, 124, 98, 212, 119, ...>> 
```

æˆ‘ä»¬ä½¿ç”¨äº† [`:crypto`](http://erlang.org/doc/man/crypto.html) Erlang æ¨¡å—ä¸­çš„ [`hash/2`å‡½æ•°](http://erlang.org/doc/man/crypto.html#hash-2)ã€‚

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„æ•£åˆ—ç®—æ³•çš„åç§°ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯`:sha256`ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬æƒ³è¦æ•£åˆ—çš„å­—èŠ‚åºåˆ—ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å®ƒè¿”å›ä¸€ä¸ªå­—èŠ‚åºåˆ—ã€‚

æˆ‘ä»¬é€šè¿‡æ·»åŠ ä¸€ä¸ªâ€œï¼â€å°±å¯ä»¥çœ‹åˆ°è¾“å‡ºæ˜¯å¦‚ä½•å˜åŒ–çš„æ€§æ ¼ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Base.encode16/1`æ¥è·å¾—åå…­è¿›åˆ¶çš„å­—ç¬¦ä¸²è¡¨ç¤º

```
iex> :crypto.hash(:sha256,"I love Elixir!") \
...> |> Base.encode16() \
...> |> String.downcase()
"d177bce6a87c62d4772f404fcad2f8c2d9606c04f99942b71d7c521eb79c4c3b" 
```

å¦‚æœä½ åœ¨ Linux æˆ– Mac æœºå™¨ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼äº`sha256sum`çš„å‘½ä»¤è¡Œå·¥å…·æ¥æŸ¥çœ‹æ‘˜è¦æ˜¯å¦å¯¹åº”äº

```
$ echo -n 'I love Elixir!' |  sha256sum d177bce6a87c62d4772f404fcad2f8c2d9606c04f99942b71d7c521eb79c4c3b - 
```

# æ•£åˆ—ä¸€ä¸ªæ–‡ä»¶

è®¡ç®—æ–‡ä»¶çš„å“ˆå¸Œåœ¨æ¦‚å¿µä¸Šä¸è®¡ç®—å­—ç¬¦ä¸²çš„å“ˆå¸Œç›¸åŒã€‚æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„`:crypto.hash(:sha256, file_content_binary)`å‡½æ•°ã€‚[ä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°å¤§å¤šæ•°æ—¶å€™å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼](https://www.poeticoding.com/processing-large-csv-files-with-elixir-streams/)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [`File.stream!`](https://hexdocs.pm/elixir/File.html#stream!/3) å’Œ [`:crypto`](http://erlang.org/doc/man/crypto.html#hash_init-1) ä¸­æä¾›çš„ä¸€ç»„ä¸åŒçš„å‡½æ•°æ¥æˆå—åœ°è¯»å–å’Œå¤„ç†æ–‡ä»¶ã€‚
è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®ƒä½¿ç”¨äº†æˆ‘ä»¬ä¹‹å‰ç”¨è¿‡çš„ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œè¢«åˆ†æˆäº†å‡ ä¸ªå—

```
iex> [chunk_1, chunk_2] = ["I love ", "Elixir!"]
iex> hash_ref = :crypto.hash_init(:sha256)
#Reference<...36636>
iex> hash_ref = :crypto.hash_update(hash_ref, chunk_1)
#Reference<...36647>
iex> hash_ref = :crypto.hash_update(hash_ref, chunk_2)
#Reference<...36655>
iex> digest = :crypto.hash_final(hash_ref)
<<209, 119, 188, 230, 168, 124, 98, 212, 119, ...>>
iex> digest |> Base.encode16() |> String.downcase()
"d177bce6a87c62d4772f404fcad2f8c2d9606c04f99942b71d7c521eb79c4c3b" 
```

æˆ‘ä»¬åˆ†å—å¤„ç†åºåˆ—ï¼Œå¾—åˆ°ä¸ä¹‹å‰ç›¸åŒçš„ç»“æœã€‚

```
hash_ref = :crypto.hash_init(:sha256)

File.stream!(file_path)
|> Enum.reduce(hash_ref, fn chunk, prev_ref-> 
    new_ref = :crypto.hash_update(prev_ref, chunk)
    new_ref
end)
|> :crypto.hash_final()
|> Base.encode16()
|> String.downcase() 
```

*   æˆ‘ä»¬ä»`:crypto.hash_init(:sha256)`å¾—åˆ°ä¸€ä¸ªå“ˆå¸Œå¼•ç”¨ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªç´¯åŠ å™¨ä¼ é€’ç»™`Enum.reduce`ã€‚
*   æˆ‘ä»¬ä½¿ç”¨`Enum.reduce`ä»æ–‡ä»¶ä¸­è¯»å–æ¯ä¸ªå—ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è®¡ç®—ä¸­ã€‚`:crypto.hash_update/2`è¿”å›ä¸€ä¸ªæ–°çš„å‚è€ƒå€¼ï¼Œç„¶åå°†å…¶è®¾ç½®ä¸ºæ–°çš„ç´¯åŠ å™¨ã€‚
*   ä¸€æ—¦å¤„ç†å®Œæ‰€æœ‰çš„å—ï¼Œæœ€åçš„å¼•ç”¨å°±é€šè¿‡ç®¡é“è¿›å…¥`:crypto.hash_final/1`å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›æ–‡ä»¶çš„ SHA-256 æ‘˜è¦ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨æ›´å¥½æ›´ç®€æ´çš„æ–¹å¼ç¼–å†™ reduce å‡½æ•°

```
File.stream!(file_path)
|> Enum.reduce(:crypto.hash_init(:sha256),&(:crypto.hash_update(&2, &1)))
|> :crypto.hash_final()
|> Base.encode16()
|> String.downcase() 
```

# `File.stream!`å¤§å— vs çº¿æ¡

é»˜è®¤æƒ…å†µä¸‹,`File.stream!`å‘å‡ºè¡Œè€Œä¸ä»…ä»…æ˜¯å—ã€‚å‘å‡ºè¡Œæ¯”å‘å‡ºå—æ…¢ï¼Œæˆ‘æƒ³æ˜¯å› ä¸ºæµéœ€è¦åœ¨å°†å—åˆ†å‰²æˆå­—ç¬¦ä¸²æ—¶å¯»æ‰¾æ¢è¡Œç¬¦ã€‚

ä¸ºäº†å¼ºåˆ¶æµå‘å‡ºå—ï¼Œæˆ‘ä»¬ä½¿ç”¨ [`File.stream!/3`](https://hexdocs.pm/elixir/File.html#stream!/3)

```
iex> File.stream!(file_path, [], 2_048)
%File.Stream{
    line_or_bytes: 2048,
    modes: [:raw, :read_ahead, :binary],
    path: file_path,
    raw: true
} 
```

è®¾ç½® 2048 å­—èŠ‚çš„å—å¤§å°ã€‚

æˆ‘åšäº†ä¸€ä¸ªå¿«é€Ÿçš„åŸºå‡†æµ‹è¯•([ä½ å¯ä»¥åœ¨è¿™ä¸ªè¦ç‚¹ä¸Šæ‰¾åˆ°](https://gist.github.com/alvises/54451c50ac0b9bafe0c932e4b2240b32))ï¼Œæˆ‘ä»¬çœ‹åˆ°æµæ•°æ®å—é€Ÿåº¦æ›´å¿«ï¼Œå†…å­˜æ–¹é¢ä¹Ÿæ›´å¥½ã€‚

```
Name             ips        average  deviation         median         99th %
chunks       23.29 K       42.93 Î¼s    Â±63.44%       41.98 Î¼s       83.98 Î¼s
lines         9.21 K      108.54 Î¼s    Â±42.52%       93.98 Î¼s      275.98 Î¼s

Comparison:
chunks       23.29 K
lines         9.21 K - 2.53x slower +65.61 Î¼s

Memory usage statistics:

Name      Memory usage
chunks         2.11 KB
lines         20.84 KB - 9.88x memory usage +18.73 KB 
```

# æ€»ç»“èµ·æ¥

æˆ‘ä»¬å·²ç»äº†è§£äº†ä»€ä¹ˆæ˜¯æ•£åˆ—å‡½æ•°ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Elixir è½»æ¾è®¡ç®—æ–‡ä»¶çš„æ•£åˆ—ã€‚

**è¿‡å»**(ä¸å¹¸çš„æ˜¯æˆ‘è®¤ä¸ºè¿˜åœ¨ç°åœ¨ğŸ˜…)ï¼Œå“ˆå¸Œå‡½æ•°**è¢«**ç”¨æ¥åœ¨æ•°æ®åº“ä¸­å­˜å‚¨å¯†ç ã€‚å¦‚æœæ‚¨éœ€è¦**å®‰å…¨**å¤„ç†å’Œå­˜å‚¨å¯†ç ï¼Œè¯·ä½¿ç”¨ [**bcrypt_elixir**](https://hex.pm/packages/bcrypt_elixir) åº“ï¼

ä½ å¯¹ä»™ä¸¹å’Œå‡¤å‡°æœ‰çƒ­æƒ…å—ï¼Ÿè®¢é˜… Poeticoding æ—¶äº‹é€šè®¯ï¼ŒåŠ å…¥å¿«ä¹çš„æ™®é€šè¯»è€…ï¼Œé€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶æ–°å¸–å­ã€‚