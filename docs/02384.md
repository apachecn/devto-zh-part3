# ä½¿ç”¨æ“ä½œç­–ç•¥å…¬å¼€ GraphQL APIs ä¸­çš„æƒé™

> åŸæ–‡:[https://dev . to/evil Marshall/expering-permissions-in-graph QL-APIs-with-action-policy-1mfh](https://dev.to/evilmartians/exposing-permissions-in-graphql-apis-with-action-policy-1mfh)

ä»Šå¤©ï¼Œæˆ‘æ­£åœ¨â€œåº†ç¥â€æˆ‘ä½¿ç”¨ GraphQL ç”Ÿäº§ Rails åº”ç”¨çš„å‘¨å¹´çºªå¿µæ—¥â€”â€”1 å¹´äº†ï¼Œå……æ»¡äº†å°è¯•å’Œé”™è¯¯ã€å¤±è´¥å’ŒæˆåŠŸã€ *wtf* -s å’Œ[æˆåŠŸ](https://dev.to/evilmartians/active-storage-meets-graphql-direct-uploads-3n38)ã€‚

[![](../Images/5ff94e4cbfc0f7413a3e4074cee86715.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DDokdZg1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ec54litfkgkgpw527q8i.png)

ä½œä¸ºä¸€ä¸ªå¼€æºè¿·ï¼Œæˆ‘ç‰¹åˆ«å–œæ¬¢ä½¿ç”¨ GraphQL:è¿™æ˜¯ä¸€é¡¹ç›¸å½“å¹´è½»çš„æŠ€æœ¯ï¼Œå› æ­¤æœ‰å¾ˆå¤šæœºä¼šåšå‡ºè´¡çŒ®(è‡³å°‘åœ¨ Ruby world ä¸­)å’Œè¿›è¡Œå®éªŒã€‚

ç°åœ¨æˆ‘æ­£åœ¨å±•ç¤ºä¸€ä¸ªè¿™æ ·çš„å®éªŒçš„ç»“æœâ€”â€”[`action_policy-graphql`gem](https://github.com/palkan/action_policy-graphql),å®ƒå°† [GraphQL Ruby](https://graphql-ruby.org) å’Œ[åŠ¨ä½œç­–ç•¥](https://actionpolicy.evilmartians.io/)æˆæƒåº“ç²˜åˆåœ¨ä¸€èµ·ã€‚

## [](#wait-action-policy-was-ist-das)ç­‰ç­‰ï¼Œè¡ŒåŠ¨æ–¹é’ˆï¼Œæ˜¯ ist das*ï¼Ÿ

**â€œè¿™æ˜¯ä»€ä¹ˆâ€å¾·è¯­(å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘æ­£åœ¨å¬æ‹‰å§†æ–¯å¦çš„æ­ŒğŸ¸)*

å¤§çº¦åœ¨æˆ‘å¼€å§‹ä½¿ç”¨ GraphQL çš„åŒæ—¶ï¼Œæˆ‘å‘ä¸–ç•Œå±•ç¤ºäº†ä¸€ä¸ªæ–°çš„ Ruby æˆæƒåº“ï¼Œ [Action Policy](https://actionpolicy.evilmartians.io/) (åœ¨ RailsConf 2018 ä¸Šçš„[)ã€‚](https://www.youtube.com/watch?v=NVwx0DARDis)

è¡ŒåŠ¨ç­–ç•¥æ˜¯ä»æˆ‘è¿‡å»å‡ å¹´ä»äº‹çš„å¤šä¸ªé¡¹ç›®ä¸­æå–å‡ºæ¥çš„ã€‚å®ƒåœ¨æ„è¯†å½¢æ€ä¸Šç±»ä¼¼äº[æƒå¨äººå£«](https://github.com/varvet/pundit)(æœ€åˆæ˜¯åœ¨å®ƒçš„åŸºç¡€ä¸Šæ„å»ºçš„)ï¼Œä½†æä¾›äº†ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„é™„åŠ åŠŸèƒ½(å¹¶ä¸”åœ¨å†…éƒ¨æœ‰ä¸€ä¸ªéå¸¸ä¸åŒçš„æ¶æ„*)ã€‚*

è¿™äº›ç‰¹æ€§ä¹‹ä¸€æ˜¯èƒ½å¤Ÿæä¾›å…³äº*ä¸ºä»€ä¹ˆ*æˆæƒæ£€æŸ¥å¤±è´¥çš„é™„åŠ ä¸Šä¸‹æ–‡-[**å¤±è´¥åŸå› **](https://actionpolicy.evilmartians.io/#/reasons) è·Ÿè¸ªã€‚

è¿™ä¸ªç‰¹æ€§åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œéƒ½æ˜¯ä¸€åŒ¹é»‘é©¬ï¼Œæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨å®ƒ(ä¸»è¦æ˜¯ä¸ºäº†è°ƒè¯•ç›®çš„)ï¼Œç›´åˆ°æˆ‘ä»¬å¼€å§‹ä¸ GraphQL åˆä½œâ€”â€”é‚£å°±æ˜¯ä¸‘å°é¸­å˜æˆç¾ä¸½å¤©é¹…çš„æ—¶å€™ã€‚

> è¦äº†è§£æ›´å¤šå…³äºè¡ŒåŠ¨æ”¿ç­–åŠå…¶ç‰¹ç‚¹çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»Šå¹´æ—©äº›æ—¶å€™åœ¨ [Seattle.rb](http://www.seattlerb.org) å‘è¡¨çš„æœ€æ–°æ¼”è®²çš„å¹»ç¯ç‰‡:ã€https://speakerdeck.com/palkan/seattle-dot-rb-2019-a-denialã€‘T2ã€‚

## [](#authorization-amp-graphql)æˆæƒ& GraphQL

> *æˆæƒ*æ˜¯ç»™äºˆæŸäººåšæŸäº‹çš„å®˜æ–¹è®¸å¯çš„è¡Œä¸º(ä¸è¦ä¸[è®¤è¯](https://en.wikipedia.org/wiki/Authentication)æ··æ·†)ã€‚

æ¯å½“æˆ‘ä»¬åœ¨ä»£ç ä¸­â€œè¯¢é—®â€æ—¶ï¼Œâ€œå…è®¸ç”¨æˆ·è¿™æ ·åšå—ï¼Ÿâ€æˆ‘ä»¬æ‰§è¡Œæˆæƒè¡Œä¸ºã€‚

åœ¨å¤„ç† GraphQL æ—¶ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥åˆ†æˆæ›´å…·ä½“çš„é—®é¢˜:

*   æ˜¯å¦å…è®¸ç”¨æˆ·ä¸å¯¹è±¡(ç‰¹å®šç±»å‹æˆ–å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹)è¿›è¡Œäº¤äº’ï¼Ÿ
*   æ˜¯å¦å…è®¸ç”¨æˆ·æ‰§è¡Œæ­¤çªå˜æˆ–è®¢é˜…æ­¤è®¢é˜…ï¼Ÿ

å¦ä¸€ä¸ªç›¸å…³çš„æ–¹é¢æ˜¯*æ•°æ®èŒƒå›´*:æ ¹æ®ç”¨æˆ·çš„æƒé™è¿‡æ»¤é›†åˆï¼Œè€Œä¸æ˜¯æ£€æŸ¥æ¯ä¸€é¡¹ã€‚

`graphql` gem æä¾›äº†åŸºæœ¬çš„[æˆæƒæ”¯æŒ](https://graphql-ruby.org/authorization/authorization.html)(é€šè¿‡`#authorized?`é’©å­)å’Œ[èŒƒå›´æ”¯æŒ](https://graphql-ruby.org/authorization/scoping.html)(é€šè¿‡`#scope_items`é’©å­):å®ƒåœ¨å¼€å§‹æ—¶å¯èƒ½è¶³å¤Ÿå¥½ï¼Œä½†æ˜¯ç”±äºæ ·æ¿æ–‡ä»¶çš„æ•°é‡è€Œä¸èƒ½å¾ˆå¥½åœ°æ‰©å±•ã€‚

è¿™å°±æ˜¯æˆ‘å¼€å§‹å¼€å‘ [`action_policy-graphql` gem](https://github.com/palkan/action_policy-graphql) çš„åŸå› â€”â€”ä¸ºå­—æ®µæˆæƒå’Œä½œç”¨åŸŸæä¾›æ›´å¥½çš„ API(ç±»ä¼¼äºä½ åœ¨ [GraphQL Pro](https://graphql.pro) ä¸­çœ‹åˆ°çš„ç”¨äº`pundit`å’Œ`cancancan`çš„ API)ã€‚ç°åœ¨æˆ‘ä»¬è¿™æ ·æè¿°æˆ‘ä»¬çš„ API:

```
# field authorization example (`authorize: true`)
field :home, Home, null: false, authorize: true do
  argument :id, ID, required: true
end

# data scoping using policies (`authorized_scope: true`)
field :events, EventType.connection_type, null: false, authorized_scope: true 
```

è¿™ä¸ªå®ç°åœ¨å†…éƒ¨ä½¿ç”¨äº† [*å­—æ®µæ‰©å±•*](https://graphql-ruby.org/type_definitions/field_extensions.html) ï¼Œè¿™æ¯”åœ¨`#authorized?`å’Œ`#scope_items`é’©å­ä¸Šæ„å»ºæ›´åŠ çµæ´»ã€‚

é—®é¢˜ä¼¼ä¹å¾—åˆ°äº†è§£å†³:ä½¿ç”¨ API ä¸­ç­–ç•¥ç±»ä¸­å®šä¹‰çš„æˆæƒå’Œä½œç”¨åŸŸè§„åˆ™æ¥æ£€æŸ¥æƒé™å’Œå¼•å‘å¼‚å¸¸å˜å¾—æ¯«ä¸è´¹åŠ›(*â€œè®¿é—®è¢«æ‹’ç»ï¼â€*)ã€‚å°½ç®¡åä¸€ç§æ–¹å¼â€”â€”å¼•å‘å¼‚å¸¸â€”â€”å¹¶ä¸æ˜¯é€šçŸ¥ç”¨æˆ·ç¼ºå°‘æƒé™çš„æœ€ä½³æ–¹å¼ã€‚

å¦‚ä½•é˜²æ­¢è¿™äº›å¼‚å¸¸ï¼Œ ***å‘Šè¯‰*å‰ç«¯å®¢æˆ·ç«¯ï¼Œå“ªäº›åŠ¨ä½œæ˜¯å…è®¸çš„ï¼Œå“ªäº›æ˜¯ä¸å…è®¸çš„**ï¼Ÿ

## [](#let-the-client-know-about-its-rights)è®©å®¢æˆ·äº†è§£è‡ªå·±çš„æƒåˆ©

[å°†å½“å‰ç”¨æˆ·çš„æƒé™](https://github.com/palkan/action_policy/issues/69)ä¿¡æ¯*ä¸‹æ¨*åˆ°å®¢æˆ·ç«¯(å‰ç«¯/ç§»åŠ¨åº”ç”¨)çš„é—®é¢˜å¹¶ä¸æ–°é²œï¼›å®ƒåœ¨ GraphQL è¯ç”Ÿå‰å‡ å¹´å°±å­˜åœ¨äº†ã€‚

è¿™ä¸ªé—®é¢˜å¯ä»¥è½¬åŒ–ä¸ºä¸‹é¢çš„é—®é¢˜:*å¦‚ä½•è®©å®¢æˆ·ç«¯çŸ¥é“å“ªäº›åŠ¨ä½œæ˜¯å…è®¸ç»™ç”¨æˆ·çš„(å¹¶æ˜¾ç¤º/éšè—ç‰¹å®šçš„æŒ‰é’®/é“¾æ¥/æ§ä»¶)*ï¼Ÿ

æ€ä¹ˆè§£å†³ï¼Ÿ

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°è¯•åªä¼ é€’*æˆæƒæ¨¡å‹*(è§’è‰²ã€æƒé™é›†)å¹¶åœ¨å®¢æˆ·ç«¯å®ç°(å³å¤åˆ¶)æˆæƒè§„åˆ™ã€‚è¿™æ ·çš„é‡å¤æœ€å®¹æ˜“æ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šã€‚

> **ä½ åº”è¯¥ä¾é å•ä¸€æ¥æºçš„*æˆæƒ*çœŸç›¸**ã€‚

è¿™ä¸ªçœŸå®çš„å•ä¸€æ¥æºé€šå¸¸æ˜¯ä¸€ä¸ª**æœåŠ¡å™¨**(å› ä¸ºé‚£æ˜¯æ‚¨è‡ªå·±æ‰§è¡Œæˆæƒæ£€æŸ¥çš„åœ°æ–¹)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†ç­–ç•¥è§„åˆ™è½¬æ¢æˆå®¢æˆ·ç«¯å…¼å®¹çš„æ ¼å¼â€”â€”ä¾‹å¦‚ï¼ŒJSON å¯¹è±¡ã€‚

å°†ç”¨æˆ·æ‰€æœ‰å¯èƒ½çš„æˆæƒè§„åˆ™è½¬å‚¨åˆ°ä¸€ä¸ª JSON å¯¹è±¡ä¸­ä¼¼ä¹ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬æœ‰å‡ åä¸ªç­–ç•¥ç±»æ—¶ã€‚å¸Œæœ› GraphQL çš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯**èƒ½å¤Ÿåªè¯·æ±‚ä½ éœ€è¦çš„æ•°æ®**(å¹¶é¿å…*è¿‡åº¦æå–*)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä»å‘ GraphQL ç±»å‹æ·»åŠ `canDoSmth`å¸ƒå°”å­—æ®µçš„ç®€å•æƒ³æ³•å¼€å§‹:

```
class EventType < Types::BaseType
  # include Action Policy helpers (`authorize!`, `allowed_to?`)
  include ActionPolicy::Behaviour

  field :can_destroy, Boolean, null: false

  def can_destroy
    # checks the EventPolicy#destroy? rule for the object
    allowed_to?(:destroy?, object, context: {user: context[:current_user]})
  end
end 
```

ç°åœ¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥*è¯¢é—®*æœåŠ¡å™¨æ˜¯å¦å…è®¸åˆ é™¤äº‹ä»¶:

```
query  {  event(id:  $id)  {  canDestroy  # true | false  }  } 
```

æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª*å®*æ¥å®šä¹‰æˆæƒå­—æ®µï¼Œä»¥å‡å°‘æ ·æ¿æ–‡ä»¶:

```
class EventType < Types::BaseType
  include ActionPolicy::Behaviour

  expose_authorization_rules :destroy?, :edit?, :rsvp?
end 
```

â€œæˆ‘ä»¬åˆ°äº†å—ï¼Ÿâ€ã€‚æ²¡æœ‰ã€‚

## [](#clients-need-more-context)å®¢æˆ·ç«¯éœ€è¦æ›´å¤šçš„ä¸Šä¸‹æ–‡

äº‹å®è¯æ˜ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒçŸ¥é“åŠ¨ä½œæ˜¯å¦è¢«å…è®¸(`true`æˆ–`false`)æ˜¯ä¸å¤Ÿçš„:æˆ‘ä»¬è¿˜éœ€è¦å‘ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥(æˆ–è€…å›ç­”é—®é¢˜â€œä¸ºä»€ä¹ˆï¼Ÿâ€).åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ ¹æ®æˆ‘ä»¬ä¸å…è®¸æ­¤æ“ä½œçš„åŸå› ï¼Œæ­¤æ¶ˆæ¯ä¼šæœ‰æ‰€ä¸åŒã€‚

è€ƒè™‘ä¸€ä¸ªæ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å…è®¸å›å¤äº‹ä»¶çš„è§„åˆ™çš„ç®€åŒ–ç¤ºä¾‹:

```
def rsvp?
  allowed_to?(:show?) &&  # => User should have an access to this event
  rsvp_open? &&           # => RSVP should be open
  seats_available?        # => There must be seats left
end 
```

æˆ‘ä»¬å¯¹æœ€åä¸¤ä¸ªæ£€æŸ¥æœ€æ„Ÿå…´è¶£(å› ä¸ºå¦‚æœç”¨æˆ·æ— æƒè®¿é—®äº‹ä»¶ï¼Œå®ƒå°±ä¸åº”è¯¥è¯·æ±‚ RSVP çš„è®¸å¯)ã€‚

å½“ RSVP å…³é—­æ—¶ï¼Œæˆ‘ä»¬è¦æ˜¾ç¤º*â€œRSVP å·²ç»ä¸ºæ­¤äº‹ä»¶å…³é—­â€*æ¶ˆæ¯ï¼›å½“æ²¡æœ‰æ›´å¤šçš„åº§ä½æ—¶-*â€œæ­¤æ´»åŠ¨å·²å”®å®Œã€‚â€*

æˆ‘ä»¬å¦‚ä½•ä»æˆ‘ä»¬çš„æ”¿ç­–ä¸­è·å¾—è¿™äº›ä¿¡æ¯ï¼Ÿä½¿ç”¨ [*å¤±è´¥åŸå› *](https://actionpolicy.evilmartians.io/#/reasons) åŠŸèƒ½ï¼

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å˜ä¸€ä¸‹æˆ‘ä»¬çš„è§„åˆ™:

```
def rsvp?
  allowed_to?(:show?) &&
  # wrapping method call into a `check?` method
  # tracks the failure of this check (i.e. when it returns false) 
  check?(:rsvp_open?) &&
  check?(:seats_available?)
end 
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»æˆæƒæ£€æŸ¥ç»“æœä¸­æ£€ç´¢é™„åŠ çš„ä¸Šä¸‹æ–‡:

```
policy = EventPolicy.new(record: event, user: user)
# first, apply the rule
policy.apply(:rsvp?)
# now we can access the result object and its reasons
# for example, details hash contains the checks names grouped
# by a policy
policy.result.reasons.details #=> {event: [:rsvp_open?]} or {event: [:seats_available?]} 
```

ç­‰ç­‰ï¼Ÿç»†èŠ‚å“ˆå¸Œï¼Ÿæ ‡è¯†ç¬¦ï¼Ÿæˆ‘ä»¬éœ€è¦äººç±»å¯è¯»çš„ä¿¡æ¯ï¼

å¥½çš„ã€‚è¿™é‡Œæ¥äº†è¡ŒåŠ¨æ–¹é’ˆå’Œ [i18n æ•´åˆ](https://actionpolicy.evilmartians.io/#/i18n)ã€‚

è®©æˆ‘ä»¬å°†æ¶ˆæ¯æ·»åŠ åˆ°è¯­è¨€ç¯å¢ƒæ–‡ä»¶:

```
en:
  action_policy:
    policy:
      event:
        rsvp?: "You  cannot  RSVP  to  this  event"
        rsvp_opened?: "RSVP  has  been  closed  for  this  event"
        seats_available?: "This  event  is  sold  out" 
```

è¦è®¿é—®æœ¬åœ°åŒ–çš„æ¶ˆæ¯ï¼Œå¯ä»¥å¯¹ç»“æœå¯¹è±¡ä½¿ç”¨`#full_messages`æ–¹æ³•:

```
policy.result.reasons.full_messages #=> ["RSVP has been closed for this event"]

# to access the top-level (rule) message
policy.result.message #=> "You cannot RSVP to this event" 
```

ç°åœ¨å›åˆ° GraphQLï¼Œå¢å¼ºæˆ‘ä»¬çš„`expose_authorization_rules`å®ï¼Œç”¨`AuthorizationResult`ç±»å‹å®šä¹‰ä¸€ä¸ªå­—æ®µ:

[![](../Images/8c7e0168e44c24e30dc5160f1e92efc7.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--X3JsRclp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/9x5317vavmbuwv77077u.png)

å…¶ä¸­åŒ…å«ä¸€ä¸ª`FailureReasons`ç±»å‹çš„`reasons`å­—æ®µ:

[![](../Images/daf36a4aa1f63e2eeba5b08da6a70903.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LMVmBI5W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/fdyjh0zica8h9ynxtzgs.png)

ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
query  {  event(id:  $id)  {  canDestroy  {  value  # true | false  message  # top-level message  reasons  {  details  # JSON-encoded failure details  fullMessages  # human-readable messages  }  }  }  } 
```

è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

*   æ‚¨æœ‰ä¸€ä¸ªè·å–æˆæƒä¿¡æ¯çš„æ ‡å‡†åŒ– API
*   æ‚¨æœ‰ä¸€ä¸ªå¤„ç†æˆæƒçš„æŠ½è±¡å±‚(ç­–ç•¥ç±»)
*   å‘æ¨¡å¼ä¸­æ·»åŠ æˆæƒè§„åˆ™å¾ˆç®€å•(è€Œä¸”ï¼Œç”±äºåŠ¨ä½œç­–ç•¥[å¯æµ‹è¯•æ€§](https://actionpolicy.evilmartians.io/#/testing)ï¼Œæµ‹è¯•ä¹Ÿå¾ˆç®€å•)ã€‚

ä»¥åŠä½¿ç”¨ [`action_policy-graphql`å®çŸ³](https://github.com/palkan/action_policy-graphql)æ—¶å…è´¹è·å¾—çš„æ‰€æœ‰åŠŸèƒ½ï¼

* * *

é˜…è¯»æ›´å¤šå…³äº https://evilmartians.com/chronicles çš„æ–‡ç« ï¼