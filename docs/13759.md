# å¤„ç† lambda å‡½æ•°ä¸­çš„å¤æ‚æ€§

> åŸæ–‡:[https://dev . to/juliantellez/handling-complexity-in-lambda-functions-28dj](https://dev.to/juliantellez/handling-complexity-in-lambda-functions-28dj)

æ­¤å¤„è§åŸå‘å¸ƒç‰ˆæœ¬[ã€‚](https://medium.com/dazn-tech/handling-complexity-in-lambda-functions-e7acfbeb920a)

### TLDRï¼›

> ä¸­é—´ä»¶å¯ä»¥å¤„ç† lambdas çš„å¤æ‚æ€§ï¼ŒåŒæ—¶å°†ä¸šåŠ¡é€»è¾‘å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹éš”ç¦»åœ¨å¯ä»¥é€šè¿‡äº‹ä»¶å‘¨æœŸå»ºæ¨¡çš„å¯é‡ç”¨ç»„ä»¶ä¸­ã€‚

æœ€è¿‘æˆ‘æœ‰å¹¸å’Œ lambda å‡½æ•°ä¸€èµ·å·¥ä½œï¼Œæˆ‘å¾ˆå¼€å¿ƒï¼æ‹¥æœ‰ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„æ‰§è¡Œç¯å¢ƒçš„æƒ³æ³•æ—¢å¤§èƒ†åˆä»¤äººå…´å¥‹ã€‚

å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦ FaaS ä¸–ç•Œï¼Œä¸è¦æ‹…å¿ƒï¼Œç¤¾åŒºå·²ç»ä¸ºä½ å‡†å¤‡äº†ä¸€ä»½ç²¾é€‰çš„é˜…è¯»æ¸…å•[è¿™é‡Œ](https://github.com/anaibol/awesome-serverless)å’Œ[è¿™é‡Œ](https://github.com/pmuens/awesome-serverless)ã€‚éšä¾¿çœ‹çœ‹ï¼Œå–ç‚¹å’–å•¡ã€‚â˜•

å¦‚ä½ æ‰€è§ï¼Œ(å› ä¸ºä½ è‡³å°‘æ£€æŸ¥äº†å…¶ä¸­ä¸€ä¸ªé“¾æ¥ï¼Œä¸æ˜¯å—ï¼Ÿ)ä¸€ä¸ªå·¨å¤§çš„é‡é‡è¢«ä¸¾èµ·äº†ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥å¼€å‘ã€è¿è¡Œå’Œç®¡ç†åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ„å»ºå’Œç»´æŠ¤å¤æ‚çš„åŸºç¡€æ¶æ„ã€‚ä½†æ˜¯éšç€æ–°çš„å¼€å§‹ï¼Œæ–°çš„æŒ‘æˆ˜å‡ºç°äº†ã€‚å…¶ä¸­ä¸€ä¸ªé—®é¢˜å’Œè¿™ä¸ªåšå®¢çš„åŸå› æ˜¯å‡½æ•°çš„å¤æ‚æ€§ã€‚

## [](#how-complex-is-too-complex)å¤šå¤æ‚æ‰ç®—å¤æ‚ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç¼–å†™ lambda å‡½æ•°æ—¶ï¼Œä½ ä¼šæŒ‰ç…§[å•ä¸€è´£ä»»åŸåˆ™](https://en.wikipedia.org/wiki/Single_responsibility_principle)å°†å®ƒä»¬ç»„ç»‡æˆä¸€ç³»åˆ—ä¸“ç”¨æ¨¡å—ã€‚å¦‚æœä½ å®æ„¿ä¸è¿™æ ·åšï¼Œè¯·é˜…è¯»è¿™ç¯‡æ¯”è¾ƒ[å•ç‰‡ä¸å•ä¸€ç”¨é€”åŠŸèƒ½](https://hackernoon.com/aws-lambda-should-you-have-few-monolithic-functions-or-many-single-purposed-functions-8c3872d4338f)çš„ä¼˜ç§€åšå®¢ã€‚å°†åº”ç”¨ç¨‹åºä¸ä¸šåŠ¡é€»è¾‘éš”ç¦»å¼€æ¥ï¼Œå¯ä»¥é™ä½ä»£ç çš„å¤æ‚æ€§ï¼Œç®€åŒ–æ¨ç†ï¼Œå¹¶å¸®åŠ©æ‚¨æ›´æœ‰æ•ˆåœ°è°ƒè¯•ä»£ç ã€‚ä½ çš„åŒäº‹å’Œæœªæ¥çš„è‡ªå·±éƒ½ä¼šæ„Ÿè°¢ä½ ã€‚

ä»¥æŸç§ CRUD API ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å¤„ç†ä»»ä½•æ•°æ®ä¹‹å‰ï¼Œç¡®ä¿æœ‰æ•ˆè½½è·çš„æ ¼å¼æ­£ç¡®ã€‚æœ‰æ•ˆè´Ÿè½½éªŒè¯å¯èƒ½ä¼šå‘å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°†å…¶çŠ¶æ€ä¼ è¾¾ç»™ä½¿ç”¨è€…ã€‚å¦‚æœéªŒè¯æˆåŠŸï¼Œå®ƒå°†ç»§ç»­æ‰§è¡Œä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚å¯¹äºè¿™ä¸¤ç§åœºæ™¯ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›è®¾ç½®ä¸€äº›ç™¾åˆ†æ¯”è·Ÿè¸ªå’Œé”™è¯¯æ—¥å¿—è®°å½•ã€‚è™½ç„¶æ‰€æœ‰è¿™äº›å¬èµ·æ¥éƒ½å¾ˆæ£’ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šå·²ç»ç”¨å„ç§[æ¨ªåˆ‡å…³æ³¨ç‚¹](https://en.wikipedia.org/wiki/Cross-cutting_concern)ç»˜åˆ¶äº†ä¸€ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ:

*   æ•°æ®éªŒè¯ã€‚
*   é”™è¯¯æ£€æµ‹å’Œçº æ­£ã€‚
*   ä¼æœ¨ã€‚
*   ç›‘æ§ã€‚

[![](../Images/0b0805023b086db7f6056e20cffb8d18.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--A6LDVOJh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn-images-1.medium.com/max/1600/1%2AXT2_l9PLKtuZxKNGTYa4Uw.gif) 
*æˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆâ€¦ (gif from giphy)*

éµå¾ªæ— æœåŠ¡å™¨åŸåˆ™ï¼Œæˆ‘ä»¬åº”è¯¥å°†ä»»ä½•ä¸æ ¸å¿ƒä¸šåŠ¡æ— å…³çš„äº‹æƒ…å¤–åŒ…å‡ºå»ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å¹¶å°†è¿™äº›ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„é—®é¢˜ä¹Ÿå¤–åŒ…å‡ºå»ï¼Œé‚£ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿå½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œæˆ‘ä»¬å·²ç»åœ¨ web æ¡†æ¶ä¸­ä½¿ç”¨å®ƒå¾ˆé•¿æ—¶é—´äº†ï¼Œå¦‚ [hapijs](http://hapijs.com) å’Œ [express](https://expressjs.com) ã€‚

## Î»ä¸­é—´ä»¶

lambda [ä¸­é—´ä»¶](https://en.wikipedia.org/wiki/Middleware)æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä»¥ä¸€è‡´çš„æ–¹å¼å¸®åŠ©ç®¡ç†æ¨ªåˆ‡å…³æ³¨ç‚¹çš„åŠŸèƒ½ã€‚å®ƒæä¾›äº†åº”ç”¨ç¨‹åºå’Œä¸šåŠ¡é€»è¾‘çš„æ¸…æ™°åˆ†ç¦»ï¼Œå¹¶æ¦‚è¿°äº†ä¸€ä¸ªæ˜“äºæ¨ç†çš„é…ç½®å‘¨æœŸã€‚å®ƒæ˜¯ä¸€ç§ç²˜åˆå‰‚ï¼Œå½“å›¢é˜Ÿä¸­çš„æ¯ä¸ªäººéƒ½é‡‡ç”¨å®ƒæ—¶ï¼Œå®ƒå°±ä¼šæˆä¸ºæ”¯æŒå’Œåˆ›å»ºç‰¹æ€§çš„é€šç”¨è¯­è¨€ã€‚ä½†æ˜¯æˆ‘ä»¬çœŸçš„éœ€è¦ä¸­é—´ä»¶å—ï¼Ÿå¥½å§ï¼Œçœ‹çœ‹ä½ çš„å…°å§†è¾¾æ–¯çš„ç°çŠ¶ï¼Œé—®è‡ªå·±å‡ ä¸ªé—®é¢˜:

*   ä»£ç æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ
*   ä½ èƒ½æƒ³è±¡è‡³å°‘åœ¨ä¸¤å¹´å†…æœ‰äººä¼šæ”¯æŒå®ƒå—ï¼Ÿ
*   éœ€è¦å¤šå°‘ä¸šåŠ¡é€»è¾‘ä¸“ä¸šçŸ¥è¯†ï¼Ÿ(å¦‚æœæ˜¯ä¸“ä¸šåŒ–çš„ï¼Œé‚£ä¹ˆåˆ†ç¦»æ˜¯å¿…è¦çš„)
*   é€»è¾‘æ˜¯å¦çº ç¼ åœ¨ä¸€èµ·ï¼Œéš¾ä»¥æ¨ç†ï¼Ÿ
*   è¿™ä¸ªé¡¹ç›®æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„è·¯å¾„ï¼Œæˆ–è€…ä½ è®¤ä¸ºå®ƒä¼šæœç€ä¸åŒçš„æ–¹å‘å‘å±•ï¼Ÿ
*   ä¸“å®¶ç¦»å¼€çš„é‚£ä¸€å¤©ï¼Œé¡¹ç›®ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿ
*   æœ€ä½³å®è·µæ˜¯å¦å¾—åˆ°å®æ–½å’Œç»´æŠ¤ï¼Ÿ

[![](../Images/37019a894738d17e3675428b77329333.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--p_Sk-iR4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn.hashnode.com/res/hashnode/image/upload/v1549761422481/5LOA6J7hr.gif) 
*æ°å…‹Â·å°¼ç§‘å°”æ£®è®¤å¯ã€‚(gif æ¥è‡ª giphy)*

## [](#enter-lambcycle)è¿›å…¥ Lambcycle

[Lambcycle](https://github.com/juliantellez/lambcycle) ğŸ‘ğŸ›µæ˜¯ lambda å‡½æ•°çš„å£°æ˜æ€§ä¸­é—´ä»¶ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªå¯é…ç½®çš„äº‹ä»¶å‘¨æœŸï¼Œå¹¶å…è®¸æ‚¨å…³æ³¨åº”ç”¨ç¨‹åºçš„é€»è¾‘ã€‚å®ƒæœ‰ä¸€ä¸ªâ€œåŠŸèƒ½æ’ä»¶â€çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ›å»ºä½ è‡ªå·±çš„æ’ä»¶æˆ–é‡ç”¨ä½ æœ€å–œæ¬¢çš„è½¯ä»¶åŒ…ã€‚

åœ¨å®è·µä¸­ï¼Œä¸å­˜åœ¨éæ„è§åŒ–çš„æ¡†æ¶ï¼Œæ¯ä¸€ä¸ªæƒ³æ³•éƒ½æ˜¯ä¸€ç§æ„è§ï¼Œæ˜¯ä¸€ç§å¤„ç†åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚Lambcycle æ›´å–œæ¬¢é…ç½®è€Œä¸æ˜¯ä»£ç ï¼Œå¹¶ä¸”è®¤ä¸ºä¸šåŠ¡é€»è¾‘åº”è¯¥å°½å¯èƒ½åœ°éš”ç¦»ã€‚

[![](../Images/b143fc04f6d2c7d6bf2a1b61e5350bfe.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--FyEK_q4D--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1600/1%2A5I_ZBcvd03ktQpGXuA2kgQ.png) 
*Labmcycle æµç¨‹å›¾ã€‚*

Lambcycle ç”¨å‡ ä¸ªæ‰©å±•ç‚¹å¢å¼ºäº† lambda å‡½æ•°(è§å›¾)ï¼Œæ¯ä¸ªæ‰©å±•ç‚¹éƒ½å¯ä»¥ç”¨æ¥ä»¥åˆ†è§£çš„æ–¹å¼ä¸äº‹ä»¶äº¤äº’ã€‚

*   ç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹æ˜¯`Request`ï¼Œå®ƒåœ¨ lambda è¢«è°ƒç”¨åç«‹å³å‡ºç°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ­¥éª¤è¿›è¡Œè§£æã€éªŒè¯ç­‰...
    æ³¨æ„:å¦‚æœä½ æ­£åœ¨è€ƒè™‘æˆæƒï¼Œè¯·è€ƒè™‘ä¸€ä¸ª [lambda æˆæƒè€…](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html)ã€‚

*   å½“æ‚¨éœ€è¦è°ƒæ•´æ•°æ®ä»¥é€‚åº”æ¥å£æ—¶,`Pre Handler`æ‰©å±•å°±æ´¾ä¸Šäº†ç”¨åœºã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªè·å–ç§˜å¯†çš„å¥½åœ°æ–¹ã€‚

*   ä½ ç¾ä¸½çš„å•†ä¸šé€»è¾‘æ‰€åœ¨çš„åœ°æ–¹ã€‚

*   æ¥ä¸‹æ¥æ˜¯`Post Handler`ï¼Œä½¿ç”¨è¿™ä¸ªæ‰©å±•æ¥éªŒè¯å’Œ/æˆ–ç¼“å­˜ä¸šåŠ¡é€»è¾‘çš„è¾“å‡ºã€‚

*   `Error`æ˜¯æ—¥å¿—å’Œè·Ÿè¸ªçš„éšå¼æ‰©å±•ã€‚

*   æœ€åæ˜¯`Pre Response`ï¼Œæ‚¨æœ‰æœºä¼šæ ¼å¼åŒ–å¯¹æ¶ˆè´¹è€…çš„å“åº”(å¯ä»¥æ˜¯æ•°æ®æˆ–é”™è¯¯)ã€‚

## [](#using-the-middleware)ä½¿ç”¨ä¸­é—´ä»¶

```
import Joi from 'joi'
import lambcycle from 'lambcycle'
import joiPlugin from 'lambcycle/dist/plugin-joi'
import bodyParser from 'lambcycle/dist/plugin-body-parser'
import realTimeEventTracker from './bugFreeBizLogic'

const businessLogic = async(event, context) => {
    const {error, data} = await realTimeEventTracker(event.data)

    if(error) {
        throw error
    }

    return data;
};

const schema = Joi.object().keys({
    assetId: Joi.string().required(),
    competition: Joi.string().required(),
    sport: Joi.string(),
    tournamentCalendar: Joi.date(),
}).required()

const handler = lambcycle(businessLogic)
.register([
    bodyParser({type: 'json'}),
    joiPlugin(schema)
])

export default handler 
```

ä¸Šé¢çš„ä¾‹å­åˆ©ç”¨äº† [express çš„ä¸»ä½“è§£æå™¨](https://github.com/expressjs/body-parser)å’Œ [hapi çš„ joi éªŒè¯](https://github.com/hapijs/joi)ã€‚æˆ‘ä»¬å·²ç»åˆ†åˆ«ä¸ºè¿™ä¸¤ä¸ªæ’ä»¶é…ç½®äº†è§£æç±»å‹å’ŒéªŒè¯æ¨¡å¼ã€‚é€šè¿‡æŠ½è±¡è¿™ä¸¤è€…ï¼Œæˆ‘ä»¬æ‘†è„±äº†å¤æ‚æ€§ï¼Œå¹¶å°†ç„¦ç‚¹è½¬ç§»åˆ°ä¸šåŠ¡é€»è¾‘ä¸Šã€‚è¯·æ³¨æ„ï¼Œæ›´å¥å£®çš„ lambda å°†åŒ…æ‹¬é”™è¯¯è·Ÿè¸ªå’Œå“åº”æ’ä»¶ã€‚

## [](#crafting-a-plugin)åˆ¶ä½œæ’ä»¶

è¯´åˆ°æ’ä»¶ï¼Œå¯èƒ½æ€§æ˜¯æ— ç©·æ— å°½çš„ï¼ä½ æœ‰ä»€ä¹ˆæƒ³æ³•å—ï¼Ÿ[æŠ•ç¨¿](https://github.com/juliantellez/lambcycle/blob/develop/contributing.md)æ›´æ¬¢è¿â¤ï¸

```
import * as Sentry from '@sentry/node';
import MyAwesomeIntegration from './MyAwesomeIntegration'

const sentryPlugin = (config) => {
    Sentry.init({
        dsn: `https://${config.key}@sentry.io/${config.project}`,
        integrations: [new MyAwesomeIntegration()]
    });

    return {
        config,
        plugin: {
            onPreResponse: async (handlerWrapper, config) => {
                Sentry.captureMessage('some percentile log perhaps?')
            },
            onError: async (handlerWrapper, config) => {
                Sentry.captureException(handlerWrapper.error);
            }
        }
    }
}

export default sentryPlugin; 
```

åœ¨ä½ çš„Î»é‡Œ....

```
import lambcycle from 'lambcycle'
import sentryPlugin from './sentryPlugin'

const myApplicationLogic = async (event, context) => {
    return await someLogic()
}

const handler = lambcycle(myApplicationLogic)
.register([
    sentryPlugin({
        key: process.env.SENTRY_KEY,
        project: process.env.SENTRY_PROJECT,
    })
]);

export default handler; 
```

# [](#dx)DX

Lambcycle åœ¨æ„å»ºæ—¶è€ƒè™‘åˆ°äº†[å¼€å‘è€…ä½“éªŒâ€œDXâ€](https://hackernoon.com/the-best-practices-for-a-great-developer-experience-dx-9036834382b0)ï¼Œå¹¶é™„å¸¦äº†[ç±»å‹](https://www.typescriptlang.org)å®šä¹‰ï¼Œä»¥å®ç°ä¸€è‡´æ€§å’Œè‡ªåŠ¨å®ŒæˆğŸš€(ä»…é™ VScode)ã€‚

[![](../Images/a661a64fc2ba4ebc49c01090f0631d9e.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--XfoDjVgF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://user-images.githubusercontent.com/4896851/51274743-db4db500-19c7-11e9-903c-cb50d127d933.gif) 
*Lambcycle DXã€‚*

# [](#conclusion)ç»“è®º

è¿™æ˜¯ä¸€ä¸ªå‹‡æ•¢çš„æ–°ä¸–ç•Œï¼Œæ— æœåŠ¡å™¨å°†æ°¸è¿œå­˜åœ¨ï¼ä¿ƒè¿›å¯é‡ç”¨ç»„ä»¶å’Œä¸€è‡´çš„é”™è¯¯å¤„ç†å°†å¸®åŠ©æ‚¨å’Œæ‚¨çš„å›¢é˜Ÿä»¥ä¸€ç§æ›´å¯æ§å’Œæ›´æœ‰ç»„ç»‡çš„æ–¹å¼åˆ›å»ºå’Œæ”¯æŒç‰¹æ€§ã€‚Lambcycle çš„ä¸»è¦ç›®æ ‡æ˜¯å›´ç»•å¯é¢„æµ‹çš„å•å‘å¾ªç¯è½¬ç§»è¯é¢˜ï¼Œå¹¶é¼“åŠ±è·¨ç‰¹æ€§çš„ç»„ä»¶å¯é‡ç”¨æ€§ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹äºæ›´å¤æ‚çš„åœºæ™¯ï¼Œä½ åº”è¯¥çœ‹çœ‹[é˜¶è·ƒå‡½æ•°](https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html)ã€‚å¦‚æœä½ æƒ³åœ¨è¯„è®ºä¸­äº†è§£æ›´å¤šï¼Œè¯·å‘Šè¯‰æˆ‘ï¼ŒåŒæ—¶æŸ¥çœ‹è¿™äº›[ç”¨ä¾‹](https://aws.amazon.com/step-functions/use-cases/)ï¼

ç‰¹åˆ«æ„Ÿè°¢ä¼ å¥‡[ç‡ƒåƒ§](https://theburningmonk.com/)å¯¹æœ¬æ–‡çš„æ·±åº¦ç‚¹è¯„ã€‚