# æ€§èƒ½æµ‹è¯•å¼¹æ€§ç ”ç©¶

> åŸæ–‡ï¼š<https://dev.to/molly/performance-testing-elasticsearch-2f7>

å½“æ‚¨æœ‰ä¸€ä¸ªå¤§å‹çš„ Elasticsearch é›†ç¾¤ï¼Œå¹¶ä¸”å¸Œæœ›å¯¹ç´¢å¼•è¿›è¡Œæ›´æ”¹æ—¶ï¼Œæ— è®ºæ˜¯å¯¹æ˜ å°„è¿˜æ˜¯è®¾ç½®ï¼Œæ‚¨éƒ½å¸Œæœ›ç¡®ä¿è¿™ç§æ›´æ”¹ä¼šæé«˜æ€§èƒ½ã€‚è¿™ç§æ”¹å˜ä¹Ÿå¯èƒ½å¾ˆéš¾å®ç°ï¼Œæ‰€ä»¥æ‚¨æƒ³çŸ¥é“æ€§èƒ½çš„æé«˜æ˜¯å¦å€¼å¾—æ‚¨èŠ±è´¹æ—¶é—´æ¥æ›´æ–°ä»£ç ã€‚

## æˆ‘ä»¬å°±åšç°åœºï¼

[![](img/e4e9674a904b35093c6361162082b63a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--AAdZ-ZRK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dq2l5qphws8dc2szxqoy.gif)

æˆ‘ä¸éª—ä½ ï¼Œåœ¨æ—©æœŸçš„è‚¯çº³ï¼Œå½“æˆ‘ä»¬å¾ˆå°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåœ¨æˆ‘ä»¬çš„ç”Ÿäº§é›†ç¾¤ä¸Šè¿›è¡Œæµ‹è¯•ã€‚ä½ è®¤ä¸ºæ–°çš„ç¢ç‰‡è®¾ç½®ä¼šæ›´å¥½å—ï¼Ÿå½“ç„¶ï¼Œè®©æˆ‘ä»¬é‡æ–°é…ç½®ä¸€åˆ‡ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ç”±äºä¼˜åŒ–å‡ºé”™ï¼Œæˆ‘ä»¬ä¸æ­¢ä¸€æ¬¡åœ°ä»¥æ·±å¤œæˆ˜æ–—å’Œæ•‘ç«å‘Šç»ˆã€‚è¿™æ˜¯ä¸€ä¸ªé™¡å³­çš„å­¦ä¹ æ›²çº¿ï¼Œä½†æœ€ç»ˆï¼Œæˆ‘ä»¬æ´»äº†ä¸‹æ¥ï¼

ç°åœ¨æˆ‘ä»¬æ›´å¤§äº†ï¼Œä¹Ÿæ›´èªæ˜äº†ğŸ˜‰ï¼Œæˆ‘ä»¬å·²ç»é€‰æ‹©æ›´è´Ÿè´£ä»»åœ°è¿›è¡Œè¿™äº›æ”¹å˜ï¼Œé¦–å…ˆå¯¹å®ƒä»¬è¿›è¡Œå…¨é¢æµ‹è¯•ï¼ğŸ‰

## æˆ‘ä»¬å¦‚ä½•æµ‹è¯•å¼¹æ€§æœç´¢çš„å˜åŒ–

### TLï¼›é€Ÿåº¦ä¸‰è§’å½¢å®šä½æ³•(dead reckoning)

æˆ‘ä»¬ç°åœ¨ä½¿ç”¨æˆ‘ä»¬ç¼–å†™çš„ Ruby [SearchTesting ç±»](https://gist.github.com/mstruve/ae0d317b6dfd2b08c801822c5df38144)æ¥æµ‹è¯• Elasticsearch çš„å˜åŒ–ã€‚è¿™ä¸ªç±»å…è®¸æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­åŒæ—¶å‘**ä¸¤ä¸ªä¸åŒçš„ç´¢å¼•å‘å‡ºè¯·æ±‚ã€‚**è¿™ä¸¤ä¸ªè¯·æ±‚éƒ½å°è£…åœ¨ç›‘æ§ä»£ç ä¸­ï¼Œå…è®¸æˆ‘ä»¬åœ¨ç›‘æ§æœåŠ¡ä¸­è·Ÿè¸ªå’ŒæŸ¥çœ‹å®ƒä»¬ã€‚é€šè¿‡è·Ÿè¸ªï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒè¯¸å¦‚è¯·æ±‚æ—¶é—´ä¹‹ç±»çš„ä¸œè¥¿ï¼Œçœ‹çœ‹å“ªä¸ªç´¢å¼•æ€§èƒ½æ›´å¥½ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç±»çš„ä¸€ä¸ªä¾‹å­ã€‚

### ä¼˜åŒ–:å°† id å­˜å‚¨ä¸ºå…³é”®å­—

åœ¨ Elasticsearch åŸ¹è®­ä¸­ï¼Œæˆ‘ä»¬ä¸€éåˆä¸€éåœ°è¢«å‘ŠçŸ¥ï¼Œå°† id å­˜å‚¨ä¸ºå…³é”®å­—å¯ä»¥æé«˜æœç´¢æ€§èƒ½ã€‚åŸå› æ˜¯å› ä¸º Elasticsearch ä¸­çš„æ•´æ•°æ•°æ®ç±»å‹é’ˆå¯¹èŒƒå›´æŸ¥è¯¢è¿›è¡Œäº†ä¼˜åŒ–ã€‚å…³é”®å­—é’ˆå¯¹æœ¯è¯­æŸ¥è¯¢è¿›è¡Œäº†ä¼˜åŒ–ã€‚ä¸€ä¸ªæœ¯è¯­æŸ¥è¯¢çœ‹èµ·æ¥åƒè¿™æ ·:

```
{  "terms":  {  "id":  [1,  5,  9]  }  } 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœæ‚¨åªä½¿ç”¨æ‚¨çš„ id æ‰§è¡Œæœ¯è¯­æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å°†å®ƒä»¬å­˜å‚¨ä¸ºå…³é”®å­—ã€‚è¿™å¬èµ·æ¥åƒæ˜¯ä¸€ä¸ªå¯é çš„å»ºè®®ï¼Œä½†æ›´æ–°æˆ‘ä»¬çš„æ˜ å°„å’Œé‡æ–°ç´¢å¼•æˆ‘ä»¬æ‰€æœ‰çš„ 30 äº¿ä¸ªæ–‡æ¡£éœ€è¦ä¸€äº›å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³ç¡®ä¿åœ¨æˆ‘ä»¬åšå‡ºä»»ä½•æ”¹å˜ä¹‹å‰ï¼Œæˆ‘ä»¬çœŸçš„ä¼šçœ‹åˆ°ä¸€äº›å¥½å¤„ã€‚

## æµ‹è¯•è®¾ç½®

åœ¨æˆ‘ä»¬å¼€å§‹æµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå¿…é¡»ä¸ºæˆ‘ä»¬çš„ç”Ÿäº§ç´¢å¼•åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ç´¢å¼•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ªæ–°çš„æµ‹è¯•ç´¢å¼•å°†æ‰€æœ‰çš„ id å­˜å‚¨ä¸ºå…³é”®å­—ã€‚æˆ‘ä»¬å°†ç”Ÿäº§ç´¢å¼•ä¸­çš„æ‰€æœ‰æ•°æ®é‡æ–°ç´¢å¼•(å¤åˆ¶)åˆ°æ–°çš„æµ‹è¯•ç´¢å¼•ä¸­ï¼Œå› æ­¤å®ƒä»¬éƒ½åŒ…å«å®Œå…¨ç›¸åŒçš„æ•°æ®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ Redis ä¸­æ”¾å…¥ä¸€ä¸ª hash æ¥é€šçŸ¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæˆ‘ä»¬å°†æµ‹è¯•è¿™ä¸ªç´¢å¼•ã€‚å½“æˆ‘ä»¬çš„æœç´¢æµ‹è¯•ç±»å‘å‡ºä¸€ä¸ª Elasticsearch è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥ Redisï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦æ­£åœ¨å¯¹æ‰€è¯·æ±‚çš„ç´¢å¼•è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœæ˜¯ï¼Œå®ƒå°†ä¸ä»…å‘åŸå§‹ç´¢å¼•å‘é€è¯·æ±‚ï¼Œè¿˜å‘æµ‹è¯•ç´¢å¼•å‘é€è¯·æ±‚ã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ç›´æ¥ç”¨ SearchTesting ç±»åˆ›å»ºäº†è¿™ä¸ªæ•£åˆ—ã€‚

```
def self.set_test_index(original_index_name, test_index_name)
  index_hashes = cache_index_hashes
  index_hashes[original_index_name] = {
    :index_name => test_index_name,
    :test_searching => true,
    :test_indexing => true
  }
  update_index_cache(index_hashes)
end 
```

Enter fullscreen mode Exit fullscreen mode

åœ¨ Redis:
ä¸­ï¼Œäº§ç”Ÿçš„æ•£åˆ—å¦‚ä¸‹æ‰€ç¤º

```
{
  "test_indexes" => {
    "prod_index" => {
      "index_name" => "test_index",
      "test_searching" => true,
      "test_indexing" => true
    }
  }
} 
```

Enter fullscreen mode Exit fullscreen mode

ä¸€æ—¦æ•£åˆ—åˆ°ä½ï¼Œæµ‹è¯•å°±å¼€å§‹äº†ï¼æˆ‘ä»¬æƒ³ç”¨ SearchTesting ç±»æµ‹è¯•ä¸¤ä»¶äº‹ï¼Œæœç´¢é€Ÿåº¦å’Œç´¢å¼•é€Ÿåº¦ã€‚

## æµ‹è¯•æœç´¢é€Ÿåº¦

å½“æˆ‘ä»¬å¼•å…¥è¿™ä¸ªæ–°çš„æœç´¢æµ‹è¯•ç±»æ—¶ï¼Œæˆ‘ä»¬ä»¥è¿™æ ·ä¸€ç§æ–¹å¼å®ç°å®ƒï¼Œå³æˆ‘ä»¬å‘ Elasticsearch å‘å‡ºçš„æ¯ä¸ªè¯·æ±‚éƒ½è¦ç»è¿‡ itâ€¨.

```
@connection.send(m, *args, &block)
# was replaced with
SearchTesting.new(@connection).send(m, *args, &block) 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œæœ‰ä¸€ä¸ªæ¥è‡ªæˆ‘ä»¬çš„ [elasticsearch-ruby](https://github.com/elastic/elasticsearch-ruby) gem çš„è¿æ¥å¯¹è±¡ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä¸ elasticsearch å¯¹è¯ã€‚æˆ‘ä»¬å°†å®ƒä¼ é€’ç»™æˆ‘ä»¬çš„ SearchTesting ç±»ï¼Œç„¶åå®ƒå®šä¹‰æˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„æ–¹æ³•ã€‚ä»»ä½•æœªå®šä¹‰çš„æ–¹æ³•éƒ½å¯ä»¥ä¸å—å¹²æ‰°åœ°ç›´æ¥è¿›å…¥ Elasticsearchã€‚

```
def method_missing(m, *args, &block)
  connection.send(m, *args, &block)
end 
```

Enter fullscreen mode Exit fullscreen mode

å› ä¸ºæˆ‘ä»¬æƒ³æµ‹è¯•æœç´¢æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™æ ·å®šä¹‰å®ƒ:

```
def search(*args)
  self.index_name = args&.first&.dig(:index)
  test_hash = cache_index_hashes.dig(index_name)

  test_search_thread = (Thread.new { test_search(*args.deep_dup, test_hash) } if test_searching_enabled?(test_hash))

  connection.search(*args)
end 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œå‘ç”Ÿçš„ä¸€äº›äº‹æƒ…æˆ‘æƒ³æ”¾å¤§ä¸€ä¸‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¾—åˆ°æˆ‘ä»¬è¯·æ±‚çš„ç´¢å¼•çš„åç§°ã€‚ç„¶åï¼Œæˆ‘ä»¬æ£€æŸ¥è¯¥ç´¢å¼•æ˜¯å¦è¢«æµ‹è¯•ã€‚

```
self.index_name = args&.first&.dig(:index)
test_hash = cache_index_hashes.dig(index_name) 
```

Enter fullscreen mode Exit fullscreen mode

å¦‚æœ Redis ä¸­å­˜åœ¨ä¸€ä¸ªæµ‹è¯•æ•£åˆ—ï¼Œå¹¶ä¸”ä¸ºè¯¥æµ‹è¯•æ•£åˆ—å¯ç”¨äº†æœç´¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥è¿è¡Œæµ‹è¯•è¯·æ±‚ã€‚

```
test_search_thread = (Thread.new { test_search(*args.deep_dup, test_hash) } if test_searching_enabled?(test_hash)) 
```

Enter fullscreen mode Exit fullscreen mode

é‚£ä¸ªæ–¹æ³•éå¸¸ç®€å•ã€‚å®ƒæ‰€åšçš„åªæ˜¯ç”¨æµ‹è¯•ç´¢å¼•åæ›¿æ¢åŸå§‹ç´¢å¼•åï¼Œç„¶åå¯¹æµ‹è¯•ç´¢å¼•æ‰§è¡Œè¯·æ±‚ã€‚

```
def test_search(*args, test_hash)
  test_index_name = test_hash[:index_name] # fetch test index name
  args.first[:index] = test_index_name # replace original index name with test
  connection.search(*args) # execute request against the test index
end 
```

Enter fullscreen mode Exit fullscreen mode

ç”±äº`test_search`æ–¹æ³•è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒç­‰å¾…å®ƒå®Œæˆã€‚ä¸€æ—¦æˆ‘ä»¬å¯åŠ¨äº† test_index è¯·æ±‚ï¼Œæˆ‘ä»¬å°±å‘åŸå§‹ç´¢å¼•å‘å‡ºè¯·æ±‚å¹¶è¿”å›è¿™äº›ç»“æœï¼

ç°åœ¨ï¼Œæœç´¢åªæ˜¯ç”»é¢çš„ä¸€åŠã€‚æˆ‘ä»¬è¿˜æƒ³ç¡®ä¿ç´¢å¼•ä»ç„¶æœ‰æ•ˆã€‚

## æµ‹è¯•åˆ†åº¦é€Ÿåº¦

ä¸ºäº†æµ‹è¯•ç´¢å¼•é€Ÿåº¦ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨æ‰¹é‡æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æœ‰çš„ç´¢å¼•éƒ½æ˜¯æ‰¹é‡å®Œæˆçš„ã€‚æˆ‘ä»¬é€šè¿‡åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥è¿è¡Œæµ‹è¯•ç´¢å¼•ï¼Œç±»ä¼¼äºæœç´¢ã€‚

```
def bulk(*args)
  test_bulk_thread = Thread.new { test_bulk(*args.deep_dup) }
  connection.bulk(*args)
end 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œæœ€éš¾çš„éƒ¨åˆ†æ˜¯ï¼Œæœ‰æ—¶ä¸åŒç´¢å¼•çš„æ•£åˆ—è¢«ç»„åˆåœ¨ä¸€èµ·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å•ç‹¬æ£€æŸ¥æ¯ä¸ªç´¢å¼•æ•£åˆ—ã€‚å¦‚æœæœ‰ä»»ä½•å“ˆå¸ŒæŒ‡å‘æ­£åœ¨æµ‹è¯•çš„ç”Ÿäº§ç´¢å¼•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šå°†è¿™äº›å“ˆå¸Œç´¢å¼•åˆ°æµ‹è¯•ç´¢å¼•ã€‚

```
def test_bulk(*args)
  new_bulk_hashes = test_bulk_hashes(*args) # select hashes to go to the test index
  return unless new_bulk_hashes.any? # if there are none return 
  connection.bulk({ :body => new_bulk_hashes }) # index hashes to the test index
end

def test_bulk_hashes(*args)
  @test_bulk_hashes ||= args.first[:body].map do |index_hash|
    index_name = test_index_name(index_hash.values.first[:_index])
    next unless index_name # if there is an index name, a test is running
    index_hash.values.first[:_index] = index_name # replace original index with test index
    index_hash # return new index hash to the map
  end.compact
end 
```

Enter fullscreen mode Exit fullscreen mode

ä¸æœç´¢ä¸€æ ·ï¼Œå› ä¸ºç´¢å¼•æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œä¸€æ—¦æˆ‘ä»¬å¼€å§‹å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­å°†æ–‡æ¡£ç´¢å¼•åˆ°åŸå§‹ç´¢å¼•å¹¶è¿”å›ç»“æœã€‚

## ä¸è¦ç€æ€¥

**å½“ä½ åœ¨ Elasticsearch ä¸­æµ‹è¯•æ€§èƒ½æŒ‡æ ‡æ—¶ï¼Œå…³é”®ä¹‹ä¸€æ˜¯ç»™æµ‹è¯•è¿è¡Œæ—¶é—´ã€‚** Elasticsearch ä¼šåœ¨ä½ æœç´¢æ—¶å»ºç«‹ç¼“å­˜ã€‚è¿™æ„å‘³ç€æ‚¨çš„åŸå§‹ç´¢å¼•(å·²ç»å»ºç«‹äº†ç¼“å­˜)å¯èƒ½ä¼šæ¯”æ‚¨çš„æ–°ç´¢å¼•æ›´å¿«ã€‚æ‚¨å¸Œæœ›è®©æµ‹è¯•è¿è¡Œè¶³å¤Ÿé•¿çš„æ—¶é—´æ¥æ„å»ºç›¸åŒçš„ç¼“å­˜ï¼Œå› æ­¤è¯¥æµ‹è¯•æ˜¯çœŸæ­£çš„ä¸€å¯¹ä¸€æµ‹è¯•ã€‚æˆ‘ä»¬é€šå¸¸è®©æˆ‘ä»¬çš„æµ‹è¯•è¿è¡Œè‡³å°‘å‡ å¤©ã€‚è¿™ä¸ä»…å…è®¸ç´¢å¼•æœ‰æ—¶é—´å»ºç«‹ç¼“å­˜ï¼Œè¿˜å…è®¸è¿›è¡Œå„ç§å„æ ·çš„æœç´¢å’Œç´¢å¼•è¯·æ±‚ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨è¿™ä¸ªæœç´¢ç±»æ¥æµ‹è¯•å°† id æ›´æ”¹ä¸ºå…³é”®å­—å’Œç¢ç‰‡è®¡æ•°çš„å˜åŒ–ã€‚å°† id æ”¹ä¸ºå…³é”®å­—ä½¿æˆ‘ä»¬çš„æœç´¢é€Ÿåº¦æé«˜äº† 30%,è€Œç´¢å¼•é€Ÿåº¦æ²¡æœ‰å˜åŒ–ã€‚å‡å°‘ç¢ç‰‡æ•°é‡ä¼šå…¨é¢æŸå®³æˆ‘ä»¬çš„æ€§èƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰åœ¨ä»£ç åº“ä¸­è¿›è¡Œè¿™ç§æ”¹å˜ã€‚

æˆ‘æƒ³åˆ†äº«è¿™æ®µä»£ç ï¼Œå¸Œæœ›å…¶ä»–äººå¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»åœ¨ Ruby ä¸­è®¾ç½®ä»–ä»¬è‡ªå·±çš„ Elasticsearch æµ‹è¯•ï¼å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–è€…æˆ‘æ²¡æœ‰è§£é‡Šæ¸…æ¥šï¼Œè¯·ä¸è¦çŠ¹è±«åœ°é—®ï¼