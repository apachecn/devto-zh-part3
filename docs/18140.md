# ç¬¬ 010 é›†-å¼‚æ­¥æ‰€æœ‰çš„äº‹æƒ…-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£

> åŸæ–‡:[https://dev.to/joaofbantunes/episode-010-async-all-the-things-aspnet-core-from-0 to-over kill-4p cn](https://dev.to/joaofbantunes/episode-010---async-all-the-things---aspnet-core-from-0-to-overkill-4pcn)

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ async å†…æ ¸ä¸­ä½¿ç”¨ async awaitï¼Œä¸ºä»€ä¹ˆå®ƒå¾ˆé‡è¦ï¼Œå¿«ä¹çš„é“è·¯å’Œä¸€äº›æ‚²ä¼¤çš„é“è·¯ï¼Œä»¥åŠä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ¥ä¸‹æ¥çš„å‡ ä¸ªè§†é¢‘ï¼Œä½†æ˜¯å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

ä¸»è§†é¢‘:
[https://www.youtube.com/embed/CGi1bQgaqwg](https://www.youtube.com/embed/CGi1bQgaqwg)

åæ¥åŠ äº†ä¸€ä¸ªç®€çŸ­çš„è¡¥é—:
[https://www.youtube.com/embed/bWyB0VFKeKA](https://www.youtube.com/embed/bWyB0VFKeKA)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

è®©æˆ‘ä»¬ä»¥ä¸åŒäºå…¶ä»–å¸–å­çš„æ–¹å¼å¼€å§‹è¿™ç¯‡å¸–å­ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥å»åš async/await ä¹‹ç±»çš„äº‹æƒ…å‘¢ï¼Ÿ
å½“æˆ‘ä»¬ä¸å†ä¸ºè¿™äº›`async`ã€`await`ã€`Task`ç­‰ç­‰çƒ¦æ¼æ—¶ï¼Œç”Ÿæ´»å˜å¾—æ›´åŠ è½»æ¾ğŸ˜›

ä» web åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œæ‰€æœ‰è¿™äº›å¯¹äºæé«˜å¯ä¼¸ç¼©æ€§éƒ½å¾ˆé‡è¦ï¼Œå› ä¸ºä¸ä¼šæ— ç¼˜æ— æ•…åœ°é˜»å¡å¤§é‡èµ„æº(çº¿ç¨‹)(å…¶ä»–ç±»å‹çš„åº”ç”¨ç¨‹åºå¯èƒ½æœ‰ä¸åŒçš„åŸå› ï¼Œæ¯”å¦‚æ¡Œé¢åº”ç”¨ç¨‹åºä¸ä¼šé˜»å¡ UI çº¿ç¨‹)ã€‚

ç”šè‡³åœ¨å¼•å…¥å¸¦æœ‰ TPL ( [ä»»åŠ¡å¹¶è¡Œåº“](https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/task-parallel-library-tpl%5D))çš„`Task`ä»¥åŠéšåå‡ºç°çš„ TAP ( [åŸºäºä»»åŠ¡çš„å¼‚æ­¥æ¨¡å¼](https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap))ä¹‹å‰ï¼Œå°±æœ‰å…¶ä»–æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œå³ä½¿ç”¨ APM ( [å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹](https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/asynchronous-programming-model-apm?view=netframework-4.7.2))ï¼Œä½†æ˜¯åšèµ·æ¥å¹¶ä¸é‚£ä¹ˆç®€å•ã€‚å°±åƒ JS æœ€è¿‘å¼•å…¥ async/await æ¥ç®€åŒ– promises çš„ç”¨æ³•ä¸€æ ·ã€‚NET ä¸ä¹…å‰ä¹Ÿåšäº†åŒæ ·çš„äº‹æƒ…ã€‚

æˆ‘å°†åœ¨è¿™é‡Œæ”¾å‡ å¼ å›¾ï¼Œä»å¾ˆé«˜çš„å±‚é¢æ¦‚è¿°éå¼‚æ­¥åœºæ™¯å’Œå¼‚æ­¥åœºæ™¯ä¸­çš„è¯·æ±‚å¤„ç†è¡Œä¸ºã€‚å¦‚æœä½ æƒ³å¯¹è¿™äº›å›¾è¡¨æœ‰æ›´å…¨é¢çš„è§£é‡Šï¼Œè¯·æŸ¥çœ‹æˆ‘åœ¨å¸–å­å¼€å¤´é“¾æ¥/åµŒå…¥çš„ç¬¬ä¸€ä¸ªè§†é¢‘ã€‚

**ä¸ä½¿ç”¨å¼‚æ­¥/ç­‰å¾…(æˆ–ç±»ä¼¼æ–¹æ³•)**

[![pre-async](../Images/9ae9cc808548dc4a13f52d1bc706afab.png)T2ã€‘](https://thepracticaldev.s3.amazonaws.com/i/0354pdhc87zj1eh7j8pv.jpg)

**ä½¿ç”¨å¼‚æ­¥/ç­‰å¾…(æˆ–ç±»ä¼¼æ–¹æ³•)**

[![async](../Images/6f4159cda080735f99a78e577ffb641a.png)T2ã€‘](https://thepracticaldev.s3.amazonaws.com/i/39q9nwf5xpxkamkre0vp.jpg)

æ€»ä¹‹ï¼Œåœ¨ async å†…æ ¸ä¸­ä½¿ç”¨ async/await å…è®¸æˆ‘ä»¬é€šè¿‡é‡Šæ”¾èµ„æºæ¥å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿›è¡Œæ•°æ®åº“è®¿é—®æˆ–å¤–éƒ¨æœåŠ¡è°ƒç”¨æ—¶ï¼Œç®€åŒ–æ›´å…·å¯ä¼¸ç¼©æ€§çš„ä»£ç çš„ç¼–å†™ï¼Œç‰¹åˆ«æ˜¯åœ¨ IO æ–¹é¢ã€‚

## [](#making-the-service-async)ä½¿æœåŠ¡å¼‚æ­¥

æ—¢ç„¶æˆ‘ä»¬å¯¹ä¸ºä»€ä¹ˆå…³å¿ƒè¿™äº›æœ‰äº†æ›´å¥½çš„ç†è§£(ä¸ç®¡æ€æ ·ï¼Œå¯èƒ½æ‚¨å·²ç»æœ‰äº†)ï¼Œè®©æˆ‘ä»¬å¼€å§‹å°†æˆ‘ä»¬ç°æœ‰çš„ä»£ç æ›´æ”¹ä¸ºå¼‚æ­¥çš„ï¼Œè¿™æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä¸ºç”¨å®é™…çš„æ•°æ®åº“æ›¿æ¢å†…å­˜ç»„â€œæŒä¹…æ€§â€åšå‡†å¤‡ã€‚

### [](#adapting-the-interface)é€‚é…ç•Œé¢

å›é¡¾ç»„æœåŠ¡çš„å½“å‰åŒæ­¥æ¥å£ï¼Œæˆ‘ä»¬æœ‰:

`IGroupsService.cs`

```
public interface IGroupsService
{
    IReadOnlyCollection<Group> GetAll();

    Group GetById(long id);

    Group Update(Group group);

    Group Add(Group group);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†æŠŠæ‰€æœ‰çš„æ–¹æ³•ç­¾åæ”¹ä¸ºå¼‚æ­¥ç­¾åï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å®ƒä»¬éƒ½æ‰§è¡Œ IOã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•ä¸éœ€è¦å¼‚æ­¥ï¼Œé‚£ä¹ˆå°±ä¸è¦ä½¿ç”¨å®ƒğŸ™‚

æ ¹æ®ç»éªŒï¼Œæ¯ä¸ªæ–¹æ³•éƒ½åº”è¯¥è¿”å›ä¸€ä¸ª`Task<T>`(æˆ–è€…å¦‚æœæ— æ•ˆçš„è¯è¿”å›ä¸€ä¸ª`Task`)ï¼Œå¹¶ä»¥`Async`ä½œä¸ºåç¼€(å°½ç®¡æœ‰äº›äººä¸å–œæ¬¢ä½¿ç”¨è¿™ä¸ªåç¼€)ã€‚

**æ³¨æ„:**è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨è¿™ç¯‡æ–‡ç« ä¸­è®¨è®º

*   æœ‰`async void`æ–¹æ³•ï¼Œä½†è¿™åœ¨å…¶ä»–ç±»å‹çš„åº”ç”¨ä¸­å¯èƒ½æœ‰ç”¨ï¼Œæ¯”å¦‚ WinForms æˆ– Xamarinï¼Œä½†åœ¨ ASP.NET æ ¸å¿ƒä¸­ä¸å¤ªæœ‰ç”¨ï¼Œ[åœ¨é‚£é‡Œå®ƒå¯èƒ½åªä¼šå¸¦æ¥é—®é¢˜](https://msdn.microsoft.com/en-us/magazine/jj991977.aspx)
*   è¿”å›`ValueTask<T>`(æˆ–`ValueTask`)è€Œä¸æ˜¯`Task`ï¼Œè¿™æ˜¯æœ€è¿‘å¢åŠ çš„åŠŸèƒ½ï¼Œå¯¹äºé«˜æ€§èƒ½éå¸¸é‡è¦çš„åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ï¼Œé¿å…åˆ†é…ä¼šå¸¦æ¥å¾ˆå¤§çš„ä¸åŒ

æ¥å£çš„å¼‚æ­¥ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤º:

`IGroupsService.cs`

```
public interface IGroupsService
{
    Task<IReadOnlyCollection<Group>> GetAllAsync();

    Task<Group> GetByIdAsync(long id);

    Task<Group> UpdateAsync(Group group);

    Task<Group> AddAsync(Group group);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ç„¶ï¼Œé€šè¿‡æ”¹å˜æ¥å£ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»æ”¹å˜è°ƒç”¨ä»£ç ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯åœ¨`GroupsController`ä¸­ã€‚æˆ‘ä»¬å°†åªçœ‹ä¸€ä¸‹(ä¹‹å‰å‘½åçš„)`Index`æ–¹æ³•ï¼Œå› ä¸ºå…¶ä»–æ–¹æ³•éµå¾ªç›¸åŒçš„æ–¹æ³•(ä½†æ˜¯ä½ å¯ä»¥åœ¨ [GitHub](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode010) ä¸ŠæŸ¥çœ‹æ‰€æœ‰ä»£ç )ã€‚

`GroupsController.cs`

```
public class GroupsController : Controller
{
    private readonly IGroupsService _groupsService;

    public GroupsController(IGroupsService groupsService)
    {
        _groupsService = groupsService;
    }

    [HttpGet]
    [Route("")]
    public async Task<IActionResult> IndexAsync()
    {
        var result = await _groupsService.GetAllAsync();
        return View("Index", result.ToViewModel());
    }

    //...

} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› æ­¤ï¼Œè€ƒè™‘åˆ°æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡çš„å†…å®¹ï¼Œ`Index`å˜æˆäº†`IndexAsync`ï¼Œå°½ç®¡åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘è®¤ä¸ºå°†å®ƒç•™åœ¨`Index`å¯èƒ½æ˜¯ä¸€ä¸ªç®€åŒ–ä¸€äº›äº‹æƒ…çš„å¥½é€‰æ‹©ï¼Œå› ä¸ºè¿™è¿«ä½¿è§†å›¾åç§°(æ˜ å°„åˆ°`Index.cshtml`)åœ¨è°ƒç”¨`View`æ–¹æ³•æ—¶ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ te åŠ¨ä½œå’Œè§†å›¾åº”è¯¥å…·æœ‰ç›¸åŒçš„åç§°(è¿™å¯èƒ½ä¼šåœ¨[ASP.NET æ ¸å¿ƒ 3.0](https://github.com/aspnet/Mvc/issues/6723) ä¸­æ”¹å˜)ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæ–¹æ³•ç­¾åç°åœ¨æœ‰äº†ä¸€ä¸ª`async`ä¿®é¥°ç¬¦ï¼Œè¡¨ç¤ºå®ç°ä¸­å°†æœ‰ä¸€ä¸ª`await`ï¼Œè¿”å›ç±»å‹ç°åœ¨æ˜¯`Task<IActionResult>`ã€‚

åœ¨æ–¹æ³•å®ç°ä¸­ï¼Œç°åœ¨å½“è°ƒç”¨`_groupsService.GetAllAsync()`æ—¶ï¼Œæˆ‘ä»¬`await`å®ƒçš„ç»“æœã€‚

### [](#implementing-the-service)å®ç°æœåŠ¡

éšç€æ¥å£å’Œå®¢æˆ·ç«¯ä»£ç çš„æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æˆ‘ä»¬çš„`InMemoryGroupsService`ã€‚å› ä¸ºæˆ‘ä»¬å®é™…ä¸Šæ²¡æœ‰å¼‚æ­¥çš„äº‹æƒ…è¦åšï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¿›å…¥æ•°æ®åº“ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†ç»„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥æœåŠ¡çš„å®ç°å°†ä¼ªé€ å¼‚æ­¥éƒ¨åˆ†ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œå½“æˆ‘ä»¬å°†å®ä½“æ¡†æ¶æ ¸å¿ƒæ·»åŠ åˆ°ç»„åˆä¸­æ—¶ï¼Œæˆ‘ä»¬å°†å†æ¬¡è°ƒæ•´æœåŠ¡ã€‚

è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹éå¼‚æ­¥ç‰ˆæœ¬:

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    private readonly List<Group> _groups = new List<Group>();
    private long _currentId = 0;

    public IReadOnlyCollection<Group> GetAll()
    {
        return _groups.AsReadOnly();
    }

    public Group GetById(long id)
    {
        return _groups.SingleOrDefault(g => g.Id == id);
    }

    public Group Update(Group group)
    {
        var toUpdate = _groups.SingleOrDefault(g => g.Id == group.Id);

        if (toUpdate == null)
        {
            return null;
        }

        toUpdate.Name = group.Name;
        return toUpdate;
    }

    public Group Add(Group group)
    {
        group.Id = ++_currentId;
        _groups.Add(group);
        return group;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†å®ƒç§»åˆ°(å‡çš„)å¼‚æ­¥ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ‰€åšçš„å°±æ˜¯æ”¹å˜æ‰€æœ‰æ–¹æ³•çš„ç­¾åï¼Œä»¥åŒ¹é…æ¥å£ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ç»“æœï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨`Task.FromResult`æ–¹æ³•å°†å®ƒåŒ…è£…åœ¨ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡ä¸­ã€‚

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    private static readonly Random RandomGenerator = new Random();
    private readonly List<Group> _groups = new List<Group>();
    private long _currentId = 0;

    public Task<IReadOnlyCollection<Group>> GetAllAsync(CancellationToken ct)
    {
        return Task.FromResult<IReadOnlyCollection<Group>>(_groups.AsReadOnly());
    }

    public Task<Group> GetByIdAsync(long id, CancellationToken ct)
    {
        return Task.FromResult(_groups.SingleOrDefault(g => g.Id == id));
    }

    public Task<Group> UpdateAsync(Group group, CancellationToken ct)
    {
        var toUpdate = _groups.SingleOrDefault(g => g.Id == group.Id);

        if (toUpdate == null)
        {
            return Task.FromResult(null);
        }

        toUpdate.Name = group.Name;
        return Task.FromResult(toUpdate);
    }

    public Task<Group> AddAsync(Group group, CancellationToken ct)
    {
        group.Id = ++_currentId;
        _groups.Add(group);
        return Task.FromResult(group);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“å®ç°ä¸€ä¸ªå¼‚æ­¥æ¥å£ï¼Œä½†å…¶ä¸­æ²¡æœ‰å¼‚æ­¥è¦åšçš„äº‹æƒ…æ—¶ï¼Œ`Task.FromResult`æ˜¯è¿”å›`Task<T>`çš„æ–¹æ³•ï¼Œ`Task.CompletedTask`æ˜¯è¿”å›`Task`çš„æ–¹æ³•ã€‚

### [](#no-need-for-taskrun)æ— éœ€ä»»åŠ¡ã€‚å¥”è·‘

çœ‹ç€ä¸Šé¢çš„`InMemoryGroupsService`å®ç°ï¼Œæœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸åƒä¸‹é¢è¿™æ ·åšå‘¢:

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    //...

    public async Task<IReadOnlyCollection<Group>> GetAllAsync(CancellationToken ct)
    {
        return await Task.Run(() => _groups.AsReadOnly());
    }

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¹Ÿå®ç°äº†å¼‚æ­¥æ¥å£ï¼Œä½†ä¸æ˜¯è¿”å›å·²å®Œæˆçš„ä»»åŠ¡ï¼Œè€Œæ˜¯è¦æ±‚çº¿ç¨‹æ± è¿è¡Œä¼ é€’ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„`Task.Run`çš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬ç­‰å¾…å®ƒçš„ç»“æœã€‚å—¯ï¼Œæˆ‘ä¼šè¯´è¿™åªæ˜¯åœ¨æµªè´¹èµ„æºï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå®ƒåªæ˜¯ä¸ºäº†è®©å®ƒå¼‚æ­¥æ˜¯æµªè´¹çš„ã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¸å¤ªæ˜æ˜¾çš„åœºæ™¯ã€‚å‡è®¾æˆ‘ä»¬å·²ç»åœ¨è¿›è¡Œæ•°æ®åº“è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æä¾›è€…ç”±äºæŸç§åŸå› ä¸æ”¯æŒå¼‚æ­¥ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·åš:

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    //...

    public async Task<IReadOnlyCollection<Group>> GetAllAsync(CancellationToken ct)
    {
        return await Task.Run(() => GetAllUsingSyncDbProvider());
    }

    private IReadOnlyCollection<Group> GetAllUsingSyncDbProvider()
    {
        //...
    }

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¹ä¸€çœ‹ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œæˆ‘ä»¬é€šè¿‡è®©å®ƒåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œä½¿åŒæ­¥æ•°æ®åº“è®¿é—®æˆä¸ºå¼‚æ­¥çš„ã€‚æˆ‘è®¤ä¸ºï¼Œè¿™åˆæ˜¯æµªè´¹èµ„æºã€‚æˆ‘ä»¬è¦æ±‚å¦ä¸€ä¸ªçº¿ç¨‹é˜»å¡ï¼Œè€Œä¸æ˜¯é˜»å¡å¤„ç†è¯·æ±‚çš„çº¿ç¨‹ã€‚é˜»å¡ä»æ¥éƒ½ä¸æ˜¯å¥½äº‹ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰å…¶ä»–æ–¹æ³•ï¼Œæˆ‘ä¼šè¯´åœ¨è¯·æ±‚å¤„ç†çº¿ç¨‹ä¸­åšå°±å¥½äº†ï¼Œä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚

`Task.Run`åº”è¯¥ç”¨æ¥åš CPU ç»‘å®šçš„å·¥ä½œï¼Œæœ€ç»ˆå¹¶è¡Œåšä¸€äº›äº‹æƒ…ã€‚è¯·è®°ä½ï¼Œæˆ‘åœ¨è¿™é‡Œè°ˆè®ºçš„æ˜¯ ASP.NET æ ¸å¿ƒï¼Œä¾‹å¦‚åœ¨æ¡Œé¢å’Œ Xamarin åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿ç”¨`Task.Run`æ¥ç¡®ä¿ UI çº¿ç¨‹ä¸è¢«é˜»å¡å¯èƒ½å¾ˆé‡è¦(å³ä½¿æ˜¯åœ¨å¼‚æ­¥æ–¹æ³•ä¸Šï¼Œå› ä¸ºå³ä½¿æ˜¯å¼‚æ­¥æ–¹æ³•ä¹Ÿå¯èƒ½æœ‰åŒæ­¥è¿è¡Œçš„éƒ¨åˆ†)ã€‚

å¦‚æœæˆ‘åœ¨è¿™ä¸€ç‚¹ä¸Šå¼„é”™äº†ï¼Œå¹¶ä¸”ä½ è§‰å¾—åœ¨æˆ‘é—æ¼çš„è¿™äº›åœºæ™¯ä¸­ä½¿ç”¨`Task.Run`æœ‰ä¼˜åŠ¿ï¼Œè¯·è”ç³»æˆ‘ï¼Œæˆ‘å¾ˆæ„Ÿæ¿€ğŸ™‚

ä½ å¯ä»¥ç‚¹å‡»æŸ¥çœ‹æ›´å¤šå…³äº`Task.Run` [çš„ä¿¡æ¯ã€‚](https://blog.stephencleary.com/2013/11/taskrun-etiquette-examples-dont-use.html)

PS: `Task.Run`ä¹Ÿå¯ä»¥ç”¨æ¥åšä¸€äº›åŒæ­¥ä¸Šä¸‹æ–‡çš„æ¶ä½œå‰§ï¼Œä½†è¿™åœ¨ ASP.NET æ ¸å¿ƒä¸­å¹¶ä¸çœŸæ­£æœ‰ç”¨(é™¤æ­¤ä¹‹å¤–ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªé»‘å®¢)ã€‚

### [](#using-cancellation-tokens)ä½¿ç”¨æ³¨é”€ä»¤ç‰Œ

æ‚¨å¯ä»¥æ·»åŠ åˆ°æˆ‘ä»¬çš„å¼‚æ­¥æ–¹æ³•ä¸­çš„ä¸€ä»¶å¥½äº‹æ˜¯å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ“ä½œçš„å¯èƒ½æ€§ã€‚è¿™æ˜¯ä½¿ç”¨`CancellationToken` s å®Œæˆçš„ã€‚

å–æ¶ˆæ ‡è®°åº”è¯¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¼‚æ­¥å‡½æ•°(æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ˜¯æœ€åä¸€ä¸ªå‚æ•°)ã€‚è¿™å°†ä½¿ç»„æœåŠ¡æ¥å£çœ‹èµ·æ¥åƒè¿™æ ·:

`IGroupsService.cs`

```
public interface IGroupsService
{
    Task<IReadOnlyCollection<Group>> GetAllAsync(CancellationToken ct);

    Task<Group> GetByIdAsync(long id, CancellationToken ct);

    Task<Group> UpdateAsync(Group group, CancellationToken ct);

    Task<Group> AddAsync(Group group, CancellationToken ct);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¼ é€’ç»™å¼‚æ­¥æ–¹æ³•è°ƒç”¨ã€‚å› ä¸ºå½“å‰çš„å®ç°ä¼ªé€ äº†å¼‚æ­¥éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘å°†æ·»åŠ ä¸€ä¸ªå»¶è¿Ÿæ¥ä¼ªé€ ä¸€ä¸ªä½¿ç”¨å–æ¶ˆä»¤ç‰Œçš„ IO æ“ä½œ(ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘åªåŒ…å«äº†ä¸€ä¸ªæ–¹æ³•ä½œä¸ºç¤ºä¾‹)ã€‚

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    //...

    public async Task<IReadOnlyCollection<Group>> GetAllAsync(CancellationToken ct)
    {
        await Task.Delay(5000, ct);
        return _groups.AsReadOnly();
    }

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†è¿™ä¸ªï¼Œå¦‚æœåœ¨è¿™ 5 ç§’å†…è¯·æ±‚è¢«å–æ¶ˆï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ª`OperationCancelledException`ï¼Œåœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç ã€‚å¯¼è‡´è¯¥å¼‚å¸¸çš„å¦ä¸€ç§æ–¹æ³•æ˜¯è°ƒç”¨`ct.ThrowIfCancellationRequested()`ã€‚å¦‚æœæˆ‘ä»¬åœ¨ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œåœºæ™¯ä¸­ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³è¦æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦åº”è¯¥ç»§ç»­ï¼Œè¿™æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†å‡†å¤‡è¢«å–æ¶ˆçš„ä»£ç ï¼Œå®ƒæ˜¯å¦‚ä½•å‘ç”Ÿçš„å‘¢ï¼Ÿåœ¨ ASP.NET æ ¸å¿ƒä¸­ï¼Œå¾ˆå®¹æ˜“å¾ˆå¥½åœ°åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å™¨ä¸Šæ·»åŠ ä¸€ä¸ªå–æ¶ˆä»¤ç‰Œåˆ°åŠ¨ä½œæ–¹æ³•ä¸­ï¼Œæ¡†æ¶ä¼šå°†å®ƒä¼ å…¥ã€‚

`GroupsController.cs`

```
public class GroupsController : Controller
{
    private readonly IGroupsService _groupsService;

    public GroupsController(IGroupsService groupsService)
    {
        _groupsService = groupsService;
    }

    [HttpGet]
    [Route("")]
    public async Task<IActionResult> IndexAsync(CancellationToken ct)
    {
        var result = await _groupsService.GetAllAsync(ct);
        return View("Index", result.ToViewModel());
    }

    //...

} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°æµè§ˆå™¨ï¼Œæå‡ºä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶åœ¨å®ƒå®Œæˆä¹‹å‰ç‚¹å‡»å–æ¶ˆæŒ‰é’®ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æŠ›å‡ºçš„å¼‚å¸¸ã€‚å½“ç„¶ï¼Œæœ‰äº›äº‹æƒ…å¯èƒ½ä¸ä¼šè¢«å–æ¶ˆï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„æ“ä½œå®Œæˆäº†ï¼Œä¹Ÿè®¸ä¸åº”è¯¥çªç„¶åœæ­¢ï¼Œä½†æ˜¯åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œè¿™ç§æ¨¡å¼å·¥ä½œå¾—å¾ˆå¥½(å³ä½¿æ€»æ˜¯ä¼ é€’`CancellationToken`å‚æ•°å¯èƒ½æœ‰ç‚¹çƒ¦äºº)ã€‚

## [](#calling-it-synchronously-but-dont)åŒæ­¥è°ƒç”¨å®ƒ(ä½†ä¸è¦)

æˆ‘ä»¬åº”è¯¥å°½å¯èƒ½åœ°é¿å…åŒæ­¥è°ƒç”¨å¼‚æ­¥æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“æœ‰æ—¶å€™ï¼Œç”±äºä¸€äº›å¥‡æ€ªçš„åŸå› ï¼Œæˆ‘ä»¬å°±æ˜¯ä¸èƒ½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è‡³å°‘å¯ä»¥å°½åŠ›æ‘†è„±å›°å¢ƒã€‚

åŒæ­¥è·å¾—`Task<T>`ç»“æœçš„é€šå¸¸æ–¹å¼æ˜¯é€šè¿‡è®¿é—®`Result`å±æ€§ã€‚å…³äºè¿™ä¸€ç‚¹çš„ä¸€ä»¶äº‹æ˜¯ï¼Œå¦‚æœä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿäº†ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¸æ˜¯é¢„æœŸçš„å¼‚å¸¸ï¼Œè€Œæ˜¯ä¸€ä¸ª`AggregateException`ï¼Œå®ƒåŒ…è£…äº†å¼‚æ­¥æ–¹æ³•ä¸­æŠ›å‡ºçš„ä»»ä½•å¼‚å¸¸ã€‚å½“æˆ‘ä»¬ç­‰å¾…ä»»åŠ¡æ—¶ï¼Œè¿™ä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºå®ƒæ‰“å¼€äº†å¼‚å¸¸ã€‚é™¤äº†`Result`ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åš`DoSomethingAsync().GetAwaiter().GetResult()`ï¼Œå› ä¸ºè¿™å°†å¤„ç†å¼‚å¸¸çš„è§£åŒ…ã€‚è¿™å¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬é˜»å¡çº¿ç¨‹ç­‰å¾…ç»“æœçš„é—®é¢˜ï¼Œä¹Ÿä¸èƒ½è§£å†³æˆ‘ä»¬åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šæ­»é”çš„é—®é¢˜(ä¾‹å¦‚åœ¨ ASP.NET é¢„æ ¸ä¸­)ï¼Œä½†è‡³å°‘æˆ‘ä»¬å¾—åˆ°äº†æ­£ç¡®çš„å¼‚å¸¸ã€‚

## configurewait(å‡)

ç»§ç»­è¿™ä¸ªä¸»é¢˜(ä½†ä¸æ˜¯å”¯ä¸€çš„)ï¼Œä¸ºä»€ä¹ˆåœ¨å¼‚æ­¥æ–¹æ³•ä¸Šé˜»å¡ä¼šå¯¼è‡´æ­»é”(åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½†ä¸æ˜¯åœ¨ ASP.NET æ ¸å¿ƒä¸­)çš„åŸå› æ˜¯æœ‰ä¸€ä¸ª`SynchronizationContext`è¢«é˜»å¡çš„çº¿ç¨‹æŒæœ‰ï¼Œå½“å¼‚æ­¥æ–¹æ³•å®Œæˆæ—¶ï¼Œè¯•å›¾è·å¾—è¯¥ä¸Šä¸‹æ–‡ä½†ä¸èƒ½ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰å®ƒã€‚

è¿™ä¸ªä¸Šä¸‹æ–‡æ˜¯ç›¸å…³çš„ï¼Œä¾‹å¦‚ï¼Œåœ¨æ¡Œé¢å’Œ Xamarin åº”ç”¨ç¨‹åºä¸­ï¼Œå¼‚æ­¥å»¶ç»­åœ¨ UI çº¿ç¨‹ä¸Šè¿è¡Œä»¥åšå‡ºä¸€äº›å¯è§çš„æ”¹å˜æ˜¯å¾ˆé‡è¦çš„ã€‚å› ä¸º ASP.NET æ ¸å¿ƒæ²¡æœ‰è¿™äº›ç§ç±»çš„éœ€æ±‚ï¼Œ`SynchronizationContext`è¢«ä¸€èµ·ç§»é™¤äº†ã€‚

å³ä½¿çŸ¥é“è¿™åœ¨ ASP.NET æ ¸å¿ƒä¸­ä¸æ˜¯é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬å†™äº†ä¸€ä¸ªæˆ‘ä»¬æœ€ç»ˆæƒ³è¦å…±äº«çš„åº“ï¼Œæˆ‘ä»¬ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ ·çš„åº”ç”¨ç¨‹åºä¼šä½¿ç”¨å®ƒã€‚æ‰€ä»¥å½“å¼€å‘è¿™æ ·çš„åº“æ—¶ï¼Œå½“ä»£ç ä¸ä¾èµ–äºè¿™ä¸ªä¸Šä¸‹æ–‡æ—¶ï¼Œé€šå¸¸çš„åšæ³•æ˜¯åœ¨ç­‰å¾…ä»»åŠ¡æ—¶ä½¿ç”¨`ConfigureAwait(false)`ã€‚è¿™æ„å‘³ç€`await`ä¹‹åçš„ä»£ç ä¸éœ€è¦ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ä¸éœ€è¦å°è¯•å’Œè·å–ï¼Œè¿™æ„å‘³ç€è¡¨ç°ä¸ä½³çš„å®¢æˆ·ç«¯ä¸ä¼šå‡ºç°æ­»é”(å¯èƒ½è¿˜æœ‰å…¶ä»–å¥½å¤„ï¼Œæ¯”å¦‚å°çš„æ€§èƒ½æå‡ï¼Œåœ¨è¿™é‡Œé˜…è¯»æ›´å¤šä¿¡æ¯[)ã€‚](https://msdn.microsoft.com/en-us/magazine/jj991977.aspx)

## [](#returning-task-without-awaiting)ä¸ç­‰å¾…è¿”å›ä»»åŠ¡

å¦‚æœæ‚¨åœ¨ä¸­ä½¿ç”¨äº†å¼‚æ­¥/ç­‰å¾…ã€‚NET ä¸­ï¼Œä½ å¯èƒ½é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼Œä½ æœ‰ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªå¼‚æ­¥æ–¹æ³•ä¸­ï¼Œå®ƒå”¯ä¸€å¼‚æ­¥åšçš„äº‹æƒ…æ˜¯æœ€åä¸€è¡Œï¼Œé‚£ä¸€è¡Œçš„è¾“å‡ºå°±æ˜¯å®ƒå°†è¿”å›çš„å†…å®¹ã€‚å¤§æ¦‚æ˜¯:

```
public async Task<bool> CheckSomethingAsync()
{
    return await InnerCheckSomethingAsync();
}

private async Task<bool> InnerCheckSomethingAsync()
{
    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéš¾é“æˆ‘ä»¬ä¸èƒ½å¿½ç•¥ async/await éƒ¨åˆ†ï¼Œåªè¿”å›å¦ä¸€ä¸ªæ–¹æ³•çš„ç»“æœå—ï¼Ÿ

```
public Task<bool> CheckSomethingAsync()
{
    return InnerCheckSomethingAsync();
}

//... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å’Œå…¶ä»–è®¸å¤šæƒ…å†µä¸€æ ·ï¼Œè¿™è¦çœ‹æƒ…å†µã€‚åœ¨ç±»ä¼¼ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œè¿™å¯èƒ½æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»è®°ä½ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå †æ ˆè·Ÿè¸ªå°†ä¼šä¸åŒï¼Œå°±å¥½åƒæ ¹æœ¬æ²¡æœ‰è°ƒç”¨`CheckSomethingAsync`ã€‚è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªç¤ºä¾‹å †æ ˆè·Ÿè¸ªã€‚

å¸¦å¼‚æ­¥/ç­‰å¾…:

```
 at Program.<InnerCheckSomethingAsync>d__3.MoveNext() in d:\Windows\Temp\kw03shrz.0.cs:line 28
--- End of stack trace from previous location where exception was thrown ---
   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter`1.GetResult()
   at Program.<CheckSomethingAsync>d__0.MoveNext() in d:\Windows\Temp\kw03shrz.0.cs:line 22
--- End of stack trace from previous location where exception was thrown ---
   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter`1.GetResult()
   at Program.Main() in d:\Windows\Temp\kw03shrz.0.cs:line 12 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç«‹å³è¿”å›ä»»åŠ¡:

```
 at Program.<InnerCheckSomethingAsync>d__0.MoveNext() in d:\Windows\Temp\uh2ndf5e.0.cs:line 28
--- End of stack trace from previous location where exception was thrown ---
   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)
   at System.Runtime.CompilerServices.TaskAwaiter`1.GetResult()
   at Program.Main() in d:\Windows\Temp\uh2ndf5e.0.cs:line 12 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯å¦å¯ä»¥æ¥å—è¦çœ‹æƒ…å†µã€‚é€šè¿‡ç«‹å³è¿”å›ä»»åŠ¡ï¼Œæˆ‘ä»¬ä¸¢å¤±äº†ä¸€äº›ä¿¡æ¯ï¼Œä½†è·å¾—äº†ä¸€äº›æ€§èƒ½ï¼Œå› ä¸ºæˆ‘ä»¬ç»•è¿‡äº†åœ¨`CheckSomethingAsync`ä¸­åˆ›å»ºå¼‚æ­¥çŠ¶æ€æœºã€‚è§†æƒ…å†µè€Œå®šï¼Œä¸€ä¸ªå¯èƒ½æ¯”å¦ä¸€ä¸ªæ›´é‡è¦ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè‡³å°‘è¿˜æœ‰ä¸€äº›å…¶ä»–çš„äº‹æƒ…è¦å¤„ç†ã€‚å¦‚æœå¯¹`InnerCheckSomethingAsync`çš„è°ƒç”¨å®é™…ä¸Šæ˜¯åœ¨ä¸€ä¸ª try/catch æˆ– using å—ä¸­(ä¹Ÿè®¸è¿˜æœ‰å…¶ä»–æˆ‘ç°åœ¨ä¸è®°å¾—çš„å—)ï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹å³è¿”å›ï¼Œå› ä¸ºä¸€äº›ä»£ç å¯èƒ½åœ¨å—ä¸å†åœ¨ä½œç”¨åŸŸä¸­ä¹‹åè¿è¡Œã€‚

ä¸€ä¸ªä¾‹å­

```
public static Task<bool> CheckSomethingAsync()
{
    try 
    {
        return InnerCheckSomethingAsync();
    } 
    catch(Exception ex)
    {
        //act on exception
    }
}

private static async Task<bool> InnerCheckSomethingAsync()
{
    await Task.Delay(1000);
    throw new Exception("Sample error");
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼‚å¸¸ä¸ä¼šè¢«æ•è·ï¼Œå› ä¸º`CheckSomethingAsync`å·²ç»å°†`InnerCheckSomethingAsync`ä»»åŠ¡è¿”å›ç»™å®ƒçš„è°ƒç”¨è€…ã€‚

## [](#making-requests-in-parallel)å¹¶è¡Œå‘å‡ºè¯·æ±‚

### [](#how-to)å¦‚ä½•

async çš„æœ¬è´¨ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œåœ¨å‘å‡ºè¯·æ±‚æ—¶ä½¿ç”¨ async ä½¿å¾—å¹¶è¡ŒåŒ–å®ƒä»¬å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œè€Œä¸éœ€è¦å¼„ä¹±çº¿ç¨‹(è‡³å°‘æ˜¾å¼åœ°)ã€‚

è®©æˆ‘ä»¬ä»¥ä¸€ç§æ–¹æ³•`CallExternalServiceAsync`ä¸ºä¾‹ã€‚å‡è®¾æˆ‘ä»¬æƒ³å‘å®ƒå‘å‡ºå‡ ä¸ªä¸ç›¸å…³çš„è¯·æ±‚ï¼Œè€Œä¸æ˜¯ç«‹å³ç­‰å¾…å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•å¹¶å°†è¿”å›çš„`Task`å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œç¨åå†ç­‰å¾…å®ƒä»¬ï¼Œå…è®¸å®ƒä»¬å¹¶è¡Œè¿›è¡Œã€‚å¦‚æœæˆ‘ä»¬ç«‹å³ç­‰å¾…å®ƒä»¬ï¼Œè¯·æ±‚å°†è¢«åºåˆ—åŒ–ï¼Œè€Œä¸æ˜¯å¹¶è¡Œã€‚ç¤ºä¾‹ä»£ç :

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    private static readonly Random RandomGenerator = new Random();

    //...

    public async Task<Group> GetByIdAsync(long id, CancellationToken ct)
    {
        var extResult1Task = CallExternalServiceAsync(ct);
        var extResult2Task = CallExternalServiceAsync(ct);

        var result1 = await extResult1Task;
        var result2 = await extResult2Task;

        return _groups.SingleOrDefault(g => g.Id == id);
    }

    //...

    private async Task<int> CallExternalServiceAsync(int multiplier, CancellationToken ct)
    {
        await Task.Delay(1000);
        return RandomGenerator.Next();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é€šè¿‡ä»¥è¿™ç§æ–¹å¼æ‰§è¡Œâ€œè¯·æ±‚â€,è€Œä¸æ˜¯åƒæˆ‘ä»¬åš`await CallExternalServiceAsync(ct)`,åºåˆ—åŒ–ä»£ç æ‰§è¡Œé‚£æ ·éœ€è¦å¤§çº¦ 2 ç§’æ¥è¿è¡Œä»£ç ï¼Œå®ƒåªéœ€è¦å¤§çº¦ 1 ç§’ï¼Œå› ä¸ºä¸€æ—¦ä»£ç çš„åŒæ­¥éƒ¨åˆ†å…è®¸ï¼Œæˆ‘ä»¬å°±å¼€å§‹ä¸¤ä¸ªå¼‚æ­¥æ“ä½œã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ç›®æ ‡ä»£ç å…è®¸çš„æƒ…å†µä¸‹è¿™æ ·åšï¼Œä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨ç›¸åŒçš„æœåŠ¡ç±»å®ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¸¾å‡ ä¸ªä¾‹å­:

*   å½“ä½¿ç”¨ä¸€ä¸ª`HttpClient`æ¥å‘å‡ºè¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¯«æ— é—®é¢˜åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œåªè¦æˆ‘ä»¬åªä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•(åœ¨ç¼–å†™æ—¶:`DeleteAsync`ã€`GetAsync`ã€`GetByteArrayAsync`ã€`GetStreamAsync`ã€`GetStringAsync`ã€`PostAsync`ã€`PutAsync`å’Œ`SendAsync`â€”â€”è§è¿™é‡Œçš„)
*   å½“ä½¿ç”¨å®ä½“æ¡†æ¶æ ¸å¿ƒæ—¶ï¼Œ`DbContext`ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªå®ä¾‹ä¸Šå¹¶è¡Œè°ƒç”¨æ“ä½œä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„

å¦ä¸€ä»¶è¦è®°ä½çš„äº‹æƒ…æ˜¯ï¼Œå½“è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œè¦å°å¿ƒä¸è¦æ»¥ç”¨å®ƒï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šæ— æ„ä¸­å¯¼è‡´æ‹’ç»æœåŠ¡(å°½ç®¡æœ‰ä¸€äº›ä¿æŠ¤æªæ–½æ¥é¿å…å¯¹åŒä¸€ä¸»æœºçš„å¤ªå¤šè¯·æ±‚ï¼Œè¯·åœ¨æ­¤é˜…è¯»æ›´å¤š)ã€‚

### [](#waiting-for-all-the-requests-to-complete)ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ

å…³äºç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œä¸Šé¢çš„æ–¹æ³•æ˜¯æœ€ç®€å•çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰å…¶ä»–çš„é€‰æ‹©ï¼Œæ¯”å¦‚`Task.WhenAll`å’Œ`Task.WhenAny`ã€‚

`Task.WhenAll`å°†åŸºæœ¬ä¸Šä¸ä¸Šé¢çš„ä»£ç ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥å¾—åˆ°ä¸€ä¸ª`Task`é›†åˆæ¥ç­‰å¾…ï¼Œè€Œä¸æ˜¯å¿…é¡»å•ç‹¬`await`æ¯ä¸ªã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å°†è¿”å›çš„ä»»åŠ¡åˆ†ç»„åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œè¿™ä¹Ÿä¼šå¾ˆæœ‰ç”¨ã€‚é€šè¿‡ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¾—åˆ°:

`InMemoryGroupsService.cs`

```
public class InMemoryGroupsService : IGroupsService
{
    //...

    public async Task<Group> GetByIdAsync(long id, CancellationToken ct)
    {
        await Task.Delay(1000, ct);
        var extResult1Task = CallExternalServiceAsync(1, ct);
        var extResult2Task = CallExternalServiceAsync(2, ct);

        await Task.WhenAll(extResult1Task, extResult2Task);

        return _groups.SingleOrDefault(g => g.Id == id);
    }

    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦ä¸€ä¸ªé€‰æ‹©æ˜¯`Task.WhenAny`ï¼Œå°½ç®¡ç›®æ ‡ä¸åŒã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒä¼šç­‰å¾…ä»»åŠ¡ï¼Œå°±åƒ`WhenAll`ä¸€æ ·ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œä»£ç å°±ä¼šç»§ç»­æ‰§è¡Œã€‚

```
public class InMemoryGroupsService : IGroupsService
{
    //...

    public async Task<Group> GetByIdAsync(long id, CancellationToken ct)
    {
        var extResult1Task = CallExternalServiceAsync(1, ct);
        var extResult2Task = CallExternalServiceAsync(2, ct);

        await Task.WhenAny(extResult1Task, extResult2Task);

        return _groups.SingleOrDefault(g => g.Id == id);
    }

    //...

    private async Task<int> CallExternalServiceAsync(int multiplier, CancellationToken ct)
    {
        await Task.Delay(1000 * multiplier);
        return RandomGenerator.Next();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æœ¬ä¾‹ä¸­ï¼Œ`Task.WhenAll`å°†ç­‰å¾…å¤§çº¦ 2 ç§’é’Ÿï¼Œå› ä¸ºè¿™æ˜¯è¿è¡Œæ—¶é—´æœ€é•¿çš„å‘¼å«ã€‚`Task.WhenAny`å¦ä¸€æ–¹é¢ï¼Œå¤§çº¦éœ€è¦ 1 ç§’é’Ÿï¼Œå› ä¸ºè¿™æ˜¯æœ€å¿«é€šè¯çš„æŒç»­æ—¶é—´ã€‚

## [](#taskcompletionsource)ä»»åŠ¡å®Œæˆæ¥æº

è™½ç„¶æˆ‘è¦ç¦»å¼€ async/await çš„â€œåŸºç¡€â€é¢†åŸŸï¼Œä½†æˆ‘è®¤ä¸ºæˆ‘ä»¬è¦è®¨è®ºçš„æœ€åå‡ ä¸ªä¸»é¢˜æ˜¯å¾ˆæœ‰è¶£çš„ï¼Œå³ä½¿ä¸æ˜¯ç»å¸¸éœ€è¦çš„(å½“ç„¶å–å†³äºæˆ‘ä»¬æ­£åœ¨å¼€å‘ä»€ä¹ˆ)ã€‚

ä»`TaskCompletionSource`å¼€å§‹ï¼Œå®ƒå…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ç§â€œæ‰‹åŠ¨â€å®Œæˆ`Task`çš„æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬ä¹ æƒ¯äºç®€å•åœ°ç­‰å¾…å®ƒä»¬ï¼Œç”±ä¸€äº›å·²ç»å­˜åœ¨çš„å®ç°æä¾›ï¼Œå¦‚`HttpClient`æˆ–`DbContext`ã€‚ä¸ºäº†å±•ç¤ºè¿™æ˜¯å¦‚ä½•å·¥ä½œï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ç§å¸¦æœ‰æ§åˆ¶å™¨çš„é˜Ÿåˆ—ã€‚

### [](#creating-a-taskcompletionsource-and-setting-the-result)åˆ›å»º TaskCompletionSource å¹¶è®¾ç½®ç»“æœ

`DemoNotRecommendedQueueController.cs`

```
[Route("queue")]
public class DemoNotRecommendedQueueController : Controller
{
    private static readonly ConcurrentQueue<TaskCompletionSource<int>> TaskCompletionSourceQueue 
        = new ConcurrentQueue<TaskCompletionSource<int>>();

    [Route("ask")]
    public async Task<IActionResult> AskAsync()
    {
        var tcs = new TaskCompletionSource<int>();
        TaskCompletionSourceQueue.Enqueue(tcs);
        var result = await tcs.Task;
        return Content(result.ToString());
    }

    [Route("tell/{value}")]
    public IActionResult Tell(int value)
    {
        if (TaskCompletionSourceQueue.TryDequeue(out var tcs))
        {
            if (!tcs.TrySetResult(value))
            {
                return StatusCode(500);        
            }

            return NoContent();
        }

        return NotFound();
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª`ConcurrentQueue`æ¥å­˜å‚¨`TaskCompletionSource<int>`å®ä¾‹ã€‚å½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾`/queue/ask`æ—¶ï¼Œä¸€ä¸ª`TaskCompletionSource<int>`è¢«åˆ›å»ºå¹¶å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥åœ¨æä¾›çš„`Task`ä¸Š`await`ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥å‘å‡ºä¸€ä¸ªè¯·æ±‚`/queue/tell/1`ï¼Œå®ƒå°†å°è¯•è®¾ç½®é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª`TaskCompletionSource`çš„ç»“æœï¼Œæœ‰æ•ˆåœ°ä½¿`AskAsync`åŠ¨ä½œæ¢å¤æ‰§è¡Œã€‚

éœ€è¦è®°ä½çš„é‡è¦äº‹æƒ…æ˜¯ï¼Œå¤§å«Â·ç¦å‹’[å‘æ¨æ–‡](https://twitter.com/davidfowl/status/1026736063836876800)æé†’æˆ‘ä»¬ï¼Œå½“æˆ‘ä»¬åœ¨`TaskCompletionSource`ä¸Šè®¾ç½®ç»“æœæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç­‰å¾…`Task`çš„å»¶ç»­ä¼šåœ¨è®¾ç½®å®ƒçš„çº¿ç¨‹ä¸Šç«‹å³æ‰§è¡Œï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œè¿™ä¼šå¸¦æ¥é—®é¢˜ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¾ˆå¥½çš„ç»éªŒæ³•åˆ™æ˜¯é€šè¿‡åœ¨åˆ›å»º`TaskCompletionSource`æ—¶æŒ‡å®š`TaskCreationOptions.RunContinuationsAsynchronously`ï¼Œè®©å»¶ç»­åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œã€‚

`DemoNotRecommendedQueueController.cs`

```
[Route("ask")]
public async Task<IActionResult> AskAsync()
{
    var tcs = new TaskCompletionSource<int>(TaskCreationOptions.RunContinuationsAsynchronously);
    //...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…³äºä½¿ç”¨`TaskCompletionSource`æ—¶æˆ‘ä»¬åº”è¯¥æ³¨æ„çš„é—®é¢˜ç±»å‹ï¼Œä¸€ç¯‡æœ‰è¶£çš„æ–‡ç« æ˜¯ Sergey Teplyakov çš„[â€œä»»åŠ¡å®Œæˆçš„å±é™©æ¥æº< T >çº§](https://blogs.msdn.microsoft.com/seteplia/2018/10/01/the-danger-of-taskcompletionsourcet-class/)ã€‚

### [](#making-the-task-fail)ä½¿ä»»åŠ¡å¤±è´¥

å½“ç„¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¸æƒ³è®¾ç½®ä»»åŠ¡çš„ç»“æœï¼Œè€Œæ˜¯å–æ¶ˆå®ƒæˆ–æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚é™¤äº†`SetResult`(å’Œ`TrySetResult`)ï¼Œæˆ‘ä»¬è¿˜æœ‰`SetCanceled`(å’Œ`TrySetCanceled`)å’Œ`SetException`(è¿˜æœ‰`TrySetException`)ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª`TrySetCanceled`çš„ä¾‹å­ã€‚

`DemoNotRecommendedQueueController.cs`

```
[Route("queue")]
public class DemoNotRecommendedQueueController : Controller
{
    //...

    [Route("cancel")]
    public IActionResult Cancel()
    {
        if (TaskCompletionSourceQueue.TryDequeue(out var tcs))
        {
            if (!tcs.TrySetCanceled())
            {
                return StatusCode(500);        
            }

            return NoContent();
        }

        return NotFound();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†ä¸æˆ‘ä»¬ä¹‹å‰åœ¨`CancellationToken` s ä¸­çœ‹åˆ°çš„è¡Œä¸ºç›¸åŒï¼Œä»¥`TaskCanceledException`ç»“æŸã€‚

## [](#cancellationtokensource)å–æ¶ˆä»¤ç‰Œæº

è¯´åˆ°`CancellationToken`ï¼Œå’Œ`TaskCompletionSource`ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ª`CancellationTokenSource`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å‘å‡ºå–æ¶ˆæ“ä½œçš„ä¿¡å·(å°±åƒ MVC åœ¨åŠ¨ä½œä¸­æ³¨å…¥`CancellationToken`ä¸€æ ·)ã€‚

ç»§ç»­ç±»ä¼¼äºä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬æœ‰:

```
[Route("queue")]
public class DemoNotRecommendedQueueController : Controller
{
    //...

    private static readonly ConcurrentQueue<CancellationTokenSource> CancellationTokenSourceQueue =
        new ConcurrentQueue<CancellationTokenSource>();

    //...

    [Route("delay/{value}")]
    public async Task<IActionResult> DelayAsync(int value)
    {
        using (var cts = new CancellationTokenSource())
        {
            CancellationTokenSourceQueue.Enqueue(cts);
            await Task.Delay(value, cts.Token);
            CancellationTokenSourceQueue.TryDequeue(out _);
            return Content("Done waiting");
        }
    }

    [Route("delay/cancel")]
    public IActionResult CancelDelay()
    {
        if (CancellationTokenSourceQueue.TryDequeue(out var cts))
        {
            cts.Cancel();
            return Content("Delay cancelled!");
        }

        return NotFound();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»£ç ä¸å‰ä¸€ä¸ªä¾‹å­éå¸¸ç›¸ä¼¼(å¿½ç•¥æˆ‘æ²¡æœ‰æ­£ç¡®ä½¿ç”¨`ConcurrentQueue`ï¼Œå› æ­¤å­˜åœ¨å¹¶å‘é—®é¢˜ğŸ˜›)ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸æ˜¯åœ¨ç­‰å¾…`TaskCompletionSource`çš„ä»»åŠ¡ï¼Œè€Œæ˜¯åœ¨ç­‰å¾…å¯ä»¥è¢«åˆ›å»ºçš„`CancellationTokenSource`å–æ¶ˆçš„ä¸œè¥¿ã€‚æ‰€ä»¥ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å»æµè§ˆå™¨è°ƒç”¨`/queue/delay/10000`ï¼Œåœ¨æ—¶é—´åˆ°æœŸä¹‹å‰ï¼Œè°ƒç”¨`/queue/delay/cancel`ï¼Œå¯¼è‡´`DelayAsync`åŠ¨ä½œçªç„¶ç»“æŸï¼Œç”¨é€šå¸¸çš„`TaskCanceledException`ã€‚

## [](#outro)å…¶ä»–

ä¸­çš„å¼‚æ­¥ã€ç­‰å¾…å’Œå¹¶å‘ç¼–ç¨‹è¿˜æœ‰å¾ˆå¤šã€‚NETï¼Œä½†æ˜¯æˆ‘æƒ³æˆ‘å·²ç»ä»‹ç»äº†å®ƒçš„ä¸€äº›æœ€å¸¸ç”¨çš„éƒ¨åˆ†ã€‚å¦‚æœæ‚¨æƒ³æ·±å…¥äº†è§£ï¼Œæˆ‘ä¼šç•™ä¸‹ä¸€äº›é¢å¤–çš„èµ„æº:

*   æ–¯è’‚èŠ¬Â·å…‹åˆ©é‡Œçš„åšå®¢-[https://blog.stephencleary.com/](https://blog.stephencleary.com/)-é‡Œé¢æœ‰å¾ˆå¤šã€‚NET å¹¶å‘ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘ç”¨äº†å¾ˆå¤šä½œä¸ºè¿™ä¸€é›†çš„å‚è€ƒ
    *   [â€œä»»åŠ¡ã€‚è·‘æ­¥ç¤¼ä»ªä¸¾ä¾‹:ä¸è¦ç”¨ Taskã€‚è¿è¡Œåœ¨æ‰§è¡Œ"](https://blog.stephencleary.com/2013/11/taskrun-etiquette-examples-dont-use.html)
*   æ–¯è’‚èŠ¬Â·å…‹åˆ©é‡ŒÂ·MSDN å…³äºå¼‚æ­¥/ç­‰å¾…æœ€ä½³å®è·µçš„æ–‡ç« - [â€œå¼‚æ­¥/ç­‰å¾…-å¼‚æ­¥ç¼–ç¨‹ä¸­çš„æœ€ä½³å®è·µâ€](https://msdn.microsoft.com/en-us/magazine/jj991977.aspx) -å¾ˆå¯èƒ½æ¯”æˆ‘çš„æ–‡ç« æ›´å…¨é¢(å°½ç®¡åœ¨ ASP.NET æ ¸å¿ƒå‡ºç°ä¹‹å‰)
*   David Fowler çš„[å¼‚æ­¥æŒ‡å¯¼æ–‡ç« ](https://github.com/davidfowl/AspNetCoreDiagnosticScenarios/blob/master/AsyncGuidance.md)ï¼Œå…¶ä¸­æœ‰å¾ˆå¤š async æ ¸å¿ƒä¸­å¸¸è§åœºæ™¯çš„ä¾‹å­
*   è°¢å°”ç›–Â·ç‰¹æ™®åˆ©äºšç§‘å¤«çš„[â€œä»»åŠ¡å®Œæˆçš„å±é™©æ¥æº< T >çº§](https://blogs.msdn.microsoft.com/seteplia/2018/10/01/the-danger-of-taskcompletionsourcet-class/)

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode010)ã€‚

è¯·å‘é€ä»»ä½•åé¦ˆï¼Œä»¥ä¾¿æˆ‘å¯ä»¥æ”¹è¿›å’Œè°ƒæ•´ä¸‹ä¸€é›†ã€‚

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼