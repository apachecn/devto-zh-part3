# åƒå»ºç­‘å¸ˆä¸€æ ·å¡‘é€ æ£±è§’(ç¬¬ 1 éƒ¨åˆ†)

> åŸæ–‡:[https://dev . to/Steve blue/build-angular-like-an-architect-part-1-3ph 2](https://dev.to/steveblue/build-angular-like-an-architect-part-1-3ph2)

æˆ‘ğŸ¤“åœ¨æ„å»ºå·¥å…·ä¸Šã€‚

è‡ªä» Angular 2 å‘å¸ƒä»¥æ¥ï¼Œæˆ‘ä¸€ç›´åœ¨å°è¯•ä¸åŒçš„æ–¹æ³•æ¥æ„å»ºåº”ç”¨ç¨‹åºã€‚å¤§å¤šæ•°å¼€å‘äººå‘˜ä¸éœ€è¦æ‹…å¿ƒä»–ä»¬çš„åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•æ„å»ºçš„ï¼Œå› ä¸º@angular/cli è®©è¿™å˜å¾—éå¸¸å®¹æ˜“ã€‚cli éšè—äº†æ‰€æœ‰çš„å¤æ‚æ€§ï¼Œè¿™æ˜¯æœ‰å……åˆ†ç†ç”±çš„ã€‚å·¥ç¨‹å¸ˆéœ€è¦ä¸“æ³¨äºå®ç°ç‰¹æ€§å’Œç¼ºé™·ä¿®å¤ã€‚è®©æˆ‘ä»¬é¢å¯¹ç°å®å§ã€‚æ„å»ºå¤æ‚çš„ä¼ä¸šåº”ç”¨ç¨‹åºå¾ˆå›°éš¾ã€‚å°†æ‰€æœ‰çš„éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·å¯èƒ½éœ€è¦å¤§é‡çš„å·¥ä½œï¼Œæ›´ä¸ç”¨è¯´è®©æ„å»ºå·¥å…·åšåƒä»£ç åˆ†å‰²åº”ç”¨ç¨‹åºè¿™æ ·çš„äº‹æƒ…äº†ã€‚

åœ¨åƒå»ºç­‘å¸ˆä¸€æ ·æ„å»º Angular(ç¬¬ 1 éƒ¨åˆ†)ä¸­ï¼Œæˆ‘ä»¬ç®€è¦åœ°çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆæœ‰äººæƒ³è¦ç¼–å†™ä¸€ä¸ªå®šåˆ¶ Angular æ„å»ºï¼Œä»¥åŠæˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨@angular-devkit/architect åŒ…ä¸­æä¾›çš„ API æ­å»ºä¸€ä¸ªæ–°çš„æ„å»ºå™¨ï¼Œç”¨ RxJS Observables ç¼–å†™æ„å»ºä»£ç ï¼Œå¹¶å­¦ä¹ å¦‚ä½•ç”¨æ†ç»‘äº† angular å’Œ Closure ç¼–è¯‘å™¨è€Œä¸æ˜¯ Webpack çš„æ–°ç”Ÿäº§æ„å»ºæ¥æ‰©å±•@angular/cliã€‚

ä½ å¯ä»¥åœ¨è¿™ä¸ª Github åº“ä¸­æŸ¥çœ‹ä»£ç [ã€‚](https://github.com/steveblue/architect)

### [](#how-did-we-get-here)æˆ‘ä»¬æ˜¯æ€ä¹ˆåˆ°è¿™é‡Œçš„ï¼Ÿ

è‡ªä»@angular/cli è¿ç§»åˆ° webpack ä¹‹åï¼Œå°±å¾ˆéš¾ä¸å…¶ä»–æ„å»ºå·¥å…·é›†æˆå¹¶ä¿ç•™ cli çš„ä¼˜åŠ¿ã€‚åªåšäº†ä¸€äº›åŠªåŠ›æ¥æ‰©å±• cliã€‚nx å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®ƒåœ¨ monorepo ä¸­å®ç°äº†æ›´å¿«çš„å¼€å‘ï¼Œåªå¢é‡åœ°æ„å»ºå·²ç»æ”¹å˜çš„ä»£ç ã€‚cli æœ‰æ—¶ä¸ webpack ç´§å¯†ç»“åˆï¼Œå¯¼è‡´ webpack æœ¬èº«çš„å®šåˆ¶éå¸¸ç¬¨æ‹™ã€‚

[![eject](../Images/ecbe24139ef7a1e41e2fc50e706cb73e.png)T2ã€‘](https://i.giphy.com/media/JGF7ctowtLGak/giphy.gif)

åœ¨ Angular 6 ä¹‹å‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`ng eject`å¼¹å‡º webpack é…ç½®æ¥å®šåˆ¶å®ƒã€‚

éšç€ Angular 6 çš„å‘å¸ƒï¼Œå½“å®Œå…¨é‡å†™@angular/cli æŠ½è±¡å‡ºè¯¥å·¥å…·çš„æŸäº›éƒ¨åˆ†æ—¶ï¼Œè¿™ä¸ª API å°±è¢«å¼ƒç”¨äº†ã€‚cli å˜æˆäº†@angular-devkit çš„åŒ…è£…å™¨ã€‚è¿è¡Œä¸€ä¸ª`ng`å‘½ä»¤ä»…ä»…æ„å‘³ç€æ‚¨æ­£åœ¨è§¦å‘è¿è¡Œâ€œæ„å»ºè€…â€çš„â€œæ¶æ„å¸ˆâ€ç›®æ ‡ã€‚è¿™ç§æŠ½è±¡ä½¿å¾— nx è¿™æ ·çš„å·¥å…·æˆä¸ºå¯èƒ½ã€‚

API çš„æœ‰ç”¨éƒ¨åˆ†å¦‚ä¸‹:

*   æ„å»ºå™¨ä½¿æ‚¨èƒ½å¤Ÿç”¨ TypeScript å’Œ RxJS ç¼–å†™è‡ªå®šä¹‰æ„å»º
*   Architect å…è®¸æ‚¨å®šä¹‰è¿è¡Œæ„å»ºå™¨çš„ç›®æ ‡
*   Architect CLI æä¾›äº†ä¸€ç§åœ¨å·¥ä½œç©ºé—´ä¸­æµ‹è¯•æ„å»ºå™¨çš„æ–¹æ³•

é«˜çº§ç”¨æˆ·å¯ä»¥é€šè¿‡ç¼–å†™æ„å»ºå™¨å¹¶ä½¿ç”¨ Architect å»ºç«‹æ‰§è¡Œæ„å»ºå™¨çš„ç›®æ ‡æ¥å®šåˆ¶å·¥å…·ï¼Œä»è€Œæä¾›å®šåˆ¶çš„ webpack é…ç½®ã€‚å¦‚æœä½ è¿™æ ·åšäº†ï¼Œä½ å°±å†’ç€ç ´å API çš„é£é™©ï¼Œè€Œ API å°†åœ¨ Angular 8 ä¸­å˜å¾—ç¨³å®šã€‚@angular-devkit/architect è¢«è®¤ä¸ºæ˜¯å®éªŒæ€§çš„ï¼Œç›´åˆ°[åƒè¿™æ ·çš„æäº¤](https://github.com/angular/angular-cli/commit/e41e10d313ad49e632ed1f9d6e7e563b3eb2fd09)è¿›å…¥ Github ä¸Šçš„@angular/cli åº“ã€‚

# @ angular-dev kit/architect ç¨³ï¼

è¿™æ˜¯ä¸€ä¸ªæ”¹å˜æ¸¸æˆè§„åˆ™çš„åŸå› ã€‚@angular/cli æ­£åœ¨å˜å¾—å¯æ‰©å±•ã€‚

[![](../Images/d38ed44ebc38f366754986f2e5394ebd.png)T2ã€‘](https://i.giphy.com/media/kVRBvsiOyBM8o/giphy.gif)

æ„å»ºå™¨å…è®¸æˆ‘ä»¬æ‰©å±• Angular CLI æ¥åšæˆ‘ä»¬ä»¥å‰è®¤ä¸ºä¸å¯èƒ½çš„äº‹æƒ…ï¼

è¿™é‡Œæœ‰å‡ ä¸ªä¾‹å­è¯´æ˜å¦‚ä½•ç”¨æ„å»ºå™¨æ‰©å±• CLIã€‚

*   ç”¨ Jest ä»£æ›¿ Karma è¿è¡Œå•å…ƒæµ‹è¯•
*   ç”¨ TestCafe ä»£æ›¿ Selenium å’Œé‡è§’å™¨æ‰§è¡Œ e2e æµ‹è¯•
*   ä½¿ç”¨ Webpack ä¹‹å¤–çš„å·¥å…·ä¼˜åŒ–ç”Ÿäº§æ†ç»‘åŒ…
*   ä½¿ç”¨è‡ªå®šä¹‰èŠ‚ç‚¹æœåŠ¡å™¨
*   æä¾›è‡ªå®šä¹‰ Webpack é…ç½®ï¼Œå¦‚[@ angular-devkit/build-web pack](https://github.com/angular/angular-cli/tree/master/packages/angular_devkit/build_webpack)

å½“ä½¿ç”¨ Builder API æ—¶ï¼Œæˆ‘ä»¬è·å¾—äº†æ‰€æœ‰è¿™äº›å¼€ç®±å³ç”¨çš„ç²¾å½©ç‰¹æ€§/è¡Œä¸ºï¼

*   RxJS å¯è§‚æµ‹é‡
*   (éŸ³ä¹)å¯è®¾å®šçš„
*   å¯è¯•éªŒçš„
*   è®°å½•å™¨
*   è¿›åº¦è·Ÿè¸ª
*   é”™è¯¯æŠ¥å‘Šè€…
*   è°ƒåº¦ç¨‹åº

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ç¼–å†™ä¸€ä¸ªä½¿ç”¨ Closure ç¼–è¯‘å™¨ä¼˜åŒ–åº”ç”¨ç¨‹åºçš„æ„å»ºå™¨æ¥æ„å»º Angularã€‚

## [](#enter-closure-compiler)è¿›å…¥é—­åŒ…ç¼–è¯‘å™¨

@angular/cli ä¾èµ– webpack å’Œ terser æ¥æ†ç»‘å’Œä¼˜åŒ– JavaScriptã€‚è¿™äº›å·¥å…·åšå¾—éå¸¸å¥½ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªå·¥å…·åšå¾—æ›´å¥½ã€‚

Closure Compiler æ˜¯ Google ä½¿ç”¨çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºä¼˜åŒ–ç”Ÿäº§ç”¨çš„ JavaScriptã€‚æ¥è‡ªå®˜ç½‘:

> é—­åŒ…ç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªè®© JavaScript ä¸‹è½½å’Œè¿è¡Œæ›´å¿«çš„å·¥å…·ã€‚å®ƒä¸æ˜¯ä»æºè¯­è¨€ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯ä» JavaScript ç¼–è¯‘æˆæ›´å¥½çš„ JavaScriptã€‚å®ƒè§£æä½ çš„ JavaScriptï¼Œåˆ†æå®ƒï¼Œåˆ é™¤æ­»ä»£ç ï¼Œé‡å†™å¹¶æœ€å°åŒ–å‰©ä¸‹çš„ä»£ç ã€‚å®ƒè¿˜æ£€æŸ¥è¯­æ³•ã€å˜é‡å¼•ç”¨å’Œç±»å‹ï¼Œå¹¶è­¦å‘Šå¸¸è§çš„ JavaScript é™·é˜±ã€‚

åœ¨ ng-conf 2017 ä¸Šï¼ŒAngular å›¢é˜Ÿå®£å¸ƒ AOT ç¼–è¯‘å™¨ä¸ Angular 4 ä¸­çš„é—­åŒ…ç¼–è¯‘å™¨å…¼å®¹ã€‚AOT ç¼–è¯‘å™¨å°† TypeScript ç±»å‹çš„æ‰¹æ³¨è½¬æ¢ä¸º JSDoc æ ·å¼çš„æ‰¹æ³¨ï¼Œé—­åŒ…ç¼–è¯‘å™¨å¯ä»¥è§£é‡Šè¿™äº›æ‰¹æ³¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç¼–è¯‘å™¨æ ‡å¿—è§£é”æ­¤åŠŸèƒ½ã€‚åœ¨å¹•åï¼Œä¸€ä¸ªåä¸º tsickle çš„å·¥å…·è½¬æ¢æ³¨é‡Šã€‚è¿™ä¸ªç‰¹æ€§å°†ä½¿ Angular åœ¨ Google å¾—åˆ°å¹¿æ³›é‡‡ç”¨ï¼Œåœ¨ Googleï¼Œå›¢é˜Ÿè¢«è¦æ±‚ç”¨ Closure ç¼–è¯‘å™¨ä¼˜åŒ– JavaScriptã€‚

[![](../Images/a9d58c2942f9a08ba96939de345e9021.png)T2ã€‘](https://i.giphy.com/media/3SBi8gMf8BqBG/giphy.gif)

Angular ç¤¾åŒºæ­£åœ¨ ng-conf 2017 ä¸Šå›´ç»• webpack é›†ä¼šï¼Œç„¶è€Œæˆ‘è‡ªç„¶å¯¹ Closure Compiler å¾ˆå¥½å¥‡ã€‚åœ¨å¼€å‘ä¼šè®®ä¸Šï¼Œä½ å¯èƒ½ä¼šå‘ç°æˆ‘åœ¨å¬ä¸€ä¸ªæŠ¥å‘Šï¼Œåœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šæ‰“å­—ï¼Œå°è¯•ä¸€äº›æˆ‘åˆšåˆšå­¦åˆ°çš„ä¸œè¥¿ã€‚åœ¨ ng-conf ä¸­ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªæ¦‚å¿µè¯æ˜ï¼Œå¯ä»¥å°† Angular ä¸é—­åŒ…ç¼–è¯‘å™¨æ†ç»‘åœ¨ä¸€èµ·ã€‚ç»“æœä»¤äººå°è±¡æ·±åˆ»ã€‚

## æˆ‘æ‰”ç»™ Closure ç¼–è¯‘å™¨çš„æ¯ä¸€ä¸ªåŒ…éƒ½æ¯” Webpack å’Œ Uglify ä¼˜åŒ–å¾—æ›´å¥½(ä¹Ÿæ›´ç®€æ´)ã€‚

[![](../Images/2c0d48455516a9ff75464717d625dd80.png)T2ã€‘](https://i.giphy.com/media/l3q2DgSFjbAyseViM/giphy.gif)

Angular å¿…é¡»æå‰æ„å»º(AOT)å’Œæå‰ç¼–è¯‘ä»£ç ã€‚é—­åŒ…ç¼–è¯‘å™¨å¿…é¡»å¤„äº ADVANCED_OPTIMIZATIONS æ¨¡å¼ï¼Œä»¥ç¡®ä¿å°½å¯èƒ½æœ€å°çš„åŒ…ã€‚ä½¿ç”¨@ angular-dev kit/build-optimizer ä¹Ÿæ— å¦¨ã€‚å½“æ–°çš„ Ivy ç¼–è¯‘å™¨æœ€ç»ˆç‰ˆ(Angular 9)æ—¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ›´å¥½çš„ä¼˜åŒ–ï¼Œä½†ç°åœ¨æˆ‘ä»¬æœ‰ AOT ç¼–è¯‘å™¨ã€‚

Angular ç¤¾åŒºéå¸¸å¹¸è¿ï¼ŒAngular ä¸ Closure ç¼–è¯‘å™¨å…¼å®¹ï¼Œä½†æ˜¯ç”±äº Angular CLI åªæ”¯æŒ Webpackï¼Œæ‰€ä»¥é‡‡ç”¨çš„é€Ÿåº¦å¾ˆæ…¢ã€‚æ²¡æœ‰å¤šå°‘å…¶ä»–åº“æˆ–æ¡†æ¶èƒ½å¤Ÿå£°ç§°èƒ½å¤Ÿç”Ÿæˆç”¨ Closure ç¼–è¯‘å™¨å®Œå…¨ä¼˜åŒ–çš„åŒ…ã€‚React å›¢é˜Ÿæ”¾å¼ƒäº†åœ¨ä¼˜åŒ– JavaScript çš„æœ€æ¿€è¿›æ¨¡å¼ä¸‹æ”¯æŒ Closure Compilerã€‚

æ‚¨å¿…é¡»å¯¹ JavaScript è¿›è¡Œå¤§é‡æ³¨é‡Šæ‰èƒ½è·å¾— ADVANCED_OPTIMIZATIONS çš„å…¨éƒ¨å›æŠ¥ï¼Œè¿™æ˜¯ Closure ç¼–è¯‘å™¨ä¸­çš„ä¸€ç§æ¨¡å¼ï¼Œåœ¨å®ç°æœ€é«˜å¯èƒ½çš„å‹ç¼©æ–¹é¢éå¸¸ç§¯æã€‚Angular æœ¬èº«å·²ç»è¢«æ³¨é‡Šäº†ï¼ŒæŒ‰ç…§ Angular åŒ…æ ¼å¼æ„å»ºçš„åº“ä¹Ÿæ˜¯å…¼å®¹çš„ã€‚è¿™æ˜¯å› ä¸ºå¼€å‘äººå‘˜å·²ç»ç”¨ TypeScript ç¼–å†™äº† Angular ä»£ç ï¼ŒAOT ç¼–è¯‘å™¨ä¼šå°†æˆ‘ä»¬çš„ç±»å‹è½¬æ¢æˆé—­åŒ…ç¼–è¯‘å™¨å¯ä»¥è§£é‡Šçš„æ³¨é‡Šã€‚å¦‚æœä½ ç»´æŠ¤ä¸€ä¸ªç±»å‹å®‰å…¨çš„åº”ç”¨ç¨‹åºï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„é—­åŒ…ç¼–è¯‘å™¨åŒ…ï¼

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ Architect API æ‰©å±• Angular CLI æ¥æ„å»º Closure ç¼–è¯‘å™¨ï¼Œè¿™æ ·åº”è¯¥ä¼šæ›´å®¹æ˜“è¢«é‡‡ç”¨ã€‚è®©æˆ‘ä»¬å¼„æ¸…æ¥šå¦‚ä½•åœ¨ CLI ä¸­å°†åº”ç”¨ç¨‹åºä¸é—­åŒ…ç¼–è¯‘å™¨æ†ç»‘åœ¨ä¸€èµ·ï¼

## [](#how-to-build-angular-with-architect-cli)å¦‚ä½•ç”¨ Architect CLI æ„å»º Angular

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æ„å»ºä¸€ä¸ªæ„å»ºå™¨æ‰€éœ€çš„åŸºæœ¬æ–‡ä»¶ï¼Œä»¥åŠå°†ä¸€ä¸ªç®€å•çš„ Angular åº”ç”¨ç¨‹åºä¸ Closure ç¼–è¯‘å™¨æ†ç»‘åœ¨ä¸€èµ·æ‰€éœ€çš„æ¶æ„å¸ˆç›®æ ‡ã€‚æœ¬èŠ‚ä»‹ç»çš„æ¦‚å¿µå¯ä»¥æ‰©å±•åˆ°ä»»ä½•æ„å»ºè€…ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œæˆ‘ä¸ä¼šæƒŠè®¶åœ°çœ‹åˆ°ä¸€ä¸ªä½¿æ­å»ºä¸€ä¸ªå»ºè®¾è€…æ›´å®¹æ˜“çš„ç¤ºæ„å›¾ï¼Œä½†ç°åœ¨æˆ‘ä»¬å°†è‡ªå·±åˆ›å»ºæ–‡ä»¶ã€‚

### [T1ã€‘ç®€ä»‹](#intro)

é¦–å…ˆè®©æˆ‘ä»¬æ¦‚è¿°ä¸€ä¸‹æ„å»º Angular çš„æ­¥éª¤ã€‚

| æ­¥éª¤ | æè¿° | å·¥å…· |
| --- | --- | --- |
| ç¼–åˆ¶ | æå‰ç¼–è¯‘åº”ç”¨ç¨‹åº | @ angular/ç¼–è¯‘å™¨ |
| ä½¿æœ€ä¼˜åŒ– | ç§»é™¤ä¸å¿…è¦çš„ç¼–è¯‘å‰¯äº§å“ w/(å¯é€‰) | @ angular-dev kit/build _ optimizer |
| å¤„ç†ç¯å¢ƒ | ä½¿ç”¨ cli æä¾›çš„ç¯å¢ƒ(å¯é€‰) | ä¸™é…¸çº¤ç»´ç´  |
| æ† | æ†ç»‘å’Œç ´å AOT ç¼–è¯‘çš„ä»£ç  | è°·æ­Œé—­åŒ…ç¼–è¯‘å™¨ |

è¦ä¸ºç”Ÿäº§æ„å»º Angular åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨@angular/compiler-cliã€‚å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨è¿™æ ·åšï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`ngc`å‘½ä»¤è°ƒç”¨ç¼–è¯‘å™¨ã€‚

```
ngc -p src/tsconfig.app.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†åœ¨ out-tsc ç›®å½•ä¸­è¾“å‡º AOT ç¼–è¯‘çš„åº”ç”¨ç¨‹åºï¼Œä¸ cli åœ¨ç”Ÿäº§ç‰ˆæœ¬ä¸­é»˜è®¤æ”¾ç½®å®ƒçš„ä½ç½®ä¸€è‡´ã€‚å› ä¸ºåœ¨ src/tsconfig.app.json : `"outDir": "../out-tsc",`ä¸­`outDir`å°±æ˜¯è¿™æ ·é…ç½®çš„

æˆ‘ä»¬å¯ä»¥åœ¨ä¸@ angular-dev kit/build-optimizer æ†ç»‘ä¹‹å‰ä¼˜åŒ–åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªåŒ…åˆ é™¤äº†ç¼–è¯‘å™¨åå‡ºçš„ä¸€äº›ä¸å¿…è¦çš„ä»£ç ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨å¼€å‘ä¸­ä½¿ç”¨çš„è£…é¥°å™¨ã€‚

@angular/cli æœ‰è¿™ä¸ªç¯å¢ƒçš„æ¦‚å¿µï¼Œå·¥ç¨‹å¸ˆå¯ä»¥`import { environment } from './environment'`ã€‚`environment`æ˜¯ä¸ºæ¯ä¸ªç¯å¢ƒé…ç½®çš„å¯¹è±¡ã€‚ä¸ºäº†ä½¿è‡ªå®šä¹‰æ„å»ºå¯¹@angular/cli å‹å¥½ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥æ”¯æŒè¿™ä¸ª APIã€‚åŸºæœ¬ä¸Šéœ€è¦å‘ç”Ÿçš„æ˜¯ out-tsc ç›®å½•ä¸­çš„`environment.js`çš„å†…å®¹éœ€è¦ç”¨`environment.${env}.js`æ¢å‡ºã€‚

ä¸ºäº†æ†ç»‘ Closure ç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶:closure.confã€‚Closure Compiler æ˜¯ä¸€ä¸ª Java åº”ç”¨ç¨‹åºï¼Œåˆ†å¸ƒåœ¨ google-closure-compiler-java åŒ…ä¸­ã€‚Closure Compiler ä¹Ÿæä¾›äº† JavaScript APIï¼Œä½†å®é™…ä¸Šæˆ‘å‘ç° Java å®ç°æ›´å¯é ã€‚

[![](../Images/844b13105522dffe1e7e7c21931e1af2.png)T2ã€‘](https://i.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif)

ä¸ºäº†æ‰‹åŠ¨è¿è¡Œé—­åŒ…ç¼–è¯‘å™¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨å‚æ•°ã€‚

```
java -jar ${jarPath} --flagFile ${confFile} --js_output_file ${outFile} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æ˜¯è¿™æ ·ï¼åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨å¼ºåˆ¶æ­¥éª¤ 1 å’Œ 4ï¼Œè¿è¡Œ AOT ç¼–è¯‘å™¨å¹¶ä½¿ç”¨é—­åŒ…ç¼–è¯‘å™¨ä¼˜åŒ–å•ä¸ªåŒ…ã€‚

åœ¨ã€Šåƒå»ºç­‘å¸ˆä¸€æ ·æ„å»º Angular ã€‹(ç¬¬ 2 éƒ¨åˆ†)ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨@ Angular-dev kit/Build-optimizer æ·»åŠ äº†ç¯å¢ƒå¹¶è¿›ä¸€æ­¥ä¼˜åŒ–äº†åŒ…ã€‚å¦‚æœä½ æƒ³å…ˆç¹ä¸ºå¿«ï¼Œè¯·æŸ¥çœ‹ Github åº“ã€‚

### [](#getting-started)å…¥é—¨

ä½¿ç”¨`next`ç‰ˆæœ¬åœ¨å…¨çƒèŒƒå›´å†…å®‰è£…æœ€æ–°çš„ cli å’Œ architect è½¯ä»¶åŒ…ã€‚ç¨³å®šçš„ Architect CLI ä»…åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­å¯ç”¨ã€‚

æ¶æ„å¸ˆå¼€å‘ä¾èµ–äºèŠ‚ç‚¹> 10.14.1ã€‚ä½¿ç”¨`which node`æ£€æŸ¥æ‚¨æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ç‰ˆæœ¬ï¼Œå¹¶ç›¸åº”åœ°æ›´æ–°èŠ‚ç‚¹ã€‚

```
npm i -g @angular/cli@next @angular-devkit/core@next @angular-devkit/architect@next @angular-devkit/architect-cli@next 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨@angular/cli åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºå·¥ä½œåŒºã€‚

```
ng new build_repo 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºç§°ä¸º build_repoã€‚

å¦‚æœæ‚¨è¿˜æ²¡æœ‰å®‰è£…å®ƒï¼Œä¹Ÿå¯ä»¥ä» Oracle ä¸‹è½½å¹¶å®‰è£…[æœ€æ–°çš„ Java SDKã€‚ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œé—­åŒ…ç¼–è¯‘å™¨ Java åº”ç”¨ç¨‹åºäº†ã€‚](https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)

åœ¨é¡¹ç›®å·¥ä½œåŒºä¸­å®‰è£…é—­åŒ…ç¼–è¯‘å™¨å’Œ tsickleã€‚

```
npm i google-closure-compiler tsickle --save-dev 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#buildtools)æ„å»º _ å·¥å…·

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºâ€œbuild_toolsâ€çš„æ–°ç›®å½•ã€‚

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ ¹ç›®å½•ä¸­åº”è¯¥æœ‰çš„æ–‡ä»¶ã€‚

| æ–‡ä»¶ | æè¿° |
| --- | --- |
| æ„å»ºå·¥å…· | ç¼–ç æ„å»ºäººå‘˜çš„å·¥ä½œç©ºé—´ |
| angular.json | è§’åº¦åº”ç”¨å·¥ä½œç©ºé—´é…ç½® |

åœ¨ build_tools ç›®å½•ä¸­åˆ›å»ºå‡ ä¸ªæ–°æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯æ¯ä¸ªæ–‡ä»¶çš„åŠŸèƒ½æè¿°ã€‚

| æ–‡ä»¶ | æè¿° |
| --- | --- |
| package.json | å®‰è£…ä¾èµ–é¡¹ï¼Œä¸ºç”Ÿæˆå™¨æä¾›ä¸Šä¸‹æ–‡ |
| tsconfig.json | typescript é¡¹ç›®é…ç½® |
| builders.json | æ­¤åŒ…ä¸­å¯ç”¨çš„æ„å»ºå™¨çš„æ¨¡å¼ |
| src/closure/schema.json | é—­åŒ…ç¼–è¯‘å™¨ç”Ÿæˆå™¨çš„æ¨¡å¼ |
| src/close/index . ts | é—­åŒ…ç¼–è¯‘å™¨ç”Ÿæˆå™¨çš„æ ¹æ–‡ä»¶ |
| src/ç´¢å¼•. ts | æ„å»ºå™¨åŒ…æºçš„æ ¹æ–‡ä»¶ |

åœ¨ build_tools ç›®å½•ä¸‹åˆ¶ä½œä¸€ä¸ª package.jsonã€‚è¯¥æ–‡ä»¶åº”è¯¥ç±»ä¼¼äºä¸‹é¢çš„ç¤ºä¾‹ã€‚

### [](#packagejson)package.json

```
{  "name":  "build_tools",  "version":  "1.0.0",  "description":  "",  "main":  "src/index.js",  "scripts":  {  "test":  "echo \"Error: no test specified\" && exit 1"  },  "author":  "",  "license":  "MIT",  "devDependencies":  {  "@angular-devkit/architect":  "^0.800.0-beta.10",  "@angular-devkit/core":  "^8.0.0-beta.10",  "@types/node":  "^11.12.1"  },  "builders":  "builders.json"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

package.json æ˜¯@angular/cli å»ºç«‹ builders.json çš„ä½ç½®ä»¥åŠå®‰è£…å¼€å‘æ„å»ºå™¨æ‰€éœ€çš„ä¾èµ–é¡¹æ‰€å¿…éœ€çš„ã€‚

åœ¨ build_tools ç›®å½•ä¸‹è¿è¡Œ`npm install`ã€‚

åœ¨ src ç›®å½•ä¸­åˆ›å»ºæ–°çš„ index.ts æ–‡ä»¶ã€‚åœ¨è¿™é‡Œå¯¼å‡ºæ¥è‡ª src/closure/index.ts.
çš„æ‰€æœ‰å†…å®¹

```
export * from './closure'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ build_tools ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ builder.json æ–‡ä»¶ã€‚

### [](#buildersjson)builders.json

è¿™ä¸ªæ–‡ä»¶ä»‹ç»äº†è¿™ä¸ªåŒ…ä¸­å¯ç”¨çš„æ„å»ºå™¨çš„æ¨¡å¼ã€‚

builders.json å»ºç«‹äº†æ¶æ„å¸ˆéœ€è¦æŒ‡å‘æ¯ä¸ªæ„å»ºå™¨çš„ç›®æ ‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç›®æ ‡è¢«ç§°ä¸ºâ€œclosure â€,å®ƒæŒ‡å‘ä½äºçš„æ„å»ºå™¨ã€‚/src/closure/index.js 'å¹¶ä¸”æ„å»ºå™¨çš„æ¶æ„ä½äº'ã€‚/src/closure/schema.jsonã€‚

```
{  "$schema":  "@angular-devkit/architect/src/builders-schema.json",  "builders":  {  "closure":  {  "implementation":  "./src/closure/index",  "class":  "./src/closure",  "schema":  "./src/closure/schema.json",  "description":  "Build a Closure app."  }  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [T1ã€‘src/closure/schema . JSON](#srcclosureschemajson)

è¯´åˆ°æ¨¡å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºé—­åŒ…ç¼–è¯‘å™¨ç”Ÿæˆå™¨å£°æ˜æ¨¡å¼ã€‚æ„å»ºå™¨æ¨¡å¼ä¸ºæ„å»ºå™¨å»ºç«‹é¢å‘å¤–éƒ¨çš„ APIã€‚

è‹±å¯¸/src/closure/schema.json æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå·¥ç¨‹å¸ˆéœ€è¦åœ¨å…¶å·¥ä½œç©ºé—´ angular.json ä¸­æä¾›çš„ä¸¤ä¸ªå¿…éœ€å±æ€§:`tsConfig`å’Œ`closureConfig`ã€‚è¿™ä¸¤ä¸ªå±æ€§æ˜ å°„åˆ°æ¯ä¸ªé…ç½®æ–‡ä»¶çš„è·¯å¾„:ç”¨äºç”¨ AOT ç¼–è¯‘å™¨æ„å»º Angular çš„ tsconfig.json å’Œç”¨äºæ†ç»‘åº”ç”¨ç¨‹åºçš„ closure.confã€‚

```
{  "$schema":  "http://json-schema.org/schema",  "title":  "Closure Compiler Builder.",  "description":  "Closure Compiler Builder schema for Architect.",  "type":  "object",  "properties":  {  "tsConfig":  {  "type":  "string",  "description":  "The path to the Closure configuration file."  },  "closureConfig":  {  "type":  "string",  "description":  "The path to the Closure configuration file."  },  },  "additionalProperties":  false,  "required":  [  "tsConfig",  "closureConfig"  ]  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#intro-to-builder-api)æ„å»ºå™¨ API ç®€ä»‹

src/closure/index.ts æ˜¯æ„å»ºå™¨é€»è¾‘æ‰€åœ¨çš„ä½ç½®ã€‚

æ„å»ºå™¨æ˜¯ç”¨ TypeScript ç¼–ç çš„ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ API ä¸»è¦ç”±@angular-devkit/architect å’Œ node æä¾›ã€‚ç¼–ç æ„å»ºå™¨ä»¤äººæƒŠå¹çš„åœ°æ–¹åœ¨äºï¼Œè¯­æ³•å¯¹äºç¼–å†™ Angular åº”ç”¨ç¨‹åºçš„äººæ¥è¯´æ˜¯éå¸¸ç†Ÿæ‚‰çš„ã€‚æ„å»ºè€…å¤§é‡ä½¿ç”¨æ¥è‡ª rxjs çš„å¯è§‚å¯Ÿæ¨¡å¼ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„å¯¼å…¥ã€‚

å°†è¢«ä¼ é€’åˆ°æ„å»ºè¿‡ç¨‹çš„æ¯ä¸€æ­¥ã€‚

`BuilderOutput`æ˜¯åœ¨è¿‡ç¨‹ç»“æŸæ—¶ï¼Œä»å¯è§‚å¯Ÿçš„äº‹ç‰©ä¸­æœ€ç»ˆè¿”å›çš„ä¸œè¥¿ã€‚

`createBuilder`æ˜¯ä¸€ä¸ªæˆ‘ä»¬è°ƒç”¨æ¥åˆ›å»ºä¸€ä¸ªæ„å»ºå™¨å®ä¾‹çš„æ–¹æ³•ã€‚æ„å»ºè€…æœ‰ä¸€ä¸ª APIï¼Œå¯ä»¥å®ç°æ—¥å¿—è®°å½•ã€è¿›åº¦è·Ÿè¸ªå’Œæ„å»ºè®¡åˆ’ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ rxjs ä¸­çš„`Observable`ã€`of`ã€`catchError`ã€`mapTo`å’Œ`concatMap`ã€‚

`exec`ã€`normalize`ã€`readFileSync`ä»æ ‡å‡†èŠ‚ç‚¹åŒ…(åˆ†åˆ«ä¸º child_processã€pathã€fs)å¯¼å…¥ã€‚è¿™äº›å·¥å…·å°†å…è®¸æˆ‘ä»¬åƒåœ¨å‘½ä»¤è¡Œ(â€œexecâ€)ä¸Šè¾“å…¥å‘½ä»¤ä¸€æ ·æ‰§è¡Œå‘½ä»¤ï¼Œé€šè¿‡`normalize`ç­‰æ–¹æ³•å®ç°è·¨å¹³å°çš„æ–‡ä»¶è·¯å¾„å¤„ç†ï¼Œå¹¶ä¸”`readFileSync`ä½¿æˆ‘ä»¬èƒ½å¤ŸåŒæ­¥è¯»å–æ–‡ä»¶ã€‚

```
import { BuilderContext, BuilderOutput, createBuilder } from '@angular-devkit/architect/src/index2';
import { Observable, of } from 'rxjs';
import { catchError, mapTo, concatMap } from 'rxjs/operators';
import { exec } from 'child_process';
import { normalize } from 'path';
import { readFileSync } from 'fs'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œåœ¨ build_tools/src/closure ä¸­åˆ›å»ºä¸€ä¸ªåä¸º schema.interface.ts çš„æ–°æ–‡ä»¶ï¼Œå¹¶ä¸º TypeScript å£°æ˜ä¸€ä¸ªé•œåƒæˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ json-schema çš„æ¥å£ã€‚æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥ä½¿ç”¨ json-schema ä»£æ›¿ TypeScript æ¥å£ï¼Œä½†æ˜¯ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åªå°†æ¨¡å¼å£°æ˜ä¸ºä¸€ä¸ªæ¥å£ã€‚

```
export interface ClosureBuilderSchema {
  tsConfig: string;
  closureConfig: string;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¼å…¥æ–°æ¨¡å¼ã€‚

```
import { ClosureBuilderSchema } from './schema.interface'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ä¸ºæ„å»ºå™¨å’Œæ‰§è¡Œæ„å»ºçš„å›è°ƒå‡½æ•°å£°æ˜ä¸€ä¸ªå¯¼å‡ºã€‚

```
export function executeClosure(
  options: ClosureBuilderSchema,
  context: BuilderContext
): Observable<BuilderOutput> {
  return of(context).pipe(
    mapTo({ success: true }),
    catchError(error => {
      context.reportStatus('Error: ' + error);
      return [{ success: false }];
    }),
  );
}

export default createBuilder<Record<string, string> & ClosureBuilderSchema>(executeClosure); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`executeClosure`å¸¦ä¸¤ä¸ªå‚æ•°:`options`å’Œ`context`ã€‚

| äº‰åµ | æè¿° |
| --- | --- |
| é€‰æ‹© | ä» angular.json ä¼ å…¥çš„é€‰é¡¹ |
| è¯­å¢ƒ | å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ„å»ºå™¨çš„ä¸Šä¸‹æ–‡ |

`executeClosure`è¿”å›ä¸€ä¸ª rxjs `Observable`ã€‚

å¦‚æœæ„å»ºæˆåŠŸï¼Œ`mapTo`é€šè¿‡`{success: true}`åœ¨ç»ˆç«¯æ˜¾ç¤ºåé¦ˆã€‚

å¦‚æœæ„å»ºè¿‡ç¨‹ä¸­çš„ä»»ä½•ä¸€æ­¥å‡ºé”™ï¼Œå°±ä¼šè°ƒç”¨`catchError`ã€‚

### [](#compiling-the-project-source)ç¼–è¯‘é¡¹ç›®æº

åœ¨ build_tools ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª tsconfig.jsonï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç¼–è¯‘åˆšåˆšç¼–å†™çš„ TypeScriptã€‚

```
{  "compileOnSave":  false,  "buildOnSave":  false,  "compilerOptions":  {  "baseUrl":  "",  "rootDir":  ".",  "target":  "es2018",  "module":  "commonjs",  "moduleResolution":  "node",  "noEmitOnError":  true,  "noImplicitAny":  false,  "removeComments":  false,  "resolveJsonModule":  true,  "esModuleInterop":  true,  "skipLibCheck":  true,  "strictNullChecks":  true,  "declaration":  true  },  "lib":  [  "es2018"  ],  "typeRoots":  [  "./node_modules/@types"  ],  "types":  [  "node",  "json-schema"  ],  "include":  [  "./src/**/*.ts"  ],  "exclude":  [  "./src/closure/schema.interface.ts"  ]  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ build_tools ç›®å½•ä¸­ä½¿ç”¨`tsc`å‘½ä»¤æ¥æ„å»ºé¡¹ç›®ã€‚

```
tsc -p tsconfig.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥è¿è¡Œ watcher æ¥æ„å»ºæ¯ä¸ªæ–‡ä»¶æ›´æ”¹ã€‚

```
tsc -p tsconfig.json --watch 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨é¡¹ç›®å»ºå¥½äº†ï¼

ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™ä¸ªä¾‹å­ä¸­çš„æ–‡ä»¶æ˜¯å°±åœ°ç¼–è¯‘çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨`compilerOptions`ä¸Šè®¾ç½®`outDir`å‚æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬è¿˜éœ€è¦å°†ä»»ä½• schema.json å’Œ package.json å¤åˆ¶åˆ°ä¸€ä¸ªåˆ†å‘æ–‡ä»¶å¤¹ä¸­ã€‚

### [](#configuring-angularjson)é…ç½® angular.json

å›åˆ°æˆ‘ä»¬æ­å»ºçš„é¡¹ç›®çš„å·¥ä½œåŒºï¼Œé…ç½® angular.jsonã€‚æˆ‘ä»¬éœ€è¦å‘Šè¯‰é¡¹ç›®å°†æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ ClosureBuilder æŒ‡å‘å“ªé‡Œã€‚

åœ¨â€œarchitectâ€é…ç½®ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºâ€œclosure_buildâ€çš„æ–°å±æ€§ã€‚

å°†æ–°çš„â€œclosure_buildâ€å¯¹è±¡çš„â€œbuilderâ€å±æ€§è®¾ç½®ä¸ºâ€œâ€ã€‚/build_tools:closureã€‚

ã€‚/build _ tools,â€œclosureâ€æ˜¯å› ä¸ºæˆ‘ä»¬çš„ Architect é¡¹ç›®çš„ package.json å°±åœ¨é‚£é‡Œï¼Œè€Œâ€œclosureâ€æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è¦è¿è¡Œåä¸ºâ€œclosureâ€çš„æ„å»ºå™¨ã€‚æˆ‘ä»¬é…ç½®äº†ä½äº'çš„ builders.jsonã€‚/build_tools'ã€‚å¦‚æœã€‚/build_tools 'ç›®å½•å·²å‘å¸ƒï¼Œæˆ‘ä»¬é€šè¿‡å¯ä»¥æ›¿æ¢çš„ npm å®‰è£…åŒ…ã€‚/build_toolsâ€ä»¥åŠåŒ…åã€‚

åœ¨â€œclosureâ€å¯¹è±¡ä¸Šåˆ›å»ºå¦ä¸€ä¸ªå±æ€§ï¼Œå¹¶å°†å…¶å‘½åä¸ºâ€œoptionsâ€ã€‚åœ¨è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œä¸º angular é¡¹ç›®é…ç½®é—­åŒ…é…ç½®(æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œæˆ)å’Œ tsconfig çš„è·¯å¾„ã€‚

å®Œæˆå angular.json åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚

```
"architect":  {  "closure_build":  {  "builder":  "./build_tools:closure",  "options":  {  "closureConfig":  "closure.conf",  "tsConfig":  "src/tsconfig.app.json"  }  }  ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å…¨å±€å®‰è£…çš„@angular-devkit/architect-cli åŒ…ï¼Œé€šè¿‡å‘å‘½ä»¤`architect`ä¼ é€’å·¥ä½œåŒºåç§°(build_repo)å’Œæˆ‘ä»¬åˆšåˆšåœ¨ angular.json ä¸­å»ºç«‹çš„ç›®æ ‡(closure_build)æ¥æµ‹è¯•æ„å»ºå™¨æ­£åœ¨å·¥ä½œã€‚

```
architect build_repo:closure_build 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å»ºç­‘å¸ˆåº”è¯¥åœ¨ç»ˆç«¯æ‰“å°æˆåŠŸã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹ã€‚

```
SUCCESS
Result: {
    "success": true,
    "target": {
        "project": "build_repo",
        "target": "closure_build"
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#what-is-going-on-here)è¿™åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ

Architect CLI å…è®¸æˆ‘ä»¬åœ¨å·¥ä½œåŒºä¸­æµ‹è¯•æ„å»ºå™¨æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚`architect`å‘½ä»¤ç›¸å½“äºä»»ä½•å…¸å‹@angular/cli å·¥ä½œç©ºé—´ä¸­çš„`ng run`ã€‚æˆ‘ä»¬çœ‹åˆ°æˆåŠŸçš„åŸå› æ˜¯ï¼Œæ„å»ºå™¨æ‰€åšçš„åªæ˜¯å°†æˆ‘ä»¬åˆ›å»ºçš„å¯è§‚å¯Ÿå¯¹è±¡æ˜ å°„åˆ°ä¸­çš„æˆåŠŸæ¶ˆæ¯ã€‚/build _ tools/src/closure/index . ts

```
return of(context).pipe(
  mapTo({ success: true }),
  catchError(error => {
    context.reportStatus('Error: ' + error);
    return [{ success: false }];
  }),
); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä»ç„¶éœ€è¦å¯¹æˆ‘ä»¬çš„æ„å»ºè¿›è¡Œç¼–ç ï¼Œä½†æ˜¯è‡³å°‘æˆ‘ä»¬çŸ¥é“è„šæ‰‹æ¶æ˜¯æœ‰æ•ˆçš„ï¼

ä¸ºäº†ç»§ç»­æµ‹è¯•æ„å»ºè¿è¡Œï¼Œåœ¨`build_tools`ç›®å½•ä¸­è¿è¡Œ`tsc -p tsconfig.json --watch`ã€‚
åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œåœ¨æ¯æ¬¡å¢é‡æ„å»º typescript åè¿è¡Œ`architect build_repo:closure_build`ã€‚

## [](#coding-builders-with-rxjs-observables-and-nodejs)ç”¨ RxJS Observables å’Œ Node.js ç¼–ç æ„å»ºå™¨

ä¹‹å‰æˆ‘ä»¬å·²ç»ç¡®å®š ClosureBuilder å°†ä½¿ç”¨è¿”å› RxJS å¯è§‚å¯Ÿå€¼çš„`executeClosure`æ–¹æ³•æ‰§è¡Œæ„å»ºã€‚è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªæˆ‘ä»¬åº”è¯¥è€ƒè™‘çš„é—®é¢˜ã€‚å¯è§‚å¯Ÿå¯¹è±¡æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯æ„å»ºé€šå¸¸æœ‰ä¸€ç»„å¿…é¡»åŒæ­¥è¿è¡Œçš„æŒ‡ä»¤ã€‚å½“ç„¶ï¼Œåœ¨å¼‚æ­¥æ‰§è¡Œæ„å»ºä»»åŠ¡çš„ç”¨ä¾‹ä¸­ï¼Œå¯è§‚æµ‹é‡ä¼šæ´¾ä¸Šç”¨åœºã€‚æˆ‘ä»¬å°†åœ¨ä»¥åçš„æ–‡ç« ä¸­æ¢è®¨å¼‚æ­¥ç”¨ä¾‹ã€‚ç°åœ¨æˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸€ç³»åˆ—æ­¥éª¤ã€‚ä¸ºäº†ç”¨ RxJS æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`concatMap`æ“ä½œç¬¦ï¼Œä¾‹å¦‚:

```
 return of(context).pipe(
    concatMap( results => ngc(options, context)),
    concatMap( results => compileMain(options, context)),
    concatMap( results => closure(options, context) ),
    mapTo({ success: true }),
    catchError(error => {
      context.reportStatus('Error: ' + error);
      return [{ success: false }];
    }),
  ); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAOT ç¼–è¯‘å™¨å°†æ‰§è¡Œï¼Œç„¶åæ˜¯æ ¼å¼åŒ–`main.js`çš„æ­¥éª¤ï¼Œæœ€åæ˜¯æ‰§è¡Œ Closure ç¼–è¯‘å™¨æ¥æ†ç»‘å’Œä¼˜åŒ–åº”ç”¨çš„æ­¥éª¤ã€‚

@angular/cli å›¢é˜Ÿæ˜¾ç„¶è®¤ä¸ºï¼Œä»»ä½•ç¼–å†™ angular åº”ç”¨ç¨‹åºçš„äººéƒ½åº”è¯¥ç†Ÿæ‚‰ç¼–å†™æ„å»ºå™¨çš„ä»£ç ã€‚åŒæ„çš„ç²‰ä¸ä¸º API ç¥é­‚é¢ å€’ï¼

å› ä¸ºè¿™ä¸ªè§‚ç‚¹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç„¶è€Œè¿™æ˜¯ä¸€ä¸ªå®¹æ˜“è§£å†³çš„é—®é¢˜ã€‚

é—®é¢˜:

node . js æ‰¿è¯ºã€‚

å»ºè®¾è€…â¤ï¸ RxJS å¯è§‚ã€‚

è§£å†³æ–¹æ¡ˆ 1:

RxJS å¯è§‚å¯Ÿå€¼ä¸æ‰¿è¯ºå¯äº’æ“ä½œã€‚

`of(new Promise())`æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚RxJs å°†ä¸ºæˆ‘ä»¬åœ¨å¹•åå°†æ‰¿è¯ºè½¬åŒ–ä¸ºå¯è§‚å¯Ÿåˆ°çš„ä¸œè¥¿ã€‚

è§£å†³æ–¹æ¡ˆ 2:

æˆ‘ä»¬å¯ä»¥å°†åŸºäºæ‰¿è¯ºçš„å·¥ä½œæµè½¬åŒ–ä¸ºå¯è§‚å¯Ÿçš„å·¥ä½œæµã€‚

è€ƒè™‘è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Node.js `exec`æ–¹æ³•è°ƒç”¨ AOT ç¼–è¯‘å™¨ã€‚`ngc`æ–¹æ³•è¿”å›ä¸€ä¸ª`Observable`ã€‚

åœ¨`Observable`å›è°ƒä¸­ï¼Œæˆ‘ä»¬ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚ç¨‹åºè¿è¡Œ execï¼Œæ‰§è¡Œ`ngc -p tsconfig.app.json`å‘½ä»¤ï¼Œå°±åƒæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸­è¾“å…¥å®ƒä¸€æ ·ã€‚

å¦‚æœ AOT ç¼–è¯‘å¯¼è‡´é”™è¯¯ï¼Œæˆ‘ä»¬è°ƒç”¨`observer.error()`ã€‚

å¦‚æœ AOT ç¼–è¯‘æˆåŠŸï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`observer.next()`ã€‚

```
export function ngc(
  options: AbstractBuilderSchema | RollupBuilderSchema | ClosureBuilderSchema,
  context: BuilderContext
): Observable<{}> {

    return new Observable((observer) => {

        exec(normalize(context.workspaceRoot +'/node_modules/.bin/ngc') +
             ' -p ' + options.tsConfig,
             {},
             (error, stdout, stderr) => {
              if (stderr) {
                  observer.error(stderr);
              } else {
                  observer.next(stdout);
              }
        });

    });

} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ä¸Šè¿°æ–¹æ³•è¢«æ’å…¥åˆ°`executeClosure`ä¸­çš„å¯è§‚å¯Ÿåœ°å›¾æ“ä½œç¬¦ä¸­æ—¶ï¼Œè¯¥æ­¥éª¤å°†è¿è¡Œï¼

```
 return of(context).pipe(
    concatMap( results => ngc(options, context)), 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬çœ‹å‡ ä¸ªç”¨ Closure ç¼–è¯‘å™¨æ„å»ºåº”ç”¨ç¨‹åºçš„æ„å»ºæ­¥éª¤çš„ä¾‹å­ã€‚

æˆ‘ä»¬ä¹‹å‰åœ¨æ¦‚å¿µå±‚é¢ä¸Šæ¦‚è¿°äº†æ„å»ºæ­¥éª¤ï¼Œä½†æ˜¯è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°å†çœ‹ä¸€éã€‚

### [](#angular-compiler)è§’åº¦ç¼–è¯‘å™¨

Angular æ˜¯æå‰ç”¨ AOT ç¼–è¯‘å™¨ä¸ºç”Ÿäº§è€Œæ„å»ºçš„ã€‚AOT ç¼–è¯‘ä¼šäº§ç”Ÿæ›´å°çš„åŒ…ï¼Œæ¯” JIT æ›´å®‰å…¨ï¼Œå¯¹æˆ‘ä»¬çš„ä¾‹å­æ¥è¯´æœ€é‡è¦çš„æ˜¯ï¼Œå¯ä»¥ä¸é—­åŒ…ç¼–è¯‘å™¨ä¸€èµ·å·¥ä½œï¼AOT ç¼–è¯‘å™¨ä½¿ç”¨ä¸€ä¸ªå«åš tsickle çš„å·¥å…·æ¥ç¿»è¯‘ TypeScript ç±»å‹çš„æ³¨é‡Šã€‚

ä¸ºäº†é…ç½® AOT ç¼–è¯‘å™¨è¾“å‡ºæ³¨é‡Šé—­åŒ…ç¼–è¯‘å™¨éœ€è¦åœ¨ ADVANCED_OPTIMIZATIONS æ¨¡å¼ä¸‹ä¼˜åŒ–çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨è§’åº¦å·¥ä½œç©ºé—´ tsconfig.app.json ä¸­æ·»åŠ äº†ä¸¤ä¸ªé…ç½®é€‰é¡¹

```
"angularCompilerOptions":  {  "annotationsAs":  "static fields",  "annotateForClosureCompiler":  true  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å›åˆ° build _ tools/src/closure/index . tsï¼Œå¯¼å…¥`exec`ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ AOT ç¼–è¯‘å™¨ï¼Œå¯¼å…¥`normalize`ä»¥ä¾¿æˆ‘ä»¬ä½¿ç”¨çš„ä»»ä½•è·¯å¾„éƒ½æ˜¯è·¨å¹³å°å…¼å®¹çš„ï¼Œè¿™æ„å‘³ç€åœ¨ Windows ä¸Šè¿è¡Œæ„å»ºçš„ç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„è„šæœ¬ã€‚

```
import { exec } from 'child_process';
import { normalize } from 'path'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åšä¸€ä¸ªåä¸º ngc çš„æ–°å‡½æ•°ï¼Œç»™å®ƒä¸¤ä¸ªè‡ªå˜é‡:`options`å’Œ`context`ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ªæ„å»ºæ­¥éª¤éƒ½å°†é‡‡ç”¨è¿™ä¸¤ä¸ªå‚æ•°ã€‚`options`æ˜¯ç”¨æˆ·é€šè¿‡ angular.json ä¼ å…¥çš„é€‰é¡¹ï¼Œè€Œ`context`æä¾›äº†å½“å‰`BuilderContext`ä¸Šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬ 2 éƒ¨åˆ†è¯¦ç»†ä»‹ç»å…¶ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚

ç°åœ¨æˆ‘ä»¬è¿”å›ä¸€ä¸ªè°ƒç”¨`exec`çš„`Observable`ï¼Œåœ¨æˆ‘ä»¬çš„å·¥ä½œç©ºé—´ä¸­ä¼ é€’ä¸€ä¸ªåˆ°`ngc`çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åä½¿ç”¨`-p`å‚æ•°ä¼ é€’ä¸€ä¸ªç±»å‹è„šæœ¬é…ç½®ã€‚

```
 export function ngc(
  options: AbstractBuilderSchema | RollupBuilderSchema | ClosureBuilderSchema,
  context: BuilderContext
): Observable<{}> {

  return new Observable((observer) => {

    exec(`${normalize(context.workspaceRoot +'/node_modules/.bin/ngc')} -p ${options.tsConfig}`,
          {},
          (error, stdout, stderr) => {
          if (stderr) {
              observer.error(stderr);
          } else {
              observer.next(stdout);
          }
    });

  });

} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªæ“ä½œåŠ å…¥åˆ°`executeClosure`å‡½æ•°ä¸­ã€‚

```
 return of(context).pipe(
    concatMap( results => ngc(options, context)), 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„å»ºé¡¹ç›®ã€‚

```
tsc -p tsconfig.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ Angular å·¥ä½œåŒºä¸­ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåœ¨è¿è¡Œ Architect CLI åçœ‹åˆ°ä¸€ä¸ªåä¸º`out-tsc`çš„æ–°ç›®å½•ã€‚

```
architect build_repo:closure_build 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªç›®å½•å°†è¢«æ‰©å±•åä¸º`ngfactory.js`çš„ AOT ç¼–è¯‘ä»£ç å¡«å……ã€‚æˆ‘ä»¬æ‰€æœ‰çš„åº”ç”¨ç¨‹åºé€»è¾‘éƒ½è¢«ç¼–è¯‘åˆ°è¿™äº›æ–‡ä»¶ä¸­ã€‚

å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿæå‰ç¼–è¯‘çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç° out-tsc/src/main.js ä¸­ Angular åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹æœ‰é—®é¢˜

```
platformBrowserDynamic().bootstrapModule(AppModule) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¥å£ç‚¹ä»ç„¶å¼•ç”¨ out-tsc/src/app/app.module.js ä¸­çš„`AppModule`ã€‚æˆ‘ä»¬éœ€è¦æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä½¿ç”¨ out-TSC/src/app/app . module . ngfactory . js ä¸­æå‰ç¼–è¯‘çš„`AppModuleNgFactory`è¿›è¡Œå¼•å¯¼ã€‚

@angular/cli ä¼šåœ¨æˆ‘ä»¬è¿è¡Œ`ng serve`æˆ–`ng build`æ—¶è‡ªåŠ¨ä¸ºæˆ‘ä»¬å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰æ„å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±è½¬æ¢ main.jsã€‚

### [](#format-mainjs)æ ¼å¼ main.js

æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•ä»ç£ç›˜è¯»å–æºæ–‡ä»¶`main.ts`ï¼Œæ‰¾åˆ°å¹¶æ›¿æ¢æ–‡ä»¶å†…å®¹çš„ä¸€éƒ¨åˆ†ï¼Œç¼–è¯‘ç±»å‹è„šæœ¬ï¼Œç„¶åå°†è½¬æ¢åçš„æ–‡ä»¶å†™å…¥ç£ç›˜ã€‚

å¹¸è¿çš„æ˜¯ï¼Œtypescript å·²ç»æ˜¯é¡¹ç›®çš„ä¸€ä¸ªä¾èµ–é¡¹ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå¯¼å…¥åˆ° build _ tools/src/closure/index . ts ä¸­ã€‚

å¯¹äºæ‰€æœ‰çš„æ–‡ä»¶ç®¡ç†ä»»åŠ¡ï¼Œæˆ‘ä»¬åœ¨ fs ä¸­æœ‰ä¸€äº›æ–¹ä¾¿çš„ Node.js å‡½æ•°(`readFileSync`ã€`writeFile`å’Œ`readFile`)ã€‚

```
import * as ts from 'typescript';
import { readFileSync, writeFile, readFile } from 'fs'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªæ“ä½œæ¯”ä¸Šä¸€ä¸ªä¾‹å­ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯æ ¼å¼æ˜¯ä¸€æ ·çš„ã€‚åœ¨`compileMain`å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡è¿”å›ä¸€ä¸ªå¯è§‚å¯Ÿå€¼ã€‚ä»ç£ç›˜ä¸­è¯»å– main.ts æºæ–‡ä»¶ï¼Œæ›¿æ¢æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬é…ç½®çš„ tsconfig ä¸­çš„ç¼–è¯‘å™¨é€‰é¡¹ä¼ è¾“å†…å®¹ï¼Œæœ€åå°†æ–‡ä»¶å†™å…¥ç£ç›˜çš„ out-tsc ç›®å½•ä¸­ï¼Œæ›¿æ¢ AOT ç¼–è¯‘å™¨æœ€åˆè¾“å‡ºçš„æ–‡ä»¶ã€‚

```
export function compileMain(
  options: AbstractBuilderSchema | RollupBuilderSchema | ClosureBuilderSchema,
  context: BuilderContext
): Observable<{}> {

  return new Observable((observer) => {

      const inFile = normalize(context.workspaceRoot+'/src/main.ts');
      const outFile = normalize('out-tsc/src/main.js');
      const tsConfig = JSON.parse(readFileSync(join(context.workspaceRoot, options.tsConfig), 'utf8'));

      readFile(inFile, 'utf8', (err, contents) => {

          if (err) observer.error(err);

          contents = contents.replace(/platformBrowserDynamic/g, 'platformBrowser');
          contents = contents.replace(/platform-browser-dynamic/g, 'platform-browser');
          contents = contents.replace(/bootstrapModule/g, 'bootstrapModuleFactory');
          contents = contents.replace(/AppModule/g, 'AppModuleNgFactory');
          contents = contents.replace(/.module/g, '.module.ngfactory');

          const outputContent = ts.transpileModule(contents, {
            compilerOptions: tsConfig.compilerOptions,
            moduleName: 'app'
          })

          writeFile(outFile, outputContent.outputText, (err) => {
              if (err) observer.error(err);
              observer.next(outputContent.outputText);
          });

      });

  });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†`compileMain`æ–¹æ³•æ·»åŠ åˆ°ç®¡é“ã€‚

```
return of(context).pipe(
  concatMap( results => ngc(options, context) ),
  concatMap( results => compileMain(options, context) ),
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„å»ºé¡¹ç›®ã€‚

```
tsc -p tsconfig.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿è¡Œ Architect CLIã€‚

```
architect build_repo:closure_build 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

out-tsc/src/main.js ä¸­çš„æ–‡ä»¶åº”è¯¥åœ¨`platformBrowser`ä¸Šè°ƒç”¨ä¸€ä¸ª`bootstrapModuleFactory`æ–¹æ³•ï¼Œå¹¶ä¼ å…¥`AppModuleNgFactory`ã€‚

```
platformBrowser().bootstrapModuleFactory(AppModuleNgFactory) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬çš„åŒ…çš„å…¥å£ç‚¹å·²ç»ä¸º AOT ç¼–è¯‘æ­£ç¡®æ ¼å¼åŒ–äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œé—­åŒ…ç¼–è¯‘å™¨äº†ã€‚

### [](#closure-compiler)é—­åŒ…ç¼–è¯‘å™¨

ä¸ºäº†ä½¿ç”¨ Closure ç¼–è¯‘å™¨è¿›è¡Œæ„å»ºï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ Angular å·¥ä½œç©ºé—´çš„æ ¹ç›®å½•ä¸­ç¼–å†™ä¸€ä¸ªåä¸º closure.conf çš„é…ç½®æ–‡ä»¶ã€‚

### [](#closureconf)closure.conf

closure.conf æ–‡ä»¶ä»¥ä¸‹åˆ—æ–¹å¼é…ç½®é—­åŒ…ç¼–è¯‘å™¨:

*   ä¸ºæ„å»ºè®¾ç½®å¯é€‰å‚æ•°(-ç¼–è¯‘çº§åˆ«ï¼Œ-åˆ›å»ºæºæ˜ å°„ç­‰)
*   å£°æ˜ä¾èµ–é¡¹å’Œå¤–éƒ¨æ–‡ä»¶(- js å’Œ- externs)
*   æºæ–‡ä»¶çš„ä½ç½®(AOT ç¼–è¯‘çš„åº”ç”¨ç¨‹åºåœ¨/out-tsc ç›®å½•ä¸­)
*   åŒ…çš„å…¥å£ç‚¹(- entry_point)
*   ç”¨äºè§£æèŠ‚ç‚¹ç¨‹åºåŒ…çš„é€‰é¡¹(- module_resolutionï¼Œ- package_json_entry_names)

è¿™ä¸ªç‰¹æ®Šçš„ closure.conf é€‚ç”¨äº angular åŒ…~ 8 . 0 . 0-beta 10 .

```
--compilation_level=ADVANCED_OPTIMIZATIONS
--language_out=ECMASCRIPT5
--variable_renaming_report=closure/variable_renaming_report
--property_renaming_report=closure/property_renaming_report
--create_source_map=%outname%.map

--warning_level=QUIET
--dependency_mode=STRICT
--rewrite_polyfills=false
--jscomp_off=checkVars

--externs node_modules/zone.js/dist/zone_externs.js

--js node_modules/tslib/package.json
--js node_modules/tslib/tslib.es6.js

--js node_modules/rxjs/package.json
--js node_modules/rxjs/_esm2015/index.js
--js node_modules/rxjs/_esm2015/internal/**.js
--js node_modules/rxjs/operators/package.json
--js node_modules/rxjs/_esm2015/operators/index.js

--js node_modules/@angular/core/package.json
--js node_modules/@angular/core/fesm2015/core.js

--js node_modules/@angular/common/package.json
--js node_modules/@angular/common/fesm2015/common.js

--js node_modules/@angular/platform-browser/package.json
--js node_modules/@angular/platform-browser/fesm2015/platform-browser.js

--js node_modules/@angular/forms/package.json
--js node_modules/@angular/forms/fesm2015/forms.js

--js node_modules/@angular/common/http/package.json
--js node_modules/@angular/common/fesm2015/http.js

--js node_modules/@angular/router/package.json
--js node_modules/@angular/router/fesm2015/router.js

--js node_modules/@angular/animations/package.json
--js node_modules/@angular/animations/fesm2015/animations.js

--js node_modules/@angular/animations/browser/package.json
--js node_modules/@angular/animations/fesm2015/browser.js

--js node_modules/@angular/platform-browser/animations/package.json
--js node_modules/@angular/platform-browser/fesm2015/animations.js

--js out-tsc/**.js

--module_resolution=node
--package_json_entry_names jsnext:main,es2015
--process_common_js_modules

--entry_point=./out-tsc/src/main.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº† closure.confï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ build _ tools/src/closure/index . ts ä¸­ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥æ‰§è¡Œæˆ‘ä»¬ä¹‹å‰å®‰è£…çš„ google-closure-compiler-java åŒ…ä¸­çš„ Java åº”ç”¨ç¨‹åºã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä»`BuilderContext`å¼€å§‹ã€‚æˆ‘ä»¬å¼•ç”¨å½“å‰çš„`target`å’Œ`project`ï¼Œæ ¹æ® angular.json.
ä¸­çš„é…ç½®æ¥é…ç½®æœ€ç»ˆåŒ…çš„è¾“å‡ºä½ç½®

```
export function closure(
   options: ClosureBuilderSchema,
   context: BuilderContext
): Observable<{}> {

  return new Observable((observer) => {

    const target = context.target ? context.target : { project: 'app' };
    const jarPath = options.jarPath ? options.jarPath : join('node_modules', 'google-closure-compiler-java', 'compiler.jar');
    const confPath = options.closureConfig;
    const outFile = `./dist/${target.project}/main.js`;

    exec(`java -jar ${jarPath} --flagfile ${confPath} --js_output_file ${outFile}`,
        {},
        (error, stdout, stderr) => {
          if (stderr.includes('ERROR')) {
            observer.error(error);
          }
          observer.next(stdout);
        });
    })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†æ–°çš„`closure`å‡½æ•°æ·»åŠ åˆ°`executeClosure`ä¸­çš„ç®¡é“ã€‚

```
 return of(context).pipe(
  concatMap( results => ngc(options, context) ),
  concatMap( results => compileMain(options, context) ),
  concatMap( results => closure(options, context) )
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ„å»ºé¡¹ç›®ã€‚

```
tsc -p tsconfig.json 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿è¡Œ Architect CLIã€‚

```
architect build_repo:closure_build 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

# [](#great-scott)ä¼Ÿå¤§çš„æ–¯ç§‘ç‰¹ï¼

[![](../Images/ae32683685857c68bea358ed5038b46d.png)T2ã€‘](https://i.giphy.com/media/3o7aCRBQC8u5GaW092/giphy.gif)

## [](#angularcli-is-optimizing-a-bundle-with-closure-compiler)@angular/cli æ­£åœ¨ç”¨é—­åŒ…ç¼–è¯‘å™¨ä¼˜åŒ–ä¸€ä¸ª bundleï¼

è®©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹åœ¨ä¸€åœºå¹´ä»£ä¹‹æˆ˜ä¸­åˆ›å»ºçš„æ†ç»‘åŒ…ã€‚

### [](#webpack-vs-closure-compiler)Webpack ä¸é—­åŒ…ç¼–è¯‘å™¨

[![](../Images/b9dd71940a1d0c038408d6d7a0db114e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--4LJZGvBt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/oc2vdqxqoxv76c0dhbxo.png)

Webpack å’Œ Terser æ†ç»‘ä¼˜åŒ–äº† app ~43.3Kb(gzipped)ã€‚

[![](../Images/b447a02e2c31f17cb8b975b4a9a9c401.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--oV3rbSXt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/r00tdlcrbumb4lfvzcmo.png)

Closure ç¼–è¯‘å™¨æ†ç»‘ä¼˜åŒ–äº† app ~37.3Kb (gzipped)ã€‚

# [](#14-reduction-in-bundle-size)~æŸå°ºå¯¸å‡å°‘ 14%

å¯¹äºè¿™ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªåŒ…è¦å° 14%!åœ¨è¿™ä¸ªè§„æ¨¡ä¸Šï¼Œè¿™ 14%å¯ä»¥å¸¦æ¥å®å®åœ¨åœ¨çš„å˜åŒ–ã€‚è¿™äº›ä¼°è®¡åŒ…æ‹¬ç”¨@ angular-dev kit/build-optimizer è¿›è¡Œçš„ä¼˜åŒ–ï¼Œå¹¶ä½¿ç”¨ gzip å‹ç¼©ã€‚æˆ‘è§è¿‡å…¶ä»–åº”ç”¨ç¨‹åºï¼ŒClosure Compiler ä½¿æ†ç»‘åŒ…æ¯”åŒæ ·çš„åº”ç”¨ç¨‹åºç¼©å°äº† 20%ã€‚

ä½¿ç”¨é—­åŒ…ç¼–è¯‘å™¨ä»£æ›¿ Webpack è¿˜æœ‰å…¶ä»–ä¼˜ç‚¹ã€‚Closure æä¾›äº†å…³äºæ½œåœ¨å±é™©æ¼æ´çš„è­¦å‘Šã€‚è¿™æœ‰åŠ©äºä¿æŒ web åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚Closure Compiler è¿˜ä»¥æœ‰è¶£çš„æ–¹å¼ä¼˜åŒ–äº† JavaScriptï¼Œå¯¹å®é™…ä»£ç è¿›è¡Œäº†è½¬æ¢ï¼Œä½¿å…¶åœ¨æµè§ˆå™¨ä¸­çš„è¿è¡Œæ›´åŠ é«˜æ•ˆã€‚

## [](#conclusion)ç»“è®º

åœ¨ã€Šåƒå»ºç­‘å¸ˆä¸€æ ·æ„å»º Angular ã€‹(ç¬¬ 1 éƒ¨åˆ†)ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•ç¼–å†™ä¸€ä¸ªæ„å»ºå™¨å¹¶ä½¿ç”¨ Architect CLI æ‰§è¡Œæ„å»ºã€‚æˆ‘ä»¬æ‰©å±•äº†@angular/cli æ¥ä¼˜åŒ–å¸¦æœ‰é—­åŒ…ç¼–è¯‘å™¨çš„äº§å“åŒ…ã€‚

Github ä¸Šæœ‰[åƒå»ºç­‘å¸ˆä¸€æ ·æ„å»º Angular çš„æºä»£ç ã€‚](https://github.com/steveblue/architect)

ä¾æˆ‘æ‹™è§ï¼Œ@angular-devkit/architect æ˜¯è‡ª schematics å‘å¸ƒä»¥æ¥ Angular CLI æœ€å¤§çš„æ”¹è¿›ã€‚Angular CLI å˜å¾—å¦‚æ­¤å¯æ‰©å±•ï¼Œå®ƒç”šè‡³å¯ä»¥æ„å»ºä»»ä½• JavaScript é¡¹ç›®ï¼Œè€Œä¸ä»…ä»…æ˜¯ Angularã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‰©å±• cli æ¥æ‰§è¡Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡çš„ä»»ä½•ä»»åŠ¡ï¼å¯¹äº Angular CLI å›¢é˜Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæƒŠäººçš„å£®ä¸¾ï¼

[![](../Images/7337a8cc70b4cf15789bbd1867819969.png)T2ã€‘](https://i.giphy.com/media/1ylQyCK1qZ63vn0lS0/giphy.gif)

åœ¨[åƒå»ºç­‘å¸ˆä¸€æ ·æ„å»º Angular(ç¬¬ 2 éƒ¨åˆ†)](https://dev.to/steveblue/build-angular-like-an-architect-part-2-208l)ä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹ angular-devkit/build-optimizerï¼Œå¼„æ¸…æ¥šå¦‚ä½•å®ç°ç¯å¢ƒã€‚

## [](#what-do-you-think)ä½ æ€ä¹ˆçœ‹ï¼Ÿ

ä½ å¯¹æ–°å»ºç­‘å¸ˆ CLI æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿ

å¦‚ä½•çœ‹å¾…@angular/cli å˜å¾—å¯æ‰©å±•ï¼Ÿ