# è®©æˆ‘ä»¬åŠ å¯†:Certbot For OpenBSD çš„ httpd

> åŸæ–‡:[https://dev . to/nab bisen/lets-encrypt-cert bot-for-openbsds-httpd-3 ofd](https://dev.to/nabbisen/lets-encrypt-certbot-for-openbsds-httpd-3ofd)

**å°é¢å›¾ç‰‡ç”± [markusspiske](https://pixabay.com/en/users/markusspiske-670330/) åŸåˆ›ï¼Œç»è¿‡ç²¾å¿ƒç¼–è¾‘ã€‚*

## [T1ã€‘ç®€ä»‹](#intro)

[è®©æˆ‘ä»¬åŠ å¯†](https://letsencrypt.org/)æ˜¯â€œä¸€ä¸ªå…è´¹çš„ã€è‡ªåŠ¨åŒ–çš„ã€å¼€æ”¾çš„è®¤è¯æœºæ„â€ã€‚
[Certbot](https://certbot.eff.org/) æ˜¯â€œä¸€ä¸ªæ˜“äºä½¿ç”¨çš„è‡ªåŠ¨å®¢æˆ·ç«¯ï¼Œä¸ºæ‚¨çš„ web æœåŠ¡å™¨è·å–å’Œéƒ¨ç½² SSL/TLS è¯ä¹¦â€ï¼Œè¢«èª‰ä¸ºâ€œå®˜æ–¹çš„ Let's Encrypt clientâ€ã€‚

æˆ‘æ¸…æ¥šåœ°è®°å¾—ï¼Œå½“æˆ‘åœ¨ 2015 å¹´è¯»åˆ° Let's Encrypt çš„[â€œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¯ä¹¦ç°å·²ä¸Šçº¿â€](https://letsencrypt.org/2015/09/14/our-first-cert.html)æ—¶ï¼Œæˆ‘æ„Ÿåˆ°å¤šä¹ˆå…´å¥‹ã€‚
å¤šä¹ˆç²¾å½©[ä»–ä»¬](https://letsencrypt.org/about/)çš„ç›®æ ‡æ˜¯ï¼›å®ƒå°†â€œä¸ºäººä»¬æä¾›ä»–ä»¬éœ€è¦çš„æ•°å­—è¯ä¹¦ï¼Œä»¥ä¾¿å…è´¹å¯ç”¨ç½‘ç«™ HTTPS (SSL/TLS)â€ï¼Œâ€œåˆ›å»ºä¸€ä¸ªæ›´åŠ å®‰å…¨å’Œå°Šé‡éšç§çš„ç½‘ç»œâ€ï¼
ä» 2018 å¹´å¼€å§‹ï¼Œä»–ä»¬ç”šè‡³å¼€å§‹æ”¯æŒ [ACME v2 å’Œé€šé…ç¬¦è¯ä¹¦](https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579)ï¼

å—¯ï¼Œåœ¨ OpenBSD å’Œå…¶ä»–æ“ä½œç³»ç»Ÿä¸­ï¼Œæœ‰ä»–ä»¬çš„å¸®åŠ©å¾ˆå®¹æ˜“ä¹Ÿå¾ˆèˆ’æœğŸ˜Š

### [](#envrionment)ç¯å¢ƒ

*   æ“ä½œç³»ç»Ÿ:OpenBSD 6.4 amd64
*   Web æœåŠ¡å™¨:OpenBSD çš„ httpd
*   è®¤è¯:ç”¨ Certbot 0.27 åŠ å¯†å§

### [](#reference)å¼•ç”¨

*   [OpenBSD çš„ httpd](https://obsd.solutions/en/blog/2018/10/05/openbsd-httpd-63-web-server/index.html)

## [](#how-to-install-certbot)å¦‚ä½•å®‰è£… Certbot

åªæ˜¯:

```
#  pkg_add certbot 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#how-to-obtain-certificates)å¦‚ä½•è·å–è¯ä¹¦

é¦–å…ˆï¼Œæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªç›®å½•ä½œä¸º webroot:

```
#  mkdir /var/www/%your-webroot% 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ç¼–è¾‘ [`/etc/httpd.conf`](https://man.openbsd.org/httpd.conf.5) ä¸ºäº†æ­å»ºä¸€ä¸ª`%your-domain%`çš„ web æœåŠ¡å™¨ç›‘å¬ Let's Encrypt çš„ HTTP æŒ‘æˆ˜è¿›è¡Œè®¤è¯:

```
# [/etc/httpd.conf] 
types {
        include "/usr/share/misc/mime.types"
}

ext_addr = egress

# ... 
cert_domain = %your-domain%
server $cert_domain {
        listen on $ext_addr port 80
        root "/%your-webroot%"
        directory auto index
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åé‡æ–°åŠ è½½é…ç½®:

```
#  rcctl restart httpd 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½çš„ã€‚æˆ‘ä»¬å‡†å¤‡å¥½äº†ã€‚

*(*ä½ ä¸éœ€è¦æš‚æ—¶åœæ­¢ web æœåŠ¡å™¨ç»™[é‡Šæ”¾ç«¯å£ 80 ç»™`--standalone`](https://certbot.eff.org/docs/using.html#standalone) æ„Ÿè°¢`--webroot`ï¼*)*

è®©æˆ‘ä»¬å°è¯•è·å–ä¸€ä¸ªæ–°è¯ä¹¦:

```
#  certbot certonly --webroot -w /var/www/%your-webroot% -d %your-domain% 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æ³¨:æ ¹æ®[æ‰‹å†Œ](https://certbot.eff.org/docs/using.html) :* ï¼Œä¸Šè¿°å­å‘½ä»¤å’Œé€‰é¡¹çš„å«ä¹‰å¦‚ä¸‹

| å­å‘½ä»¤/é€‰é¡¹ | æè¿° |
| --- | --- |
| `certonly` | è·å–æˆ–ç»­è®¢è¯ä¹¦ï¼Œä½†ä¸è¦å®‰è£…å®ƒã€‚ |
| `--webroot` | å°†æ–‡ä»¶æ”¾åœ¨æœåŠ¡å™¨çš„ webroot ç›®å½•ä¸­è¿›è¡Œèº«ä»½éªŒè¯ã€‚ |
| `--webroot-path WEBROOT_PATH`ï¼Œ`-w WEBROOT_PATH` | Webroot / `public_html`è·¯å¾„[s å•ç‹¬]ã€‚ |
| `-d DOMAIN`ï¼Œ`--domains DOMAIN` | å•ç‹¬æŒ‡å®šçš„åŸŸã€‚ |

æ­¤å¤–ï¼Œå¯èƒ½ä¼šçœç•¥`--webroot -w /var/www/%your-webroot%`ï¼Œå› ä¸ºç¨åä¼šè¯¢é—®æ‚¨(å› æ­¤å®ƒæˆä¸ºéè‡ªåŠ¨è¿‡ç¨‹)ã€‚

**æ³¨æ„:å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ï¼Œç³»ç»Ÿä¼šè¯¢é—®æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€ï¼ŒCA(è¯ä¹¦é¢å‘æœºæ„)ä¼šå°†é€šçŸ¥ç”µå­é‚®ä»¶å‘é€åˆ°è¯¥åœ°å€ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨`-m EMAIL, --email EMAIL`é€‰é¡¹ã€‚*

æ€»ä¹‹ï¼Œ`certbot`è¾“å‡ºæ˜¯è¿™æ ·çš„:

```
#  certbot certonly --webroot -w /var/www/%your-webroot% -d %your-domain%
 Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for %your-domain%
Using the webroot path /var/www/%your-webroot% for all unmatched domains.
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/%your-domain%/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/%your-domain%/privkey.pem
   Your cert will expire on 20??-??-??. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   "certbot renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬æ”¶åˆ°ç”œèœœçš„â€œç¥è´ºï¼â€æ¶ˆæ¯ã€‚
è®©æˆ‘ä»¬æ¥åæ˜ ä¸€ä¸‹`/etc/httpd.conf` :
ä¸­çš„`fullchain.pem`å’Œ`privkey.pem`

```
# [/etc/httpd.conf] 
types {
        include "/usr/share/misc/mime.types"
}

ext_addr = egress

# ... 
#cert_domain = %your-domain%
#server $cert_domain {
#        listen on $ext_addr port 80
#        root "/%your-webroot%"
#        directory auto index
#} 
server "%your-domain%" {
        listen on $ext_addr port 80
        block return 301 "https://$SERVER_NAME$REQUEST_URI"
}
server "%your-domain%" {
        listen on $ext_addr tls port 443
        tls {
                certificate     "/etc/letsencrypt/live/%your-domain%/fullchain.pem"
                key             "/etc/letsencrypt/live/%your-domain%/privkey.pem"
        }
        root "/%your-webroot%"
        directory auto index
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶å:

```
# rcctl restart httpd 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæˆ‘ä»¬è·å¾—äº† web æœåŠ¡å™¨æ¥åˆ›å»º HTTPS è¿æ¥ï¼Œåªè¦å®ƒæœ€åè¢«è®¿é—®ï¼

### [](#how-to-manage-obtained-certificates)å¦‚ä½•ç®¡ç†è·å¾—çš„è¯ä¹¦

è¯·è®°ä½ [Let's Encript çš„è¯ä¹¦æœ‰æ•ˆæœŸä¸º 90 å¤©](https://letsencrypt.org/docs/faq/)ä»¥åŠ[ä¸ºä»€ä¹ˆæ˜¯](https://letsencrypt.org/2015/11/09/why-90-days.html)ã€‚

è¿™äº›æ˜¯`certbot`çš„åŸºæœ¬å­å‘½ä»¤:

| å­å‘½ä»¤ | æè¿° |
| --- | --- |
| è¯ä¹¦ | åˆ—å‡º Certbot ç®¡ç†çš„è¯ä¹¦ |
| [æ›´æ–°](https://certbot.eff.org/docs/using.html#renewing-certificates) | æ›´æ–°æ‰€æœ‰è¯ä¹¦(æˆ–ç”¨`--cert-name`æŒ‡å®šçš„è¯ä¹¦) |
| åˆ é™¤ | æ¸…ç†ä¸è¯ä¹¦ç›¸å…³çš„æ‰€æœ‰æ–‡ä»¶ |
| [æ’¤é”€](https://certbot.eff.org/docs/using.html#revoking-certificates) | æ’¤é”€ç”¨`--cert-path`æˆ–`--cert-name`æŒ‡å®šçš„è¯ä¹¦ |

##### [](#to-list)ä¸ºåˆ—è¡¨

```
#  certbot certificates
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Found the following certs:
  Certificate Name: %your-domain%
    Domains: %your-domain%
    Expiry Date: 20??-??-?? ??:??:??+00:00 (VALID: 90 days)
    Certificate Path: /etc/letsencrypt/live/%your-domain%/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/%your-domain%/privkey.pem
  Certificate Name: ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

##### [](#to-renew)æ›´æ–°

ç®€å•çš„ç”¨æ³•æ˜¯è¿™æ ·çš„â€œæ›´æ–°ä»»ä½•ä»¥å‰è·å¾—çš„åœ¨ 30 å¤©å†…åˆ°æœŸçš„è¯ä¹¦â€:

```
#  certbot renew 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‰/åæŒ‚é’©å¯ç”¨:

```
#  certbot renew --pre-hook "rcctl stop httpd" --post-hook "rcctl start httpd" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

##### [](#to-delete)åˆ é™¤

å®Œå…¨åˆ é™¤è¯ä¹¦:

```
#  certbot delete --cert-name %your-domain% 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

<center>âœ¿ âœ¿ âœ¿</center>

å¿«ä¹æœåŠ¡ğŸŒµ