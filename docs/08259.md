# åœ¨å•ä¸€ API ä¸­è¯†åˆ«æœåŠ¡è¾¹ç•Œ

> åŸæ–‡ï¼š<https://dev.to/paulswail/identifying-service-boundaries-in-a-monolithic-api-laa>

è‡ªä»æˆ‘[éƒ¨ç½² API Gateway ä½œä¸ºæˆ‘çš„é—ç•™ API](https://winterwindsoftware.com/serverless-migration-journal-part3/) çš„ä»£ç†ä»¥æ¥ï¼Œå·²ç»è¿‡å»äº†ä¸€ä¸ªå¤šæ˜ŸæœŸã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸€åˆ‡éƒ½å¾ˆå¹³é™ã€‚ğŸ˜€

æœ¬å‘¨æ—©äº›æ—¶å€™ï¼Œæˆ‘å¯¹æˆ‘çš„ monolithic Express.js API ä»£ç åº“è¿›è¡Œäº†åˆ†æï¼Œç›®çš„æ˜¯è¯†åˆ«æœåŠ¡è¾¹ç•Œï¼Œä»¥å¸®åŠ©æˆ‘å°†ç›¸å…³çš„è·¯ç”±é€»è¾‘åœ°åˆ†ç»„åˆ°å®ƒä»¬è‡ªå·±çš„æœåŠ¡ä¸­ï¼Œå¹¶é€‰æ‹©é¦–å…ˆè¿ç§»æœ‰æ„ä¹‰çš„æœåŠ¡ã€‚

ä¸‹é¢åˆ—å‡ºäº†æˆ‘åœ¨ç¦»æ•£æœåŠ¡æ–¹é¢çš„æƒ³æ³•ã€‚é’ˆå¯¹æ¯ä¸ªæœåŠ¡ï¼Œæˆ‘æŒ‡å®šäº†è¯¥æœåŠ¡å½“å‰ä¾èµ–çš„ä¸‹æ¸¸èµ„æºï¼Œä»¥åŠå®ƒä½¿ç”¨çš„ä»»ä½•ç‰¹å®šçš„ MongoDB é›†åˆ(è¡¨)ã€‚

*ç‰¹åˆ«æ„Ÿè°¢[å´”ç°](https://twitter.com/theburningmonk)è¿™é‡Œæ˜¯æˆ‘éå¸¸å€šé‡çš„[æ–‡ç« ](https://blog.binaris.com/how-to-migrate-existing-monoliths-to-serverless/)å’Œä¼˜ç§€çš„[ç”Ÿäº§å°±ç»ªæ— æœåŠ¡å™¨è¯¾ç¨‹](https://bit.ly/production-ready-serverless)ã€‚*

### è®¤è¯

æ³¨å†Œã€ç™»å½•ã€æˆæƒå’Œç”¨æˆ·æ¡£æ¡ˆç®¡ç†ã€‚è¿™äº›è·¯ç”±çš„å®ç°ä½¿ç”¨ PassportJSï¼Œå¹¶ä¸”ç›¸å¯¹å¤æ‚ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(é›†åˆ:ç”¨æˆ·ï¼Œä¼šè¯)ï¼Œé‚®æˆ³ã€‚

### å®¢æˆ·è´¦æˆ·ç®¡ç†

åˆ›å»ºå®¢æˆ·å¸æˆ·ï¼Œå‘å¸æˆ·æ·»åŠ ç”¨æˆ·ï¼Œæ›´æ”¹å¸æˆ·è®¾ç½®ï¼Œå…³é—­å¸æˆ·ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(é›†åˆ:CustomerAccountsï¼ŒUsers)ã€‚

### è®¿å®¢ç®€ä»‹

è®°å½•è®¿é—®è€…çš„æ´»åŠ¨ï¼Œè·å–è®¿é—®è€…çš„ä¸ªäººèµ„æ–™ï¼Œç»™è®¿é—®è€…é™„ä¸Šæ³¨é‡Šã€‚æœ€ç»ˆç”¨æˆ·é—¨æˆ·å’Œç°æœ‰çš„äº‹ä»¶è·Ÿè¸ªæœåŠ¡éƒ½ä½¿ç”¨å®ƒã€‚ä¸‹æ¸¸èµ„æº:MongoDB(é›†åˆ:è®¿é—®è€…ã€é€šçŸ¥)ã€‚

### è®¿å®¢æœç´¢

æœç´¢è®¿é—®è€…ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(æ”¶è—:è®¿é—®è€…)ã€‚

### ä¸¾æŠ¥

é’ˆå¯¹ç‰¹å®šå¸æˆ·çš„æŒ‰éœ€/é¢„å®šæŠ¥å‘Šï¼Œé’ˆå¯¹ Mongo è¿è¡ŒæŸ¥è¯¢å¹¶è¿”å› JSON æˆ– HTML å“åº”ã€‚æ¯å‘¨çš„æ´»åŠ¨é‚®ä»¶æŠ¥å‘Šæ˜¯è¿™é‡Œçš„ä¸»è¦å†…å®¹ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(æ”¶è—:è®¿é—®è€…)ã€‚

### äº‹ä»¶æŒ‡æ ‡

åœ¨å¸æˆ·ä»ªè¡¨æ¿é¡µé¢ä¸­æ˜¾ç¤ºä¸è®¿é—®è€…æ´»åŠ¨ç›¸å…³çš„æ±‡æ€»æŒ‡æ ‡ã€‚è¿™åªæ˜¯ä¸€ä¸ªå•ä¸€çš„`/all`è·¯ç”±ï¼Œå®ƒè°ƒç”¨ç°æœ‰çš„ Lambda å¹¶æ‰§è¡Œ 2 ä¸ª Mongo è®¡æ•°æŸ¥è¯¢ã€‚ä¸‹æ¸¸èµ„æº:ç°æœ‰çš„ Lambda(æ¥è‡ªäº‹ä»¶è·Ÿè¸ªæœåŠ¡)ã€MongoDB(é›†åˆ:è®¿é—®è€…)ã€‚

### æ´»åŠ¨é€šçŸ¥(å†…éƒ¨)

è¿™æœ‰å‡ ä¸ªç”± Lambda è½®è¯¢ä½œä¸šè§¦å‘çš„è·¯ç”±ã€‚å½“å‰çš„å®ç°ä» MongoDB è·å–é€šçŸ¥è®°å½•ï¼Œæ¯å½“ä¿å­˜è®¿é—®è€…é…ç½®æ–‡ä»¶æ—¶éƒ½ä¼šä¿å­˜è¿™äº›è®°å½•ã€‚ç„¶åï¼Œå®ƒä¸ºæ¯ä¸ªäººç”Ÿæˆç”µå­é‚®ä»¶ï¼Œå¹¶ä½¿ç”¨é‚®æˆ³å‘é€é€šçŸ¥ç”µå­é‚®ä»¶ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªä»…ä¾›å†…éƒ¨ä½¿ç”¨çš„ APIï¼Œè€Œä¸éœ€è¦ API ç½‘å…³ç«¯ç‚¹ï¼Œè¿™å¯èƒ½ä¼šå®Œå…¨é‡æ„ï¼Œè®©è®¿é—®è€…é…ç½®æ–‡ä»¶æ›´æ–°å°†äº‹ä»¶æ¨é€åˆ° SNSï¼Œç„¶å Lambda å¤„ç†ç¨‹åºè¢«è§¦å‘æ¥å‘é€ç”µå­é‚®ä»¶ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(é›†åˆ:é€šçŸ¥ï¼Œè®¿å®¢)ï¼Œé‚®æˆ³ã€‚

### å‰ç«¯ UI

HTML-æœåŠ¡è·¯çº¿ã€‚è™½ç„¶å¤§éƒ¨åˆ†å‰ç«¯æ˜¯ AngularJS å•é¡µé¢åº”ç”¨ç¨‹åºï¼Œä½†ä»¤äººçƒ¦æ¼çš„æ˜¯ï¼Œæœ‰å‡ ä¸ªé¡µé¢ä»ç„¶ä½¿ç”¨ Express ä¸­çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œæˆ‘éœ€è¦è¿ç§»åˆ° Lambda æˆ–æ›´æ–°å‰ç«¯ï¼Œä½¿è¿™äº›é¡µé¢ä¹Ÿæˆä¸º SPA çš„ä¸€éƒ¨åˆ†ã€‚ä¸‹æ¸¸èµ„æº:MongoDB(é›†åˆ:ç”¨æˆ·)

æˆ‘è¿˜å‘ç°äº†å‡ ä¸ªå·²ç»åºŸå¼ƒçš„ API è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥ç»ˆæ­¢ã€‚âœ‚ï¸

## ä»å“ªé‡Œå¼€å§‹ï¼Ÿ

æ‰€ä»¥éœ€è¦è¿ç§»çš„æœåŠ¡ç›¸å½“å¤šã€‚å…¶ä¸­è®¸å¤šåªæœ‰ 1 æˆ– 2 æ¡è·¯çº¿ï¼Œä½†æ¯æ¡è·¯çº¿çš„å¤æ‚ç¨‹åº¦ä¸åŒ:ä¸€äº›æ˜¯åŸºæœ¬çš„ CRUDï¼Œè€Œå¦ä¸€äº›åˆ™æ‰§è¡Œæ›´å¤æ‚çš„ç¼–æ’ã€‚

æˆ‘æƒ³ä»è¾ƒç®€å•çš„è·¯çº¿å¼€å§‹ï¼Œè¿™äº›è·¯çº¿é£é™©ç›¸å¯¹è¾ƒä½ï¼Œä½†ä»ç„¶æœ‰å¾ˆå¤§çš„æµé‡ã€‚æ£€æŸ¥å®Œæ¯ä¸€é¡¹åï¼Œæˆ‘æƒ³ä»*äº‹ä»¶åº¦é‡*æœåŠ¡å¼€å§‹:

*   ç”¨æˆ·ä¸€æ‰“å¼€é—¨æˆ·ç½‘ç«™çš„ä¸»é¡µï¼Œå®ƒå°±ä¼šè¢«å¤§é‡ç‚¹å‡»ã€‚
*   å®ƒæ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥æˆ‘ä¸éœ€è¦æ‹…å¿ƒæŸåæ•°æ®ã€‚
*   å®ƒç›®å‰ä½¿ç”¨ Redis Elasticache æ¥ç¼“å­˜ç»“æœï¼Œæˆ‘è®¤ä¸ºæˆ‘å¯ä»¥åœ¨è¿™é‡Œå¾ˆå¥½åœ°äº¤æ¢ API ç½‘å…³ç¼“å­˜ã€‚

ä½†æ˜¯åœ¨æˆ‘å¼€å§‹å®æ–½æ–°çš„äº‹ä»¶åº¦é‡æœåŠ¡ä¹‹å‰ï¼Œæˆ‘éœ€è¦è§£å†³ä¸€äº›è·¨é¢†åŸŸçš„é—®é¢˜:

1.  **æµ‹è¯•å’Œ CI/CD** â€”æˆ‘å¸Œæœ›æ¯ä¸ªæ–°è¿ç§»çš„è·¯ç”±åœ¨éƒ¨ç½²åˆ°å®é™…ä½¿ç”¨ä¹‹å‰é€šè¿‡é›†æˆå’ŒéªŒæ”¶æµ‹è¯•ã€‚æˆ‘è®¡åˆ’ç”¨ AWS CodePipeline/CodeBuild å»ºç«‹ä¸€ä¸ªç®¡é“ã€‚
2.  **è®¤è¯&æˆæƒ** â€”å‡ ä¹æ‰€æœ‰çš„ API è·¯ç”±éƒ½è¦æ±‚è°ƒç”¨è€…é€šè¿‡è®¤è¯ï¼Œå¹¶æ‹¥æœ‰ç‰¹å®šè´¦æˆ·çš„æˆæƒã€‚è¿™ç›®å‰ç”± Express åº”ç”¨ç¨‹åºä¸­çš„ä¸­é—´ä»¶ç®¡ç†ï¼Œå®ƒä½¿ç”¨ MongoDB ä¸­çš„ Users è¡¨æ¥å­˜å‚¨ç”¨æˆ·é…ç½®æ–‡ä»¶å’Œå‡­è¯ã€‚è™½ç„¶æˆ‘è¿˜ä¸æƒ³å°†ç™»å½• API è·¯å¾„è¿ç§»åˆ° Lambdaï¼Œä½†æˆ‘ç¡®å®éœ€è¦ä¸€ç§æ–¹æ³•æ¥éªŒè¯ API è¯·æ±‚ä¸­çš„ auth ä»¤ç‰Œï¼Œå¹¶æ£€æŸ¥æ•°æ®åº“ä¸­ç”¨æˆ·çš„æˆæƒçº§åˆ«ã€‚æˆ‘æœ‰å‡ ä¸ªé€‰æ‹©ï¼Œå¯èƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ª [API ç½‘å…³ Lambda æˆæƒå™¨](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html)ï¼Œä½¿ç”¨ä¸€ä¸ªæ‰€æœ‰ Lambda è·¯ç”±åŠŸèƒ½éƒ½å¯ä»¥ä½¿ç”¨çš„å…±äº«ä¸­é—´ä»¶åº“ï¼Œæˆ–è€…ç”šè‡³å¯èƒ½æ˜¯è¿™ä¸¤ç§æ–¹æ³•çš„ç»„åˆã€‚

æˆ‘å°†åœ¨æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¸­æ·±å…¥æ¢è®¨è¿™ä¸¤ä¸ªé¢†åŸŸï¼Œæ•¬è¯·å…³æ³¨ã€‚

## ç›‘æ§æ½œä¼æœŸ

åœ¨ç»“æŸä¹‹å‰ï¼Œæˆ‘æƒ³è°ˆä¸€è°ˆæˆ‘ä¸Šå‘¨å¿½ç•¥çš„å…³äºå»¶è¿Ÿçš„è¿è¥é—®é¢˜(æ„Ÿè°¢[å‡¯å°”Â·åŠ å°”å¸ƒé›·æ–¯](https://twitter.com/kylegalbraith)ä¸º[æŒ‡å‡ºäº†è¿™ä¸€ç‚¹](https://dev.to/kylegalbraith/comment/9hco))ã€‚å…·ä½“æ¥è¯´ï¼Œè¿˜æ²¡æœ‰è¿ç§»åˆ° Lambda çš„å®¢æˆ·ç«¯ API è¯·æ±‚ç°åœ¨æœ‰äº†ä¸€ä¸ªé¢å¤–çš„ç½‘ç»œè·³è½¬ã€‚ä»¥å‰ï¼Œè¯·æ±‚è·¯å¾„æ˜¯:

*æµè§ˆå™¨- > ELB(ç¾ä¸œ-1)â€”â€”>EC2(ç¾ä¸œ-1)*

ç„¶è€Œç°åœ¨æ˜¯:

*æµè§ˆå™¨->API GW(edge)â€”â€”>ELB(ç¾ä¸œ-1)â€”â€”>EC2(ç¾ä¸œ-1)*

åœ¨ [serverless-aws-alerts æ’ä»¶](https://github.com/ACloudGuru/serverless-plugin-aws-alerts)ä¸ºæˆ‘è‡ªåŠ¨åˆ›å»ºçš„ CloudWatch ä»ªè¡¨ç›˜ä¸­ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°æ‰€æœ‰é€šè¿‡ API ç½‘å…³çš„è¯·æ±‚çš„ p90 å»¶è¿Ÿã€‚

[![CloudWatch API Gateway latencies](img/fa18fb1aa6e4836f915438bdb08b2455.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--vE4OaVTk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://winterwindsoftware.com/img/blog-images/api-latency-graph.png)

æˆ‘å¹¶ä¸å¤ªæ‹…å¿ƒè¿™äº›å»¶è¿Ÿï¼Œä½†æˆ‘ç¡®å®å¸Œæœ›æ”¹å–„å®ƒä»¬ï¼Œå› ä¸ºæˆ‘ç”¨ Lambda å‡½æ•°æ›¿æ¢äº†å¯¹ä¼ ç»Ÿ ELB çš„è¯·æ±‚ï¼Œå¹¶å¼€å§‹åˆ©ç”¨ API Gateway çš„ç¼“å­˜åŠŸèƒ½ã€‚æˆ‘çš„ API ç½‘å…³å®ä¾‹æ˜¯è¾¹ç¼˜ä¼˜åŒ–çš„ï¼Œè¿™ä¸€äº‹å®å°†æœ‰æ‰€å¸®åŠ©ï¼Œå› ä¸ºæˆ‘çš„å¤§å¤šæ•°å®¢æˆ·éƒ½åœ¨è¥¿æ¬§ã€‚(æˆ‘æœ€åˆé€‰æ‹©åœ¨ us-east-1 å»ºè®¾åŸºç¡€è®¾æ–½ï¼Œå¸Œæœ›å€Ÿæ­¤å¾æœåŒ—ç¾å¸‚åœºï¼Œç°åœ¨çœ‹æ¥æœ‰ç‚¹æ„šè ¢ğŸ˜)

å±•æœ›æœªæ¥ï¼Œè™½ç„¶ä¸Šå›¾æè¿°äº†èšåˆçº§åˆ«çš„å»¶è¿Ÿï¼Œä½†æˆ‘å¸Œæœ›çœ‹åˆ°æ¯ä¸ªè¿ç§»åˆ° Lambda çš„æ–°ç«¯ç‚¹çš„å»¶è¿Ÿå’Œé”™è¯¯çš„æ›´ç»†ç²’åº¦çš„æ¯è·¯å¾„æŒ‡æ ‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘å°†åœ¨è¿ç§»è¿‡ç¨‹ä¸­è¯•ç”¨[æ¡‘å¾·æ‹‰](https://thundra.io/)ï¼Œå› ä¸ºæœ€è¿‘çš„ä¸€æ¬¡æ¼”ç¤ºç»™æˆ‘ç•™ä¸‹äº†æ·±åˆ»çš„å°è±¡ã€‚

## ä¸‹ä¸€æ­¥

æˆ‘æ¥ä¸‹æ¥è¦åšçš„æ˜¯:

1.  æ”¾ç½® CI/CD ç®¡é“å’Œæµ‹è¯•æ¡†æ¶ï¼Œä»å¼€å‘->è¯•è¿è¡Œ->ç”Ÿäº§
2.  å®æ–½è®¤è¯å’Œæˆæƒä¸­é—´ä»¶ï¼Œå¹¶åœ¨è™šæ‹Ÿè·¯çº¿ä¸Šè¿›è¡Œæµ‹è¯•
3.  ä¸ºæˆ‘ç¡®å®šä¸ºç¬¬ä¸€ä¸ªè¦è¿ç§»çš„å¾®æœåŠ¡çš„äº‹ä»¶åº¦é‡è·¯çº¿å®æ–½ Lambda

ä¸€å¦‚æ—¢å¾€ï¼Œå¦‚æœä½ å¯¹æˆ‘çš„å†³å®šæœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæˆ‘å¾ˆä¹æ„å€¾å¬ã€‚

âœ‰ï¸ *å¦‚æœä½ æƒ³åœ¨è¿™ä¸€ç³»åˆ—å‡†å¤‡å°±ç»ªåå°½å¿«è·å¾—æœªæ¥çš„æ›´æ–°ï¼Œå¹¶ä¸”**è®¿é—®æˆ‘ç”¨æ¥è·Ÿè¸ªæˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­æ‰§è¡Œçš„æ‰€æœ‰ä»»åŠ¡çš„ Trello æ¿**ï¼Œä½ å¯ä»¥[åœ¨è¿™é‡Œè®¢é˜…](https://winterwindsoftware.com/serverless-migration-journal/#signup)ã€‚*

* * *

æ‚¨è¿˜å¯èƒ½ä¼šå–œæ¬¢:

*   [æ‹…å¿ƒæ— æœåŠ¡å™¨å¸¦èµ°](https://winterwindsoftware.com/concerns-that-serverless-takes-away/)
*   [â€œæ— æœåŠ¡å™¨â€çš„ä¸åŒå®šä¹‰](https://winterwindsoftware.com/serverless-definitions/)
*   [æ— æœåŠ¡å™¨è¯æ±‡è¡¨](https://winterwindsoftware.com/serverless-glossary/)

*åŸè½½äº winterwindsoftware.com*ã€‚