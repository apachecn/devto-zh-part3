# ååº”é’©ã€æ‚¬å¿µå’Œå¤‡å¿˜å½•

> åŸæ–‡:[https://dev . to/whoisryosuke/react-hooks-suspension-and-memo-513 o](https://dev.to/whoisryosuke/react-hooks-suspense-and-memo-513o)

> ç¼–è€…æ³¨:æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼ŒHooks è¿˜åœ¨ alpha ç‰ˆæœ¬(React v16.6)ï¼Œç°åœ¨ Hooks æ­£å¼å‘å¸ƒäº†(v16.8)ï¼Œæˆ‘å†³å®šå†™å®Œè¿™ç¯‡æ–‡ç« ã€‚

æœ€è¿‘ React ç¤¾åŒºçš„äº‹æƒ…è¶Šæ¥è¶Šå¤šäº†ï¼åœ¨å‡ ä¸ªæœˆçš„*æ‚¬å¿µ*ä¹‹é—´ï¼ŒCreate React App v2ã€Hooksã€Memo - React çš„æ–°è€å¼€å‘è€…ä»¬éƒ½å¿™ç€ç©æ–°ç©å…·ã€‚æˆ‘ç»ˆäºæœ‰æ—¶é—´æ·±å…¥ç ”ç©¶æ–°çš„`React.memo()`ã€`React.lazy()`å’Œ`<Suspense />`APIï¼Œä»¥åŠæè®®çš„ Hooks APIã€‚

## [](#purecomponent-for-functional-components)PureComponent ä¸ºåŠŸèƒ½ç»„ä»¶

ä¸€ç§æ–°çš„è®°å¿†æŠ€æœ¯ï¼`React.memo()`æ˜¯ä¸€ä¸ªç‰¹è®¾ï¼Œé˜²æ­¢ä¸€ä¸ªç»„ä»¶åœ¨é“å…·ç›¸åŒçš„æƒ…å†µä¸‹æ”¹å˜é“å…·ã€‚å®ƒåŸºæœ¬ä¸Šåœ¨`shouldComponentUpdate()`ç”Ÿå‘½å‘¨æœŸä¸­çš„ props ä¸Šè¿è¡Œä¸€ä¸ªæµ…å±‚ equalï¼Œä½†æ˜¯å¯¹äºä¸èƒ½è®¿é—®å®ƒçš„åŠŸèƒ½ç»„ä»¶(æ²¡æœ‰åˆ‡æ¢åˆ°ç±»)ã€‚

```
const MyComponent = React.memo(function MyComponent(props) {
  /* render using props */
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€Œå¦‚æœé“å…·ä¸­åŒ…å«å¤æ‚çš„ç‰©ä½“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶å†…éƒ¨æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥æ£€æŸ¥:

```
function MyComponent(props) {
  /* render using props */
}
function areEqual(prevProps, nextProps) {
  /*
  return true if passing nextProps to render would return
  the same result as passing prevProps to render,
  otherwise return false
  */
}
export default React.memo(MyComponent, areEqual); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äºä¾èµ–åŠŸèƒ½ç»„ä»¶æ¥å‘ˆç°ä½çº§ UI å…ƒç´ çš„ç»„ä»¶å’Œè®¾è®¡ç³»ç»Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ€§èƒ½å¢ç›Šã€‚

### [](#a-callback-cache)å›è°ƒâ€œç¼“å­˜â€

è¿˜å®ç°äº†ä¸€ä¸ªæ–°çš„é’©å­ï¼Œå®ƒåœ¨å‡½æ•°ä¸Šä½¿ç”¨ç›¸åŒçš„è®°å¿†é€»è¾‘ã€‚å®ƒé˜²æ­¢å‡½æ•°è¢«å†æ¬¡è°ƒç”¨ï¼Œé™¤éå®ƒçš„å‚æ•°(æˆ–ä½ æŒ‡å®šçš„å˜é‡)æ”¹å˜:

```
const memoizedValue = useMemo(() => computeExpensiveValue(a, b), [a, b]); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-suspense-is-over)æ‚¬å¿µç»“æŸäº†ğŸŒŸ

æˆ‘é¦–å…ˆæƒ³æŒ–æ˜çš„æ˜¯æ‚¬å¿µï¼Œå› ä¸ºå®ƒå®é™…ä¸Šå·²ç»å®ç°äº†(å¦‚æœä¸æ˜¯ä¸å®Œæ•´çš„è¯)ã€‚åœ¨ 3 æœˆè§‚çœ‹äº† Dan åœ¨ ReactFest 2018 ä¸Šå…³äºæ‚¬å¿µçš„[ä»¤äººéš¾ä»¥ç½®ä¿¡çš„æ¼”è®²åï¼Œæˆ‘å¾ˆé«˜å…´ React å°†å»¶è¿ŸåŠ è½½ä½œä¸ºä¸€ä¸ªä¼˜å…ˆäº‹é¡¹ï¼Œè¶³ä»¥å°†å…¶çº³å…¥ä»–ä»¬çš„ APIã€‚æˆ‘ä¸éœ€è¦ä¾èµ–åƒ](https://www.youtube.com/watch?v=6g3g0Q_XVb4)[è¿™æ ·çš„åº“æˆ–è€… Webpack ä¸­çš„é…ç½®ï¼Œæˆ‘åªéœ€è¦:](https://github.com/jamiebuilds/react-loadable#readme) 

```
const OtherComponent = React.lazy(() => import('./OtherComponent'));

function MyComponent() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <OtherComponent />
      </Suspense>
    </div>
  );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä¸ä»…è·å¾—äº†å»¶è¿ŸåŠ è½½æˆ‘çš„ç»„ä»¶åŒ…çš„å¥½å¤„(ä½¿åº”ç”¨ç¨‹åºæœ€åˆåŠ è½½æ›´å¿«)ï¼Œè€Œä¸”æˆ‘è¿˜å¯ä»¥æ’å…¥ä»»ä½•åŠ è½½ç»„ä»¶ã€‚è¿™ä½¿å¾—åƒ*éª¨æ¶å±å¹•*è¿™æ ·çš„å¹»è§‰å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚

ä½ å¯ä»¥åœ¨ CodeSandbox ä¸Šçœ‹åˆ°[ä¸€ä¸ªæ´»ç”Ÿç”Ÿçš„ä¾‹å­:](https://codesandbox.io/s/y2453lj5xj?view=editor)

## [](#hooks)æŒ‚é’©

æœ€è¿‘ï¼ŒReact æå‡ºäº†ä¸€ç§æ–°çš„ã€åŠŸèƒ½æ›´å¼ºçš„æ–¹æ³•ï¼Œä½¿ç”¨â€œé’©å­â€æ¥å¤„ç†çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¾èµ– React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚æ‚¨å¯ä»¥åœ¨æ­¤å¤„çš„ React æ–‡æ¡£ä¸­æ‰¾åˆ°[æ•´ä¸ªææ¡ˆã€‚](https://reactjs.org/docs/hooks-intro.html)

ä½¿ç”¨å®ƒä»¬å¾ˆç®€å•ï¼Œä¸åŒç±»äº§å“ç›¸æ¯”ï¼ŒåŠŸèƒ½ç»„ä»¶çš„ LOC æ›´ä½ã€‚

```
function YourComponent({ text }) {
  const [ theText, updateText] = useState(text)
  const changeText = ({ target: { value } }) => {
    updateText(value)
  }
  return(
    <button onClick={() => changeText}>
      {theText}
    </button>
  )
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†å¤„ç†ç»„ä»¶ä¸­çš„ä»»ä½•å‰¯ä½œç”¨ï¼Œåœ¨åŠŸèƒ½ç»„ä»¶ä¸­åŠ å…¥ä¸€ä¸ª`useEffect()`æ¥åœ¨æ¯æ¬¡çŠ¶æ€æ”¹å˜/é‡æ–°å‘ˆç°æ—¶è¿è¡Œä»£ç ã€‚

é’©å­æœ€å¥½çš„éƒ¨åˆ†ä¹‹ä¸€æ˜¯å®ƒä»¬çš„åŠŸèƒ½ç‰¹æ€§(FP FTW)ã€‚æ‚¨å¯ä»¥å°†æŒ‚é’©å’Œæ•ˆæœæå–åˆ°ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ä¸­ï¼Œå¹¶åœ¨åº”ç”¨ç¨‹åºçš„å¤šä¸ªç»„ä»¶ä¸­é‡ç”¨è¯¥æŒ‚é’©ã€‚

### [](#hooks-less-compiled-code)é’©å­=è¾ƒå°‘ç¼–è¯‘çš„ä»£ç 

å¢åŠ é’©å­æœ€å¥½çš„åœ°æ–¹ä¹‹ä¸€æ˜¯èƒ½å¤Ÿæ”¾å¼ƒæœ‰çŠ¶æ€é€»è¾‘çš„ç±»ï¼Œæ”¯æŒæ›´æœ‰æ•ˆçš„å‡½æ•°ã€‚å¦‚æœä½ æ›¾ç»çœ‹è¿‡å¤§å¤šæ•°ç¼–è¯‘è¿‡çš„ JS ä»£ç ï¼Œç”±äºç±»çš„å·¥ä½œæ–¹å¼(ç›¸å¯¹äºåŸå‹æ˜¯è¯­æ³•ä¸Šçš„ç³–è¡£)ï¼Œåœ¨ä½ çš„åº”ç”¨ä¸­ä½¿ç”¨ä¸€ä¸ªç±»ä¼šç”¨ polyfills æå¤§åœ°è†¨èƒ€ä½ çš„ä»£ç ã€‚

æœ¬è¯¾:

```
class Test extends React {
  constructor() {
    super()
    this.state = {}
  }
  render() {
    return <div>Test</div>
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç¼–è¯‘åˆ°:

```
"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var Test = function (_React) {
  _inherits(Test, _React);

  function Test() {
    _classCallCheck(this, Test);

    var _this = _possibleConstructorReturn(this, (Test.__proto__ || Object.getPrototypeOf(Test)).call(this));

    _this.state = {};
    return _this;
  }

  _createClass(Test, [{
    key: "render",
    value: function render() {
      return React.createElement(
        "div",
        null,
        "Test"
      );
    }
  }]);

  return Test;
}(React); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¦‚æœä½ ä½¿ç”¨ä¸€ä¸ªå‡½æ•°(é™¤éå®ƒæ˜¯ ES6 arrow å‡½æ•°)ï¼Œå®ƒå°±åƒå®ƒå‡ºç°æ—¶ä¸€æ ·ç¼–è¯‘â€”â€”å› ä¸ºå‡½æ•°è¢«å¦‚æ­¤å¹¿æ³›åœ°æ”¯æŒ(å¦‚æ­¤åŸå§‹/æ—©æœŸçš„ JS API)ã€‚å³ä½¿è€ƒè™‘åˆ°æ•°ç»„ææ„ï¼Œ[ä»£ç ä»ç„¶æ¯”ç±»](https://babeljs.io/repl/#?babili=false&browsers=&build=&builtIns=false&spec=false&loose=false&code_lz=GYVwdgxgLglg9mABAFQKYGcoAoAOAnOHdASkQG8AoRRCBTRAbVvClTwBpEZI9UBbVGCgBdRAF5EIdKgDKUAIassABmIBuKol5QQeJAB4AFgEYAfAAlUAGytx9AehOmNAXyA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=es2015%2Creact%2Cstage-2&prettier=false&targets=&version=6.26.0&envVersion=)å°‘ï¼ŒåŒæ—¶èƒ½å¤Ÿä½¿ç”¨çŠ¶æ€:

```
function Test(props) {
  const [counter, increment] = useState(0);
  return <h1>Hello</h1>; } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
"use strict";

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

function Test(props) {
  var _useState = useState(0),
      _useState2 = _slicedToArray(_useState, 2),
      counter = _useState2[0],
      increment = _useState2[1];

  return React.createElement(
    "h1",
    null,
    "Hello"
  );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## React çš„æ›´å¯ç»„åˆçš„æœªæ¥

å¾ˆé«˜å…´çœ‹åˆ° React API åœ¨è¿‡å»ä¸€å¹´ä¸­çš„æ”¹è¿›ã€‚è¯¥å›¢é˜Ÿåœ¨ç»´æŠ¤ä¼ ç»Ÿ API å’Œä¸ç ´ååº”ç”¨ç¨‹åºæ–¹é¢åšå¾—éå¸¸å‡ºè‰²(è„¸ä¹¦ä»åœ¨ä½¿ç”¨`React.createElement`),æ–°åŠŸèƒ½çš„æ·»åŠ éƒ½è§£å†³äº†å¼€å‘äººå‘˜çš„å…³é”®é—®é¢˜ã€‚æˆ‘ä¸çŸ¥é“æœ‰å¤šå°‘æ¬¡ï¼Œæˆ‘ä¸å¾—ä¸æŠŠä¸€ä¸ªåŠŸèƒ½ç»„ä»¶è½¬æ¢æˆä¸€ä¸ªç±»ï¼Œä»…ä»…æ˜¯ä¸ºäº†ä¸€ä¸ªæœ‰çŠ¶æ€çš„å¸ƒå°”å€¼ï¼Œç°åœ¨æˆ‘åªéœ€è¦åœ¨å‡½æ•°çš„é¡¶éƒ¨æ”¾ä¸€ä¸ªé’©å­(å¹¶å¯¹å®ƒè¿›è¡Œè®°å¿†ï¼Œä»¥è·å¾—ä¸ PureComponent ç›¸åŒçš„æ€§èƒ½ï¼).

Cheers ğŸ»
Ryo

* * *

**å‚è€ƒæ–‡çŒ®**:

*   [ä»¤äººæ•¬ç•çš„ååº”é’©å­](https://github.com/rehooks/awesome-react-hooks)
*   [æŒ‚é’©å¯¼è½¨](https://www.hooks.guide/)
*   [ä¸¹Â·é˜¿å¸ƒæ‹‰è«å¤«â€”â€”ç†è§£é’©å­](https://dev.to/dan_abramov/making-sense-of-react-hooks-2eib)
*   [ååº”:CRA v2](https://reactjs.org/blog/2018/10/01/create-react-app-v2.html)
*   [ååº”:é’©å­ä»‹ç»](https://reactjs.org/docs/hooks-intro.html)
*   [ååº”:ä»£ç æ‹†åˆ†](https://reactjs.org/docs/code-splitting.html)
*   [ååº”:æ‚¬å¿µ](https://reactjs.org/docs/react-api.html#suspense)
*   [ååº”:å¤‡å¿˜å½•](https://reactjs.org/docs/react-api.html#reactmemo)