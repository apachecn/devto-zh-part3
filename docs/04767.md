# å¦‚ä½•åšç¼“å­˜ï¼Œå½“ Redis å¤ªå¤šçš„æ—¶å€™ã€‚

> åŸæ–‡:[https://dev . to/lucagez/how-do-caching-when-redis-is-just-too-more-113 o](https://dev.to/lucagez/how-to-do-caching-when-redis-is-just-too-much-113o)

**TLï¼›**
*æœ‰æ—¶å€™ä½ ä¼šéœ€è¦ä¸€äº›ç¼“å­˜ã€‚ä½†æ˜¯å»ºç«‹ä¸“ç”¨æ•°æ®åº“çš„å¼€é”€å¯èƒ½ä¸å€¼å¾—ã€‚
æˆ‘åšäº† Ricordoï¼Œä¸€ä¸ªå¾®å‹ç¼“å­˜/å¤‡å¿˜å½•åº“æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚*
https://github.com/lucagez/ricordo[â¡](https://github.com/lucagez/ricordo)

æˆ‘å¿…é¡»å¼€å‘ä¸€ä¸ª APIã€‚å¾ˆåŸºæœ¬çš„ä¸€ä¸ªã€‚å½“æ‰¾åˆ°å±äºç‰¹å®šç”¨æˆ·çš„è·¯çº¿æ—¶ï¼Œæ‚¨ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«ä»–æ‰€æœ‰äº§å“çš„ JSON å“åº”ã€‚å½“æ‰¾åˆ°å±äºæŸä¸ªäº§å“çš„è·¯å¾„æ—¶ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«å…¶ä¿¡æ¯çš„ JSON æ–‡ä»¶ã€‚

æˆ‘å¼€å§‹æ³¨æ„åˆ°ï¼Œåªæœ‰å°‘æ•°äº§å“æ¯”å…¶ä»–äº§å“è¢«è¦æ±‚çš„æ¬¡æ•°å¤šã€‚æ‰€ä»¥æˆ‘å¼€å§‹è€ƒè™‘æŸç§å½¢å¼çš„ç¼“å­˜ã€‚

è¿™ä¸ª API æ‰˜ç®¡åœ¨ digitalocean çš„ä¸€ä¸ª 5 ç¾å…ƒçš„å®ä¾‹ä¸Šã€‚åœ¨åŒä¸€ä¸ªæ¶²æ»´ä¸Šæ‰˜ç®¡:

*   NGINXï¼Œä½œä¸ºä¸€ä¸ªåå‘ä»£ç†ï¼Œä¹Ÿç”¨äºæœåŠ¡ä¸€äº›é™æ€èµ„äº§ã€‚
*   æ³¢æ–¯ç‰¹æ ¼é‡Œæ–¯æ•°æ®åº“ã€‚
*   æˆ‘çš„èŠ‚ç‚¹ APIã€‚

å› æ­¤ï¼Œä¸ºäº†ç¼“å­˜å°‘é‡çš„ JSON å“åº”(æ€»è®¡çº¦ 50mb)ï¼ŒRedis åœ¨è¿™ 5$ droplet ä¸Šå¢åŠ çš„å¼€é”€..å¤ªå¤šäº†ã€‚

ç„¶åæˆ‘å¼€å§‹è€ƒè™‘å°†è®°å¿†åŒ–ä½œä¸ºä¸€äº›å°ç¼“å­˜çš„å¯è¡ŒæŠ€æœ¯ã€‚è®°å¿†æ˜¯ä¸€ç§æŠ€æœ¯ï¼ŒåŒ…æ‹¬å­˜å‚¨æ˜‚è´µè®¡ç®—çš„ç»“æœï¼Œå¹¶ä¸”å¦‚æœç”¨ç›¸åŒçš„è¾“å…¥è°ƒç”¨è¯¥è®¡ç®—ï¼Œåˆ™è¿”å›ç›¸åŒçš„ç»“æœã€‚

ä¸€ä¸ªå¾®è§‚çš„ä¾‹å­:

```
const memo = func => {
  // cache object
  const cache = new Map();

  // Returning function that look up in cache.
  // If nothing is found => a new computation is fired.
  return arg => {
    if (cache.has(arg)) return cache.get(arg);

    // New computation
    const result = func(arg);
    cache.set(arg, result);
    return result;
  };
};

// Super mega expensive function (:
const hello = a => `hello ${a}`;

const cached = memo(hello);

cached('world'); // `hello world` => cache insertion.
cached('world'); // `hello world` => retrieved from cache. 
```

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¼€å§‹ä½¿ç”¨å®ƒæ¥å­˜å‚¨æ•°æ®åº“å“åº”ä¼šæ€ä¹ˆæ ·å‘¢ï¼ŸğŸ¤”è¿™å°±åƒä¸€ä¸ªç¼“å­˜ç³»ç»Ÿã€‚
è¿™æ ·æˆ‘ä»¬å¯ä»¥å¼€å§‹è€ƒè™‘åŸºäºå‡½æ•°çš„ç¼“å­˜ã€‚

å°½ç®¡æˆ‘ä»¬æœ‰ä¸€äº›é—®é¢˜ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„åŸå§‹ç¼“å­˜å®ç°ï¼Œ
æ­£åœ¨å­˜å‚¨æˆ‘ä»¬æ‰”ç»™å®ƒçš„æ‰€æœ‰ä¸œè¥¿ã€‚æ°¸è¿œä¿å­˜å¯†é’¥å’Œç»“æœã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å¾ˆå¿«è€—å°½å†…å­˜ï¼Œåªæœ‰å½“æˆ‘ä»¬çš„è¿›ç¨‹ç»“æŸæ—¶ï¼Œæˆ‘ä»¬çš„å†…å­˜æ‰ä¼šè¢«é‡Šæ”¾ã€‚
å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸€é¡¹æœåŠ¡éå¸¸å¯ç”¨ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥ç”¨ä¸€äº›ç±»ä¼¼çœŸå®ç¼“å­˜çš„è¡Œä¸ºæ¥è°ƒæ•´æˆ‘ä»¬çš„å®ç°ï¼Œä¾‹å¦‚ **TTL** ã€‚

ç”Ÿå­˜æ—¶é—´æ˜¯ç¼“å­˜ç»“æœçš„ç”Ÿå‘½å‘¨æœŸã€‚å½“ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå¯†é’¥å°†ä»æˆ‘ä»¬çš„ç¼“å­˜ä¸­åˆ é™¤ã€‚

```
 const memo = (func, ttl) => {
  const cache = new Map();
  return arg => {
    if (cache.has(arg)) return cache.get(arg);

    // Spawning timeout on new insertion
    // => delete key / result after lifespan 
    setTimeout(() => cache.delete(arg), ttl);

    const result = func(arg);
    cache.set(arg, result);
    return result;
  };
}; 
```

ç¨å¾®å¥½ä¸€ç‚¹ï¼Œç°åœ¨æˆ‘ä»¬ä¸ä¼šæ°¸è¿œå­˜å‚¨æ•°ä¸‡äº¿ä¸ªå¯†é’¥ã€‚ä½†ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜ğŸ˜«åœ¨é«˜çº§è¯­è¨€é¢†åŸŸï¼Œæˆ‘ä»¬ä¸èƒ½å®Œå…¨æ§åˆ¶å¦‚ä½•åˆ†é…å†…å­˜ã€‚æ‰€ä»¥ï¼Œåœ¨åˆ é™¤ä¸€ä¸ªé”®ä¹‹åï¼Œæˆ‘ä»¬ä¸ç¡®å®š Node.js æ˜¯å¦å·²ç»å†³å®š
è¿™æ˜¯é‡Šæ”¾ä¸€äº›å†…å­˜çš„æ­£ç¡®æ—¶æœºã€‚
æ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æ­¢æˆ‘ä»¬ä¾¿å®œçš„ 5$ droplet å†æ¬¡å†…å­˜ä¸è¶³ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ JS ä¸­ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®šä¸€ä¸ªå¯¹è±¡åœ¨æˆ‘ä»¬çš„ ram ä¸­å ç”¨äº†å¤šå°‘ç©ºé—´ã€‚(è‡³å°‘æ²¡æœ‰åŠæ³•ä¸æµªè´¹ç›¸åŒæ•°é‡çš„å­˜å‚¨å†…å­˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç›¸å½“æ— ç”¨)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»ä¾èµ–äºå¯¹å­˜å‚¨ç»“æœå°†å ç”¨å¤šå°‘å†…å­˜çš„ä¼°è®¡ï¼Œå¹¶å†³å®šå­˜å‚¨é”®çš„æ•°é‡é™åˆ¶ï¼Œä»¥é˜²æ­¢åœ¨è¾¾åˆ°é™åˆ¶æ—¶è¿›ä¸€æ­¥æ’å…¥ã€‚

```
 const memo = (func, ttl, limit) => {
  const cache = new Map();
  return arg => {
    if (cache.has(arg)) return cache.get(arg);
    const result = func(arg);

    // Now we are waiting for some key deletions before inserting other results.
    if (cache.size < limit) {
      setTimeout(() => cache.delete(arg), ttl);
      cache.set(arg, result);
    }
    return result;
  };
}; 
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æ­£ç¡®ä¼°è®¡äº†å­˜å‚¨ç»“æœçš„å¤§å°ï¼Œæˆ‘ä»¬çš„ 5$ droplet å°±ä¸ä¼šè€—å°½å†…å­˜ğŸ‰ğŸ‰ğŸ‰

ä½†æ˜¯ç­‰ç­‰ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„é’¥åŒ™å‘¢ï¼Ÿæˆ‘ä»¬æ€æ ·æ‰èƒ½è·Ÿè¸ªä»–ä»¬å‘¢ï¼Ÿå¦‚ä½•æ‰èƒ½åªå­˜å‚¨æœ€å¸¸ç”¨çš„ **n** ä¸ªé¡¹ç›®ï¼Ÿ
å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ç»™å®šçš„æ—¶é—´ç‚¹é”€æ¯ç¼“å­˜æˆ–å•ä¸ªå¯†é’¥ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

å—¯ï¼Œæˆ‘é¢ä¸´è¿™äº›é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘å†³å®šåšä¸€ä¸ªå°å°çš„ npm åŒ…æ¥è§£å†³å®ƒä»¬ã€‚
å¸Œæœ›èƒ½è®©ä½ çš„å¾®ç¼“å­˜éœ€æ±‚å°‘ä¸€ç‚¹ç—›è‹¦ã€‚

è¿™æ˜¯ github å›è´­:
[https://github.com/lucagez/ricordo](https://github.com/lucagez/ricordo)

ç¥å¤§å®¶ç¼“å­˜å¿«ä¹ï¼âœŒ