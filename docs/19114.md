# ä½¿ç”¨æœ¬åœ°åç«™é«˜é€Ÿç¼“å­˜èŠ‚çœæ—¶é—´å’Œå¸¦å®½

> åŸæ–‡:# t0]https://dev . to/mayu/èŠ‚çœ-du-time-and-la-bandage-with-un-cache dock-local-1mj

æˆ‘ç»å¸¸ä½¿ç”¨åç«™ğŸ³åœ¨ VM(æ¼«æ¸¸)æˆ–å…¶ä»–â€œT0â€æœ¬åœ°ç½‘ç»œè®¡ç®—æœºä¸Šï¼Œæˆ‘å‘ç°è‡ªå·±åœ¨è¿™äº›ä¸åŒçš„è®¡ç®—æœºä¸Šå¤šæ¬¡ä¸‹è½½ç›¸åŒçš„â€œT1â€æ˜ åƒã€‚é™¤äº†å¸¦å®½æµªè´¹å¤–ï¼Œ
åœ¨å°è¿æ¥ä¸Šä¹Ÿå¾ˆå¿«æˆä¸ºæµªè´¹æ—¶é—´ï¼
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç°åœ¨ä½¿ç”¨æœ¬åœ°è¿è¡Œçš„
åç«™(registry)æ¥é€æ˜åœ°éšè—åç«™æ£€ç´¢åˆ°çš„æ‰€æœ‰
å›¾åƒã€‚ä¸‹é¢æ˜¯å¦‚ä½•è®¾ç½®å®ƒã€‚

å…ˆåšç‚¹å‡†å¤‡ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè®°å½•ï¼Œè¯¥è®°å½•å°†ç”¨äºå­˜å‚¨æ‰€æœ‰è¿™äº›æ•°æ®ã€‚è¿™ä¸ªæ¡£æ¡ˆä¹Ÿè®¸æ˜¯
ä½ ç”µè„‘ä¸Šçš„ä»»ä½•åœ°æ–¹ï¼Œæˆ‘äº²è‡ªæŠŠå®ƒæ”¾åœ¨`/var/lib` :

```
$ sudo mkdir /var/lib/docker-registry 
```

æˆ‘ä»¬å°†åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­æ·»åŠ é»˜è®¤æ³¨å†Œè¡¨è®¾ç½®ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ç›´æ¥ä» dock:t1 æ˜ åƒä¸­æå–æ³¨å†Œè¡¨è®¾ç½®

```
$ sudo docker run -it --rm registry:2       \
       cat /etc/docker/registry/config.yml  \
       > /var/lib/docker-registry/config.yml 
```

é…ç½®å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œå…·ä½“å–å†³äºæ‚¨æ˜¯ä½•æ—¶æ£€ç´¢åˆ°çš„ï¼Œåœ¨
ä¸Šï¼Œæœ¬æ–‡çš„åˆ›å»ºå¦‚ä¸‹æ‰€ç¤º:

```
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3 
```

è¦å¯ç”¨æœåŠ¡å™¨ä»£ç†åŠŸèƒ½ï¼Œå¿…é¡»å°†ä»¥ä¸‹é…ç½®â€œ
â€æ·»åŠ åˆ° yaml æ–‡ä»¶:

```
proxy:
  remoteurl: https://registry-1.docker.io 
```

é‡‘é’¥`remoteurl`å¯ä»¥æŒ‡å‘ä»»ä½•ç™»å½•ï¼Œæˆ‘åœ¨æ­¤è®¾å®š
ä¸ºé¢„è®¾åœé é‡‘é’¥ã€‚

æœ€ç»ˆé…ç½®åŒ…æ‹¬

```
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
proxy:
  remoteurl: https://registry-1.docker.io 
```

ç°åœ¨é…ç½®å®Œæˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æ³¨å†Œäº†ã€‚a
è¯·æ³¨æ„ï¼Œæˆ‘åœ¨ä»¥ä¸‹å‘½ä»¤
ä¸­ä½¿ç”¨äº†`--restart=always`é€‰é¡¹ï¼Œä»¥ç¡®ä¿æ³¨å†Œè¡¨è‡ªåŠ¨ä» docker å®ˆæŠ¤ç¨‹åºå¼€å§‹ã€‚

```
$ sudo docker run --restart=always -p 5000:5000                         \
         --name v2-mirror -v /var/lib/docker-registry:/var/lib/registry \
         --detach registry:2 serve /var/lib/registry/config.yml 
```

ä½¿ç”¨â€œ`-v`â€å°†å…ˆå‰åˆ›å»ºçš„æ–‡ä»¶å¤¹è£…å…¥æ˜ åƒä¸­ï¼Œç„¶åä½¿ç”¨â€œ
â€é€‰é¡¹å¯åŠ¨æ³¨å†Œè¡¨ï¼Œåè·Ÿâ€œ
é…ç½®â€æ–‡ä»¶çš„è·¯å¾„ã€‚

è®©æˆ‘ä»¬å…ˆç¡®å®šå®¹å™¨æ˜¯ç”¨`docker ps`æ­£ç¡®å‘å°„çš„:

```
$ sudo docker ps
CONTAINER ID   IMAGE        CREATED          STATUS          PORTS                    NAMES
67425da4ea4c   registry:2   32 seconds ago   Up 29 seconds   0.0.0.0:5000->5000/tcp   v2-mirror 
```

ç„¶åå¯ä»¥é€šè¿‡`curl` :
åˆ—å‡ºç™»è®°å†Œçš„å†…å®¹(ç©ºç™½)

```
$ curl http://localhost:5000/v2/_catalog
{"repositories":[]} 
```

ç°åœ¨æˆ‘ä»¬çš„æ³¨å†Œè¡¨å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæˆ‘ä»¬å°†è®¾ç½® docker æ¥ä½¿ç”¨å®ƒã€‚ä¸ºæ­¤ï¼Œéœ€è¦ç¼–è¾‘æ–‡ä»¶`/etc/docker/daemon.json`ä»¥
æ·»åŠ ä»¥ä¸‹é…ç½®(å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON):

```
{  "registry-mirrors":  ["http://localhost:5000"]  } 
```

æ‚¨çš„ç³»ç»Ÿä¸Šå¯èƒ½ä¸å­˜åœ¨æ­¤æ–‡ä»¶(è¯·å‚é˜…æ–‡ä»¶å¤¹)ã€‚
å¦‚æœæ˜¯è¿™æ ·ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»º(ä¸ç”¨æˆ·`root`ä¸€èµ·)ã€‚
é…ç½®æ›´æ”¹åéœ€è¦é‡æ–°å¯åŠ¨åç«™ã€‚è¿™é‡Œæˆ‘å‡è®¾
ä½ æœ‰ä¸€ä¸ªä½¿ç”¨ç³»ç»Ÿçš„ç³»ç»Ÿ:

```
$ sudo systemctl restart docker 
```

æˆ‘ä»¬ç°åœ¨å‡†å¤‡è¿›è¡Œç¬¬ä¸€æ¬¡ä¸‹è½½ï¼Œä»¥éªŒè¯â€œT0â€ä»£ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ:

```
$ sudo docker pull redis
Using default tag: latest
latest: Pulling from library/redis
f17d81b4b692: Pull complete
b32474098757: Pull complete
8980cabe8bc2: Pull complete
e614c66c2b9c: Pull complete
6eb43ec9256b: Pull complete
394ecf5f46d4: Pull complete
Digest: sha256:f30f134bd475d451ce3207fb128bcef8ff87d0f520a39cac0c4ea285819c42a9
Status: Downloaded newer image for redis:latest

~ took 40s 
```

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å›¾ç‰‡ç°åœ¨åœ¨æˆ‘ä»¬çš„æœ¬åœ°æ³¨å†Œè¡¨ä¸­:

```
$ curl http://localhost:5000/v2/_catalog
{"repositories":["library/redis"]} 
```

å°±è¿™æ ·ï¼æˆ‘ä»¬åˆšåˆšéšè—äº†æˆ‘ä»¬çš„ç¬¬ä¸€å¼ å›¾ç‰‡ğŸ‰ã€‚ç°åœ¨è®©æˆ‘ä»¬éªŒè¯ç¼“å­˜æ˜¯å¦å·¥ä½œæ­£å¸¸ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ“¦é™¤æˆ‘ä»¬åç«™å®ˆæŠ¤ç¨‹åºçš„å›¾ç‰‡
:T2]

```
$ sudo docker rmi redis
Untagged: redis:latest
Untagged: redis@sha256:f30f134bd475d451ce3207fb128bcef8ff87d0f520a39cac0c4ea285819c42a9
Deleted: sha256:415381a6cb813ef0972eff8edac32069637b4546349d9ffdb8e4f641f55edcdd
Deleted: sha256:2a5a57892da005399e6ce7166c5521cdca43a07872f23995e210bde5dae2640e
Deleted: sha256:85e1fabde4fd4d6df993de44ef3e04d15cd69f9d309c0112c6a5054a6dc8351a
Deleted: sha256:2725175b62c7479ee209454110e8293080b9711e4f0a29219e358d1afba88787
Deleted: sha256:7ae66985fd3a3a132fab51b4a43ed32fd14174179ad8c3041262670523a6104c
Deleted: sha256:bf45690ef12cc54743675646a8e0bafe0394706b7f9ed1c9b11423bb5494665b
Deleted: sha256:237472299760d6726d376385edd9e79c310fe91d794bc9870d038417d448c2d5 
```

ç„¶åæˆ‘ä»¬å†æŠŠå®ƒæ‹¿å›æ¥:

```
sudo docker pull redis
Using default tag: latest
latest: Pulling from library/redis
f17d81b4b692: Pull complete
b32474098757: Pull complete
8980cabe8bc2: Pull complete
e614c66c2b9c: Pull complete
6eb43ec9256b: Pull complete
394ecf5f46d4: Pull complete
Digest: sha256:f30f134bd475d451ce3207fb128bcef8ff87d0f520a39cac0c4ea285819c42a9
Status: Downloaded newer image for redis:latest

~ took 13s 
```

è¿™èŠ±äº†æˆ‘ä»¬ 3 å€çš„æ—¶é—´ï¼ğŸ‘ä¸‹è½½å‡ ä¹æ˜¯ç¬æ—¶çš„
ï¼Œåªæœ‰è§£å‹éœ€è¦æ—¶é—´ã€‚

æœ‰äº†å®ƒï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªé€æ˜çš„æœ¬åœ°ç¼“å­˜ï¼Œå¯ä»¥å­˜æ”¾æ‰€æœ‰ä¸‹è½½çš„å›¾ç‰‡
ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„ VM æˆ–â€œ
â€ç½‘ç»œæœºå™¨æŒ‡å‘æ­¤ç¼“å­˜ï¼Œå¹¶åˆ©ç”¨æ‰€èŠ‚çœçš„æ—¶é—´ä½¿â€œ
â€æœ‰ç”¨ï¼Œè€Œä¸æ˜¯ä» internet ä¸‹è½½å­—èŠ‚:â€

æ­¤ç¼“å­˜çš„ä¸€ä¸ªæœ‰è¶£çš„å‰¯ä½œç”¨æ˜¯ï¼Œå¦‚æœä¸€ä¸ªâ€˜t0â€™åœ¨ä¸Šè½½è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœï¼Œ
å·²ç»ä¸Šè½½çš„ä¸­é—´æ˜ åƒå°†ä¿ç•™åœ¨ç¼“å­˜ä¸­ï¼Œå› æ­¤æ— éœ€å†æ¬¡ä¸‹è½½ã€‚æ‚¨å¯ä»¥é€šè¿‡åœæ­¢ä¸€ä¸ªâ€œ`pull`â€å¹¶é‡æ–°å¯åŠ¨â€œ
â€æ¥æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç†ã€‚

*è¿™ç¯‡æ–‡ç« æœ€åˆå‘è¡¨åœ¨[mayu . me](https://mayeu.me/blog/economiser-temps-bande-passante-cache-docker-local/)ä¸Šã€‚*