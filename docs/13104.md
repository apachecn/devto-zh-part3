# ä½¿ç”¨ React çš„ä¸Šä¸‹æ–‡ API å…±äº«çŠ¶æ€

> åŸæ–‡:[https://dev . to/sunny Singh/sharing-state-using-reactions-context-API-3623](https://dev.to/sunnysingh/sharing-state-using-reacts-context-api-3623)

React ä¸­çš„å…¨å±€çŠ¶æ€ä¸åƒ [Redux](https://redux.js.org/) è¿™æ ·çš„åº“æ˜¯åŒä¹‰è¯ã€‚å¦‚æœæ‚¨æ›¾ç»éœ€è¦ä¸å¤šä¸ªç»„ä»¶å…±äº«çŠ¶æ€ï¼Œæ¯”å¦‚å½“å‰çš„è·¯ç”±æˆ–æ¥è‡ª API çš„æ•°æ®ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½å·²ç»ä½¿ç”¨ Redux äº†ã€‚

è¾ƒæ–°ç‰ˆæœ¬çš„ React (16.3+)åŒ…å«äº†ä¸€ç§å…±äº«çŠ¶æ€çš„å†…ç½®æ–¹å¼ï¼Œè¿™æ„å‘³ç€ä¸å¿…å¼•å…¥å¤–éƒ¨åº“ã€‚è¿™è¢«ç§°ä¸º [React ä¸Šä¸‹æ–‡ API](https://reactjs.org/docs/context.html) ï¼Œå­¦ä¹ èµ·æ¥å¯èƒ½æœ‰ç‚¹æ£˜æ‰‹ã€‚æˆ‘å¸Œæœ›æä¾›ä¸€ä¸ªç®€åŒ–çš„è§£é‡Šå’Œæ•™ç¨‹ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥å¿«é€Ÿåœ°å°†å…¨å±€çŠ¶æ€æ·»åŠ åˆ°ä»»ä½• React åº”ç”¨ç¨‹åºä¸­ã€‚

## æˆ‘ä»¬è¯•å›¾è§£å†³çš„é—®é¢˜

åœ¨æ·±å…¥ä¸Šä¸‹æ–‡ API ä¹‹å‰ï¼Œè®©æˆ‘å…ˆæè¿°ä¸€ä¸ªé—®é¢˜åœºæ™¯ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»ªè¡¨æ¿ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­æ›´æ–°ä»–ä»¬çš„ç”¨æˆ·åã€‚ç”¨æˆ·åæ˜¾ç¤ºåœ¨æ•´ä¸ªä»ªè¡¨æ¿ä¸Šï¼Œè¿™æ„å‘³ç€ç”¨æˆ·åå°†å­˜å‚¨åœ¨ç»„ä»¶çŠ¶æ€ä¸­ï¼Œç„¶åé€šè¿‡ props ä¼ é€’ç»™å…¶ä»–ç»„ä»¶ã€‚

å¦‚æœæ²¡æœ‰ä¸Šä¸‹æ–‡ APIï¼Œæˆ‘ä»¬å°†ä¼šè¿™æ ·åš:

```
class Dashboard extends React.Component {
  state = { username: '' };

  render() {
    return (
      <div>
        <WelcomeMessage username={this.state.username} />
        <SettingsForm
          username={this.state.username}
          updateUsername={newUsername => {
            this.setState({ username: newUsername });
          }}
        />
      </div>
    );
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨æˆ·åå­˜å‚¨åœ¨`Dashboard`ç»„ä»¶çš„çŠ¶æ€ä¸­ï¼Œç„¶åé€šè¿‡`username` prop ä¼ é€’ç»™`<WelcomeMessage>`å’Œ`<SettingsForm>`ç»„ä»¶ã€‚ä¸€ä¸ªé¢å¤–çš„å±æ€§è¢«ä¼ é€’ç»™è¡¨å•ä»¥æ›´æ–°çŠ¶æ€ï¼Œç„¶åè¡¨å•å°†ä½¿ç”¨æ–°çš„ç”¨æˆ·åé‡æ–°å‘ˆç°ä»ªè¡¨æ¿ã€‚

ç°åœ¨å¾ˆéš¾çœ‹å‡ºè¿™æœ‰ä»€ä¹ˆé—®é¢˜ã€‚è€ƒè™‘ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬å‘ä»ªè¡¨æ¿æ·»åŠ æ›´å¤šæ·±åº¦åµŒå¥—çš„ç»„ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆã€‚

```
<Dashboard>
  <WelcomeMessage>
    <MessageList>
      <UserMessage>
        <p>Need to show username here...</p> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘è¯•å›¾è¯´æ˜`<UserMessage>`æ˜¯ä»ªè¡¨æ¿å†…éƒ¨çš„ 3 ä¸ªç»„ä»¶å±‚ã€‚ä¸ºäº†å°†ç”¨æˆ·åä¼ é€’ç»™å®ƒï¼Œæˆ‘ä»¬éœ€è¦åšæ‰€è°“çš„â€œé“å…·è®­ç»ƒâ€:

```
<Dashboard>
  <WelcomeMessage username={this.state.username} />
    <MessageList username={this.props.username} />
      <UserMessage>
        <p>Hello {this.props.username}!</p> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

éšç€æˆ‘ä»¬æ·»åŠ æ›´å¤šçš„çŠ¶æ€å’ŒåµŒå¥—ç»„ä»¶ï¼Œè¿™ä¼šå˜å¾—éå¸¸ä¹å‘³ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½éœ€è¦åœ¨ä»ªè¡¨æ¿ä¹‹å¤–è®¿é—®ç”¨æˆ·åã€‚

## [](#how-to-use-the-context-api)å¦‚ä½•ä½¿ç”¨ä¸Šä¸‹æ–‡ API

è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å†…ç½®çš„ [React ä¸Šä¸‹æ–‡ API](https://reactjs.org/docs/context.html) ã€‚

å®ƒå…è®¸æ‚¨é¿å…é€‚å½“çš„é’»å–ï¼Œè¿™æ„å‘³ç€åœ¨æˆ‘ä»¬å‰é¢çš„ä¾‹å­ä¸­,`<UserMessage>`ç»„ä»¶å°†ç›´æ¥è®¿é—®æœ€åˆå­˜å‚¨åœ¨`<Dashboard>`ç»„ä»¶ä¸­çš„ç”¨æˆ·åçŠ¶æ€ã€‚

> **æ³¨æ„**:ä¸€ä¸ªå®Œæ•´çš„å·¥ä½œç¤ºä¾‹æ˜¯åœ¨ CodeSandbox ä¸Šæä¾›çš„[ã€‚](https://codesandbox.io/s/kk3myozr5o)

### [](#create-provider-and-consumer-components)åˆ›å»ºæä¾›è€…å’Œæ¶ˆè´¹è€…ç»„ä»¶

è®©æˆ‘ä»¬é¦–å…ˆä¸ºæ‚¨çš„ä¸Šä¸‹æ–‡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚æˆ‘å°±å«å®ƒ`user-context.js`ã€‚

åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import React, { createContext } from 'react';

const UserContext = createContext({
  username: '',
  updateUsername: () => {},
});

export class UserProvider extends React.Component {
  updateUsername = newUsername => {
    this.setState({ username: newUsername });
  };

  state = {
    username: 'user',
    updateUsername: this.updateUsername,
  };

  render() {
    return (
      <UserContext.Provider value={this.state}>
        {this.props.children}
      </UserContext.Provider>
    );
  }
}

export const UserConsumer = UserContext.Consumer; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬æŠŠè¿™ä¸ªæ–‡ä»¶åˆ†è§£ä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œä½¿ç”¨`createContext()`åˆ›å»ºç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚è¿™é‡Œçš„å€¼å°†è¢«`UserProvider`è¦†ç›–ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`UserProvider`ç»„ä»¶ï¼Œå®ƒå°†ä½œä¸ºçˆ¶ç»„ä»¶æ¥ä¿å­˜å’Œç®¡ç†å…±äº«çŠ¶æ€ã€‚å¯ä»¥æŠŠè¿™çœ‹ä½œæ˜¯æˆ‘ä»¬æœ€æ—©çš„ä¾‹å­ä¸­çš„`<Dashboard>`ç»„ä»¶çš„ç­‰ä»·ç‰©ã€‚

æœ€åï¼Œæˆ‘ä»¬å¯¼å‡ºä¸€ä¸ª`UserConsumer`ç»„ä»¶ï¼Œå®ƒå°†å…è®¸ç»„ä»¶è®¿é—®å…±äº«çŠ¶æ€ã€‚

### [](#using-the-provider)ä½¿ç”¨æä¾›è€…

`<UserProvider>`ç»„ä»¶éœ€è¦åŒ…è£…æ‰€æœ‰å…±äº«çŠ¶æ€çš„ç»„ä»¶ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†å®ƒæ·»åŠ åˆ°æ‚¨çš„ä¸»åº”ç”¨ç¨‹åºç»„ä»¶ä¸­ï¼Œè¯¥ç»„ä»¶é€šå¸¸æ˜¯ React å‘ˆç°ç»™ DOM çš„ç»„ä»¶ã€‚

```
import React from 'react';
import ReactDOM from 'react-dom';
import UserMessage from './UserMessage';
import SettingsForm from './SettingsForm';
import { UserProvider } from './user-context';

function App() {
  return (
    <UserProvider>
      <UserMessage />
      <SettingsForm />
    </UserProvider>
  );
}

const rootElement = document.getElementById('root');
ReactDOM.render(<App />, rootElement); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜åœ¨è¿™é‡Œå¯¼å…¥äº†å¦å¤–ä¸¤ä¸ªç»„ä»¶:`UserMessage`å’Œ`SettingsForm`ã€‚è¿™ä¸¤ä¸ªç»„ä»¶å°†è®¿é—®å…±äº«ç”¨æˆ·çŠ¶æ€ã€‚

### [](#using-the-consumer-to-read-state)ä½¿ç”¨æ¶ˆè´¹è¯»å–çŠ¶æ€

å…±äº«çŠ¶æ€çš„ä¸€ä¸ªç”¨ä¾‹æ˜¯æ˜¾ç¤ºå®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ˜¾ç¤ºå½“å‰ç”¨æˆ·åã€‚åˆ›å»ºä¸€ä¸ªåä¸º`UserMessage.js`çš„æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import React from 'react';
import { UserConsumer } from './user-context';

export default function UserMessage() {
  return (
    <UserConsumer>
      {({ username }) => <h1>Welcome {username}!</h1>}
    </UserConsumer>
  );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ˜¾ç¤ºâ€œæ¬¢è¿ç”¨æˆ·åâ€æ¶ˆæ¯çš„`UserMessage`ç»„ä»¶ã€‚ç”¨æˆ·åæ˜¯ä»ä»`user-context.js`å¯¼å‡ºçš„`UserConsumer`ç»„ä»¶ä¸­è·å–çš„ã€‚

åœ¨`<UserConsumer>`é‡Œé¢ï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ªå«åš[çš„æ¸²æŸ“é“å…·](https://reactjs.org/docs/render-props.html)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è·å–çŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç”¨å®ƒæ¥å‘ˆç°ä¸€äº›ä¸œè¥¿ã€‚

### [](#using-the-consumer-to-update-state)ä½¿ç”¨æ¶ˆè´¹è€…æ›´æ–°çŠ¶æ€

å…±äº«çŠ¶æ€çš„å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯æ›´æ–°å®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªè¡¨å•æ¥æ›´æ–°ä»–ä»¬çš„ç”¨æˆ·åã€‚åˆ›å»ºä¸€ä¸ªåä¸º`UserSettings.js`çš„æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹:

```
import React from 'react';
import { UserConsumer } from './user-context';

export default function UserSettings() {
  return (
    <UserConsumer>
      {({ updateUsername }) => (
        <div>
          <h2>Settings</h2>
          <label htmlFor="username">Username: </label>
          <input
            id="username"
            type="text"
            onChange={event => {
              updateUsername(event.target.value);
            }}
          />
        </div>
      )}
    </UserConsumer>
  );
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç±»ä¼¼äºå‰é¢çš„ä¾‹å­ï¼Œé™¤äº†æˆ‘ä»¬ä¸æ˜¯è·å–ç”¨æˆ·åï¼Œè€Œæ˜¯è·å–`updateUsername`å‡½æ•°æ¥æ›´æ–°å®ƒã€‚

## [](#overview)æ¦‚è¿°

å¦‚æœä½ åœ¨è¿™ä¸€ç‚¹ä¸Šæ„Ÿåˆ°å›°æƒ‘ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ çœ‹ä¸€ä¸‹[å·¥ä½œä»£ç æ²™ç®±ç¤ºä¾‹](https://codesandbox.io/s/kk3myozr5o)ï¼Œå®ƒæŠŠæ‰€æœ‰çš„ä¸œè¥¿éƒ½é›†åˆåœ¨ä¸€èµ·ã€‚

æ­¤å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä¸»è¦æ¦‚å¿µçš„å¿«é€Ÿæ¦‚è¿°:

*   æä¾›è€…ç»„ä»¶åŒ…è£…æ•´ä¸ªåº”ç”¨ç¨‹åºæ¥ç®¡ç†å…±äº«çŠ¶æ€ã€‚
*   æ¶ˆè´¹è€…ç»„ä»¶ç”¨äºè®¿é—®æˆ–æ›´æ–°å…±äº«çŠ¶æ€ã€‚
*   `user-context.js`æ–‡ä»¶å¯¼å‡ºè¿™ä¸¤ä¸ªç»„ä»¶ï¼Œå…±äº«çŠ¶æ€å­˜å‚¨åœ¨`<UserProvider>`ç»„ä»¶ä¸­ã€‚
*   é€šè¿‡ç®€å•åœ°å¯¼å…¥å’Œä½¿ç”¨`<UserConsumer>`ç»„ä»¶ï¼Œ`<UserMessage>`å’Œ`<SettingsForm>`ç»„ä»¶è¯»å–å’Œæ›´æ–°å…±äº«çŠ¶æ€ã€‚
*   å‡è®¾`<UserProvider>`æ­£åœ¨åŒ…è£…ä½ çš„æ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œä½ å¯ä»¥ä»åº”ç”¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹è¯»å–å’Œå…±äº«çŠ¶æ€ã€‚

å°±æ˜¯è¿™æ ·ã€‚æ‚¨å¯ä»¥éšæ„ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥å…±äº«å¯¼èˆªã€æ¨¡æ€ç”šè‡³æ•°æ®çš„çŠ¶æ€ã€‚æƒåŠ›åœ¨ä½ æ‰‹ä¸­ğŸ’ª

> **æ³¨**:æœ¬æ–‡åŸå†™äº[æˆ‘çš„ä¸ªäººåšå®¢](https://sunnysingh.io/blog/react-context-api)ã€‚æˆ‘åœ¨è¿™é‡Œä¸ºç¥å¥‡çš„å¼€å‘è€…ç¤¾åŒºé‡æ–°å‘å¸ƒå®ƒã€‚