# GraphQL æœåŠ¡å™¨æœªè®¾ç½® JWT Cookie

> åŸæ–‡:[https://dev . to/doylecodes/graph QL-server-not-setting-jwt-cookie-1g me](https://dev.to/doylecodes/graphql-server-not-setting-jwt-cookie-1gme)

## [](#solution)è§£ï¼

ä¸‹é¢æ˜¯è¿™ä¸ªåŸå¸–
ä¸­é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ

[![doylecodes image](../Images/002cdee0566e4615dfc5506844df12f9.png)](/doylecodes) [## é˜¿æ³¢ç½—å®¢æˆ·ç«¯å’Œé˜¿æ³¢ç½—æœåŠ¡å™¨ä¸­çš„ CORS

### ç‘å®‰é“å°” 1919 å¹´ 5 æœˆ 1 æ—¥ 3 åˆ†é’Ÿé˜…è¯»

#apollo #tutorial #react #express](/doylecodes/cors-in-apollo-client-apollo-server-3cbj)

## [](#original-post)åŸå¸–

èªæ˜äººå¥½ï¼æˆ‘å¸Œæœ›æœ‰äººèƒ½å¸®æˆ‘è§£å†³ä¸€ä»¶å›°æ‰°æˆ‘å¾ˆä¹…çš„äº‹æƒ…ã€‚

æˆ‘å‚åŠ è¿‡ä¸€ä¸ª WesBos è¯¾ç¨‹(Advanced React ),éå¸¸æ£’ï¼Œå®ƒä½¿ç”¨ä¿å­˜ä¸º cookies çš„ JWT è¿›è¡Œèº«ä»½éªŒè¯ã€‚æˆ‘ä¸€ç›´åœ¨åšè‡ªå·±çš„é¡¹ç›®ï¼Œå¹¶å†³å®šåšåŒæ ·çš„äº‹æƒ…ã€‚æœ€åˆï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ Apollo Server 2ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘çš„ cookies æ²¡æœ‰ä¿å­˜ï¼Œæ‰€ä»¥æˆ‘æƒ³ï¼Œâ€œå˜¿ï¼Œæˆ‘æ˜¯ç”¨ GraphQL Yoga æœåŠ¡å™¨åšçš„ï¼Œæ‰€ä»¥æˆ‘å°±è¿™æ ·åšå§ã€‚â€åœ¨ç”¨ apollo-server-express æœåŠ¡å™¨åšäº†ä¸€äº›å°è¯•ä¹‹å)ã€‚

é•¿è¯çŸ­è¯´ï¼Œæˆ‘è¿˜æ˜¯å¡ä½äº†ã€‚æˆ‘æƒ³æˆ‘å¯ä»¥é—®ä¸€ä¸‹ StackOverflowï¼Œä½†æ˜¯é‚£è¾¹ä¸å¤ªå¥½ï¼å¥¹æ˜¯æˆ‘çš„ä¸€åˆ‡...

### [](#indexjs)index.js

```
const { Prisma } = require('prisma-binding');
const express = require('express');
const { ApolloServer } = require('apollo-server-express');
const { GraphQLServer } = require('graphql-yoga');
const { importSchema } = require('graphql-import');
const cookieParser = require('cookie-parser');
const jwt = require('jsonwebtoken');
require('dotenv').config();

const typeDefs = importSchema('./src/schema.graphql');
const Query = require('./src/resolvers/Query');
const Mutation = require('./src/resolvers/Mutation');

const db = new Prisma({
  typeDefs: './generated/prisma.graphql',
  endpoint: process.env.DB_ENDPOINT,
  secret: process.env.DB_SECRET
});

const server = new GraphQLServer({
  typeDefs,
  resolvers: {
    Mutation,
    Query
  },
  context: req => ({ ...req, db })
});

server.express.use(cookieParser());
server.express.use((req, res, next) => {
  const { token } = req.cookies;
  if (token) {
    const { userId } = jwt.verify(token, process.env.APP_SECRET);
    // add the user to future requests
    req.userId = userId;
  }
  next();
});

server.start({ //start the GraphQL server
  cors: { // only allow from frontend server (frontend_url)
    credentials: true,
    port: 4000,
    origin: ['http://localhost:3000'],
  },
}, postStart => { //callback once connection is created
  console.log(`ğŸš€ Server now running on http://localhost:${postStart.port}`);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#my-mutation-for-logging-in)æˆ‘çš„ç™»å½•çªå˜

```
async signin(parent, { email, password }, ctx, info) {
    const user = await ctx.db.query.user({ where: { email: email } });
    if (!user) {
      throw new Error(`No such user found for the email ${email}`);
    }
    const valid = await bcrypt.compare(password, user.password);
    if (!valid) {
      throw new Error(`password is not valid!`);
    }
    const token = jwt.sign({ userId: user.id }, process.env.USER_SECRET);

    ctx.response.cookie('token', token, {
      httpOnly: true,
      maxAge: 1000 * 60 * 60 * 24 * 31,
    });
    console.log(ctx.response);
    return user;
  }, 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨ç°åœ¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘åœ¨æˆ‘çš„å˜å¼‚ä¸­è®¾ç½®äº†ä¸€ä¸ª console.log æ¥è®°å½•å“åº”ã€‚æˆ‘å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªå®é™…çš„å“åº”ï¼Œå®ƒè¯´:

```
 body:
      { operationName: 'LOGIN_MUTATION',
        variables: [Object],
        query:
         'mutation LOGIN_MUTATION($email: String!, $password: String!) {\n  signin(email: $email, password: $password) {\n    id\n    name\n    email\n    __typename\n  }\n}\n' },
     _body: true,
     length: undefined },
  locals: [Object: null prototype] {},

  [Symbol(outHeadersKey)]:
   [Object: null prototype] {
     'x-powered-by': [ 'X-Powered-By', 'Express' ],
     'access-control-allow-origin': [ 'Access-Control-Allow-Origin', 'http://localhost:3000' ],
     vary: [ 'Vary', 'Origin' ],
     'access-control-allow-credentials': [ 'Access-Control-Allow-Credentials', 'true' ],
     'set-cookie':
      [ 'Set-Cookie',   'token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjanRreG5kZG9henlpMGIwMG8yamwwZzg1IiwiaWF0IjoxNTU0MDc0MDU1fQ.h617eZ1LV3yUqn01jpMaTZDTUlYQmRMxwZc1VKbSHns; Max-Age=2678400; Path=/; Expires=Wed, 01 May 2019 23:14:15 GMT; HttpOnly' ] } } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥æˆ‘åœ¨æœ€åçœ‹åˆ°äº†è¿™ä¸ª Set-Cookieï¼Œä½†æ˜¯ä¸ç®¡æˆ‘æ€ä¹ˆå°è¯•ï¼Œæ²¡æœ‰ Cookie è¢«ä¿å­˜:(

æˆ‘ç”šè‡³è¯•ç€å¤åˆ¶æˆ‘åœ¨è¯¾ç¨‹ä¸­æ‰€åšçš„äº‹æƒ…(å°½ç®¡è½¯ä»¶åŒ…ç•¥æœ‰ä¸åŒ)ä»¥é¿å…è¿æ°”ä¸ä½³ã€‚

èªæ˜çš„äººä»¬ï¼Œæˆ‘é”™è¿‡äº†ä»€ä¹ˆï¼Ÿæˆ‘æ„Ÿè§‰æˆ‘æƒ³åœ¨çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆä¹‹åå†™ä¸€ç¯‡å…³äºè¿™ä¸ªçš„å¸–å­...

**æ›´æ–°:**

*   æˆ‘çŸ¥é“æˆ‘çš„ env å˜é‡å·¥ä½œæ­£å¸¸ï¼Œæˆ‘åœ¨åº”ç”¨ç¨‹åºä¸­æœ‰å…¶ä»–å·¥ä½œæ­£å¸¸çš„å˜åŒ–ã€‚å¦‚æœæˆ‘ä»æˆ‘çš„ã€‚ç¯å¢ƒæ–‡ä»¶ã€‚
*   æˆ‘è®¤ä¸ºè¿™ä¸ CORS æœ‰å…³ï¼Œå› ä¸ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨ä¸åŒçš„æœ¬åœ°ä¸»æœºä¸Šã€‚

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png) [ç‘å®‰å§†é“å°”](https://github.com/ryanmdoyle) / [çƒ­é±¼å­¦å®¶](https://github.com/ryanmdoyle/thermoFisherSci)

### é›¶ä»¶åº“å­˜æè¿°è·Ÿè¸ªè€…/ç¼–è¾‘è€…/å¯¼å‡ºè€…ã€‚å…è®¸ä»¥å¤šç§è¯­è¨€è¾“å…¥å’Œé€€å‡ºé›¶ä»¶æè¿°ï¼Œä»¥å¯¼å‡ºä¸º HTMLï¼Œç”¨äº web åº”ç”¨ç¨‹åºã€‚

<article class="markdown-body entry-content container-lg" itemprop="text">

# ThermoFisher ç§‘å­¦éƒ¨åˆ†æè¿°

é›¶ä»¶åº“å­˜æè¿°è·Ÿè¸ªè€…/ç¼–è¾‘è€…/å¯¼å‡ºè€…ã€‚å…è®¸ä»¥å¤šç§è¯­è¨€è¾“å…¥å’Œé€€å‡ºé›¶ä»¶æè¿°ï¼Œä»¥å¯¼å‡ºä¸º HTMLï¼Œç”¨äº web åº”ç”¨ç¨‹åºã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯åŠ¨åº”ç”¨ç¨‹åº:

1.  ä»å‰ç«¯å’Œåç«¯æ–‡ä»¶å¤¹å®‰è£… npmã€‚
2.  æ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ª prisma å¸æˆ·ï¼Œå¹¶ä»åç«¯éƒ¨ç½²åˆ° Prismaã€‚
3.  ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨åç«¯åˆ›å»ºä¸€ä¸ª. env æ–‡ä»¶:

*   DB_ENDPOINT(è®¾ç½®ä¸ºæ‚¨çš„ prisma ç«¯ç‚¹)
*   DB_SECRET(éšæœºç”Ÿæˆä¸€ä¸ªç§˜å¯†ä¾› prisma ä½¿ç”¨)
*   USER_SECRET(ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„éšæœºå¯†ç )
*   COOKIE_SECRET(ç”¨äº COOKIE ç”Ÿæˆçš„éšæœºå†…å®¹)
*   FRONTEND_URL=http:æœ¬åœ°ä¸»æœº:3000
*   APP_SECRET(ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„éšæœºå†…å®¹)

4.  åˆ¶é€ ã€‚å‰ç«¯ç¯å¢ƒ

*   èŠ‚ç‚¹ç¯å¢ƒ=å¼€å‘

5.  npm ä»å‰ç«¯(localhost: 3000)å’Œåç«¯(localhost:4000)è¿è¡Œ dev
6.  å‚è§ locahost çš„åº”ç”¨ç¨‹åº:3000

</article>

[View on GitHub](https://github.com/ryanmdoyle/thermoFisherSci)