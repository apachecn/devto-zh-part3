# ç”¨ C#ç¼–å†™æœ¬åœ°åº“å¹¶åœ¨å…¶ä»–è¯­è¨€ä¸­ä½¿ç”¨å®ƒä»¬

> åŸæ–‡:[https://dev.to/mhmd_azeez/writing-native-libraries-in-c-3kl](https://dev.to/mhmd_azeez/writing-native-libraries-in-c-3kl)

> æ³¨:Stefan Hausotte å·²ç»æŠŠ[è¿™ä¸ªå°å®éªŒç§»æ¤åˆ° F#](https://secanablog.wordpress.com/2020/02/01/writing-a-native-library-in-f-which-can-be-called-from-c/) ä¸Šäº†ã€‚

æœ€è¿‘æˆ‘å¶ç„¶å‘ç°äº†æ¥è‡ª[çš„](https://twitter.com/MStrehovsky)è¿™ç¯‡æ–‡ç« ã€‚è¿™æ˜¯å¯¹ CoreRT çš„ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»ï¼Œå®ƒè®©æˆ‘å¾ˆå¥½å¥‡ï¼Œä½ èƒ½ç”¨ CoreRT ç¼–å†™æœ¬åœ°åº“å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼

> ![Michal StrehovskÃ½ profile image](../Images/a6112e6d426741a717a7d31dcd673fe4.png)ç±³å“ˆå°”Â·æ–¯ç‰¹åˆ—éœå¤«æ–¯åŸº@ mstrehovsky![twitter logo](../Images/65e26e35707d96169ec8af6b3cbf2003.png)[@ mhmd _ aze ez](https://twitter.com/mhmd_azeez)[@ xoofx](https://twitter.com/xoofx)CoreRT å¯ä»¥ç”Ÿæˆã€‚dll/ã€‚æ‰€ä»¥/ã€‚è¿ªåˆ©å¸ƒå’Œã€‚lib/ã€‚ä¸€ç§å¯¼å‡º C#å‡½æ•°çš„æ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼ä½¿å¾—å®ƒä»¬å¯ä»¥é€šè¿‡æ ‡å‡†çš„ FFI ç›´æ¥è°ƒç”¨ã€‚ä¸€ä¸ªæ ·æœ¬é¢„æ’åœ¨è¿™é‡Œ:[github.com/dotnet/corert/â€¦](https://t.co/7N0ll44jMA)2019 å¹´ 05 æœˆ 02 æ—¥ä¸Šåˆ 07:58[![Twitter reply action](../Images/e5d6036ea29f7fc2ceecadd7806ec22d.png)](https://twitter.com/intent/tweet?in_reply_to=1123859217654460424)[![Twitter retweet action](../Images/045a8cb35300a0b869b6787434707687.png)](https://twitter.com/intent/retweet?tweet_id=1123859217654460424)0[![Twitter like action](../Images/1bf915c7b46baf6310d9eb9b48e72a89.png)](https://twitter.com/intent/like?tweet_id=1123859217654460424)3

æˆ‘æœ‰ä¸€ä¸ªå°çš„åº“ï¼Œæˆ‘å¸Œæœ›å®ƒèƒ½æ”¯æŒå¤šç§è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘å¯¹å®ƒå¾ˆæ„Ÿå…´è¶£ã€‚æ‰€ä»¥æˆ‘è¯•ç”¨äº†[å®˜æ–¹æ ·å“](https://github.com/dotnet/corert/tree/master/samples/NativeLibrary)ï¼Œå¯¹ç»“æœå¾ˆæ»¡æ„ã€‚

æˆ‘ç”¨`dotnet publish /p:NativeLib=Shared -r win-x64 -c Release`ç¼–è¯‘äº†è¿™ä¸ªåº“ï¼Œå®ƒäº§ç”Ÿäº†ä¸€ä¸ª 4.52 MB çš„ dllã€‚åœ¨ Michal çš„å¸®åŠ©ä¸‹ï¼ŒæŒ‰ç…§æœ¬æ–‡ä¸­[çš„æ­¥éª¤ï¼Œæˆ‘èƒ½å¤Ÿå°†å¤§å°é™ä½åˆ° 1.67 MBï¼Œå¯¹æˆ‘æ¥è¯´å·²ç»è¶³å¤Ÿå¥½äº†ã€‚](https://github.com/dotnet/corert/blob/master/Documentation/using-corert/optimizing-corert.md)

å®˜æ–¹ç¤ºä¾‹ä¸­çš„[æœ‰ä¸€ä¸ªç±»](https://github.com/dotnet/corert/blob/master/samples/NativeLibrary/Class1.cs)ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæ–¹æ³•:`Add`å’Œ`WriteLine`ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ¼”ç¤ºäº†å¦‚ä½•å°†åŸè¯­å’Œå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCoreRT åªå…è®¸åŸè¯­ä½œä¸ºå‚æ•°ç±»å‹ï¼Œä½ å¿…é¡»å°é€ä»»ä½•æ›´å¤æ‚çš„ä¸œè¥¿ã€‚ç„¶è€Œï¼Œ`System.Runtime.InteropServices.Marshal`ç¡®å®æœ‰äº›æœ‰ç”¨çš„æ–¹æ³•ã€‚

```
public class Class1
{
    [NativeCallable(EntryPoint = "add", CallingConvention = CallingConvention.StdCall)]
    public static int Add(int a, int b)
    {
        return a + b;
    }

    [NativeCallable(EntryPoint = "write_line", CallingConvention = CallingConvention.StdCall)]
    public static int WriteLine(IntPtr pString)
    {
        // The marshalling code is typically auto-generated by a custom tool in larger projects.
        try
        {
            // NativeCallable methods only accept primitive arguments. The primitive arguments
            // have to be marshalled manually if necessary.
            string str = Marshal.PtrToStringAnsi(pString);

            Console.WriteLine(str);
        }
        catch
        {
            // Exceptions escaping out of NativeCallable methods are treated as unhandled exceptions.
            // The errors have to be marshalled manually if necessary.
            return -1;
        }
        return 0;
    }
} 
```

ç”¨`NativeCallable`ä¿®é¥°çš„æ–¹æ³•ä¸èƒ½é€šè¿‡æ™®é€šçš„ C#æ–¹æ³•è°ƒç”¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ P/Invoke è°ƒç”¨ğŸ˜ˆã€‚

ä¸ºæ­¤ï¼Œæ‚¨å¿…é¡»:

1.  é€šè¿‡åœ¨å…¶æ–‡ä»¶å¤¹ä¸­è¿è¡Œ`dotnet publish /p:NativeLib=Shared -r win-x64 -c Release`æ¥æ„å»ºæœ¬åœ°åº“ã€‚
2.  åˆ›å»ºä¸€ä¸ªæ–°çš„æ§åˆ¶å° app(æˆ‘åˆ›å»ºäº†ä¸€ä¸ª dotnet æ ¸å¿ƒæ§åˆ¶å° appï¼Œä¸è¿‡æ²¡å…³ç³»)ã€‚
3.  å³é”®ç‚¹å‡»é¡¹ç›®ï¼Œç‚¹å‡»`Add => Exisiting Item`ã€‚
4.  æµè§ˆåˆ°æœ¬åœ°åº“é¡¹ç›®çš„`bin\Release\netcoreapp2.2\win-x64\native`æ–‡ä»¶å¤¹ï¼Œç„¶åé€‰æ‹© dll å¹¶ç‚¹å‡»`Add As Link`ã€‚
5.  åœ¨è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­å³å‡» dllï¼Œç„¶åå•å‡»å±æ€§ã€‚
6.  å°†`Copy to Output Directory`æ”¹ä¸º`Copy if newer`ã€‚
7.  å°†è§£å†³æ–¹æ¡ˆå¹³å°æ›´æ”¹ä¸º`x64` ![Solutions Platform](../Images/9967af9c9a4523f2eda4e03d94259dab.png)
8.  ç„¶åå°†`Program.cs`ä¸­çš„ä»£ç ä¿®æ”¹å¦‚ä¸‹:

```
class Program
{
    [DllImport("NativeLibrary.dll", EntryPoint = "add", CallingConvention = CallingConvention.StdCall)]
    public static extern int Add(int a, int b);

    [DllImport("NativeLibrary.dll", EntryPoint = "write_line", CallingConvention = CallingConvention.StdCall)]
    public static extern void WriteLine(string text);

    static void Main(string[] args)
    {
        var result = Add(1, 2);
        WriteLine(result.ToString());
        WriteLine("Hello World!");
    }
} 
```

ç°åœ¨è¿è¡Œæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œæ‚¨å°†å¾—åˆ°å¦‚ä¸‹è¾“å‡º:

```
3
Hello World! 
```

[![But Why?](../Images/9b141613943bd410baa7487f7357fcbe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--57Z1LlF2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/84kbvfvss1xwiy7vnvbx.gif)

ç°åœ¨ p/è°ƒç”¨è¿™ä¸ªåº“å¯èƒ½ä¸æ˜¯å¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯å°†ä¸€ä¸ªç±»åº“ç¼–è¯‘ä¸ºæœ¬æœºåº“ä¸ºå…¶ä»–è¯­è¨€è°ƒç”¨è¿™ä¸ªåº“æ‰“å¼€äº†å¤§é—¨ã€‚

è¿™æ˜¯ä¸€ä¸ªæ¼«é•¿è€Œç—›è‹¦çš„è¿‡ç¨‹ï¼Œä½†æˆ‘æœ€ç»ˆèƒ½å¤Ÿä» C++åº”ç”¨ç¨‹åºä¸­å¼•ç”¨è¿™ä¸ªåº“ã€‚è¿™ä¸ª[è§†é¢‘](https://youtu.be/or1dAmUO8k0)å’Œè¿™ä¸ª[æ–‡ç« ](https://docs.microsoft.com/en-us/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=vs-2019)è¶…çº§æœ‰ç”¨ã€‚

ä¸‹é¢æ˜¯æ­¥éª¤:
1ã€‚å‘è§£å†³æ–¹æ¡ˆä¸­æ·»åŠ ä¸€ä¸ªç©ºçš„ C++é¡¹ç›®ã€‚

2 .æ·»åŠ ä¸€ä¸ªæºæ–‡ä»¶å¹¶ç²˜è´´åˆ°ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
#include <iostream>
#include <NativeLibrary.h> using namespace std;

void main()
{
    int result = add(1, 2);
    cout << result << endl;
    write_line("Hello World!");
} 
```

3 .åˆ›å»ºä¸€ä¸ªåä¸º`NativeLibrary.h`(è¿™æ˜¯åº“çš„åç§°)çš„æ–°å¤´æ–‡ä»¶ï¼Œå¹¶ç²˜è´´ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
#pragma once extern "C" int __stdcall add(int a, int b);
extern "C" void __stdcall write_line(const char* pString); 
```

å¦‚ä½ æ‰€è§ï¼Œæˆ‘å†™äº†ä»`NativeLibrary`å¯¼å‡ºçš„å‡½æ•°çš„ç­¾åã€‚

4 .å³é”®å•å‡» C++é¡¹ç›®ï¼Œç„¶åå•å‡» Propertiesã€‚

5 .ä»`Configuration:`ä¸­é€‰æ‹©`All Configurations`ã€‚è¿™å°†ç¡®ä¿æ›´æ”¹é€‚ç”¨äº`Release`å’Œ`Debug`é…ç½®(ä»¥åŠæ‚¨å¯èƒ½æ‹¥æœ‰çš„ä»»ä½•å…¶ä»–é…ç½®)ã€‚

6 .è½¬åˆ° Generalï¼Œå°†`Output Directory`æ”¹ä¸º`$(ProjectDir)bin\$(Platform)\$(Configuration)\`ã€‚è¿™æ˜¯ä¸å¿…è¦çš„ï¼Œä½†æˆ‘è§‰å¾—è¿™æ ·æ›´è‡ªåœ¨ã€‚

7 .è½¬åˆ°`C\C++` > `Linker` > `General`ï¼Œå°†`$(SolutionDir)NativeLibrary\bin\Release\netcoreapp2.2\win-x64\native`æ·»åŠ åˆ°`Additional Library Directories`ã€‚è¿™å…è®¸é“¾æ¥å™¨å‘ç°`NativeLibrary.lib`ã€‚

8 .è¿›å…¥`C\C++` > `Linker` > `Input`ï¼Œå°†`NativeLibrary.lib`æ·»åŠ åˆ°`Additional Dependencies`åˆ—è¡¨ä¸­ã€‚

9 .è½¬åˆ°`Build Events` > `Post-Build Event`ï¼Œå°†è¿™æ®µä»£ç ç²˜è´´åˆ°`Command Line` :

```
xcopy /y /d "$(SolutionDir)NativeLibrary\bin\Release\netcoreapp2.2\win-x64\native\NativeLibrary.dll" "$(OutDir)" 
```

æ¯å½“æ‚¨æ„å»º C++é¡¹ç›®æ—¶ï¼Œè¿™ä¼šå°†`NativeLibrary.dll`å¤åˆ¶åˆ°è¾“å‡ºç›®å½•ä¸­ã€‚

10 .æ„å»ºå¹¶è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡º:

```
3
Hello World! 
```

å¦‚æœè¿™ä¸é…·ï¼Œæˆ‘ä¸çŸ¥é“ä»€ä¹ˆæ˜¯é…·ã€‚

æºä»£ç [å¯åœ¨ GitHub](https://github.com/encrypt0r/CoreRTDemo) ä¸Šè·å¾—ã€‚