# å±€åŸŸç½‘å†…çš„æœåŠ¡å‘ç°

> åŸæ–‡:[https://dev.to/itzmeanjan/service-discovery-within-lan-1cap](https://dev.to/itzmeanjan/service-discovery-within-lan-1cap)

## [](#idea)æƒ³æ³•

è®©æˆ‘ä»¬å‡è®¾ä¸€ç§æƒ…å†µâ€”â€”ä½ æœ‰ä¸¤ä¸ªè®¾å¤‡åœ¨åŒä¸€ä¸ª*å±€åŸŸç½‘*å†…ï¼Œä½ æƒ³ä»*è®¾å¤‡ A* å‘*è®¾å¤‡ B* å‘é€ä¸€ä¸ªæ–‡ä»¶ã€‚

```
 deviceA -> deviceB 
```

> é‚£ä½ ä¼šæ€ä¹ˆåšï¼Ÿ
> 
> ä¸º**è®¾å¤‡ A** ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨ç¨‹åºï¼Œä¸º**è®¾å¤‡ B** ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºğŸ¤”ã€‚

è¿™å¾ˆæœ‰æ•ˆã€‚ä½†æ˜¯ä¸‹æ¬¡å½“æ‚¨è¿è¡Œè¿™äº›ç¨‹åºæ—¶ï¼Œ *deviceA* å’Œ *deviceB* å¯èƒ½æœ‰ä¸åŒçš„ IP åœ°å€ï¼Œæˆ–è€…å¦ä¸€ä¸ª *deviceC* å¯èƒ½æœ‰å…´è¶£å‚ä¸æ–‡ä»¶ä¼ è¾“ï¼Œè¿™å¯èƒ½æœ€ç»ˆå¯¼è‡´æ‚¨æ‰‹åŠ¨æ›´æ–°*å¯¹ç­‰æ–¹çš„* IP åœ°å€ğŸ˜ã€‚

> æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨è®¾å¤‡å‘ç°æœåŠ¡æ€ä¹ˆæ ·ï¼Ÿ
> 
> å¬èµ·æ¥ä¸é”™ğŸ‘

æ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å·¥ä½œå§ğŸƒ

## [](#model)å‹å·

æˆ‘ä»¬å°†ä½¿ç”¨ **DatagramSocket** ï¼Œç”¨äºå¤„ç†å±€åŸŸç½‘ä¸­çš„*æœåŠ¡å¹¿å‘Š*å’Œ*æœåŠ¡å‘ç°*ã€‚å®ç°å°†ä½¿ç”¨ *Dart è¯­è¨€*å®Œæˆï¼Œå¹¶å°†æä¾› *JavaScript* çš„ç‰‡æ®µã€‚

## [](#init)åˆå§‹åŒ–

é¦–å…ˆæˆ‘ä»¬è¦å†™*æœåŠ¡å¹¿å‘Š*ä¹Ÿå°±æ˜¯ä¸€ä¸ª UDP æœåŠ¡å™¨ç¨‹åºã€‚

### [](#service-advertiser)æœåŠ¡å¹¿å‘Šå®¢æˆ·

å®ç°å»ºè®®åŠŸèƒ½æ‰€éœ€çš„ç±»ã€‚

```
import 'dart:io' show RawDatagramSocket, RawSocketEvent, InternetAddress, Datagram;
import 'dart:convert' show utf8; 
```

åœ¨ *InternetAddress.anyIPv4* å’Œç«¯å£ *8000* ä¸Šç»‘å®šä¸€ä¸ª *RawDatagramSocket* ï¼Œä½¿å…¶å¯ä»¥ç›‘å¬ç«¯å£ *8000* ä¸Šçš„æ‰€æœ‰æ¥å£ã€‚

```
RawDatagramSocket.bind(InternetAddress.anyIPv4, 8000).then((datagramSocket) {
    // more code coming ...
  }); 
```

å¯ä»¥çœ‹åˆ° *RawDatagramSocket.bind(...)*è¿”å›ä¸€ä¸ª*æœªæ¥*ã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸ªå¥—æ¥å­—ä¸Šå¯ç”¨ *READ* äº‹ä»¶ç›‘å¬å™¨ï¼Œè¿™æ ·æ¯å½“ä»»ä½•å…¶ä»–è®¾å¤‡è¯•å›¾åœ¨è¿™ä¸ªå¥—æ¥å­—ä¸Šå†™ä¸œè¥¿æ—¶ï¼Œç›‘å¬å™¨éƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚

```
datagramSocket.readEventsEnabled = true; // put this line within aforementioned `then()` 
```

ç°åœ¨æˆ‘ä»¬å°†åœ¨è¿™ä¸ª
*DatagramSocket* ä¸Šç›‘å¬ *READ* äº‹ä»¶ã€‚æ¯å½“æ–°çš„ *READ* äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä½¿ç”¨ *DatagramSocket.receive()* è·å–è¯¥äº‹ä»¶ï¼Œå¹¶é€šçŸ¥å…¶ä»–ç»ˆç«¯å®ƒå·²ç»åˆ°è¾¾æœ‰æ•ˆçš„*æœåŠ¡å¹¿å‘Šè€…*ã€‚

```
datagramSocket.listen((RawSocketEvent event) {
      if (event == RawSocketEvent.read) {
          // checking whether it's a read event or not
        Datagram dg = datagramSocket.receive();
        if (dg != null) {
        // notifying other end that it has reached a service advertiser
          datagramSocket.send(dg.data, dg.address, dg.port);
          print('${dg.address}:${dg.port} -- ${utf8.decode(dg.data)}');
        }
      }
    }); 
```

*å¯¹ç­‰ä½“çš„* IP åœ°å€ã€ç«¯å£å·å’Œæ¥æ”¶æ•°æ®ä»*æ•°æ®æŠ¥*å¯¹è±¡ä¸­æå–ï¼Œåœ¨ *READ* äº‹ä»¶å‘ç”Ÿæ—¶æ¥æ”¶ã€‚

ä½¿ç”¨æ¥è‡ª *utf8* æ¨¡å—çš„ä»¥ä¸‹å‡½æ•°ï¼Œä»*åˆ—è¡¨*å°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç å›*å­—ç¬¦ä¸²*ã€‚

```
utf8.decode(dg.data); 
```

äº•*æœåŠ¡å¹¿å‘Šå•†*å®ŒæˆğŸ˜‰ã€‚

### [](#service-discoverer)æœåŠ¡å‘ç°è€…

ä½ å¯èƒ½å·²ç»çŒœåˆ°äº†ï¼Œè¿™åªæ˜¯ä¸€ä¸ª UDP å®¢æˆ·ç«¯ã€‚

å®ç°æœåŠ¡å‘ç°åŠŸèƒ½æ‰€éœ€çš„ç±»ã€‚

```
import 'dart:io' show RawDatagramSocket, RawSocketEvent, InternetAddress, Datagram;
import 'dart:convert' show utf8; 
```

æˆ‘ä»¬å†æ¬¡éœ€è¦åœ¨ *InternetAddress.anyIPv4* å’Œç«¯å£ 0 ä¸Šç»‘å®šä¸€ä¸ª *RawDatagramSocket* ï¼Œå®ƒå°†è¿”å› *Future* ã€‚

> ä¸ºä»€ä¹ˆæ˜¯ç«¯å£ 0ï¼ŸğŸ¤”
> 
> æŒ‡å®šç«¯å£å· 0ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨æ“ä½œç³»ç»Ÿé€‰æ‹©çš„ç«¯å£å·ã€‚åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¯¹ç›‘å¬é¢„å®šä¹‰çš„ç«¯å£å·ä¸æ„Ÿå…´è¶£ğŸ˜Šã€‚

```
RawDatagramSocket.bind(InternetAddress.anyIPv4, 0).then((datagramSocket) {
    // more code coming ...
  }); 
```

åœ¨*æœåŠ¡å¹¿å‘Š*æœŸé—´ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ *RawDatagramSocket* ä¸Šç›‘å¬ *READ* äº‹ä»¶ï¼Œä½†ç°åœ¨æˆ‘ä»¬ä¹Ÿè¦å¯ç”¨*å¹¿æ’­*ï¼Œè¿™æ ·è¿™ä¸ª Socket å°±å¯ä»¥å‘ *255.255.255.255* å‘é€*å¹¿æ’­æ¶ˆæ¯*ï¼Œè¯¥æ¶ˆæ¯å°†åˆ°è¾¾å±€åŸŸç½‘å†…çš„æ‰€æœ‰è®¾å¤‡ã€‚

```
// put these two lines with in previous `then()`
datagramSocket.broadcastEnabled = true;
datagramSocket.readEventsEnabled = true; 
```

åœ¨*å¹¿æ’­åœ°å€*å’Œç«¯å£ 8000 ä¸Šå‘é€æ¶ˆæ¯çš„æ—¶é—´ã€‚

```
datagramSocket.send("io.github.itzmeanjan.transferZ".codeUnits,
        InternetAddress("255.255.255.255"), 8000); 
```

ä¸Šè¿°æ¶ˆæ¯åˆ°è¾¾ LAN ä¸­æ‰€æœ‰ä¾¦å¬ç«¯å£ 8000 ä¸Šçš„ *READ* äº‹ä»¶çš„è®¾å¤‡ã€‚

> ä¸ºä»€ä¹ˆæ˜¯ 8000 ç«¯å£ï¼ŸğŸ¤”
> 
> æˆ‘ä»¬å°†ç«¯å£ 8000 ç”¨äº*æœåŠ¡å¹¿å‘Š*ğŸ˜‰ã€‚

ä½ å¯èƒ½ä¼šå¥½å¥‡ä»€ä¹ˆæ˜¯*â€œio . github . itzmeanjan . transferzâ€ã€‚codeUnits* ï¼Œä»*å­—ç¬¦ä¸²*è¿”å›*åˆ—è¡¨*ï¼Œä½œä¸º*å¹¿æ’­æ¶ˆæ¯*å‘é€ã€‚

ç°åœ¨è®©æˆ‘ä»¬æŠŠç›‘å¬*è¯»*äº‹ä»¶æ‰€éœ€çš„é€»è¾‘æ”¾åˆ° *RawDatagramSocket* ä¸Šã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µéå¸¸æ¥è¿‘æˆ‘ä»¬åœ¨*æœåŠ¡å¹¿å‘Š*ä¸­ä½¿ç”¨çš„ä»£ç ç‰‡æ®µï¼Œé™¤äº†æˆ‘ä»¬ä¸å‘*æœåŠ¡å¹¿å‘Š*å‘é€ä»»ä½•ä¸œè¥¿ã€‚

```
datagramSocket.listen((RawSocketEvent event) {
      if (event == RawSocketEvent.read) {
        Datagram dg = datagramSocket.receive();
        if (dg != null) {
          print('${dg.address}:${dg.port} -- ${utf8.decode(dg.data)}');
          //datagramSocket.close();
          // You may consider uncommenting previous line, if you want to explore only one Service Advertiser at a time.
        }
      }
    }); 
```

æˆ‘ä»¬çš„*æœåŠ¡å‘ç°è€…*å®Œæˆäº†ğŸ˜ƒã€‚

## [](#run)è¿è¡Œ

æ˜¯æ—¶å€™è¿è¡Œå®ƒäº†ğŸƒ

### [](#service-advertiser)æœåŠ¡å¹¿å‘Šå®¢æˆ·