# Ooopsâ€¦çœ‹èµ·æ¥ WFfM æ‰“ç ´äº†åˆ†æâ€¦

> åŸæ–‡:[https://dev . to/jermdavis/ooops-looks-like-wffm-broke-analytics-3h0j](https://dev.to/jermdavis/ooops-looks-like-wffm-broke-analytics-3h0j)

æœ€è¿‘ï¼Œæˆ‘å¾—åˆ°äº†ä¸€å¼ æœ‰è¶£çš„æ”¯æŒç¥¨ï¼Œæ˜¯å…³äº Sitecore v8.1 çš„ä¸€ä¸ªå®¢æˆ·çš„ï¼Œä»–çš„åˆ†æå¤„ç†åœæ­¢äº†ã€‚ä»–ä»¬éœ€è¦æ±‡æ€»çš„å¤§é‡åŸå§‹åˆ†ææ•°æ®æ­£åœ¨ç¼“æ…¢å¢é•¿ï¼Œä¸€äº›ä¾èµ–äºæœ€æ–°åˆ†ææ•°æ®çš„åŠŸèƒ½å·²ç»åœæ­¢å·¥ä½œã€‚è¯•å›¾è§£å†³è¿™ä¸ªé—®é¢˜è®©æˆ‘æƒ³åˆ°äº†ä¸¤ä¸ªé—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜ä¸è¥é”€äººå‘˜çš„ç½‘ç»œè¡¨å•æ•°æ®åœ¨åˆ†æä¸­çš„å¤„ç†æ–¹å¼æœ‰å…³â€”â€”è¿™äº›é—®é¢˜ä¼¼ä¹æ˜¯å…¶ä»–æ”¯æŒå·¥ä½œçš„äººå¯èƒ½éœ€è¦çš„ä¿¡æ¯â€¦â€¦

## [](#first-off-how-do-you-know-the-analytics-queue-is-growing-anyway)é¦–å…ˆï¼Œä½ æ€ä¹ˆçŸ¥é“åˆ†æé˜Ÿåˆ—æ­£åœ¨å¢é•¿ï¼Ÿ

å¥½é—®é¢˜ï¼é˜Ÿåˆ—ä½äº MongoDB çš„â€œTracking Liveâ€æ•°æ®åº“çš„â€œå¤„ç†æ± â€é›†åˆä¸­ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å¯åŠ¨æ‚¨æœ€å–œæ¬¢çš„ Mongo åˆ†æå·¥å…·ï¼Œå¹¶è®¡ç®—è¯¥è¡¨ä¸­çš„è¡Œæ•°ã€‚ä½œä¸ºä¸€å [Robo 3T / RoboMongo](https://robomongo.org/) ç”¨æˆ·ï¼Œæˆ‘è¿è¡ŒæŸ¥è¯¢`db.getCollection('ProcessingPool').count()`å¹¶æŸ¥çœ‹ç»“æœ:

[![](../Images/98bd78653cd0bcb3decb407e16134f04.png)T2ã€‘](https://jermdavis.files.wordpress.com/2019/03/processingpool.png)

æ‚¨å¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»è§‚å¯Ÿè¿™ä¸ªæ•°å­—ï¼Œçœ‹çœ‹æ‚¨çš„é˜Ÿåˆ—å‘ç”Ÿäº†ä»€ä¹ˆâ€¦

å½“æˆ‘è¿™ä¹ˆåšçš„æ—¶å€™ï¼Œæˆ‘æ„è¯†åˆ°èƒ½å¤Ÿä»¥ä¸€ç§æ›´åŠ è‡ªåŠ¨åŒ–çš„æ–¹å¼è·å¾—è¿™äº›æ•°æ®ä¼šå¾ˆæœ‰å¸®åŠ©ï¼Œæ‰€ä»¥æˆ‘æƒ³å‡ºäº†å¦‚ä½•åœ¨ PowerShell ä¸­è¿›è¡ŒåŒæ ·çš„æŸ¥è¯¢:

```
Add-Type  -Path  'C:\inetpub\wwwroot\yourWebsiteFolder\Website\bin\MongoDB.Driver.dll'  $client  =  New-Object  -TypeName  MongoDB.Driver.MongoClient  -ArgumentList  "mongodb://yourMongoServer:yourPort"  $server  =  $client.GetServer()  $database  =  $server.GetDatabase("tracking_live")  $val  =  $database.GetCollection('ProcessingPool').count()  write-host  "----"  write-host  "At: $(Get-Date  -Format  'dd/MM/yyyy HH:mm')"
write-host "Count:  $val" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼ŒSitecore å¯¹è¿™äº›æ•°æ®è¿›è¡Œæ‰¹å¤„ç†ï¼Œå› æ­¤æ‚¨ä¼šå‘ç°è¯¥è¡¨ä¸­çš„æ•°å­—ä¼šæœ‰æ‰€æ”€å‡ï¼Œç›´åˆ°å¤„ç†å¼•æ“å¼€å§‹å¤„ç†ä¸€æ‰¹æ•°æ®ã€‚å› æ­¤éœ€è¦èŠ±å‡ åˆ†é’Ÿæ—¶é—´æ¥è§‚å¯Ÿå®ƒçš„è¶‹åŠ¿ã€‚

åœ¨æˆ‘çœ‹åˆ°çš„æœåŠ¡å™¨ä¸Šï¼Œè¿™ä¸ªé˜Ÿåˆ—ç›¸å½“å¤§ [![ğŸ˜‰](../Images/b26450942c7c42752fe0b02f126abb48.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--fumfYCPq--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s0.wp.com/wp-content/mu-plugins/wpcom-smileys/twemoji/2/72x72/1f609.png)

é‚£ä¹ˆæˆ‘çœ‹åˆ°äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

## [](#issue-one)é—®é¢˜ä¸€:

æˆ‘åœ¨æ—¥å¿—ä¸­å‘ç°çš„ç¬¬ä¸€å¤§å †é”™è¯¯æ˜¯è¿™æ ·çš„:

```
4544 13:07:23 ERROR Exception when storing an aggregation result into reporting database. Item will be postponed and retried later.
Exception: System.Data.SqlClient.SqlException
Message: Failed to insert or update rows in the [Fact_FormSummary] table.
Failed to insert or update rows in the [Fact_FormSummary] table.
Failed to insert or update rows in the [Fact_FormSummary] table.
Failed to insert or update rows in the [Fact_FormSummary] table.
Failed to insert or update rows in the [Fact_FormSummary] table.
Failed to insert or update rows in the [Fact_FormSummary] table.
Source: .Net SqlClient Data Provider
   at System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString)
   at System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   at System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean asyncWrite)
   at System.Data.SqlClient.SqlCommand.InternalExecuteNonQuery(TaskCompletionSource`1 completion, String methodName, Boolean sendToPipe, Int32 timeout, Boolean asyncWrite)
   at System.Data.SqlClient.SqlCommand.ExecuteNonQuery()
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.Commit(SqlDataApi api, IReportingStorageItemBatch batch, Func`2 filter)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.<>c__DisplayClass6.<StoreBatch>b__1()
   at Sitecore.Data.DataProviders.NullRetryer.ExecuteNoResult(Action action, Action recover)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.StoreBatch(IReportingStorageItemBatch batch)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.Store(IReportingStorageItemBatch batch) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹æˆ‘æ¥è¯´å¹¸è¿çš„æ˜¯ï¼Œè°·æ­Œå¾ˆå¿«è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º Dmytro Shevchenko å·²ç»å°±è¿™ä¸ªé—®é¢˜åšäº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å¸–å­ã€‚

åº”ç”¨ä»–çš„è¡¥ä¸æ¶ˆé™¤äº†è¿™äº›æ—¥å¿—é”™è¯¯ï¼Œå¤„ç†é˜Ÿåˆ—åˆå¼€å§‹ä¸‹é™äº†â€¦

## [](#issue-two)ä¸€æœŸä¸¤æœŸ:

â€¦ä½†æ˜¯åœ¨æ„‰å¿«çš„å¤„ç†äº†ä¸€å¤©å·¦å³ä¹‹åï¼Œä¸€ä¸ªæ–°çš„é”™è¯¯å‡ºç°äº†:

```
6680 10:27:47 ERROR Exception when storing an aggregation result into reporting database. Item will be postponed and retried later.
Exception: System.Data.SqlClient.SqlException
Message: Column, parameter, or variable @p59\. : Cannot find data type Fact_FormSummary_Type.
Source: .Net SqlClient Data Provider
   at System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString)
   at System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   at System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean asyncWrite)
   at System.Data.SqlClient.SqlCommand.InternalExecuteNonQuery(TaskCompletionSource`1 completion, String methodName, Boolean sendToPipe, Int32 timeout, Boolean asyncWrite)
   at System.Data.SqlClient.SqlCommand.ExecuteNonQuery()
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.Commit(SqlDataApi api, IReportingStorageItemBatch batch, Func`2 filter)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.<>c__DisplayClass6.<StoreBatch>b__1()
   at Sitecore.Data.DataProviders.NullRetryer.ExecuteNoResult(Action action, Action recover)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.StoreBatch(IReportingStorageItemBatch batch)
   at Sitecore.Analytics.Aggregation.SqlReportingStorageProvider.Store(IReportingStorageItemBatch batch) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

çœ‹äº†ä¸€ä¸‹æ•°æ®åº“ï¼Œåœ¨ Sys é‡Œæ‰¾ä¸åˆ°ä»»ä½•å«â€œFact_FormSummary_Typeâ€çš„ä¸œè¥¿ã€‚Objects è¡¨ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯å¯èƒ½æ˜¯å‡†ç¡®çš„ï¼Œå³ä½¿å®ƒä¸æ˜¯å¾ˆæœ‰å¸®åŠ©ã€‚

å¯æ‚²çš„æ˜¯ï¼Œè°·æ­Œåœ¨è¿™é‡Œæ²¡æœ‰å¸®æˆ‘ï¼Œå› ä¸ºæˆ‘å¾—åˆ°çš„å”¯ä¸€å‚è€ƒæ˜¯ç¤¾åŒºè®ºå›ä¸Šå…³äºå¦ä¸€æ¡æ¶ˆæ¯çš„å¸–å­ã€‚å¯¹å®ƒçš„ä¿®å¤æ¶‰åŠåˆ°æ•°æ®åº“çš„æƒé™é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯æ£€æŸ¥äº†ä¸€ä¸‹â€”â€”ä½†æ˜¯æˆ‘å·¥ä½œçš„ç«™ç‚¹ä¼¼ä¹æœ‰ä¸€ä¸ªè¿æ¥å­—ç¬¦ä¸²ç”¨æˆ·æ‹¥æœ‰è¿™äº›æƒé™ã€‚

åœ¨åšäº†æ›´å¤šçš„è°ƒæŸ¥å´æ¯«æ— è¿›å±•ä¹‹åï¼Œæˆ‘è¯•ç€å’Œ Sitecore æ”¯æŒäººå‘˜äº¤æµã€‚ä»–ä»¬å¾ˆå¿«æŒ‡å‡ºè¿™æ˜¯ä¸€ä¸ªå·²çŸ¥çš„ bugã€‚è™½ç„¶é—æ†¾çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼ºä¹è®°å½•çš„é—®é¢˜â€”â€”å› æ­¤æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚

ä»–ä»¬è¯´ WFfM v8.2 Update 6 ä¸­åŒ…å«äº†è¯¥ä¿®å¤ç¨‹åºï¼Œå› æ­¤ä»–ä»¬å»ºè®®å¦‚æœå¯èƒ½çš„è¯ï¼Œè‡³å°‘å°†æ‚¨çš„ Sitecore / WFfM å®ä¾‹æ›´æ–°åˆ°è¯¥ç‰ˆæœ¬ã€‚ä½†æ˜¯å¦‚æœä½ åšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆå°±å‘Šè¯‰æ”¯æŒäººå‘˜å…³äº Bug #120569 çš„é—®é¢˜ï¼Œä»¥è·å¾—ä»–ä»¬çš„è¡¥ä¸ã€‚

å°†è¯¥è¡¥ä¸åº”ç”¨åˆ°æˆ‘æ­£åœ¨æŸ¥çœ‹çš„ Sitecore å®ä¾‹åï¼Œæˆ‘çš„æ—¥å¿—ä¸­ä¸å†å‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œå¹¶ä¸”æˆ‘çš„å¤„ç†é˜Ÿåˆ—åˆå¼€å§‹ä¸‹é™äº†ã€‚

å¸Œæœ›è¿™æ˜¯æˆ‘åœ¨æœåŠ¡å™¨æ¸…ç©ºé˜Ÿåˆ—ä¹‹å‰éœ€è¦è§£å†³çš„æœ€åä¸€ä¸ªé—®é¢˜â€¦