# åœ¨ R ä¸­äº‰è®ºå†…å®¹å®‰å…¨ç­–ç•¥

> åŸæ–‡:[https://dev . to/hrbrmstr/wrangling-content-security-policies-in-r-2 J1](https://dev.to/hrbrmstr/wrangling-content-security-policies-in-r-2j1)

è¿‡å»çš„[ä¸¤ä¸ª](https://dev.to/hrbrmstr/heads-up-roll-your-own-http-headers-investigations-with-the-hdrs-package-5c5m) [å¸–å­](https://rud.is/b/2019/03/04/ip-user-agent-and-referrer-tracking-disabled-on-cinc-rud-is-and-git-rud-is/)å·²ç»ä½¿ç”¨ R æ¥æŸ¥çœ‹ web-y thing-ys çš„å®‰å…¨æ€§(å‡è®¾è¿™äº›æœ¯è¯­ä»ç°åœ¨å¼€å§‹åœ¨æ¯ä¸ªå¸–å­ä¸­éƒ½å‡ºç°åœ¨å“äººçš„å¼•å·ä¸­)ã€‚æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­ç»§ç»­è¿™ä¸ªä¸»é¢˜ï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨ä¸€ä¸ª[å¯æƒœæ²¡æœ‰ä½¿ç”¨çš„] HTTP æœåŠ¡å™¨å¤´:[å†…å®¹å®‰å…¨ç­–ç•¥](https://www.w3.org/TR/CSP3/)(åœ¨è¿™ç¯‡æ–‡ç« çš„å‰©ä½™éƒ¨åˆ†ç§°ä¸º CSP)ã€‚

ä¸ºäº†ç®€åŒ–äº‹æƒ…ï¼ŒCSP å¤´æŒ‡ç¤ºæµè§ˆå™¨ä½ å·²ç»æˆæƒä»€ä¹ˆæ˜¯ä½ çš„ç«™ç‚¹çš„ä¸€éƒ¨åˆ†ã€‚æ‚¨ä¸ºä¸åŒç±»å‹çš„å†…å®¹æä¾›æŒ‡ä»¤ï¼Œå‘Šè¯‰æµè§ˆå™¨å“ªäº›ç½‘ç«™å¯ä»¥å°†å†…å®¹åŠ è½½åˆ°å½“å‰é¡µé¢ï¼Œä»¥é˜²æ­¢ç±»ä¼¼äº[è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»](https://www.owasp.org/index.php/Cross-site_Scripting_(XSS))ã€[æ¶æ„ iframes](https://kb.sucuri.net/malware/malicious-iframes) ã€[ç‚¹å‡»åŠ«æŒ](https://www.owasp.org/index.php/Clickjacking)ã€[å¯†ç åŠ«æŒ](https://www.malwarebytes.com/cryptojacking/)ç­‰ç­‰ã€‚å¦‚æœä½ è®¤ä¸ºè¿™ä¸ä¼šå‘ç”Ÿï¼Œ[å†æƒ³æƒ³](https://www.riskiq.com/blog/labs/magecart-adverline/)ã€‚

web ä¸Šæœ‰å¤§é‡å…³äºå¦‚ä½•é…ç½® CSP çš„èµ„æº(æœ‰äº›æ˜¯å‰é¢é“¾æ¥çš„),ä¸éœ€è¦å¦å¤–çš„æŒ‡å—(è¿™ç¯‡æ–‡ç« æ˜¯å…³äºåœ¨ R ä¸­ä½¿ç”¨ CSP ä½œä¸ºæ•°æ®æºçš„)ã€‚ç„¶è€Œï¼Œå¦‚æœä½ ç›®å‰æ²¡æœ‰åœ¨è‡ªå·±çš„ä»»ä½•ç½‘ç«™ä¸Šä½¿ç”¨ CSPï¼Œå¹¶ä¸”æƒ³è¦ä¸€ä¸ªç›¸å½“ç®€å•çš„æ–¹æ³•æ¥åˆ¶å®šç­–ç•¥ï¼Œé‚£ä¹ˆå°±æ‹¿ä¸€ä»½æœ€æ–°çš„ Firefoxï¼Œå®‰è£… Mozilla è‡ªå·±çš„ [CSP Toolkit æ‰©å±•](https://addons.mozilla.org/en-US/firefox/addon/laboratory-by-mozilla/)ï¼Œå¹¶åœ¨è¯¥æ’ä»¶æ¿€æ´»çš„æƒ…å†µä¸‹æµè§ˆä½ çš„ç½‘ç«™ã€‚å®ƒä¼šç”Ÿæˆå°½å¯èƒ½å°‘çš„ç­–ç•¥ï¼Œå› ä¸ºå®ƒä¼šæŸ¥çœ‹æ‚¨çš„ç«™ç‚¹å‘å‡ºçš„æ‰€æœ‰èµ„æºè¯·æ±‚ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`Content-Security-Policy-Report-Only`æŠ¥å¤´å’Œ`Content-Security-Policy`æŠ¥å¤´ï¼Œå› ä¸ºå‰è€…åªä¼šæŠ¥å‘Šæ½œåœ¨çš„èµ„æºåŠ è½½é—®é¢˜ï¼Œè€Œä¸ä¼šé˜»æ­¢èµ„æºåŠ è½½ã€‚

### [](#how-about-some-r-code-now-mmmkay)ç°åœ¨æ¥ç‚¹ R ç æ€ä¹ˆæ ·ï¼ŒMmmkayï¼Ÿ

å³ä½¿æ‚¨æ²¡æœ‰è‡ªå·±çš„ CSPï¼Œä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ°å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬ä¼šå‡ºç°åœ¨ HTTP æœåŠ¡å™¨å“åº”å¤´ä¸­ã€‚ä¸ºäº†æ›´å®¹æ˜“åœ°æŸ¥çœ‹ä¸€ä¸ªç«™ç‚¹æ˜¯å¦æœ‰ CSP ä»¥åŠåŠ è½½ CSPï¼Œæˆ‘å·²ç»æŠŠ[ä¸€ä¸ªå°çš„åŒ…](https://cinc.rud.is/web/packages/cspy/)(å®‰è£…è¯´æ˜&æºä½ç½®åœ¨é‚£ä¸ªé“¾æ¥ä¸Š)æ”¾åœ¨ä¸€èµ·ï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬åšè¿™äº›ã€‚(å¦‚æœæ‚¨è®¿é—®è¯¥é¡µé¢ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ä¸€ä¸ªä¸º CRAN çŠ¶æ€å¾½ç« åŠ è½½å¤±è´¥å›¾åƒã€‚åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å¼€å‘è€…å·¥å…·æˆ– javascript æ§åˆ¶å°ï¼Œæ‚¨ä¼šçœ‹åˆ° CSP è§„åˆ™åœ¨åŠªåŠ›å·¥ä½œ:

[![](../Images/56973b36919590d65fc97458de040e05.png)T2ã€‘](https://i0.wp.com/rud.is/b/wp-content/uploads/2019/03/cran-badge-csp.png?ssl=1)

`cspy`åŒ…åŸºäº Shape Security çš„[æ¼‚äº®çš„ Java åº“](https://github.com/shapesecurity/salvation/)ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªçœŸæ­£çš„ CSP è§„åˆ™è§£æå™¨(è€Œä¸æ˜¯æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿè¦åšçš„ hacky-string-slicing ),å¹¶æœ‰ä¸€ç»„ç”¨ R ç¼–å†™çš„å®‰å…¨æ£€æŸ¥å™¨è§„åˆ™ï¼Œä½†åŸºäº Google å®šä¹‰çš„è§„åˆ™[ã€‚æˆ‘è¿åäº†*â€œä¸€ä¸ª pkg æ”¯æŒç½å­ï¼›å¦ä¸€ä¸ª pkg"* "è§„åˆ™"ä¸­çš„å®é™…åŠŸèƒ½ï¼Œå› ä¸º Shape Security æ¯å¹´åªå‘å¸ƒ 1.5 ç‰ˆï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ä¸ªæ²¡æœ‰ä¾èµ–å…³ç³»çš„è¶…çº§å° JARã€‚](https://csp-evaluator.withgoogle.com/)

è®©æˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªä»¥ R ä¸ºä¸­å¿ƒçš„ç«™ç‚¹ï¼Œå®ƒæœ‰ä¸€ä¸ªæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„ CSP(å‡è®¾`tidyverse`å’Œ`stringi`è¢«åŠ è½½åˆ° R ä¼šè¯ä¸­)ã€‚æˆ‘ä»¬å°†ä»ä¸€ä¸ªè¶…çº§æ¼‚äº®çš„ R org å¼€å§‹:RStudioï¼:

```
cspy::has_csp("https://www.rstudio.com/")
## [1] FALSE 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å“¦ï¼Œå—¯â€¦â€¦é‚£ä¹ˆï¼Œå¦ä¸€ä¸ªè¶…çº§æ£’çš„ç»„ç»‡æ€ä¹ˆæ ·:èŠ’æœè§£å†³æ–¹æ¡ˆï¼:

```
cspy::has_csp("http://mango-solutions.com/")
## [1] FALSE 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*å‘µ*ã€‚å—¯â€¦å•Š& hellipã€‚Hrmã€‚æ•°æ®è¥å‘¢ï¼ä»–ä»¬æœ‰å¾ˆå¤šå¾ˆæ£’çš„ä¸œè¥¿:

```
cspy::has_csp("https://www.datacamp.com/")
## [1] TRUE 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

W00tï¼

å…¬å¹³åœ°è¯´ï¼ŒRStudio å’Œ Mango çš„ä¸»è¦å“ç‰Œç½‘ç«™éƒ½ä½¿ç”¨ WordPressï¼ŒWordPress ä½¿å¾—ç¼–å†™ä¸€ä¸ªåƒæ ·çš„ CSP å˜å¾—éå¸¸å›°éš¾ã€‚ç„¶è€Œï¼Œ(åœ¨æˆ‘çœ‹æ¥)è¿™å¹¶ä¸æ˜¯æ²¡æœ‰çš„å€Ÿå£(å› ä¸ºæˆ‘è¿è¡Œ WordPress å¹¶ä¸”æœ‰ä¸€ä¸ª)ã€‚ä½†æ˜¯ï¼Œæ•°æ®è¥æœ‰ï¼é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å–æ¥çœ‹çœ‹:

```
(dc_csp <- cspy::fetch_csp("https://www.datacamp.com/"))
## default-src 'self' *.datacamp.com *.datacamp-staging.com
## base-uri 'self'
## connect-src 'self' *.datacamp.com *.datacamp-staging.com https://com-datacamp.mini.snplow.net https://www2.profitwell.com https://www.facebook.com https://www.optimalworkshop.com https://in.hotjar.com https://stats.g.doubleclick.net https://*.google-analytics.com https://frstre.com https://onesignal.com https://*.algolia.net https://*.algolianet.com https://wootric-eligibility.herokuapp.com https://d8myem934l1zi.cloudfront.net https://production.wootric.com
## font-src 'self' *.datacamp.com *.datacamp-staging.com https://fonts.gstatic.com data:
## form-action 'self' *.datacamp.com *.datacamp-staging.com https://*.paypal.com https://www.facebook.com
## frame-ancestors 'self' *.datacamp.com *.datacamp-staging.com
## frame-src 'self' *.datacamp.com *.datacamp-staging.com *.zuora.com https://www.google.com https://vars.hotjar.com https://beacon.tapfiliate.com https://b.frstre.com https://onesignal.com https://tpc.googlesyndication.com https://*.facebook.com https://*.youtube.com
## img-src 'self' *.datacamp.com *.datacamp-staging.com https://s3.amazonaws.com https://checkout.paypal.com https://cdnjs.cloudflare.com https://www.gstatic.com https://maps.googleapis.com https://maps.gstatic.com https://www.facebook.com https://q.quora.com https://bat.bing.com https://*.ads.linkedin.com https://www.google.com https://*.g.doubleclick.net https://*.google-analytics.com https://www.googletagmanager.com blob data:
## script-src 'self' 'unsafe-inline' 'unsafe-eval' *.datacamp.com *.datacamp-staging.com https://*.googletagmanager.com https://*.google-analytics.com https://browser.sentry-cdn.com https://js.braintreegateway.com https://*.zuora.com https://*.paypal.com https://js-agent.newrelic.com https://bam.nr-data.net https://maps.googleapis.com https://assets.calendly.com http://com-datacamp.mini.snplow.net https://cdn.jsdelivr.net https://*.algolia.net https://www.gstatic.com https://www.google.com https://cdnjs.cloudflare.com https://static.tapfiliate.com https://cdn.onesignal.com https://onesignal.com https://static.hotjar.com https://script.hotjar.com https://*.linkedin.com https://sjs.bizographics.com/insight.min.js https://bat.bing.com/bat.js https://a.quora.com/qevents.js https://connect.facebook.net https://www.googleadservices.com https://www.googletagmanager.com https://*.googlesyndication.com https://dna8twue3dlxq.cloudfront.net/js/profitwell.js https://disutgh7q0ncc.cloudfront.net/beacon.js data:
## style-src 'self' 'unsafe-inline' *.datacamp.com *.datacamp-staging.com https://cdnjs.cloudflare.com https://fonts.googleapis.com https://assets.calendly.com
## worker-src 'self'
## report-uri https://infra-reporter.datacamp.com/csp-report 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å“‡å“¦ã€‚å­—é¢:*å“‡*ã€‚æˆ‘ä»¬å°†è®©ä»–ä»¬æœ€è¿‘çš„è¿è§„å’Œç¼ºä¹ 2FA ç™»å½•æ»‘ä¸€ç‚¹ b/c è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ CSPï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ä»–ä»¬ç¡®å®å…³å¿ƒä½ (ä¸ç®¡æœ‰ä»€ä¹ˆ CSP åŠ©æ‰‹å·¥å…·ï¼Œè¿™äº› CSP æ˜¯ä¸€ç§ç—›è‹¦çš„è®¾ç½®ï¼Œæ‰€ä»¥è¿™ä¸ªå¦‚æ­¤å½»åº•çš„äº‹å®è¡¨æ˜ä»–ä»¬â€œæ˜ç™½â€)ã€‚

ä¸è¿‡ï¼Œr å›½äººå¯èƒ½ä¼šçœ‹ç€è¿™ä¸€å›¢ä¹±éº»ï¼Œç•ç¼©ä¸å‰ã€‚æˆ‘ä»¬å°†å¾ˆå¿«æ•´ç†å®ƒï¼Œä½†æˆ‘ä»¬è¦ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ CSP:

```
glimpse(validate_csp(dc_csp))
## Observations: 1
## Variables: 8
## $ message <chr> "A draft of the next version of CSP deprecates report-uri in favour â€¦
## $ type <chr> "INFO"
## $ start_line <int> 1
## $ start_column <int> 2680
## $ start_offset <int> 2679
## $ end_line <int> 1
## $ end_column <int> 2690
## $ end_offset <int> 2689 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

éªŒè¯å™¨åªæ³¨æ„åˆ°æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªå³å°†è¢«å¦å†³çš„æŒ‡ä»¤(ä½†è¿™åªæ˜¯ä¿¡æ¯æ€§çš„ï¼Œåœ¨ CSP v3 é€€å‡ºè‰æ¡ˆå¹¶ä¸”æµè§ˆå™¨æ”¯æŒå®ƒä¹‹å‰å®Œå…¨æ²¡é—®é¢˜)ï¼Œå¹¶ä¸”éªŒè¯è¾“å‡ºå…·æœ‰å‘ç”Ÿè¿è§„çš„ä½ç½®å€¼(è¿™æ˜¾ç¤ºäº†ä½¿ç”¨çœŸæ­£çš„è§£æå™¨è€Œä¸æ˜¯å­—ç¬¦ä¸²æ‹†åˆ†å™¨çš„å¥½å¤„)ã€‚

è¿™äº›`csp`å¯¹è±¡çš„å®šåˆ¶æ‰“å°æ–¹æ³•å°†æ¯ä¸ªæŒ‡ä»¤æ”¾åœ¨å•ç‹¬çš„è¡Œä¸Šï¼Œå¹¶ä¿æŒèµ„æºå€¼ä¸å˜ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå®ƒåˆä¸‘åˆä¹±ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ¥å¤„ç†ä¸€ä¸‹:

```
(csp_df <- as.data.frame(dc_csp))
## # A tibble: 111 x 3
## directive value origin                   
## <chr> <chr> <chr>                    
## 1 default-src 'self' https://www.datacamp.com/
## 2 default-src *.datacamp.com https://www.datacamp.com/
## 3 default-src *.datacamp-staging.com https://www.datacamp.com/
## 4 base-uri 'self' https://www.datacamp.com/
## 5 connect-src 'self' https://www.datacamp.com/
## 6 connect-src *.datacamp.com https://www.datacamp.com/
## 7 connect-src *.datacamp-staging.com https://www.datacamp.com/
## 8 connect-src https://com-datacamp.mini.snplow.net https://www.datacamp.com/
## 9 connect-src https://www2.profitwell.com https://www.datacamp.com/
## 10 connect-src https://www.facebook.com https://www.datacamp.com/
## # â€¦ with 101 more rows 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæ¯ä¸ªæŒ‡ä»¤/å€¼å¯¹éƒ½æœ‰ä¸€è¡Œã€‚å¦‚æœæ‚¨æƒ³å°†è¿™äº›ç»‘å®šåœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆåŸç‚¹(ç­–ç•¥çš„æ¥æº)ä¹Ÿä¼šéšä¹‹å‡ºç°ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬éœ€è¦æ•è·å¤šå°‘ç¬¬ä¸‰æ–¹ç½‘ç«™å¹¶æ·»åŠ åˆ°è¯¥ç­–ç•¥ä¸­:

```
filter(csp_df, stri_detect_fixed(value, ".")) %>% 
  pull(value) %>% 
  stri_replace_all_fixed("*.", "") %>% 
  urltools::url_parse() %>% 
  distinct(domain) %>% 
  filter(!stri_detect_regex(domain, "(datacamp\\.com|datacamp-staging\\.com)$")) %>% 
  arrange(domain) %>% 
  pull(domain)
## [1] "a.quora.com" "ads.linkedin.com" "algolia.net"                      
## [4] "algolianet.com" "assets.calendly.com" "b.frstre.com"                     
## [7] "bam.nr-data.net" "bat.bing.com" "beacon.tapfiliate.com"            
## [10] "browser.sentry-cdn.com" "cdn.jsdelivr.net" "cdn.onesignal.com"                
## [13] "cdnjs.cloudflare.com" "checkout.paypal.com" "com-datacamp.mini.snplow.net"     
## [16] "connect.facebook.net" "d8myem934l1zi.cloudfront.net" "disutgh7q0ncc.cloudfront.net"     
## [19] "dna8twue3dlxq.cloudfront.net" "facebook.com" "fonts.googleapis.com"             
## [22] "fonts.gstatic.com" "frstre.com" "g.doubleclick.net"                
## [25] "google-analytics.com" "googlesyndication.com" "googletagmanager.com"             
## [28] "in.hotjar.com" "js-agent.newrelic.com" "js.braintreegateway.com"          
## [31] "linkedin.com" "maps.googleapis.com" "maps.gstatic.com"                 
## [34] "onesignal.com" "paypal.com" "production.wootric.com"           
## [37] "q.quora.com" "s3.amazonaws.com" "script.hotjar.com"                
## [40] "sjs.bizographics.com" "static.hotjar.com" "static.tapfiliate.com"            
## [43] "stats.g.doubleclick.net" "tpc.googlesyndication.com" "vars.hotjar.com"                  
## [46] "wootric-eligibility.herokuapp.com" "www.facebook.com" "www.google.com"                   
## [49] "www.googleadservices.com" "www.googletagmanager.com" "www.gstatic.com"                  
## [52] "www.optimalworkshop.com" "www2.profitwell.com" "youtube.com"                      
## [55] "zuora.com" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªåˆ—è¡¨æ˜¯è¿™äº› CSP å¯èƒ½éš¾ä»¥é…ç½®çš„ä¸€ä¸ªé‡è¦åŸå› ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰äº›äººè®¤ä¸ºå®ƒä»¬å¯èƒ½æ²¡æœ‰ä»€ä¹ˆå¥½å¤„ã€‚ä¸ºä»€ä¹ˆæ”¶ç›Šä¸å¤§ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬å…è®¸æµè§ˆå™¨ä»å“ªäº›ç½‘ç«™åŠ è½½å’Œæ‰§è¡Œ javascript å†…å®¹:

```
filter(csp_df, directive == "script-src") %>% 
  select(value) %>% 
  filter(!stri_detect_regex(value, "(datacamp\\.com$|datacamp-staging\\.com$|'|data:)")) %>% 
  pull(value)
## [1] "https://*.googletagmanager.com" "https://*.google-analytics.com"                       
## [3] "https://browser.sentry-cdn.com" "https://js.braintreegateway.com"                      
## [5] "https://*.zuora.com" "https://*.paypal.com"                                 
## [7] "https://js-agent.newrelic.com" "https://bam.nr-data.net"                              
## [9] "https://maps.googleapis.com" "https://assets.calendly.com"                          
## [11] "http://com-datacamp.mini.snplow.net" "https://cdn.jsdelivr.net"                             
## [13] "https://*.algolia.net" "https://www.gstatic.com"                              
## [15] "https://www.google.com" "https://cdnjs.cloudflare.com"                         
## [17] "https://static.tapfiliate.com" "https://cdn.onesignal.com"                            
## [19] "https://onesignal.com" "https://static.hotjar.com"                            
## [21] "https://script.hotjar.com" "https://*.linkedin.com"                               
## [23] "https://sjs.bizographics.com/insight.min.js" "https://bat.bing.com/bat.js"                          
## [25] "https://a.quora.com/qevents.js" "https://connect.facebook.net"                         
## [27] "https://www.googleadservices.com" "https://www.googletagmanager.com"                     
## [29] "https://*.googlesyndication.com" "https://dna8twue3dlxq.cloudfront.net/js/profitwell.js"
## [31] "https://disutgh7q0ncc.cloudfront.net/beacon.js" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¶ä¸­ä¸€äº›è¢«æŒ‡å®šåˆ°`.js`æ–‡ä»¶ï¼Œä½†å…¶ä»–çš„åˆ™åœ¨æ•´ä¸ª CDN ç½‘ç»œä¸Šå·¥ä½œã€‚å½“ç„¶ï¼Œæ²¡æœ‰ä»€ä¹ˆæ¯”äºšé©¬é€Šçš„ S3 é¡¶çº§åŸŸå(ä¸ç®¡æœ‰æ²¡æœ‰é€šé…ç¬¦)æ›´ç³Ÿç³•çš„äº†ï¼Œä½†æ˜¯è¿™ä¸ªåˆ—è¡¨ä¸­æœ‰å¾ˆå¤šå€¼å¾—ä¿¡ä»»çš„åœ°æ–¹ã€‚CSP çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœ Data Camp äº†è§£åˆ°è¿™äº›ç½‘ç«™ä¸­çš„ä»»ä½•ä¸€ä¸ªæœ‰é—®é¢˜ï¼Œå®ƒå¯ä»¥å¿«é€Ÿåœ°ä»æ ‡é¢˜ä¸­åˆ é™¤å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬å·²ç»å®Œæˆäº†è‰°éš¾çš„æšä¸¾å·¥ä½œã€‚æ­¤å¤–ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç«™ç‚¹é­åˆ°ç ´åï¼Œå¹¶åŠ è½½ä¸€ä¸ªè¯•å›¾æ‰§è¡Œä¸åœ¨è¯¥åˆ—è¡¨ä¸­çš„åŸŸçš„ä»£ç çš„èµ„æºï¼Œå°†ä¼šç”Ÿæˆä¸€ä¸ªç­–ç•¥é”™è¯¯ï¼ŒData Camp å‡ºè‰²çš„ SOC(ä»–ä»¬å¯¹ç ´åçš„å“åº”éå¸¸å¥½)å¯ä»¥é‡‡å–ç§¯æçš„æªæ–½ï¼Œé€šçŸ¥ä»–ä»¬çš„ä¸‹æ¸¸æä¾›å•†æœ‰é—®é¢˜ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥åšä¸€äº›å®‰å…¨æ£€æŸ¥:

```
check_script_unsafe_inline(csp_df)
## Category: script-unsafe-inline
## Severity: HIGH
## Message: 'unsafe-inline' allows the execution of unsafe in-page scripts and event handlers.
## 
## directive value origin
## 67 script-src 'unsafe-inline' https://www.datacamp.com/

check_script_unsafe_eval(csp_df)
## Category: script-unsafe-eval
## Severity: HIGH
## Message: 'unsafe-eval' allows the execution of code injected into DOM APIs such as eval().
## 
## directive value origin
## 68 script-src 'unsafe-eval' https://www.datacamp.com/

check_plain_url_schemes(csp_df)
## Category: unsafe-execution
## Severity: HIGH
## Message: URI(s) found that allow the exeution of unsafe scripts.
## 
## directive value origin
## 102 script-src data: https://www.datacamp.com/

check_wildcards(csp_df)

check_missing_directives(csp_df)
## Category: missing-directive
## Severity: HIGH
## Message: Missing object-src allows the injection of plugins which can execute JavaScript. Can you set it to 'none'?
## 
## directive value
## 1 object-src <NA>

check_ip_source(csp_df)

check_deprecated(csp_df)
## Category: deprecated-directive
## Severity: INFO
## Message: Found deprecated directive(s). See https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy for more information.
## 
## directive value
## 111 report-uri https://infra-reporter.datacamp.com/csp-report
## origin
## 111 https://www.datacamp.com/

check_nonce_length(csp_df)

check_src_http(csp_df)
## Category: http-src
## Severity: MEDIUM
## Message: Use HTTPS vs HTTP.
## 
## directive value
## 81 script-src http://com-datacamp.mini.snplow.net
## origin
## 81 https://www.datacamp.com/ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¼´éšç€æ¼‚äº®çš„æ‰“å°ï¼Œå®ƒä»¬è¿”å›æ½œåœ¨æœ‰é—®é¢˜çš„è§„åˆ™çš„æ•°æ®å¸§ã€‚

å¯¹äºæŸäº›é¡µé¢ï¼ŒData Camp ä¼šåšæ‚¨åœ¨ç¼–ç»‡ R markdown æ–‡æ¡£æ—¶å¯èƒ½ä¼šåšçš„äº‹æƒ…:å°†å…¶ä¿å­˜ä¸ºè‡ªåŒ…å«é¡µé¢ã€‚å› æ­¤ï¼Œå¯¹ä¸€äº›æŒ‡ä»¤ä½¿ç”¨`'unsafe-inline'`ã€`'unsafe-eval'`å’Œ`data:`æŒ‡ä»¤å€¼æ˜¯ç»å¯¹å¿…è¦çš„ã€‚è¿™æ˜¯æ²¡åŠæ³•çš„ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“äº†`report-uri`çš„è´¬å€¼ã€‚è™½ç„¶`object-src`ä¸åœ¨ CSP-proper ä¸­ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª`default-src`ï¼Œå®ƒå°†ç”Ÿæ•ˆã€‚ä½†æ˜¯ï¼Œæ£€æŸ¥å™¨çŸ¥é“å®ƒæ²¡æœ‰è®¾ç½®ä¸º`'none'`ï¼Œè¿™æ„å‘³ç€æ’ä»¶ä»ç„¶å¯ä»¥ä» Data Camp è‡ªå·±çš„åŸŸä¸­åŠ è½½(è¿™å¯èƒ½å®Œå…¨æ²¡é—®é¢˜ï¼Œå–å†³äºå®ƒä»¬ä½¿ç”¨çš„åµŒå…¥ç±»å‹)ã€‚

æˆ‘å°†ä¸å¾—ä¸æ”¯æŒæ£€æŸ¥å™¨çš„ä¸€ä¸ªå‘ç°æ˜¯æœ€åçš„é‚£ä¸ª(`check_src_http()`çš„è¾“å‡º)ã€‚ä»–ä»¬ä¼¼ä¹å…è®¸ç½‘ç«™çš„ä¼—å¤šåˆ†ææä¾›å•†ä¹‹ä¸€(æˆ‘è®¤ä¸ºæ˜¯[è¿™ä¸ªç»„ç»‡](https://snowplowanalytics.com/))ä½¿ç”¨`http://`å¯¹`https://`ã€‚å¦‚æœä»–ä»¬çœŸçš„é€šè¿‡æ™®é€šçš„`http://`ä»è¯¥ç½‘ç«™åŠ è½½ javascript å†…å®¹ï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±æœ‰å¯èƒ½åŠ«æŒå†…å®¹å¹¶æ’å…¥æ¶æ„çš„ javascriptã€‚ä½¿ç”¨åŸºäº DNS(ä¾‹å¦‚ [pi-hole](https://pi-hole.net/) )æˆ– uBlock Origin æ¥é˜»æ­¢ä»»ä½•è·Ÿè¸ªå™¨æˆ–åˆ†æè„šæœ¬åŠ è½½çš„å¦ä¸€ä¸ªå¥½ç†ç”±ã€‚

è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼ŒData Camp ä½¿ç”¨äºšé©¬é€Š AWS ä½œä¸ºä»–ä»¬çš„ç½‘ç«™ä¸»æœºï¼Œä½ å¿…é¡»è¦ç»å†é‡é‡å›°éš¾æ‰èƒ½åœ¨é‚£é‡Œæ·»åŠ è¿™ä¸ªæ ‡é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬åœ¨è€ƒè™‘ä½ çš„å®‰å…¨æ–¹é¢åšå¾—å¾ˆå¥½ã€‚

### [](#atscale-wrangling)å¤§è§„æ¨¡çš„è§’åŠ›

`cspy`åŒ…å¾ˆé€‚åˆä¸´æ—¶/è½»é‡çº§æ£€æŸ¥ï¼Œä½†æ˜¯å®ƒä½¿ç”¨äº† Java shimï¼Œè¿™æ„å‘³ç€åœ¨ R å’Œ JVM ä¹‹é—´å°é€æ•°æ®ğŸ’¤å¤§è§„æ¨¡ã€‚æ ¹æ®æ‚¨è¦åšçš„äº‹æƒ…ï¼Œä¸€äº›åŸºæœ¬çš„å­—ç¬¦ä¸²äº‰è®ºå¯èƒ½å°±è¶³å¤Ÿäº†ã€‚

åœ¨$DAYJOBï¼Œæˆ‘ä»¬æ‰§è¡Œè®¸å¤š [HTTP æ‰«æ](https://opendata.rapid7.com/sonar.https/)ã€‚æˆ‘ä»¬å†…éƒ¨çš„ä¸€æ¬¡æ‰«æ(æˆ‘ä¸è®¤ä¸ºè¿™æ˜¯å…¬å¼€æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œä½†æˆ‘ä¼šåœ¨å‘¨ä¸€æ£€æŸ¥)æ˜¯å¯¹ Alexa å‰ 100 ä¸‡åä¸»æœºçš„å®šæœŸæŠ“å–ã€‚åœ¨æœ€è¿‘çš„æ‰«æä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†å¤§çº¦ 65K ä¸ªå¸¦æœ‰ CSP æ ‡é¢˜çš„ç«™ç‚¹ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œè·å–åŒ…å«è™šæ‹Ÿä¸»æœºåç§°å’Œæ‰¾åˆ°çš„ CSP ç­–ç•¥å­—ç¬¦ä¸²[çš„ CSVã€‚](https://rud.is/dl/top1m-csp.csv.gz)

ä¸€æ—¦ä½ ä¸‹è½½äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œæ¥å¾—åˆ°ä¸€ä¸ªæ•´æ´çš„æ•°æ®å¸§:

```
read_csv("top1m-csp.csv.gz", col_types = "cc") %>% # use the location where you stored it
  mutate(csp = stri_trans_tolower(csp)) -> top1m_csp

stri_split_regex(top1m_csp$csp, ";[[:space:]]*", simplify = FALSE) %>% # split directives for each policy
  map2_df(top1m_csp$vhost, ~{ # we want to keep the origin
    stri_match_first_regex(.x, "([[:alpha:]\\-]+)[[:space:]]+(.*)$|([[:alpha:]\\-]+)") %>% # get the directive
      as.data.frame(stringsAsFactors = FALSE) %>%
      mutate(origin = sprintf("https://%s/", .y)) %>% 
      mutate(raw = .x) # save the raw CSP
  }) %>%
  mutate(V2 = ifelse(is.na(V2), V4, V2)) %>% # figure out directive
  mutate(V3 = ifelse(is.na(V3), "", V3)) %>% # and value (keeping in mind no-value directives)
  select(directive = V2, value = V3, origin, raw) %>%
  as_tibble() %>%
  separate_rows(value, sep="[[:space:]]+") -> top1m_csp # tidy it up with each row being directive|value|origin like the above 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¯¹æˆ‘æ¥è¯´åªèŠ±äº† 2 åˆ†é’Ÿï¼Œè¿™ 2 åˆ†é’Ÿå¤ªé•¿äº†ï¼Œæ— æ³•åˆ†å‘ç»™é‚£äº›å¯èƒ½æ­£åœ¨å®¶é‡Œå°è¯•çš„å‹‡æ•¢çš„è¯»è€…ï¼Œæ‰€ä»¥ç»“æœçš„ RDS ä¹Ÿæ˜¯å¯ç”¨çš„ã€‚

å› æ­¤ï¼Œåœ¨æ’åå‰ 100 ä¸‡çš„ç½‘ç«™ä¸­ï¼Œåªæœ‰å¤§çº¦ 65000 ä¸ªæœ‰ CSP æ ‡é¢˜(å¤§çº¦ 6.5%)ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒä»¬æ˜¯å¥½çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬ç”¨è¿‡çš„æ— æ•ˆæŒ‡ä»¤:

```
top1m_csp %>%
  filter(!is.na(directive)) %>%
  count(directive, sort = TRUE) %>%
  mutate(is_valid = directive %in% valid_csp_directives) %>%
  filter(!is_valid) %>%
  select(-is_valid) %>% 
  print(n=65)
## # A tibble: 65 x 2
## directive n
## <chr> <int>
## 1 referrer 69
## 2 reflected-xss 58
## 3 t 50
## 4 self 34
## 5 tscript-src 22
## 6 tframe-src 17
## 7 timg-src 16
## 8 content-security-policy 14
## 9 default 10
## 10 policy-definition 9
## 11 allow 8
## 12 defalt-src 8
## 13 tstyle-src 8
## 14 https 7
## 15 nosniff 7
## 16 null 7
## 17 tfont-src 6
## 18 unsafe-inline 6
## 19 http 5
## 20 allow-same-origin 4
## 21 content 4
## 22 defaukt-src 4
## 23 default-scr 4
## 24 defaut-src 4
## 25 data 3
## 26 frame-ancestor 3
## 27 policy 3
## 28 self-ancestors 3
## 29 defualt-src 2
## 30 jivosite 2
## 31 mg-src 2
## 32 none 2
## 33 object 2
## 34 options 2
## 35 policy-uri 2
## 36 referrer-policy 2
## 37 tconnect-src 2
## 38 tframe-ancestors 2
## 39 xhr-src 2
## 40 - 1
## 41 -report-only 1
## 42 ahliunited 1
## 43 anyimage 1
## 44 blok-all-mixed-content 1
## 45 content-security-policy-report-only 1
## 46 default-sec 1
## 47 disown-opener 1
## 48 dstyle-src 1
## 49 frame-ancenstors 1
## 50 frame-ancestorss 1
## 51 frame-ancestros 1
## 52 mode 1
## 53 navigate-to 1
## 54 origin 1
## 55 plugin-type 1
## 56 same-origin 1
## 57 strict-dynamic 1
## 58 tform-action 1
## 59 tni 1
## 60 upgrade-insecure-request 1
## 61 v 1
## 62 value 1
## 63 worker-sc 1
## 64 x-frame-options 1
## 65 yandex 1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‹¼å†™é”™è¯¯æ¯”äººä»¬æƒ³è±¡çš„æ›´å¸¸è§(è¿™æ˜¯ CSP å¾ˆéš¾çš„å¦ä¸€ä¸ªåŸå› ï¼Œå› ä¸ºäººç±»å¾€å¾€ä¸å¾—ä¸çŠ¯è¿™äº›é”™è¯¯)ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ä½¿ç”¨æœ€å¤šçš„æŒ‡ä»¤:

```
top1m_csp %>%
  filter(!is.na(directive)) %>%
  count(directive, sort = TRUE) %>%
  mutate(is_valid = directive %in% valid_csp_directives) %>%
  filter(is_valid) %>%
  select(-is_valid) %>% 
  print(n=25)
## # A tibble: 25 x 2
## directive n
## <chr> <int>
## 1 script-src 57636
## 2 frame-ancestors 47685
## 3 upgrade-insecure-requests 47515
## 4 block-all-mixed-content 38038
## 5 report-uri 37483
## 6 default-src 36369
## 7 img-src 35093
## 8 style-src 23005
## 9 connect-src 22415
## 10 frame-src 15827
## 11 font-src 12878
## 12 media-src 6718
## 13 child-src 5043
## 14 object-src 4235
## 15 worker-src 3076
## 16 form-action 1522
## 17 base-uri 861
## 18 manifest-src 374
## 19 sandbox 79
## 20 script-src-elem 54
## 21 plugin-types 47
## 22 report-to 32
## 23 prefetch-src 22
## 24 require-sri-for 14
## 25 style-src-elem 6 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½å¥‡çš„è¯»è€…åº”è¯¥åŠ è½½`urltools`ï¼Œçœ‹çœ‹é‚£äº›`script-src`æŒ‡ä»¤å…è®¸å“ªäº›åŸŸã€‚è¯·è®°ä½ï¼ŒæŒ‡å‘ç¬¬ä¸‰æ–¹ç½‘ç«™çš„æ¯ä¸ªå€¼æ¡ç›®éƒ½æ„å‘³ç€è¯¥ç½‘ç«™å¯ä»¥å¹²æ‰°æ‚¨çš„æµè§ˆå™¨æˆ–ç›‘è§†æ‚¨ã€‚

å¹¶ä¸”ï¼Œçœ‹çœ‹äººä»¬åœ¨å“ªé‡Œåš CSP é”™è¯¯æŠ¥å‘Š:

```
filter(top1m_csp, directive %in% c("report-uri", "report-to")) %>%
  mutate(report_host = case_when(
    !grepl("^http[s]*://", value) ~ origin,
    TRUE ~ value
  )) %>%
  select(report_host) %>%
  mutate(report_host = sub('"$', "", report_host)) %>%
  pull(report_host) %>%
  urltools::url_parse() %>%
  as_tibble() %>%
  count(domain, sort=TRUE) %>% 
  print(n=20)
## # A tibble: 18,565 x 2
## domain n
## <chr> <int>
## 1 csp.medium.com 113
## 2 sentry.io 43
## 3 de.forumhome.com 40
## 4 report-uri.highwebmedia.com 33
## 5 csp.yandex.net 23
## 6 99designs.report-uri.io 20
## 7 endpoint1.collection.us2.sumologic.com 20
## 8 capture.condenastdigital.com 17
## 9 secure.booked.net 14
## 10 bimbobakeriesusa.com 10
## 11 oroweat.com 10
## 12 ponyfoo.com 8
## 13 monzo.report-uri.com 6
## 14 19jrymqg65.execute-api.us-east-1.amazonaws.com 5
## 15 app.getsentry.com 5
## 16 csp-report.airfrance.fr 5
## 17 csp.nic.cz 5
## 18 myklad.org 5
## 19 reports-api.sqreen.io 5
## 20 tracker.report-uri.com 5
## # â€¦ with 1.854e+04 more rows 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¦œå•(18Kï¼)è¿œæ¯”æˆ‘é¢„æœŸçš„æ›´åŠ å¤šæ ·åŒ–ã€‚

ä½ å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…(ç‰¹åˆ«æ˜¯å› ä¸ºäº‰è®ºå·²ç»ä¸ºä½ åšäº†:-)ã€‚

### [](#fin)é³

æœªæ¥çš„å¸–å­å°†å±•ç¤ºå¦‚ä½•åœ¨ R ä¸­å¤„ç† CSP é”™è¯¯æŠ¥å‘Šï¼Œå¹¶ä¸”å¯èƒ½ä¼šæœ‰æ›´å¤šä»¥å®‰å…¨ä¸ºä¸»é¢˜çš„å¸–å­ã€‚

`cspy` [CINC å›è´­](https://cinc.rud.is/web/packages/cspy/)æœ‰ Windows å’Œ macOS äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œä½ å¯ä»¥åœ¨æ‰€æœ‰å¸¸è§çš„åœ°æ–¹è·å¾—æºä»£ç ï¼Œæ‰€ä»¥è¸¢è½®èƒï¼Œæ–‡ä»¶é—®é¢˜/PRsï¼Œå¹¶å¼€å§‹æ¢ç´¢ä½ ç»å¸¸è®¿é—®çš„ç½‘ç«™çš„å†…å®¹å®‰å…¨æ”¿ç­–(å¹¶åšå®¢ä½ çš„ç»“æœï¼).

å¦ä¸€ä¸ªæœ‰è¶£çš„ç»ƒä¹ æ˜¯æŠ“å– R Weekly æˆ– R-bloggers åšå®¢ï¼Œçœ‹çœ‹æœ‰å¤šå°‘åšå®¢æœ‰ CSPã€‚