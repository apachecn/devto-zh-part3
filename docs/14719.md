# ç”¨ Python æµ‹è¯• WebSocket æœåŠ¡å™¨ï¼

> åŸæ–‡:[https://dev . to/Healey codes/benchmark-web socket-servers-with-python-5kc](https://dev.to/healeycodes/benchmarking-websocket-servers-with-python-5kc)

ä»Šå¤©ï¼ŒWebSockets è¿è¡Œç€ web çš„å¾ˆå¤§ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯å“ªäº›æœåŠ¡å™¨å’Œæ¡†æ¶æ˜¯æœ€å¥½çš„å‘¢ï¼Ÿé‚£è¦çœ‹ä½ æ€ä¹ˆå®šä¹‰æœ€å¥½äº†ã€‚å¦‚æœä½ è¿½æ±‚åŸå§‹çš„æ€§èƒ½ï¼Œé‚£ä¹ˆä¸‹é¢çš„å¸–å­å¯èƒ½ä¼šè®©ä½ æ„Ÿå…´è¶£ã€‚æˆ‘å°†å›é¡¾ä¸€ä¸‹æˆ‘ç”¨ Python å†™çš„ä¸€ä¸ªå°å‹åŸºå‡†ç¨‹åºçš„ä¸€äº›è®¾è®¡ç¬”è®°ï¼Œè¿™ä¸ªç¨‹åºæ˜¯ç”¨ [asyncio](https://docs.python.org/3/library/asyncio.html) å’Œ [websockets](https://github.com/aaugustin/websockets) ç¼–å†™çš„ã€‚

[![Coder at work!](../Images/446d11f72e0de4c53c75b95a48617c93.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8AgPWT4q--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/8lderspof3kpfcbwru6o.png)

#### [web socket benchmark](https://github.com/healeycodes/websocket-benchmarker)

æˆ‘å†™çš„ç¡•å£«è®ºæ–‡æ˜¯å…³äº WebSockets æœåŠ¡å™¨å’Œæ¡†æ¶çš„åŸºå‡†æµ‹è¯•ï¼Œç”¨ Node.js å’Œ [ws](https://github.com/websockets/ws) ç¼–å†™äº†ä¸€ä¸ªåŸºå‡†æµ‹è¯•ç¨‹åºã€‚è¿™ä¸ªé¡¹ç›®è™½ç„¶æœ‰æ•ˆåœ°å®ç°äº†æˆ‘çš„ç ”ç©¶ç›®æ ‡ï¼Œä½†ä¸é€‚åˆå‘è¡¨ã€‚[web socket benchmark](https://github.com/healeycodes/websocket-benchmarker)çš„ç›®æ ‡æ˜¯å­¦ä¹ æ›´å¤šå…³äºå¼‚æ­¥ Python çš„çŸ¥è¯†ï¼Œå¹¶åˆ›é€ ä¸€äº›å…¶ä»–äººå¯ä»¥ä½¿ç”¨çš„ä¸œè¥¿ã€‚è¿™é‡Œçš„å¯ç”¨æ€§æŒ‡çš„æ˜¯ä¸€äº›ç«¯åˆ°ç«¯çš„æµ‹è¯•ã€å¯ç»´æŠ¤æ€§å’Œå¸¦æœ‰æ–‡æ¡£å­—ç¬¦ä¸²çš„è‰¯å¥½æ³¨é‡Šçš„ä»£ç :

```
async def client(state):
    '''A WebSocket client, which sends a message and expects an echo
    `roundtrip` number of times. This client will spawn a copy of itself afterwards,
    so that the requested concurrency-level is continuous.

    Parameters
    ----------
    state : Dictionary
        A Dictionary-like object with the key `clients` --
        the number of clients spawned thus far.

    Returns
    -------
    string
        A statement when the max number of clients have been spawned.''' 
```

> ç­‰å¾…è¡¨è¾¾å¼â€”â€”æš‚åœå¯ç­‰å¾…å¯¹è±¡ä¸Šåç¨‹çš„æ‰§è¡Œã€‚

è¿™ä¸ªç¨‹åºå…è®¸ä¸€äº›äººä¼ªé€ è¿æ¥åˆ° echo æœåŠ¡å™¨çš„å¤šä¸ªå¹¶å‘å®¢æˆ·ç«¯(WebSocket å®ç°å·²ç»è¿‡åŸºå‡†æµ‹è¯•),å¹¶å‘é€ä¸€ç³»åˆ—æ¶ˆæ¯ã€‚åœ¨åŸºå‡†æµ‹è¯•ç»“æŸæ—¶ï¼Œæµ‹é‡ã€è®°å½•å¹¶ç®€è¦åˆ†ææ¯æ¡æ¶ˆæ¯çš„å¾€è¿”æ—¶é—´ã€‚

å¼‚æ­¥è®¾è®¡æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨è½®è¯¢äº‹æƒ…æ¥æŸ¥çœ‹å®ƒä»¬ä½•æ—¶å®Œæˆã€‚asyncio ä¸åƒè¿‡å»é‚£æ ·ç»å¸¸ä¼ é€’å›è°ƒï¼Œè€Œæ˜¯è®©æˆ‘ä»¬åšä¸€äº›äº‹æƒ…ã€‚è¿™æ˜¯å¹¶å‘çš„ï¼Œä½†å¾ˆå®¹æ˜“ã€‚

> `await`ä¸`yield from`ç±»ä¼¼ï¼Œæš‚åœ`read_data`åç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°`db.fetch`a wavable å®Œæˆå¹¶è¿”å›ç»“æœæ•°æ®ã€‚

â€œå®¢æˆ·ç«¯â€æ˜¯å­˜åœ¨äº asyncio äº‹ä»¶å¾ªç¯ä¸­çš„åç¨‹å‡½æ•°ã€‚å®ƒä»¬ç­‰å¾…æ‰“å¼€è¿æ¥ï¼Œç­‰å¾…å‘é€æ¶ˆæ¯ï¼Œç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œç­‰å¾…å…³é—­æ¡æ‰‹ã€‚åœ¨è¿™ä¹‹åï¼Œå®ƒä»¬ä¼šç¹æ®–å‡ºè‡ªå·±çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå¹¶ç­‰å¾…å®ƒçš„åˆ°æ¥ï¼è¿™å°±æ˜¯å¹¶å‘æ€§çš„å®ç°æ–¹å¼ã€‚æ€»æ˜¯æœ‰ç›¸åŒæ•°é‡çš„å®¢æˆ·ç«¯ã€‚ä»ä¸å¤šä¹Ÿä¸ä¼šå°‘ã€‚

```
# create an amount of client coroutine functions to satisfy args.concurrency con_clients = [client] * concurrency

# pass them all a 'link' to the same state Dictionary state = dict({'clients': 0})

# run them concurrently main = asyncio.gather(*[i(state) for i in con_clients])
loop = asyncio.get_event_loop()
loop.run_until_complete(main) 
```

ä¸€æ—¦è¿›å…¥å¼‚æ­¥å‡½æ•°ï¼Œäº‹æƒ…å°±åƒå¬èµ·æ¥ä¸€æ ·ç®€å•:

`response = await websocket.recv()`

ç°åœ¨ï¼Œæ§åˆ¶æµå°†è½¬åˆ°å…¶ä»–åœ°æ–¹ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è¿”å›ã€‚

åœ¨æ¥ä¸‹æ¥çš„æ—¥å­é‡Œï¼Œæˆ‘å¸Œæœ›ä½¿ç”¨è¿™ä¸ªè½¯ä»¶æ¥æ›´æ–°æˆ‘ä¸ªäººå¯¹ WebSocket æœåŠ¡å™¨å’Œæ¡†æ¶çš„åŸºå‡†æ’åï¼Œå¹¶å†™å¦ä¸€ç¯‡å…³äºç»“æœçš„åšæ–‡(ä»¥åŠå¯»æ±‚åŸå§‹æ€§èƒ½é€šå¸¸ä¼šå¯¼è‡´çš„æƒè¡¡)ï¼

è´¡çŒ®æ˜¯æœ€å—æ¬¢è¿çš„â¤ï¸.

## ![GitHub logo](../Images/a73f630113876d78cff79f59c2125b24.png)[Healey codes](https://github.com/healeycodes)/[web socket-benchmark](https://github.com/healeycodes/websocket-benchmarker)

### æµ‹è¯• WebSocket æœåŠ¡å™¨çš„æ¶ˆæ¯ååé‡âŒ›

<article class="markdown-body entry-content container-lg" itemprop="text">

[![Build Status](../Images/5e06aba01066a1e5e9da90f8e0d9c265.png)T2ã€‘](https://travis-ci.org/healeycodes/websocket-benchmarker)

## <g-emoji class="g-emoji" alias="radio" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4fb.png">ğŸ“»</g-emoji> WebSocket åŸºå‡†æµ‹è¯•å‘˜ <g-emoji class="g-emoji" alias="watch" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/231a.png">âŒš</g-emoji>

*æ¶ˆæ¯ååé‡*æ˜¯ WebSocket æœåŠ¡å™¨è§£æå’Œå“åº”æ¶ˆæ¯çš„é€Ÿåº¦ã€‚æœ‰äº›äººè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ¡†æ¶/åº“/æœåŠ¡å™¨æ€§èƒ½çš„å¥½å‚è€ƒã€‚è¯¥å·¥å…·é€šè¿‡æ¨¡æ‹Ÿå¹¶å‘å®¢æˆ·ç«¯æ¥æµ‹é‡è´Ÿè½½ä¸‹çš„æ¶ˆæ¯ååé‡ã€‚

[![](../Images/f5f83fd11890b38dee6c54251c9c1a9c.png)T2ã€‘](https://github.com/healeycodes/websocket-benchmarker/blob/master/images/header.png)

* * *

###### 2019.01.26

ç°åœ¨æœ‰äº† 100%æ›´å¤šçš„å‡ºè¡€è¾¹ç¼˜<g-emoji class="g-emoji" alias="zap" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26a1.png">âš¡</g-emoji>T2ã€‘é˜¿è¾›è¥¿å¥¥å–„è‰¯ã€‚

* * *

### è£…ç½®

Python 3.6.5+ã€‚

`pip install -r requirements.txt`

### ä½¿ç”¨

è¿™ä¸ªç¨‹åºå¸Œæœ›ä¸»æœºæ˜¯ä¸€ä¸ª echo æœåŠ¡å™¨ï¼Œå¹¶æµ‹é‡å‘é€æ¶ˆæ¯å’Œä»ä¸»æœºæ¥æ”¶åˆ°ç›¸åŒæ¶ˆæ¯ä¹‹é—´çš„æ—¶é—´ã€‚å®ƒåŒæ—¶ä¸ºå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥æ‰§è¡Œæ­¤æ“ä½œï¼Œæ—¨åœ¨äº§ç”Ÿå¯é‡å¤çš„ç»“æœã€‚

`python bench.py`å°†å¯åŠ¨åŸºå‡†å¹¶å°†ç»Ÿè®¡æ•°æ®æ‰“å°åˆ° stdoutã€‚å¦‚æœæ—¥å¿—æ–‡ä»¶è·¯å¾„æŒ‡å‘éæ–‡ä»¶ï¼Œåˆ™å°†åˆ›å»ºä¸€ä¸ªï¼Œå¦åˆ™ç»“æœå°†é™„åŠ åˆ°ç°æœ‰æ–‡ä»¶ä¸­ã€‚

åŸå§‹ç»“æœä¸º CSV æ ¼å¼ï¼Œæ¯è¡Œâ€¦

</article>

[View on GitHub](https://github.com/healeycodes/websocket-benchmarker)

* * *

åŠ å…¥æˆ‘çš„å…³äºç¼–ç¨‹å’Œä¸ªäººæˆé•¿çš„[æ—¶äº‹é€šè®¯](https://buttondown.email/healeycodes)çš„ 150 å¤šäººæ³¨å†Œï¼

æˆ‘å‘å…³äºç§‘æŠ€çš„å¾®åšã€‚