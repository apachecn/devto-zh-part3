# å¾ªç¯è¿ç»­éƒ¨ç½²-ç¬¬ 2 éƒ¨åˆ†

> åŸæ–‡:# t0]https://dev . to/jeansmaug/dploizione-continu-with-circus-part-2-6 op

[ç¬¬ä¸€éƒ¨åˆ†](https://dev.to/deploiement-continu-avec-circleci-partie-1)æœ‰åŠ©äºå‘ç°å¾ªç¯çš„åŸºæœ¬æ¦‚å¿µä»¥åŠå¦‚ä½•åº”ç”¨è¿™äº›æ¦‚å¿µã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•é€šè¿‡å„ç§æ–¹å¼åœ¨å·¥ä½œä¹‹é—´å…±äº«ä¿¡æ¯ã€‚

## [](#%C3%A9tat-des-lieux)åœºæ‰€çŠ¶å†µ

```
version: 2.1
jobs:
  build:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - run: yarn install
      - run: yarn build

  lint:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - run: yarn install
      - run: yarn lint

  test:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - run: yarn install
      - run: yarn test:unit

  deploy:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - run: yarn install
      - run: yarn build
      - run: yarn firebase deploy --token "$FIREBASE_TOKEN" --only hosting

workflows:
  version: 2
  integration:
    jobs:
      - build
      - lint
      - test
    - deploy:
          requires:
            - build
            - lint
            - test
          filters:
            branches:
              only: master 
```

æˆ‘ä»¬çš„é…ç½®æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯é‡å¤çš„ã€‚æ¯ä¸ªä½œä¸šéƒ½åŒ…å«è¿™äº›è¡Œ:

```
docker:
  - image: circleci/node:11.10.1
steps:
  - checkout
  - run: yarn install 
```

å‰ä¸¤è¡Œ(è¿è¡Œæ—¶ç¯å¢ƒé…ç½®ä¸­çš„è¡Œ)åªæ˜¯é…ç½®æ–‡ä»¶ä¸­çš„é‡å¤é¡¹ï¼Œä¸ä¼šå½±å“æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ç¡®ä¿å¯æŒç»­æ€§ï¼Œå°†ä½¿ç”¨æ‰§è¡Œè€…å’Œå‘½ä»¤å¯¹è¿™äº›ç¢ç‰‡è¿›è¡Œæµ‹é‡ã€‚

ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œæ¯ä¸ªä½œä¸šéƒ½å¿…é¡»é‡æ–°å®‰è£…ç›¸å…³æ€§ï¼Œå› ä¸ºå®ƒä»¬åœ¨éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œå…¶è¯­å¥ã€‚
è¦è§£å†³æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬å°†å®‰è£…ä¾èµ–å…³ç³»ï¼Œç¼“å­˜å®ƒä»¬ï¼Œä»¥ä¾¿å·¥ä½œæµä½œä¸šå¯ä»¥å…±äº«å®ƒä»¬ã€‚é«˜é€Ÿç¼“å­˜çš„ç›¸å…³æ€§ä¹Ÿå¯ç”¨äºå°†æ¥çš„ä½œä¸šã€‚

æœ€åä¸€ä¸ªé—®é¢˜æ˜¯éœ€è¦åœ¨å»ºç½®å·¥ä½œä¸­é‡æ–°å»ºç½®å®é™…ç¯å¢ƒæ‰§è¡Œåº”ç”¨ç¨‹å¼ï¼Œè€Œå»ºç½®å·¥ä½œå·²å®Œæˆæ­¤æ­¥éª¤ã€‚æ­¤å¤–ï¼Œé—®é¢˜è¿˜åœ¨äºä½œä¸šæ˜¯å­¤ç«‹çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œéƒ¨ç½²ä½œä¸šæ— æ³•è¯»å–ç”Ÿæˆä½œä¸šæ‰€ç”Ÿæˆçš„å†…å®¹ã€‚æˆ‘ä»¬å°†åˆ©ç”¨å·¥ä½œåŒºæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## [](#cacher-les-d%C3%A9pendances)éšè—ä¾èµ–å…³ç³»

è¦ä½¿ç”¨ç¼“å­˜ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªæ–°ä½œä¸šæ¥å®‰è£…æˆ‘ä»¬çš„ä¾èµ–é¡¹:

```
install:
  docker:
    - image: circleci/node:11.10.1
  steps:
    - checkout
    - restore_cache:
        key: v1-dependencies-{{ checksum "yarn.lock" }}
    - run: yarn install
    - save_cache:
        key: v1-dependencies-{{ checksum "yarn.lock" }}
        paths:
          - ./node_modules 
```

*   `restore_cache`:æ¢å¤ç»™å®šå¯†é’¥çš„ç¼“å­˜
    *   `key`:ç¼“å­˜æ¢å¤å¯†é’¥
*   `save_cache`:å¤‡ä»½ç¼“å­˜æ–‡ä»¶
    *   `key`:ç¼“å­˜å­˜å‚¨å¯†é’¥
    *   `paths`è¦å‚¨å­˜çš„é¡¹ç›®ï¼Œæ­¤å¤„ä¸º node_modules

æ­¤æ­¥éª¤å°†å°è¯•æ¢å¤åŒ…å«â€œ`node_modules`â€çš„ç¼“å­˜ï¼Œä»¥ä¾¿è·³è¿‡ä¾èµ–é¡¹å®‰è£…æ­¥éª¤ã€‚

æ³¨æ„:å¿«å–é‡‘é’¥åŒ…å«ç”± checksum å‡½æ•°äº§ç”Ÿçš„`yarn.lock`æ¡£æ¡ˆæ‚å‡‘ã€‚å› æ­¤ï¼Œå¦‚æœæ–‡ä»¶æ›´æ”¹ï¼Œæ•£åˆ—å°†æ›´æ”¹ï¼Œç¼“å­˜å°†é‡æ–°ç”Ÿæˆã€‚

æˆ‘ä»¬å¯ä»¥æ›´æ–°é…ç½®ä¸­çš„å…¶ä»–ä½œä¸šä»¥ä½¿ç”¨ç¼“å­˜:

```
version: 2
jobs:
  install:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - restore_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}
      - run: yarn install
      - save_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules

  build:
    docker:
      - image: circleci/node:11.10.1
    steps:
      - checkout
      - restore_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}
      - run: yarn build

  # autres jobs...

workflows:
  version: 2
  integration:
    jobs:
      - install
      - build:
          requires:
            - install
      - lint:
          requires:
            - install
      - test:
          requires:
            - install
    - deploy:
          requires:
            - build
            - lint
            - test
          filters:
            branches:
              only: master 
```

ç°åœ¨åªéœ€å®‰è£…ä¸€æ¬¡ï¼Œå³å¯åœ¨ä¸åŒä½œä¸šä¹‹é—´å…±äº«ä¾èµ–å…³ç³»ã€‚è¯·è®°ä½ï¼Œæ¯ä¸ªä½œä¸šéƒ½éœ€è¦å®Œæˆ install ä½œä¸šã€‚

ä½¿ç”¨ç¼“å­˜å¯ä»¥èŠ‚çœå¤§çº¦ 20 ç§’çš„éƒ¨ç½²æ—¶é—´ã€‚

[![circleci-with-cache](../Images/5c1209eff5b70706607829852b924d9a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--CMZmZ4_X--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/v4xljhbhu526uq29anpv.png)

## [](#les-workspaces)Les å·¥ä½œåŒº

å·¥ä½œåŒºæ˜¯ä¸€ä¸ªå…è®¸ä½œä¸šä¸å…¶åç»­ä½œä¸šå…±äº«æ•°æ®çš„ç©ºé—´ã€‚
åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨`build`ä½œä¸šä¸­æ„å»ºåº”ç”¨ç¨‹åºï¼Œå°†é™æ€æ–‡ä»¶å­˜å‚¨åœ¨å·¥ä½œåŒºä¸­ï¼Œä»¥ä¾¿`deploy`ä½œä¸šåœ¨å¿…è¦æ—¶å¯ä»¥æ£€ç´¢å®ƒä»¬ã€‚

```
build:
  docker:
    - image: circleci/node:11.10.1
  steps:
    - checkout
    - restore_cache:
        key: v1-dependencies-{{ checksum "yarn.lock" }}
    - run: yarn build
    - persist_to_workspace:
        root: ~/project
        paths:
          - ./dist 
```

*   `persist_to_workspace`è¡¨ç¤ºè¦å†™å…¥å·¥ä½œåŒº
    *   `~/project`:è¦åœ¨å…¶ä¸­è·å–ä¿¡æ¯çš„æ–‡ä»¶å¤¹ï¼Œé»˜è®¤ä¸º`~/project`
    *   `paths`è¦å†™å…¥å·¥ä½œåŒºçš„æ¡£æ¡ˆ/èµ„æ–™å¤¹è·¯å¾„æ¸…å•

```
deploy:
  docker:
    - image: circleci/node:11.10.1
  steps:
    - checkout
    - restore_cache:
        key: v1-dependencies-{{ checksum "yarn.lock" }}
    - attach_workspace:
        at: ~/project
    - run: yarn firebase deploy --token "$FIREBASE_TOKEN" --only hosting 
```

ä¸ç¬¬ä¸€éƒ¨åˆ†çš„é…ç½®ç›¸æ¯”ï¼Œä½¿ç”¨å·¥ä½œåŒºä½œä¸ºé«˜é€Ÿç¼“å­˜çš„è¡¥å……å¯ä»¥èŠ‚çœå¤§çº¦ 30 ç§’ğŸ‰ã€‚

[![circle-ci-final-build](../Images/9a75cfdc658ca922323f2678c3773efe.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Maian0hB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/k0qbfmp2ov6fbyfezgee.png)

## [](#sur-le-les-executors-et-les-commandes)ğŸ’åœ¨ä¸ŠğŸ°:æ‰§è¡Œè€…å’Œå‘½ä»¤

åœ¨æ­¤ï¼Œæˆ‘ä»¬å°†ä¼˜åŒ–é…ç½®ï¼Œä»¥æœ€å¤§é™åº¦åœ°é¿å…åœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°é‡å¤ã€‚
Les `commands`ä½¿æˆ‘ä»¬èƒ½å¤Ÿå¯¹æˆ‘ä»¬å·¥ä½œçš„é˜¶æ®µè¿›è¡Œç³»æ•°è®¡ç®—ã€‚
ä½¿ç”¨`executors`å¯ä»¥å¯¹è¿è¡Œæˆ‘ä»¬çš„è„šæœ¬çš„ç¯å¢ƒè¿›è¡Œç³»æ•°è®¡ç®—ã€‚

```
commands:
  checkout_and_restore_cache:
    steps:
      - checkout
      - restore_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}

executors:
  node:
    docker:
      - image: circleci/node:11.10.1 
```

æˆ‘ä»¬å¯ä»¥æ›´æ–°æˆ‘ä»¬çš„å·¥ä½œ:

```
install:
  executor: node
  steps:
    - checkout_and_restore_cache
    - run: yarn install
    - save_cache:
        key: v1-dependencies-{{ checksum "yarn.lock" }}
        paths:
          - ./node_modules 
```

## [](#la-configuration-finale)æ‹‰é…ç½®å‹è½´

```
version: 2.1

commands:
  checkout_and_restore_cache:
    steps:
      - checkout
      - restore_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}

executors:
  node:
    docker:
      - image: circleci/node:11.10.1

jobs:
  install:
    executor: node
    steps:
      - checkout_and_restore_cache
      - run: yarn install
      - save_cache:
          key: v1-dependencies-{{ checksum "yarn.lock" }}
          paths:
            - ./node_modules

  build:
    executor: node
    steps:
      - checkout_and_restore_cache
      - run: yarn build
      - persist_to_workspace:
          root: ~/project
          paths:
            - dist/*

  lint:
    executor: node
    steps:
      - checkout_and_restore_cache
      - run: yarn lint

  test:
    executor: node
    steps:
      - checkout_and_restore_cache
      - run: yarn test:unit

  deploy:
    executor: node
    steps:
      - checkout_and_restore_cache
      - attach_workspace:
          at: ~/project
      - run: yarn firebase deploy --token "$FIREBASE_TOKEN" --only hosting

workflows:
  version: 2
  integration:
    jobs:
      - install
      - build:
          requires:
            - install
      - lint:
          requires:
            - install
      - test:
          requires:
            - install
      - deploy:
          requires:
            - build
            - lint
            - test
          filters:
            branches:
              only: master 
```

## [](#conclusion)ç»“è®º

æˆ‘ä»¬ç»ˆäºæœ‰äº† bogass çš„é…ç½®ğŸ˜
é€šè¿‡ç¼“å­˜å’Œå·¥ä½œåŒºçš„ä½¿ç”¨è¡¨ç°å‡ºè‰²ï¼Œé€šè¿‡å‘½ä»¤å’Œæ‰§è¡Œè€…ä¿æŒå¯æ“ä½œæ€§ï¼Œé€šè¿‡è‹¹æœå‹å¥½ã€‚

è°¢è°¢ä½ è¯»ç»™æˆ‘å¬ã€‚

## [](#liens-utiles)æœ‰ç”¨çš„é“¾æ¥

*   [ç»„æ€æ¡£æ¡ˆå‚è€ƒæ–‡ä»¶](https://circleci.com/docs/2.0/configuration-reference)
*   [é…ç½®å‹è½´](https://github.com/jean-smaug/condorcet/blob/4046a6723fc2c4b6470c79b309683d9f7af9844a/.circleci/config.yml)