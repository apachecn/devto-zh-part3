# å»ºç«‹ä¸€ä¸ª Python æœºå™¨äººæ¥æ‰¾åˆ°ä½ çš„ç½‘ç«™çš„æ­»é“¾æ¥

> åŸæ–‡:[https://dev . to/Healey codes/build-a-python-bot-to-find-your-website-s-dead-links-563 c](https://dev.to/healeycodes/build-a-python-bot-to-find-your-website-s-dead-links-563c)

æ­»é“¾æ¥å’Œå›¾åƒï¼Œè®©æ¸¸å®¢æ„Ÿåˆ°æ²®ä¸§ã€‚æ‰‹åŠ¨æ£€æŸ¥å®ƒä»¬ä¼šæ›´åŠ ä»¤äººæ²®ä¸§ï¼æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªæœºå™¨äººï¼Œä»…ä½¿ç”¨ Python æ ‡å‡†åº“æ¥æŠ“å–ç½‘ç«™ä¸Šç¼ºå¤±çš„èµ„æºã€‚

[![](../Images/dd1b84e5102efb5c528236cbcd712338.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--5dCEYOws--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/uk31t1u3c6l4xcsdivoz.gif)

æˆ‘ä»¬æ¥è°ˆè°ˆè®¾è®¡ç›®æ ‡ã€‚æˆ‘ä»¬æƒ³è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œè®©æ•´ä¸ªç½‘ç«™æ£€æŸ¥æ­»èµ„æºã€‚è¿™æ„å‘³ç€å°†æ¶‰åŠä¸€äº›çˆ¬è¡Œã€‚

```
$ python deadseeker.py 'https://healeycodes.com/'
> 404 - https://docs.python.org/3/library/missing.html
> 404 - https://github.com/microsoft/solitare2 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»æŠ€æœ¯ä¸Šè®²ï¼Œæœºå™¨äººåº”è¯¥è§£æç»™å®šé¡µé¢ä¸Šçš„æ‰€æœ‰ HTML æ ‡ç­¾ï¼Œå¯»æ‰¾`href`å’Œ`src`å±æ€§ã€‚å¦‚æœå‘ç°ä»»ä½•é”™è¯¯ï¼Œå®ƒåº”è¯¥å‘é€ä¸€ä¸ª GET è¯·æ±‚å¹¶è®°å½•ä»»ä½• HTTP é”™è¯¯ä»£ç ã€‚å¦‚æœå®ƒå‘ç°æœ¬åœ°é¡µé¢(å¦‚`/about/`ã€`/projects/`)ï¼Œå®ƒåº”è¯¥å°†å®ƒä»¬æ’é˜Ÿä»¥ä¾›ä»¥åæ‰«æã€‚å½“æˆ‘ä»¬æ£€æŸ¥é“¾æ¥æ—¶ï¼Œè®©æˆ‘ä»¬å°†å®ƒä»¬æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åªæ£€æŸ¥å®ƒä»¬ä¸€æ¬¡ã€‚

Python ä¸ºæˆ‘ä»¬æä¾›äº†[html . parser](https://docs.python.org/3/library/html.parser.html#module-html.parser)â€”â€”ä¸€ä¸ªç®€å•çš„ HTML å’Œ XHTML è§£æå™¨ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

```
from html.parser import HTMLParser

# extend HTMLParser class MyHTMLParser(HTMLParser):
    # override `handle_starttag`
    def handle_starttag(self, tag, attrs):
        print(f'Encountered a start tag: {tag}')
        print(f'And some attributes: {attrs}')

parser = MyHTMLParser()
parser.feed('<html><body><a href="https://google.com">Google</a></body></html>') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å¼ ç…§ç‰‡:

```
> Encountered a start tag: a
> And some attributes: [('href', 'https://google.com')] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é‚£æ˜¯ä¸ºæˆ‘ä»¬å¤„ç†çš„é‡ç‰©ã€‚è¯·æ±‚æ€ä¹ˆæ ·äº†ï¼ŸPython æœ‰ [urllib.request](https://docs.python.org/3/library/urllib.request.html#module-urllib.request) ã€‚å®ƒæœ‰`urllib.request.urlopen`,æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å‘é€ GET è¯·æ±‚ã€‚å¤§å¤šæ•°æ—¶å€™ä½ ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹åº“[è¯·æ±‚](http://docs.python-requests.org)ï¼Œä½†æ˜¯æˆ‘ä»¬çš„éœ€æ±‚å¾ˆå°ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å®ç°å®ƒï¼

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ Google æ˜¯å¦å¯åŠ¨äº†ï¼Œæˆ‘ä»¬æœŸå¾…ä¸€ä¸ª HTTP çŠ¶æ€ä»£ç  200 (OK)ã€‚

```
>>> import urllib.request
>>> r = urllib.request.urlopen('https://google.com')
>>> r.status
200 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº›ç½‘ç«™ä¼šè¿”å› 403(ç¦æ­¢)ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç”¨æˆ·ä»£ç†ä¼šèƒŒå›æˆ‘ä»¬è¿™ä¸ªæœºå™¨äººã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒçœ‹èµ·æ¥ä¼šåƒ`User-Agent: Python-urllib/3.7`ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ªè£…æˆä¸åŒçš„ç”¨æˆ·ä»£ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è´Ÿè´£ä»»çš„æœºå™¨äººä¼šå…ˆæ£€æŸ¥ [robots.txt](http://www.robotstxt.org/) æ£€æŸ¥ç½‘ç«™çš„è§„åˆ™ï¼

æˆ‘ä»¬ä»è¿›å£å¼€å§‹ï¼Œè·å–æˆ‘ä»¬éœ€è¦çš„ä¸€åˆ‡ã€‚æˆ‘ä»¬è¿˜å­˜å‚¨äº†å¯¹ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²çš„å¼•ç”¨ã€‚è¿™æ„å‘³ç€*ç”¨æˆ·æ­£åœ¨æµè§ˆæœ€è¿‘çš„ Chrome ç‰ˆæœ¬*ã€‚

```
import sys
import urllib
from urllib import request, parse
from urllib.parse import urlparse, urljoin
from urllib.request import Request
from html.parser import HTMLParser
from collections import deque

search_attrs = set(['href', 'src'])
agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å¯¼å…¥äº†ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¹¶å£°æ˜äº†å¦ä¸€ä¸ªæ•°æ®ç»“æ„â€”â€”dequee å’Œ setã€‚ [deque](https://docs.python.org/3/library/collections.html#collections.deque) æ˜¯ä¸€ä¸ªâ€œç±»ä¼¼åˆ—è¡¨çš„å®¹å™¨ï¼Œå…·æœ‰å¿«é€Ÿè¿½åŠ å’Œä¸¤ç«¯å¼¹å‡ºåŠŸèƒ½â€ã€‚æˆ‘ä»¬å°†æŠŠå®ƒä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—â€”â€”åœ¨å‘ç°æœ¬åœ°é¡µé¢æ—¶æ·»åŠ å®ƒä»¬ï¼Œå¹¶ä»¥å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼æ‰«æå®ƒä»¬ã€‚æˆ‘ä»¬çš„ [Set](https://docs.python.org/3/library/stdtypes.html#set) ç”¨æ³•æ›´ç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨å‘é€å’Œæ·»åŠ é“¾æ¥ä¹‹å‰æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»å‘é“¾æ¥å‘é€äº†è¯·æ±‚ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨ä¸€ä¸ª[åˆ—è¡¨](https://docs.python.org/3/tutorial/datastructures.html)ï¼Œä½†æ˜¯è¿™æ ·ä¼šé™ä½è®¡ç®—æ•ˆç‡ã€‚

æˆ‘ä»¬å°†`HTMLParser`æ‰©å±•ä¸º`LinkParser`â€”â€”æˆ‘ä»¬ç¨‹åºçš„æ ¸å¿ƒã€‚æˆ‘ä»¬ä½¿ç”¨ [super()](https://docs.python.org/3/library/functions.html#super) æ¥å¼•ç”¨æˆ‘ä»¬æ­£åœ¨è¦†ç›–çš„çˆ¶æ„é€ å‡½æ•°ã€‚

```
class LinkParser(HTMLParser):
    def __init__(self, home):
        super().__init__()
        self.home = home
        self.checked_links = set()
        self.pages_to_check = deque()
        self.pages_to_check.appendleft(home)
        self.scanner() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹æ—¶ï¼Œæˆ‘ä»¬æŠŠå®ƒä¼ é€’ç»™æˆ‘ä»¬ç½‘ç«™çš„ä¸»é¡µã€‚æˆ‘ä»¬å°†å®ƒå­˜å‚¨ä¸º`self.home`,è¿™æ ·æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æ£€æŸ¥æˆ‘ä»¬é‡åˆ°çš„é“¾æ¥æ˜¯å¦æ˜¯æœ¬åœ°é¡µé¢ã€‚æ­£å¦‚ä½ åœ¨æ„é€ å‡½æ•°çš„æœ«å°¾çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬é©¬ä¸Šå¼€å§‹æ‰«æâ€”â€”ä½†æ˜¯â€œæ‰«æâ€æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

```
def scanner(self):
    # as long as we still have pages to parse
    while self.pages_to_check:

        # take the first page added
        page = self.pages_to_check.pop()

        # send a request to it using our custom header
        req = Request(page, headers={'User-Agent': agent})
        res = request.urlopen(req)

        # check that we're about to parse HTML (e.g. not CSS)
        if 'html' in res.headers['content-type']:
            with res as f:

                # read the HTML and assume that it's UTF-8
                body = f.read().decode('utf-8', errors='ignore')
                self.feed(body) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“`feed`è§£æ HTML æ—¶ï¼Œå®ƒä¼šé‡åˆ°æ ‡ç­¾å¹¶è°ƒç”¨`handle_starttag`ã€`handle_endtag`å’Œå…¶ä»–æ–¹æ³•ã€‚æˆ‘ä»¬ç”¨è‡ªå·±çš„æ–¹æ³•è¦†ç›–äº†`handle_starttag`ï¼Œè¯¥æ–¹æ³•æ£€æŸ¥æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„é”®çš„å±æ€§ã€‚å½“æˆ‘ä»¬é‡åˆ°`<a href="http://google.com">Google</a>`æ—¶ï¼Œæˆ‘ä»¬æƒ³è¦æå–`href`å€¼ã€‚ç±»ä¼¼åœ°ï¼Œå¯¹äº`<img src="/cute_dog.png">`,æˆ‘ä»¬éœ€è¦`src`å€¼ã€‚

```
def handle_starttag(self, tag, attrs):
    for attr in attrs:
        # ('href', 'https://google.com')
        if attr[0] in search_attrs and attr[1] not in self.checked_links:
            self.checked_links.add(attr[1]) 
            self.handle_link(attr[1]) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æé†’:è¦å¾ªç¯éå†ä¸€ä¸ª iterableï¼Œå¯ä»¥ä½¿ç”¨`for thing in things:`ï¼Œåœ¨ä¸‹é¢çš„å—ä¸­ï¼Œé€šè¿‡ç¬¬ä¸€ä¸ªå˜é‡`thing`å¼•ç”¨æ¯ä¸€é¡¹ã€‚è¦æ£€æŸ¥æŸä¸ªä¸œè¥¿æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¯ä»¥ä½¿ç”¨`item in a_set`ï¼Œå®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚å¯ä»¥ç”¨`a_set.add(item)`åŠ ã€‚

```
def handle_link(self, link):
    # check for a relative link (e.g. /about/, /blog/)
    if not bool(urlparse(link).netloc):

        # fix if we need to, we can't send a request to `/about/`
        link = urljoin(self.home, link)

    # attempt to send a request, seeking the HTTP status code
    try:
        req = Request(link, headers={'User-Agent': agent})
        status = request.urlopen(req).getcode()

    # we're expecting errors (dead resources) so let's handle them
    except urllib.error.HTTPError as e:
        print(f'HTTPError: {e.code} - {link}')  # (e.g. 404, 501, etc)
    except urllib.error.URLError as e:
        print(f'URLError: {e.reason} - {link}')  # (e.g. conn. refused) 
    # otherwise, we got a 200 (OK) or similar code!
    else:

        # remove this in production or we won't spot our errors
        print(f'{status} - {link}')

    # build a queue of local pages so we crawl the entire website
    if self.home in link:
        self.pages_to_check.appendleft(link) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€ä¸ªå®Œæ•´çš„æ­»èµ„æºçˆ¬è™«ï¼Œä¸åˆ° 50 è¡Œæ™®é€šä»£ç ã€‚èµ Pythonã€‚è®¸å¤šäººè®¤ä¸ºæ‰©å±•çš„æ ‡å‡†åº“æ˜¯å®ƒå—æ¬¢è¿çš„åŸå› ä¹‹ä¸€ã€‚æˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯è°ƒç”¨æˆ‘ä»¬çš„ç±»ï¼Œåœ¨è„šæœ¬ä¹‹åç»™å®ƒä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

```
LinkParser(sys.argv[1])  # e.g. 'https://healeycodes.com/' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæ˜¯åŒ…å«æœ€ç»ˆä»£ç çš„[åº“](https://github.com/healeycodes/Broken-Link-Crawler)ã€‚æ•™ç¨‹è¯„è®ºå·²ç»æ¸…ç†å®Œæ¯•ã€‚å¿«ä¹è£…ç“¶ğŸ˜€

* * *

æˆ‘åœ¨æˆ‘çš„æ¯å‘¨[ç®€è®¯](https://buttondown.email/healeycodes)ä¸Šå‘å¸ƒç‹¬ç‰¹çš„å†…å®¹ğŸ“§ã€‚