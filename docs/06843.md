# å‘ Node.js Web åº”ç”¨ç¨‹åºæ·»åŠ åŒå› ç´ èº«ä»½éªŒè¯

> åŸæ–‡:[https://dev . to/vonagedev/add-two-factor-authentic ation-to-node-js-we B- apps-1k2h](https://dev.to/vonagedev/add-two-factor-authentication-to-node-js-web-apps-1k2h)

åŒå› ç´ èº«ä»½éªŒè¯(2FA)å¾—åäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³æ‚¨éœ€è¦ä¸¤æ ·ä¸œè¥¿æ¥éªŒè¯æ‚¨çš„èº«ä»½ã€‚æ‚¨çŸ¥é“çš„ä¸€äº›ä¸œè¥¿ï¼Œå¦‚å¯†ç ï¼Œä»¥åŠæ‚¨æ‹¥æœ‰çš„ä¸€äº›ä¸œè¥¿ï¼Œå¦‚æ¥è‡ªæ‚¨çš„ç§»åŠ¨è®¾å¤‡æˆ–ç‰©ç†ä»¤ç‰Œçš„éªŒè¯ç ã€‚

å°† 2FA æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­å¹¶ä¸æ˜¯ä¸€ä»¶å›°éš¾çš„äº‹æƒ…ã€‚æœ¬æ•™ç¨‹å°†ä»‹ç»å¦‚ä½•åœ¨ Nexmo Verify API çš„å¸®åŠ©ä¸‹ï¼Œä¸ºæ‚¨çš„ web åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å®ç° 2FAï¼Œä»¥è·å¾—é¢å¤–çš„å®‰å…¨å±‚ã€‚æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•çš„ Koa.js åº”ç”¨ç¨‹åºæ¥ç†è§£åº•å±‚æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚è¿™å°†ä½¿æ‚¨æ›´å®¹æ˜“çœ‹åˆ°å®ƒå¦‚ä½•é€‚åˆæ‚¨è‡ªå·±çš„ç°æœ‰é¡¹ç›®ï¼Œå³ä½¿æ‚¨æ²¡æœ‰ä½¿ç”¨ Koa.jsã€‚

ä½ å¯ä»¥ä»ä¸€ä¸ªè¦æ±‚ç”¨æˆ·è¾“å…¥æ‰‹æœºå·ç çš„ç™»å½•é¡µé¢å¼€å§‹ã€‚æäº¤åï¼Œä»–ä»¬ä¼šè¢«è¦æ±‚è¾“å…¥éªŒè¯ç ï¼ŒéªŒè¯ç ä¼šé€šè¿‡çŸ­ä¿¡å‘é€åˆ°ä»–ä»¬çš„æ‰‹æœºå·ç ã€‚ä¸€æ—¦å®Œæˆæ’åºï¼Œä»–ä»¬å°±å¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºäº†ã€‚

## [](#prerequisites)å…ˆå†³æ¡ä»¶

*   å¯¹ Javascript çš„åŸºæœ¬ç†è§£
*   å®‰è£…åœ¨æ‚¨æœºå™¨ä¸Šçš„ [Node.js](https://nodejs.org/en/download/)
*   ä¸€ä¸ª [Nexmo](https://dashboard.nexmo.com/sign-up) å¸æˆ·(ç”¨äºæ‚¨çš„ API å‡­è¯)

æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»å¤´å¼€å§‹è¿™ä¸ªè¿‡ç¨‹ã€‚å¦‚æœæ‚¨æƒ³çœ‹åˆ°å®Œæˆçš„ä»£ç ï¼Œæ‚¨å¯ä»¥å…‹éš†è¿™ä¸ªé¡¹ç›®çš„ [git åº“](https://github.com/nexmo-community/verify-2fa-koa)ã€‚æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª Glitch ç‰ˆæœ¬ï¼Œå®ƒæœ‰ä¸€ä¸ªæ›´å¤¸å¼ çš„è®¾è®¡ï¼Œä½ ä¹Ÿå¯ä»¥[é‡æ–°æ··éŸ³](https://glitch.com/edit/#!/remix/verify-2fa-koa)ã€‚è¯·æ³¨æ„ï¼Œå®ƒä»¬å¯¹äº Glitch å®ç°ç•¥æœ‰ä¸åŒï¼Œä»¥é€‚åº”é¡¹ç›®åœ¨å¹³å°ä¸Šçš„æ‰˜ç®¡æ–¹å¼ã€‚

[![Glitch version of demo](../Images/a0d5869a98e2718b186927692fba2665.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--28EeUWPd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Fglitch.png%3F1554816007328)

## [](#starting-a-koajs-project-from-scratch)ä»é›¶å¼€å§‹ä¸€ä¸ª Koa.js é¡¹ç›®

åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®ä¸€ä¸ªæ–°çš„ Node.js é¡¹ç›®ã€‚

```
npm init 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†è§¦å‘ä¸€ç³»åˆ—æç¤ºï¼Œç”Ÿæˆæ‚¨çš„`package.json`æ–‡ä»¶ã€‚å¦‚æœæ„¿æ„ï¼Œæ‚¨å¯ä»¥é€‰æ‹©å°†ç­”æ¡ˆç•™ç©ºä»¥ä½¿ç”¨é»˜è®¤å€¼ã€‚

[![Configuring package.json](../Images/3666cb92556239c2bc7ef6341afa1d2e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--niuEw8Zb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Fnpm-init.png%3F1554655286468)

æ¥ä¸‹æ¥ï¼Œå®‰è£… [Koa.js](https://koajs.com/) ã€‚è¯·æ³¨æ„ï¼ŒKoa éœ€è¦ 7.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬çš„èŠ‚ç‚¹æ¥æ”¯æŒ ES2015 å’Œå¼‚æ­¥åŠŸèƒ½ã€‚

```
npm install koa --save 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`server.js`æ–‡ä»¶ã€‚

```
touch server.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°†ä»¥ä¸‹ä»£ç ç²˜è´´åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ã€‚

```
const Koa = require('koa')
const port = process.env.PORT || 3000
const app = new Koa()

app.use(async ctx => {
  ctx.body = 'Hello Unicorn ğŸ¦„'
})

const listener = app.listen(port, function() {
  console.log('Your app is listening on port ' + listener.address().port)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿è¡Œ`server.js`æ–‡ä»¶ã€‚

```
node server.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ ä»æµè§ˆå™¨å¯¼èˆªåˆ°`http://localhost:3000`ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç©ºç™½é¡µé¢ï¼Œä¸Šé¢å†™ç€â€œä½ å¥½ï¼Œç‹¬è§’å…½ğŸ¦„".

[![Check that server is running](../Images/59c5d4b25e4e3d7518b18d903fa113f9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Y1SBsHFW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Fkoa-server.png%3F1554656108532)

æ‚¨è¿˜åº”è¯¥å®‰è£… [dotenv](https://www.npmjs.com/package/dotenv) ï¼Œå®ƒå…è®¸æ‚¨å°†å­˜å‚¨åœ¨`.env`æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡åŠ è½½åˆ°`process.env`ä¸­ã€‚

```
npm install dotenv --save 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æ‚¨å¯ä»¥åˆ›å»º`.env`æ–‡ä»¶ï¼Œå®ƒè‡³å°‘åº”è¯¥åŒ…å«ä»¥ä¸‹å˜é‡:

```
NEXMO_API_KEY=''
NEXMO_API_SECRET='' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦è®¿é—®ç¯å¢ƒå˜é‡ï¼Œä½ å¿…é¡»éœ€è¦å®ƒï¼Œæœ€å¥½æ˜¯åœ¨ä½ çš„`server.js`æ–‡ä»¶çš„é¡¶éƒ¨ã€‚

```
require('dotenv').config() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä½ è¿˜æ²¡æœ‰æ³¨å†Œä¸€ä¸ª Nexmo è´¦æˆ·ï¼Œç°åœ¨æ˜¯æ—¶å€™äº†ã€‚ä¸€æ—¦æ‚¨ç™»å½•åˆ°ä»ªè¡¨æ¿ï¼Œæ‚¨é¦–å…ˆçœ‹åˆ°çš„åº”è¯¥æ˜¯æ‚¨çš„ API å‡­è¯ã€‚è¯·åŠ¡å¿…ç”¨å¼•å·å°†æ‚¨çš„å¯†é’¥å’Œæœºå¯†æ‹¬èµ·æ¥ã€‚

## [](#project-structure)é¡¹ç›®ç»“æ„

ç°åœ¨ï¼Œä½ çš„é¡¹ç›®å¯èƒ½åªæœ‰ä¸€ä¸ª`package.json`ã€ä¸€ä¸ª`server.js`å’Œä¸€ä¸ª`.env`æ–‡ä»¶ã€‚è®©æˆ‘ä»¬è®¾ç½®é¡¹ç›®ç»“æ„ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æœ‰ä¸€ä¸ªåŸºæœ¬çš„å‰ç«¯ä¾›ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚

```
PROJECT_NAME/               
    |-- public/             
    | |-- client.js
    | `-- style.css
    |-- views/
    | `-- index.html
    |-- .env
    |-- package.json
    `-- server.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ ·ï¼Œæ‚¨å¿…é¡»å¯¹`server.js`æ–‡ä»¶è¿›è¡Œä¸€äº›è°ƒæ•´ï¼Œä»¥æœåŠ¡äº`index.html`æ–‡ä»¶å’Œç›¸å…³èµ„äº§ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€è¡Œæ–‡æœ¬ã€‚Koa.js æ˜¯ä¸€ä¸ªç›¸å½“ç®€å•çš„æ¡†æ¶ï¼Œæ‰€ä»¥ä»»ä½•è·¯ç”±æˆ–æœåŠ¡é™æ€èµ„äº§çš„é™„åŠ åŠŸèƒ½éƒ½éœ€è¦å•ç‹¬å®‰è£…ã€‚ä»¥ä¸‹æ˜¯é™„åŠ æ¨¡å—åŠå…¶ç”¨é€”çš„åˆ—è¡¨:

*   `koa-static`ç”¨äºæœåŠ¡é™æ€èµ„äº§
*   `koa-bodyparser`ç”¨äºå¤„ç†é€šè¿‡ POST è¯·æ±‚å‘é€çš„æ•°æ®
*   `koa-router`ä¸ºè·¯ç”±
*   `koa-views`æ¸²æŸ“æ¨¡æ¿

è¿™ä¸ªä¾‹å­ä¹Ÿä½¿ç”¨äº† [Nunjucks](https://mozilla.github.io/nunjucks/) æ¥å‘ˆç°æ¨¡æ¿æ–‡ä»¶ã€‚Nexmo Verify API å°†ç”¨äºé€šè¿‡ SMS è§¦å‘éªŒè¯ç ï¼Œå› æ­¤æ‚¨è¿˜éœ€è¦å®‰è£… Nexmo çš„ Node.js å®¢æˆ·ç«¯åº“ã€‚

```
npm install koa-static koa-bodyparser koa-router koa-views nunjucks nexmo --save 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#serving-static-assets-and-html-files)æœåŠ¡é™æ€èµ„äº§å’Œ HTML æ–‡ä»¶

ä»¥å…è®¸åº”ç”¨ç¨‹åºæœåŠ¡äºé™æ€èµ„äº§ã€‚åƒæ ·å¼è¡¨å’Œå®¢æˆ·ç«¯ Javascript ä¸€æ ·ï¼Œåœ¨ */public* æ–‡ä»¶å¤¹ä¸­ï¼Œæ‚¨å¯ä»¥å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°`server.js`æ–‡ä»¶ä¸­:

```
const serve = require('koa-static')
app.use(serve('./public')) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†æä¾›æ¥è‡ª*/è§†å›¾*æ–‡ä»¶å¤¹çš„ HTML æ–‡ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨`koa-views`ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª`render()`åŠŸèƒ½ã€‚æœ¬ä¾‹ä¸­ä½¿ç”¨çš„æ¨¡æ¿å¼•æ“æ˜¯ Nunjucksï¼Œä½†æ˜¯æ‚¨å¯ä»¥è‡ªç”±é€‰æ‹©æœ€é€‚åˆæ‚¨çš„æ¨¡æ¿å¼•æ“ã€‚

```
const views = require('koa-views')
app.use(views('./views', { map: { html: 'nunjucks' }})) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥è¦è®¾ç½®çš„æ˜¯ä¸ºåº”ç”¨ç¨‹åºé¡µé¢æä¾›æœåŠ¡çš„ä¸€äº›åŸºæœ¬è·¯çº¿ã€‚

```
const Router = require('koa-router')
const router = new Router()

router.get('/', (ctx, next) => {
  return ctx.render('./index')
})

app.use(router.routes()).use(router.allowedMethods()) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæ‚¨å°†éœ€è¦ 3 ä¸ªé¡µé¢ï¼Œ`index.html`ä½œä¸ºä¸»ç™»å½•é¡µé¢ï¼Œ`verify.html`ä¾›ç”¨æˆ·è¾“å…¥ä»–ä»¬çš„éªŒè¯ç ï¼Œ`result.html`æ˜¾ç¤ºéªŒè¯æ˜¯å¦æˆåŠŸã€‚

web è¡¨å•çš„ç»“æ„ç›¸å½“ç®€å•ï¼Œæ‚¨å¯ä»¥éšæ„ç”¨ CSS ä¿®é¥°å®ƒã€‚

```
<form method="post" action="verify">
  <input name="phone" type="tel" placeholder="+6588888888">
  <button>Get OTP</button>
</form> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥è¡¨å•å°†ç”¨æˆ·è¾“å…¥å‘å¸ƒåˆ°`/verify`è·¯çº¿ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¾“å…¥ä¸­çš„ç”µè¯å·ç æ¥è§¦å‘éªŒè¯ç è¯·æ±‚ã€‚ç±»ä¼¼çš„è¡¨æ ¼ä¹Ÿå¯ç”¨äº`/check`å’Œ`/cancel`çš„å…¶ä»–ä¸¤æ¡è·¯çº¿ã€‚

```
<form method="post" action="check">
  <input name="pin" placeholder="Enter PIN">
  <input name="reqId" type="hidden" value="">
  <button>Verify</button>
</form>

<form method="post" action="cancel">
  <input name="reqId" type="hidden" value="">
  <button class="inline">Cancel verification</button>
</form> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#handling-user-inputs)å¤„ç†ç”¨æˆ·è¾“å…¥

ç„¶åï¼Œä¸ºäº†é€šè¿‡ web è¡¨å•å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œæ‚¨è¿˜éœ€è¦ä¸€äº›è·¯ç”±æ¥å¤„ç†`POST`è¯·æ±‚ã€‚åŠ¡å¿…åœ¨ä»»ä½•è·¯çº¿ä¹‹å‰å£°æ˜`bodyparser()`ã€‚

```
const bodyParser = require('koa-bodyparser')

/* This should appear before any routes */
app.use(bodyParser())

router.post('/verify/', async (ctx, next) => {
  const payload = await ctx.request.body
  /* Function to trigger verification code here */
})

router.post('/check/', async (ctx, next) => {
  const payload = await ctx.request.body
  /* Function to check verification code here */
})

router.post('/cancel/', async (ctx, next) => {
  const payload = await ctx.request.body
  /* Function to cancel verification code here */
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ—¢ç„¶æ‚¨å·²ç»èƒ½å¤Ÿæ¥æ”¶ç”¨æˆ·çš„ç”µè¯å·ç ï¼Œé‚£ä¹ˆæ‚¨å°†éœ€è¦ä½¿ç”¨ Verify API å‘å®ƒå‘é€ä¸€ä¸ª PIN ç ã€‚ç”¨ä½ çš„å‡­è¯åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Nexmo å®ä¾‹ã€‚

```
const Nexmo = require('nexmo');
const nexmo = new Nexmo({
  apiKey: YOUR_API_KEY,
  apiSecret: YOUR_API_SECRET
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬éœ€è¦å¤„ç† 3 ä¸ªåŠŸèƒ½ã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡`nexmo.verify.request()`åŠŸèƒ½è§¦å‘éªŒè¯ç ã€‚å®ƒåŒ…æ‹¬ç”¨æˆ·çš„ç”µè¯å·ç å’Œå“ç‰Œåç§°çš„å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²å°†ä½œä¸ºå‘é€è€…æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚

```
async function verify(number) {
  return new Promise(function(resolve, reject) {
    nexmo.verify.request({
      number: number,
      brand: process.env.NEXMO_BRAND_NAME
    }, (err, result) => {
      if (err) {
        console.error(err)
        reject(err)
      } else {
        resolve(result)
      }
    })
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦æ‚¨çš„ç”¨æˆ·é€šè¿‡çŸ­ä¿¡æ”¶åˆ° PIN ç ï¼Œä»–ä»¬å¿…é¡»å°†å…¶æäº¤ç»™`nexmo.verify.check()`åŠŸèƒ½ï¼Œä»¥ä¾¿è¿›è¡ŒéªŒè¯ã€‚æ‚¨ä¼šæ³¨æ„åˆ°ä¸€ä¸ª`request_id`å‚æ•°ã€‚å½“ PIN ç è¢«æˆåŠŸè§¦å‘æ—¶ï¼Œè·å¾—è¯¥å€¼ã€‚æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥å°†è¯·æ±‚ ID ä¼ é€’ç»™`nexmo.verify.check()`å‡½æ•°ï¼Œè¿™ä¸ªä¾‹å­ä½¿ç”¨äº† *check* è¡¨å•ä¸­çš„ä¸€ä¸ªéšè—å­—æ®µã€‚

```
async function check(reqId, code) {
  return new Promise(function(resolve, reject) {
    nexmo.verify.check({
      request_id: reqId,
      code: code
    }, (err, result) => {
      if (err) {
        console.error(err)
        reject(err)
      } else {
        resolve(result)
      }
    })
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœç”¨æˆ·æ”¹å˜ä¸»æ„ï¼Œæœ€åä¸€ä¸ªåŠŸèƒ½å¯ä»¥è®©ä»–ä»¬é€‰æ‹©å–æ¶ˆéªŒè¯ã€‚å®ƒä½¿ç”¨`nexmo.verify.control()`å‡½æ•°ï¼ŒåŒæ ·éœ€è¦è§¦å‘ PIN ç ç”Ÿæˆçš„è¯·æ±‚ ID å’Œä¸€ä¸ªå­—ç¬¦ä¸²å€¼`cancel`ã€‚

```
async function cancel(reqId) {
  return new Promise(function(resolve, reject) {
    nexmo.verify.control({
      request_id: reqId,
      cmd: 'cancel'
    }, (err, result) => {
      if (err) {
        console.error(err)
        reject(err)
      } else {
        resolve(result)
      }
    })
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![Landing page for demo](../Images/e7d88a5adeee3b3102a8a74673f6a57c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--M2WxLK8m--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Flanding.png%3F1554815323752)

ç°åœ¨ï¼Œæ‚¨éœ€è¦åœ¨æˆ‘ä»¬ä¹‹å‰æŒ‡å®šçš„è·¯ç”±ä¸­ä½¿ç”¨è¿™ 3 ä¸ªå‡½æ•°ï¼Œé¦–å…ˆä»è§¦å‘éªŒè¯ç çš„å‡½æ•°å¼€å§‹ã€‚

```
router.post('/verify/', async (ctx, next) => {
  const payload = await ctx.request.body
  const phone = payload.phone

  const result = await verify(phone)
  const reqId = result.request_id 
  ctx.status = 200
  return ctx.render('./verify', { reqId: reqId })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`ctx.request.body`çœ‹èµ·æ¥ä¼šåƒè¿™æ ·:

```
{  phone:  '+40987654321'  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥è·å–è¯¥ç”µè¯å·ç å¹¶å°†å…¶ä¼ é€’ç»™`verify()`å‡½æ•°ã€‚åªè¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç”µè¯å·ç ï¼ŒéªŒè¯ç å°±ä¼šè¢«æ¿€æ´»ï¼Œä½ ä¼šæ”¶åˆ°ä¸€ä¸ªåŒ…å«`request_id`å’Œ`status`çš„å“åº”ã€‚

```
{  request_id:  '1bf002ecd1e94d8aa81ba7463b19f583',  status:  '0'  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»é‚£é‡Œï¼Œæ‚¨å¯ä»¥å°†è¯·æ±‚ ID å‘é€åˆ°å‰ç«¯ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·è¾“å…¥éªŒè¯ç æ—¶ä½¿ç”¨ã€‚

[![The request_id is passed to the frontend](../Images/0186e152ab62c73a6df7091fbef55ede.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--QF6mIxWa--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Fcheck.png%3F1554884941055)

å½“æ‚¨çš„ç”¨æˆ·æäº¤æ­£ç¡®çš„ PIN æ—¶ï¼Œæ‚¨éœ€è¦å°† PIN å’Œè¯·æ±‚ ID æ’å…¥åˆ°`check()`å‡½æ•°ä¸­ã€‚

```
router.post('/check/', async (ctx, next) => {
  const payload = await ctx.request.body
  const code = payload.pin
  const reqId = payload.reqId

  const result = await check(reqId, code)
  const status = result.status
  ctx.status = 200
  return ctx.render('./result', { status: status })
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŒæ ·ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½å¯ä»¥ä»`ctx.request.body`ä¸­è·å¾—ï¼Œå¦‚æœ PIN è¢«éªŒè¯ä¸ºæ­£ç¡®ï¼Œæ‚¨å°†ä¼šæ”¶åˆ°ä¸€ä¸ªç±»ä¼¼å¦‚ä¸‹çš„å“åº”:

```
{  request_id:  '1bf002ecd1e94d8aa81ba7463b19f583',  status:  '0',  event_id:  '150000001AC57AB2',  price:  '0.10000000',  currency:  'EUR'  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œæ‚¨å¯ä»¥åˆ©ç”¨çŠ¶æ€ä»£ç æ¥ç¡®å®šæ‚¨å¸Œæœ›å‘ç”¨æˆ·æ˜¾ç¤ºä»€ä¹ˆæ¶ˆæ¯ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨äº† Nunjucksï¼Œæ‰€ä»¥ç»“æœé¡µé¢ä¸Šçš„æ ‡è®°çœ‹èµ·æ¥åƒè¿™æ ·:

```
{% if status == 0 %}
<p>Code verified successfully. Â¯\_(ãƒ„)_/Â¯</p>
{% else %}
<p>Something went wrongâ€¦ à² _à² </p>
<p>Please contact the administrator for more information.</p>
{% endif %} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[![Verification messages](../Images/6e0693fee22782e6d18e5ba7051532c6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Cky5FJOQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.glitch.com/e53b88bf-b990-43c3-8efd-a5141145a96c%252Fmessage.png%3F1554885944796)

è¿™æ˜¯å¯¹ä»£ç æ¯ä¸€éƒ¨åˆ†çš„å½»åº•åˆ†è§£ï¼Œä½†æ˜¯ä¸ºäº†æŸ¥çœ‹åº”ç”¨ç¨‹åºæ•´ä½“çš„æ ·å­ï¼Œè¯·æŸ¥çœ‹ GitHub ä¸Šçš„[æºä»£ç ã€‚](https://github.com/nexmo-community/verify-2fa-koa)

## [](#additional-things-to-take-care-of)é¢å¤–è¦ç…§é¡¾çš„ä¸œè¥¿

æœ¬æ•™ç¨‹æ˜¯ä¸€ä¸ªç²¾ç®€ç‰ˆï¼Œåªå¼ºè°ƒå®ç°åŒå› ç´ èº«ä»½éªŒè¯æ‰€å¿…éœ€çš„éƒ¨åˆ†ã€‚ä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­æœ‰è®¸å¤šäº‹æƒ…éœ€è¦æ³¨æ„ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯é”™è¯¯å¤„ç†ã€‚å¯¹äºæˆåŠŸçš„æŸ¥è¯¢ï¼ŒVerify API è¿”å›çŠ¶æ€å€¼`0`,ä½†æ˜¯ä»»ä½•å…¶ä»–å€¼éƒ½è¡¨ç¤ºé”™è¯¯ã€‚

åº”è¯¥å¤„ç†è¿™äº›é”™è¯¯ï¼Œå¹¶ä¸”å‰ç«¯çš„ç”¨æˆ·ç•Œé¢åº”è¯¥åæ˜ ä»»ä½•é˜»æ­¢æˆåŠŸéªŒè¯çš„æ½œåœ¨é”™è¯¯ã€‚å®ç°æŸç§å‰ç«¯éªŒè¯æˆ–è€…ç”šè‡³åˆ©ç”¨ Nexmo çš„ [Number Insight API](https://developer.nexmo.com/number-insight/overview) æ¥ç¡®ä¿åªæœ‰æœ‰æ•ˆçš„ç”µè¯å·ç è¢«ä¼ é€’ç»™ Verify API ä¹Ÿæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

## [](#where-next)ä¸‹ä¸€æ­¥å»å“ªé‡Œï¼Ÿ

å¦‚æœæ‚¨çƒ­è¡·äºä½¿ç”¨è¿™äº› API åšæ›´å¤šçš„äº‹æƒ…ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¯èƒ½å¯¹æ‚¨æœ‰å¸®åŠ©çš„é“¾æ¥:

*   [å¼€å‘äººå‘˜é—¨æˆ·ä¸ŠéªŒè¯ API çš„æ–‡æ¡£](https://developer.nexmo.com/verify/overview)
*   å„ç§ Nexmo APIs çš„ç³»åˆ—æ•™ç¨‹
*   å¦‚æœä½ éœ€è¦æˆ‘ä»¬ï¼Œè¯•è¯• [Nexmo ç¤¾åŒº Slack é¢‘é“](https://developer.nexmo.com/community/slack)
*   è¯·å‘æ¨æ–‡åˆ° [@NexmoDev](https://twitter.com/nexmodev) è®©æˆ‘ä»¬çŸ¥é“ä½ çš„æƒ³æ³•