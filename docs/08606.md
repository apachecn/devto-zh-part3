# è¶Šå¿«è¶Šå¥½

> åŸæ–‡:[https://dev . to/tonymet/getting-to-yes-as-pleasant-1263](https://dev.to/tonymet/getting-to-yes-as-quickly-as-possible-1263)

ä¸€å¹´å‰[æœ‰ä¸€åœºå…³äº gnu ç‰ˆæœ¬çš„â€œæ˜¯â€æœ‰å¤šå¿«çš„å¤§è®¨è®º](https://www.reddit.com/r/unix/comments/6gxduc/how_is_gnu_yes_so_fast/)ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰çš„è¯ï¼Œ`yes`æ— é™è¾“å‡º`y`ã€‚

```
yes |head -5
y
y
y
y
y 
```

å…³é”®çš„ä¸€ç‚¹æ˜¯`write`å¾ˆæ˜‚è´µï¼Œè€Œå†™é¡µé¢å¯¹é½çš„ç¼“å†²åŒºè¦å¿«å¾—å¤šã€‚è·¨è¯­è¨€éƒ½æ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ go ä¸­æ­£ç¡®åœ°åšåˆ°è¿™ä¸€ç‚¹ã€‚

å¦‚æœä½ å¯¹ç»“æœæ„Ÿåˆ°éœ‡æƒŠæˆ–å°è±¡æ·±åˆ»ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä½ æ˜¯å¦‚ä½•ç”¨è‡ªå·±çš„è¯­è¨€åšåˆ°è¿™ä¸€ç‚¹çš„â€”â€”åœ¨è¯„è®ºä¸­å‘å¸ƒä½ çš„ç»“æœã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å»å¹´æ–‡ç« ä¸­çš„åŸºå‡† C ä»£ç ã€‚

```
/* yes.c - iteration 4 */
#define LEN 2
#define TOTAL 4096 * 4
int main() {
    char yes[LEN] = {'y', '\n'};
    char *buf = malloc(TOTAL);
    int bufused = 0;
    while (bufused < TOTAL) {
        memcpy(buf+bufused, yes, LEN);
        bufused += LEN;
    }
    while(write(1, buf, TOTAL));
    return 1;
} 
```

ç°åœ¨æ˜¯ååé‡åŸºå‡†

```
$ gcc yes.c -o yes_c
$ ./yes_c |pv >/dev/null
...[3.21GiB/s] ... 
```

æ‰€ä»¥æˆ‘ä»¬çš„åŸºå‡†é€Ÿç‡= **3.21 GB/s**

## [](#go-round-1-captain-obvious)å›åˆ 1 -é˜Ÿé•¿æ˜æ˜¾

å‡è®¾:è¿™å°†æ˜¯ç¼“æ…¢çš„ã€‚æˆ‘çŒœæ¯”åŸºå‡†æµ‹è¯•å¿« 20%ã€‚

```
package main

import (
    "fmt"
    "os"
)

func main() {
    for {
        fmt.Fprintln(os.Stdout, "y")
    }
} 
```

```
$ go run yes.go |pv > /dev/null 
$ ...[1.07MiB/s] ... 
```

å‘€ï¼1.07 MB/sï¼Œä»…ä¸ºæˆ‘ä»¬åŸºå‡†æµ‹è¯•çš„ **0.03%** ã€‚ğŸ’©å‡è®¾æˆç«‹ï¼

## [](#go-round-2-pagealigned-buffers)å¾ªç¯ 2 é¡µå¯¹é½çš„ç¼“å†²åŒº

æ³¨æ„åœ¨ Darwin Pagesize X 4 ä¸Šäº§ç”Ÿäº†æœ€å¥½çš„ç»“æœâ€”â€”æˆ‘ä¼šè®©è¯»è€…å»çŒœæµ‹ä¸ºä»€ä¹ˆã€‚

```
package main

import (
    "os"
)

func main() {
    buf := make([]byte, os.Getpagesize()*4)
    for i := 0; i < len(buf); i += 2 {
        buf[i], buf[i+1] = 'y', '\n'
    }
    for {
        os.Stdout.Write(buf)
    }
} 
```

ç»“æœ:

```
$ go run yes.go |pv > /dev/null 
$ ...[3.15GiB/s] ... 
```

ç»“æœ:3.15 GB/s æˆ–åŸºå‡†æµ‹è¯•çš„ 98.13%ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªèµ¢å®¶ğŸ

â¡ï¸:ç”¨ä½ æœ€å–œæ¬¢çš„è¯­è¨€ï¼Œä½ å¤šå¿«èƒ½è¯´â€œæ˜¯â€ï¼Ÿ