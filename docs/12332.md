# ç”Ÿäº§ä¸“ç”¨ PHP+Apache dock æ˜ åƒ

> åŸæ–‡:# t0]https://dev . to/silarri/un-image docker-PHP-Apache-å®šåˆ¶-ç”Ÿäº§-15e 2

åˆ›å»ºä¸æ‚¨ç›¸ä¼¼çš„ PHP+Apache docker å›¾åƒã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ˜¯æ­¤åšå®¢çš„è¯»è€…ï¼Œå¹¶ä¸”è®¢é˜…äº†æ–°æ–‡ç« ï¼Œå®ƒå°†éå¸¸å®Œç¾ğŸ’–ã€‚

## [](#cest-quoi-une-image-docker-parfaite-)ä»€ä¹ˆæ˜¯å®Œç¾çš„å¯¹æ¥å›¾åƒï¼Ÿ

è¿™é¦–å…ˆæ˜¯æ ¹æ®**ä½ çš„éœ€è¦å’Œç»éªŒ**å»ºç«‹èµ·æ¥çš„å½¢è±¡ã€‚æ‚¨å·²ç¡®å®šäº†åœ¨æ‚¨çš„å¼€å‘è¿‡ç¨‹ä¸­ä¸æ–­é‡å¤çš„å¸¸è§é…ç½®æ¨¡å¼**ã€‚ä½œä¸ºä¸€ä¸ªå¥½äººï¼Œæ‚¨å¸Œæœ›å°†è¿™äº›åº”ç”¨ç¨‹åºæ”¾åœ¨ä¸€ä¸ªé€šç”¨å±‚ä¸­ï¼Œä»¥ä¾¿äºç»´æŠ¤ã€‚**

æ ¹æ®æˆ‘è‡ªå·±çš„ç»éªŒå’Œæˆ‘å¤§éƒ¨åˆ†æ—¶é—´å¼€å‘çš„åº”ç”¨ç¨‹åºç±»å‹ï¼Œæˆ‘è®¤ä¸º Apache PHP æ˜ åƒæ˜¯å®Œç¾çš„:

*   [Composer](https://getcomposer.org/) å®‰è£…**é»˜è®¤**(ç°åœ¨ä¸ä½¿ç”¨ä¾èµ–ç®¡ç†å™¨ï¼Ÿé¡µ:1ã€‚
*   PHP å’Œ Apache é…ç½®ä¸ºâ€œT0â€ç”Ÿäº§ã€‚
*   é»˜è®¤æƒ…å†µä¸‹å¯ç”¨çš„å¾ªç¯ PHP æ¨¡å—ã€‚
*   æ¯” Apache çš„é»˜è®¤é”™è¯¯é¡µé¢å®‰é™ä¸€ç‚¹ã€‚
*   æœ€é€‚åˆä¸ Symfony ä¸€èµ·è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚

## [](#cr%C3%A9er-son-image-parfaite)åˆ›é€ ä»–å®Œç¾çš„å½¢è±¡

é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä» php çš„å®˜æ–¹å½¢è±¡å¼€å§‹ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³èŠ‚çœæ—¶é—´ï¼Œè€Œä¸æ˜¯é‡æ–°å‘æ˜è½®å­ã€‚ä½ çŸ¥é“å—ï¼Ÿè¯¥æ˜ åƒç”šè‡³éšé™„äº†ä¸€ä¸ªé›†æˆçš„ Apache æœåŠ¡å™¨ã€‚**é¡¶ã€‚**

ğŸ¤“*ä¸ºä»€ä¹ˆä½¿ç”¨ Apache è€Œä¸æ˜¯ nginxï¼Ÿ*

å› ä¸ºè¿™ç¯‡æ–‡ç« ä¸æ˜¯ä¸­ç«‹çš„ï¼Œå¿…é¡»ä½œå‡ºå†³å®šã€‚å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘å‘ç°ä¸¤è€…ä¹‹é—´çš„æ€§èƒ½å·®å¼‚å¾®ä¸è¶³é“ï¼Œå¯¹äºå¤§å¤šæ•°é¡¹ç›®æ¥è¯´ï¼ŒApache æ˜¯ç†æƒ³çš„é€‰æ‹©ã€‚å¯¹äº PHP Docker å›¢é˜Ÿå°†ç›´æ¥æ‰§è¡Œçš„å®‰å…¨æ›´æ–°æ¥è¯´ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æ›´å®‰é™çš„æ–¹å¼ã€‚ä½†æ˜¯ï¼Œæˆ‘æœ‰æ—¶ä¼šä½¿ç”¨ nginx æ¥æ‰§è¡Œä¸€äº›æ›´å¤§çš„é¡¹ç›®ã€‚å†ä¸€æ¬¡ï¼Œè¿™çœŸçš„ä»ç„¶æ˜¯**éœ€è¦ã€ç»éªŒå’Œå“å‘³çš„é—®é¢˜**ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»ä»¥ä¸‹è¡Œå¼€å§‹æˆ‘ä»¬çš„ç å¤´é£æ ¼:

```
# Dockerfile
FROM php:7.4-apache 
```

æˆ‘ä»¬æ„å»ºå¹¶è¿è¡Œæ‰€æœ‰è¿™äº›ä»¥ç¡®ä¿ä¸€åˆ‡é¡ºåˆ©:

```
docker build -t super/hero .
docker run -it -p 8080:80 super/hero 
```

è®¿é—® [http://127.0.0.1:8080](http://127.0.0.1:8080) æ—¶ï¼Œä¸€å®šè¦ç¿»åˆ°ç¾ä¸½çš„ 403 é¡µã€‚è¿™æ„å‘³ç€ä¸€åˆ‡éƒ½å¾ˆé¡ºåˆ©ï¼Œè¿˜æ²¡æœ‰ä½ çš„æ¶ˆæ¯æ¥æºï¼Œæ‰€ä»¥ Apache å¾ˆå¥½åœ°å›ç­”ä½ ï¼

### [](#composer-par-d%C3%A9faut)é»˜è®¤åˆæˆå™¨

å†ç®€å•ä¸è¿‡äº†ï¼Œæˆ‘ä»¬ä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ composerï¼Œå¹¶ä½¿è¯¥å‘½ä»¤åœ¨å®¹å™¨ä¸­çš„ä»»ä½•ä½ç½®éƒ½å¯ä»¥è®¿é—®ã€‚

```
# Dockerfile
ENV COMPOSER_ALLOW_SUPERUSER=1
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
RUN composer --version 
```

### [](#configuration-dapache)é…ç½®é˜¿å¸•å¥‡

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­£å¼æ˜ åƒé…ç½®ä¸ºåœ¨/var/www/html ä¸­å…·æœ‰ Web æœåŠ¡å™¨æ ¹ç›®å½•ã€‚**å¤ªé•¿äº†ï¼**æˆ‘ä»¬å°†å¿½ç•¥è¿™ä¸€åˆ‡ï¼Œå°†æˆ‘ä»¬æœªæ¥çš„æºä»£ç ç›´æ¥å­˜æ”¾åœ¨å®¹å™¨æ ¹ç›®å½•çš„ **/app** æ–‡ä»¶å¤¹ä¸­ã€‚

```
# conf/vhost.conf
<VirtualHost *:80>
    ServerAdmin contact@monsupersite.fr

    DocumentRoot /app

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost> 
```

```
# conf/apache.conf
<Directory /app/>
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

ServerTokens Prod
ServerSignature Off 
```

```
# Dockerfile
# ...
ADD conf/vhost.conf /etc/apache2/sites-available/000-default.conf
ADD conf/apache.conf /etc/apache2/conf-available/z-app.conf
RUN a2enconf z-app 
```

æ­¤å¤„æ›´æ”¹äº† Apache çš„åŸºæœ¬ vhost é…ç½®(000-default.conf)ï¼Œè¯¥é…ç½®ç°åœ¨æä¾›/app æ–‡ä»¶å¤¹çš„å†…å®¹ã€‚æ‚¨ä¹Ÿå¯ä»¥å°†/app èµ„æ–™å¤¹è®¾å®šä¸ºä¸å…è®¸ Apache åˆ—å‡ºç›®å½•ä¸­å«æœ‰`Options -Indexes`çš„æ¡£æ¡ˆã€‚

å°±æˆ‘è€Œè¨€ï¼Œæˆ‘ä¸å–œæ¬¢ç”¨ä¸€ä¸ªæ¥è®¾ç½®æˆ‘çš„ç½‘ç«™ htaccess(å‡ºäºæ€§èƒ½åŸå› )ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘æ”¾äº†æŒ‡ä»¤`AllowOverride None`ã€‚å› ä¸ºå½±åƒæ˜¯ç”¨äºæš‚å­˜/ç”Ÿäº§ï¼Œæ‰€ä»¥ä¹Ÿåˆ é™¤äº†ä¸æ–¹é’ˆ`ServerTokens Prod`å’Œ`ServerSignature Off`ä¸€èµ·ä½¿ç”¨çš„åŸºç¡€è®¾æ–½çš„ç›¸å…³ä¿¡æ¯ã€‚

æˆ‘å·²è‡ªæ„¿å°†é…ç½®å‘½åä¸ºâ€œ`z-app`â€ï¼Œä»¥ç¡®ä¿å®ƒæœ€ååŠ è½½ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–æ¨¡å—ä¼šå¯¼è‡´æŒ‡ä»¤è¿‡è½½ã€‚

### [](#configuration-de-php)é…ç½® de PHP

æˆ‘ä»¬å°†æ ¹æ®æœªæ¥å›¾åƒçš„é‡å¤éœ€è¦é…ç½® PHPã€‚è¯·ä¸è¦åœ¨æ­¤å¤„è¾“å…¥å¤ªå¤§çš„å€¼ï¼Œå¦‚æœæ‚¨çš„ç‰¹å®šå®¹å™¨éœ€è¦æ›´å¿«çš„é…ç½®ï¼Œåˆ™å¯ä»¥åœ¨æ­¤åº”ç”¨ç¨‹åºç‰¹æœ‰çš„ dockerfile ä¸­å¤ç›–æ­¤åŸºæœ¬é…ç½®ã€‚

```
; conf/php.ini
date.timezone = Europe/Paris

opcache.enable = 1
opcache.enable_cli = 1
opcache.memory_consumption = 128
opcache.revalidate_freq = 0
apc.enable_cli = On

upload_max_filesize = 16M
post_max_size = 16M

realpath_cache_size = 4096k
realpath_cache_ttl = 7200

display_errors = Off
display_startup_errors = Off 
```

```
# Dockerfile
# ...
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libicu-dev
RUN docker-php-ext-install -j$(nproc) opcache pdo_mysql
ADD conf/php.ini /usr/local/etc/php/conf.d/app.ini 
```

æ ¹æ®éœ€è¦è‡ªå®šä¹‰é»˜è®¤æ¨¡å—ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæˆ‘çš„å‡ ä¹æ‰€æœ‰é¡¹ç›®éƒ½ä½¿ç”¨ PDO å’Œ MySQLã€‚ç¼ºçœæƒ…å†µä¸‹ï¼ŒOPCache ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

### [](#des-jolies-pages-derreur-par-d%C3%A9faut)æ¼‚äº®çš„ç¼ºçœé”™è¯¯é¡µ

è°ä»æ¥æ²¡è§è¿‡ Apache çš„ 404 é¡µé¢ï¼Ÿå°±æ˜¯å¤±å»â€˜t0â€™[ã€å¿è€…å¥‰çŒ®å¤§æ•°æ®äº²å©´å„¿è„šã€‘](https://www.mathieupassenaud.fr/un-developpeur-nest-pas-un-joueur/) ç­‰ä¿¡èª‰çš„ä¿è¯ï¼Œä½ ç«™åœ¨é¡¾å®¢é¢å‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹ç°æœ‰çš„ confï¼Œå¢åŠ é”™è¯¯é¡µé¢å¤„ç†:

```
# conf/apache.conf
# ...
<Directory /errors/>
    Options -Indexes
    AllowOverride None
    Require all granted
</Directory>

Alias /_errors/ /errors/
ErrorDocument 404 /_errors/404.html
ErrorDocument 403 /_errors/403.html
ErrorDocument 500 /_errors/500.html 
```

```
# Dockerfile
# ...
ADD errors /errors 
```

ä¸ºäº†é¿å…ä¸å°†æ¥çš„åº”ç”¨ç¨‹åºå†²çªï¼Œæˆ‘å°†é”™è¯¯é¡µçš„å†…å®¹æ”¾åœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹(/errors ä½äºå®¹å™¨çš„æ ¹ç›®å½•)ä¸­ï¼Œå¹¶ä½¿ç”¨/_errors è·¯å¾„éš”ç¦»ç‰¹å®šäºé”™è¯¯é¡µçš„ HTTP è¯·æ±‚ã€‚

## [](#%C3%A7a-donne-quoi-au-final-)åˆ°åº•æ˜¯ä»€ä¹ˆç»“æœï¼Ÿ

Dockerfile å·²ç»è¿‡ä¼˜åŒ–ï¼Œå¯ä»¥å‡å°å±‚çš„å¤§å°ã€‚

```
# Dockerfile
FROM php:7.2-apache

ENV COMPOSER_ALLOW_SUPERUSER=1

EXPOSE 80
WORKDIR /app

RUN apt-get update -qy && \
    apt-get install -y \
    git \
    libicu-dev \
    unzip \
    zip && \
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# PHP Extensions
RUN docker-php-ext-install -j$(nproc) opcache pdo_mysql
ADD conf/php.ini /usr/local/etc/php/conf.d/app.ini

# Apache
ADD errors /errors
RUN a2enmod rewrite remoteip
ADD conf/vhost.conf /etc/apache2/sites-available/000-default.conf
ADD conf/apache.conf /etc/apache2/conf-available/z-app.conf
RUN a2enconf z-app
ADD index.php /app/index.php 
```

```
# conf/apache.conf
<Directory /app/>
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted

    SetEnvIf X_FORWARDED_PROTO https HTTPS=on
</Directory>

ServerTokens Prod
ServerSignature Off

<Directory /errors/>
    Options -Indexes
    AllowOverride None
    Require all granted
</Directory>

Alias /_errors/ /errors/
ErrorDocument 404 /_errors/404.html
ErrorDocument 403 /_errors/403.html
ErrorDocument 500 /_errors/500.html 
```

```
# conf/vhost.conf
<VirtualHost *:80>
    ServerAdmin guillaume@silarhi.fr

    DocumentRoot /app

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost> 
```

```
; conf/php.ini
date.timezone = Europe/Paris

opcache.enable = 1
opcache.enable_cli = 1
opcache.memory_consumption = 128
opcache.revalidate_freq = 0
apc.enable_cli = On

upload_max_filesize = 16M
post_max_size = 16M

realpath_cache_size=4096k
realpath_cache_ttl=7200

display_errors = Off
display_startup_errors = Off 
```

å¥½å¥‡å—ï¼Ÿæˆ‘åªä¸ºä½ å‡†å¤‡äº†ï¼š

*   [ä»¥è¶…è²å¾‹å®¾è¯­ä¸ºæ—©ä¸Šå¥½](https://labs.silarhi.fr/php)çš„å›¾åƒå¯¹æ¥æ¼”ç¤º
*   [ä»¥ Symfony](https://labs.silarhi.fr) ( [åŠå…¶ç›¸å…³åšå®¢æ–‡ç« ](https://blog.silarhi.fr/deploiement-continu-symfony-docker-circleci/)ä¸ºåŸºç¡€çš„æ›´åŠ å…·ä½“çš„æ¼”ç¤º
*   [404 é¡µçš„ä¸€ä¸ªä¾‹å­](https://labs.silarhi.fr/php/liencass%C3%A9)
*   [ç”¨ Traefik](https://github.com/silarhi/labs.silarhi.fr/tree/master/php) å¤„ç†è¿™ä¸€åˆ‡çš„æºä»£ç 

## [](#pour-aller-plus-loin)è¦æ›´è¿›ä¸€æ­¥

*   [github](https://github.com/silarhi/docker-php)æ–‡ç« ä¸­ä½¿ç”¨çš„å…¨éƒ¨æºä»£ç 
*   [ä½¿ç”¨ Traefik](https://blog.silarhi.fr/docker-compose-traefik-https/) åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šè®¾ç½®åç«™æ˜ åƒ
*   [åç«™æ¢çº½ä¸­çš„å›¾åƒ](https://hub.docker.com/r/silarhi/php-apache)