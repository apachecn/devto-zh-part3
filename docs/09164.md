# ä¸è¦è®©è¿™ä¸ªå¼‚æ­¥/ç­‰å¾… Oopsieï¼

> åŸæ–‡:[https://dev . to/me bble/don-make-this-async away-error-1 AEO](https://dev.to/mebble/dont-make-this-asyncawait-mistake-1eao)

å‡è®¾æˆ‘ä»¬éœ€è¦å¯¹æ•°ç»„çš„é¡¹ç›®æ‰§è¡Œä¸€äº› I/O æ“ä½œï¼Œæ¯”å¦‚ä½¿ç”¨ä¸€äº› API ä»çŒ«çš„ id ä¸­è·å–çŒ«çš„ä¸»äººã€‚

```
const catIDs = [132, 345, 243, 121, 423]; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‡è®¾æˆ‘ä»¬å†³å®šä½¿ç”¨æ–°è·å¾—çš„ async/await æŠ€èƒ½æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚Async/await æ¶ˆé™¤äº†å¯¹å›è°ƒçš„éœ€è¦(åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹)ï¼Œä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥ç±»ä¼¼äºåŒæ­¥ä»£ç ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¿˜è®°äº†æˆ‘ä»¬ä»ç„¶åªæ˜¯åœ¨å¤„ç†å¼‚æ­¥ä»£ç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçŠ¯ä¸€ä¸ªé”™è¯¯ï¼Œä½¿æ‹¥æœ‰å¹¶å‘æ€§çš„æ•´ä¸ªç›®çš„è½ç©ºã€‚

æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åšè¿™æ ·çš„äº‹æƒ…:

```
async function fetchOwners(catIDs) {
    const owners = [];
    for (const id of catIDs) {
        const cat = await fetchCat(id);
        const owner = await fetchOwner(cat.ownerID);
        owners.push(owner);
    }
    return owners;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## æˆ‘ä»¬çš„ Oopsie æ˜¯ä»€ä¹ˆï¼ŸğŸ¤·â€â™‚ï¸

å…è´£å£°æ˜:å¦‚æœä½ çŸ¥é“ oopsie æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆä½ å¯èƒ½å·²ç»çŸ¥é“ä½ åœ¨åšä»€ä¹ˆã€‚ä½ å¯èƒ½çŸ¥é“è¿™ç§è¡Œä¸ºçš„ä¸€ä¸ªç”¨ä¾‹ï¼Œæ‰€ä»¥æˆ‘æƒ³ç§°å®ƒä¸ºâ€œoopsieâ€æœ‰ç‚¹ä¸å…¬å¹³ã€‚è¿™ç¯‡æ–‡ç« åªæ˜¯è®©äººä»¬ç†Ÿæ‚‰è¿™ç§å¼‚æ­¥/ç­‰å¾…è¡Œä¸ºã€‚

æˆ‘ä»¬è¿è¡Œä»£ç ï¼Œçœ‹èµ·æ¥ä¸€åˆ‡æ­£å¸¸ã€‚ä½†æ˜¯åœ¨æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ async/await æ–¹é¢æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜ã€‚é—®é¢˜æ˜¯æˆ‘ä»¬åœ¨ for å¾ªç¯ä¸­ä½¿ç”¨äº†`await`ã€‚è¿™ä¸ªé—®é¢˜å®é™…ä¸Šè¡¨æ˜äº†ä¸€ç§å¸¸è§çš„[ä»£ç å‘³é“](https://en.m.wikipedia.org/wiki/Code_smell)ï¼Œå³åœ¨æ‰§è¡Œæ•°ç»„è½¬æ¢çš„ for-loop" æ–¹æ³•ä¸­ *" `.push`"åˆ°è¾“å‡ºæ•°ç»„ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ [`.map`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map) (æˆ‘ä»¬å°†åœ¨åé¢è®¨è®º)ã€‚*

ç”±äº for å¾ªç¯ä¸­çš„`await`ï¼Œçœ‹èµ·æ¥åŒæ­¥çš„`fetchOwners`å‡½æ•°æ­£åœ¨é¡ºåºåœ°(æŸç§ç¨‹åº¦ä¸Š)è€Œä¸æ˜¯å¹¶è¡Œåœ°æ‰§è¡Œå¯¹ cat çš„æå–ã€‚åœ¨è¿›å…¥ä¸‹ä¸€ä¸ª for å¾ªç¯è¿­ä»£ä»¥è·å–ä¸‹ä¸€åªçŒ«çš„ä¸»äººä¹‹å‰ï¼Œä»£ç `await`ä»£è¡¨ä¸€åªçŒ«çš„ä¸»äººã€‚æŠ“ä½ä¸€åªçŒ«çš„ä¸»äººå¹¶ä¸ä¾èµ–äºå…¶ä»–ä»»ä½•ä¸€åªçŒ«ï¼Œä½†æˆ‘ä»¬è¡¨ç°å¾—å¥½åƒæ˜¯è¿™æ ·ã€‚æ‰€ä»¥æˆ‘ä»¬å®Œå…¨é”™è¿‡äº†å¹¶è¡Œè·å–æ‰€æœ‰è€…çš„èƒ½åŠ›(oopsieï¼ğŸ¤·â€â™‚ï¸).

***æ³¨:**æˆ‘æåˆ°äº†â€œç§â€é¡ºåºï¼Œå› ä¸ºé‚£äº›é¡ºåºçš„ for-loop è¿­ä»£ä¸å…¶ä»–è¿‡ç¨‹äº¤é”™(é€šè¿‡[äº‹ä»¶å¾ªç¯](https://youtu.be/8aGhZQkoFbQ))ï¼Œå› ä¸º for-loop è¿­ä»£`await`åœ¨ä¸€ä¸ª`async`å‡½æ•°å†…ã€‚*

## [](#what-we-should-be-doing)æˆ‘ä»¬åº”è¯¥åšä»€ä¹ˆğŸ˜

æˆ‘ä»¬ä¸åº”è¯¥åœ¨ for å¾ªç¯ä¸­ã€‚äº‹å®ä¸Šï¼Œå³ä½¿ä»£ç æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœæ²¡æœ‰ for å¾ªç¯ï¼Œè¿™ä¸ªé—®é¢˜ä¼šè§£å†³å¾—æ›´å¥½ã€‚ä¸€ä¸ª`.map`æ˜¯åˆé€‚çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å¤„ç†çš„é—®é¢˜æ˜¯ä¸€ä¸ªæ•°ç»„è½¬æ¢ï¼Œä»ä¸€ä¸ªçŒ« id æ•°ç»„åˆ°ä¸€ä¸ªæ‰€æœ‰è€…æ•°ç»„ã€‚

å¦‚æœä»£ç æ˜¯åŒæ­¥çš„ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨`.map`çš„æ–¹æ³•ã€‚

```
// catIDs -> owners
const owners = catIDs.map(id => {
    const cat = fetchCatSync(id);
    const owner = fetchOwnerSync(cat.ownerID);
    return owner;
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”±äºä»£ç å®é™…ä¸Šæ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å°†ä¸€ä¸ªçŒ« id æ•°ç»„è½¬æ¢ä¸ºä¸€ä¸ªæ‰¿è¯ºæ•°ç»„(å¯¹çŒ«çš„ä¸»äººçš„æ‰¿è¯º)ï¼Œç„¶åä½¿ç”¨`await`å°†æ‰¿è¯ºæ•°ç»„è§£åŒ…ä»¥è·å¾—ä¸»äººã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™æ®µä»£ç ä¸å¤„ç†è¢«æ‹’ç»çš„æ‰¿è¯ºã€‚

```
// catIDs -> ownerPromises -> owners
async function fetchOwners(catIDs) {
    const ownerPromises = catIDs.map(id => {
        return fetchCat(id)
            .then(cat => fetchOwner(cat.ownerID));
    });
    const owners = await Promise.all(ownerPromises);
    return owners;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†è¿›ä¸€æ­¥çµæ´»æˆ‘ä»¬çš„ async/await æŠ€èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ª`async`å›è°ƒä¼ é€’ç»™ map æ–¹æ³•ï¼Œå¹¶å°†è¯¥å›è°ƒä¸­çš„æ‰€æœ‰ä¸­é—´å“åº”(è¿™é‡Œï¼Œè·å–ä¸€åªçŒ«ä»¥è·å¾—å®ƒçš„ä¸»äººçš„ ID)ä¼ é€’ç»™`await`ã€‚è®°ä½ï¼Œ`async`å‡½æ•°è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ç„¶æœ‰ä¸€ä¸ªæ‰¿è¯ºæ•°ç»„ä½œä¸º`.map`çš„è¾“å‡ºã€‚è¿™æ®µä»£ç ç›¸å½“äºå‰ä¸€æ®µï¼Œä½†æ˜¯æ²¡æœ‰ä¸‘é™‹çš„`.then`ã€‚

```
async function fetchOwners(catIDs) {
    const ownerPromises = catIDs.map(async id => {
        const cat = await fetchCat(id);
        const owner = await fetchOwner(cat.ownerID);
        return owner;
    });
    const owners = await Promise.all(ownerPromises);
    return owners;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## `.map`åˆ°åº•åœ¨åšä»€ä¹ˆï¼Ÿ

`.map`åœ¨æ¯ä¸ª cat ID ä¸Šä¾æ¬¡è°ƒç”¨å›è°ƒ(åœ¨å›è°ƒä¸­æˆ‘ä»¬å‘å‡ºä¸€ä¸ª I/O è¯·æ±‚)ã€‚ä½†æ˜¯ç”±äºå›è°ƒè¿”å›ä¸€ä¸ªæ‰¿è¯º(æˆ–è€…æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°)ï¼Œæ‰€ä»¥`.map`ä¸ä¼šç­‰å¾…ä¸€åªçŒ«çš„å“åº”åˆ°è¾¾ï¼Œå°±å‘å‡ºä¸‹ä¸€åªçŒ«çš„è¯·æ±‚ã€‚

> è¯·æ±‚æ˜¯æŒ‰é¡ºåºå‘å‡ºçš„ï¼Œä½†æ˜¯ä»¥å¹³è¡Œçš„æ–¹å¼è¡Œè¿›ï¼Œå®ƒä»¬çš„å“åº”æ˜¯æ— åºçš„(æƒ³è±¡ä¸€ä¸‹ç”¨ä¸€åªæ‰‹åœ¨èƒŒåæ‰”ä¸€å †é£å»æ¥å™¨)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åƒé¢„æœŸçš„é‚£æ ·å¹¶è¡Œè·å–çŒ«ä¸»äººğŸ™Œï¼å™¢ï¼Œæ¾å¼€äº†ï¼

* * *

è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚ä¸ä»…ä»…æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡å…³äº DEV çš„æ–‡ç« ï¼Œä¹Ÿæ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡åšæ–‡ã€‚å¸Œæœ›ä½ å–œæ¬¢ã€‚