# å°† Omniauth GitHub æ·»åŠ åˆ° Devise ä¹‹ä¸Šçš„ Rails åº”ç”¨ç¨‹åºä¸­

> åŸæ–‡:[https://dev . to/mercier _ remi/add-omni auth-github-to-your-rails-app-on-top-of-device-5n 7](https://dev.to/mercier_remi/add-omniauth-github-to-your-rails-app-on-top-of-devise-5n7)

å»å¹´ 6 æœˆï¼Œå½“æˆ‘å·²ç»è¿›å…¥æœ€åä¸‰å‘¨çš„ [@lewagon çš„ ruby bootcamp](http://lewagon.com/) æ—¶ï¼Œæˆ‘å’Œæˆ‘çš„é˜Ÿå‹ä»¬åœ¨è¿›å…¥æˆ‘ä»¬çš„æœ€ç»ˆé¡¹ç›®ä¹‹å‰æ­£åœ¨å¼€å‘å¸‚åœºåº”ç”¨ç¨‹åºã€‚

æˆæƒäººä»¬æ³¨å†Œ GitHub çš„éœ€æ±‚å¾ˆå¿«å‡ºç°ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå¾ªåºæ¸è¿›çš„æ•™ç¨‹ï¼Œä»‹ç»æˆ‘åœ¨ä½¿ç”¨ Devise å¤„ç†è®¤è¯æ—¶æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚

å¸Œæœ›ä½ ä¼šå–œæ¬¢å®ƒï¼Œå¹¶å‘ç°è¿™å¾ˆæœ‰å¸®åŠ©ã€‚ğŸ™

## [](#basic-set-up)åŸºæœ¬è®¾ç½®å®Œæ¯•

åœ¨ä½¿ç”¨ä½ çš„åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œä½ éœ€è¦è®¾ç½®ä¸€äº›ä¸œè¥¿ã€‚

### [](#create-a-application-on-git-hub)åœ¨ Git Hub ä¸Šåˆ›å»ºåº”ç”¨

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ª OAuth åº”ç”¨ç¨‹åºã€‚è½¬åˆ°æ‚¨çš„ä¸ªäººèµ„æ–™ï¼Œç„¶åç‚¹å‡»`developper settings`å¹¶ç‚¹å‡»`New OAuth App`ã€‚

ç»™ä½ çš„åº”ç”¨ä¸€ä¸ªåå­—ï¼Œä¸€ä¸ª URL å’Œä¸€ä¸ªå›è°ƒ URLã€‚å¦‚æœæ‚¨æƒ³ä½¿ç”¨ localhost å‘¢ï¼Ÿå¾ˆé«˜å…´ä½ é—®äº†ã€‚

å¯¹äºæ‚¨çš„æ•¬æ„ç½‘å€:`http://http://localhost:your_port`å°†å®Œç¾åœ°å·¥ä½œ

å¯¹äºå›è°ƒ URLï¼Œä¸èƒ½ä½¿ç”¨`http://http://localhost:your_port`ï¼Œå› ä¸º GitHub éœ€è¦ä½ æŒ‡å®šä¸€ä¸ªå¯ä»¥å…¬å¼€è®¿é—®çš„åœ°å€ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ

### n æ‹¯æ•‘ä¸–ç•Œ

ngrok é€šè¿‡å…¬å…± URL å…¬å¼€æ‚¨çš„æœ¬åœ° web æœåŠ¡å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£… ngrok å¹¶è®©å®ƒç›‘å¬æˆ‘ä»¬çš„æœ¬åœ°æœåŠ¡å™¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå…¬å…±ç½‘å€ï¼Œå¹¶æŠŠå®ƒç»™ GitHubã€‚

é¦–å…ˆï¼Œåœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œ:

```
brew install ngrok 
```

ç„¶åè¿è¡Œ:

```
ngrok http your_port 
```

ä½ ä¼šå¾—åˆ°:

```
ngrok by @inconshreveable                                       (Ctrl+C to quit)

Session Status                online
Session Expires               7 hours, 59 minutes
Version                       2.2.8
Region                        United States (us)
Web Interface                 http://127.0.0.1:4040
Forwarding                    http://3aa8f0f7.ngrok.io -> localhost:3000
Forwarding                    https://3aa8f0f7.ngrok.io -> localhost:3000

Connections                   ttl     opn     rt1     rt5     p50     p90
                 0       0       0.00    0.00    0.00    0.00 
```

è¿™å°±æ˜¯ä½ çš„å›è°ƒ URL: `http://3aa8f0f7.ngrok.io -> localhost:3000`ã€‚

ä¸è¦å¿˜è®°åœ¨ä½ çš„å›æ‹¨ URL åé¢åŠ ä¸Š`/users/auth/github/callback`ã€‚

æ‚¨çš„å¼€å‘å›è°ƒ URL åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

`http://3aa8f0f7.ngrok.io/users/auth/github/callback`

ä¸€æ—¦è¿›å…¥ç”Ÿäº§é˜¶æ®µï¼Œæˆ‘ä»¬å°†éœ€è¦æ›´æ”¹è¿™ä¸¤ä¸ª URLã€‚âš ï¸æ³¨æ„åœ¨ä½ çš„åº”ç”¨ç¨‹åº URL å’Œå›æ‹¨ URL ä¸­ä½¿ç”¨ç›¸åŒçš„åè®®ã€‚åœ¨ä¸€ä¸ªä¸­ä½¿ç”¨`http`,åœ¨å¦ä¸€ä¸ªä¸­ä½¿ç”¨`https`,ä¼šå¯¼è‡´ URL ä¸åŒ¹é…ã€‚

### [](#save-your-api-keys-in-your-rails-app)åœ¨ä½ çš„ Rails åº”ç”¨ä¸­ä¿å­˜ä½ çš„ API å¯†é’¥

æˆ‘ä»¬ä¸å¸Œæœ›æˆ‘ä»¬çš„ API å¯†é’¥è¢«æ¨é€åˆ° GitHubã€‚æ‰€ä»¥æˆ‘å°†ä½¿ç”¨ [figaro gem](https://github.com/laserlemon/figaro) å°†è¿™äº›å­˜å‚¨åœ¨ä¸€ä¸ªå®‰å…¨æ–‡ä»¶ä¸­ã€‚(æ³¨æ„:æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚env æ–‡ä»¶)ã€‚

```
# Add figaro to your gem file@
gem 'figaro' 
```

```
# In your terminal
bundle install 
```

Figaro åˆ›å»ºäº†ä¸€ä¸ª *config/application.yml* æ¥æ”¾ç½®æ‰€æœ‰çš„ API é”®ï¼Œå¹¶å°†è¿™ä¸ªæ–‡ä»¶æ·»åŠ åˆ°. gitignore ä¸­ã€‚

å°†æ‚¨çš„å¯†é’¥å¤åˆ¶/ç²˜è´´åˆ°*config/application . yml*
ä¸­

```
development: GITHUB_ID: 8***********************b
  GITHUB_SECRET: 4***********************************************3 
```

ä¸è¦å¿˜è®°å‘Šè¯‰ devise ä½¿ç”¨*config/initializer/device . Rb*ä¸­çš„è¿™äº›é”®ã€‚

```
config.omniauth :github, ENV['GITHUB_ID'], ENV['GITHUB_SECRET'], scope: 'user,public_repo' 
```

## [](#configure-omniauth-githhub-with-devise)ç”¨ Devise é…ç½® Omniauth GithHub

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Devise æ¥å¤„ç†è®¤è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æƒ³åœ¨*config/initializer/omni auth . Rb*ä¸­å†™ configã€‚

æˆ‘ä»¬è¨€å½’æ­£ä¼ å§ï¼

ç¬¬ä¸€æ­¥æ˜¯å°† Omniauth gem å®‰è£…åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ã€‚è½¬åˆ°æ‚¨çš„`Gemfile` :

```
gem 'omniauth-github' 
```

ç„¶åè¿è¡Œ:

```
bundle install 
```

ä¸‹ä¸€æ­¥æ˜¯å°†`provider`å’Œ`uid`åˆ—æ·»åŠ åˆ°æˆ‘ä»¬çš„ç”¨æˆ·æ¨¡å‹ä¸­ã€‚è®°ä½æˆ‘ä»¬å·²ç»åœ¨æˆ‘ä»¬çš„*é…ç½®/initializer/device . Rb*ä¸­å£°æ˜äº†æä¾›è€…ã€‚

```
rails g migration AddOmniauthToUsers provider:string uid:string
rake db:migrate 
```

æˆ‘ä»¬è½¬åˆ°`user.rb`å¹¶è®©æˆ‘ä»¬çš„ç”¨æˆ·æ— æ‰€ä¸èƒ½ã€‚

```
devise :omniauthable, omniauth_providers: %i[github] 
```

æœ‰äº†`devise_for :users`ä¹‹åï¼ŒDevise å°†åˆ›å»ºä¸¤ä¸ª URL æ–¹æ³•:

*   `user_omniauth_authorize_path(provider)`
*   `user_omniauth_callback_path(provider)` _

### [](#add-it-to-your-view)å°†å…¶æ·»åŠ åˆ°æ‚¨çš„è§†å›¾ä¸­

ç²˜è´´ä¸‹é¢çš„ä»£ç å¾—åˆ°ä¸€ä¸ªç®€å•çš„é“¾æ¥æ¥æµ‹è¯•å®ƒ:

```
<%= link_to "Sign up with GitHub", user_github_omniauth_authorize_path %> 
```

âš ï¸ä¼ é€’ç»™`user_omniauth_authorize_path`æ–¹æ³•çš„ç¬¦å·åº”è¯¥ä¸ä¼ é€’ç»™ devise çš„é…ç½®å—çš„æä¾›è€…çš„ç¬¦å·ç›¸åŒ¹é…ã€‚

ç°åœ¨ï¼Œå½“ç‚¹å‡»`Sign up with GitHub`æ—¶ï¼Œäººä»¬å°†è¢«é‡å®šå‘åˆ° GitHub ä»¥ç»™å‡ºä»–ä»¬çš„å‡­è¯ã€‚ä½†å°±ç›®å‰è€Œè¨€ï¼Œå½“ GitHub å‘å›ç”¨æˆ·çš„æ•°æ®æ—¶ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿã€‚

### [](#add-the-callback-to-your-app)å°†å›æ‹¨æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ç¨‹åº

è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„`config/routes.rb`æ¥å‘Šè¯‰ Devise æˆ‘ä»¬å°†åœ¨å“ªä¸ªæ§åˆ¶å™¨ä¸­å®ç°æˆ‘ä»¬çš„å›è°ƒ:

```
devise_for :users, controllers: { omniauth_callbacks: 'users/omniauth_callbacks' } 
```

ç°åœ¨æˆ‘ä»¬åªæ·»åŠ æ–‡ä»¶`app/controllers/users/omniauth_callbacks_controller.rb` :

```
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
end 
```

å›è°ƒåº”è¯¥ä¸æˆ‘ä»¬åœ¨ Devise çš„é…ç½®å—ä¸­ä¼ é€’çš„æä¾›è€…åŒåã€‚

```
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
   def github
       @user = User.from_omniauth(request.env["omniauth.auth"])
       if @user.persisted?
         sign_in_and_redirect @user, event: :authentication #this will throw if @user is not activated
         set_flash_message(:notice, :success, kind: "GitHub") if is_navigational_format?
       else
         session["devise.github_data"] = request.env["omniauth.auth"]
         redirect_to new_user_registration_url
       end
     end

     def failure
       redirect_to root_path
     end
 end 
```

ç„¶åï¼Œä»æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬ç§»åŠ¨åˆ°æˆ‘ä»¬çš„ç”¨æˆ·æ¨¡å‹ã€‚ä¸‹é¢æ˜¯æ¥è‡ª Devise æ–‡æ¡£çš„ä»£ç :

```
def self.from_omniauth(auth)
   where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
     user.email = auth.info.email
     user.password = Devise.friendly_token[0,20]
     user.name = auth.info.name   # assuming the user model has a name
     user.image = auth.info.image # assuming the user model has an image
     # If you are using confirmable and the provider(s) you use validate emails,
     # uncomment the line below to skip the confirmation emails.
     # user.skip_confirmation!
   end
 end 
```

åœ¨ä¿®æ”¹äº†ä¸Šé¢çš„ä»£ç ä»¥é€‚åº”æˆ‘çš„ä¸»è¦éœ€æ±‚ä¹‹åï¼Œæˆ‘é‡åˆ°äº†å‡ ä¸ªé—®é¢˜:

*   æˆ‘ä½¿ç”¨ Carrierwave åœ¨ Cloudinary ä¸Šä¸Šä¼ å›¾ç‰‡ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ç»™è¿™ä¸ªæ–¹æ³•æ·»åŠ é€‚å½“çš„é€»è¾‘ã€‚
*   å¦‚æœä¸€ä¸ªç”¨æˆ·å·²ç»å­˜åœ¨äºæˆ‘çš„æ•°æ®åº“ä¸­ï¼Œå¹¶è¯•å›¾ç”¨ GitHub ç™»å½•ï¼Œä»–ä¼šè¢«é‡å®šå‘åˆ°ç™»å½•è€Œä¸ç™»å½•ã€‚

å› æ­¤ï¼Œè¿™é‡Œæ˜¯æˆ‘è‡ªå·±çš„åŸºäºæˆ‘çš„æ¨¡å¼å’Œéœ€æ±‚çš„ç±»æ–¹æ³•ç‰ˆæœ¬:

```
def self.from_omniauth(auth)
     user = User.find_by(email: auth.info.email)
     if user
       user.provider = auth.provider
       user.uid = auth.uid
       user.save
     else
       user = User.where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
         user.email = auth.info.email
         user.password = Devise.friendly_token[0,20]
         user.first_name = auth.info.name.split(' ').first
         user.last_name = auth.info.name.split(' ').second
       end
     end
     unless user.avatar.present?
       photo_url = auth.info.image
       user.remote_avatar_url = photo_url # Carrierwave helper
       user.save
     end
     user
   end 
```

å¯¼è‡´ç¬¬äºŒä¸ªé—®é¢˜çš„åŸå› æ˜¯æ¨¡å‹æœ‰ä¸¤ä¸ªç›¸äº’å†²çªçš„éªŒè¯ç­–ç•¥:

*   è®¾è®¡
*   å’Œ Rails åŸç”Ÿçš„`validates`æ–¹æ³•ã€‚

æˆ‘çš„ç”¨æˆ·æ¨¡å‹æœ‰ä¸€ä¸ª`validates :password, presence: true`ï¼Œå®ƒå¼•å‘äº†ä¸€ä¸ªé”™è¯¯å¹¶é˜»æ­¢ç”¨æˆ·ç™»å½•ã€‚è¿™ä¸€è¡Œæ— ç”¨çš„ä»£ç æ˜¯ç”±æˆ‘ä»¬å›¢é˜Ÿå†…éƒ¨ç¼ºä¹æ²Ÿé€šé€ æˆçš„ã€‚å½¼æ­¤å¤šäº¤æµå¯ä»¥è®©æˆ‘ä»¬çœå»å¾ˆå¤šè°ƒè¯•â˜ï¸.çš„éº»çƒ¦

## [](#push-into-production)æ¨å…¥ç”Ÿäº§

åœ¨æµ‹è¯•å¹¶åˆå¹¶äº†æˆ‘åœ¨ GitHub ä¸Šçš„åˆ†æ”¯åï¼Œæˆ‘ä»¬æŠŠå®ƒæ¨åˆ°äº† Herokuã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œé‡è¦çš„æ˜¯å›åˆ°ä½ çš„ GitHub åº”ç”¨é¡µé¢ï¼Œç”¨ä½ çš„åŸŸåæ›´æ–°åº”ç”¨ URL å’Œå›è°ƒ URLã€‚

æ‚¨çš„åº”ç”¨ç¨‹åº URL ç°åœ¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

ä¸»é¡µ URL: `http://your_app_url.your_domain`

å›æ‹¨ç½‘å€:`http://your_app_url.your_domain/users/auth/github/callback`

è¿˜æœ‰ï¼Œåˆ«å¿˜äº†ç»™ Heroku ä½ çš„ API å¯†åŒ™ã€‚å¦åˆ™ä½ çš„ç”Ÿäº§ç¯å¢ƒå°†ä¸çŸ¥é“å¦‚ä½•è§£é‡Šä½ çš„*config/initializer/device . Rb*ä¸­çš„`config.omniauth :github, ENV['GITHUB_ID'], ENV['GITHUB_SECRET'], scope: 'user,public_repoâ€™`(ä½ çš„ç”¨æˆ·å°†å¾—åˆ°ä¸€ä¸ªåä¸½çš„ 404)ã€‚

åˆ«å¿˜äº†è·‘:

```
heroku run bundle # to install the omniauth gem
heroku run rails db:migrate # to update your users schema
heroku restart 
```

ç°åœ¨ï¼Œäººä»¬å¯ä»¥ä½¿ç”¨ä»–ä»¬çš„ GitHub å‡­æ®æ³¨å†Œå¹¶ç™»å½•åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºã€‚ğŸ™Œ