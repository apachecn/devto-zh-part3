# ç¬¬ 012 é›†-ç§»åŠ¨åˆ° Web API-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°è¿‡åº¦

> åŸæ–‡:[https://dev.to/joaofbantunes/episode-012-move-to-a-web-API-aspnet-core-from-0-to-over kill-50fg](https://dev.to/joaofbantunes/episode-012---move-to-a-web-api---aspnet-core-from-0-to-overkill-50fg)

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å¼€å§‹å°†å½“å‰çš„åº”ç”¨ç¨‹åºè½¬æ¢æˆä¸€ä¸ª Web APIï¼Œè¿™æ ·å®ƒå°±å¯ä»¥åœ¨æˆ‘ä»¬å°†è¦å¼€å‘çš„å•é¡µé¢åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/vxDvAGP9Bh8](https://www.youtube.com/embed/vxDvAGP9Bh8)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªæœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ MVC åº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼Œè¿™ä¸ªé¡¹ç›®çš„ç›®æ ‡æ˜¯æœ€ç»ˆå®ç°ä¸€ä¸ªå¤„ç†å¤§éƒ¨åˆ† UI éœ€æ±‚çš„å•é¡µé¢åº”ç”¨ç¨‹åºã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†æŠŠè¿™ä¸ª MVC åº”ç”¨ç¨‹åºè½¬æ¢æˆä¸€ä¸ª Web APIï¼Œè¿™æ · SPA(æˆ–è€…å…¶ä»–å¯èƒ½éœ€è¦å®ƒçš„ç»„ä»¶)å°±å¯ä»¥ä½¿ç”¨å®ƒå’Œæˆ‘ä»¬å°†æ¥æ„å»ºçš„å…¶ä»–ç»„ä»¶ã€‚

å¦å¤–ï¼Œæˆ‘ç§°ä¹‹ä¸º Web API æˆ– HTTP APIï¼Œè€Œä¸æ˜¯ REST APIã€‚æˆ‘ä¸æƒ³å› ä¸ºç§°å®ƒä¸º REST API è€Œä¸éµå¾ªæ‰€æœ‰éšå«çš„éœ€æ±‚(åŒ…æ‹¬ä½†ä¸ä»…ä»…æ˜¯è¶…åª’ä½“)æ¥å®ç°å®ƒè€Œæƒ¹æ¼ä»»ä½•äººã€‚å‡è®¾å®ƒæ˜¯ä¸€ä¸ª RESTish API(ğŸ˜›)ï¼Œå› ä¸ºå®ƒå®ç°äº†å¤§å¤šæ•°äººå¯¹å®ƒçš„æœŸæœ›ï¼Œä½†å¹¶ä¸å®Œå…¨ç¬¦åˆ RESTã€‚

## [](#remove-unneeded-bits)å»æ‰ä¸éœ€è¦çš„ä½

ç”±äºæˆ‘ä»¬æ­£åœ¨è½¬å‘ Web APIï¼Œæœ‰äº›ä¸œè¥¿æˆ‘ä»¬ä¸å†éœ€è¦ï¼Œå¯ä»¥æ¸…ç†/è°ƒæ•´ï¼Œå³:

*   ç§»é™¤è§†å›¾
*   ç”¨`AddMvcCore`æ›¿æ¢`AddMvc`ï¼Œåªæ·»åŠ æ‰€éœ€çš„ MVC ç‰¹æ€§
*   ä»`ControllerBase`è€Œä¸æ˜¯`Controller`ç»§æ‰¿

å…³äºç¬¬ä¸€ä¸ªï¼Œæ²¡æœ‰å¤ªå¤šè¦è¯´çš„ï¼Œåªæ˜¯åˆ é™¤è§†å›¾çš„æ–‡ä»¶å¤¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦å®ƒä»¬äº†ã€‚å…³äºå…¶ä»–çš„ï¼Œè®©æˆ‘ä»¬è¿›å…¥æ›´å¤šç»†èŠ‚ã€‚

### [](#replace-addmvc-with-addmvccore)ç”¨ AddMvcCore æ›¿æ¢ AddMvc

åœ¨ DI å®¹å™¨ MVC çš„æœåŠ¡ä¸­æ³¨å†Œï¼Œé‚£äº›å®ƒè‚¯å®šéœ€è¦çš„æœåŠ¡å’Œä¸€äº›å®ƒå¯èƒ½éœ€è¦çš„æœåŠ¡ã€‚ä¸ºæ­¤ï¼Œå®ƒè°ƒç”¨`AddMvcCore`å¹¶æ·»åŠ æ›´å¤šçš„ä¸œè¥¿ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨`AddMvcCore`æ¥é¿å…æ³¨å†Œä¸éœ€è¦çš„æœåŠ¡ï¼Œä»¥åŠæˆ‘ä»¬çŸ¥é“éœ€è¦çš„ä»»ä½•å…¶ä»– MVC æœåŠ¡ã€‚

è¿™ä¼šå¯¹æ€§èƒ½æœ‰å½±å“å—ï¼Ÿå¯èƒ½æ²¡æœ‰é‚£ä¹ˆå¤š(è™½ç„¶æ²¡æœ‰æµ‹é‡å®ƒ)ï¼Œä½†æ˜¯æ—¢ç„¶æˆ‘ä»¬å·²ç»åœ¨åšäº†ï¼Œæˆ‘ä»¬å°±å»æ‰ä¸€äº›ä¸ç”¨çš„éƒ¨åˆ†ï¼Œæ›´å¥½åœ°çœ‹çœ‹ä¸€äº›å¯ç”¨çš„ MVC ç‰¹æ€§ã€‚ä½†æ˜¯å¤§å¤šæ•°æ—¶å€™ï¼Œä¿æŒå†·é™ï¼Œä¸è¦æ‹…å¿ƒğŸ™‚

æˆ‘ä»¬æ¥çœ‹çœ‹ GitHub ä¸Šçš„ [`MvcServiceCollectionExtensions.cs`](https://github.com/aspnet/AspNetCore/blob/v2.2.1/src/Mvc/src/Microsoft.AspNetCore.Mvc/MvcServiceCollectionExtensions.cs) æ–‡ä»¶ï¼Œè¿™é‡Œå®šä¹‰äº†`AddMvc`ã€‚

```
// ...

public static class MvcServiceCollectionExtensions
{
    /// <summary>
    /// Adds MVC services to the specified <see cref="IServiceCollection" />.
    /// </summary>
    /// <param name="services">The <see cref="IServiceCollection" /> to add services to.</param>
    /// <returns>An <see cref="IMvcBuilder"/> that can be used to further configure the MVC services.</returns>
    public static IMvcBuilder AddMvc(this IServiceCollection services)
    {
        // ...

        var builder = services.AddMvcCore();

        builder.AddApiExplorer();
        builder.AddAuthorization();

        AddDefaultFrameworkParts(builder.PartManager);

        // Order added affects options setup order

        // Default framework order
        builder.AddFormatterMappings();
        builder.AddViews();
        builder.AddRazorViewEngine();
        builder.AddRazorPages();
        builder.AddCacheTagHelper();

        // +1 order
        builder.AddDataAnnotations(); // +1 order

        // +10 order
        builder.AddJsonFormatters();

        builder.AddCors();

        return new MvcBuilder(builder.Services, builder.PartManager);
    }

    private static void AddDefaultFrameworkParts(ApplicationPartManager partManager)
    {
        var mvcTagHelpersAssembly = typeof(InputTagHelper).GetTypeInfo().Assembly;
        if (!partManager.ApplicationParts.OfType<AssemblyPart>().Any(p => p.Assembly == mvcTagHelpersAssembly))
        {
            partManager.ApplicationParts.Add(new FrameworkAssemblyPart(mvcTagHelpersAssembly));
        }

        var mvcRazorAssembly = typeof(UrlResolutionTagHelper).GetTypeInfo().Assembly;
        if (!partManager.ApplicationParts.OfType<AssemblyPart>().Any(p => p.Assembly == mvcRazorAssembly))
        {
            partManager.ApplicationParts.Add(new FrameworkAssemblyPart(mvcRazorAssembly));
        }
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æ¸…ç†äº†æ–‡ä»¶ä¸­ä¸€äº›æˆ‘ä»¬ç°åœ¨è¦æ‰¾çš„ä¸œè¥¿å¹¶ä¸çœŸæ­£éœ€è¦çš„éƒ¨åˆ†ã€‚

æŸ¥çœ‹`AddMvc`ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒåšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è°ƒç”¨`AddMvcCore`ï¼Œå°†è¿”å›çš„`IMvcBuilder`å­˜å‚¨åœ¨ä¸€ä¸ªå˜é‡ä¸­ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥é…ç½®ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨æ„å»ºå™¨é…ç½®çš„å…¶ä»–ä¸œè¥¿ã€‚

*   addapi explorerâ€”â€”ç”¨äºå…¬å¼€å…³äº MVC åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œè¿™å¯¹äºåˆ›å»º Swagger æ–‡æ¡£ç«¯ç‚¹å¾ˆæœ‰ç”¨ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹å®‰å¾·é²Â·æ´›å…‹çš„å¸–å­ã€‚æˆ‘ä»¬æœ€ç»ˆä¼šä½¿ç”¨ Swaggerï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨å®ƒ...è¯´å‡ºæ¥å§ï¼
*   add authorizationâ€”â€”æ·»åŠ å¿…è¦çš„æˆæƒæœåŠ¡ï¼Œæˆ‘ä»¬å°†æ¥è‚¯å®šä¼šéœ€è¦ï¼Œä½†ä¸æ˜¯ç°åœ¨ï¼Œæ‰€ä»¥...å‡ºå»ï¼
*   AddDefaultFrameworkPartsâ€”â€”æŸ¥çœ‹`AddMvc`ä¸‹é¢çš„`AddDefaultFrameworkParts`å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ­£åœ¨ä» Razor å’Œ TagHelpers ç¨‹åºé›†æ³¨å†ŒæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»•è¿‡å®ƒã€‚
*   AddFormatterMappingsâ€”â€”æˆ‘ä¸å¾—ä¸çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°æ¥å¼„æ¸…æ¥šå®ƒåšäº†ä»€ä¹ˆï¼Œå®ƒåŸºæœ¬ä¸Šæ³¨å†Œäº†ä¸€ä¸ª`FormatFilter`,æ£€æŸ¥è¯·æ±‚çš„è·¯ç”±æ•°æ®å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨æ ¼å¼å‚æ•°ï¼Œå°±åƒä½¿ç”¨`Accept`å¤´ä¸€æ ·ä½¿ç”¨ã€‚å¦ä¸€ä¸ªæˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œæ‰€ä»¥è·³è¿‡å®ƒã€‚
*   æ·»åŠ è§†å›¾-è§†å›¾...ä¸‹ä¸€ä¸ªï¼
*   æ›´å¤šå‰ƒåˆ€çš„ä¸œè¥¿ï¼Œä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªï¼
*   æ·»åŠ å‰ƒåˆ€é¡µ-å’Œæ›´å¤šå‰ƒåˆ€...è®©æˆ‘ä»¬ç»§ç»­è·³ç»³å§ã€‚
*   AddCacheTagHelper -æ›´å¤šçš„æ ‡è®°åŠ©æ‰‹ï¼Œè·³è¿‡å®ƒã€‚
*   adddata annotationsâ€”â€”åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨æ•°æ®æ³¨é‡Šï¼Œæˆ‘ä¹Ÿä¸å¸Œæœ›å°†æ¥åœ¨è¿™ä¸ª API ä¸­ä½¿ç”¨å®ƒä»¬(æˆ‘ä»¬å°†ä½¿ç”¨ [Fluent éªŒè¯](https://github.com/JeremySkinner/FluentValidation))ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å®‰å…¨åœ°å¿½ç•¥å®ƒã€‚
*   AddJsonFormattersâ€”â€”ç°åœ¨æˆ‘ä»¬éœ€è¦è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬çš„ API éœ€è¦å¤„ç† JSONã€‚
*   add CORSâ€”â€”æˆ‘ä¸æœŸæœ›æˆ‘ä»¬å°†ä»ä¸åŒçš„åŸŸè®¿é—® APIï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å®‰å…¨åœ°å¿½ç•¥è¿™ä¸ªã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°ä»€ä¹ˆå‘¢ï¼Ÿåœ¨`Startup`ç±»ä¸­ï¼Œ`services.AddMvc();`è¢«æ›¿æ¢ä¸º`services.AddRequiredMvcComponents();`ï¼Œè¿™æ˜¯æˆ‘ä»¬æ·»åŠ åˆ°å·²ç»åˆ›å»ºçš„`ServiceCollectionExtensions`ç±»ä¸­çš„ä¸€ä¸ªæ–°çš„æ‰©å±•æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä»¥ä¸‹å†…å®¹:

`ServiceCollectionExtensions.cs`

```
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddRequiredMvcComponents(this IServiceCollection services)
    {
        var mvcBuilder = services.AddMvcCore();
        mvcBuilder.AddJsonFormatters();
        return services;
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€ƒè™‘åˆ°æˆ‘ä»¬æ‰€æ‹¥æœ‰çš„ï¼Œæˆ‘ä»¬åªæŠŠ`AddMvc`æ¢æˆäº†`AddMvcCore`ï¼Œè¿˜å¢åŠ äº†ä¸€ä¸ªå¯¹`AddJsonFormatters`çš„å‘¼å«ã€‚æˆ‘ä»¬ç¨åå°†å›åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å°†éœ€è¦ä¸€äº›é¢å¤–çš„é…ç½®æ¥è¿›è¡Œæˆ‘ä»¬å°†è¦è¿›è¡Œçš„æ›´æ”¹ã€‚

### [](#inherit-from-controllerbase-instead-of-controller)ç»§æ‰¿è‡ª ControllerBase è€Œé Controller

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„`GroupsController`ç±»ç»§æ‰¿è‡ª`Controller`ã€‚å®ƒä»ç„¶å¯ä»¥ä»`Controller`ç»§æ‰¿ï¼Œä½†æ˜¯ç”±äº`Controller`å”¯ä¸€æ‹¥æœ‰çš„`ControllerBase`æ²¡æœ‰çš„ä¸œè¥¿(é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå®ƒç»§æ‰¿äº†è¿™ä¸ªä¸œè¥¿)æ˜¯å¯¹è§†å›¾çš„æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡ä¸å¿…è¦çš„é¢å¤–éƒ¨åˆ†ã€‚

å› ä¸ºè¿™ä¸ªæ”¹å˜ï¼Œå› ä¸ºæˆ‘ä»¬ä»ç„¶è°ƒç”¨`View`æ–¹æ³•ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ç¼–è¯‘é”™è¯¯ã€‚æˆ‘ä»¬é©¬ä¸Šå¼€å§‹ã€‚

## [](#adjust-endpoints)è°ƒæ•´ç«¯ç‚¹

ç°åœ¨è®©æˆ‘ä»¬å°†`GroupsController`é‡æ–°åŠ å·¥æˆä¸€ä¸ª API æ§åˆ¶å™¨ã€‚æ€»ä¹‹ï¼Œå®ƒå°†ä»¥ç­¾åä¸`IGroupsService`å‡ ä¹ç›¸åŒçš„æ–¹æ³•ç»“æŸï¼Œè°ƒç”¨æœåŠ¡çš„æ–¹æ³•å¹¶æ·»åŠ ä¸€äº›é¢å¤–çš„â€œæ§åˆ¶å™¨ä¸œè¥¿â€åˆ°æ··åˆä¸­ï¼Œå³è·¯ç”±ã€HTTP æ–¹æ³•å’Œ HTTP å“åº”ã€‚

`GroupsController.cs`

```
[Route("groups")]
public class GroupsController : ControllerBase
{
    private readonly IGroupsService _groupsService;

    public GroupsController(IGroupsService groupsService)
    {
        _groupsService = groupsService;
    }

    [HttpGet]
    [Route("")]
    public async Task<IActionResult> GetAllAsync(CancellationToken ct)
    {
        var result = await _groupsService.GetAllAsync(ct);
        return Ok(result.ToModel());
    }

    [HttpGet]
    [Route("{id}")]
    public async Task<IActionResult> GetByIdAsync(long id, CancellationToken ct)
    {
        var group = await _groupsService.GetByIdAsync(id, ct);

        if (group == null)
        {
            return NotFound();
        }

        return Ok(group.ToModel());
    }

    [HttpPut]
    [Route("{id}")]
    public async Task<IActionResult> UpdateAsync(long id, GroupModel model, CancellationToken ct)
    {
        model.Id = id; //not needed when we move to MediatR
        var group = await _groupsService.UpdateAsync(model.ToServiceModel(), ct);

        return Ok(group.ToModel());
    }

    [HttpPut]
    [HttpPost]
    [Route("")]
    public async Task<IActionResult> AddAsync(GroupModel model, CancellationToken ct)
    {
        model.Id = 0; //not needed when we move to MediatR
        var group = await _groupsService.AddAsync(model.ToServiceModel(), ct);

        return CreatedAtAction(nameof(GetByIdAsync), new { id = group.Id }, group.ToModel());
    }

    [HttpDelete]
    [Route("{id}")]
    public async Task<IActionResult> RemoveAsync(long id, CancellationToken ct)
    {
        await _groupsService.RemoveAsync(id, ct);

        return NoContent();
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘è®¤ä¸ºç†è§£è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…çœŸçš„å¾ˆç®€å•ï¼Œä½†æˆ‘ä¼šå°è¯•æŒ‡å‡ºä¸€äº›å°ç»†èŠ‚ã€‚

*   è¯»æ“ä½œï¼ŒåŒ…æ‹¬å®ƒä»¬çš„è·¯å¾„ï¼ŒåŸºæœ¬ä¸Šä¿æŒä¸å˜ï¼Œåªæ˜¯æ–¹æ³•åæœ‰æ‰€è°ƒæ•´ï¼Œå¹¶ç›´æ¥è¿”å›æ¨¡å‹è€Œä¸æ˜¯è§†å›¾(JSON æˆ–ä»»ä½•å…¶ä»–æ ¼å¼çš„åºåˆ—åŒ–ç”±æ¡†æ¶å¤„ç†)ã€‚

*   æ›´æ–°æ“ä½œè¢«ç»‘å®šåˆ° HTTP PUTï¼Œè¿™åœ¨ HTTP APIs ä¸­å¾ˆå¸¸è§ï¼Œå› ä¸ºæˆ‘ä»¬æœŸæœ›å®Œå…¨æ›¿æ¢å­˜å‚¨çš„å®ä½“ã€‚

*   add æ“ä½œç»‘å®šåˆ° HTTP POST å’Œ PUT æ–¹æ³•ï¼Œä¸ update æ“ä½œä¸åŒï¼Œå®ƒä¸éœ€è¦ idã€‚è¿™å½“ç„¶ä¾èµ–äºè¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆ id çš„å®ç°ã€‚å…¶ä»–å®ç°å¯èƒ½å…è®¸å®¢æˆ·ç«¯æä¾›ä¸€ä¸ª idï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”¨ä¸€ä¸ªåŠ¨ä½œæ›¿æ¢è¿™ä¸¤ä¸ªåŠ¨ä½œï¼Œå¦‚æœå®ä½“ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ï¼Œå¦åˆ™æ›´æ–°ã€‚

*   add åŠ¨ä½œè¿”å›ä¸€ä¸ª HTTP 201 åˆ›å»ºçš„çŠ¶æ€ä»£ç ï¼ŒåŒ…æ‹¬ url çš„`Location`å¤´ä»¥è·å–æ·»åŠ çš„å®ä½“ï¼Œè¿˜åŒ…æ‹¬åœ¨å“åº”ä½“ä¸­ã€‚

åœ¨æœ¬èŠ‚çš„æœ€åä¸€ç‚¹ï¼Œè¯·æ³¨æ„åœ¨ add å’Œ update æ–¹æ³•ä¸­ï¼Œæˆ‘è¦†ç›–äº†æ¥è‡ªå®¢æˆ·ç«¯çš„ idã€‚æˆ‘ä¸éœ€è¦è¿™æ ·åšï¼Œä½†æ˜¯æˆ‘è¦ç¡®ä¿æœåŠ¡ä¸ä¼šå¾—åˆ°ä¸ä¸€è‡´/æ„å¤–çš„ idâ€”â€”åœ¨ add ä¸Šå®šä¹‰ä¸€ä¸ªè¿˜æ²¡æœ‰ id çš„ id(è‡³å°‘æŒ‰ç…§æˆ‘ä»¬ç°åœ¨çš„æ–¹å¼ï¼Œå…è®¸å®šä¹‰ id ä¹Ÿå¯èƒ½æ˜¯æœ‰æ•ˆçš„)å’Œä¸€ä¸ªä¸åŒäºåœ¨æ›´æ–°æ—¶æ”¾åœ¨ route ä¸Šçš„ idã€‚

è¿™ä¸ªé—®é¢˜ä¸»è¦æºäºæˆ‘ä»¬åœ¨æ‰€æœ‰æ“ä½œä¸­é‡ç”¨åŒä¸€ä¸ªæ¨¡å‹ã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯å¯¹æ¯ä¸€ä¸ªéƒ½ä½¿ç”¨ç‰¹å®šçš„æ¨¡å‹ï¼Œè¿™å°†åœ¨æˆ‘ä»¬å°†[mediator](https://github.com/jbogard/MediatR)æ·»åŠ åˆ°é¡¹ç›®ä¸­æ—¶å®ç°ã€‚

## [](#use-apicontroller-attribute)ä½¿ç”¨ ApiController å±æ€§

API åŸºæœ¬ä¸Šå·²ç»å‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç°åœ¨å°è¯•è¿è¡Œå®ƒï¼Œè¯»æ“ä½œä¼šåƒé¢„æœŸçš„é‚£æ ·å·¥ä½œï¼Œä½†æ˜¯å†™æ“ä½œä¸ä¼šã€‚

è®©æˆ‘ä»¬é€šè¿‡å‘`http://localhost:5000/groups`å‘é€ä¿¡æ¯`{ "name": "Test Group" }`æ¥å°è¯•æ·»åŠ ä¸€ä¸ªæ–°ç»„ã€‚æˆ‘ä»¬å¾—åˆ°çš„å›åº”å¦‚ä¸‹:

```
{  "id":  1,  "name":  null,  "rowVersion":  "611"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`id`å’Œ`rowVersion`æ­£ç¡®ï¼Œä½†`name`ä¸æ­£ç¡®ã€‚å‰è€…å¾ˆå¥½ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯åœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„ï¼Œä½†åå­—å¹¶ä¸æ˜¯ get åˆ°çš„ action æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬åœ¨`AddAsync`æ–¹æ³•ä¸­æ”¾ä¸€ä¸ªæ–­ç‚¹ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°`model`å‚æ•°æ˜¯ç©ºçš„ã€‚`UpdateAsync`ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

é—®é¢˜æ˜¯åŠ¨ä½œä¸çŸ¥é“`model`åº”è¯¥ä»ä¸»ä½“ååºåˆ—åŒ–ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨`model`å‚æ•°ä¸­æ·»åŠ `[FromBody]`å±æ€§æ¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è¿™æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥åšå¾—æ›´å¥½ã€‚åœ¨ ASP.NET æ ¸å¿ƒ 2.1 ä¸­å¼•å…¥äº†`ApiController`ï¼Œå…è®¸æˆ‘ä»¬ä¿®é¥°æ§åˆ¶å™¨ï¼Œä½¿å®ƒéµå¾ªä¸€äº›èŠ‚çœæˆ‘ä»¬å·¥ä½œçš„æƒ¯ä¾‹ï¼Œæ¯”å¦‚æ¨æ–­å¤æ‚çš„å¯¹è±¡æ¥è‡ªè¯·æ±‚ä½“ã€‚è¿™å½“ç„¶å¯ä»¥è¢«è¦†ç›–ï¼Œä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç¼ºçœå€¼ï¼Œå¯ä»¥é¿å…æˆ‘ä»¬è¿›è¡Œä¸€äº›è¾“å…¥ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºè¿™ä¸ªå±æ€§[çš„å†…å®¹ã€‚](https://docs.microsoft.com/en-us/aspnet/core/web-api/?view=aspnetcore-2.2#annotation-with-apicontroller-attribute)

è¦ä½¿ç”¨è¯¥å±æ€§ï¼Œæˆ‘ä»¬å¿…é¡»è½¬åˆ°ä¾èµ–æ³¨å…¥ MVC é…ç½®å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:

`ServiceCollectionExtensions.cs`

```
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddRequiredMvcComponents(this IServiceCollection services)
    {
        var mvcBuilder = services.AddMvcCore();
        mvcBuilder.SetCompatibilityVersion(CompatibilityVersion.Version_2_2);
        // ...
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å› ä¸ºä½¿ç”¨è¯¥å±æ€§éœ€è¦ä½¿ç”¨ 2.1 ç‰ˆåŠæ›´é«˜ç‰ˆæœ¬çš„æ–° ASP.NET æ ¸å¿ƒ MVC ä½ï¼Œä¸ 2.0 ç›¸æ¯”ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´é‡å¤§å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ˜ç¡®åœ°å‘Šè¯‰å®ƒæˆ‘ä»¬æƒ³è¦ä½¿ç”¨æ–°ç‰¹æ€§ã€‚ç‚¹å‡»é˜…è¯»æ›´å¤šå…³äºå…¼å®¹æ€§ç‰ˆæœ¬[çš„ä¿¡æ¯ã€‚](https://docs.microsoft.com/en-us/aspnet/core/mvc/compatibility-version?view=aspnetcore-2.2)

æˆ‘ä½¿ç”¨å…¼å®¹æ€§ç‰ˆæœ¬ 2.2ï¼Œå› ä¸ºåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`ApiController`å±æ€§ä½œä¸ºè‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰æ§åˆ¶å™¨çš„é›†åˆå±æ€§ï¼Œè€Œä¸å¿…ä¿®é¥°æ¯ä¸ªæ§åˆ¶å™¨ã€‚

åœ¨`Startup`ç±»æ–‡ä»¶ä¸­ï¼Œæˆ‘åˆšåˆšæ·»åŠ äº†å±æ€§ä¸º`[assembly: ApiController]`ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ­£å¸¸å·¥ä½œçš„æ§åˆ¶å™¨ğŸ™‚

## [](#create-an-exception-filter)åˆ›å»ºä¾‹å¤–è¿‡æ»¤å™¨

åŸºäºæˆ‘ä»¬åœ¨è¿‡å»å‡ é›†ä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›é€ ä¸€ä¸ª`ExceptionFilter`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå½“å¯¹ä¸€ä¸ªç»„çš„æ›´æ–°ç”±äºè¿‡æ—¶è€Œå¤±è´¥æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª HTTP 409 å†²çªçŠ¶æ€ä»£ç â€”â€”è¿™æ˜¯ä¸€ä¸ªä¹è§‚å¹¶å‘å¼‚å¸¸ï¼Œå°±åƒæˆ‘ä»¬åœ¨ä¸Šä¸€é›†çœ‹åˆ°çš„é‚£æ ·ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»¥åæ”¹è¿›è¿‡æ»¤å™¨æ¥å¤„ç†æ›´å¤šç§ç±»çš„é”™è¯¯ã€‚

`ApiExceptionFilter.cs`

```
public class ApiExceptionFilter : IExceptionFilter
{
    public void OnException(ExceptionContext context)
    {
        if (context.Exception is DbUpdateConcurrencyException)
        {
            context.Result = 
                new ConflictObjectResult(
                    new
                    {
                        Message = "The updated entity has changed, please refresh your current copy."
                    });
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å¯ä»¥åœ¨æœªæ¥æ”¹è¿›è¿™ä¸€ç‚¹ï¼Œè®©ä¸šåŠ¡å±‚å°†åˆ°è¾¾ API çš„å¼‚å¸¸æŠ½è±¡ä¸ºæ›´é€šç”¨çš„å¹¶å‘å¼‚å¸¸ï¼Œè€Œä¸æ˜¯ç»‘å®šåˆ°å®ä½“æ¡†æ¶ç‰¹å®šçš„å¼‚å¸¸ã€‚ç›®å‰ï¼Œè¿™å·²ç»è¶³å¤Ÿå¥½äº†ã€‚

ç°åœ¨æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„`ServiceCollectionExtensions`ç±»ï¼Œé€šè¿‡æ·»åŠ è¿™ä¸ªè¿‡æ»¤å™¨æ¥æ€»ç»“å¯¹ MVC é…ç½®çš„æ›´æ”¹(ä»Šå¤©)ã€‚

```
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddRequiredMvcComponents(this IServiceCollection services)
    {
        services.AddTransient<ApiExceptionFilter>();

        var mvcBuilder = services.AddMvcCore(options =>
        {
            options.Filters.AddService<ApiExceptionFilter>();
        });
        mvcBuilder.SetCompatibilityVersion(CompatibilityVersion.Version_2_2);   
        mvcBuilder.AddJsonFormatters();
        return services;
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#outro)å…¶ä»–

è¿™å°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ã€‚æˆ‘ä»¬å°†æˆ‘ä»¬çš„ MVC åº”ç”¨ç¨‹åºç§»æ¤åˆ°äº†ä¸€ä¸ª Web API ä¸Šâ€”â€”ä¸ç®¡æ€æ ·ï¼Œå®ƒæ˜¯å»ºç«‹åœ¨ MVC ä¹‹ä¸Šçš„ï¼Œä½†æ˜¯ä½ æ˜ç™½äº†ï¼

åœ¨æœªæ¥çš„å‡ é›†é‡Œï¼Œæˆ‘ä»¬å°†åœ¨è¿™ä¸ª API çš„åŸºç¡€ä¸Šæ„å»ºï¼Œå®ƒä»ç„¶éå¸¸ç®€å•ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ¢ç´¢è®¸å¤š ASP.NET çš„æ ¸å¿ƒæ„å»ºå—å’Œç‰¹æ€§ã€‚

ä¸è¿‡åœ¨ä¸‹ä¸€é›†ï¼Œæˆ‘ä»¬å°†ä» ASP.NET æ ¸å¿ƒä¸­ä¼‘æ¯ä¸€ä¸‹ï¼Œå¼€å§‹ç”¨ Vue.js åˆ›å»ºä¸€ä¸ªå•é¡µé¢åº”ç”¨ç¨‹åºï¼Œè¿™å°†æ˜¯æˆ‘ä»¬çš„ PlayBall é¡¹ç›®å‰ç«¯ï¼Œå¹¶å°†ä½¿ç”¨è¿™ä¸ª API æ¥å®ç°å®ƒçš„åŠŸèƒ½ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   Andrew Lock[å¯¹ ASP.NET æ ¸å¿ƒ ApiExplorer çš„ä»‹ç»](https://andrewlock.net/introduction-to-the-apiexplorer-in-asp-net-core/)
*   [ä½¿ç”¨ ASP.NET æ ¸å¿ƒæ„å»º web APIsã€‘](https://docs.microsoft.com/en-us/aspnet/core/web-api/?view=aspnetcore-2.2)
*   [ASP.NET æ ¸å¿ƒ MVC çš„å…¼å®¹ç‰ˆæœ¬](https://docs.microsoft.com/en-us/aspnet/core/mvc/compatibility-version?view=aspnetcore-2.2)

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/tree/episode012)ã€‚

å¦‚æœä½ æƒ³çœ‹åˆ°ä»ä¹‹å‰çš„ä»£ç åˆ°è¿™ä¸€é›†çš„å˜åŒ–ï¼Œä¸è¦å¿˜è®°ä½ å¯ä»¥çœ‹çœ‹ GitHub ä¸­çš„æäº¤å’Œæ‹‰è¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°è¿™ä¸€é›†çš„ PR[ã€‚](https://github.com/AspNetCoreFromZeroToOverkill/GroupManagement/pull/5)

è¯·éšæ„æé—®ï¼Œä¸è¦çŠ¹è±«æä¾›åé¦ˆã€‚

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼