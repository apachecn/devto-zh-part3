# ä½¿ç”¨ Dropwizardã€MongoDB å’Œ Docker æ„å»ºå¾®æœåŠ¡

> åŸæ–‡:[https://dev . to/ricdev 2/building-micro services-with-drop wizard-MongoDB-docker-o30](https://dev.to/ricdev2/building-microservices-with-dropwizard-mongodb--docker--o30)

### [](#dropwizard-making-magic)Dropwizard åˆ¶é€ é­”æ³•ã€‚ğŸ˜

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ Dropwizard åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªæ¡†æ¶æä¾›äº†æ‰€æœ‰ç±»å‹çš„åº“æ¥æ„å»º web åº”ç”¨ç¨‹åºã€‚åŒ…æ‹¬çš„ä¸€äº›åº“æœ‰:

Jetty Server :è¿™æ˜¯ä¸€ä¸ªå¼€æºçš„ web æœåŠ¡å™¨ï¼Œè½»é‡çº§ï¼Œæ˜“äºåµŒå…¥åˆ°ä»»ä½•åº”ç”¨ç¨‹åºä¸­ã€‚

**Jersey** :åˆ›å»º RESTful web æœåŠ¡çš„å®ç°ã€‚

Jackson :å…è®¸ä½ ä» JSON å¯¹è±¡åˆ° POJOs è¿›è¡Œæ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚

**åº¦é‡**:æä¾›å…³äº HTTP è¯·æ±‚ã€æ•°æ®åº“è¿æ¥ã€é˜Ÿåˆ—ç­‰çŠ¶æ€çš„ä¿¡æ¯ã€‚

Guava :æ”¯æŒè®¸å¤šç±»æ¥å¤„ç†é›†åˆã€éªŒè¯ã€å­—ç¬¦ä¸²ç­‰ã€‚

Hibernate éªŒè¯å™¨:ä½œä¸º java å¯¹è±¡çº¦æŸçš„éªŒè¯ã€‚

JDBI :åŒ…è£…äº† JDBCï¼Œå¹¶æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥æ“ä½œå…³ç³»æ•°æ®åº“ã€‚

**Liquibase** :éå¸¸é€‚åˆæ•°æ®åº“ä¸­çš„è¿ç§»å’Œ DDL æ›´æ”¹ã€‚

### MongoDB NoSQL æ•°æ®åº“ç­‰ç­‰ã€‚ğŸŒ³

è¿™ä¸ªé¢å‘æ–‡æ¡£çš„ NoSQL æ•°æ®åº“(é€šè¿‡åƒ JSON è¿™æ ·çš„æ–‡æ¡£)ç»“åˆäº†å…³ç³»æ•°æ®åº“çš„ä¸€äº›ç‰¹æ€§ï¼Œæ˜“äºä½¿ç”¨ï¼Œå¤šå¹³å°æ˜¯çºµå‘æ‰©å±•çš„æœ€ä½³é€‰æ‹©ï¼Œå…·æœ‰å®¹é”™ã€è´Ÿè½½å¹³è¡¡ã€map reduce ç­‰åŠŸèƒ½ã€‚

#### [](#technologies-used-in-this-microservice)æœ¬å¾®æœåŠ¡ä¸­ä½¿ç”¨çš„æŠ€æœ¯ğŸ“

*   OpenJDK 8
*   dock 2 . 0 . 0-MAC 81(MAC ç‰ˆæœ¬)
*   MongoDB 4.0
*   Maven 3.5
*   Mac OS mojave(æˆ–ä»»ä½•å…¶ä»–åƒ windows æˆ– linux)
*   Nginx 1.15
*   IntelliJ IDEA 2018

å¥½äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºé¡¹ç›®ï¼ŒDropwizard ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª maven åŸå‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»å®ƒçš„ç½‘ç«™ä¸Šä½¿ç”¨å®ƒï¼Œä¸‹é¢æ˜¯è¿™ä¸ªå‘½ä»¤çš„ä¸€ä¸ªä¾‹å­:

```
mvn archetype:generate -DarchetypeGroupId=io.dropwizard.archetypes -DarchetypeArtifactId=java-simple -DarchetypeVersion=1.3.5 -DgroupId=com.demo -DartifactId=dropwizard-mongodb-ms -Dversion=1.0.0-SNAPSHOT -Dname=DropwizardMongoDBMicroservice 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œåœ¨å‘½ä»¤å‰ç²˜è´´ï¼Œç¡®ä¿å·²ç»å®‰è£…å¹¶é…ç½®äº† maven å’Œ javaã€‚

æœ€ç»ˆçš„ç»“æ„çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
dropwizard-mongodb-ms/
â”œâ”€â”€ README.md
â”œâ”€â”€ config.yml
â”œâ”€â”€ pom.xml
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ com
    â”‚   â”‚       â””â”€â”€ demo
    â”‚   â”‚           â”œâ”€â”€ DropwizardMongoDBMicroserviceApplication.java
    â”‚   â”‚           â”œâ”€â”€ DropwizardMongoDBMicroserviceConfiguration.java
    â”‚   â”‚           â”œâ”€â”€ api
    â”‚   â”‚           â”œâ”€â”€ cli
    â”‚   â”‚           â”œâ”€â”€ client
    â”‚   â”‚           â”œâ”€â”€ core
    â”‚   â”‚           â”œâ”€â”€ db
    â”‚   â”‚           â”œâ”€â”€ health
    â”‚   â”‚           â””â”€â”€ resources
    â”‚   â””â”€â”€ resources
    â”‚       â”œâ”€â”€ assets
    â”‚       â””â”€â”€ banner.txt
    â””â”€â”€ test
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ com
        â”‚       â””â”€â”€ demo
        â”‚           â”œâ”€â”€ api
        â”‚           â”œâ”€â”€ client
        â”‚           â”œâ”€â”€ core
        â”‚           â”œâ”€â”€ db
        â”‚           â””â”€â”€ resources
        â””â”€â”€ resources
            â””â”€â”€ fixtures 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦é¡¹ç›®è¢«åˆ›å»ºï¼Œåœ¨`pom.xml`æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–é¡¹:

```
. . .
<properties>
        <dropwizard.version>1.3.5</dropwizard.version>
        <mainClass>com.demo.DropwizardMongoDBMicroserviceApplication</mainClass>
        <mongodb.version>3.8.2</mongodb.version>
        <jdk.version>1.8</jdk.version>
        <dropwizard.swagger.version>1.0.6-1</dropwizard.swagger.version>
        <mockito.core.version>2.23.0</mockito.core.version>
</properties>
. . .
<dependency>
    <groupId>io.dropwizard</groupId>
    <artifactId>dropwizard-core</artifactId>
</dependency>
<dependency>
    <groupId>org.mongodb</groupId>
    <artifactId>mongodb-driver-sync</artifactId>
    <version>${mongodb.version}</version>
</dependency>

<dependency>
    <groupId>com.smoketurner</groupId>
    <artifactId>dropwizard-swagger</artifactId>
    <version>${dropwizard.swagger.version}</version>
</dependency>

<!-- Testing -->
<dependency>
    <groupId>io.dropwizard</groupId>
    <artifactId>dropwizard-testing</artifactId>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <version>${mockito.core.version}</version>
    <scope>test</scope>
</dependency>
<!-- Testing -->
. . . 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘åœ¨æ–‡ä»¶`configuration.yaml`ä¸­æ·»åŠ äº†ä¸€äº›é…ç½®ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:

```
server:
  maxThreads: 512
  applicationContextPath: /dropwizard-mongodb-ms
  applicationConnectors:
    - type: http
      port: 8080
  adminConnectors:
    - type: http
      port: 8081

logging:
  level: INFO
  loggers:
    com.demo: INFO

#You can choose the user and password what you want.
mongoDBConnection:
  credentials:
    username: "user_donuts" 
    password: "pAsw0Rd"
  seeds:
    - host: "mongodb"
      port: 27017
  database: "donuts"

swagger:
  basePath: /dropwizard-mongodb-ms
  resourcePackage: com.demo.resources
  scan: true
  info:
    version: "1.0.0"
    title: "Donuts  API  CRUD"
    description: "A  simple  API  used  for  expose  CRUD  operation  on  MongoDB  collection"
    termsOfService: "http://swagger.io/terms/"
    contact:
      name: "Donuts  API  "
    license:
      name: "Rich  Lopez" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

configuration.yml æ˜ å°„åˆ°ä¸€ä¸ªæ‰©å±•äº†`io.dropwizard.Configuration`çš„ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
package com.demo;

import com.demo.db.configuration.MongoDBConnection;
import com.fasterxml.jackson.annotation.JsonProperty;

import io.dropwizard.Configuration;
import io.federecio.dropwizard.swagger.SwaggerBundleConfiguration;

public class DropwizardMongoDBMicroserviceConfiguration extends Configuration {

    /**
     * The data configuration for MongoDB.
     */

    private MongoDBConnection mongoDBConnection;

    @JsonProperty("swagger")
    private SwaggerBundleConfiguration swaggerBundleConfiguration;

    //Getters and setters
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªå¾®æœåŠ¡å°†å…¬å¼€ä¸€ä¸ªåŸºäº CRUD(åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤)API RESTã€‚æˆ‘å·²ç»é€‰æ‹©äº†ä¸€ä¸ªäº§å“ï¼Œå¦‚ç”œç”œåœˆ(ğŸ© ğŸ¤¤)ï¼Œä½ å¯ä»¥åœ¨æˆ‘çš„ Github èµ„æºåº“ä¸­æ‰¾åˆ°æœ¬æ•™ç¨‹æœ«å°¾çš„éƒ¨åˆ†ä»£ç ã€‚

æˆ‘ä½¿ç”¨`com.mongodb.client.MongoCollection`æ¥å£æ¥è®¿é—®åä¸º`donuts`çš„é›†åˆï¼Œä»¥ä¾¿åœ¨æ“ä½œä¸­æœ‰æ›´å¤šçš„ç²’åº¦ï¼Œæ‰€ä»¥æˆ‘åˆ›å»ºäº†ä¸€ä¸ª DAO(æ•°æ®è®¿é—®å¯¹è±¡)æ¥æ“çºµ CRUD æ“ä½œã€‚

```
package com.demo.db.daos;
//imports ... 
public class DonutDAO {

    /** The collection of Donuts */
    final MongoCollection<Document> donutCollection;

    /**
     * Constructor.
     *
     * @param donutCollection the collection of donuts.
     */
    public DonutDAO(final MongoCollection<Document> donutCollection) {
        this.donutCollection = donutCollection;
    }

    /**
     * Find all donuts.
     *
     * @return the donuts.
     */
    public List<Donut> getAll() {
        final MongoCursor<Document> donuts = donutCollection.find().iterator();
        final List<Donut> donutsFind = new ArrayList<>();
        try {
            while (donuts.hasNext()) {
                final Document donut = donuts.next();
                donutsFind.add(DonutMapper.map(donut));
            }
        } finally {
            donuts.close();
        }
        return donutsFind;
    }

    /**
     * Get one document find in other case return null.
     *
     * @param id the identifier for find.
     * @return the Donut find.
     */
    public Donut getOne(final ObjectId id) {
        final Optional<Document> donutFind = Optional.ofNullable(donutCollection.find(new Document("_id", id)).first());
        return donutFind.isPresent() ? DonutMapper.map(donutFind.get()) : null;
    }

    public void save(final Donut donut){
        final Document saveDonut = new Document("price", donut.getPrice())
                                      .append("flavor", donut.getFlavor());
        donutCollection.insertOne(saveDonut);
    }

    /**
     * Update a register.
     *
     * @param id the identifier.
     * @param donut the object to update.
     */
    public void update(final ObjectId id, final Donut donut) {
        donutCollection.updateOne(new Document("_id", id),
                new Document("$set", new Document("price", donut.getPrice())
                        .append("flavor", donut.getFlavor()))
        );
    }

    /**
     * Delete a register.
     * @param id    the identifier.
     */
    public void delete(final ObjectId id){
        donutCollection.deleteOne(new Document("_id", id));
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†æ˜ å°„æ¥è‡ªæ•°æ®åº“çš„ä¿¡æ¯ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªå®ç”¨ç¨‹åºç±»æ¥è¿‡æ»¤ MongoDB åˆ° POJO çš„å­—æ®µã€‚

```
package com.demo.util;

import com.demo.api.Donut;
import org.bson.Document;

public class DonutMapper {

    /**
     * Map objects {@link Document} to {@link Donut}.
     *
     * @param donutDocument the information document.
     * @return A object {@link Donut}.
     */
    public static Donut map(final Document donutDocument) {
        final Donut donut = new Donut();
        donut.setId(donutDocument.getObjectId("_id"));
        donut.setFlavor(donutDocument.getString("flavor"));
        donut.setPrice(donutDocument.getDouble("price"));
        return donut;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååˆ›å»ºä¸€ä¸ª POJO æ¥æ“ä½œ MongoDB ä¸Šçš„ä¿¡æ¯ã€‚

```
package com.demo.api;
//imports ...
public class Donut implements Serializable {

    /** The id.*/
    @JsonSerialize(using = ObjectIdSerializer.class)
    private ObjectId id;

    /** The price. */
    @NotNull
    private double price;

    /** The principal flavor.*/
    @NotNull
    private String flavor;

    /**Constructor.*/
    public Donut() {
    }

//getters & setters
//hashcode, equals and toString methods 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­¤ç±»ä»…ç”¨äºå“åº”ç«¯ç‚¹ã€‚

```
package com.demo.api;
//imports ...
public class Response {
    /** The message.*/
    private String message;

    /** Constructor.*/
    public Response() {
    }
//getters & setters
//hashcode, equals and toString methods 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰æ›´å¤šä½¿ç”¨ Jackson å°†`org.bson.types.ObjectId`è½¬æ¢ä¸º`String`å¯¹è±¡çš„å®ç”¨ç¨‹åºç±»ã€‚

```
package com.demo.util;

import java.io.IOException;

import org.bson.types.ObjectId;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.SerializerProvider;

public class ObjectIdSerializer extends JsonSerializer<ObjectId> {
    @Override
    public void serialize(final ObjectId objectId, final JsonGenerator jsonGenerator,
                          final SerializerProvider serializerProvider) throws IOException {
        jsonGenerator.writeString(objectId.toString());
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨äºå°†`String`å¯¹è±¡è½¬æ¢ä¸º`char`çš„æ•°ç»„ã€‚

```
package com.demo.util;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.SerializerProvider;

import java.io.IOException;

public class PasswordSerializer extends JsonSerializer<String> {
    @Override
    public void serialize(final String input, final JsonGenerator jsonGenerator,
                          final SerializerProvider serializerProvider) throws IOException {
        jsonGenerator.writeString(input.toCharArray(), 0, input.toCharArray().length);
    }

    @Override
    public Class<String> handledType() {
        return String.class;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨è¿™äº› POJOs å°†ä¿¡æ¯ä¸`configuration.yml`è¿›è¡Œæ˜ å°„ã€‚

```
package com.demo.db.configuration;

import java.util.Arrays;
import java.util.Objects;

import com.demo.util.PasswordSerializer;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;

/**
 * This class is used for credentials.
 * @version 1.0.0
 * @since 1.0.0
 * @author Rich Lopez
 */
public class Credentials {

    /** The user name.*/
    private String username;

    /** The password.*/
    @JsonSerialize(using = PasswordSerializer.class)
    private char[] password;

    //getters, setters, hashcode and equals methods.
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
package com.demo.db.configuration;

import java.util.Objects;

public class Seed {

    /** The host.*/
    private String host;

    /** The port.*/
    private int port;
    //getters, setters, hashcode and equals methods.
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
package com.demo.db.configuration;

import java.util.List;

public class MongoDBConnection {

    /**
     * The credentials user and password.
     */
    private Credentials credentials;

    /**
     * The lis of seeds.
     */
    private List<Seed> seeds;

    /**
     * The db.
     */
    private String database;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†ç®¡ç†ä¸ MongoDB çš„è¿æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¥è‡ª yaml æ–‡ä»¶é…ç½®çš„ä¿¡æ¯æ˜ å°„åˆ°è¿™ä¸ªç±»`com.demo.db.configuration.Credentials`ã€`com.demo.db.configuration.MongoDBConnection`ã€`com.demo.db.configuration.Seed`ã€‚

ç±»`com.demo.db.MongoDBFactoryConnection`ä½¿ç”¨ yaml æ–‡ä»¶ä¸­æä¾›çš„é€‰é¡¹ä¸º MongoDB åˆ›å»ºå®¢æˆ·ç«¯ï¼Œåˆ›å»ºå®ä¾‹çš„æ–¹æ³•å¦‚ä¸‹:

```
package com.demo.db;
//imports ...
public class MongoDBFactoryConnection {

    /** The configuration for connect to MongoDB Server.*/
    private MongoDBConnection mongoDBConnection;

    /**
     * Constructor.
     *
     * @param mongoDBConnection the mongoDB connection data.
     */
    public MongoDBFactoryConnection(final MongoDBConnection mongoDBConnection) {
        this.mongoDBConnection = mongoDBConnection;
    }

    /**
     * Gets the connection to MongoDB.
     *
     * @return the mongo Client.
     */
    public MongoClient getClient() {
        LOGGER.info("Creating mongoDB client.");
        final Credentials configCredentials = mongoDBConnection.getCredentials();

        final MongoCredential credentials = MongoCredential.createCredential(
                configCredentials.getUsername(),
                mongoDBConnection.getDatabase(),
                configCredentials.getPassword());

        final MongoClient client = MongoClients.create(
                MongoClientSettings.builder()
                        .credential(credentials)
                        .applyToClusterSettings(builder -> builder.hosts(getServers())).build()
        );

        return client;
    }

    /**
     * Map the object {@link Seed} to objects {@link ServerAddress} that contain the information of servers.
     *
     * @return the list of servers.
     */
    private List<ServerAddress> getServers() {
        final List<Seed> seeds = mongoDBConnection.getSeeds();
        return seeds.stream()
                .map(seed -> {
                    final ServerAddress serverAddress = new ServerAddress(seed.getHost(), seed.getPort());
                    return serverAddress;
                })
                .collect(Collectors.toList());
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ Dropwizard ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯¹è±¡å¯ä»¥ç”±æ¥å£`io.dropwizard.lifecycle.Managed`å’Œç±»`io.dropwizard.lifecycle.MongoDBManaged`æ¥ç®¡ç†ã€‚

```
package com.demo.db;
//imports ...
public class MongoDBManaged implements Managed {

    /** The mongoDB client.*/
    private MongoClient mongoClient;

    /**
     * Constructor.
     * @param mongoClient   the mongoDB client.
     */
    public MongoDBManaged(final MongoClient mongoClient) {
        this.mongoClient = mongoClient;
    }

    @Override
    public void start() throws Exception {
    }

    @Override
    public void stop() throws Exception {
        mongoClient.close();
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦ä¸€ä¸ªé‡è¦çš„ç±»æ˜¯ Healthcheckï¼Œå› ä¸ºåˆ›å»ºè¿™ä¸ªç±»åªéœ€è¦ä»`com.codahale.metrics.health.HealthCheck`æ‰©å±•å¹¶å®ç°æ–¹æ³•`check`ã€‚

```
package com.demo.health;
//imports ...
public class DropwizardMongoDBHealthCheck extends HealthCheck {
     /** A client of MongoDB.*/
    private MongoClient mongoClient;

    /**
     * Constructor.
     *
     * @param mongoClient the mongo client.
     */
    public DropwizardMongoDBHealthCheck(final MongoClient mongoClient) {
        this.mongoClient = mongoClient;
    }
    @Override
    protected Result check() {
        try {
            final Document document = mongoClient.getDatabase("donuts").runCommand(new Document("buildInfo", 1));
            if (document == null) {
                return Result.unhealthy("Can not perform operation buildInfo in Database.");
            }
        } catch (final Exception e) {
            return Result.unhealthy("Can not get the information from database.");
        }
        return Result.healthy();
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªå¾®æœåŠ¡çš„å…¥å£ç‚¹æ˜¯ç±»`com.demo.DropwizardMongoDBMicroserviceApplication`åŠ è½½æ‰€æœ‰çš„åŒ…é…ç½®ã€åˆå§‹åŒ–ç±»ç­‰ã€‚è¯¥ç±»å¿…é¡»ä»`io.dropwizard.Application`æ‰©å±•ï¼Œå¹¶ç”±æ‰©å±•`io.dropwizard.Configuration`çš„ç±»æ¥å‚æ•°åŒ–ã€‚

```
package com.demo;

import com.demo.db.MongoDBFactoryConnection;
import com.demo.db.daos.DonutDAO;
import com.demo.db.MongoDBManaged;
import com.demo.health.DropwizardMongoDBHealthCheck;
import com.demo.resources.DonutResource;

import io.dropwizard.Application;
import io.dropwizard.setup.Bootstrap;
import io.dropwizard.setup.Environment;
import io.federecio.dropwizard.swagger.SwaggerBundle;
import io.federecio.dropwizard.swagger.SwaggerBundleConfiguration;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class DropwizardMongoDBMicroserviceApplication extends Application<DropwizardMongoDBMicroserviceConfiguration> {

    /**
     * Logger class.
     */
    private static final Logger LOGGER = LoggerFactory.getLogger(DropwizardMongoDBMicroserviceApplication.class);

    /**
     * Entry point for start Application.
     *
     * @param args the args.
     * @throws Exception when the app can not start.
     */
    public static void main(final String[] args) throws Exception {
        LOGGER.info("Start application.");
        new DropwizardMongoDBMicroserviceApplication().run(args);
    }

    @Override
    public String getName() {
        return "DropwizardMongoDBMicroservice";
    }

    @Override
    public void initialize(final Bootstrap<DropwizardMongoDBMicroserviceConfiguration> bootstrap) {
        bootstrap.addBundle(new SwaggerBundle<DropwizardMongoDBMicroserviceConfiguration>() {
            @Override
            protected SwaggerBundleConfiguration getSwaggerBundleConfiguration(
                        final DropwizardMongoDBMicroserviceConfiguration dropwizardMongoDBMicroserviceConfiguration) {
                return dropwizardMongoDBMicroserviceConfiguration.getSwaggerBundleConfiguration();
            }
        });
    }

    @Override
    public void run(final DropwizardMongoDBMicroserviceConfiguration configuration,
                    final Environment environment) {

        final MongoDBFactoryConnection mongoDBManagerConn = new MongoDBFactoryConnection(configuration.getMongoDBConnection());

        final MongoDBManaged mongoDBManaged = new MongoDBManaged(mongoDBManagerConn.getClient());

        final DonutDAO donutDAO = new DonutDAO(mongoDBManagerConn.getClient()
                .getDatabase(configuration.getMongoDBConnection().getDatabase())
                .getCollection("donuts"));

        environment.lifecycle().manage(mongoDBManaged);
        environment.jersey().register(new DonutResource(donutDAO));
        environment.healthChecks().register("DropwizardMongoDBHealthCheck",
                new DropwizardMongoDBHealthCheck(mongoDBManagerConn.getClient()));
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½¿ç”¨å‘½ä»¤æ„å»ºé¡¹ç›®:

`$ mvn clean package`

åœ¨å¯åŠ¨åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œéœ€è¦æœ‰æ•°æ®åº“ï¼Œæ‚¨å¯ä»¥ä»ç½‘ç«™ä¸‹è½½ MongoDB æˆ–ä½¿ç”¨ DockerHub ä¸­çš„ docker æ˜ åƒã€‚

ä¸€æ—¦ä¸‹è½½äº† MongoDB çš„é•œåƒï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨:

`$ docker run --name mongodb -d -p 27017:27017 mongo`

**æ³¨æ„:**ç¡®ä¿åˆ›å»ºä¸€ä¸ªå·æ¥ç»´æŠ¤ä¿¡æ¯çš„æŒä¹…æ€§ã€‚

è¾“å…¥å®¹å™¨å¹¶é”®å…¥ä»¥ä¸‹å‘½ä»¤:

`$ docker exec -it [container name or id] /bin/bash`
`$ mongo`
`$ use donuts`

é»˜è®¤æƒ…å†µä¸‹ï¼ŒMongoDB å°†èº«ä»½éªŒè¯æœºåˆ¶è®¾ç½®ä¸º SCRAMã€‚

ç°åœ¨ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ç¨‹åº:

`$ java -jar target/dropwizard-mongodb-ms-1.0.0-SNAPSHOT.jar server configuration.yml`

ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†ç”¨æˆ·å’Œæ•°æ®åº“ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸‹é¢çš„ URL ä¸­è¾“å…¥ swagger æ–‡æ¡£:

*[http://localhost:8080/drop wizard-MongoDB-ms/swagger](http://localhost:8080/dropwizard-mongodb-ms/swagger)T3ã€‘*

[![Swagger Documentation](../Images/297e9442bef9f8ff5dd1128edcc02224.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--jhquB277--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://raw.githubusercontent.com/ricdev2/dropwizard-mongodb-ms/master/imgs/swagger.png)

### [](#using-docker-compose)ä½¿ç”¨ docker æ’°å†™ğŸ³

æ¯å¤©ä½¿ç”¨ docker çš„åŸå› ä¹‹ä¸€æ˜¯å› ä¸ºå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç‹¬ç‰¹çš„ç¯å¢ƒï¼Œå¹¶ä¸”æ‰€æœ‰å¼€å‘äººå‘˜éƒ½ä¿æŒä¾èµ–å…³ç³»ã€æ•°æ®åº“ã€web æœåŠ¡å™¨ç­‰åŒæ­¥ã€‚æ„å»ºå’Œéƒ¨ç½²å·¥ä»¶çš„ç®€å•æ–¹æ³•å‡å°‘äº†äº¤ä»˜æ—¶é—´ã€‚

æˆ‘ä½¿ç”¨ docker æ¥å¯åŠ¨åº”ç”¨ç¨‹åºå’Œ MongoDB æœåŠ¡å™¨ï¼Œæ­¤å¤–æˆ‘è¿˜æ·»åŠ äº† *Nginx ä»£ç†*æ¥æ¥æ”¶è¯·æ±‚ï¼Œè¿™æ˜¯ docker ç¼–å†™æ–‡ä»¶çš„ä¸€ä¸ªä¾‹å­:

```
version: '3'
services:
  mongodb:
    image: mongo
    restart: always
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin
    ports:
      - 27017:27017
    networks:
      - dropw-mongodb-ntw

  nginx:
    image: nginx
    container_name: nginx
    volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
    - "8080:80"
    - "443:443"
    networks:
    - dropw-mongodb-ntw

  dropw-ms:
    image: openjdk:8-jre
    container_name: dropw-ms
    volumes:
    - ./target/dropwizard-mongodb-ms-1.0.0-SNAPSHOT.jar:/microservice/dropwizard-mongodb-ms-1.0.0-SNAPSHOT.jar
    - ./configuration.yml:/microservice/configuration.yml
    working_dir: /microservice
    command: ["java", "-jar", "dropwizard-mongodb-ms-1.0.0-SNAPSHOT.jar", "server", "configuration.yml"]
    ports:
    - "8090:8080"
    - "8091:8081"
    networks:
    - dropw-mongodb-ntw

networks:
  dropw-mongodb-ntw:
    external:
      name: dropw-mongodb-ntw 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º docker ç½‘ç»œ:

`docker network create dropw-mongodb-ntw`

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé¡¹ç›®:

`$ mvn clean package`

å¼€å§‹åç«™ç»„æˆ:

`$ docker-compose up`

ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†ä¸ºæ•°æ®åº“åˆ›å»ºç”¨æˆ·æ‰€éœ€çš„æ‰€æœ‰æœåŠ¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¿é—®å®¹å™¨ã€‚

`$ docker exec -it [container name or id] /bin/bash`
`$ mongo`
`> use donuts`

*[http://localhost:8080/drop wizard-MongoDB-ms/swagger](http://localhost:8080/dropwizard-mongodb-ms/swagger)T3ã€‘*

## [](#conclusion)ç»“è®º

Dropwizard ä¸ºæˆ‘ä»¬æä¾›äº†å‡ ä¸ªå·¥å…·ï¼Œè®©æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åˆ›å»ºå¾®æœåŠ¡ã€‚æ‚¨å¯ä»¥é€šè¿‡ç¤ºä¾‹ä¸å…¶ä»–æŠ€æœ¯é›†æˆï¼Œå¦‚ MongoDBã€Dockerã€Nginxã€‚è¯·è®°ä½ï¼Œè¿™ä¸€åˆ‡éƒ½å–å†³äºéœ€æ±‚å’Œè¦è§£å†³çš„é—®é¢˜ï¼Œä½†å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹å’Œåˆ†äº«ç»éªŒã€‚

Github åº“:[https://github.com/ricdev2/dropwizard-mongodb-ms](https://github.com/ricdev2/dropwizard-mongodb-ms)