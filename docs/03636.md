# ä½¿ç”¨ Varnish å’Œ ESI ç‰‡æ®µå°†ç½‘ç«™å“åº”æ—¶é—´é™¤ä»¥ 100

> åŸæ–‡:# t0]https://dev . to/silar ri/é™¤ä»¥æ‚¨ç½‘ç«™çš„å›å¤æ—¶é—´-par-100-with-varnish-et-les-fragments-ESI-46 KD

åº”ç”¨ç¨‹åºç¼“å­˜æ˜¯æœ€å¤§é™åº¦åœ°ç¼©çŸ­ç«™ç‚¹å“åº”æ—¶é—´çš„é¦–é€‰è§£å†³æ–¹æ¡ˆã€‚åªéœ€åœ¨æ­¤å¤„æ‰¾åˆ°ç¼©çŸ­ç½‘ç«™å“åº”æ—¶é—´çš„çœŸæ­£è§£å†³æ–¹æ¡ˆï¼Œåªæœ‰ 1%çš„äººçŸ¥é“è¯¥è§£å†³æ–¹æ¡ˆã€‚

å¦‚æœä½ å†çœ‹è¿™äº›å°è¯ï¼Œé‚£å°±æ˜¯æˆ‘åšçš„å¾ˆå¥½çš„æŒ‘é€—å·¥ä½œä¸‹é¢æ˜¯ç¼©çŸ­æ‚¨ç«™ç‚¹å“åº”æ—¶é—´çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆ:**ä¸è¦ç»™æ‚¨çš„ç«™ç‚¹æ‰“ç”µè¯**ã€‚

<figure>[![Mais quelle drÃ´le d'idÃ©e.](../Images/01bcd7ad4eec0bea6720be1d7551e6eb.png)](https://i.giphy.com/media/ODU1I5zAgOwX6/source.gif) 

<figcaption>ä½†è¿™ä¸»æ„çœŸæœ‰è¶£ã€‚</figcaption>

</figure>

å¯åŠ¨åç«¯å¹¶è¿”å›å®¢æˆ·å“åº”ï¼Œå³ä½¿ä½¿ç”¨äº†æœ€æ–°çš„è¶…çº§æ¡†æ¶ï¼Œä¹Ÿæ˜¯è€—æ—¶ä¸”æˆæœ¬é«˜æ˜‚çš„ã€‚æ¡†æ¶å¼•å¯¼ã€æ•°æ®åº“è¿æ¥ã€é‡å®šå‘æœåŠ¡å™¨ã€ç”¨æˆ·æƒé™æ£€æŸ¥ã€æ¨¡æ¿å¼•æ“ç­‰ã€‚ä¸éœ€è¦å¤ªå¤§çš„å‹åŠ›ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿæ¢å¤ 200 æ¯«ç§’çš„å†…å®¹ã€‚

ğŸ¤“*é‚£ä¹ˆæ€æ ·æ‰èƒ½ç¼©çŸ­æˆ‘çš„ååº”æ—¶é—´å‘¢ï¼Ÿæˆ‘æ˜¯å¦éœ€è¦æŠ•èµ„ï¼Œæå‡æˆ‘çš„åˆ¶é€ æœåŠ¡å™¨ï¼Œå¹¶ä½¿å‘ç¥¨é‡‘é¢åŠ å€ï¼Ÿ*

**ä¸€ç‚¹ä¹Ÿä¸ï¼**æƒ³æ³•æ˜¯å……åˆ†åˆ©ç”¨ HTTP ç¼“å­˜å­˜å‚¨åç«¯ç”Ÿæˆçš„ HTML æ¸²æŸ“ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ç©â€˜T2â€™varnishâ€™T3â€™è¿™ä¸ªç”¨ c å†™çš„è¶…å¼ºå¤§çš„åå‘ä»£ç†ã€‚è¿™é‡Œæ‰€è¯´çš„æ˜¯â€˜T4â€™çš„é¡ºåºå“åº”æ—¶é—´ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨è¯¥é¡µé¢ï¼Œåˆ™ä¸ºâ€˜t5â€™çš„å‡ æ¯«ç§’ã€‚

Varnish çš„åŸç†ç›¸å½“ç®€å•:åå‘ä»£ç†æ˜¯ç”¨æˆ·æŸ¥è¯¢çš„å‰æ²¿ã€‚å¦‚æœå·²æœ‰è¯¥è¯·æ±‚çš„ç­”æ¡ˆï¼Œåˆ™åªéœ€å‘å‡ºè¯¥è¯·æ±‚å³å¯ã€‚å¦åˆ™ï¼Œå®ƒä¼šå°†è¯·æ±‚è½¬å‘åˆ°åç«¯å¹¶å­˜å‚¨ç»“æœã€‚å°±è¿™ä¹ˆç®€å•ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•æŠŠè¿™ç§æµåŠ¨å˜æˆç°å®ã€‚

<figure>[![Divisez le temps de rÃ©ponse de votre site Web par 100 avec Varnish et les fragments ESI](../Images/cc574e900cd491a31eab3dd1e385198b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--_nl0DvKZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.silarhi.fr/content/images/2019/05/introduction-to-varnish-vcl-6-1024.jpg) 

<figcaption>ç“¦è®·çš„ç®€å•åŸç†</figcaption>

</figure>

## [](#cest-parti)å¼€å§‹äº†

å› æ­¤ï¼Œæˆ‘ä»¬çš„æƒ³æ³•æ˜¯å°† Varnish æ”¾åœ¨ç”¨æˆ·æŸ¥è¯¢çš„å‰é¢ã€‚ç°åœ¨ï¼Œä»–å°†ç›‘å¬ç«¯å£ 80ï¼Œå¹¶å°†è¯·æ±‚å‘é€åˆ°æ‚¨çš„ Web æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ä¸€ç›´å¤„äºå‰ç«¯ã€‚

ç¬¬ä¸€æ­¥æ˜¯æ›´æ”¹åç«¯ä¾¦å¬ç«¯å£ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Apacheï¼Œæˆ‘ä»¬å°†æ›´æ”¹é…ç½®:

```
Listen 80 
```

æ ‡å‡†æ†

```
Listen 8000 
```

è¯·è®°ä½ Web æœåŠ¡å™¨çš„æ–°ä¾¦å¬ç«¯å£ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®‰è£…ç“¦å°”å¾·çº³ä»€ã€‚è½¬åˆ° packagecloud å¹¶æŒ‰ç…§æ‚¨çš„å‘è¡Œç‰ˆä¸­çš„è¯´æ˜è¿›è¡Œæ“ä½œ:https://package cloud . io/varniscacheã€‚

## [](#un-premier-exemple-du-contenu-statique)ç¬¬ä¸€ä¸ªä¾‹å­:é™æ€å†…å®¹

Varnish ä½¿ç”¨è‡ªå·±çš„é…ç½®è¯­è¨€(VCL)ï¼Œç„¶åå°†å…¶ç¼–è¯‘ä¸º cã€‚è¿™æ˜¯ä¸€ä¸ªä½çº§æ¯›å‘ï¼Œä½†æ˜¯ä¸€æ—¦é…ç½®å¥½ï¼Œæ‚¨å°±å¯ä»¥å°†æ³•æ‹‰åˆ©å¼•æ“æ”¾å…¥æ‚¨çš„ 2 CV ä¸­ã€‚

æˆ‘ä»¬å…ˆä»æœ€å° VCL å¼€å§‹:

```
vcl 4.0;

backend default {
    .host = "127.0.0.1"; 
    .port = "8000"; # Le port d'Ã©coute de votre backend (Apache, Nginx, ...)
}

# AppelÃ© Ã  la fin de chaque rÃ©ponse (en cache ou non)
sub vcl_deliver {
    if (obj.hits > 0) {
        set resp.http.X-Cache = "HIT";
    } else {
        set resp.http.X-Cache = "MISS";
    }

    set resp.http.X-Cache-Hits = obj.hits;

    return (deliver);
} 
```

èŠ±ç‚¹æ—¶é—´ç†Ÿæ‚‰è¯­æ³•å’Œé…ç½®ã€‚åœ¨æ­¤ï¼ŒVarnish è¢«å‘ŠçŸ¥ï¼Œç«¯å£ 8000 ä¸Šæœ‰ä¸€ä¸ªåç«¯(ç¼ºçœ)å¯ä» 127.0.0.1 è®¿é—®(è¯·è®°ä½ï¼Œè¿™æ˜¯ Web æœåŠ¡å™¨çš„æ–°ä¾¦å¬ç«¯å£)ã€‚è¿˜è®¾ç½®äº†ä¸€ä¸ªåä¸º *X-Cache* çš„åº”ç­”å¤´ï¼Œä»¥ç¡®å®šæ˜¯å¦å·²ä»ç¼“å­˜ä¸­æ£€ç´¢åˆ°åº”ç­”ã€‚ç¬¬ä¸€æ¬¡è®¿é—®æˆ‘ä»¬çš„ç«™ç‚¹ä¸»é¡µæ¥éªŒè¯ç»“æœ:

<figure>[![Divisez le temps de rÃ©ponse de votre site Web par 100 avec Varnish et les fragments ESI](../Images/5c6b2c6e036d11c4d6d0873928a3c9bd.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--A5L8K_vT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.silarhi.fr/content/images/2019/07/image-1.png) 

<figcaption>ç¬¬ä¸€æ¬¡æŸ¥è¯¢:Varnish æ²¡æœ‰ç¼“å­˜</figcaption>

</figure>

ç”±äºè¿™æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®èµ„æºï¼Œå› æ­¤ Varnish åœ¨å…¶ç¼“å­˜ä¸­æ²¡æœ‰ç­”æ¡ˆï¼Œè¿™æ˜¯åˆä¹é€»è¾‘çš„ã€‚å› æ­¤ï¼Œå®ƒä¼šæ­£å¸¸è°ƒç”¨åç«¯ï¼Œå¹¶å°†ç»“æœå­˜å‚¨ 120 ç§’(è¿™æ˜¯ Varnish çš„é»˜è®¤è®¾ç½®ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ”¹)ã€‚å¦‚æœä½ åˆ·æ–°é¡µé¢ï¼Œä½ ä¼šå‘ç°ç“¦è®·çš„ååº”ä¸åŒ:

<figure>[![Divisez le temps de rÃ©ponse de votre site Web par 100 avec Varnish et les fragments ESI](../Images/e0512d38d460767c3ec1ee7175326895.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--LcYtgw8o--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.silarhi.fr/content/images/2019/07/image-2.png) 

<figcaption>ç¬¬äºŒä¸ªæŸ¥è¯¢:Varnish ç›´æ¥è¿”å›</figcaption>

</figure>

çš„å›ç­”

å¤ªå¥½äº†ï¼Varnish ç›´æ¥è¿”å›äº†ä»–åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚ä¸­å­˜å‚¨çš„ç»“æœã€‚æœªè¯·æ±‚åç«¯ï¼Œæ‚¨å°†æ— æ³•åœ¨ Web æœåŠ¡å™¨æ—¥å¿—ä¸­æ‰¾åˆ°ä»»ä½•è®¿é—®è®°å½•ã€‚**å®ƒå¼€å§‹çœ‹èµ·æ¥æœ‰äº›ä¸œè¥¿ã€‚**

ğŸ¤“*ä½†æ˜¯å¦‚æœæˆ‘çš„å†…å®¹å› ç”¨æˆ·è€Œå¼‚-æˆ‘...ã€‚æˆ‘ä¸æƒ³æŠŠåŒæ ·çš„å†…å®¹è¿˜ç»™å¤§å®¶æ€ä¹ˆåšï¼Ÿ*

è¿™å°±æ˜¯ ESI ç‰‡æ®µå‘ç”Ÿçš„åœ°æ–¹ã€‚

## [](#mettre-en-cache-des-fragments-de-page-avec-esi)ä½¿ç”¨ ESI ç¼“å­˜é¡µé¢ç‰‡æ®µ

ä½¿ç”¨ edge side includes)ç¼“å­˜å—å¯ä»¥ç¼“å­˜é¡µé¢çš„éƒ¨åˆ†ã€‚è¯¥è§„èŒƒæ˜¯ Akamai åå¹´å‰ç¼–å†™çš„ï¼Œç›®çš„æ˜¯ä¸ºâ€œå—â€åˆ¶å®šä¸åŒçš„ç¼“å­˜ç­–ç•¥ã€‚ä¾‹å¦‚:æˆ‘çš„é¡µé¢æœ‰ç”¨æˆ·ä¸“ç”¨çš„èœå•*ã€nav barã€‘*ã€‚æˆ‘é¡µé¢çš„å…¶é¦€éƒ¨åˆ†å¯¹æ¯ä¸ªäººéƒ½ä¸€æ ·å› æ­¤ï¼Œæˆ‘å¯ä»¥å»ºç«‹ä¸€ä¸ªåŒ…å«èœå•å’Œç¼“å­˜æ‰€æœ‰å…¶ä»–å†…å®¹çš„å—ã€‚

ç†è®ºä¸Šæ¥è¯´ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ƒå¦‚ä½•è½¬åŒ–ä¸ºä¸€ä¸ªåº”ç”¨ç¨‹åº:

```
<!DOCTYPE html>
<html>
    <body>
        <h1>Ma super app</h1>

        <!-- Le bloc du ESI est dÃ©fini lÃ  -->
        <esi:include src="/mon-menu-prive.php"/>
    </body>
</html> 
```

å°±è¿™ä¹ˆç®€å•ï¼é™¤äº†ç”±åå‘ä»£ç†(Varnish)å‘å‡ºè¯·æ±‚å¤–ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºå¯¹æ¯ä¸ªå—å‘å‡ºçš„ Ajax è°ƒç”¨ã€‚ä¸åŒä¹‹å¤„åœ¨äºå­æŸ¥è¯¢æ˜¯ç”±æœåŠ¡å™¨è€Œä¸æ˜¯å®¢æˆ·ç«¯æ‰§è¡Œçš„ã€‚

### [](#un-cas-d%C3%A9tude-concret)ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹ç ”ç©¶

æˆ‘ä»¬å°†è®¾ç½®ä¸€ä¸ªå…·ä½“çš„é¡µé¢ï¼Œå®ƒå°†ç”±å‡ ä¸ªå—ç»„æˆã€‚æŸäº›åŒºå—ä¼šå› ä½¿ç”¨è€…è€Œå¼‚(ä¾‹å¦‚åŠŸèƒ½è¡¨)ï¼Œè€Œå…¶ä»–åŒºå—åˆ™ä¸ºå…¬ç”¨åŒºå—ã€‚åŒºå—å¿«å–æ—¶é—´ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚

ä¸ªæ¡ˆç ”ç©¶:[å¯ç”¨ç¤ºèŒƒ](https://labs.silarhi.fr/esi)

<figure>[![Divisez le temps de rÃ©ponse de votre site Web par 100 avec Varnish et les fragments ESI](../Images/438ab1eaf3a11fa37cbf4687a231e960.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--Qb_ewIvB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.silarhi.fr/content/images/2019/07/Screenshot-2019-07-19-at-13.06.00.png) 

<figcaption>ä½©æœè¿™äº›ç¾ä¸½çš„è¾¹æ¡†</figcaption>

</figure>

è®©æˆ‘ä»¬è¿›å…¥ä¸»é¢˜çš„æ ¸å¿ƒï¼Œè¿™æ˜¯ä»£ç :

```
<?php // index.php
    header('Surrogate-Control: abc=ESI/1.0');
    header("X-Reverse-Proxy-TTL: 10");
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Ma super page</title>
</head>
<body class="public cached p-2">
    <esi:include src="/menu.php"/>
    <div class="container">
        <esi:include src="/time.php"/>
        <div class="row">
            <div class="col-md-8 col-lg-9">
                <h1>Page de contenu public</h1>
                <p class="lead">Mise en cache le <span class="badge badge-secondary"><?= date('d/m/Y H:i:s') ?></span> (10s)</p>
            </div>
            <div class="col-md-4 col-lg-3">
                <esi:include src="/user.php"/>
                <esi:include src="/sidebar.php"/>
            </div>
        </div>
    </div>
</body>
</html> 
```

è¯·ä¸è¦è¿‡äºä¸“æ³¨äºæ­¤ä»£ç çš„ç»†èŠ‚ï¼Œåªéœ€è®¾æƒ³ä¸€ä¸‹åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½®è‡ªå·±çš„å—å³å¯ã€‚

é™¤äº†è¿™ä¸ªè´¨é‡è®¾è®¡å¤–ï¼Œä½ å¤§æ¦‚å·²ç»ç¡®å®šäº†å››ä¸ªè¡—åŒºã€‚é¡¶éƒ¨çš„èœå•(menu.php)ã€å¸¦æœ‰å›¾ä¾‹çš„æœåŠ¡å™¨æ—¶é—´(time.php)ã€ä¸Šæ¬¡ç™»å½•æ—¶é—´(user.php)å’Œå°éƒ¨ä»¶(sidebar.php)ã€‚4 ä¸ªåŒºå—ä»£è¡¨ 4 ä¸ªä¸åŒçš„å¿«å–åŸåˆ™ã€‚å°† Varnish ä¸­çš„é…ç½®ä¸é€šè¿‡åç«¯å‘é€ HTTP å“åº”ç›¸ç»“åˆï¼Œå¯ä»¥å®ç°æˆ‘ä»¬çš„ 4 ä¸ªç­–ç•¥ã€‚

### [](#configuration-dans-varnish)é…ç½®ä¸¹æ¸…æ¼†

```
# /etc/varnish/default.vcl
vcl 4.0;

import std;
import directors;

backend default {
    .host = "127.0.0.1";
    .port = "8000"; # Le port d'Ã©coute de votre serveur Apache / Nginx
}

# AppelÃ© au dÃ©but de chaque requÃªte
sub vcl_recv {
    # Pas de mise en cache pour les mÃ©thodes type POST / DELETE
    if (req.method != "GET" && req.method != "HEAD") {
        return (pass);
    }

    # On supprime les cookies sur les pages publiques (cf vcl_hash)
    if(! req.url ~ "^/(login|logout|menu|user)\.php") {
        unset req.http.Cookie;
    }

    # On supprime tous les autres cookies que PHPSESSID pour les pages privÃ©es
    if (req.http.Cookie) {
        set req.http.Cookie = regsuball(req.http.Cookie, "; +", ";");
        set req.http.Cookie = regsuball(req.http.Cookie, ";(PHPSESSID)=", "; \1=");
        set req.http.Cookie = regsuball(req.http.Cookie, ";[^][^;]*", "");
        set req.http.Cookie = regsuball(req.http.Cookie, "^[;]+|[;]+$", "");
        set req.http.Cookie = regsuball(req.http.Cookie, "^;\s*", "");

        if (req.http.Cookie ~ "^\s*$") {
            unset req.http.Cookie;
        }
    }

    return (hash);
}

# AppelÃ© pour calculer un hash de la requÃªte
sub vcl_hash {
    hash_data(req.url);

    if (req.http.host) {
        hash_data(req.http.host);
    } else {
        hash_data(server.ip);
    }

    if (req.http.Cookie) {
        hash_data(req.http.Cookie);
    }
}

# AppelÃ© si le hash a Ã©tÃ© trouvÃ© (= page en cache)
sub vcl_hit {
    if (obj.ttl >= 0s) {
        return (deliver);
    }

    return (miss);
}

# AppelÃ© au retour de la rÃ©ponse par le backend
sub vcl_backend_response {
    # L'entÃªte est envoyÃ©e par index.php
    if (beresp.http.Surrogate-Control ~ "ESI/1.0") {
        unset beresp.http.Surrogate-Control;
        set beresp.do_esi = true;
    }

    # Notre fameuse entÃªte custom
    if (beresp.http.X-Reverse-Proxy-TTL) {
        set beresp.ttl = std.duration(beresp.http.X-Reverse-Proxy-TTL + "s", 0s);
        unset beresp.http.X-Reverse-Proxy-TTL;
    }

    return (deliver);
}

# AppelÃ© Ã  la fin de chaque rÃ©ponse (en cache ou non)
sub vcl_deliver {
    if (obj.hits > 0) {
        set resp.http.X-Cache = "HIT";
    } else {
        set resp.http.X-Cache = "MISS";
    }

    set resp.http.X-Cache-Hits = obj.hits;

    return (deliver);
} 
```

åœ¨æ­¤é…ç½®ä¸­æœ‰å‡ ä¸ªå…³é”®æ¦‚å¿µéœ€è¦äº†è§£ã€‚å…¶å®è´¨æ€æƒ³æ˜¯ä¸ºæ¯ä¸ªæŸ¥è¯¢/å­æŸ¥è¯¢ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„æ•£åˆ—ã€‚æ­¤æ•£åˆ—å€¼å¿…é¡»å–å†³äºä¸“ç”¨å—çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œè€Œå…¬ç”¨å—çš„æ•£åˆ—å€¼å¹¶éå¿…éœ€çš„ã€‚åœ¨ PHP ä¸­ï¼Œç”¨æˆ·é€šè¿‡ phpsessid cookie è¿æ¥åˆ°æœåŠ¡å™¨ä¼šè¯ã€‚ä¸ºäº†åœ¨æˆ‘ä»¬æ„Ÿå…´è¶£çš„é¡µé¢ä¸Šç”Ÿæˆè¿™ç§è‘—åçš„å”¯ä¸€æ•£åˆ—å€¼ï¼Œå¿…é¡»ä¿ç•™ cookie å€¼ã€‚å¯¹äºå…¶å®ƒé¡µé¢ï¼Œæ‚¨å¯ä»¥åˆ é™¤æ­¤ cookieï¼Œä»¥æœ€å¤§é™åº¦åœ°æé«˜å…¶ä»–ç”¨æˆ·å‘é€ç¼“å­˜å†…å®¹çš„å¯èƒ½æ€§ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šåˆ é™¤åç«¯æ— ç”¨çš„ cookies(å¦‚ Google Analytics ç­‰)ï¼Œè¿™æ ·å¯ä»¥é™ä½åƒåœ¾é‚®ä»¶çš„å‘½ä¸­ç‡ã€‚å½“ç„¶ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰ vcl_recv åŠŸèƒ½ã€‚

ä¸‹å›¾æ¸…æ¥šåœ°æ¦‚è¿°äº†æˆ‘ä»¬å¿…é¡»é‡‡å–è¡ŒåŠ¨çš„å„ä¸ªæ­¥éª¤:

<figure>[![Divisez le temps de rÃ©ponse de votre site Web par 100 avec Varnish et les fragments ESI](../Images/cfda0bbee00a6b0a6314b10e8cfeedb1.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--cctWs6fY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.silarhi.fr/content/images/2019/05/simplified_fsm.svg) 

<figcaption>å­¦åˆ†:[ã€ç“¦å°”å¾·çº³ä»€åŸºç¡€ã€‘](https://book.varnish-software.com/4.0/chapters/VCL_Basics.html)</figcaption>

</figure>

### ã€sidebar.phpã€‘T2

```
<?php //sidebar.php
    header("X-Reverse-Proxy-TTL: 20");
?>
<div class="public cached p-2">
    <h1>Widgets publics</h1>
    <p class="lead">
        Mise en cache le <span class="badge badge-secondary"><?= date('d/m/Y H:i:s') ?></span> (20s)
    </p>
</div> 
```

åŒºå—å¿«å–åŸåˆ™:å¿«å– 20 ç§’çš„å…¬ç”¨å†…å®¹ã€‚

æ­£æ˜¯å¤´éƒ¨`X-Reverse-Proxy-TTL`å°†ç»™å‡ºç“¦å°”å¾·çº³æ–¯çš„ç¼“å­˜æ—¶é—´ã€‚è¿™ä¸ªå¤´**ä¸æ˜¯æ ‡å‡†**ã€‚æœ¬æ¥å¯ä»¥åœ¨æ ‡å‡†å¤´`Cache-Control`ä¸Šç©ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªä¸»è¦çš„ç¼ºç‚¹:**ä½¿ç”¨æŒ‡ä»¤`Cache-Control: public, smax-age=20`æ— æ³•æ§åˆ¶ç¼“å­˜**çš„ä¼ æ’­ã€‚æ˜¯çš„ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¯èƒ½è¿˜æœ‰å…¶ä»–ä»£ç†æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨æ­¤æŒ‡ä»¤ç¼“å­˜ HTML å†…å®¹ã€‚å¦‚æœæ‚¨åœ¨ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¸­è®¾ç½®äº†è¾ƒå¤§çš„ TTL å€¼ï¼Œæ‚¨å°†æ— æ³•æ§åˆ¶æ›´æ–°ã€‚æœ€å¥½ä¿æŒå¯¹å†…å®¹ä¼ æ’­çš„æŒæ§ã€‚å¦ä¸€æ–¹é¢ï¼Œå¯¹äºå›¾åƒ/CSS/JS ç±»å‹çš„å†…å®¹ï¼Œå¦‚æœæ‚¨æŒæ¡äº† busting ç¼“å­˜ï¼Œè¯·ä½¿ç”¨è¾ƒå¤§çš„ TTL ä½¿ cache-public control æˆä¸ºå¯èƒ½ã€‚

### menu.php

```
<?php //menu.php
    session_start();
    header("X-Reverse-Proxy-TTL: 60");
?>
<nav class="navbar navbar-expand-lg navbar-light bg-light private cached">
    <div class="container">
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <?php if (isset($_SESSION['logged'])): ?>
                    <li class="navbar-text">
                        <span class="badge badge-success">ConnectÃ©</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="logout.php">DÃ©connexion</a>
                    </li>
                <?php else: ?>
                    <li class="navbar-text">
                        <span class="badge badge-danger">Anonyme</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.php">Connexion</a>
                    </li>
                <?php endif; ?>
            </ul>
            <span class="navbar-text">
                Mise en cache le <span class="badge badge-secondary"><?= date('d/m/Y H:i:s') ?></span> (60s)
            </span>
        </div>
    </div>
</nav> 
```

å—é«˜é€Ÿç¼“å­˜ç­–ç•¥:é«˜é€Ÿç¼“å­˜ 60 ç§’çš„ä¸“ç”¨å†…å®¹ã€‚

å°†ç›´æ¥åœ¨ Varnish ä¸­æŒ‰ç”¨æˆ·ç®¡ç†å†…å®¹ç¼“å­˜ã€‚é—®é¢˜æ˜¯åœ¨è®¡ç®—æ­¤å—çš„æŸ¥è¯¢çš„â€œæ•£åˆ—â€æ—¶åŒ…æ‹¬ç”¨æˆ·çš„ phpsessid è¿™æ˜¯æˆ‘ä»¬åœ¨ vcl_recv æ–¹æ³•ä¸­æ‰€åšçš„ã€‚

### time.php

```
<?php //time.php ?>
<div class="text-center p-2 public">
    <p class="lead text-center">Heure serveur : <span class="badge badge-secondary"><?= date('d/m/Y H:i:s') ?></span> (pas de cache)</p>
    <div class="row">
        <div class="col-3"><span class="public p-1">Public</span></div>
        <div class="col-3"><span class="public cached p-1">Public + cache</span></div>
        <div class="col-3"><span class="private p-1">PrivÃ©</span></div>
        <div class="col-3"><span class="private cached p-1">PrivÃ© + cache</span></div>
    </div>
</div> 
```

åŒºå—å¿«å–åŸåˆ™:ä¸å«ç‰¹æ®Šå¿«å–çš„å…¬ç”¨å†…å®¹ã€‚

ç³»ç»Ÿä¸ºæ­¤å—è°ƒç”¨åç«¯(æˆ‘å·²å°† Varnish çš„åŸºæœ¬é…ç½®æ›´æ”¹ä¸ºé»˜è®¤ ttl ç§’)ã€‚

### user.php

```
<?php //user.php
    session_start();
?>
<br />
<div class="private p-2">
    <?php if($_SESSION['logged'] ?? false): ?>
        DerniÃ¨re connexion il y a <?= time() - $_SESSION['last_login'] ?>s
    <?php else: ?>
        Pas de derniÃ¨re connexion
    <?php endif; ?>
</div> 
```

å—é«˜é€Ÿç¼“å­˜ç­–ç•¥:ä¸å«ç‰¹æ®Šé«˜é€Ÿç¼“å­˜çš„ä¸“ç”¨å†…å®¹ã€‚

ç³»ç»Ÿåœ°ä¸ºæ­¤å—è°ƒç”¨åç«¯ã€‚

### login.php

```
<?php // login.php

session_start();
$_SESSION['logged'] = true;
$_SESSION['last_login'] = time();

header('Location: /', true, 301); 
```

æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„æˆ‘ä»¬åœ¨ä¸€ä¸ªéå¸¸ä¼ ç»Ÿçš„å®¶åº­ç™»å½•ç³»ç»Ÿé‡Œã€‚

### logout.php

```
<?php // logout.php

if ( isset( $_COOKIE[session_name()] ) ) {
    setcookie( session_name(), "deleted", time()-3600, "/");
}

session_start();
session_destroy();

header('Location: /', true, 301); 
```

è¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹ç‚¹:**PHP ä¼šè¯ä¸­çš„ cookie** è¢«å®Œå…¨é”€æ¯ï¼Œè¿™æ · Varnish å°±ä¸ä¼šå°†ä¸å†å­˜åœ¨çš„æ—§ç¼“å­˜ç”¨æˆ·å†…å®¹è¿”å›ç»™æˆ‘ä»¬ã€‚

æˆ‘ä»¬äº†è§£äº†å¦‚ä½•æ ¹æ®é¡µé¢çš„å—ç±»å‹è®¾ç½®ä¸åŒçš„ç¼“å­˜ç­–ç•¥ã€‚åˆ«å¿˜äº†ä½¿ç”¨ ESI ç‰‡æ®µçš„ HTTP å¿«å–æ¦‚å¿µï¼Œå¹¶å¹¿æ³›ä½¿ç”¨å®ƒæ¥å¤§å¹…ç¼©çŸ­ç¾ä¸½ç½‘é¡µçš„å›åº”æ—¶é—´ã€‚

### [](#pour-aller-plus-loin)è¦æ›´è¿›ä¸€æ­¥

[ä½¿ç”¨çš„ç¤ºä¾‹æ¼”ç¤º](https://labs.silarhi.fr/esi)

[ã€æ¼”ç¤ºæºä»£ç è¦æ¸…æ¥šç†è§£(ä½¿ç”¨åç«™)](https://github.com/silarhi/labs.silarhi.fr/tree/master/esi)
[ã€ç“¦å°”çº³å®˜æ–¹æ–‡çŒ®ã€‘](https://varnish-cache.org/docs/4.1/users-guide/index.html)