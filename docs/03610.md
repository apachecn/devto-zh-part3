# ç”Ÿäº§ååº”åº”ç”¨çš„åŸå› ï¼ŸğŸ¤”(ç¬¬ä¸‰éƒ¨åˆ†)

> åŸæ–‡:[https://dev . to/seif _ ghe zala/reason ml-for-production-react-apps-part-3-3368](https://dev.to/seif_ghezala/reasonml-for-production-react-apps-part-3-3368)

ä¸ä¹…å‰ï¼Œæˆ‘å‘è¡¨äº†è¿™ç¯‡å…³äºåœ¨ React ä¸­æ„å»ºä¸€ä¸ªå¯è®¿é—®å’Œå¯é‡ç”¨çš„æ¨¡æ€/å¯¹è¯æ¡†ç»„ä»¶çš„æ–‡ç« ã€‚

[![React modal](../Images/e9d467bfdd6d4e5edeeceb38a9ab11e6.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--OXMjfhPY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ja0duaz4tejuxqr3yadt.gif) 

<figure>

<figcaption>ååº”æ¨¡æ€</figcaption>

</figure>

è¯¥ç»„ä»¶æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

*   ä¸€ä¸ªå¯é‡ç”¨çš„ç»„ä»¶ API:æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåœ¨ä»»ä½•åœ°æ–¹è½»æ¾åœ°ä½¿ç”¨æˆ‘ä»¬çš„å¯è®¿é—®æ¨¡å‹ï¼Œå¹¶ç”¨å†…å®¹å¡«å……å®ƒã€‚
*   **å¯è®¿é—®æ ‡è®°ã€‚**
*   æˆ‘ä»¬åº”è¯¥å¯ä»¥ä½¿ç”¨é”®ç›˜æ‰“å¼€&å…³é—­æ¨¡æ€ã€‚
*   **åœ¨æ¨¡æ€ä¸­æ•è·ç„¦ç‚¹:**å› ä¸ºæ¨¡æ€æ˜¯ä¸€ä¸ªæƒ°æ€§ç»„ä»¶ï¼Œæ‰€ä»¥ä¸€æ—¦å®ƒæ‰“å¼€ï¼Œé”®ç›˜å¯¼èˆªåº”è¯¥è¢«æ•è·åœ¨å…¶ä¸­ã€‚

è¯¥ç»„ä»¶åˆ©ç”¨äº† React ç‰¹æ€§ï¼Œå¦‚ä¸Šä¸‹æ–‡ã€é—¨æˆ·å’Œå¼•ç”¨ã€‚ä¸ºäº†è¯„ä¼° ReasonReact æ˜¯å¦å¯ä»¥æŠ•å…¥ç”Ÿäº§ï¼Œæˆ‘å°†åœ¨ Reason ä¸­æ„å»ºç›¸åŒçš„æ¨¡å‹ï¼Œå¹¶æŠ¥å‘Šæˆ‘å–œæ¬¢/ä¸å–œæ¬¢çš„å†…å®¹ã€‚

æˆ‘å°†åœ¨è¿­ä»£ä¸­å†æ¬¡è¿™æ ·åšã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æœ€ç»ˆçš„æºä»£ç [ã€‚æ¯ä¸ªè¿­ä»£éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯ã€‚](https://github.com/siffogh/reason-react-modal)

# [](#iteration-1-the-modal-as-a-simple-div)è¿­ä»£#1:å°†æ¨¡æ€ä½œä¸ºä¸€ä¸ªç®€å•çš„ div

[![Iteration #1: the modal as a simple div](../Images/e8e9961e7afd31f5cb7b776a56257f36.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--wAzKTViF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/q8h622eucw20hvbu7owf.gif) 

<figure>

<figcaption>è¿­ä»£#1:å°†æ¨¡æ€ä½œä¸ºç®€å•çš„ div</figcaption>

</figure>

## [](#the-modal-component)æ¨¡æ€åˆ†é‡

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºæ¨¡æ€ç»„ä»¶:

```
/* src/Modal.re */

[%bs.raw {|require('./Modal.css')|}];

[@bs.scope "document"] [@bs.val] external body: Dom.element = "body";

[@react.component]
let make = (~children) =>
  ReactDOMRe.createPortal(
    <div className="modal-container" role="dialog" ariaModal=true>
      <div className="modal-content"> children </div>
    </div>,
    body,
  ); 
```

ä¸ºäº†ä½¿æ¨¡æ€å¯è®¿é—®ï¼Œå®ƒåº”è¯¥ä¸ä¸»åº”ç”¨ç¨‹åºå†…å®¹éš”ç¦»ã€‚ä½¿ç”¨ ReactDOMRe çš„`createPortal`å‡½æ•°ï¼Œæ¨¡æ€ç›´æ¥å‘ˆç°åœ¨æ–‡æ¡£ä½“ä¸­ã€‚

ä½†é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ¥è¿‘å°¸ä½“...

Reason é™„å¸¦äº†ä¸€ä¸ª`Dom`æ¨¡å—ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¯¥æ¨¡å—åªåŒ…å«æœ‰ç”¨çš„ç±»å‹ï¼Œå¹¶ä¸æä¾›åˆ°å®é™… DOM çš„ç»‘å®šã€‚

æˆ‘ä»¬å½“ç„¶å¯ä»¥åªä½¿ç”¨åŸå§‹ JavaScript æ¥è®¿é—®`document.body`å¹¶ä½¿ç”¨ Dom æ¨¡å—é”®å…¥å€¼:

```
let body: Dom.element = [%raw "document.body"]; 
```

å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ç¼–è¯‘åçš„`Modal.bs.js`æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™å®Œå…¨ä¸å¿…è¦çš„ä¸€è¡Œ:

```
var body = (document.body); 
```

å¦‚æœæ¯å½“æˆ‘ä»¬æƒ³è¦è®¿é—®ä¸€ä¸ª JavaScript å€¼æ—¶å°±å¼€å§‹ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‚¨èƒ½æƒ³è±¡ç¼–è¯‘åçš„ä»£ç ä¼šæ˜¯ä»€ä¹ˆæ ·å­å—ï¼Ÿæˆ‘ä»¬å¯ä»¥åšå¾—æ›´å¥½ï¼

è¦è®¿é—®æ–‡æ¡£çš„ä¸»ä½“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ BuckleScript çš„[å¤–éƒ¨ç‰¹æ€§](https://bucklescript.github.io/docs/en/bind-to-global-values) :

```
[@bs.scope "document"] [@bs.val] external body: Dom.element = "body"; 
```

æˆ‘ä»¬åªéœ€å‘Šè¯‰ BuckleScript ç»™æˆ‘ä»¬å‡ºç°åœ¨å…¨å±€å€¼`document`ä¸­çš„`Dom.element`ç±»å‹çš„å€¼`body`ã€‚è¿™ç§è¯­æ³•éå¸¸èªæ˜å’Œé«˜æ•ˆã€‚å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ç¼–è¯‘åçš„`Modal.bs.js`æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸»ä½“æ˜¯ç›´æ¥ä» document å¯¹è±¡è®¿é—®çš„ï¼Œå°±åƒæˆ‘ä»¬åœ¨ JavaScript ä¸­åšçš„ä¸€æ ·ï¼

## [](#opening-the-modal)å¼€å¯æ¨¡æ€

```
/* src/App.re */

[%bs.raw {|require('./App.css')|}];

[@react.component]
let make = () => {
  let (isModalVisible, setIsModalVisible) = React.useState(() => false);
  <div className="App">
    <h1> {"Parent container" |> ReasonReact.string} </h1>
    <h3> {"This is just a demo container" |> ReasonReact.string} </h3>
    <button onClick={_ => setIsModalVisible(_ => true)}>
      {"open modal" |> ReasonReact.string}
    </button>
    {!isModalVisible
       ? ReasonReact.null : <Modal> {"Foo" |> ReasonReact.string} </Modal>}
  </div>;
}; 
```

ä¸ºäº†æŸ¥çœ‹/éšè—æ¨¡æ€ï¼ŒåŸºäº`isModalVisible`å¸ƒå°”çŠ¶æ€å€¼æœ‰æ¡ä»¶åœ°åœ¨ App ç»„ä»¶ä¸­å‘ˆç°å®ƒã€‚

â€œæ‰“å¼€æ¨¡æ€â€æŒ‰é’®åªæ˜¯å°†è¯¥å€¼è®¾ç½®ä¸º`true`ï¼Œæ‰“å¼€æ¨¡æ€ã€‚

## [](#i-like)æˆ‘å–œæ¬¢ğŸ‘

*   ä½¿ç”¨é—¨æˆ·éå¸¸ç®€å•ã€‚
*   BuckleSript å¤–éƒ¨è¯­æ³•ä½¿å¾—è®¿é—® DOM å…ƒç´ å˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚

## [](#i-dislike)æˆ‘ä¸å–œæ¬¢ğŸ‘

*   ç¼ºå°‘å¯¹ DOM çš„å®é™…ç»‘å®šã€‚å®ƒå°†ä½¿è®¿é—®æ–‡æ¡£ä¸»ä½“å˜å¾—åƒåœ¨ JavaScript ä¸­ä¸€æ ·å®¹æ˜“ï¼ŒåŒæ—¶å—ç›Šäºé”®å…¥ã€‚

# [](#iteration-2-adding-close-buttons)è¿­ä»£#2:æ·»åŠ å…³é—­æŒ‰é’®

[![Iteration #2: adding close buttons](../Images/5eb37777c7aa015266160278c233d437.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--A_Pr2Jfa--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/4vc4tjk7dk4bga6t4kph.png) 

<figure>

<figcaption>è¿­ä»£ 2:æ·»åŠ å…³é—­æŒ‰é’®</figcaption>

</figure>

æˆ‘ä»¬å¸Œæœ›æœ‰ 2 ä¸ªæŒ‰é’®æ¥å…³é—­æ¨¡å¼:

*   æ ‡é¢˜ä¸­çš„åå­—æŒ‰é’®ã€‚
*   é¡µè„šçš„â€œå…³é—­â€æŒ‰é’®ã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆå…¬å¼€æ¨¡å¼:

*   ä¸€ä¸ª header ç»„ä»¶ï¼ŒåŒ…å«äº¤å‰å…³é—­æŒ‰é’®å’Œæˆ‘ä»¬å¸Œæœ›åœ¨ modal çš„æ ‡é¢˜ä¸­å‘ˆç°çš„ä»»ä½•å…ƒç´ ã€‚

*   ä¸€ä¸ªä¸»ä½“ç»„ä»¶ï¼ŒåŒ…å«æˆ‘ä»¬å¸Œæœ›åœ¨æ¨¡å¼ä¸»ä½“ä¸­å‘ˆç°çš„ä»»ä½•å…ƒç´ ã€‚

*   ä¸€ä¸ªé¡µè„šç»„ä»¶ï¼Œå®ƒå°†åŒ…å«ç¬¬äºŒä¸ªå…³é—­æŒ‰é’®å’Œæˆ‘ä»¬å¸Œæœ›åœ¨æ¨¡å¼é¡µè„šä¸­å‘ˆç°çš„ä»»ä½•å…ƒç´ ã€‚

```
/* src/Modal.re */

[%bs.raw {|require('./Modal.css')|}];

[@bs.scope "document"] [@bs.val] external body: Dom.element = "body";

module Cross = {
  [@bs.module "./cross.svg"] [@react.component]
  external make: unit => React.element = "default";
};

[@react.component]
let make = (~children) => {
  ReactDOMRe.createPortal(
    <div className="modal-container" role="dialog" ariaModal=true>
      <div className="modal-content"> children </div>
    </div>,
    body,
  );
};

module Header = {
  [@react.component]
  let make = (~children) => {
    <div className="modal-header">
      children
      <button className="cross-btn" title="close modal"> <Cross /> </button>
    </div>;
  };
};

module Body = {
  [@react.component]
  let make = (~children) => <div className="modal-body"> children </div>;
};

module Footer = {
  [@react.component]
  let make = (~children) => <div className="modal-footer"> children </div>;

  module CloseBtn = {
    [@react.component]
    let make = (~children) => {
      <button className="close-btn" title="close modal"> children </button>;
    };
  };
}; 
```

ç„¶åæˆ‘ä»¬å¯ä»¥é‡æ„æˆ‘ä»¬çš„ App.re å¹¶ä½¿ç”¨æ–°çš„æ¨¡æ€å­ç»„ä»¶:

```
/* src/App.re */

[%bs.raw {|require('./App.css')|}];

[@react.component]
let make = () => {
  let (isModalVisible, setIsModalVisible) = React.useState(() => false);

  <div className="App">
    <h1> {"Parent container" |> ReasonReact.string} </h1>
    <h3> {"This is just a demo container" |> ReasonReact.string} </h3>
    <button onClick={_ => setIsModalVisible(_ => !isModalVisible)}>
      {"open modal" |> ReasonReact.string}
    </button>
    {!isModalVisible
       ? ReasonReact.null
       : <Modal>
           <Modal.Header> {"Header" |> ReasonReact.string} </Modal.Header>
           <Modal.Body> {"Body" |> ReasonReact.string} </Modal.Body>
           <Modal.Footer>
             <Modal.Footer.CloseBtn>
               {"Close" |> ReasonReact.string}
             </Modal.Footer.CloseBtn>
           </Modal.Footer>
         </Modal>}
  </div>;
}; 
```

## [](#i-like)æˆ‘å–œæ¬¢ğŸ‘

*   Reason çš„æ¨¡å—è¯­æ³•éå¸¸ç®€å•ï¼Œåˆ›å»ºå­æ¨¡å—ä¹Ÿå¾ˆå®¹æ˜“ã€‚

# [](#iteration-3-closing-the-modal)è¿­ä»£#3:å…³é—­æ¨¡æ€

å°±åƒæ‰“å¼€æ¨¡æ€ä¸€æ ·ï¼Œå…³é—­æ¨¡æ€å¯ä»¥é€šè¿‡å°† App.re ä¸­çš„`isModalVisible`è®¾ç½®ä¸º`true`æ¥å®Œæˆã€‚

è®©æˆ‘ä»¬ä¼ é€’ç»™æ¨¡æ€ a å‡½æ•°ï¼Œ`onModalClose`ï¼Œå®ƒç¡®å®åšäº†:

```
/* src/App.re*/

[%bs.raw {|require('./App.css')|}];

[@react.component]
let make = () => {
  let (isModalVisible, setIsModalVisible) = React.useState(() => false);

  <div className="App">
    <h1> {"Parent container" |> ReasonReact.string} </h1>
    <h3> {"This is just a demo container" |> ReasonReact.string} </h3>
    <button onClick={_ => setIsModalVisible(_ => !isModalVisible)}>
      {"open modal" |> ReasonReact.string}
    </button>
    {!isModalVisible
       ? ReasonReact.null
       : <Modal onModalClose={() => setIsModalVisible(_ => false)}>
           <Modal.Header> {"Header" |> ReasonReact.string} </Modal.Header>
           <Modal.Body> {"Body" |> ReasonReact.string} </Modal.Body>
           <Modal.Footer>
             <Modal.Footer.CloseBtn>
               {"Close" |> ReasonReact.string}
             </Modal.Footer.CloseBtn>
           </Modal.Footer>
         </Modal>}
  </div>;
}; 
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ¨¡æ€ç»„ä»¶æœ‰ä¸€ä¸ªå…³é—­æ¨¡æ€çš„ prop å‡½æ•°ã€‚å‰©ä¸‹çš„å”¯ä¸€ä¸€ä»¶äº‹å°±æ˜¯è®©å®ƒå¯¹é¡µçœ‰å’Œé¡µè„šå…³é—­æŒ‰é’®å¯ç”¨ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ React ä¸Šä¸‹æ–‡æä¾›ç¨‹åºä¸­å…¬å¼€å®ƒã€‚ä»»ä½•éœ€è¦è®¿é—®`onModalClose`å‡½æ•°çš„ç»„ä»¶éƒ½å¯ä»¥ä½¿ç”¨`useContext`é’©å­æ¥ä½¿ç”¨å®ƒã€‚

ä¸ºäº†åˆ›å»ºä¸€ä¸ªæ¨¡æ€çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React `createContext`å‡½æ•°å¹¶å‘å®ƒä¼ é€’ä¸€ä¸ªåˆå§‹å€¼ã€‚å› ä¸º`onModalClose`å‡½æ•°å±äº`unit => unit`ç±»å‹ï¼Œæ‰€ä»¥åˆå§‹å€¼éœ€è¦å±äºåŒä¸€ç±»å‹:

```
let modalContext = React.createContext(() => ()); 
```

ä¸èƒ½ä»æ¨¡å¼çš„ä¸Šä¸‹æ–‡ä¸­ç›´æ¥è®¿é—®æä¾›è€…ã€‚ä½¿ç”¨å®ƒçš„ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæä¾›è€…æ¨¡å—ï¼Œå®ƒå…¬å¼€äº†ä¸€ä¸ª`make`å’Œ`makeProps`å‡½æ•°:

```
module ContextProvider = {
  let makeProps = (~value, ~children, ()) => {
    "value": value,
    "children": children,
  };

  let make = React.Context.provider(modalContext);
}; 
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨¡æ€çš„å­èŠ‚ç‚¹åŒ…è£…åœ¨ä¸Šä¸‹æ–‡æä¾›è€…ä¸­ï¼Œå¹¶åœ¨é¡µçœ‰å’Œé¡µè„šä¸­ä½¿ç”¨æˆ‘ä»¬çš„å€¼:

```
/* src/Modal.re */

[%bs.raw {|require('./Modal.css')|}];

[@bs.scope "document"] [@bs.val] external body: Dom.element = "body";

module Cross = {
  [@bs.module "./cross.svg"] [@react.component]
  external make: unit => React.element = "default";
};

let modalContext = React.createContext(() => ());

module ContextProvider = {
  let makeProps = (~value, ~children, ()) => {
    "value": value,
    "children": children,
  };

  let make = React.Context.provider(modalContext);
};

[@react.component]
let make = (~children, ~onModalClose) => {
  ReactDOMRe.createPortal(
    <div className="modal-container" role="dialog" ariaModal=true>
      <div className="modal-content">
        <ContextProvider value=onModalClose> children </ContextProvider>
      </div>
    </div>,
    body,
  );
};

module Header = {
  [@react.component]
  let make = (~children) => {
    let onModalClose = React.useContext(modalContext);

    <div className="modal-header">
      children
      <button
        className="cross-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        <Cross />
      </button>
    </div>;
  };
};

module Body = {
  [@react.component]
  let make = (~children) => <div className="modal-body"> children </div>;
};

module Footer = {
  [@react.component]
  let make = (~children) => <div className="modal-footer"> children </div>;

  module CloseBtn = {
    [@react.component]
    let make = (~children) => {
      let onModalClose = React.useContext(modalContext);

      <button
        className="close-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        children
      </button>;
    };
  };
}; 
```

## [](#i-like)æˆ‘å–œæ¬¢ğŸ‘

*   æˆ‘èƒ½å¤Ÿä½¿ç”¨ä¸Šä¸‹æ–‡æ¥å®ç°è¯¥ç‰¹æ€§ï¼Œå³ä½¿è¿™æ˜¯ä¸€ç§å˜é€šæ–¹æ³•ã€‚
*   åœ¨é™·å…¥ä½¿ç”¨ä¸Šä¸‹æ–‡çš„å›°å¢ƒåï¼Œæˆ‘è®¾æ³•é€šè¿‡[è®ºå›](https://reasonml.chat/t/current-state-of-react-context/1626/2)å’Œ[ä¸å’Œè°é¢‘é“](https://discordapp.com/channels/235176658175262720/235199093155168257)å¾ˆå¿«æ‰¾åˆ°äº†ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚

## [](#i-dislike)æˆ‘ä¸å–œæ¬¢ğŸ‘

*   æ²¡æœ‰å…³äºä½¿ç”¨ä¸Šä¸‹æ–‡çš„æ–‡æ¡£ã€‚
*   æˆ‘ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆæ— ç–‘æ˜¯ä¸€ä¸ªé»‘å®¢ã€‚

# [](#iteration-4-closing-the-modal-through-a-keyboard-shortcut)è¿­ä»£#4:é€šè¿‡å¿«æ·é”®å…³é—­æ¨¡æ€

[![Iteration #4: closing the modal through a keyboard shortcut](../Images/3c55bdebbd43eace12f7a30cfb970dff.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--ErARfEiN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/dq8ohaqee3i3mxm1jyjw.gif) 

<figure>

<figcaption>è¿­ä»£#4:é€šè¿‡å¿«æ·é”®</figcaption>

</figure>

å…³é—­æ¨¡æ€

æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿé€šè¿‡æŒ‰ä¸‹`ESCAPE`é”®æ¥å…³é—­æ¨¡æ€ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤–éƒ¨è¯­æ³•æ¥è®¿é—®ä¸¤ä¸ªå‡½æ•°:

*   `document.addEventListener`(æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨)ã€‚
*   `document.removeEventListener`(åˆ é™¤ä¸€ä¸ªç›‘å¬å™¨)ã€‚

æˆ‘ä»¬å¿…é¡»æ˜ç¡®è¿™ä¸¤ä¸ªå‡½æ•°ä¸­ä½¿ç”¨çš„äº‹ä»¶ç±»å‹ã€‚`ReactEvent`æ¨¡å—æä¾›äº†å„ç§äº‹ä»¶çš„ç±»å‹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨å¤„ç†ç±»å‹ä¸º`Keyboard`çš„äº‹ä»¶ã€‚ç”±äºæˆ‘ä»¬çš„å‡½æ•°åªå¤„ç†é”®ç›˜äº‹ä»¶ï¼Œæˆ‘å†³å®šç»™å®ƒä»¬èµ·ä¸€ä¸ªç¨å¾®ä¸åŒçš„åå­—:

```
[@bs.scope "document"] [@bs.val]
external addKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "addEventListener";

[@bs.scope "document"] [@bs.val]
external removeKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "removeEventListener"; 
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªå¯¹`ESCAPE`é”®åšå‡ºååº”çš„`keydown`ç›‘å¬å™¨:

```
let keyDownListener = e =>
  if (ReactEvent.Keyboard.keyCode(e) === 27) {
     onModalClose();
  }; 
```

`useEffect`é’©å­å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥è®¢é˜…æˆ‘ä»¬çš„`keyDownListener`ã€‚è¯¥å‡½æ•°è¿”å›æ¯”å¦ä¸€ä¸ªå‡½æ•°æ¸…ç†çš„æ•ˆæœï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªé€‰é¡¹:

```
/* src/Modal.re */

[%bs.raw {|require('./Modal.css')|}];

[@bs.scope "document"] [@bs.val] external body: Dom.element = "body";

[@bs.scope "document"] [@bs.val]
external addKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "addEventListener";

[@bs.scope "document"] [@bs.val]
external removeKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "removeEventListener";

module Cross = {
  [@bs.module "./cross.svg"] [@react.component]
  external make: unit => React.element = "default";
};

let modalContext = React.createContext(() => ());

module ContextProvider = {
  let makeProps = (~value, ~children, ()) => {
    "value": value,
    "children": children,
  };

  let make = React.Context.provider(modalContext);
};

[@react.component]
let make = (~children, ~onModalClose) => {
  let keyDownListener = e =>
    if (ReactEvent.Keyboard.keyCode(e) === 27) {
      onModalClose();
    };

  let effect = () => {
    addKeybordEventListener("keydown", keyDownListener);
    Some(() => removeKeybordEventListener("keyDown", keyDownListener));
  };

  React.useEffect(effect);

  ReactDOMRe.createPortal(
    <div className="modal-container" role="dialog" ariaModal=true>
      <div className="modal-content">
        <ContextProvider value=onModalClose> children </ContextProvider>
      </div>
    </div>,
    body,
  );
};

module Header = {
  [@react.component]
  let make = (~children) => {
    let onModalClose = React.useContext(modalContext);

    <div className="modal-header">
      children
      <button
        className="cross-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        <Cross />
      </button>
    </div>;
  };
};

module Body = {
  [@react.component]
  let make = (~children) => <div className="modal-body"> children </div>;
};

module Footer = {
  [@react.component]
  let make = (~children) => <div className="modal-footer"> children </div>;

  module CloseBtn = {
    [@react.component]
    let make = (~children) => {
      let onModalClose = React.useContext(modalContext);

      <button
        className="close-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        children
      </button>;
    };
  };
}; 
```

## [](#i-like)æˆ‘å–œæ¬¢ğŸ‘

*   useEffect è¢«å®Œå…¨é”®å…¥ï¼Œå®ƒæé†’ä½ æ¸…ç†æ•ˆæœã€‚ä½ è¦ä¹ˆæ˜¾å¼è¿”å›`None`è¦ä¹ˆè¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ã€‚è¿™å¯ä»¥é¿å…åœ¨æ·»åŠ ä¾¦å¬å™¨è€Œä¸åˆ é™¤å®ƒä»¬æ—¶å‡ºç°å†…å­˜æ³„æ¼ã€‚

## [](#i-dislike)æˆ‘ä¸å–œæ¬¢ğŸ‘

*   æ²¡æœ‰å…³äºä½¿ç”¨`useEffect`çš„æ–‡æ¡£ã€‚

# [](#iteration-5-trapping-the-focus-in-the-modal)è¿­ä»£#5:åœ¨æ¨¡æ€ä¸­æ•æ‰ç„¦ç‚¹

ä¸ºäº†è®©æˆ‘ä»¬çš„æ¨¡å‹å¯ä»¥è¢«æ­£ç¡®è®¿é—®ï¼Œè¿˜æœ‰ä¸€ä»¶äº‹è¦åš:å®ƒé‡Œé¢çš„ç„¦ç‚¹åº”è¯¥è¢«æ•è·ã€‚ä¸€æ—¦æ‰“å¼€äº†æ¨¡å‹ï¼Œæˆ‘ä»¬åº”è¯¥å…³æ³¨å…¶ä¸­çš„ç¬¬ä¸€ä¸ªå¯èšç„¦çš„å…ƒç´ ã€‚ä»é‚£æ—¶èµ·ï¼ŒæŒ‰ TAB æˆ– SHIFT + TAB é”®å°†åªå…è®¸ç”¨æˆ·åœ¨æ¨¡å¼ä¸­å¯¼èˆªã€‚

[![Trapping the focus inside the modal](../Images/d6c20fed3ae8b25bd98053f4caeeb0c0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--zevNJ4WW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/adiro5t2jje42hglxwm3.jpeg) 

<figure>

<figcaption>æŠŠç„¦ç‚¹å¥—åœ¨æƒ…æ€é‡Œé¢</figcaption>

</figure>

æˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª Ref æ¥è®¿é—®æ¨¡æ€ dom å…ƒç´ :

```
let modalRef = React.useRef(Js.Nullable.null); 
```

æ³¨æ„ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡`Js.Nullable`æ¨¡å—ç”¨ç©ºå€¼åˆå§‹åŒ–`useRef`ã€‚å¹¸è¿çš„æ˜¯ï¼Œä»`Js.Nullable`è½¬æ¢æˆæœŸæƒ
ç›¸å½“å®¹æ˜“

```
switch(Js.Nullable.toOption(someNullable)) {
    | Some(value) => ...
    | None => ...
} 
```

ä¸ºäº†é€‰æ‹© modal ä¸­æ‰€æœ‰å¯èšç„¦çš„å…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯¹ modal ç»„ä»¶çš„å¼•ç”¨ä¸­ä½¿ç”¨ DOM å…ƒç´ çš„`querySelector`å‡½æ•°ã€‚

ç”±äºç¼ºå°‘åˆ° DOM çš„æ­£ç¡®ç»‘å®šï¼Œæˆ‘ä»¬è¦ä¹ˆå¿…é¡»ç¼–å†™è‡ªå·±çš„ç»‘å®šï¼Œä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œè¦ä¹ˆåªä½¿ç”¨`ReactDOMRe.domElementToObj`å°†æ¨¡æ€ ref ä¸­çš„ DOM å…ƒç´ è½¬æ¢æˆä¸€ä¸ªå¯¹è±¡ã€‚

ç›®å‰ï¼Œæˆ‘é€‰æ‹©ç¬¬ä¸‰ä¸ªé€‰é¡¹ã€‚è¿™ä½¿æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è®¿é—®`querySelector`å‡½æ•°ï¼Œä½†æ˜¯ä¼šå¤±å»å¯¹æ‰€æœ‰ç±»å‹çš„è·Ÿè¸ª:

```
/* src/Modal.re */

[%bs.raw {|require('./Modal.css')|}];

[@bs.scope "document"] [@bs.val] external body: Dom.element = "body";

[@bs.scope "document"] [@bs.val]
external addKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "addEventListener";

[@bs.scope "document"] [@bs.val]
external removeKeybordEventListener:
  (string, ReactEvent.Keyboard.t => unit) => unit =
  "removeEventListener";

[@bs.scope "document"] [@bs.val]
external activeElement: Dom.element = "activeElement";

module Cross = {
  [@bs.module "./cross.svg"] [@react.component]
  external make: unit => React.element = "default";
};

let modalContext = React.createContext(() => ());

module ContextProvider = {
  let makeProps = (~value, ~children, ()) => {
    "value": value,
    "children": children,
  };

  let make = React.Context.provider(modalContext);
};
[@react.component]
let make = (~children, ~onModalClose) => {
  let modalRef = React.useRef(Js.Nullable.null);

  let handleTabKey = e => {
    let current = React.Ref.current(modalRef);
    switch (Js.Nullable.toOption(current)) {
    | Some(element) =>
      let elementObj = ReactDOMRe.domElementToObj(element);
      let elements =
        elementObj##querySelectorAll(
          "a[href], button, textarea, input[type='text'], input[type='radio'], input[type='checkbox'], select",
        );
      let firstElement = elements[0];
      let lastElement = elements[elements##length - 1];

      if (!ReactEvent.Keyboard.shiftKey(e) && activeElement !== firstElement) {
        firstElement##focus();
        ReactEvent.Keyboard.preventDefault(e);
      };

      if (ReactEvent.Keyboard.shiftKey(e) && activeElement !== lastElement) {
        lastElement##focus();
        ReactEvent.Keyboard.preventDefault(e);
      };

    | None => ignore()
    };
  };

  let keyListenersMap =
    Js.Dict.fromArray([|("27", _ => onModalClose()), ("9", handleTabKey)|]);

  let effect = () => {
    let keyDownListener = e => {
      let keyCodeStr = ReactEvent.Keyboard.keyCode(e) |> string_of_int;

      switch (Js.Dict.get(keyListenersMap, keyCodeStr)) {
      | Some(eventListener) => eventListener(e)
      | None => ignore()
      };
    };

    addKeybordEventListener("keydown", keyDownListener);
    Some(() => removeKeybordEventListener("keyDown", keyDownListener));
  };

  React.useEffect(effect);

  ReactDOMRe.createPortal(
    <div className="modal-container" role="dialog" ariaModal=true>
      <div className="modal-content" ref={ReactDOMRe.Ref.domRef(modalRef)}>
        <ContextProvider value=onModalClose> children </ContextProvider>
      </div>
    </div>,
    body,
  );
};

module Header = {
  [@react.component]
  let make = (~children) => {
    let onModalClose = React.useContext(modalContext);

    <div className="modal-header">
      children
      <button
        className="cross-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        <Cross />
      </button>
    </div>;
  };
};

module Body = {
  [@react.component]
  let make = (~children) => <div className="modal-body"> children </div>;
};

module Footer = {
  [@react.component]
  let make = (~children) => <div className="modal-footer"> children </div>;

  module CloseBtn = {
    [@react.component]
    let make = (~children) => {
      let onModalClose = React.useContext(modalContext);

      <button
        className="close-btn"
        title="close modal"
        onClick={_ => onModalClose()}>
        children
      </button>;
    };
  };
}; 
```

## [](#i-like)æˆ‘å–œæ¬¢ğŸ‘

*   èƒ½å¤Ÿä»`Js.Nullable`è½¬æ¢ä¸ºé€‰é¡¹ã€‚
*   å°½ç®¡ç¼ºå°‘å¯¹ DOM çš„é€‚å½“ç»‘å®šï¼Œæˆ‘è¿˜æ˜¯èƒ½å¤Ÿå®ç°è¿™ä¸ªç‰¹æ€§ã€‚

## [](#i-dislike)æˆ‘ä¸å–œæ¬¢ğŸ‘

*   æ— æ³•ä½¿ç”¨å¸¦æœ‰ useRef æŒ‚é’©çš„é€‰é¡¹ã€‚
*   ç¼ºå°‘å¯¹ DOM çš„æ­£ç¡®ç»‘å®šã€‚