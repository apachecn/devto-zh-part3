# ç¬¬ 019 é›†-è§’è‰²ã€ä¸»å¼ å’Œæ”¿ç­–-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°è¿‡åº¦æ€æˆ®

> åŸæ–‡:[https://dev . to/joaofbantunes/episode-019-roles-claims-and-policies-ASP-net-core-from-0-to-overkill-1 hkh](https://dev.to/joaofbantunes/episode-019-roles-claims-and-policies-asp-net-core-from-0-to-overkill-1hkh)

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬å›åˆ°æˆæƒä¸»é¢˜ï¼Œåœ¨ ASP.NET æ ¸å¿ƒä¸­ç©ä¸€ä¼šå„¿è§’è‰²ã€å£°æ˜å’Œç­–ç•¥ï¼Œå­¦ä¹ å¦‚ä½•ä½¿ç”¨å®ƒä»¬æ¥é™åˆ¶å¯¹åº”ç”¨ç¨‹åºæŸäº›åŒºåŸŸçš„è®¿é—®ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/betgDb8AH8k](https://www.youtube.com/embed/betgDb8AH8k)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨å‰é¢çš„å‡ é›†ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´è‡´åŠ›äºèº«ä»½éªŒè¯æœåŠ¡ï¼Œå®ƒå°†ä½œä¸ºåº”ç”¨ç¨‹åºç”¨æˆ·æ³¨å†Œå’Œç™»å½•çš„ä¸­å¿ƒç‚¹ã€‚æˆ‘ä»¬è¿˜åˆ©ç”¨ä½¿ç”¨ Razor Pages çš„æœºä¼šæ¥çœ‹çœ‹å¦‚ä½•åœ¨ ASP.NET æ ¸å¿ƒä¸­å®ç°å›½é™…åŒ–ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å€Ÿæ­¤æœºä¼šäº†è§£ä¸€ä¸‹æˆæƒã€å¦‚ä½•åœ¨ ASP.NET æ ¸å¿ƒä¸­å®æ–½æˆæƒåŠå…¶ä¸€äº›æ¦‚å¿µ(è§’è‰²ã€å£°æ˜å’Œç­–ç•¥)ã€‚æˆ‘è®¡åˆ’åœ¨ç¨åé˜¶æ®µè®¨è®ºè¿™ä¸ªä¸»é¢˜ï¼Œå¹¶å°†å…¶åº”ç”¨äºæˆ‘ä»¬å°†è¦å®ç°çš„ APIï¼Œå› ä¸ºèº«ä»½éªŒè¯æœåŠ¡å°†åªå¤„ç†èº«ä»½éªŒè¯ï¼Œä½† YouTube ä¸Šçš„ä¸€ä½è§‚ä¼—è¯´ï¼Œå¾ˆé«˜å…´çœ‹åˆ°å®ƒå¦‚ä½•ä¸ Razor é¡µé¢ä¸€èµ·å·¥ä½œï¼Œæ‰€ä»¥...æˆ‘ä»¬åˆ°äº†ğŸ™‚ã€‚

## [](#roles-with-some-claims-and-policies-in-the-mix)è§’è‰²(æ··åˆäº†ä¸€äº›å£°æ˜å’Œç­–ç•¥)

åœ¨ ASP.NETï¼Œå®ç°æˆæƒæœ€å¹¿ä¸ºäººçŸ¥çš„æ–¹å¼å¯èƒ½æ˜¯é€šè¿‡ä½¿ç”¨è§’è‰²ã€‚åœ¨ ASP.NET æ ¸å¿ƒä¸­ï¼Œå¼•å…¥äº†ä¸€ç§æ–°çš„æ–¹æ³•ï¼Œå³åŸºäºç­–ç•¥çš„æˆæƒï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥é€‰æ‹©ä½¿ç”¨åŸºäºè§’è‰²çš„æˆæƒã€‚

å¦ä¸€ä»¶è¦æ³¨æ„çš„äº‹æƒ…æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥å‡ ç§ä¸åŒçš„æ–¹å¼ä½¿ç”¨è§’è‰²â€”â€”è§’è‰²æœ¬èº«æˆ–è€…åŸºäºå£°æ˜çš„è§’è‰²ã€‚åœ¨è¿™ä¸ªç®€å•çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†åŸºäºå£°æ˜çš„è§’è‰²ï¼Œä½†æ˜¯æˆ‘ä¹Ÿå°†åœ¨å…¶ä»–æ–¹æ³•çš„æ–¹å‘ä¸Šæ·»åŠ ä¸€äº›æŒ‡é’ˆã€‚

### [](#requiring-a-role-to-access-a-page)è¦æ±‚è§’è‰²è®¿é—®é¡µé¢

è¦æ±‚ä¸€ä¸ªè§’è‰²è®¿é—®ä¸€ä¸ªé¡µé¢çš„å·¥ä½œæ–¹å¼å’Œä»¥å‰ä¸€æ ·ï¼Œé€šè¿‡åœ¨æˆ‘ä»¬æƒ³è¦å¼ºåˆ¶ä¸€ä¸ªç‰¹å®šè§’è‰²çš„ç±»ä¸Šæ·»åŠ ä¸€ä¸ª`Authorize`å±æ€§ã€‚

ä»…ä»…ä¸ºäº†è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º`Admin`çš„`Pages`çš„æ–°çš„å­æ–‡ä»¶å¤¹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ Razor é¡µé¢ï¼Œåä¸º`Index.cshtml`ã€‚åœ¨è§†å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›æ–‡æœ¬ï¼Œåªæ˜¯ä¸ºäº†æ›´å®¹æ˜“åœ°çœ‹åˆ°æˆ‘ä»¬æ‰€åœ¨çš„é¡µé¢ã€‚ç›¸å…³éƒ¨åˆ†åœ¨ä»£ç éšè—ä¸­:

`Pages/Admin/Index.cshtml.cs`

```
[Authorize(Roles = "admin")]
public class IndexModel : PageModel
{
    public void OnGet()
    {
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†`Authorize`å±æ€§ï¼Œæˆ‘ä»¬åªèƒ½åœ¨æ‹¥æœ‰`admin`è§’è‰²çš„æƒ…å†µä¸‹è®¿é—®é¡µé¢ï¼Œè€Œæˆ‘ä»¬ç°åœ¨è¿˜æ²¡æœ‰ï¼Œæ‰€ä»¥å¯¼èˆªåˆ°é¡µé¢ä¼šè¢«æ‹’ç»è®¿é—®ã€‚

### [](#adding-a-role-to-a-user-using-claims)ä½¿ç”¨å£°æ˜å‘ç”¨æˆ·æ·»åŠ è§’è‰²

ä¸ºäº†ä½¿è¿™ä¸ªä¾‹å­éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ³¨å†Œæ—¶ä½¿ç”¨æˆ‘å‰é¢æåˆ°çš„å£°æ˜ä¸ºç”¨æˆ·æ·»åŠ è§’è‰²ã€‚åœ¨`Register.cshtml.cs`ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä»¥ä¸‹æ›´æ”¹:

`Pages/Register.cshtml.cs`

```
public class RegisterModel : PageModel
{
    // ...
    public async Task<IActionResult> OnPostAsync(CancellationToken ct, string returnUrl = null)
    {
        // ...
        // after creating a user successfully
        var addClaimResult = await _userManager.AddClaimAsync(user, new Claim(ClaimTypes.Role, "admin"));
        // ...
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†`UserManager.AddClaimAsync`ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„å£°æ˜ï¼Œè€Œæ²¡æœ‰ä»»ä½•ä¾èµ–å…³ç³»(ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œè¿™ä¸æ˜¯ç‹¬ç«‹è§’è‰²çš„æƒ…å†µ)ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åŠ©æ‰‹å¸¸é‡`ClaimTypes.Role`å¹¶å°†æ–°æ³¨å†Œçš„ç”¨æˆ·é…ç½®ä¸ºæ‹¥æœ‰`admin`è§’è‰²ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·å¹¶å†æ¬¡å°è¯•è®¿é—®è¯¥é¡µé¢ï¼Œè®¿é—®å°†ä¸å†è¢«æ‹’ç»ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥é¡µé¢çš„å†…å®¹ã€‚

### [](#using-roles-without-claims)ä½¿ç”¨æ²¡æœ‰æƒåˆ©è¦æ±‚çš„è§’è‰²

è¦ä½¿ç”¨æ²¡æœ‰å£°æ˜çš„è§’è‰²ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›æ”¹å˜ã€‚

å…³äºåœ¨æ³¨å†Œæ—¶å°†ç”¨æˆ·æ·»åŠ åˆ°è§’è‰²ï¼Œä»£ç å°†éå¸¸ç±»ä¼¼:

```
var addClaimResult = await _userManager.AddClaimAsync(user, new Claim(ClaimTypes.Role, "admin"));
// becomes
var addToRoleResult = await _userManager.AddToRoleAsync(user, "admin"); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯è¯•å›¾è¿è¡Œï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªé”™è¯¯:

```
InvalidOperationException: Role ADMIN does not exist.

Microsoft.AspNetCore.Identity.EntityFrameworkCore.UserStore<TUser, TRole, TContext, TKey, TUserClaim, TUserRole, TUserLogin, TUserToken, TRoleClaim>.AddToRoleAsync(TUser user, string normalizedRoleName, CancellationToken cancellationToken) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å½“ä½¿ç”¨å£°æ˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥éšæ„æ·»åŠ å®ƒä»¬ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ä¸€ä¸ªåç§°ï¼Œå®ƒä»¬å°±è¢«åˆ›å»ºäº†ã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æƒ³å•ç‹¬ä½¿ç”¨è§’è‰²ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒä»¬å­˜åœ¨ã€‚

ä¸ºäº†é…ç½®è§’è‰²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`RoleManager<TRole>`ç±»ã€‚å‡è®¾æˆ‘ä»¬ä¹Ÿæƒ³åœ¨æ³¨å†Œè¿‡ç¨‹ä¸­è¿™æ ·åšâ€”â€”è¿™ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä½†æ˜¯ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦è¿™æ ·åšã€‚

åœ¨`RegisterModel`æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å‚æ•°å¹¶å­˜å‚¨èµ·æ¥ä»¥å¤‡å°†æ¥ä½¿ç”¨:
`Pages/RegisterModel.cshtml.cs`

```
public class RegisterModel : PageModel
{
    private readonly RoleManager<IdentityRole> _roleManager;

    public RegisterModel(
        // ...
        RoleManager<IdentityRole> roleManager)
    {
        // ...
        _roleManager = roleManager;
    }
    // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œåœ¨åˆ›å»ºç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºæˆ‘ä»¬æƒ³è¦çš„è§’è‰²ã€‚

`Pages/Register.cshtml.cs`

```
// ...
public async Task<IActionResult> OnPostAsync(CancellationToken ct, string returnUrl = null)
{
    // ...
    // after creating a user successfully
    if(!(await _roleManager.RoleExistsAsync("admin")))
    {
        await _roleManager.CreateAsync(new IdentityRole("admin"));
    }

    var addClaimResult = await _userManager.AddToRoleAsync(user, "admin");
    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> æ³¨æ„:åŒæ ·ï¼Œè¿™ç§è§’è‰²ç®¡ç†çš„ä¸œè¥¿ä¸åº”è¯¥å‡ºç°åœ¨æ³¨å†Œè¿‡ç¨‹çš„ä¸­é—´ï¼Œè€Œåº”è¯¥å‡ºç°åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ–è€…ç”šè‡³å‡ºç°åœ¨åº”ç”¨ç¨‹åºä¸­å…è®¸è¿™ç§é…ç½®çš„å•ç‹¬åŒºåŸŸã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå®ƒå°†ä¼šæˆåŠŸï¼Œè§’è‰²å°†ä¼šèµ‹äºˆæ–°ç”¨æˆ·ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åƒä»¥å‰ä¸€æ ·è®¿é—®ç®¡ç†é¡µé¢ã€‚

## [](#policies)æ”¿ç­–

æ­£å¦‚æˆ‘æåˆ°çš„ï¼Œåœ¨ ASP.NET æ ¸å¿ƒä¸­ï¼Œæˆ‘ä»¬æœ‰åŸºäºç­–ç•¥çš„æˆæƒçš„æ¦‚å¿µã€‚ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸çµæ´»åœ°è¦æ±‚ç”¨æˆ·è®¿é—®ç‰¹å®šé¡µé¢ã€åº”ç”¨ç¨‹åºåŒºåŸŸç”šè‡³æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚è®©æˆ‘ä»¬çœ‹ä¸€äº›ä½¿ç”¨ç­–ç•¥çš„ä¾‹å­ã€‚

### [](#declare-a-needed-policy)å£°æ˜ä¸€ä¸ªéœ€è¦çš„ç­–ç•¥

è®©æˆ‘ä»¬ä»å‡ ç§æ–¹æ³•å¼€å§‹ï¼Œè¯´æ˜è®¿é—®åº”ç”¨ç¨‹åºçš„ç‰¹å®šé¡µé¢æˆ–åŒºåŸŸéœ€è¦ä»€ä¹ˆç­–ç•¥ã€‚ä¹‹åå†çœ‹å¦‚ä½•å®šä¹‰æ”¿ç­–ã€‚

#### [](#using-the-authorize-attribute)ä½¿ç”¨æˆæƒå±æ€§

ä¸ºäº†æŒ‡ç¤ºè®¿é—®é¡µé¢æ‰€éœ€çš„ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¯¹è§’è‰²é‚£æ ·ä½¿ç”¨`Authorize`å±æ€§ï¼Œåªæ˜¯æŒ‡å®šä¸€ä¸ªç­–ç•¥ã€‚ä¸ºäº†çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`Pages/Admin`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`AttributePolicyProtected.cshtml`çš„æ–° Razor é¡µé¢ã€‚å°±åƒå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨è§†å›¾ä¸­æ”¾ç½®ä¸€äº›æ–‡æœ¬ï¼Œåªæ˜¯ä¸ºäº†é€šçŸ¥æˆ‘ä»¬æ‰€åœ¨çš„é¡µé¢ã€‚ç›¸å…³éƒ¨åˆ†åœ¨`AttributePolicyProtected.cshtml.cs`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æœ‰:

`Pages/Admin/AttributePolicyProtected.cshtml.cs`

```
[Authorize(Policy = "SamplePolicy")]
public class AttributePolicyProtectedModel : PageModel
{
    public void OnGet()
    {

    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°å¦‚ä½•å®šä¹‰ç­–ç•¥ï¼Œä½†æ˜¯ç›¸å…³çš„ä¿¡æ¯æ˜¯ï¼Œå®ƒåƒä»¥å‰ä¸€æ ·å¼ºåˆ¶ç”¨æˆ·æ‹¥æœ‰`admin`è§’è‰²ï¼Œå› æ­¤å¯ä»¥è®¿é—®å‰é¢çš„ç¤ºä¾‹é¡µé¢çš„ç”¨æˆ·ä¹Ÿå¯ä»¥è®¿é—®è¿™ä¸ªé¡µé¢ï¼Œåªæ˜¯ä»¥ä¸åŒçš„æ–¹å¼å£°æ˜ã€‚

#### [](#using-razor-pages-conventions)ä½¿ç”¨å‰ƒåˆ€é¡µçº¦å®šä¿—æˆ

é™¤äº†ç”¨å±æ€§è®¾ç½®å¿…éœ€çš„ç­–ç•¥ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ Razor Pages çº¦å®š(æˆ– MVC è¿‡æ»¤å™¨ï¼Œä½†åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬å°†åªä½¿ç”¨ Razor Pages)æ¥å®ç°ã€‚

æˆ‘ä»¬ä¹‹å‰å·²ç»ä½¿ç”¨è¿‡ Razor Pages çº¦å®šï¼Œå°†åº”ç”¨ç¨‹åºçš„`Account`åŒºåŸŸè®¾ç½®ä¸ºè¦æ±‚å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚å¯¹äºåŒä¸€ä¸ª`AuthorizeFolder`æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªç­–ç•¥åã€‚è¿˜æœ‰å…¶ä»–ç±»ä¼¼çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹`AuthorizePage`ã€‚

`Startup.cs`

```
// ...
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services
        .AddMvc()
        .SetCompatibilityVersion(CompatibilityVersion.Version_2_2)
        .AddRazorPagesOptions(options =>
        {
            options.Conventions.AuthorizeFolder("/Account");
            options.Conventions.AuthorizePage("/Admin/ConventionPolicyProtected", "AnotherSamplePolicy");
        })
        // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°†åä¸º`ConventionPolicyProtected`çš„é¡µé¢è®¾ç½®ä¸ºéœ€è¦åä¸º`AnotherSamplePolicy`çš„ç­–ç•¥(åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡è®¾å®ƒä¸`SamplePolicy`åšåŒæ ·çš„äº‹æƒ…)ã€‚å¦‚æœæˆ‘ä»¬åˆ›å»ºäº†æ–°é¡µé¢`Pages/Admin/ConventionPolicyProtected.cshtml`ï¼Œå³ä½¿æ²¡æœ‰`Authorize`å±æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å®ƒå¼ºåˆ¶æ‰§è¡Œäº†æ‰€éœ€çš„ç­–ç•¥ï¼Œæ­£å¦‚åœ¨ Razor Pages çº¦å®šä¸­å®šä¹‰çš„é‚£æ ·ã€‚

### [](#define-a-policy)å®šä¹‰ä¸€ä¸ªç­–ç•¥

æ—¢ç„¶æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä½¿ç”¨ç­–ç•¥çš„ä¸€äº›æ–¹æ³•ï¼Œé‚£ä¹ˆæ˜¯æ—¶å€™çœ‹çœ‹å®šä¹‰å®ƒä»¬çš„å‡ ç§æ–¹æ³•äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†çœ‹ä¸€çœ‹ç®€å•åœ°è¦æ±‚ä¸€ä¸ªå£°æ˜å¹¶ä½¿ç”¨ä¸€ä¸ªå®šåˆ¶çš„`AuthorizationHandler`ã€‚è¿˜æœ‰æ›´å¤šï¼Œä½†æˆ‘ä»¬åªæ˜¯åœ¨æ¢ç´¢ï¼Œå½“æˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ—¶å€™ï¼Œæ›´å®¹æ˜“æ‰¾åˆ°æ›´å¤šçš„ä¸œè¥¿ğŸ™‚ã€‚

#### [](#using-requireclaim)ä½¿ç”¨ RequireClaim

é…ç½®ç­–ç•¥çš„ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨æˆ‘ä»¬åœ¨é…ç½®æˆæƒæœåŠ¡æ—¶è·å¾—çš„`AuthorizationPolicyBuilder`ã€‚æˆ‘ä»¬å°†çœ‹ä¸€ä¸‹`RequireClaim`ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥æ¢ç´¢æ›´å¤šçš„æ–¹æ³•ï¼Œæ¯”å¦‚`RequireRole`ã€`RequireAssertion`ã€`RequireUserName`ç­‰ç­‰ã€‚

è®©æˆ‘ä»¬å›åˆ°`Startup`ç±»çš„`ConfigureServices`æ–¹æ³•ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†é€šè¿‡æ·»åŠ å¯¹`AddAuthorization`çš„è°ƒç”¨æ¥æ·»åŠ æˆæƒæœåŠ¡çš„é…ç½®ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services.AddAuthorization(options =>
    {
        options.AddPolicy("SamplePolicy", policy => policy.RequireClaim(ClaimTypes.Role, "admin"));
        // ...
    });
    // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨`options`å¯¹è±¡ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªç±»å‹ä¸º`AuthorizationOptions`çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯æˆ‘ä»¬å°†æŠŠé‡ç‚¹æ”¾åœ¨`AddPolicy`ä¸Šã€‚`AddPolicy`æ–¹æ³•å…è®¸æˆ‘ä»¬é…ç½®æ–°çš„ç­–ç•¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åƒä»¥å‰ä¸€æ ·ä½¿ç”¨ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨`RequireClaim`æ–¹æ³•æ¥é…ç½®æˆ‘ä»¬çš„ç­–ç•¥ï¼Œè¦æ±‚ç”¨æˆ·å¤„äºè§’è‰²`admin`ã€‚ä½¿ç”¨`RequireRole`ä¼šäº§ç”Ÿç›¸åŒçš„ç»“æœã€‚

#### [](#using-authorization-requirements-and-handlers)ä½¿ç”¨æˆæƒéœ€æ±‚å’Œå¤„ç†ç¨‹åº

å¦‚æœæˆ‘ä»¬æƒ³ç”¨æ›´å¤æ‚çš„è§„åˆ™å®ç°ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[æˆæƒéœ€æ±‚](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-2.2#requirements)å’Œ[å¤„ç†ç¨‹åº](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-2.2#authorization-handlers)ã€‚éœ€æ±‚æ˜¯ä¸€ä¸ªåŒ…å«æ•°æ®çš„å¯¹è±¡ï¼Œå¤„ç†ç¨‹åºåº”è¯¥å¯¹å…¶è¿›è¡Œè¯„ä¼°ï¼Œä»¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æ‰€éœ€çš„é¡µé¢ã€‚

ä¸ºäº†ä½¿ç”¨éœ€æ±‚å’Œå¤„ç†ç¨‹åºï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„éœ€æ±‚ç±»ï¼Œå®ƒå®ç°äº†ä¸€ä¸ª`IAuthorizationRequirement`ï¼Œç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¤„ç†ç¨‹åºç±»ï¼Œå®ƒå®ç°äº†`IAuthorizationHandler`(å®ƒå¯ä»¥å¤„ç†å¤šä¸ªéœ€æ±‚)ï¼Œæˆ–è€…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨çš„æ–¹æ³•ï¼Œä»`AuthorizationHandler<TRequirement>`ç»§æ‰¿è€Œæ¥ï¼Œå®ƒå¯ä»¥ä½œä¸ºä¸€ä¸ªåŸºç¡€ï¼Œä¸ºä¸€ä¸ªå•ä¸€çš„éœ€æ±‚åˆ›å»ºä¸€ä¸ªå¤„ç†ç¨‹åºã€‚

ä»éœ€æ±‚å¼€å§‹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º`UsernameRequirement`çš„æ–°ç±»ï¼Œå®ƒå°†åŒ…å«ä¸€ä¸ªæ¨¡å¼ï¼Œç”¨æˆ·åå¿…é¡»æ»¡è¶³è¯¥æ¨¡å¼æ‰èƒ½è¢«å…è®¸è®¿é—®ã€‚

`Policies\Requirements\UsernameRequirement.cs`

```
public class UsernameRequirement : IAuthorizationRequirement
{
    public UsernameRequirement(string usernamePattern)
    {
        UsernamePattern = usernamePattern;
    }

    public string UsernamePattern { get; }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬å®ç°åä¸º`UsernameRequirementHandler`çš„å¤„ç†ç¨‹åºï¼Œå®ƒä¸å½“å‰ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·åæä¾›çš„æ¨¡å¼ç›¸åŒ¹é…ã€‚

`Policies\Handlers\UsernameRequirementHandler.cs`

```
public class UsernameRequirementHandler : AuthorizationHandler<UsernameRequirement>
{
    protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, UsernameRequirement requirement)
    {
        if (Regex.IsMatch(context.User.Identity.Name, requirement.UsernamePattern))
        {
            context.Succeed(requirement);
        }

        return Task.CompletedTask;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå¦‚æœéœ€æ±‚å¾—åˆ°æ»¡è¶³ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨`AuthorizationHandlerContext`ä¸Šçš„`Succeed`æ–¹æ³•ï¼Œå¦åˆ™å¯¹æ‰€éœ€é¡µé¢çš„è®¿é—®å°†è¢«æ‹’ç»ã€‚

æœ€åï¼Œæˆ‘ä»¬å¿…é¡»è®¾ç½®æˆæƒæœåŠ¡æ¥ä½¿ç”¨è¿™äº›æ–°ç±»ã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬å›åˆ°`Startup`ç±»ã€‚

`Startup.cs`

```
public void ConfigureServices(IServiceCollection services)
{
    // ...
    services.AddAuthorization(options =>
    {
        // ...
        options.AddPolicy("AnotherSamplePolicy", policy => policy.Requirements.Add(new UsernameRequirement(".*someone.*")));
    });

    services.AddSingleton<IAuthorizationHandler, UsernameRequirementHandler>();
    // ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæˆ‘ä»¬å¿…é¡»åšä¸¤ä»¶äº‹:é…ç½®ä¸€ä¸ªç­–ç•¥æ¥ä½¿ç”¨æ–°çš„éœ€æ±‚ï¼Œå¹¶å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ã€‚

ä¸ºäº†é…ç½®ç­–ç•¥ï¼Œæˆ‘ä»¬åƒä»¥å‰ä¸€æ ·ä½¿ç”¨`AddPolicy`ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å‘ç­–ç•¥çš„`Requirements`é›†åˆæ·»åŠ ä¸€ä¸ªæ–°çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯`RequireClaim`ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„`UsernameRequirement`å®ä¾‹ï¼Œå…¶æ¨¡å¼ä¸ç”¨æˆ·åç›¸åŒ¹é…ã€‚

å°†`UsernameRequirementHandler`æ·»åŠ åˆ° DI ä¸­ä¸æˆ‘ä»¬ç°åœ¨æ‰€ä¹ æƒ¯çš„æ›´åŠ ç›¸ä¼¼ã€‚æˆ‘æŠŠå®ƒä½œä¸ºå•ä¾‹æ·»åŠ ï¼Œå› ä¸ºå®ƒæ—¢æ²¡æœ‰çŠ¶æ€ä¹Ÿæ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ä¿å­˜ä¸€ä¸ªå•ä¸ªå®ä¾‹ï¼Œä¸éœ€è¦æ€»æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚

### [](#shoutout-to-resourcebased-authorization)å–Šå‡ºåŸºäºèµ„æºçš„æˆæƒ

è™½ç„¶æˆ‘ä»¬ä¸ä¼šåœ¨è¿™ç¯‡æ–‡ç« ä¸­çœŸæ­£æ¢è®¨åŸºäºèµ„æºçš„æˆæƒï¼Œä½†æˆ‘è®¤ä¸ºæ„è¯†åˆ°å®ƒçš„å­˜åœ¨æ˜¯å¾ˆé‡è¦çš„ã€‚

åœ¨æˆ‘ä»¬åœ¨å½“å‰å¸–å­ä¸­çœ‹åˆ°çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯æ ¹æ®ä¸€äº›é™æ€ä¿¡æ¯(ä¾‹å¦‚ï¼Œæ˜¯ç®¡ç†å‘˜ï¼Œæœ‰æŸä¸ªç”¨æˆ·åï¼Œ...).è¿™åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸å¤Ÿçš„ï¼Œé™¤äº†è¢«è®¿é—®çš„é¡µé¢ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æƒ³ç¡®ä¿ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„å†…å®¹ã€‚

ä»¥æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„ç»„ç®¡ç†æœåŠ¡ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿè®¿é—®æ‰€æœ‰çš„ç»„ï¼Œè€Œåªèƒ½è®¿é—®ç”¨æˆ·æ‰€å±çš„ç»„ã€‚è¿™ä¸èƒ½ä»…ä»…ç”¨æˆ‘ä»¬ä¸€ç›´ä½¿ç”¨çš„é™æ€è§„åˆ™æ¥å¼ºåˆ¶æ‰§è¡Œï¼Œå®ƒå°†å–å†³äºè¢«è®¿é—®çš„ç‰¹å®šèµ„æºã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸€å † if ä¸æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ä»£ç æ··åˆåœ¨ä¸€èµ·ï¼Œæˆ–è€…ä»¥ä¸€ç§æ›´åŠ åˆ†ç¦»çš„æ–¹å¼æ¥å®Œæˆã€‚æ­£å¦‚æˆ‘ä»¬åœ¨[æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/resourcebased?view=aspnetcore-2.2)ä¸­çœ‹åˆ°çš„ï¼ŒASP.NET æ ¸å¿ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›è®¾æ–½æ¥å®ç°å®ƒã€‚

åœ¨ä»¥åçš„å¸–å­ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ¢è®¨è¿™ä¸ªä¸»é¢˜(æˆ–è€…ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥å®ç°ç›¸åŒçš„ä¸»é¢˜)ï¼Œæœ€ç»ˆæ˜¯é’ˆå¯¹æˆ‘åˆšæ‰æåˆ°çš„ç»„ç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘æƒ³å°†è¿™äº›ä¿¡æ¯ç•™åœ¨è¿™é‡Œï¼Œä»¥ä¾›ä»»ä½•æ­£åœ¨å¯»æ‰¾å®ç°è¿™ç§ç²’åº¦è®¿é—®æ§åˆ¶çš„æ–¹æ³•çš„äººä½¿ç”¨ã€‚

## [](#outro)å…¶ä»–

å¿«é€Ÿæµè§ˆä¸€ä¸‹ï¼Œå°±æ˜¯è¿™ä¸ªã€‚é€šè¿‡ ASP.NET æ ¸å¿ƒæä¾›çš„æˆæƒç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åšæ›´å¤šçš„äº‹æƒ…(æˆ‘çœŸçš„é¼“åŠ±ä½ å»æ¢ç´¢[æ–‡æ¡£](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/introduction?view=aspnetcore-2.2))ï¼Œä½†æ˜¯è¦æœ‰ä¸€äº›å¯èƒ½æ€§çš„åŸºç¡€çŸ¥è¯†ï¼Œå¸Œæœ›è¿™äº›ä¾‹å­æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹ã€‚åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨ä¸€äº›æ›´ç›¸å…³çš„ç‰¹æ€§ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [ASP.NET æ ¸å¿ƒæˆæƒä»‹ç»](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/introduction?view=aspnetcore-2.2)
*   [ASP.NET æ ¸å¿ƒä¸­åŸºäºè§’è‰²çš„æˆæƒ](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-2.2)
*   [ASP.NET æ ¸å¿ƒä¸­åŸºäºç­–ç•¥çš„æˆæƒ](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-2.2)
*   [ASP.NET æ ¸å¿ƒä¸­åŸºäºèµ„æºçš„æˆæƒ](https://docs.microsoft.com/en-us/aspnet/core/security/authorization/resourcebased?view=aspnetcore-2.2)

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode019)ã€‚

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼