# è®©æˆ‘ä»¬æ¥æ„å»º:ä½¿ç”¨ Ruby on Rails -å¸¦ Stripe è®¢é˜…æ”¯ä»˜çš„å›¾ä¹¦å›¾ä¹¦é¦†åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev.to/justalever/lets-build-with-ruby-on-rails-å›¾ä¹¦-å›¾ä¹¦é¦†-å¸¦æ¡çº¹çš„åº”ç”¨-è®¢é˜…-æ”¯ä»˜-4f8b](https://dev.to/justalever/lets-build-with-ruby-on-rails---book-library-app-with-stripe-subscription-payments-4f8b)

æ¬¢è¿æ¥åˆ°æˆ‘çš„å…³äº Ruby on Rails çš„æ„å»ºç³»åˆ—ã€‚è¿™ä¸€æœŸé‡ç‚¹å…³æ³¨ä½¿ç”¨ Ruby on Rails ä½œä¸º web åº”ç”¨ç¨‹åºæ¡†æ¶æ¥å—æ”¯ä»˜ã€‚æˆ‘ä»¬å°† Ruby on Rails ä¸ Stripe åˆä½œï¼Œä¸ºä¸€ä¸ªè™šæ‹Ÿçš„å›¾ä¹¦å›¾ä¹¦é¦†åº”ç”¨ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ªåŸºäºè®¢é˜…çš„ SaaS æ¨¡å‹ã€‚

### è¿™ä¸ªç‰ˆæœ¬æœ‰ä»€ä¹ˆæ–°ç‰¹æ€§ï¼Ÿ

*   Rails 5.2 å‡ºç°äº†
*   æˆ‘ä»¬ä½¿ç”¨ Rails 5.2 ä¸­æ–°å¢çš„[åŠ¨æ€å­˜å‚¨](http://edgeguides.rubyonrails.org/active_storage_overview.html)ã€‚æˆ‘ä»¬ä¸å†éœ€è¦å›å½¢é’ˆæˆ– Carrierwave ç­‰ç¬¬ä¸‰æ–¹å®çŸ³ã€‚
*   æ–°çš„åŠ å¯†ç§˜å¯†ï¼Œä½¿ç®¡ç†ä»»ä½•ç¯å¢ƒå˜é‡æˆ–å¯†é’¥çš„æ–¹å¼æ›´å®¹æ˜“ã€‚ç”±äºåŠ å¯†çš„è´¨é‡ï¼Œæ‚¨å¯ä»¥æ”¾å¿ƒåœ°å°†å®ƒä»¬æäº¤ç»™ç‰ˆæœ¬æ§åˆ¶
*   [Stripe è®¡è´¹](https://stripe.com/billing) - Stripe æœ€è¿‘å‘å¸ƒäº†ä¸€ç§å›´ç»•å…¶è®¢é˜…äº§å“çš„æ–°æ¨¡å¼ã€‚åœ¨æ¡å¸¦è®¡è´¹ä¸­ï¼Œæ‚¨å¯ä»¥å®šä¹‰å…·æœ‰å…³è”è®¡åˆ’çš„è¦†ç›–äº§å“ã€‚è¿™æ˜¯ä¸€ç§æ›´å¥½çš„æ†ç»‘é”€å”®çš„æ–¹å¼ï¼Œä½†ä»ç„¶èƒ½å¤Ÿä»¥ä¸åŒçš„æ–¹å¼é”€å”®ï¼Œå³ç»Ÿä¸€ä»·æ ¼ã€å¤šç§è®¡åˆ’ã€æŒ‰åº§ä½ã€åŸºäºä½¿ç”¨å’Œç»Ÿä¸€ä»·æ ¼+è¶…é¢ã€‚

æˆ‘ä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„ Ruby on Rails åº”ç”¨ç¨‹åºæ¨¡æ¿(åŸºäºæœ¬ç³»åˆ—ä¸­çš„[å¸ƒå°”ç› CSS](https://bulma.io/) ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½

## ![GitHub logo](../Images/292a238c61c5611a7f4d07a21d9e8e0a.png) [ justalever ](https://github.com/justalever) / [å›¾ä¹¦ _ å›¾ä¹¦é¦†](https://github.com/justalever/book_library)

### ä¸€ä¸ªåŸºäº SaaS çš„æ¼”ç¤ºåº”ç”¨ç¨‹åºï¼Œå›´ç»•å›¾ä¹¦ä¸‹è½½å’Œæ¡çº¹è®¢é˜…

<article class="markdown-body entry-content container-lg" itemprop="text">

[![Let's Build](../Images/edcee5e791ca451d3df661bc3ead7e38.png)T2ã€‘](https://camo.githubusercontent.com/d74ab506a95ed289aafa177981e37a7fe61f24df2e35493dd58d4d3222e58656/68747470733a2f2f692e696d6775722e636f6d2f6b47594e724e472e6a7067)

# è®©æˆ‘ä»¬æ¥æ„å»º:ç”¨ Ruby on Railsâ€”â€”ä¸€ä¸ªå¸¦ Stripe è®¢é˜…æ”¯ä»˜çš„å›¾ä¹¦å›¾ä¹¦é¦†åº”ç”¨

æ¬¢è¿æ¥åˆ°æˆ‘çš„ç¬¬åä¸€æœŸè®©æˆ‘ä»¬æ„å»ºä»¥ Ruby on Rails ä¸ºç‰¹è‰²çš„ç³»åˆ—ã€‚è¿™ä¸€æœŸå†æ¬¡å…³æ³¨ä½¿ç”¨ Ruby on Rails ä½œä¸º web åº”ç”¨ç¨‹åºæ¡†æ¶æ¥å—æ”¯ä»˜ã€‚æˆ‘ä»¬å°† Ruby on Rails ä¸ Stripe åˆä½œï¼Œä¸ºå›¾ä¹¦å›¾ä¹¦é¦†åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªåŸºäºè®¢é˜…çš„ SaaS æ¨¡å‹ã€‚

### è¿™ä¸ªå»ºç­‘æœ‰ä»€ä¹ˆæ–°ç‰¹ç‚¹ï¼Ÿ

*   Rails 5.2 å‡ºç°äº†
*   æˆ‘ä»¬ä½¿ç”¨ Rails 5.2 ä¸­æ–°å¢çš„[åŠ¨æ€å­˜å‚¨](http://edgeguides.rubyonrails.org/active_storage_overview.html)ã€‚æˆ‘ä»¬ä¸å†éœ€è¦å›å½¢é’ˆæˆ– Carrierwave ç­‰ç¬¬ä¸‰æ–¹å®çŸ³ã€‚
*   æ–°çš„åŠ å¯†ç§˜å¯†ï¼Œä½¿ç®¡ç†ä»»ä½•ç¯å¢ƒå˜é‡æˆ–å¯†é’¥çš„æ–¹å¼æ›´å®¹æ˜“ã€‚ç”±äºåŠ å¯†çš„è´¨é‡ï¼Œæ‚¨å¯ä»¥æ”¾å¿ƒåœ°å°†å®ƒä»¬æäº¤ç»™ç‰ˆæœ¬æ§åˆ¶
*   [Stripe è®¡è´¹](https://stripe.com/billing) - Stripe æœ€è¿‘å‘å¸ƒäº†ä¸€ç§å›´ç»•å…¶è®¢é˜…äº§å“çš„æ–°æ¨¡å¼ã€‚åœ¨æ¡å¸¦è®¡è´¹ä¸­ï¼Œæ‚¨å¯ä»¥å®šä¹‰å…·æœ‰å…³è”è®¡åˆ’çš„è¦†ç›–äº§å“ã€‚è¿™æ˜¯ä¸€ç§æ›´å¥½çš„æ†ç»‘æ–¹å¼â€¦

</article>

[View on GitHub](https://github.com/justalever/book_library)

### [](#the-book-library-application)å›¾ä¹¦å€Ÿé˜…ç”³è¯·

è¯¥åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªç®€å•çš„å›¾ä¹¦åº”ç”¨ç¨‹åºï¼Œå…è®¸ç”¨æˆ·åœ¨å›¾ä¹¦é¦†ä¸­æ·»åŠ å’Œåˆ é™¤å›¾ä¹¦ã€‚ä¸€æ—¦ç”¨æˆ·è®¢é˜…ï¼Œè¿™äº›ä¹¦å°±å¯ä»¥ä¸‹è½½é˜…è¯»ã€‚åªæœ‰åœ¨ç”¨æˆ·è®¢é˜…çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è®¿é—®åº“ã€‚è¿™æ¬¾åº”ç”¨ä¸åŒäºä»¥å‰çš„åº”ç”¨ï¼Œä»¥å‰çš„åº”ç”¨è¦æ±‚ç”¨æˆ·å¿…é¡»å…ˆä»˜è´¹æ‰èƒ½åˆ›å»ºè´¦æˆ·ã€‚

å‘ç”¨æˆ·å‘ˆç°ç”¨äºå‘ä»–ä»¬çš„å›¾ä¹¦é¦†æ·»åŠ ä¹¦çš„æŒ‰é’®ã€‚æ­£å¦‚æ‚¨æ‰€çŒœæµ‹çš„ï¼Œè¦æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œç”¨æˆ·é¦–å…ˆéœ€è¦ä¸€ä¸ªå¸æˆ·ã€‚ç‚¹å‡»â€œæ·»åŠ åˆ°åº“â€æŒ‰é’®åï¼Œé¢å‘å…¬ä¼—çš„ç”¨æˆ·(æ²¡æœ‰å¸æˆ·çš„äºº)è¢«é‡å®šå‘åˆ°ä¸€ä¸ªæ³¨å†Œé¡µé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨[device](https://github.com/plataformatec/devise)gem å®ç°è¯¥é¡µé¢ã€‚

Devise çš„ä¸€ä¸ªå¾ˆå¥½çš„å›è°ƒå‡½æ•°å…è®¸æˆ‘ä»¬åœ¨æˆåŠŸæ³¨å†Œåé‡å®šå‘ç”¨æˆ·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸€ä¸ªå®šä»·é¡µé¢ï¼Œè¯¥é¡µé¢æœ‰ä¸‰ç§æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ã€‚æ¯ä¸ªè®¡åˆ’éƒ½æœ‰è‡ªå·±çš„ç›¸å…³å‚æ•°ã€‚ç‚¹å‡»ä»»æ„ä¸€å±‚ä¸Šçš„â€œsubscribeâ€æŒ‰é’®ï¼Œç”¨æˆ·å°†è¢«é‡å®šå‘åˆ°ä¸€ä¸ªæ”¯ä»˜é¡µé¢ï¼Œè¯¥é¡µé¢å¸¦æœ‰å¿…è¦çš„å‚æ•°ä»¥è¿æ¥åˆ° Stripeã€‚

çœ‹ä¼¼ç®€å•çš„åº”ç”¨ç¨‹åºæ‰¿è½½äº†ä¸€äº›é€»è¾‘å’Œé‡é‡æ¥è¦†ç›–æˆ‘ä»¬æ‰€æœ‰çš„è½¨è¿¹ã€‚è¿™ä¸ªåº”ç”¨ç¨‹åºè¿˜è¿œæœªå®Œæˆï¼Œä½†æ˜¯ä½ å¯ä»¥ï¼Œæ— è®ºå¦‚ä½•ï¼Œæ‰©å±•å®ƒã€‚

æˆ‘æ²¡æœ‰æ—¶é—´äº†ï¼Œä½†æ˜¯æ‰©å±•è¿™ä¸ªåº”ç”¨ç¨‹åºçš„ä¸€ä¸ªæ˜æ˜¾çš„åœ°æ–¹æ˜¯ä¿å­˜ç”¨æˆ·å·²ç»è®¢é˜…çš„è®¡åˆ’ã€‚è¿™å¯ä»¥åœ¨ä»–ä»¬åˆ›å»ºè®¢é˜…æ—¶å®Œæˆã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æŸ¥è¯¢åº”ç”¨ç¨‹åºä¸­çš„ä¸åŒä½ç½®ï¼Œä»¥æ ¹æ®å…¶å¹³é¢å›¾ç±»å‹æ˜¾ç¤ºå’Œéšè—ç‰¹å®šè¦ç´ ã€‚

#### [](#part-1)ç¬¬ä¸€éƒ¨åˆ†

[https://www.youtube.com/embed/eS52517o6Ck](https://www.youtube.com/embed/eS52517o6Ck)

#### [](#part-2)ç¬¬äºŒéƒ¨åˆ†

[https://www.youtube.com/embed/JG1whaC_8i8](https://www.youtube.com/embed/JG1whaC_8i8)

#### [](#part-3)ç¬¬ä¸‰éƒ¨åˆ†

[https://www.youtube.com/embed/mOS-tzf7xXA](https://www.youtube.com/embed/mOS-tzf7xXA)

#### [](#part-4)ç¬¬å››éƒ¨åˆ†

[https://www.youtube.com/embed/56vbxhw3S2o](https://www.youtube.com/embed/56vbxhw3S2o)

#### [](#part-5)ç¬¬äº”éƒ¨åˆ†

[https://www.youtube.com/embed/GUbLcffLY7I](https://www.youtube.com/embed/GUbLcffLY7I)

#### [](#part-6)ç¬¬å…­éƒ¨åˆ†

[https://www.youtube.com/embed/cSKEFco7HdA](https://www.youtube.com/embed/cSKEFco7HdA)

#### [](#models-and-relationships)æ¨¡å‹å’Œå…³ç³»

æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåªæœ‰ä¸‰ç§å‹å·ã€‚æˆ‘ä»¬æ€»æ˜¯é€šè¿‡å›¾ä¹¦é¦†æ¨¡å‹æ¥è®¿é—®ä¹¦ç±å’Œç”¨æˆ·ã€‚è¿™æœ€ç»ˆæˆä¸ºä¸€ä¸ª`many-to-many`å…³è”ã€‚

**ç”¨æˆ·**

```
 email
name
stripe_id
stripe_subscription_id
card_last4
card_exp_month
card_exp_year
card_type
admin
subscribed 
```

**é¢„å®š**

```
 title
description
author
user_id 
```

**å›¾ä¹¦é¦†**

```
 book_id
user_id 
```

è¿™äº›å…³ç³»æœ€ç»ˆå¦‚ä¸‹æ‰€ç¤º:

```
 #app/models/book.rb

class Book < ApplicationRecord
  has_one_attached :thumbnail
  belongs_to :user
  has_many :libraries
  has_many :added_books, through: :libraries, source: :user
 end 
```

```
 #app/models/library

class Library < ApplicationRecord
  belongs_to :book
  belongs_to :user
end 
```

```
 #app/models/user
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable and :omniauthable
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :trackable, :validatable
  has_many :charges
  has_many :books, dependent: :destroy
  has_many :libraries
  has_many :library_additions, through: :libraries, source: :book

  def subscribed?
    stripe_subscription_id?
  end
end 
```

### [](#controllers)æ§åˆ¶å™¨

å½“æäº¤ä¸€ä¸ªæˆåŠŸçš„ä»˜æ¬¾ä»¥åŠè®¢é˜…ä¸€ä¸ªæ–°ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬çš„æ§åˆ¶å™¨æ˜¯è®¸å¤šå¥‡è¿¹å‘ç”Ÿçš„åœ°æ–¹ã€‚

æœ€å®¹æ˜“å¼€å§‹çš„æ§åˆ¶å™¨æ˜¯æˆ‘ä»¬çš„å›¾ä¹¦æ§åˆ¶å™¨ã€‚è¿™æ¨¡ä»¿äº†æˆ‘ä»¬ä»¥å‰çš„è®¸å¤šç³»åˆ—ï¼Œå…¶ä¸­ç”¨æˆ·éœ€è¦ä¸å¦ä¸€ä¸ªæ¨¡å‹ç›¸å…³è”ã€‚ç¡®ä¿ä½ çš„`Book`æ¨¡å‹æœ‰ä¸€ä¸ª`user_id`å­—æ®µã€‚

#### [](#books-controller)è´¦æœ¬æ§åˆ¶å™¨

```
 class BooksController < ApplicationController
  before_action :set_book, only: [:show, :edit, :update, :destroy, :library]
  before_action :authenticate_user!, except: [:index, :show]

  # GET /books
  # GET /books.json
  def index
    @books = Book.all
  end

  # GET /books/1
  # GET /books/1.json
  def show
  end

  # GET /books/new
  def new
    @book = current_user.books.build
  end

  # GET /books/1/edit
  def edit
  end

  # POST /books
  # POST /books.json
  def create
    @book = current_user.books.build(book_params)

    respond_to do |format|
      if @book.save
        format.html { redirect_to @book, notice: 'Book was successfully created.' }
        format.json { render :show, status: :created, location: @book }
      else
        format.html { render :new }
        format.json { render json: @book.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /books/1
  # PATCH/PUT /books/1.json
  def update
    respond_to do |format|
      if @book.update(book_params)
        format.html { redirect_to @book, notice: 'Book was successfully updated.' }
        format.json { render :show, status: :ok, location: @book }
      else
        format.html { render :edit }
        format.json { render json: @book.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /books/1
  # DELETE /books/1.json
  def destroy
    @book.destroy
    respond_to do |format|
      format.html { redirect_to books_url, notice: 'Book was successfully destroyed.' }
      format.json { head :no_content }
    end
  end

  # Add and remove books to library
  # for current_user
  def library
    type = params[:type]

    if type == "add"
      current_user.library_additions << @book
      redirect_to library_index_path, notice: "#{@book.title} was added to your library"

    elsif type == "remove"
      current_user.library_additions.delete(@book)
      redirect_to root_path, notice: "#{@book.title} was removed from your library"
    else
      # Type missing, nothing happens
      redirect_to book_path(@book), notice: "Looks like nothing happened. Try once more!"
    end
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_book
      @book = Book.find(params[:id])
    end

    # Never trust parameters from the scary internet, only allow the whitelist through.
    def book_params
      params.require(:book).permit(:title, :description, :author, :thumbnail, :user_id)
    end
end 
```

åœ¨è¿™ä¸ªæ§åˆ¶å™¨ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªæ–°çš„åŠ¨ä½œã€‚æ­¤æ“ä½œå…è®¸æˆ‘ä»¬å®é™…å‘ç»™å®šç”¨æˆ·çš„å›¾ä¹¦é¦†æ·»åŠ ä¸€æœ¬ä¹¦ã€‚æˆ‘ä»¬ä»è§†å›¾ä¸­è·å–ä¼ é€’çš„å‚æ•°ï¼Œå¹¶ç¡®å®šæˆ‘ä»¬æ˜¯æ·»åŠ è¿˜æ˜¯åˆ é™¤å›¾ä¹¦ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯ä»¥æ”¹å–„ UXã€‚

```
 # Add and remove books to the library
  # for current_user
  def library
    type = params[:type]

    if type == "add"
      current_user.library_additions << @book
      redirect_to library_index_path, notice: "#{@book.title} was added to your library"

    elsif type == "remove"
      current_user.library_additions.delete(@book)
      redirect_to root_path, notice: "#{@book.title} was removed from your library"
    else
      # Type missing, nothing happens
      redirect_to book_path(@book), notice: "Looks like nothing happened. Try once more!"
    end
  end 
```

è¯¥æ“ä½œç¡®å®éœ€è¦å¯¹æˆ‘ä»¬çš„ routes æ–‡ä»¶è¿›è¡Œä¸€äº›æ›´æ”¹ã€‚æœ€ç»ˆçš„è·¯ç”±æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º:

```
 #config/routes.rb

require 'sidekiq/web'

Rails.application.routes.draw do

  resources :library, only:[:index]
  mount Sidekiq::Web => '/sidekiq'

  resources :books do
    member do
      put "add", to: "books#library"
      put "remove", to: "books#library"
    end
  end

  devise_for :users, controllers: { registrations: "registrations" }
  root to: 'books#index'
  resources :pricing, only:[:index]
  resources :subscriptions
end 
```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨`resources :books`ä¸­å£°æ˜äº†ä¸€ä¸ªå—ï¼Œå¹¶æ·»åŠ äº†ä¸€ä¸ª`member` do å—ã€‚

åœ¨æˆ‘ä»¬çš„`_book.html.erb`éƒ¨åˆ†ä¸­ï¼Œä½¿è¿™ä¸€åˆ‡å·¥ä½œçš„ç›¸åº”æ ‡è®°å¦‚ä¸‹æ‰€ç¤ºã€‚

```
 <div class="content">
   <% if subscribed? %>

    <% if user_added_to_library?(current_user, book) %>

      <%= link_to 'Remove from library', add_book_path(book, type: "remove"), method: :put, class: "button is-danger is-fullwidth" %>

      <% if controller.controller_name == "library" %>
        <%= link_to 'Download', '#', class:"button is-success is-fullwidth mt1" %>
      <% end %>

    <% else %>
      <%= link_to 'Add to library', add_book_path(book, type: "add"), method: :put, class: "button is-link is-fullwidth" %>
    <% end %>

  <% else %>
    <%= link_to 'Add to library', new_user_registration_path, class: "button is-link is-fullwidth" %>
  <% end %>
</div> 
```

æˆ‘ä»¬åœ¨è¿™é‡Œåšäº†å¾ˆå¤šäº‹æƒ…ï¼Œä½†æ˜¯ä¸»è¦çš„ç„¦ç‚¹æ˜¯`link_to`æ–¹æ³•ã€‚è¿™äº›é€šè¿‡`add_book_path()`å’Œ`book`ï¼Œä»¥åŠ`type`çš„â€œæ·»åŠ â€æˆ–â€œåˆ é™¤â€ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™æ ·çš„é“¾æ¥ä¼ é€’ä»»ä½•å‚æ•°ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„è·¯ç”±åŒ¹é…å‘½åçº¦å®šï¼Œæ‰€ä»¥å®ƒä»¬æ‰è¿™æ ·åšã€‚

#### [](#subscriptions-controller)è®¢é˜…æ§åˆ¶å™¨

```
 class SubscriptionsController < ApplicationController
  layout "subscribe"
  before_action :authenticate_user!, except: [:new, :create]

  def new
    if user_signed_in? && current_user.subscribed?
      redirect_to root_path, notice: "You are already a subscriber!"
    end
  end

  def create
    Stripe.api_key = Rails.application.credentials.stripe_api_key

    plan_id = params[:plan_id]
    plan = Stripe::Plan.retrieve(plan_id)
    token = params[:stripeToken]

    product = Stripe::Product.retrieve(Rails.application.credentials.book_library)

    customer = if current_user.stripe_id?
                 Stripe::Customer.retrieve(current_user.stripe_id)
               else
                 Stripe::Customer.create(email: current_user.email, source: token)
               end

    subscription = customer.subscriptions.create(plan: plan.id)

    options = {
      stripe_id: customer.id,
      stripe_subscription_id: subscription.id,
      subscribed: true,
    }

    options.merge!(
      card_last4: params[:user][:card_last4],
      card_exp_month: params[:user][:card_exp_month],
      card_exp_year: params[:user][:card_exp_year],
      card_type: params[:user][:card_type]
    ) if params[:user][:card_last4]

    current_user.update(options)

    redirect_to root_path, notice: "ğŸ‰ Your subscription was set up successfully!"
  end

  def destroy
    customer = Stripe::Customer.retrieve(current_user.stripe_id)
    customer.subscriptions.retrieve(current_user.stripe_subscription_id).delete
    current_user.update(stripe_subscription_id: nil)

    redirect_to root_path, notice: "Your subscription has been cancelled."
  end

end 
```

æˆ‘ä»¬çš„è®¢é˜…æ§åˆ¶å™¨è·å¾—äº†ä¸ Stripe gem å…³è”æ‰€éœ€çš„æ‰€æœ‰é€»è¾‘ã€‚ç»“åˆ Stripe å…ƒç´ åº“ä¸­çš„ä¸€äº›æ ‡è®°å’Œ Javascriptï¼Œæˆ‘ä»¬ä»è§†å›¾ä¸­è·å–å‚æ•°ã€‚

```
 plan_id = params[:plan_id] # passed in through the view
 plan = Stripe::Plan.retrieve(plan_id) # retrives the plans on stripe.com of which we already made
 token = params[:stripeToken] # necessary to submit payment to stripe 
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ£€ç´¢ä¸€ä¸ªç°æœ‰çš„å®¢æˆ·ï¼Œæˆ–è€…ç”¨ä¸‹é¢å‡ è¡Œåˆ›å»ºä¸€ä¸ªæ–°å®¢æˆ·:

```
 customer = if current_user.stripe_id?
                 Stripe::Customer.retrieve(current_user.stripe_id)
               else
                 Stripe::Customer.create(email: current_user.email, source: token)
               end 
```

æœ€åï¼Œä¸ºäº†åˆ›å»ºæ–°çš„è®¢é˜…ï¼Œæˆ‘ä»¬å°†è¿™ä¸€è¡Œç§°ä¸º:

```
 subscription = customer.subscriptions.create(plan: plan.id) 
```

åœ¨æ­¤æœŸé—´ï¼Œæ‚¨å¯ä»¥æ›´æ–°ä¸€äº›ä¸æ‚¨çš„ç”¨æˆ·ç›¸å…³çš„å†…å®¹:

```
 options = {
      stripe_id: customer.id, # saves customer id for later
      stripe_subscription_id: subscription.id, # allows us to modify subscription where applicable
      subscribed: true, # dictates if a user is subscribed or not
    }

    options.merge!(
      card_last4: params[:user][:card_last4],
      card_exp_month: params[:user][:card_exp_month],
      card_exp_year: params[:user][:card_exp_year],
      card_type: params[:user][:card_type]
    ) if params[:user][:card_last4]

    current_user.update(options) # updates/adds all options to user account from above

    redirect_to root_path, notice: "ğŸ‰ Your subscription was set up successfully!" 
```

å¤§é‡æ•°æ®çš„è§†å›¾æ˜¾ç¤ºå¦‚ä¸‹:

```
 <!-- app/views/subscriptions/new -->
<section class="section">
  <div class="columns is-centered">
    <div class="column is-6 border pa5">
    <h1 class="title is-3">Subscribe</h1>
    <hr />
      <p>Chosen plan: <strong><%= params[:plan] %></strong></p>
    <hr />
  <%= form_tag subscriptions_path, id: "payment-form" do |form| %>

    <div class="field">

      <label class="label" for="card-element">
        Enter credit or debit card
      </label>

      <div id="card-element">
        <!-- A Stripe Element will be inserted here. -->
      </div>

      <!-- Used to display Element errors. -->
      <div id="card-errors" role="alert"></div>

      <%= hidden_field_tag :plan_id, params[:plan_id] %>

    <button class="button is-fullwidth is-link mt4">Submit</button>
  </div>

<% end %>

</div>
</div>
</section> 
```

æœ€ç»ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Stripe å…ƒç´ æ¥å‘ˆç°æ”¯ä»˜è¡¨å•ã€‚è¡¨å•è¾“å…¥æ˜¯ä½¿ç”¨ JavaScript å’Œé”™è¯¯å¤„ç†ç”Ÿæˆçš„ã€‚æˆ‘å‘ç°è¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯æ»šåŠ¨ä½ è‡ªå·±çš„è¡¨å•ã€‚å¦‚æœä½ éœ€è¦åƒè´å®ä¸€æ ·å¤„ç†å¤šä¸ªå•†å®¶ï¼Œä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹ã€‚

åœ¨ç”¨æˆ·ç™»é™†è¿™ä¸ªé¡µé¢ä¹‹å‰ï¼Œä»–ä»¬å·²ç»ä»ä»–ä»¬é€‰æ‹©è®¡åˆ’çš„å®šä»·é¡µé¢æ¥äº†ã€‚æ¯ä¸ªè®¡åˆ’éƒ½æœ‰ä¸€ä¸ªä¼ é€’ç»™è¯¥è§†å›¾çš„ç›¸å…³å‚æ•°ï¼Œè¯¥å‚æ•°è§£é‡Šäº†`params[:plan]`ä»¥åŠéšè—çš„å­—æ®µæ ‡ç­¾:

```
 <%= hidden_field_tag :plan_id, params[:plan_id] %> 
```

æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥çŸ¥é“å“ªä¸ªè®¡åˆ’å‘ç”¨æˆ·æ”¶è´¹ã€‚è¿™æ˜¯ä¸€ç§å¿«é€Ÿçš„æ–¹æ³•ã€‚è¿™ä¸ª id æ¥è‡ªå®šä»·é¡µé¢ï¼Œæˆ‘å°†åœ¨ä¸‹é¢è®¨è®ºï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ç°è¿™ä¸€åˆ‡æ‰€éœ€çš„ JavaScript:

```
 document.addEventListener("turbolinks:load", function() {
  const publishableKey = document.querySelector("meta[name='stripe-key']").content;
  const stripe = Stripe(publishableKey);

  const elements = stripe.elements({
    fonts: [{
      cssSrc: "https://rsms.me/inter/inter-ui.css"
    }],
    locale: 'auto'
  });

  // Custom styling can be passed to options when creating an Element.
  const style = {
    base: {
      color: "#32325D",
      fontWeight: 500,
      fontFamily: "Inter UI, Open Sans, Segoe UI, sans-serif",
      fontSize: "16px",
      fontSmoothing: "antialiased",

      "::placeholder": {
        color: "#CFD7DF"
      }
    },
    invalid: {
      color: "#E25950"
    }
  };

  // Create an instance of the card Element.
  const card = elements.create('card', { style });

  // Add an instance of the card Element into the `card-element` <div>.

    card.mount('#card-element');

    card.addEventListener('change', ({ error }) => {

      const displayError = document.getElementById('card-errors');
      if (error) {
        displayError.textContent = error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // Create a token or display an error when the form is submitted.
    const form = document.getElementById('payment-form');

    form.addEventListener('submit', async(event) => {
      event.preventDefault();

      const { token, error } = await stripe.createToken(card);

      if (error) {
        // Inform the customer that there was an error.
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = error.message;
      } else {
        // Send the token to your server.
        stripeTokenHandler(token);
      }
    });

    const stripeTokenHandler = (token) => {
      // Insert the token ID into the form so it gets submitted to the server
      const form = document.getElementById('payment-form');
      const hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);

      ["type", "last4", "exp_month", "exp_year"].forEach(function(field) {
        addCardField(form, token, field);
      });

      // Submit the form
      form.submit();
    }

    function addCardField(form, token, field) {
      let hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', "user[card_" + field + "]");
      hiddenInput.setAttribute('value', token.card[field]);
      form.appendChild(hiddenInput);
    }

}); 
```

å¦‚æœä½ ä¸€æ­¥ä¸€æ­¥åœ°åšï¼Œä½ å¯èƒ½åœ¨ä½ çš„`app/assets/javascripts`ç›®å½•ä¸­æœ‰ä¸€ä¸ª`subscriptions.coffee`æ–‡ä»¶ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œå°†å…¶é‡å‘½åä¸º`subscriptions.js`ï¼Œå¹¶è¾“å…¥ä¸Šé¢çš„ä»£ç ã€‚

æˆ‘ä»¬ä¸ºæ”¯ä»˜æµç¨‹åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰å¸ƒå±€ã€‚è¿™åœ¨æˆ‘ä»¬çš„`subscriptions_controller.rb`ä¸­ç”¨ç®€å•çš„ä¸€è¡Œè¡¨ç¤ºåœ¨æœ€é¡¶ç«¯:

```
 class SubscriptionsController < ApplicationController
  layout "subscribe"
  ...
 end 
```

è¿™å…è®¸æˆ‘ä»¬åœ¨`app/views/layouts/`ä¸­åˆ›å»ºæ–°çš„æ–‡ä»¶`subscribe.html.erb`ã€‚

æ‚¨éœ€è¦åœ¨æ‚¨çš„`subscribe.html.erb`å¸ƒå±€æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª meta æ ‡ç­¾æ¥å®ç°è¿™ä¸€ç‚¹ã€‚æ³¨æ„æˆ‘æ˜¯å¦‚ä½•æ·»åŠ  stripe js åº“çš„`https://js.stripe.com/v3/`ã€‚è¯¥ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```
 <head>
<%= javascript_include_tag 'application', 'https://js.stripe.com/v3/', 'data-turbolinks-track': 'reload' %>

 <%= tag :meta, name: "stripe-key", content: Rails.application.credentials.stripe_publishable_key %>
</head> 
```

ä½œä¸º Rails 5.2 çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ­£åœ¨ä»¥ä¸åŒäºä¹‹å‰ç³»åˆ—çš„æ–¹å¼è®¿é—®æˆ‘ä»¬çš„æ–°å‡­è¯ã€‚è¯·åŠ¡å¿…è§‚çœ‹å¦‚ä½•ç¼–è¾‘/æ›´æ–°/å­˜å‚¨è¿™äº›å†…å®¹çš„è§†é¢‘ã€‚

é€šè¿‡è¾“å‡ºæ‚¨çš„`test` stipe å¯å‘å¸ƒå¯†é’¥ï¼Œæ‚¨ç°åœ¨å·²ç»å‡†å¤‡å¥½ä¸º Stripe å®ç° javascript æ¥å®ç°å®ƒçš„é­”åŠ›ã€‚

### [](#the-pricing-page)å®šä»·é¡µé¢

è·å–æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰è®¡åˆ’å’Œå‚æ•°éœ€è¦ä¸€äº›ç”¨æˆ·è¾“å…¥ã€‚å®šä»·é¡µé¢å¯¹æ­¤è´Ÿè´£ã€‚

```
 <section class="section">
  <div class="has-text-centered box">
    <h1 class="title">Pricing</h1>
    <h2 class="subtitle">Choose the best plan that matches your reading consistency and budget.</h2>
    <div class="pricing-table">
      <div class="pricing-plan is-warning">
        <div class="plan-header">Starter</div>
        <div class="plan-price"><span class="plan-price-amount"><span class="plan-price-currency">$</span>5</span>/month</div>
        <div class="plan-items">
          <div class="plan-item">5 Downloads</div>
        </div>
        <div class="plan-footer">
          <% if user_signed_in? %>
          <%= link_to 'Subscribe', new_subscription_path(plan: "starter", plan_id: Rails.application.credentials.starter), class:"button is-fullwidth" %>
            <% else %>
          <%= link_to 'Subscribe', new_user_registration_path, class:"button is-fullwidth" %>
          <% end %>
        </div>
      </div>
      <div class="pricing-plan is-link is-active">
        <div class="plan-header">Book Worm</div>
        <div class="plan-price"><span class="plan-price-amount"><span class="plan-price-currency">$</span>10</span>/month</div>
        <div class="plan-items">
          <div class="plan-item">10 Downloads</div>
        </div>
        <div class="plan-footer">
          <% if user_signed_in? %>
          <%= link_to 'Subscribe', new_subscription_path(plan: "book_worm", plan_id: Rails.application.credentials.book_work), class:"button is-fullwidth" %>
          <% else %>
          <%= link_to 'Subscribe', new_user_registration_path, class:"button is-fullwidth" %>
          <% end %>
        </div>
      </div>
      <div class="pricing-plan is-danger">
        <div class="plan-header">Scholar</div>
        <div class="plan-price"><span class="plan-price-amount"><span class="plan-price-currency">$</span>30</span>/month</div>
        <div class="plan-items">
          <div class="plan-item">30 Downloads</div>
        </div>
        <div class="plan-footer">
          <% if user_signed_in? %>
          <%= link_to 'Subscribe', new_subscription_path(plan: "scholar", plan_id: Rails.application.credentials.scholar), class:"button is-fullwidth" %>
          <% else %>
          <%= link_to 'Subscribe', new_user_registration_path, class:"button is-fullwidth" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</section> 
```

å¼€ç®±å³ç”¨ï¼Œå¸ƒå°”ç›ä¸æ”¯æŒè¿™ç§æ ‡è®°ã€‚ä½ å¯ä»¥ç”¨è¿™ä¸ªåº“æ¥æ‰©å±• bulmaï¼Œæ·»åŠ é¢å¤–çš„ CSS æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ¯ä¸ªè®¢é˜…æŒ‰é’®éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„å‚æ•°ã€‚æˆ‘ä»¬å°†`plan_id`å‚æ•°å­˜å‚¨ä¸ºç§˜å¯†å‡­è¯ã€‚ä½ å¯ä»¥ä»ä½ åœ¨ stripe.com ä»ªè¡¨ç›˜ä¸Šåˆ›å»ºçš„è®¡åˆ’ä¸­è·å–è¿™äº›ä¿¡æ¯ã€‚æˆ‘ä»¬è¿˜ä¼ é€’è®¡åˆ’åç§°æœ¬èº«ï¼Œåªæ˜¯ä¸ºäº†å¸®åŠ©ä¸‹ä¸€ä¸ªå±å¹•ä¸Šçš„ UXï¼Œè®©ç”¨æˆ·çŸ¥é“ä»–ä»¬æ­£åœ¨è´­ä¹°ä»€ä¹ˆã€‚æ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´çš„ï¼Œè¿™æ˜¯å°†è®¡åˆ’ç±»å‹ä¿å­˜åˆ°æ‚¨çš„ç”¨æˆ·æ¨¡å‹çš„å¥½åœ°æ–¹ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥æŒ‡å®šæ‚¨æƒ³è¦æ¯ä¸ªè®¡åˆ’ç±»å‹çš„å¯ç”¨ç‰¹æ€§ã€‚

### [](#rounding-out)å››èˆäº”å…¥

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºä¼¼ä¹ç›¸å½“ç®€å•ã€‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ Rails 5.2 çš„ä¸€äº›ä»¤äººå…´å¥‹çš„æ–°åŠŸèƒ½ï¼Œæˆ‘å°†åœ¨è§†é¢‘ä¸­æ›´æ·±å…¥åœ°è®¨è®ºè¿™äº›åŠŸèƒ½ã€‚æˆ‘é‚€è¯·æ‚¨ç»§ç»­å…³æ³¨ï¼Œå¹¶ä¸€å¦‚æ—¢å¾€åœ°éšæ—¶æé—®ã€‚ä¸‹é¢çš„è¯„è®ºæˆ– YouTube ä¸Šçš„è¯„è®ºæ˜¯è·å¾—åé¦ˆçš„å¥½æ–¹æ³•ã€‚Github ä¸Šçš„æºä»£ç ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

å¦‚æœä½ èƒ½èµ°åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘çœŸä¸çŸ¥é“è¯¥æ€ä¹ˆæ„Ÿè°¢ä½ ã€‚è¿™æ¬¡ç»å†å¯¹æˆ‘æ¥è¯´æ˜¯ä¸€æ¬¡å·¨å¤§çš„å­¦ä¹ ã€‚æˆ‘é€‰æ‹©åœ¨å…¬å…±åœºåˆå­¦ä¹ ï¼Œä¸ä»…æ˜¯ä¸ºäº†åˆ†äº«æˆ‘å­¦åˆ°çš„ä¸œè¥¿ï¼Œä¹Ÿæ˜¯ä¸ºäº†è·å¾—åé¦ˆï¼Œäº†è§£æˆ‘æ˜¯å¦åšé”™äº†ä»€ä¹ˆæˆ–æ²¡æœ‰è¾¾åˆ°è¦æ±‚ã€‚æ¬¢è¿æ‰¹è¯„ï¼Œå¦‚æœä½ æ˜¯æ–°æ¥çš„ï¼Œä¸€å®šè¦çœ‹çœ‹æˆ‘ä»¥å‰çš„æ‰€æœ‰ç³»åˆ—ã€‚

**ç›¸å…³ç³»åˆ—**

1.  [è®©æˆ‘ä»¬æ„å»º:ä½¿ç”¨ Ruby on Railsâ€”â€”ç®€ä»‹](https://web-crunch.com/lets-build-with-ruby-on-rails-introduction/)
2.  [è®©æˆ‘ä»¬æ„å»º:ä½¿ç”¨ Ruby on Railsâ€”â€”å®‰è£…](https://web-crunch.com/lets-build-with-ruby-on-rails-installation/)
3.  [è®©æˆ‘ä»¬æ„å»º:ç”¨ Ruby on Railsâ€”â€”å¸¦è¯„è®ºçš„åšå®¢](https://web-crunch.com/lets-build-with-ruby-on-rails-blog-with-comments)
4.  [è®©æˆ‘ä»¬æ„å»º:ç”¨ Ruby on Railsâ€”â€”Twitter çš„å…‹éš†ç‰ˆ](https://web-crunch.com/lets-build-with-ruby-on-rails-a-twitter-clone/)
5.  [è®©æˆ‘ä»¬ç”¨ Ruby on Rails æ„å»ºä¸€ä¸ªå¯ç§»æ¤çš„å…‹éš†ç‰ˆæœ¬](https://web-crunch.com/lets-build-dribbble-clone-with-ruby-on-rails/)

### [](#shameless-plug-time)æ— è€»çš„å¡æ—¶é—´

[![](../Images/e4dc18bd4506d5a2ef46a7e214a4132b.png)T2ã€‘](http://hellorails.io)

æˆ‘æœ‰ä¸€é—¨æ–°è¯¾ç¨‹å«åš [Hello Rails](https://hellorails.io) ã€‚Hello Rails æ˜¯ä¸€é—¨ç°ä»£è¯¾ç¨‹ï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨å¿«é€Ÿå¼€å§‹ä½¿ç”¨å’Œç†è§£ Ruby on Railsã€‚å¦‚æœä½ æ˜¯ Ruby æˆ– Ruby on Rails çš„æ–°æ‰‹ï¼Œæˆ‘é‚€è¯·ä½ å»çœ‹çœ‹è¿™ä¸ªç½‘ç«™ã€‚è¯¥è¯¾ç¨‹å°†ä¸è¿™äº›æ„å»ºéå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªè¶…çº§æ·±å…¥çš„ç‰ˆæœ¬ï¼Œå…·æœ‰æ›´ç°å®çš„ç›®æ ‡å’Œå¯äº¤ä»˜æˆæœã€‚[æŠ¥åä»Šå¤©å¾—åˆ°é€šçŸ¥](https://hellorails.io/)ï¼

åœ¨æ¨ç‰¹ä¸Šå…³æ³¨ [@hello_rails](https://twitter.com/hello_rails) å’Œ[æœ¬äºº@justalever](https://twitter.com/justalever) ã€‚