# ç”¨ Node.js å’Œ GraphQL æ„å»ºä¸€ä¸ª CRUD åº”ç”¨

> åŸæ–‡:[https://dev . to/oktadev/build-a-crud-app-with-node-js-and-graph QL-n0m](https://dev.to/oktadev/build-a-crud-app-with-node-js-and-graphql-n0m)

æ„å»ºä¸€ä¸ªç®€å•çš„ CRUD(åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤)åº”ç”¨ç¨‹åºæœ‰å¾ˆå¤šé€‰æ‹©ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€æ–°çš„æ•°æ®è®¿é—®å±‚æ˜¯ GraphQLã€‚è¿™å¾ˆæ£’ï¼Œå› ä¸ºå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ç®€å•çš„å¼ºç±»å‹è¯­è¨€æ¥å®šä¹‰æ¨¡å‹åŠå…¶å…³ç³»ï¼Œç„¶åæä¾›å‡½æ•°æ¥å®šä¹‰æ¯ä¸ªéƒ¨åˆ†åº”è¯¥å¦‚ä½•è§£å†³ã€‚ç„¶åï¼Œç”¨æˆ·å¯ä»¥æŒ‘é€‰ä»–ä»¬æƒ³è¦çš„éƒ¨åˆ†ï¼ŒGraphQL æœåŠ¡å™¨åªæ”¶é›†æœåŠ¡è¯·æ±‚æ‰€éœ€çš„ä¿¡æ¯ã€‚

GraphQL ä¸ä»…æ˜¯ä¸€ä¸ªçœŸæ­£å¼ºå¤§çš„å·¥å…·ï¼Œè€Œä¸”åç«¯å’Œå‰ç«¯å¼€å‘äººå‘˜ä½¿ç”¨èµ·æ¥éƒ½å¾ˆæœ‰è¶£ã€‚ä»Šå¤©ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ GraphQL åˆ›å»ºä¸€ä¸ªç®€å•çš„ CRUD åº”ç”¨ç¨‹åºï¼Œä»¥ä¾¿èƒ½å¤ŸæŸ¥è¯¢å’Œç¼–è¾‘ä¸€ç»„æŠ¥ä»·ã€‚ä½¿ç”¨ Oktaï¼Œæˆ‘è¿˜å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨ GraphQL ä¸­éªŒè¯ç”¨æˆ·ï¼Œä»¥é˜²æ­¢åŒ¿åç”¨æˆ·ç¼–è¾‘ç°æœ‰æŠ¥ä»·ã€‚

## [](#create-the-graphql-server-for-your-nodejs-app)ä¸º Node.js åº”ç”¨ç¨‹åºåˆ›å»º GraphQL æœåŠ¡å™¨

é¦–å…ˆï¼Œæ‚¨éœ€è¦ä¸º Node.js è®¾ç½®ä¸€ä¸ª`package.json`æ¥æ§åˆ¶æ‚¨çš„ä¾èµ–é¡¹ã€‚å®‰è£…`eslint`æ¥å¸®åŠ©æ‚¨æå‰æ•æ‰ä»£ç ä¸­çš„é”™è¯¯ä¹Ÿæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚å¤§å¤šæ•°ç¼–è¾‘å™¨éƒ½æœ‰æŸç§`eslint`æ’ä»¶ï¼Œè¿™æ ·ä½ å°±å¯ä»¥åœ¨ä½ å†™ä»£ç çš„æ—¶å€™çœ‹åˆ°é”™è¯¯ã€‚

```
mkdir node-graphql
cd node-graphql
npm init -y
npm install --save-dev eslint@5.16.0 
```

åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`.eslintrc`æ¥æ·»åŠ ä¸€äº›åŸºæœ¬çš„è®¾ç½®ï¼Œè¿™æ · eslint å°±å¯ä»¥å¯¹ä½ æ­£åœ¨ä½¿ç”¨çš„ç¯å¢ƒæœ‰æ‰€äº†è§£:

```
{  "extends":  "eslint:recommended",  "parserOptions":  {  "ecmaVersion":  2018  },  "env":  {  "es6":  true,  "node":  true  }  } 
```

ç°åœ¨ç¼–è¾‘ä½ çš„`package.json`æ–‡ä»¶ï¼Œä½¿`scripts`éƒ¨åˆ†çœ‹èµ·æ¥åƒè¿™æ ·:

```
{  "start":  "node .",  "test":  "eslint ."  } 
```

æ‚¨çš„ç¼–è¾‘å™¨åº”è¯¥å†…è”ç»™æ‚¨è­¦å‘Šï¼Œä½†æ˜¯æ‚¨ç°åœ¨ä¹Ÿå¯ä»¥éšæ—¶è¿è¡Œ`npm test`æ¥è·å¾—é”™è¯¯å’Œè­¦å‘Šçš„å®Œæ•´åˆ—è¡¨ã€‚

å¯¹äº GraphQL æœåŠ¡å™¨ï¼ŒApollo æœåŠ¡å™¨æ˜¯å¿«é€Ÿå¯åŠ¨å’Œè¿è¡Œçš„å¥½æ–¹æ³•ã€‚æ‚¨è¿˜éœ€è¦åˆ›å»ºä¸åŒçš„ id æ¥è·Ÿè¸ªæ‚¨çš„æŠ¥ä»·ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨`uuid`æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ç”¨ä»¥ä¸‹å†…å®¹å®‰è£…è¿™äº›ä¾èµ–é¡¹:

```
npm install apollo-server@2.5.0 graphql@14.3.0 uuid@3.3.2 
```

ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`index.js`ï¼Œå®ƒå°†æˆä¸ºæœåŠ¡å™¨çš„ä¸»æ–‡ä»¶ã€‚å®ƒåº”è¯¥æ˜¯è¿™æ ·çš„:

```
const { ApolloServer, gql } = require('apollo-server');
const uuid = require('uuid/v4');

const typeDefs = gql`
  type Quote {
    id: ID!
    phrase: String!
    quotee: String
  }

  type Query {
    quotes: [Quote]
  }
`;

const quotes = {};
const addQuote = quote => {
  const id = uuid();
  return quotes[id] = { ...quote, id };
};

// Start with a few initial quotes
addQuote({ phrase: "I'm a leaf on the wind. Watch how I soar.", quotee: "Wash" });
addQuote({ phrase: "We're all stories in the end.", quotee: "The Doctor" });
addQuote({ phrase: "Woah!", quotee: "Neo" });

const resolvers = {
  Query: {
    quotes: () => Object.values(quotes),
  },
};

const server = new ApolloServer({ typeDefs, resolvers });

server.listen().then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`); // eslint-disable-line no-console
}); 
```

`typeDefs`å®šä¹‰äº†æ•°æ®çš„ç»“æ„ã€‚è¿™å°†ä¸ºæ‚¨çš„ç”¨æˆ·ç”Ÿæˆä¸€äº›æœ‰è¶£çš„æ–‡æ¡£ï¼Œå¹¶ä½¿æ¨ç†å¯¹è±¡åŠå…¶å…³ç³»å˜å¾—å®¹æ˜“ã€‚`Query`ç±»å‹æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒå‘Šè¯‰ GraphQL ç”¨æˆ·å¯ä»¥æŸ¥è¯¢ä»€ä¹ˆï¼Œå¯ä»¥ä¼ å…¥ä»€ä¹ˆå‚æ•°(å¦‚æœæœ‰çš„è¯),ä»¥åŠå°†è¿”å›ä»€ä¹ˆã€‚

GraphQL æœåŠ¡å™¨çš„ä¸‹ä¸€ä¸ªé‡è¦éƒ¨åˆ†æ˜¯å¦‚ä½•å®é™…è§£å†³è¿™äº›æŸ¥è¯¢ã€‚è¿™äº›è¢«ç§°ä¸º`resolvers`ï¼Œåªæ˜¯ä¸€ç»„è¿”å›æ•°æ®æˆ–æ•°æ®æ¨¡å‹çš„å‡½æ•°ã€‚è¿™é‡Œæˆ‘ä»¬åªè¿”å›æ™®é€šå¯¹è±¡ï¼ŒGraphQL åªæ˜¾ç¤ºè¯·æ±‚çš„å†…å®¹ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰ getterss çš„ç±»å¯¹è±¡ï¼Œè¿™äº› getter åªæœ‰åœ¨è¢«è¯·æ±‚æ—¶æ‰ä¼šè¿è¡Œï¼Œå› æ­¤å¦‚æœç”¨æˆ·æ²¡æœ‰è¯·æ±‚è¿™äº›ä¿¡æ¯ï¼Œå°±ä¸ä¸€å®šéœ€è¦æ‰§è¡Œæ›´å¤æ‚çš„è®¡ç®—ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ JavaScript å¯¹è±¡æ¥ä½¿äº‹æƒ…å¿«é€Ÿè¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰€æœ‰çš„æŠ¥ä»·éƒ½å°†å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚æ‚¨è¿˜å¯ä»¥å°†è§£æå™¨ä¸­å¤šä¸ªåœ°æ–¹çš„éƒ¨åˆ†æ‹¼å‡‘åœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä»æ•°æ®åº“æˆ–ä¸€äº›å¤–éƒ¨ API è·å–æ•°æ®ã€‚

æ‚¨çš„æœåŠ¡å™¨ç°å·²å‡†å¤‡å°±ç»ªã€‚ä¸ºäº†å¯åŠ¨å®ƒï¼Œä»ä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹ä¸­è¿è¡Œ`npm start`ã€‚è¿™å°†åœ¨`http://localhost:4000`å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ã€‚è¿™å°†æŠŠä½ å¸¦åˆ°ä¸€ä¸ªæ£€æŸ¥ä½ çš„`typeDefs`çš„æ¸¸ä¹åœºï¼Œè‡ªåŠ¨æ·»åŠ ä¸€äº›ä½ å¯ä»¥æœç´¢çš„æ–‡æ¡£ã€‚å®ƒæœ‰å„ç§å„æ ·çš„å…¶ä»–åŠŸèƒ½ï¼Œåƒè‡ªåŠ¨å®Œæˆå’Œæ˜¾ç¤ºé”™è¯¯ã€‚

[![Cool Features](../Images/7aaa321aecdb51297aaeda9279b05fd1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--zlGLRO2E--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/cool-features-1e8387e0e869839f707201a3af4b7875c35688bd57b1e34574ada7ad0a740e82.png)

å»æŸ¥çœ‹ä¸€ä¸‹ï¼Œå¹¶å°è¯•è¿è¡Œä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ¥æŸ¥çœ‹ç°æœ‰çš„æŠ¥ä»·ã€‚

[![Simple GraphQL Query](../Images/c10e613ee73e7244e01d9c144b9c406d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LQyR1lMe--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/simple-graphql-query-5558467b13c75098d85f18d44cc7cea04ee0517a0e1c86d1da11b0c916a0f08a.png)

## [](#add-the-cud-part-of-crud-to-your-graphql-nodejs-app)å°† CRUD çš„ CUD éƒ¨åˆ†æ·»åŠ åˆ°ä½ çš„ GraphQL Node.js App ä¸­

æ‚¨ç°åœ¨èƒ½å¤Ÿä»æœåŠ¡å™¨è¯»å–æ•°æ®ï¼Œä½†æ˜¯ä¸ºäº†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ CRUD åº”ç”¨ç¨‹åºï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚åœ¨ GraphQL ä¸­ï¼Œç¼–è¾‘æ•°æ®æ˜¯é€šè¿‡å˜å¼‚å®Œæˆçš„ã€‚é¦–å…ˆåœ¨`typeDefs`ä¸­å®šä¹‰ä¸€äº›æ–°çš„ç±»å‹ã€‚

```
 type  Mutation  {  addQuote(phrase:  String!,  quotee:  String):  Quote  editQuote(id:  ID!,  phrase:  String,  quotee:  String):  Quote  deleteQuote(id:  ID!):  DeleteResponse  }  type  DeleteResponse  {  ok:  Boolean!  } 
```

ç„¶åï¼Œæ‚¨éœ€è¦æ·»åŠ è§£æå™¨æ¥å¤„ç†è¿™äº›ç±»å‹ã€‚æ‚¨å·²ç»æœ‰äº†ä¸€ä¸ª`addQuote`å‡½æ•°ï¼Œå› æ­¤è§£æå™¨å°†æ˜¯æœ€ç®€å•çš„ã€‚è§£æå™¨å°†éœ€è¦è¿”å›æ–°çš„/ç¼–è¾‘è¿‡çš„æŠ¥ä»·ï¼Œé™¤äº†åœ¨`deleteQuote`çš„å®ä¾‹ä¸­ã€‚å› ä¸ºæŠ¥ä»·å·²ç»ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿”å›å®ƒæ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥ç›¸åï¼Œä½ å¯ä»¥åªè¿”å›ä¸€ä¸ª`ok`æˆ–è€…`true`æˆ–è€…`false`ï¼Œè¿™å–å†³äºåˆ é™¤æ˜¯å¦æˆåŠŸã€‚

```
const resolvers = {
  // Add below existing Query resolver
  Mutation: {
    addQuote: async (parent, quote) => {
      return addQuote(quote);
    },
    editQuote: async (parent, { id, ...quote }) => {
      if (!quotes[id]) {
        throw new Error("Quote doesn't exist");
      }

      quotes[id] = {
        ...quotes[id],
        ...quote,
      };

      return quotes[id];
    },
    deleteQuote: async (parent, { id }) => {
      const ok = Boolean(quotes[id]);
      delete quotes[id];

      return { ok };
    },
  },
}; 
```

é‡å¯æœåŠ¡å™¨(æ‚¨å¯ä»¥ä½¿ç”¨`ctrl-c`æ¥åœæ­¢å®ƒï¼Œç„¶åé‡æ–°è¿è¡Œ`npm start`)ï¼Œç„¶åç»§ç»­å°è¯•ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç¤ºä¾‹æŸ¥è¯¢å’Œå˜å¼‚:

```
mutation  Create  {  addQuote(phrase:  "You know nothing, Jon Snow.")  {  id  }  }  query  Read  {  quotes  {  id  phrase  quotee  }  }  mutation  Update($id:  ID!)  {  editQuote(id:  $id,  quotee:  "Ygritte")  {  id  phrase  quotee  }  }  mutation  Delete($id:  ID!)  {  deleteQuote(id:  $id)  {  ok  }  } 
```

**æ³¨æ„**:ä¸€æ—¦ä½ å¾—åˆ°äº†ä½ æƒ³è¦æ›´æ–°æˆ–åˆ é™¤çš„ä¸œè¥¿çš„ idï¼Œä½ éœ€è¦æŠŠè¿™ä¸ª id ä½œä¸ºä¸€ä¸ªå˜é‡ä¼ å…¥ã€‚å¯ä»¥ç‚¹å‡»é¡µé¢åº•éƒ¨çš„`QUERY VARIABLES`é“¾æ¥å±•å¼€å˜é‡ç¼–è¾‘å™¨ï¼›ç„¶åä½ éœ€è¦ä½¿ç”¨ JSON æ¥ä¼ é€’å˜é‡ã€‚ä¾‹å¦‚:

```
{  "id":  "4ef19b4b-0348-45a5-9a9f-6f68ca9a62e6"  } 
```

## [](#add-user-authentication-to-your-nodejs-app)å‘ Node.js åº”ç”¨ç¨‹åºæ·»åŠ ç”¨æˆ·éªŒè¯

ä¸€ä¸ªéå¸¸å¸¸è§çš„æµç¨‹æ˜¯å…è®¸ä»»ä½•äººè‡³å°‘è¯»å–æ•°æ®çš„ä¸€ä¸ªå­é›†ï¼Œä½†æ˜¯åªå…è®¸ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·å†™æ•°æ®æ¥ä¿®æ”¹æ•°æ®ã€‚æ‚¨å·²ç»å®ç°äº†åº”ç”¨ç¨‹åºçš„æ•´ä¸ª CRUD éƒ¨åˆ†ï¼Œä½†æ˜¯æ·»åŠ èº«ä»½éªŒè¯éå¸¸ç®€å•ï¼Œå› æ­¤æ‚¨å¯ä»¥é˜»æ­¢åŒ¿åç”¨æˆ·è®¿é—®åº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†ã€‚

è¿™å°±æ˜¯ Okta å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚Okta æ˜¯ä¸€ç§äº‘æœåŠ¡ï¼Œå…è®¸å¼€å‘äººå‘˜åˆ›å»ºã€ç¼–è¾‘å’Œå®‰å…¨å­˜å‚¨ç”¨æˆ·å¸æˆ·å’Œç”¨æˆ·å¸æˆ·æ•°æ®ï¼Œå¹¶å°†å®ƒä»¬ä¸ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºè¿æ¥ã€‚æˆ‘ä»¬çš„ API ä½¿æ‚¨èƒ½å¤Ÿ:

*   [è®¤è¯](https://developer.okta.com/product/authentication/)å’Œ[æˆæƒ](https://developer.okta.com/product/authorization/)æ‚¨çš„ç”¨æˆ·
*   å­˜å‚¨ç”¨æˆ·æ•°æ®
*   æ‰§è¡ŒåŸºäºå¯†ç çš„[ç¤¾äº¤ç™»å½•](https://developer.okta.com/authentication-guide/social-login/)
*   é€šè¿‡[å¤šé‡èº«ä»½éªŒè¯](https://developer.okta.com/use_cases/mfa/)ä¿æŠ¤æ‚¨çš„åº”ç”¨
*   è¿˜æœ‰æ›´å¤šï¼æŸ¥çœ‹æˆ‘ä»¬çš„[äº§å“æ–‡æ¡£](https://developer.okta.com/documentation/)

å¦‚æœä½ è¿˜æ²¡æœ‰ï¼Œé‚£ä¹ˆ[æ³¨å†Œä¸€ä¸ªæ°¸è¿œå…è´¹çš„å¼€å‘è€…è´¦æˆ·](https://developer.okta.com/signup/)ã€‚

ä½ éœ€è¦ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚åˆ›å»ºä¸€ä¸ªåä¸º`.env`çš„æ–°æ–‡ä»¶ã€‚åœ¨å…¶ä¸­ï¼Œè¾“å…¥æ‚¨çš„ç»„ç»‡ URLã€‚

```
OKTA_ORG_URL=https://{yourOktaOrgUrl} 
```

æ¥ä¸‹æ¥ï¼Œç™»å½•æ‚¨çš„å¼€å‘äººå‘˜æ§åˆ¶å°ï¼Œå¯¼èˆªåˆ°**åº”ç”¨**ï¼Œç„¶åå•å‡»* *æ·»åŠ åº”ç”¨**ã€‚é€‰æ‹©**æœ¬åœŸ**ï¼Œç„¶åç‚¹å‡»**ä¸‹ä¸€æ­¥**ã€‚ä¸ç”¨æ‹…å¿ƒå®ƒåªæåˆ°äº†åŸç”Ÿåº”ç”¨çš„ iOS å’Œ Androidã€‚è¿™å¯¹äºç›´æ¥ä» GraphQL è¿›è¡Œèº«ä»½éªŒè¯æ˜¯å¿…è¦çš„ã€‚GraphQL æœåŠ¡å™¨å°†æ‹¥æœ‰ä¸€ä¸ªç”¨äºç”Ÿæˆå®‰å…¨ JWT çš„å®¢æˆ·ç«¯ç§˜å¯†ï¼Œå®ƒä¸ä¼šæš´éœ²ç»™ç”¨æˆ·ã€‚

åœ¨ä¸‹ä¸€é¡µï¼Œç»™ä½ çš„åº”ç”¨å‘½åï¼Œå¹¶ç¡®ä¿åœ¨ç‚¹å‡»**å®Œæˆ**ä¹‹å‰é€‰æ‹©**èµ„æºæ‰€æœ‰è€…å¯†ç **ã€‚

[![Create New Application Settings](../Images/ea8f467d88f76eda87fd78c3da364453.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--e07z3rVg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/create-new-application-settings-6c2c57b48537021c8b65d273b2df2d96a392bd17bf0aa522ca85ccbfe36b2444.png)

åˆ›å»ºåº”ç”¨ç¨‹åºåï¼Œç‚¹å‡»**å®¢æˆ·ç«¯å‡­è¯**éƒ¨åˆ†çš„**ç¼–è¾‘**ã€‚å°†**å®¢æˆ·ç«¯è®¤è¯**æ”¹ä¸º**ä½¿ç”¨å®¢æˆ·ç«¯è®¤è¯**ã€‚è¿™å°†ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯æœºå¯†ã€‚

[![Use Client Authentication](../Images/0621c8d5ac68aa00017dc455109aec24.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--f3VjWEyF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/use-client-authentication-00a5f09103a09444ec6a2a13434e9f0c9d865f38dfb18bad8ebc53569439a1c4.png)

å°†å®¢æˆ·ç«¯ ID å’Œå¯†ç ä¿å­˜åˆ°æ‚¨çš„`.env`æ–‡ä»¶:

```
OKTA_CLIENT_ID={yourClientID}
OKTA_CLIENT_SECRET={yourClientSecret} 
```

æ‚¨éœ€è¦ä» Okta è·å¾—çš„æœ€åä¸€æ¡ä¿¡æ¯æ˜¯ä¸€ä¸ª API ä»¤ç‰Œã€‚åœ¨æ‚¨çš„å¼€å‘è€…æ§åˆ¶å°ä¸­ï¼Œå¯¼èˆªåˆ°**API**->-**ä»¤ç‰Œ**ï¼Œç„¶åç‚¹å‡»**åˆ›å»ºä»¤ç‰Œ**ã€‚æ‚¨å¯ä»¥æœ‰è®¸å¤šæ ‡è®°ï¼Œæ‰€ä»¥åªéœ€ç»™è¿™ä¸ªæ ‡è®°ä¸€ä¸ªæé†’æ‚¨å®ƒçš„ç”¨é€”çš„åç§°ï¼Œæ¯”å¦‚â€œGraphQL Quotesâ€ã€‚ä½ ä¼šå¾—åˆ°ä¸€ä¸ªä½ ç°åœ¨åªèƒ½çœ‹åˆ°çš„ä»¤ç‰Œã€‚å¦‚æœæ‚¨ä¸¢å¤±äº†ä»¤ç‰Œï¼Œæ‚¨å¿…é¡»é‡æ–°åˆ›å»ºä¸€ä¸ªã€‚ä¹Ÿå°†æ­¤æ·»åŠ åˆ°`.env`ä¸­ã€‚

```
OKTA_TOKEN={yourOktaAPIToken} 
```

ä¸ºäº†è®©æ‚¨çš„ä»£ç åŠ è½½`.env`æ–‡ä»¶ï¼Œæ‚¨éœ€è¦å®‰è£…ä¸€ä¸ªåä¸º`dotenv`çš„æ–°ä¾èµ–é¡¹ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
npm install dotenv@8.0.0 
```

ç„¶ååœ¨æ‚¨çš„`index.js`æ–‡ä»¶çš„æœ€é¡¶ç«¯ï¼Œæ·»åŠ ä¸‹é¢ä¸€è¡Œ:

```
require('dotenv').config(); 
```

ç°åœ¨åˆ›å»ºä¸€ä¸ªåä¸º`auth.js`çš„æ–°æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å°†åˆ›å»ºä¸€äº›ä¸ºç”¨æˆ·ç”Ÿæˆä»¤ç‰Œã€éªŒè¯æ‰€æä¾›çš„ä»¤ç‰Œä»¥åŠè·å–æœ‰å…³ç”¨æˆ·çš„æ›´å¤šä¿¡æ¯æ‰€éœ€çš„å®ç”¨å‡½æ•°ã€‚

æ‚¨éœ€è¦å¼•å…¥æ›´å¤šçš„ä¾èµ–é¡¹:

```
npm install @okta/jwt-verifier@0.0.15 @okta/okta-sdk-nodejs@2.0.0 node-fetch@2.6.0 
```

åœ¨æ‚¨çš„`auth.js`æ–‡ä»¶çš„å¼€å¤´ï¼Œæ·»åŠ ä»¥ä¸‹`require`è¯­å¥:

```
const fetch = require('node-fetch');
const { AuthenticationError } = require('apollo-server');
const JWTVerifier = require('@okta/jwt-verifier');
const okta = require('@okta/okta-sdk-nodejs'); 
```

æ‚¨å°†éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥ä¸ºç”¨æˆ·ç”Ÿæˆä»¤ç‰Œã€‚ç”¨æˆ·å°†æä¾›ä»–ä»¬çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åæ‚¨å°†è¿™äº›ä¿¡æ¯è½¬å‘ç»™ Okta çš„ API å¹¶è¿”å›ä¸€ä¸ªä»¤ç‰Œã€‚å¦‚æœè®¤è¯å¤±è´¥ï¼ŒæŠ›å‡ºä¸€ä¸ªç”¨æˆ·å°†çœ‹åˆ°çš„é”™è¯¯:

```
const basicAuth = Buffer.from(
  [
    process.env.OKTA_CLIENT_ID,
    process.env.OKTA_CLIENT_SECRET,
  ].join(':')
).toString('base64');

const getToken = async ({ username, password }) => {

  const response = await fetch(`${process.env.OKTA_ORG_URL}/oauth2/default/v1/token`, {
    method: 'POST',
    headers: {
      authorization: `Basic ${basicAuth}`,
      'accept': 'application/json',
      'content-type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      username,
      password,
      grant_type: 'password',
      scope: 'openid',
    }).toString(),
  });

  const { error_description, access_token } = await response.json();

  if (error_description) throw new AuthenticationError(error_description);

  return access_token;
}; 
```

ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œä»–ä»¬å°†ä½¿ç”¨ä»–ä»¬çš„ä»¤ç‰Œä½œä¸ºè®¤è¯ï¼Œè€Œä¸æ˜¯ä»–ä»¬çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ‚¨éœ€è¦ä¸€ç§æ–¹æ³•æ¥éªŒè¯ä»¤ç‰Œæ˜¯åˆæ³•çš„(ä¾‹å¦‚ï¼Œå…·æœ‰æœ‰æ•ˆçš„ç­¾åå¹¶ä¸”æ²¡æœ‰è¿‡æœŸ)ã€‚è¿™ä¸ªå‡½æ•°å°†è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ã€ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„ç”¨æˆ· IDã€‚å¦åˆ™å°†è¿”å›`undefined`ã€‚

```
const verifier = new JWTVerifier({
  issuer: `${process.env.OKTA_ORG_URL}/oauth2/default`,
  clientId: process.env.OKTA_CLIENT_ID,
});

const getUserIdFromToken = async (token) => {
  if (!token) return;

  try {
    const jwt = await verifier.verifyAccessToken(token)
    return jwt.claims.sub;
  } catch (error) {
    // ignore
  }
}; 
```

æ‚¨å¯èƒ½è¿˜éœ€è¦å…³äºæ‚¨çš„ç”¨æˆ·çš„æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä»–ä»¬çš„å§“åã€‚ä½¿ç”¨ Okta çš„ Node SDK:
å¯ä»¥å¾—åˆ°è¿™ä¸ª

```
const client = new okta.Client({
  orgUrl: process.env.OKTA_ORG_URL,
  token: process.env.OKTA_TOKEN,
});

const getUser = async (userId) => {
  if (!userId) return;

  try {
    const user = await client.getUser(userId);
    return user.profile;
  } catch (error) {
    // ignore
  }
}; 
```

æ‚¨è¿˜éœ€è¦å¯¼å‡ºè¿™äº›å‡½æ•°ï¼Œä»¥ä¾¿åœ¨`index.js` :
ä¸­ä½¿ç”¨

```
module.exports = { getToken, getUserIdFromToken, getUser }; 
```

æœ€ç»ˆçš„`auth.js`æ–‡ä»¶åº”è¯¥æ˜¯è¿™æ ·çš„:

```
const fetch = require('node-fetch');
const { AuthenticationError } = require('apollo-server');
const JWTVerifier = require('@okta/jwt-verifier');
const okta = require('@okta/okta-sdk-nodejs');

const basicAuth = Buffer.from(
  [
    process.env.OKTA_CLIENT_ID,
    process.env.OKTA_CLIENT_SECRET,
  ].join(':')
).toString('base64');

const getToken = async ({ username, password }) => {

  const response = await fetch(`${process.env.OKTA_ORG_URL}/oauth2/default/v1/token`, {
    method: 'POST',
    headers: {
      authorization: `Basic ${basicAuth}`,
      'accept': 'application/json',
      'content-type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      username,
      password,
      grant_type: 'password',
      scope: 'openid',
    }).toString(),
  });

  const { error_description, access_token } = await response.json();

  if (error_description) throw new AuthenticationError(error_description);

  return access_token;
};

const verifier = new JWTVerifier({
  issuer: `${process.env.OKTA_ORG_URL}/oauth2/default`,
  clientId: process.env.OKTA_CLIENT_ID,
});

const getUserIdFromToken = async (token) => {
  if (!token) return;

  try {
    const jwt = await verifier.verifyAccessToken(token)
    return jwt.claims.sub;
  } catch (error) {
    // ignore
  }
};

const client = new okta.Client({
  orgUrl: process.env.OKTA_ORG_URL,
  token: process.env.OKTA_TOKEN,
});

const getUser = async (userId) => {
  if (!userId) return;

  try {
    const user = await client.getUser(userId);
    return user.profile;
  } catch (error) {
    // ignore
  }
};

module.exports = { getToken, getUserIdFromToken, getUser }; 
```

ç°åœ¨å›åˆ°`index.js`ï¼Œæ‚¨éœ€è¦å°†ç”¨æˆ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä»¥ä¾¿è§£æå™¨å¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹åˆ°æ˜¯è°åœ¨å°è¯•å‘å‡ºè¯·æ±‚ã€‚åœ¨æ–‡ä»¶é¡¶éƒ¨é™„è¿‘å¯¼å…¥æ–°å‡½æ•°(é€šå¸¸æ‰€æœ‰å¯¼å…¥éƒ½åœ¨ä»»ä½•å…¶ä»–ä»£ç ä¹‹å‰å®Œæˆï¼Œæœ¬åœ°å¯¼å…¥åœ¨ä»å¤–éƒ¨ä¾èµ–é¡¹å¯¼å…¥ä¹‹åå®Œæˆ)ã€‚å½“ç”¨æˆ·åœ¨ç¼–è¾‘è¿‡ç¨‹ä¸­æ²¡æœ‰ç™»å½•æ—¶ï¼Œæ‚¨è¿˜å°†æŠ›å‡ºä¸€ä¸ª`AuthenticationError`ï¼Œæ‰€ä»¥è¯·ç¡®ä¿ä¹Ÿå¯¼å…¥å®ƒ:

```
const { ApolloServer, AuthenticationError, gql } = require('apollo-server');
const uuid = require('uuid/v4');

const { getToken, getUserIdFromToken, getUser } = require('./auth'); 
```

é€šè¿‡å°†æ­¤æ·»åŠ åˆ°æ‚¨çš„`typeDefs` :
ä¸­ï¼Œä¸ºæ‚¨çš„ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°çš„ç™»å½•çªå˜

```
type  Mutation  {  # ...  login(username:  String!,  password:  String!):  Authentication  }  type  Authentication  {  token:  String!  } 
```

æ‚¨çš„ç™»å½•å˜å¼‚è§£æå™¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
 login: async (parent, { username, password }) => ({
    token: await getToken({ username, password }),
  }), 
```

ä¸ºäº†è®©è§£æå™¨çŸ¥é“ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯ï¼Œæ¨èçš„æ–¹æ³•æ˜¯å°†ç”¨æˆ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸Šä¸‹æ–‡æ˜¯åœ¨ä»»ä½•è§£æå™¨è¢«å‘½ä¸­ä¹‹å‰æ„å»ºçš„ï¼Œç„¶åä¼ é€’ç»™æ¯ä¸ªè§£æå™¨ï¼Œå› æ­¤åªéœ€è¦åœ¨ä»»ä½•è¯·æ±‚å¼€å§‹æ—¶è¿›è¡Œèº«ä»½éªŒè¯ã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„`context`å‡½æ•°ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ Apollo æœåŠ¡å™¨ã€‚

```
const context = async ({ req }) => {
  const [, token] = (req.headers.authorization || '').split("Bearer ");

  return {
    user: await getUser(await getUserIdFromToken(token)),
  };
};

const server = new ApolloServer({ typeDefs, resolvers, context }); 
```

ä¸ºäº†å°†è¿™äº›æ‹¼å‡‘åœ¨ä¸€èµ·ï¼Œæ‚¨ç°åœ¨å¯ä»¥åœ¨å®é™…æ‰§è¡Œä»»ä½•å·¥ä½œä¹‹å‰ï¼Œåœ¨æ·»åŠ ã€ç¼–è¾‘å’Œåˆ é™¤å˜å¼‚ä¸­æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå½“ç„¶ï¼Œé™¤éç”¨æˆ·æ­£ç¡®ç™»å½•ã€‚ä¸ºäº†æ£€æŸ¥ç”¨æˆ·ï¼Œæ‚¨éœ€è¦æ·»åŠ `context`ä½œä¸ºè§£æå™¨çš„ç¬¬ä¸‰ä¸ªè¾“å…¥å‚æ•°ã€‚

```
 addQuote: async (parent, quote, context) => {
    if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");
    // ...etc
  },
  editQuote: async (parent, { id, ...quote }, context) => {
    if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");
    // ...etc
  },
  deleteQuote: async (parent, { id }, context) => {
    if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");
    // ...etc
  }, 
```

æœ€åï¼Œæ‚¨çš„`index.js`æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
require('dotenv').config();

const { ApolloServer, AuthenticationError, gql } = require('apollo-server');
const uuid = require('uuid/v4');

const { getToken, getUserIdFromToken, getUser } = require('./auth');

const typeDefs = gql`
  type Quote {
    id: ID!
    phrase: String!
    quotee: String
  }

  type Query {
    quotes: [Quote]
  }

  type Mutation {
    login(username: String!, password: String!): Authentication
    addQuote(phrase: String!, quotee: String): Quote
    editQuote(id: ID!, phrase: String, quotee: String): Quote
    deleteQuote(id: ID!): DeleteResponse
  }

  type Authentication {
    token: String!
  }

  type DeleteResponse {
    ok: Boolean!
  }
`;

const quotes = {};
const addQuote = quote => {
  const id = uuid();
  return quotes[id] = { ...quote, id };
};

addQuote({ phrase: "I'm a leaf on the wind. Watch how I soar.", quotee: "Wash" });
addQuote({ phrase: "We're all stories in the end.", quotee: "The Doctor" });
addQuote({ phrase: "Woah!", quotee: "Neo" });

const resolvers = {
  Query: {
    quotes: () => Object.values(quotes),
  },
  Mutation: {
    login: async (parent, { username, password }) => ({
      token: await getToken({ username, password }),
    }),
    addQuote: async (parent, quote, context) => {
      if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");

      return addQuote(quote);
    },
    editQuote: async (parent, { id, ...quote }, context) => {
      if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");

      if (!quotes[id]) {
        throw new Error("Quote doesn't exist");
      }

      quotes[id] = {
        ...quotes[id],
        ...quote,
      };

      return quotes[id];
    },
    deleteQuote: async (parent, { id }, context) => {
      if (!context.user) throw new AuthenticationError("You must be logged in to perform this action");

      const ok = Boolean(quotes[id]);
      delete quotes[id];

      return { ok };
    },
  },
};

const context = async ({ req }) => {
  const [, token] = (req.headers.authorization || '').split("Bearer ");

  return {
    user: await getUser(await getUserIdFromToken(token)),
  };
};

const server = new ApolloServer({ typeDefs, resolvers, context });

server.listen().then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`); // eslint-disable-line no-console
}); 
```

## [](#test-your-authentication)æµ‹è¯•ä½ çš„è®¤è¯

é‡å¯ä½ çš„æœåŠ¡å™¨ï¼Œç°åœ¨ä¸€åˆ‡éƒ½å‡†å¤‡å¥½äº†ã€‚å°è¯•è¿è¡Œä¸€äº›çªå˜ï¼Œä½ ä¼šå‘ç°ä½ ä¸€å¼€å§‹ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœä½ åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªå †æ ˆè·Ÿè¸ªï¼Œä½†æ˜¯å¦‚æœä½ åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹è¿è¡Œ(æ¯”å¦‚ç”¨`NODE_ENV=production npm start`)ï¼Œä½ åªä¼šçœ‹åˆ°é”™è¯¯ä»£ç ã€‚

[![Authentication Error](../Images/743aa01c116474d07c0fc77bbb3d6b74.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_yliCqQ---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/authentication-error-42662daf05164ec5f598dc564f7fefce6d0a4465c7dccb2a965b2b6283fd277d.png)

ä¸ºäº†ç™»å½•ï¼Œè¿è¡Œ`login`çªå˜ã€‚æ‚¨å¯ä»¥åƒè¿™æ ·ä»¥å†…è”æ–¹å¼æä¾›è¾“å…¥:

```
mutation  {  login(username:  "myusername@example.com",  password:  "hunter2")  {  token  }  } 
```

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨å˜é‡æ¥ä»£æ›¿:

[![Login Mutation With Variables](../Images/9f45937e9004085b76f16f200f3233ab.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--1y4nMa2n--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/login-mutation-with-variables-8937435d680417bbdb7451888999dc7526e7ccf5fecbf9acd3e305d2497db390.png)

å¦‚æœä½ æä¾›æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªä»¤ç‰Œå›æ¥ã€‚å¤åˆ¶è¿™ä¸ªä»¤ç‰Œï¼Œç„¶åç‚¹å‡»å±å¹•åº•éƒ¨çš„`HTTP HEADERS`å¹¶è¿›å…¥`{ "Authorization": "Bearer eyJraWQiOi...1g6Kdicw" }`(å°½ç®¡ä½¿ç”¨ä½ ä»`login`çªå˜ä¸­è·å¾—çš„å®Œæ•´çš„ã€é•¿å¾—å¤šçš„ä»¤ç‰Œ)ã€‚

å†è¯•ä¸€æ¬¡ï¼Œä½ åº”è¯¥èƒ½å¤ŸæˆåŠŸåœ°ç¼–è¾‘æŠ¥ä»·ã€‚

[![Successful Authenticated Edit](../Images/d0c09d006783e735970b887775b9a84c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qCc3FBxE--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://developer.okta.com/assets-jekyll/blog/node-graphql/successful-authenticated-mutation-1c77ef75269d16ff2680bbfb4edde317c37911de883c784fc1f2d74eb0df667f.png)

## [](#learn-more-about-graphql-nodejs-and-secure-authentication)äº†è§£æœ‰å…³ GraphQLã€Node.js å’Œå®‰å…¨è®¤è¯çš„æ›´å¤šä¿¡æ¯

æˆ‘å¸Œæœ›æ‚¨åœ¨å­¦ä¹  GraphQL å’Œä½“éªŒæ“åœºçš„è¿‡ç¨‹ä¸­è·å¾—äº†ä¹è¶£ã€‚è¿™ä¸ªé¡¹ç›®æ²¡æœ‰å¤ªå¤šå¤æ‚çš„éƒ¨åˆ†ï¼Œä½†æ˜¯æ‚¨æœ‰èº«ä»½éªŒè¯ï¼Œèƒ½å¤Ÿè¯»å†™æ•°æ®é›†ï¼Œå¹¶ä¸”ä¸ºä¸æ‚¨å…±äº« API çš„ä»»ä½•äººæä¾›äº†å¾ˆå¥½çš„æ–‡æ¡£ã€‚æ‚¨å¯ä»¥çœ‹åˆ°æ‰©å±•ç±»å‹å®šä¹‰å’Œè§£æå™¨æ˜¯å¤šä¹ˆå®¹æ˜“ï¼Œä»è€Œæ„å»ºæ›´æœ‰å®è´¨æ„ä¹‰çš„ä¸œè¥¿ã€‚

å¦‚æœä½ æƒ³çœ‹æœ€ç»ˆçš„æ ·æœ¬ä»£ç ï¼Œå¯ä»¥åœ¨ github ä¸Šæ‰¾åˆ°[ã€‚](https://github.com/oktadeveloper/okta-node-graphql-crud-example)

å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº GraphQL æˆ– Node çš„çŸ¥è¯†ï¼Œè¯·æŸ¥çœ‹ Okta å¼€å‘è€…åšå®¢ä¸Šçš„å…¶ä»–æ–‡ç« :

*   [ä½¿ç”¨ Reactã€GraphQL å’Œç”¨æˆ·è®¤è¯æ„å»ºå¥åº·è·Ÿè¸ªåº”ç”¨](https://developer.okta.com/blog/2018/07/11/build-react-graphql-api-user-authentication)
*   [å»ºç«‹å¹¶ç†è§£ä¸€ä¸ªç®€å•çš„ Node.js ç½‘ç«™ï¼Œå¹¶è¿›è¡Œç”¨æˆ·è®¤è¯](https://developer.okta.com/blog/2018/08/17/build-and-understand-user-authentication-in-node)
*   [ç”¨ Expressã€React å’Œ GraphQL æ„å»ºä¸€ä¸ªç®€å•çš„ Web åº”ç”¨](https://developer.okta.com/blog/2018/10/11/build-simple-web-app-with-express-react-graphql)
*   [æ•™ç¨‹:ç”¨ Node.js æ„å»ºä¸€ä¸ªåŸºæœ¬çš„ CRUD App](https://developer.okta.com/blog/2018/06/28/tutorial-build-a-basic-crud-app-with-node)
*   [ç”¨ Express å’Œ GraphQL æ„å»ºä¸€ä¸ªç®€å•çš„ API æœåŠ¡](https://developer.okta.com/blog/2018/09/27/build-a-simple-api-service-with-express-and-graphql)

å¦‚æœä½ å¯¹è¿™ç¯‡æ–‡ç« æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ä¸‹é¢æ·»åŠ è¯„è®ºã€‚æ›´å¤šç²¾å½©å†…å®¹ï¼Œè¯·åœ¨ Twitter ä¸Šå…³æ³¨ [@oktadev](https://twitter.com/oktadev) ï¼Œå°±åƒæˆ‘ä»¬åœ¨è„¸ä¹¦å…³æ³¨[ï¼Œæˆ–è€…è®¢é˜…](https://www.facebook.com/oktadevelopers/)[æˆ‘ä»¬çš„ YouTube é¢‘é“](https://www.youtube.com/channel/UC5AMiWqFVFxF1q9Ya1FuZ_Q)ã€‚