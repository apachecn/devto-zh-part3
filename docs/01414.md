# [ ğŸ‡¬ğŸ‡§ ] Gitlab CI æ„å»ºå®¹å™¨å¹¶å°†å…¶æ¨é€åˆ°æ³¨å†Œè¡¨

> åŸæ–‡:[https://dev . to/bzinoun/git lab-ci-to-build-and-push-containers-to-registry-538 a](https://dev.to/bzinoun/gitlab-ci-to-build-and-push-containers-to-registry-538a)

æˆ‘ä»¬éƒ½çŸ¥é“ Gitlab CI build ä½¿ç”¨ docker æ˜ åƒæ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œä½†æ˜¯æ‚¨æ›¾ç»å°è¯•è¿‡åœ¨ gitlab CI build å†…éƒ¨æ„å»º docker æ˜ åƒå—ï¼Ÿ

æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œgitlab CI å§‹äº docker å®¹å™¨ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬æƒ³è¦åœ¨ gitlab CI build ä¸­æ„å»º docker æ˜ åƒæ—¶ï¼Œå®ƒæ˜¯ docker in docker (DinD)

[![](../Images/f871d3e515a1cae99918625af24b3567.png)T2ã€‘](https://i.giphy.com/media/m1UTexVjvh2WA/giphy.gif)

* * *

æ²¡æœ‰è¿‡æ¸¡ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹`.gitla-ci.yml`æ–‡ä»¶:

```
 image: docker:latest
    variables:
     DOCKER_DRIVER: overlay2
    stages:
      - build
      - push
    services:
      - docker:dind
    before_script:
      # docker login needs the password to be passed through stdin for security
      # we use $CI_JOB_TOKEN here which is a special token provided by GitLab
      - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
      - docker version
      - docker info

    after_script:
      - docker logout registry.gitlab.com
    Build:
      stage: build
      script:
        - docker pull $CI_REGISTRY_IMAGE:latest || true
        - >
          docker build
          --pull
          --cache-from $CI_REGISTRY_IMAGE:latest
          --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
          .
        - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    Push_When_tag:
      stage: push
      only:
        # We want this job to be ran on tags only.
        - tags
      script:
        - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
        - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME 
```

### [](#step-1-images-amp-services)æ­¥éª¤ 1 -å›¾ç‰‡&æœåŠ¡

```
 image: docker:latest
    variables:
     DOCKER_DRIVER: overlay2
    stages:
      - build
      - push
    services:
      - docker:dind 
```

äºš ml

æˆ‘ä»¬é¦–å…ˆå®šä¹‰ GitlabCI æ„å»ºå°†ä½¿ç”¨çš„ docker æ˜ åƒã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æœ€æ–°çš„ docker å›¾åƒã€‚

```
image: docker:latest 
```

> ä»¥ç”Ÿäº§ä¸­çš„âš ï¸ä¸ºä¾‹ï¼Œæˆ‘ä¸æ¨èä½¿ç”¨`latest`æˆ–`stable`ç‰ˆæœ¬ã€‚å‡ºäºè®¸å¤šåŸå› ...
> å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯å¯é‡å¤æ€§ï¼Œå¦ä¸€ä¸ªåŸå› æ˜¯æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„ç®¡é“åœ¨ 10 ä¸ªæœˆæˆ– 10 å¹´å†…æŠ•å…¥ä½¿ç”¨ã€‚å¦‚æœéœ€è¦æ–°åŠŸèƒ½ï¼Œåˆ™è®¡åˆ’è¿›è¡Œå‡çº§ã€‚

```
 variables:
     DOCKER_DRIVER: overlay2 
```

yaml
å½“ä½¿ç”¨`docker:dind`æ—¶ï¼ŒDocker ä½¿ç”¨`vfs`å­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œå®ƒåœ¨æ¯æ¬¡è¿è¡Œæ—¶å¤åˆ¶æ–‡ä»¶ç³»ç»Ÿã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç£ç›˜å¯†é›†å‹çš„æ“ä½œï¼Œå¦‚æœä½¿ç”¨ä¸åŒçš„é©±åŠ¨ç¨‹åºå¯ä»¥é¿å…ï¼Œä¾‹å¦‚`overlay2`

### [](#step-2-before-and-after-script)ç¬¬äºŒæ­¥-è„šæœ¬å‰å

```
 before_script:
      # docker login needs the password to be passed through stdin for security
      # we use $CI_JOB_TOKEN here which is a special token provided by GitLab
      - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
      - docker version
      - docker info

    after_script:
      - docker logout registry.gitlab.com 
```

yaml
è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆç‰¹åˆ«çš„:

*   è¿æ¥åˆ° Gitlab æ³¨å†Œè¡¨
*   æ£€æŸ¥ docker å®ˆæŠ¤ç¨‹åºå’Œé…ç½®
*   ä» docker æ³¨å†Œè¡¨æ³¨é”€

### [](#step-3-build-and-push)æ­¥éª¤ 3 -æ„å»ºå’Œæ¨é€

```
 Build:
      stage: build
      script:
        - docker pull $CI_REGISTRY_IMAGE:latest || true

        # notice the cache-from, which is going to use the image we just pulled locally
        # the built image is tagged locally with the commit SHA, and then pushed to 
        # the GitLab registry
        - >
          docker build
          --pull
          --cache-from $CI_REGISTRY_IMAGE:latest
          --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
          .
        - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

We pull the last pushed image on the registry ; the `|| true` assure that the pipeline will not fail if no image was found . 

After pulling the last image , this one will be used for the cache when building a new image using the `--cache-from` . 

Then we push to registry with the image flagged with `$CI_COMMIT_SHA` that contains the commit SHA . 
```

é›…å§†

### [](#step-4-tag-management)ç¬¬å››æ­¥-æ ‡ç­¾ç®¡ç†

```
 Push_When_tag:
      stage: push
      only:
        - tags
      script:
        - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
        - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME 
```

æˆ‘ä»¬å¸Œæœ›è®© Git æ ‡ç­¾å’Œ Docker æ ‡ç­¾ä¿æŒåŒæ­¥ã€‚è¿™åœ¨è°ƒè¯•å’Œè¯•å›¾é‡ç°ç‰¹å®šç‰ˆæœ¬é”™è¯¯æ—¶å¾ˆæœ‰å¸®åŠ©ã€‚

å¦‚æœæ‚¨è¿˜æ²¡æœ‰å®ç°è¿™ä¸€ç‚¹çš„è‡ªåŠ¨åŒ–ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½ä¼šå‘ç°è‡ªå·±æ­£å¤„äºè¿™æ ·ä¸€ç§æƒ…å†µ:â€œè¿™ä¸ªå›¾ç‰‡æ˜¯å“ªä¸ª git æ ‡ç­¾ï¼Ÿâ€ã€‚

âš ï¸åªæœ‰åœ¨åˆ›å»ºæ ‡ç­¾æ—¶æ‰ä¼šè§¦å‘æ­¤é˜¶æ®µã€‚