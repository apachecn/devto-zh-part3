# ä½¿ç”¨ Azure SignalR æœåŠ¡æ„å»ºå®æ—¶æ— æœåŠ¡å™¨åº”ç”¨

> åŸæ–‡:[https://dev . to/azure/build-real-time-server less-apps-with-azure-signalr-service-1 fin](https://dev.to/azure/build-real-time-serverless-apps-with-azure-signalr-service-1fin)

ä»Šå¤©ï¼Œå¾®è½¯[å®£å¸ƒ](https://azure.microsoft.com/en-us/blog/real-time-serverless-applications-with-the-signalr-service-bindings-in-azure-functions/?WT.mc_id=devto-blog-antchu)Azure SignalR æœåŠ¡ç»‘å®š Azure åŠŸèƒ½çš„å…¨é¢ä¸Šå¸‚ã€‚ç»‘å®šå…è®¸ Azure åŠŸèƒ½ä¸ SignalR æœåŠ¡æ— ç¼é›†æˆï¼Œé€šè¿‡ WebSockets å¤§è§„æ¨¡å¹¿æ’­å®æ—¶æ¶ˆæ¯ã€‚

æˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ HTML å’Œ JavaScript æ„å»ºä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„åä½œç»˜å›¾åº”ç”¨ç¨‹åºã€‚å¤šäººå¯ä»¥åœ¨è‡ªå·±çš„æµè§ˆå™¨ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œå¹¶åœ¨ç”»å¸ƒä¸Šç»˜å›¾ã€‚ä½¿ç”¨ Azure å‡½æ•°å’Œ SignalR æœåŠ¡å®æ—¶åŒæ­¥æ›´æ”¹ã€‚

Azure å‡½æ•°ä¸­çš„ Java è¯­è¨€æ”¯æŒæœ€è¿‘ä¹Ÿå˜å¾—[æ™®éå¯ç”¨](https://azure.microsoft.com/en-us/blog/announcing-the-general-availability-of-java-support-in-azure-functions/?WT.mc_id=devto-blog-antchu)ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Java ç¼–å†™å‡½æ•°ï¼Œä½†æ˜¯ SignalR æœåŠ¡ç»‘å®šä¹Ÿé€‚ç”¨äº Azure å‡½æ•°æ”¯æŒçš„å…¶ä»–è¯­è¨€ã€‚æŸ¥çœ‹ [GitHub repo](https://github.com/anthonychu/serverless-draw) è·å– Javaã€C#å’Œ JavaScript çš„æºä»£ç ã€‚

## [](#overview)æ¦‚è¿°

è¯¥åº”ç”¨ç¨‹åºæœ‰ä¸‰ä¸ªä¸»è¦ç»„ä»¶:ç»˜å›¾ç”»å¸ƒã€Azure åŠŸèƒ½åº”ç”¨ç¨‹åºå’Œ Azure SignalR æœåŠ¡ã€‚

[![Architecture](../Images/1f3472a03cce47f7a9816b5142787397.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--LfVrSMgH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/49mhwtjpunxh01n4z5hw.png)

1.  ç”»å¸ƒæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„ç®€å• JavaScript åº”ç”¨ç¨‹åºã€‚å½“åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå®ƒä»ä¸€ä¸ªåä¸ºâ€œnegotiateâ€çš„ Azure å‡½æ•°ä¸­æ£€ç´¢ SignalR æœåŠ¡è¿æ¥ç«¯ç‚¹å’Œè®¿é—®ä»¤ç‰Œã€‚

2.  è¯¥åº”ç”¨ç¨‹åºè¿æ¥åˆ° SignalR æœåŠ¡ï¼Œå¹¶å»ºç«‹å®æ—¶é€šé“ã€‚å®ƒé€šå¸¸æ˜¯ä¸€ä¸ª WebSocket è¿æ¥ï¼Œä½†æ˜¯å¦‚æœ WebSocket å¯¹äºä¸€ä¸ªç»™å®šçš„è¿æ¥ä¸å¯ç”¨ï¼ŒSignalR å°†è‡ªåŠ¨é€€å›åˆ°å…¶ä»–ä¼ è¾“ã€‚

3.  å½“åœ¨ç”»å¸ƒä¸Šç”»çº¿æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šå‘ä¸€ä¸ªåä¸ºâ€œdrawâ€çš„ Azure å‡½æ•°å‘é€ä¸€ç³»åˆ—ç¬”ç”»ã€‚

4.  draw Azure å‡½æ•°ä½¿ç”¨ SignalR æœåŠ¡å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­ä¸€ç³»åˆ—ç¬”ç”»ã€‚

## [](#create-an-azure-signalr-service-instance)åˆ›å»º Azure SignalR æœåŠ¡å®ä¾‹

Azure SignalR æœåŠ¡æ˜¯ä¸€ä¸ªå®Œå…¨æ‰˜ç®¡çš„å®æ—¶æ¶ˆæ¯å¹³å°ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†ä½¿ç”¨å®ƒæ¥å¹¿æ’­æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Azure é—¨æˆ·ä¸­åˆ›å»ºä¸€ä¸ªå…è´¹çš„æœåŠ¡å®ä¾‹ï¼Œæˆ–è€…è¿è¡Œä¸‹é¢çš„ Azure CLI å‘½ä»¤ã€‚

```
az signalr create -n $SIGNALR_NAME -g $GROUP_NAME --sku Free_DS2 -l westus 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ›å»ºå®ä¾‹åï¼Œæˆ‘ä»¬éœ€è¦è·å–å‡½æ•°åº”ç”¨ç¨‹åºå°†ä½¿ç”¨çš„è¿æ¥å­—ç¬¦ä¸²ã€‚

```
az signalr key list -n $SIGNALR_NAME -g $GROUP_NAME 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#build-the-azure-function-app)æ‰“é€  Azure åŠŸèƒ½ app

Azure Function app ç”±ä¸¤ä¸ªå…³é”®åŠŸèƒ½ç»„æˆã€‚ç¬¬ä¸€ä¸ªæ˜¯è¿”å› SignalR æœåŠ¡è¿æ¥ä¿¡æ¯çš„`negotiate`å‡½æ•°ã€‚ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª`draw`å‡½æ•°ï¼Œæ¯å½“åœ¨ä»»ä½•ç”»å¸ƒä¸Šç”»çº¿æ—¶éƒ½ä¼šè°ƒç”¨å®ƒï¼›å®ƒä¼šå°†è¿™äº›çº¿å¹¿æ’­åˆ°å…¶ä»–ç”»å¸ƒä¸Šã€‚

> å¦‚æœä½ ä»¥å‰æ²¡æœ‰ä½¿ç”¨è¿‡ Azure å‡½æ•°ï¼Œå¯ä»¥çœ‹çœ‹å®ƒä»¬çš„[å¿«é€Ÿå…¥é—¨](https://docs.microsoft.com/en-us/azure/azure-functions/?WT.mc_id=devto-blog-antchu)ã€‚

### [](#negotiate-function)åå•†åŠŸèƒ½

è¿™ä¸ª HTTP è§¦å‘çš„å‡½æ•°ä½¿ç”¨`SignalRConnectionInfoInput`ç»‘å®šæ¥ä¸ºå®¢æˆ·ç«¯ç”Ÿæˆè®¿é—®ä»¤ç‰Œå’Œç«¯ç‚¹ä¿¡æ¯ã€‚ç»‘å®šä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²ç”Ÿæˆæ­¤ä¿¡æ¯ã€‚

```
@FunctionName("negotiate")
public SignalRConnectionInfo negotiate(
    @HttpTrigger(
      name = "req",
      methods = { HttpMethod.POST },
      authLevel = AuthorizationLevel.ANONYMOUS) HttpRequestMessage<Optional<String>> req,
    @SignalRConnectionInfoInput(
      name = "connectionInfo",
      hubName = "serverlessdraw") SignalRConnectionInfo connectionInfo) {
  return connectionInfo;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#draw-function)ç»˜åˆ¶åŠŸèƒ½

`draw` HTTP è§¦å‘å‡½æ•°ä½¿ç”¨`SignalROutput`ç»‘å®šå°†ç”»å¸ƒä¸Šç»˜åˆ¶çš„ç¬”ç”»ä¼ æ’­åˆ°å½“å‰è¿æ¥åˆ° SignalR æœåŠ¡çš„æ‰€æœ‰ç”»å¸ƒã€‚

å®ƒåªæ˜¯å°† HTTP è¯·æ±‚ä½“çš„å†…å®¹è½¬å‘ç»™ SignalR æœåŠ¡ã€‚

```
@FunctionName("draw")
public void draw(
    @HttpTrigger(
      name = "req",
      methods = { HttpMethod.POST },
      authLevel = AuthorizationLevel.ANONYMOUS) HttpRequestMessage<StrokeCollection> req,
    @SignalROutput(
      name = "signalRMessage",
      hubName = "serverlessdraw") OutputBinding<SignalRMessage> signalRMessage) {

  StrokeCollection strokeCollection = req.getBody();
  SignalRMessage msg = new SignalRMessage("newStrokes", strokeCollection);
  signalRMessage.setValue(msg);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#create-the-drawing-canvas)åˆ›å»ºç»˜å›¾ç”»å¸ƒ

canvas æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åŸºäºæµè§ˆå™¨çš„ JavaScript åº”ç”¨ç¨‹åºï¼Œå®ƒä½¿ç”¨ HTML canvasã€‚ä½ å¯ä»¥åœ¨æˆ‘çš„ Twitch stream ä¸Šè§‚çœ‹æˆ‘æ„å»ºå®ƒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚

### [](#signalr-service-connection)ä¿¡å·å‘˜æœåŠ¡è¿æ¥

å½“ canvas åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è¿æ¥åˆ° SignalR æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CDN å¼•ç”¨ SignalR JavaScript å®¢æˆ·ç«¯ã€‚

```
<script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js"></script> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯åˆ›å»ºåˆ° SignalR æœåŠ¡çš„è¿æ¥ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼ŒSignalR å®¢æˆ·ç«¯å°†åœ¨ URL çš„æœ«å°¾è¿½åŠ `/negotiate`æ¥å‘ç°è¿æ¥åå•†ç«¯ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åˆå§‹åŒ–`HubConnectionBuilder`æ—¶å°†å‡½æ•° URL çš„è¿™ä¸€éƒ¨åˆ†å»æ‰ã€‚

```
var connection = new signalR.HubConnectionBuilder()
  .withUrl(`${apiBaseUrl}/api`) // function URL minus /negotiate
  .build()

// set up event listeners
connection.on('newStrokes', drawStrokes)
connection.on('clearCanvas', clearCanvas)

connection.start()
  .then(() => console.log('connected')) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨é…ç½®è¿æ¥å’Œå¯åŠ¨è¿æ¥ä¹‹é—´ï¼Œæˆ‘ä»¬è®¾ç½®äº†å‡ ä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚å½“æ¥è‡ª SignalR æœåŠ¡çš„äº‹ä»¶ä¸å…¶ä¸­ä¸€ä¸ªåç§°åŒ¹é…æ—¶ï¼Œå°†è°ƒç”¨äº‹ä»¶å¤„ç†ç¨‹åºã€‚ä¸‹é¢æ˜¯`clearCanvas`å‡½æ•°çš„æ ·å­:

```
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#the-drawing-canvas)ç»˜åˆ¶ç”»å¸ƒ

ä¸»ç”»å¸ƒæ˜¯(ä½ çŒœå¯¹äº†)ä¸€ä¸ªå•ç‹¬çš„`<canvas>`æ ‡ç­¾:

```
<canvas id="draw-canvas" height="500" width="800"></canvas> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸» JavaScript å‡½æ•°è¢«å‘½åä¸º`mouseMove`ã€‚æ¯ç”»ä¸€ç¬”å°±è°ƒç”¨ä¸€æ¬¡ã€‚æˆ‘ä»¬ç®—å‡ºçº¿çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œå¹¶æŠŠå®ƒç”»åœ¨ç”»å¸ƒä¸Šã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ç¬”ç”»æ·»åŠ åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ”¶é›†ä¸€äº›ç¬”ç”»ï¼Œå¹¶æˆæ‰¹å‘é€å®ƒä»¬ã€‚

```
function mouseMove(ev) {

  // ğŸŒŸ math happens here

  drawStroke(start, end, colorButton.value)
  unsentStrokes.push({
    start: start,
    end: end,
    color: colorButton.value
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¯éš” 250 æ¯«ç§’å·¦å³ï¼Œæˆ‘ä»¬å°†ä¸€æ‰¹ç¬”ç”»å‘é€åˆ°æˆ‘ä»¬çš„`draw` Azure å‡½æ•°ã€‚

```
setInterval(function () {
  if (unsentStrokes.length) {
    axios.post(`${apiBaseUrl}/api/draw`, {
      sender: clientId,
      strokes: unsentStrokes
    })
    unsentStrokes = []
  }
}, 250) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

draw å‡½æ•°å°†ä½¿ç”¨ SignalR æœåŠ¡åœ¨æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ¯ä¸ªè¿è¡Œå®ä¾‹ä¸­å¼•å‘`newStrokes`äº‹ä»¶ã€‚è¿™å°†è°ƒç”¨åä¸º`drawStrokes`çš„å‡½æ•°æ¥ç»˜åˆ¶ç¬”ç”»ã€‚

æˆå“çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

[![Serverless draw app](../Images/6b77804348fd35880cd2400e1e850daf.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--G_3StrWt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/08tjfk0nvynqjlz0l0s9.gif)

æŸ¥çœ‹ [GitHub repo](https://github.com/anthonychu/serverless-draw) è·å– Javaã€JavaScript å’Œ C#ç‰ˆæœ¬çš„å‡½æ•°åº”ç”¨çš„æºä»£ç ã€‚

## [](#resources)èµ„æº

*   ç”¨äº Azure åŠŸèƒ½çš„ Azure SignalR æœåŠ¡ç»‘å®šæ­£å¼å‘å¸ƒ
*   [å®£å¸ƒ Azure å‡½æ•°ä¸­ Java æ”¯æŒçš„æ™®éå¯ç”¨æ€§](https://azure.microsoft.com/en-us/blog/announcing-the-general-availability-of-java-support-in-azure-functions/?WT.mc_id=devto-blog-antchu)
*   ã€Azure å‡½æ•°å¼•ç”¨çš„ç»‘å®š
*   [ä¿¡å·æœåŠ¡æ— æœåŠ¡å™¨ç¼–ç¨‹æŒ‡å—](https://docs.microsoft.com/en-us/azure/azure-signalr/signalr-overview-azure-functions?WT.mc_id=devto-blog-antchu)
*   [æ— æœåŠ¡å™¨ç»˜åˆ¶æºä»£ç ](https://github.com/anthonychu/serverless-draw)