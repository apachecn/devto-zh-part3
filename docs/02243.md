# ç†è§£ OAuth2 ä» CLI ä½¿ç”¨ Google APIs

> åŸæ–‡:[https://dev . to/uf4no/understanding-oauth 2-to-use-Google-APIs-from-a-CLI-5g6e](https://dev.to/uf4no/understanding-oauth2-to-use-google-apis-from-a-cli-5g6e)

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»æœªéœ€è¦ä½¿ç”¨ä»»ä½•è°·æ­Œ APIï¼Œä½†æœ€è¿‘æˆ‘éœ€è¦è·å¾—è¿‡å»äº”å¹´ä¸­æˆ‘ä¹˜åçš„æ‰€æœ‰èˆªç­çš„ä¿¡æ¯ï¼Œå°½ç®¡æˆ‘çš„è°·æ­Œæ—¥å†ä¸­æœ‰è¿™äº›ä¿¡æ¯ï¼Œä½†åº”ç”¨ç¨‹åºä¸å…è®¸æˆ‘æå–è¿™äº›ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™æ˜¯æ·±å…¥äº†è§£è°·æ­Œ API å·¥ä½œæ–¹å¼çš„ç»ä½³æœºä¼šã€‚åœ¨å¿«é€Ÿç ”ç©¶äº†[æ—¥å† API æ–‡æ¡£](https://developers.google.com/calendar/v3/reference/ "Google calendar API documentation")ä¹‹åï¼Œæˆ‘çš„è®¡åˆ’æ˜¯åœ¨ Node.js ä¸­æ„å»ºä¸€ä¸ªå°å‹å‘½ä»¤è¡Œåº”ç”¨ç¨‹åºï¼Œå®ƒå°†:

*   å‘ç”¨æˆ·è¯¢é—®ä¸€äº›è¿‡æ»¤å™¨ï¼Œå¦‚æ—¥æœŸèŒƒå›´ã€å…³é”®å­—å’Œè¦æ£€ç´¢çš„ç»“æœæ•°é‡ã€‚
*   å‘è°·æ­Œè®¤è¯
*   åº”ç”¨è¿™äº›è¿‡æ»¤å™¨åœ¨ç”¨æˆ·æ—¥å†ä¸­æœç´¢äº‹ä»¶
*   å°†ç»“æœå†™å…¥æ§åˆ¶å°å’Œæ–‡ä»¶ä¸­

æ„Ÿè°¢ Google æ–‡æ¡£ä¸­æä¾›çš„ä¾‹å­ï¼Œæˆ‘èƒ½å¤Ÿå¾ˆå¿«åœ°ä»æˆ‘çš„æ—¥å†ä¸­æ£€ç´¢æ•°æ®ï¼Œä½†ç†è§£å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„æœ‰ç‚¹æ£˜æ‰‹ï¼Œæ‰€ä»¥æˆ‘å†³å®šé‡æ„ä»£ç ï¼Œä½¿ç”¨ async/await è€Œä¸æ˜¯å›è°ƒæ¥å®Œå…¨ç†è§£å®ƒåœ¨åšä»€ä¹ˆï¼Œå¹¶ä½¿å®ƒæ›´å¯é‡ç”¨ã€‚ç„¶åï¼Œæˆ‘åœ¨å®ƒå‘¨å›´åŒ…è£…äº†ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œä»¥åŒ…å«è¿‡æ»¤å™¨åŠŸèƒ½ã€‚æˆ‘æ˜¯è¿™æ ·åšçš„ğŸ˜

### Google æ—¥å† API æ–‡æ¡£å’Œç¤ºä¾‹

æˆ‘åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è®¿é—®[æ´»åŠ¨èµ„æºé¡µé¢](https://developers.google.com/calendar/v3/reference/events "Google Calendar Events documentation")ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘æƒ³ä»æ—¥å†ä¸­æ£€ç´¢çš„å†…å®¹ã€‚è¿™ä¸ªèµ„æºæœ‰ä¸€äº›æ–¹æ³•ï¼Œå¹¸è¿çš„æ˜¯ï¼Œ **[**list()** æ–¹æ³•](https://developers.google.com/calendar/v3/reference/events/list "Events.list documentation")è¿”å›ä¸€ä¸ªäº‹ä»¶åˆ—è¡¨å¹¶æ¥å—ä¸€äº›æŸ¥è¯¢å‚æ•°ï¼Œè¿™æ­£æ˜¯æˆ‘æ‰€å¯»æ‰¾çš„ã€‚ç„¶åæˆ‘æœç´¢äº†ä¸€äº›ç”¨ Node.js ç¼–å†™çš„ä¾‹å­ï¼Œæ‰¾åˆ°äº†[å¿«é€Ÿå…¥é—¨é¡µé¢](https://developers.google.com/calendar/quickstart/nodejs "Calendar Node.js quickstart")ï¼Œå…¶ä¸­è§£é‡Šäº†å¦‚ä½•ç”¨ 3 ä¸ªç®€å•çš„æ­¥éª¤åˆ›å»ºä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œåº”ç”¨ç¨‹åº:**

 ***   å¯ç”¨ Google æ—¥å† API
*   å®‰è£… googleapis Node.js åŒ…
*   å¤åˆ¶[ä»£ç ç¤ºä¾‹](https://github.com/gsuitedevs/node-samples/blob/master/calendar/quickstart/index.js "CLI example code")å¹¶è¿è¡Œå®ƒ

æ­£å¦‚æ–‡æ¡£ä¸­æ‰€è¯¦è¿°çš„ï¼Œåº”ç”¨ç¨‹åºç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œä¼šè¦æ±‚æ‚¨é€šè¿‡è®¿é—®ä¸€ä¸ª URL æ¥æˆæƒè®¿é—®ã€‚è™½ç„¶è¿™å·¥ä½œæ­£å¸¸ï¼Œæˆ‘å¾—åˆ°äº†ä¸€ä¸ªäº‹ä»¶åˆ—è¡¨ï¼Œä½†æˆ‘ä¸æ˜ç™½è®¤è¯è¿‡ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæ‰€ä»¥æˆ‘æœç´¢äº†æ›´å¤šä¿¡æ¯ï¼Œæ‰¾åˆ°äº†[è¿™ä¸€èŠ‚å…³äºä¸åŒçš„è®¤è¯æ–¹æ³•](https://github.com/googleapis/google-api-nodejs-client#authentication-and-authorization "Google API authentication documentation") (OAuth2ï¼ŒæœåŠ¡-æœåŠ¡å’Œ API å¯†é’¥)å’Œ[å…³äº OAuth2 ä¸­ä½¿ç”¨çš„ OpenID è¿æ¥è§„èŒƒ](https://developers.google.com/identity/protocols/OpenIDConnect "OpenID Connect documentation")çš„é“¾æ¥ã€‚ä¸€æ—¦æˆ‘å»ºç«‹äº†èº«ä»½éªŒè¯å¦‚ä½•å·¥ä½œçš„åŸºç¡€ï¼Œå¹¶å†³å®šäº†æˆ‘æƒ³è¦ä½¿ç”¨çš„æ–¹æ³•(OAuth2)ï¼Œæˆ‘å°±å‡†å¤‡ä½¿ç”¨æ–‡æ¡£ä¸­æä¾›çš„ä»£ç ç¤ºä¾‹ä½œä¸ºå‚è€ƒï¼Œä»å¤´å¼€å§‹ç¼–å†™æˆ‘çš„åº”ç”¨ç¨‹åºã€‚

### å‘è°·æ­Œè®¤è¯

ä½¿ç”¨ä»»ä½• Google API æ—¶ï¼Œé¦–å…ˆè¦åšçš„æ˜¯è¿›å…¥ [Google çš„å¼€å‘è€…æ§åˆ¶å°](https://console.developers.google.com/apis/dashboard "Google's developer console")å¹¶åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®:

[![new project in Google API console](../Images/978d95e67d782e9586bd2fe3e8ae05fb.png)T2ã€‘](https://www.antonioufano.com/image_uploads/new_project.png)

åˆ›å»ºå®Œæˆåï¼Œè½¬åˆ° Library éƒ¨åˆ†ï¼Œæœç´¢ Google Calendar API(æˆ–ä»»ä½•æ‚¨æƒ³è¦ä½¿ç”¨çš„ API)å¹¶å¯ç”¨å®ƒã€‚è¿™æ„å‘³ç€ä¸€æ—¦é€šè¿‡èº«ä»½éªŒè¯ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå°†èƒ½å¤Ÿè®¿é—®é€‰å®šçš„ APIã€‚ç°åœ¨è½¬åˆ°å‡­è¯éƒ¨åˆ†ï¼Œåˆ›å»ºä¸€ç»„æ–°çš„ OAuth å®¢æˆ·ç«¯ ID ç±»å‹çš„å‡­è¯ã€‚åœ¨ä¸‹ä¸€é¡µä¸­ï¼Œå®ƒä¼šè¯¢é—®æ‚¨åº”ç”¨ç¨‹åºçš„ç±»å‹ã€‚å› ä¸ºæˆ‘æƒ³åˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº† Other å¹¶ç»™å®ƒèµ·äº†ä¸€ä¸ªåå­—:

[![new project in Google API console, credentials](../Images/73b70b3f60b24daa4d82fb480b1d96ba.png) ](https://www.antonioufano.com/image_uploads/credentials.png) [ ![new project in Google API console, credentials two](../Images/29e375b81cbb563bc505ee856e2db92d.png)](https://www.antonioufano.com/image_uploads/credentials2.png)

å®Œæˆåï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªä¸æ‚¨çš„é¡¹ç›®ç›¸å…³è”çš„ client_id å’Œ client_secretã€‚æ‚¨å¯ä»¥åœ¨ä¸€ä¸ª JSON æ–‡ä»¶ä¸­ä¸‹è½½å®ƒä»¬ï¼Œè¯¥æ–‡ä»¶è¿˜åŒ…å«å…¶ä»–å±æ€§ï¼Œå¦‚ token_uri(åœ¨è¿™é‡Œæˆ‘ä»¬å°†è¯·æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œ)å’Œ redirect_uri(ä¸€æ—¦è¢«æˆæƒå°±é‡å®šå‘åˆ°å“ªé‡Œï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåªæ˜¯ localhost)ã€‚ä¸‹è½½è¯¥æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬ç¨åä¼šåœ¨ CLI ç¨‹åºä¸­ç”¨åˆ°å®ƒã€‚

ä½†æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è¿™äº› idï¼Œå®ƒä»¬æ˜¯å¦‚ä½•ä½¿ç”¨çš„å‘¢ï¼Ÿæˆ‘è¯•å›¾åœ¨ä¸‹å›¾ä¸­è§£é‡Š oAuth2 è®¤è¯è¿‡ç¨‹:

[![Google API authentication flow](../Images/7247065682eed7c4bd42251fa4ad31c1.png)T2ã€‘](https://www.antonioufano.com/image_uploads/AuthFlow.png)

æ€»ä¹‹ï¼Œè®¤è¯æµç¨‹å°†æ˜¯:

*   ä½¿ç”¨ client_id å’Œ client_secret åˆ›å»º OAuth2 å®¢æˆ·ç«¯å®ä¾‹
*   å‘è°·æ­Œè¯·æ±‚ä¸€ä¸ªè®¤è¯ URL
*   è¦æ±‚ç”¨æˆ·è®¿é—®è®¤è¯ URLï¼Œå¹¶æ¥å—æˆ‘ä»¬çš„ç¨‹åºå°†è®¿é—®ä»–çš„æ—¥å†äº‹ä»¶(è¿™æ˜¯åŸºäºæˆ‘ä»¬å®šä¹‰çš„èŒƒå›´ï¼Œç¨åè§£é‡Š...)
*   ä¸€æ—¦ç”¨æˆ·æ¥å—ï¼Œè°·æ­Œè®¤è¯å°†è¿”å›ä¸€ä¸ªéªŒè¯ç 
*   éªŒè¯ç è¢«æ‰‹åŠ¨ä¼ é€’ç»™æˆ‘ä»¬çš„ CLI ç¨‹åº
*   CLI ç¨‹åºè¯·æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œæ¥äº¤æ¢éªŒè¯ä»£ç 
*   å°†è®¿é—®ä»¤ç‰Œä¿å­˜ä¸º OAuth2 å®¢æˆ·ç«¯å‡­æ®
*   å°†è®¿é—®ä»¤ç‰Œä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ä¾¿åœ¨åç»­è¯·æ±‚ä¸­é‡ç”¨

æ‰€æœ‰è¿™äº›æ­¥éª¤éƒ½æ˜¯åœ¨[è°·æ­Œå¿«é€Ÿå…¥é—¨æŒ‡å—](https://developers.google.com/calendar/quickstart/nodejs "Node.js quickstart Calendar API")ä¸­æä¾›çš„ä»£ç ç¤ºä¾‹ä¸­å®Œæˆçš„ï¼Œä½†æˆ‘å°†å…¶é‡æ„ä¸ºä½¿ç”¨ async/awaitï¼Œå¹¶å°†å…¶æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ä¸­(GitHub ä¸­çš„ [googleAuth.js](https://github.com/uF4No/gcal-event-finder/blob/master/src/googleAuth.js "googleAuth.js in GitHub") )ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥åœ¨å…¶ä»–ç¨‹åºä¸­é‡ç”¨å®ƒã€‚æ­¤æ¨¡å—å¯¼å‡ºä¸€ä¸ªå‡½æ•°æ¥ç”Ÿæˆç»è¿‡èº«ä»½éªŒè¯çš„ OAuth2 å®¢æˆ·ç«¯ã€‚ä»£ç å¦‚ä¸‹:

```
/**
 * googleAuth.js
 * 
 * Generates an OAuthClient to be used by an API service
 * Requires path to file that contains clientId/clientSecret and scopes
 */

const {google} = require('googleapis');
const fs = require('fs');

const inquirer = require('inquirer')

const debug = require('debug')('gcal:googleAuth')

// The file token.json stores the user's access and refresh tokens, and is
// created automatically when the authorization flow completes for the first
// time.
const TOKEN_PATH = 'token.json';

/**
 * Generates an authorized OAuth2 client.
 * @param {object} keysObj Object with client_id, project_id, client_secret...
 * @param {array<string>} scopes The scopes for your oAuthClient
*/
async function generateOAuthClient(keysObj, scopes){
  let oAuth2Client
  try{
    const {client_secret, client_id, redirect_uris} = keysObj.installed
    debug('Secrets read!')
    // create oAuthClient using clientId and Secret
    oAuth2Client = new google.auth.OAuth2(client_id, client_secret, redirect_uris[0])
    google.options({auth: oAuth2Client});

    // check if we have a valid token
    const tokenFile = fs.readFileSync(TOKEN_PATH)
    if(tokenFile !== undefined &amp;&amp; tokenFile !== {}){
      debug('Token already exists and is not empty %s', tokenFile)

      oAuth2Client.setCredentials(JSON.parse(tokenFile))
    }else{
      debug('ğŸ¤¬ğŸ¤¬ğŸ¤¬ Token is empty!')
      throw new Error('Empty token')
    }
    return Promise.resolve(oAuth2Client)
  }catch(err){
    console.log('Token not found or empty, generating a new one ğŸ¤¨')
    // get new token and set it to the oAuthClient.credentials
    oAuth2Client = await getAccessToken(oAuth2Client, scopes)

    return Promise.resolve(oAuth2Client)
  }

}

/**
 * Get and store access_token after prompting for user authorization
 * @param {google.auth.OAuth2} oAuth2Client The OAuth2 client to get token for.
 * @param {array<string>} scopes The scopes for your oAuthClient
*/
async function getAccessToken(oAuth2Client, scopes) {
  const authUrl = oAuth2Client.generateAuthUrl({
    access_type: 'offline',
    scope: scopes,
  });
  console.log('âš ï¸ Authorize this app by visiting this url:', authUrl);
  let question = [
    { 
      type: 'input',
      name: 'code',
      message: 'Enter the code from that page here:'
    }
  ]
  const answer = await inquirer.prompt(question)
  console.log(`ğŸ¤ Ok, your access_code is ${answer['code']}`)
  // get new token in exchange of the auth code
  const response = await oAuth2Client.getToken(answer['code'])
  debug('Token received from Google %j', response.tokens)
  // save token in oAuth2Client
  oAuth2Client.setCredentials(response.tokens)
  // save token in disk
  fs.writeFileSync(TOKEN_PATH, JSON.stringify(response.tokens))

  return Promise.resolve(oAuth2Client)

}

module.exports = {generateOAuthClient} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå…·æœ‰æœ‰æ•ˆè®¿é—®ä»¤ç‰Œçš„ OAuth2 å®¢æˆ·æœºï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒæ¥æŸ¥è¯¢æ—¥å† APIã€‚

### ä»æ—¥å†ä¸­æ£€ç´¢äº‹ä»¶

ä¸ºäº†ä¸æ—¥å† API è¿›è¡Œäº¤äº’ï¼Œæˆ‘åˆ›å»ºäº†å¦ä¸€ä¸ªæ¨¡å—( [calendarService.js](https://github.com/uF4No/gcal-event-finder/blob/master/src/calendarService.js "calendarService.js in GitHub") åœ¨ GitHub ä¸­),è¯¥æ¨¡å—å¯¼å‡ºä¸€ä¸ªå‡½æ•° **getEvents()** ,è¯¥å‡½æ•°æ¥æ”¶ OAuth2 å®¢æˆ·ç«¯(å·²ç»é€šè¿‡èº«ä»½éªŒè¯)å’Œä¸€ä¸ªè¿‡æ»¤å™¨å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚ç„¶åé€šè¿‡æ·»åŠ  calendarId æ„å»º filterBy å¯¹è±¡ï¼Œè½¬æ¢æ—¥æœŸèŒƒå›´ï¼Œæ·»åŠ  orderBy å’Œ maxResults ç­‰å…¶ä»–å€¼ï¼Œæœ€åè°ƒç”¨ **events.list()** æ–¹æ³•ã€‚

```
/**
 * calendarService.js
 * 
 * Methods to interact with the Google Calendar API
 * 
 */
const {google} = require('googleapis');
const debug = require('debug')('gcal:calendarService')

/**
 * creates a Google Calendar instance using the OAuth2 client and call the list events with the filter
 * @param {google.auth.OAuth2} auth The OAuth2 client already authenticated
 * @param {object} filter Properties to filter by
 */
async function getEvents(auth, filter){
  try{

    const calendar = google.calendar({
      version: 'v3',
      auth
    })

    const filterBy = {
      calendarId: 'primary',
      timeMin: (new Date(filter.timeMin).toISOString()) || (new Date('2014-01-01')).toISOString(),
      timeMax: (new Date(filter.timeMax).toISOString())  || (new Date()).toISOString(),
      maxResults: filter.maxResults ,
      singleEvents: true,
      orderBy: 'startTime',
      q:filter.keyword
    }
    debug('Searching with filter %j', filterBy)
    const events = await calendar.events.list(filterBy)
    debug('found events: ', events)
    return events
  }catch(err){
    debug('ğŸ¤¬ğŸ¤¬ğŸ¤¬ Captured error in getEvents: %s', err)
    console.log(err)
  }

}

module.exports = {getEvents} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

***æ³¨æ„:**å¦‚æœæˆ‘æƒ³ç”¨å¤šä¸ªå‡½æ•°æ‰©å±•è¿™ä¸ªæ¨¡å—æ¥è°ƒç”¨ API çš„ä¸åŒæ–¹æ³•ï¼Œæˆ‘å¯ä»¥ä»ä»»ä½•å‡½æ•°ä¸­æå–æ—¥å†å®¢æˆ·ç«¯çš„åˆ›å»ºï¼Œä¸€æ—¦åˆ›å»ºï¼Œå°±å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ‰€æœ‰å‡½æ•°ã€‚*

### å‘½ä»¤è¡Œç¨‹åº

æœ€åä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª CLI ç¨‹åºï¼Œè¦æ±‚ç”¨æˆ·æä¾›ä¸€äº›è¿‡æ»¤å™¨ã€‚æˆ‘ç”¨ [inquirer](https://www.npmjs.com/package/inquirer "Inquirer NPM page") æ¥æ„å»ºå®ƒï¼Œå› ä¸ºå®ƒéå¸¸å®¹æ˜“ä½¿ç”¨ï¼›æ‚¨åªéœ€å®šä¹‰ä¸€ä¸ªé—®é¢˜æ•°ç»„ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™ prompt æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè§£æå¸¦æœ‰ç­”æ¡ˆçš„æ‰¿è¯ºã€‚æˆ‘è¿˜åˆ›å»ºäº†å¦ä¸€ä¸ªå¼‚æ­¥å‡½æ•°(triggerCalendarAPI ),å®ƒé¦–å…ˆè°ƒç”¨ googleAuth.js æ¨¡å—ä¼ é€’ client_d å’Œ secret(ä»¥è·å¾—ç»è¿‡èº«ä»½éªŒè¯çš„ OAuth2 å®¢æˆ·ç«¯),ç„¶åè°ƒç”¨ calendarService.js æ¨¡å—æ£€ç´¢äº‹ä»¶åˆ—è¡¨ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæ‰“å°åˆ°æ§åˆ¶å°æˆ–å†™å…¥æ–‡ä»¶ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†ç»“æœå†™å…¥ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶:

*   results.json åªåŒ…å«æ£€ç´¢åˆ°çš„äº‹ä»¶çš„åç§°ã€æ—¥æœŸå’Œä½ç½®
*   results_raw.json åŒ…å«æ£€ç´¢åˆ°çš„äº‹ä»¶çš„æ‰€æœ‰å±æ€§

å¦ä¸€ä»¶é‡è¦çš„äº‹æƒ…æ˜¯ï¼Œæˆ‘å¿…é¡»å®šä¹‰ä¸€ä¸ªç®€å•çš„èŒƒå›´ï¼Œåªä»æ—¥å† API ä¸­è¯»å–ã€‚æ ¹æ®æ‚¨æƒ³è¦ä½¿ç”¨çš„ API å’Œæ“ä½œï¼Œæ‚¨å¿…é¡»å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚åœ¨æ¯ä¸ª API æ–‡æ¡£ä¸­å¯ä»¥æ‰¾åˆ°ä¸åŒçš„ä½œç”¨åŸŸã€‚

```
/**
 * gCal Event Finder
 * CLI program to search and extract events from the user's calendar
 * using the Google Calendar API. Requires 
 * 
 */

const fs = require('fs');
const inquirer = require('inquirer')
const figlet = require('figlet')
const calendarService = require('./src/calendarService')
const googleAuth = require('./src/googleAuth')

const debug = require('debug')('gcal:index')

// IMPORTANT!: Define path to your secrets file, which should contain client_id, client_secret etc...
// To generate one, create a new project in Google's Developer console
const secretsFile = './keys/secrets.json'
const secrets = JSON.parse(fs.readFileSync(secretsFile));

// define the scope for our app
const scopes = ['https://www.googleapis.com/auth/calendar.readonly']

/**
 * Function that trigger calls to googleAuth and calendarService to 
 * retrieve the events from the calendar API.
 * @param {object} filter with properties maxResults, timeMin, timeMax and keyword 
 */
async function triggerCalendarAPI(filter){
  try{
    // get authenticated oAuth2 client 
    const oAuth2Client = await googleAuth.generateOAuthClient(secrets, scopes)
    debug('oAuthClient received, getting events....')
    // call the calendar service to retrieve the events. Pass secrets and scope
    const events = await calendarService.getEvents(oAuth2Client, filter)
    debug('Events are %j', events)
    // check if the are events returned
    if(events.data.items.length &gt; -1){
      //write raw results to file
      console.log(`Found ${events.data.items.length} events!`)
      await fs.writeFileSync('./results_raw.json', JSON.stringify(events.data.items))
      let res = [];
      // loop events array to filter properties
      events.data.items.forEach(event =&gt; {
        const start = event.start.dateTime || event.start.date;
        res.push({date:start,summary:event.summary, location: event.location})
      });
      //write filtered properties to another file
      await fs.writeFileSync('./results.json', JSON.stringify(res))

      console.log(`ğŸ‘ğŸ‘ğŸ‘ - Results extracted to file results.json and results_raw.json`)
      return Promise.resolve(events)
    }else{
      throw new Error('ğŸ¤¯ No records found')
    }

  }catch(err){
    console.log('ğŸ¤¬ğŸ¤¬ğŸ¤¬ ERROR!!!' + err)
    return Promise.reject(err)
  }
}

/**
 * #########  Starts CLI program  #################
**/

console.log(figlet.textSync('gcal-finder', { horizontalLayout: 'full' }))
console.log(`Let's find some events in your calendar ğŸ¤”!`)

let filter = {};
let questions = [
{
  type: 'input',
  name: 'nResults',
  message: 'How many results do you want to retrieve? (default 100)'  
},
{
  type: 'input',
  name: 'dateFrom',
  message: 'Start date (YYYY-MM-DD)? (default 3 months ago)'  
},
{
  type: 'input',
  name: 'dateTo',
  message: 'End Date (YYYY-MM-DD)? (default today)'  
},
{
  type: 'input',
  name: 'keyword',
  message: 'Search by keyword? (just one ğŸ˜¬  default all)'  
},
]

inquirer.prompt(questions).then(answers =&gt; {
  const today = new Date();
  const temp = new Date()
  temp.setMonth(temp.getMonth() -3)
  const monthsAgo = temp.toISOString();
  filter = {
    maxResults: answers['nResults'] || 100,
    timeMin: answers['dateFrom'] || monthsAgo,
    timeMax: answers['dateTo'] || today,
    keyword: answers['keyword'] || undefined
  }
  debug('Searching with filter: %j ', filter)

  return triggerCalendarAPI(filter);

}).catch(err =&gt; {
  console.log('ğŸ¤¬ğŸ¤¬ğŸ¤¬ Error retrieving events from the calendar' + err)
}) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**é‡è¦æç¤º:**secrets . JSON æ–‡ä»¶åŒ…å«æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ client_idã€client_secret å’Œ project_id(ä»¥åŠå…¶ä»–å±æ€§)ã€‚ä½ å¯ä»¥ä» [Google API å¼€å‘è€…æ§åˆ¶å°](https://console.developers.google.com/apis/dashboard "Google API developer console")çš„å‡­è¯éƒ¨åˆ†ä¸‹è½½å®Œæ•´çš„ json æ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ª web åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ redirect_uri å±æ€§å°†ç”¨æˆ·å‘é€åˆ°æˆ‘ä»¬é¡¹ç›®çš„ç‰¹å®š URLã€‚

### ç»“è®º

è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ä¸ºæˆ‘ä¸ªäººéœ€è¦çš„ä¸œè¥¿ä½¿ç”¨ä¸€ä¸ªäº§å“çš„ APIï¼Œè¿™çœŸçš„è®©æˆ‘æƒ³åˆ°äº†è¿™ç§ API ç»™æˆ‘ä»¬å¸¦æ¥çš„æ‰€æœ‰å¯èƒ½æ€§ã€‚æˆ‘ä»¬å¯ä»¥å°†äº§å“çš„åŸå§‹åŠŸèƒ½æ‰©å±•åˆ°æˆ‘ä»¬æˆ–æˆ‘ä»¬ç¡®å®šçš„å¸‚åœºéœ€æ±‚ã€‚

æˆ‘æƒ³åˆ†äº«è¿™ä¸ªå‘½ä»¤è¡Œç¨‹åºï¼Œäººä»¬å¯ä»¥ä½¿ç”¨ NPM åœ¨å…¨çƒèŒƒå›´å†…å®‰è£…ï¼Œä½†è¿™æ„å‘³ç€æˆ‘å¿…é¡»å°†æˆ‘è‡ªå·±é¡¹ç›®çš„ client_id å’Œ secret ä¸Šä¼ åˆ° repoï¼Œæ‰€ä»¥ï¼Œæˆ‘æ²¡æœ‰è¿™æ ·åšï¼Œè€Œæ˜¯å°†ä»£ç ä¸Šä¼ åˆ° GitHub ä¸­çš„[è¿™ä¸ª repoï¼Œå¦‚æœä½ æƒ³è¿è¡Œå®ƒï¼Œä½ åªéœ€åœ¨ä½ è‡ªå·±çš„ Google å¼€å‘è€…æ§åˆ¶å°ä¸­ç”Ÿæˆä¸€ä¸ªæ–°çš„ client_id å’Œ secretï¼Œå°†å®ƒä»¬æ”¾åœ¨ secrets.json æ–‡ä»¶ä¸­ï¼Œä½ å°±å¯ä»¥å¼€å§‹äº†ã€‚](https://github.com/uF4No/gcal-event-finder "gcal-event-finder in GitHub")

å¸Œæœ›è¿™å¯¹ä½ æœ‰ç”¨ã€‚

ç¼–ç å¿«ä¹ï¼

* * *

*æœ¬æ–‡åŸè½½äº[æˆ‘çš„ç½‘ç«™](https://www.antonioufano.com)ã€‚å¦‚æœä½ å–œæ¬¢ï¼Œä½ å¯èƒ½ä¼šåœ¨[æˆ‘çš„åšå®¢](https://www.antonioufano.com/blog)* ä¸­æ‰¾åˆ°æœ‰è¶£çš„å¾€æœŸæ–‡ç« **