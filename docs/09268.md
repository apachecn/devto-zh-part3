# ä½¿ç”¨ HttpClient æ‹¦æˆªè¿›è¡Œæµ‹è¯•

> åŸæ–‡:[https://dev . to/stuartblang/testing-with-http client-interception-304 f](https://dev.to/stuartblang/testing-with-httpclient-interception-304f)

åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ä»ä¸€ä¸ª swagger æ–‡ä»¶ä¸­è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç”¨äº`HttpClientFactory`çš„ç±»å‹åŒ–å®¢æˆ·ç«¯ã€‚ç°åœ¨æˆ‘æƒ³å¯¹å®¢æˆ·ç«¯çš„è¡Œä¸ºè¿›è¡Œä¿®æ”¹ï¼Œå¹¶éœ€è¦è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†çœ‹çœ‹ [HttpClient æ‹¦æˆª](https://github.com/justeat/httpclient-interception/)åº“ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•åœ¨æµ‹è¯•ä¸­æœ‰æ•ˆåœ°ä½¿ç”¨å®ƒã€‚

çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå®ƒåˆ©ç”¨äº†æˆ‘ä»¬ä¹‹å‰ç”Ÿæˆçš„å®¢æˆ·æœºã€‚

```
var pet = await petStoreClient.GetPetByIdAsync(1, ct);
var firstTag = pet.Tags.FirstOrDefault(); 
```

è¿™çœ‹èµ·æ¥å¾ˆå¥½ï¼Œå¯¹ä¸å¯¹ï¼Ÿä½†æ˜¯å¦‚æœ`Tags`æ˜¯`null`ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿé‚£ä»¶äº‹ä¼šå‘ç”Ÿå—ï¼Ÿ

å¿«é€Ÿè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨`?.`æ¥ä¼ æ’­ç©ºå®‰å…¨ï¼Œä½†æ˜¯ä¹Ÿè®¸æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„ååºåˆ—åŒ–æ°¸è¿œä¸å…è®¸é›†åˆä¸ºç©ºï¼Œè€Œæ˜¯é»˜è®¤ä¸ºç©ºé›†åˆã€‚

ä¸ºäº†å¼„æ¸…æ¥šå½“å‰çš„è¡Œä¸ºå¹¶è®°å½•æˆ‘ä»¬å¸Œæœ›å®ƒå¦‚ä½•å·¥ä½œï¼Œæˆ‘ä»¬åº”è¯¥ç¼–å†™æµ‹è¯•ã€‚

æˆ‘å°†ç”¨ F#ç¼–å†™è¿™äº›æµ‹è¯•ï¼Œå› ä¸ºå®ƒå¤ªæ£’äº†ï¼å®ƒä¸ä»…æ˜¯ä¸€ç§éå¸¸å¥½çš„è¯­è¨€ï¼Œæˆ‘æƒ³åœ¨æˆ‘çš„æµ‹è¯•ä¸­ä½¿ç”¨åŒ…å« JSON çš„å­—ç¬¦ä¸²ï¼Œè¿™åœ¨ C#ä¸­æ˜¯å¾ˆç—›è‹¦çš„ã€‚

## [](#httpclient-interception)HttpClient æ‹¦æˆª

è¿™ä¸ªåº“çœŸçš„å¾ˆæ£’ï¼Œå®ƒæœ‰ä¸€ä¸ªæµç•…çš„ APIï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªåŠ è½½äº†ä¸€ä¸ª`HttpClientHandler`çš„`HttpClient`ï¼Œè¿™ä¸ª`HttpClientHandler`å°†æ‹¦æˆªè¯·æ±‚å¹¶è¿”å›é…ç½®å¥½çš„å“åº”ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆå•å…ƒæµ‹è¯•ã€‚

æµç•…çš„ API éå¸¸ç›´è§‚ï¼Œä½ å¯ä»¥åœ¨ [README](https://github.com/justeat/httpclient-interception/) ä¸Šçœ‹åˆ°ä¸€äº›å¾ˆæ£’çš„ä¾‹å­ã€‚

```
module NSwag.PetStore.Client.Tests.Tests

open System
open Xunit
open NSwag.PetStore.Client
open JustEat.HttpClientInterception

[<Fact>]
let ``Given missing collection property, we deserialize to an empty collection. ğŸš€`` () =

    let builder =
        HttpRequestInterceptionBuilder()
            .Requests().ForAnyHost().ForPath("/pet/1234")
            .Responds().WithContent """{
  "id": 0,
  "name": "doggie",
  "photoUrls": [
    "string"
  ],
  "status": "available"
}"""

    let options =  HttpClientInterceptorOptions().ThrowsOnMissingRegistration()
    builder.RegisterWith options |> ignore
    use innerClient = options.CreateHttpClient()

    innerClient.BaseAddress <- "http://test-host" |> Uri

    let client = PetStoreClient(innerClient)
    let pet = client.GetPetByIdAsync(1234L) |> Async.AwaitTask |> Async.RunSynchronously

    Assert.NotNull pet.Tags
    Assert.Empty pet.Tags 
```

æœ‰äº›äº‹æƒ…è¦å¤§å£°è¯´å‡ºæ¥:

*   æˆ‘ä»¬ç”¨çš„æ˜¯`xUnit`ï¼Œå¦ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©æ˜¯ [Expecto](https://github.com/haf/expecto) ï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰éª‘æ‰‹çš„æµ‹è¯•è·‘æ­¥è€…ï¼ŒxUnit åœ¨è¿™é‡Œä¼šå·¥ä½œå¾—å¾ˆå¥½ã€‚xUnit ä¸ F#é…åˆå¾—å¾ˆå¥½ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç±»å®šä¹‰ï¼Œæ³¨æ„æˆ‘ä»¬åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªæ¨¡å—ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æƒ³è¦ä½¿ç”¨`ITestOutputHelper`æˆ‘ä»¬å°±å¿…é¡»åˆ‡æ¢åˆ°ä½¿ç”¨ç±»ã€‚
*   F#ä¸­çš„å‡½æ•°åå¯ä»¥åŒ…å«å‡ ä¹ä»»ä½•ä¸œè¥¿ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€æ ‡ç‚¹ç¬¦å·ã€ç”šè‡³è¡¨æƒ…ç¬¦å·(è¿™æ„å‘³ç€ä½ å¿…é¡»ä½¿ç”¨å®ƒä»¬ï¼).
*   å½“æˆ‘ä»¬ä½¿ç”¨ä¸‰é‡å¼•å·å­—ç¬¦ä¸²æ—¶ï¼Œå­—ç¬¦ä¸²æ–‡å­—å¯ä»¥åŒ…å«`"`â€”â€”è¿™å¯¹ JSON å’Œ XML ç‰‡æ®µæ¥è¯´å¾ˆå¥½ã€‚

å°±æˆ‘ä»¬ç”¨ HttpClient æ‹¦æˆªå™¨æ‰€åšçš„äº‹æƒ…è€Œè¨€ï¼Œå®ƒå‡ ä¹ä¸éœ€è¦è§£é‡Šï¼Œå› ä¸ºå®ƒå®Œå…¨æ˜¯å£°æ˜æ€§çš„ï¼Œæˆ‘è¦æ·»åŠ çš„å”¯ä¸€æ³¨é‡Šæ˜¯ï¼Œåœ¨æµ‹è¯•æœŸé—´ï¼Œæ‚¨å¯èƒ½éœ€è¦`ThrowsOnMissingRegistration`,å› ä¸ºè¿™ç¡®ä¿äº†ä¸€åˆ‡éƒ½å®Œå…¨åœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿é€šè¿‡å¹¶å…·ä½“åŒ–ä¸ºå®é™…çš„ HTTP è¯·æ±‚ã€‚

<figure>[![](../Images/f6417bd309569ea4ea490a8c923be69d.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--CAYvCx_6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://stu.dev/content/images/2019/03/image.png) 

<figcaption>æ­£å¦‚æˆ‘ä»¬æ‰€æ€€ç–‘çš„ï¼</figcaption>

</figure>

å¯¹ï¼Œæ‰€ä»¥å¦‚æœ JSON çš„`Tag`éƒ¨åˆ†è¢«çœç•¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªç©ºé›†åˆï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ”¹å˜å®ƒã€‚

NSwag è®©æˆ‘ä»¬ä»¥å‡ ç§æ–¹å¼æ§åˆ¶åºåˆ—åŒ–è®¾ç½®ï¼Œä¸€ç§æ–¹å¼æ˜¯é€šè¿‡`jsonSerializerSettingsTransformationMethod`è®¾ç½®ï¼Œå®ƒè®©æˆ‘ä»¬æŒ‡å‘ä¸€ä¸ªé™æ€æ–¹æ³•æ¥é…ç½®`JsonSerializerSettings`ã€‚

ç»è¿‡å¤§é‡çš„è°ƒæŸ¥ï¼Œæˆ‘å‘ç°è¿™æ˜¯å®ç°æˆ‘æƒ³è¦çš„ååºåˆ—åŒ–çš„æœ€ç®€å•çš„æ–¹æ³•:

```
using System;
using System.Collections.Generic;
using System.Reflection;
using Newtonsoft.Json;
using Newtonsoft.Json.Serialization;

namespace NSwag.PetStore.Client
{
    internal static class PetStoreSerializerSettings
    {
        public static JsonSerializerSettings TransformSettings(JsonSerializerSettings settings)
        {
            settings.DefaultValueHandling = DefaultValueHandling.Populate;
            settings.ContractResolver = new NullToEmptyListResolver();
            return settings;
        }
    }

    internal sealed class NullToEmptyListResolver : DefaultContractResolver
    {
        protected override JsonProperty CreateProperty(MemberInfo member, MemberSerialization memberSerialization)
        {
            var property = base.CreateProperty(member, memberSerialization);

            var propType = property.PropertyType;
            if (propType.IsGenericType && 
                propType.GetGenericTypeDefinition() == typeof(ICollection<>))
                property.NullValueHandling = NullValueHandling.Include;
            return property;
        }

        protected override IValueProvider CreateMemberValueProvider(MemberInfo member)
        {
            var provider = base.CreateMemberValueProvider(member);

            if (member.MemberType == MemberTypes.Property)
            {
                var propType = ((PropertyInfo)member).PropertyType;
                if (propType.IsGenericType && 
                    propType.GetGenericTypeDefinition() == typeof(ICollection<>))
                {
                    return new EmptyListValueProvider(provider, propType);
                }
            }

            return provider;
        }

        class EmptyListValueProvider : IValueProvider
        {
            readonly IValueProvider innerProvider;
            readonly object defaultValue;

            public EmptyListValueProvider(IValueProvider innerProvider, Type listType)
            {
                this.innerProvider = innerProvider;
                defaultValue = Array.CreateInstance(listType.GetGenericArguments()[0], 0);
            }

            public void SetValue(object target, object value) => innerProvider.SetValue(target, value ?? defaultValue);
            public object GetValue(object target) => innerProvider.GetValue(target) ?? defaultValue;
        }
    }
} 
```

å¦‚æœæœ‰æ›´ç®€å•çš„æ–¹æ³•(è€Œä¸”æˆ‘æ€€ç–‘è‚¯å®šæœ‰ï¼)ä¸€å®šè¦åœ¨è¯„è®ºé‡Œè®©æˆ‘çŸ¥é“ã€‚

å½“æˆ‘ä»¬å†æ¬¡è¿›è¡Œæµ‹è¯•æ—¶...

<figure>[![](../Images/073348d5b5c4afc5113adef81f3301be.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--dgeRKpFs--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://stu.dev/content/images/2019/03/image-1.png) 

<figcaption>é‚£æ›´å¥½ğŸ™‚</figcaption>

</figure>

## [](#other-options-with-httpclient-interception)å…¶ä»–é€‰é¡¹åŒ HttpClient æ‹¦æˆª

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å¸Œæœ›æˆ‘çš„æµ‹è¯•åŒ…å«ä¸€ä¸ª JSON å­—ç¬¦ä¸²æ–‡å­—ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`WithJsonContent`æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ªå¯¹è±¡å¹¶ä¸ºæˆ‘ä»¬åºåˆ—åŒ–å®ƒ(å¯é€‰åœ°ä½¿ç”¨åºåˆ—åŒ–è®¾ç½®)ã€‚å…·æœ‰è®½åˆºæ„å‘³çš„æ˜¯ï¼Œå¦‚æœæˆ‘æƒ³è¿™æ ·åšï¼Œåœ¨ C#ä¸­ä¼šæ›´å®¹æ˜“ï¼Œå› ä¸ºåŒ¿åå¯¹è±¡åœ¨ F#ä¸­è¿˜æ²¡æœ‰ç™»é™†(ä½†æ˜¯å®ƒæ˜¯å¦‚æ­¤çš„æ¥è¿‘ï¼).

ä¸€ä¸ªä»¤äººä¿¡æœçš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸€ä¸ª [HTTP bundle](https://github.com/justeat/httpclient-interception#http-bundle-files) æ–‡ä»¶ï¼Œå¼•ç”¨æ–‡æ¡£çš„è¯æ¥è¯´ï¼Œâ€œå¯ä»¥ç”¨æ¥å­˜å‚¨ HTTP è¯·æ±‚ï¼Œä»¥æ‹¦æˆªç›¸åº”çš„å“åº”å¹¶å°†å…¶å­˜å‚¨ä¸º JSONâ€ã€‚

## [](#closing)å…³é—­

HttpClient æ‹¦æˆªæ˜¯[é©¬ä¸Â·ç§‘æ–¯ç‰¹æ´›](https://twitter.com/martin_costello)çš„[åˆ›æ„ï¼Œä»–æ€»æ˜¯åœ¨äº’è”ç½‘ä¸ŠåšæƒŠäººçš„äº‹æƒ…ã€‚NET æ ¸å¿ƒç¤¾åŒºã€‚](https://github.com/justeat/httpclient-interception/graphs/contributors)

ä½ å¯ä»¥åœ¨è¿™ä¸ªå¸–å­çš„ä¸­æ‰¾åˆ°æ‰€æœ‰çš„[ä»£ç ã€‚](https://github.com/slang25/nswag-petstore-client/tree/httpclient-interception)