# Node.js fork ä¸æ˜¯ä½ æƒ³çš„é‚£æ ·ï¼

> åŸæ–‡:[https://dev . to/pi0/nodejs-fork-is not-what-you-think-of-this-this-of-you-think-37ko](https://dev.to/pi0/nodejs-fork-is-not-what-you-think-of-37ko)

ä»Šå¤©æˆ‘æ„è¯†åˆ°ï¼Œåœ¨ Node.js ä¸­ï¼Œ`cluster.fork`å’Œ`child_process.fork`çš„è¡Œä¸ºéƒ½ä¸åƒä½ åœ¨ C ç¯å¢ƒä¸­æ‰€æœŸæœ›çš„é‚£æ ·ã€‚å®é™…ä¸Šï¼Œåœ¨[æ–‡ä»¶](https://nodejs.org/api/child_process.html#child_process_child_process_fork_modulepath_args_options)ä¸­æœ‰ç®€çŸ­æåŠ:

> ä¸ [fork(2)](http://man7.org/linux/man-pages/man2/fork.2.htm) POSIX ç³»ç»Ÿè°ƒç”¨ä¸åŒï¼Œ`child_process.fork()`ä¸å…‹éš†å½“å‰è¿›ç¨‹ã€‚
> 
> `child_process.fork()`æ–¹æ³•æ˜¯`child_process.spawn()`çš„ç‰¹ä¾‹ï¼Œä¸“é—¨ç”¨äºäº§ç”Ÿæ–°çš„ Node.js è¿›ç¨‹ã€‚åƒ`child_process.spawn()`ä¸€æ ·ï¼Œè¿”å›ä¸€ä¸ª`ChildProcess`å¯¹è±¡ã€‚è¿”å›çš„`ChildProcess`å°†æœ‰ä¸€ä¸ªé¢å¤–çš„å†…ç½®é€šä¿¡é€šé“ï¼Œå…è®¸æ¶ˆæ¯åœ¨çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ä¹‹é—´æ¥å›ä¼ é€’ã€‚

## [](#so-what-it-means)é‚£ä¹ˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

ä»¥ä¸€ä¸ªç®€å•çš„ C ä»£ç ä¸ºä¾‹ï¼Œå®ƒåˆ†æ”¯ 5 ä¸ªè¿›ç¨‹:

```
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h> 
int main()
{
   printf("Shared Code\n");

   for (int i = 0; i < 5; i++)
   {
      int pid = fork();
      if (!pid)
      {
       return printf("Worker %d\n", i+1);
      }
   }

   return 0;
} 
```

ç¼–è¯‘å¹¶è¿è¡Œè¿™æ®µä»£ç ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœ:

```
Shared
Worker 1
Worker 2
Worker 3
Worker 4
Worker 5 
```

æ“ä½œç³»ç»Ÿåœ¨å¹•ååšçš„æ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ [fork()](http://man7.org/linux/man-pages/man2/fork.2.htm) æ—¶ï¼Œå®ƒ**å°†**æ•´ä¸ªè¿›ç¨‹çŠ¶æ€å¤åˆ¶åˆ°ä¸€ä¸ªå…·æœ‰æ–° PID çš„æ–°çŠ¶æ€ã€‚å·¥ä½œè€…è¿›ç¨‹ä¸­çš„è¿”å›å€¼æ€»æ˜¯`0`ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ç§æ–¹æ³•æ¥æŸ¥æ˜**ä»£ç çš„å‰©ä½™éƒ¨åˆ†**æ˜¯å¦åœ¨åˆ†å‰è¿›ç¨‹æˆ–ä¸»è¿›ç¨‹ä¸­è¿è¡Œã€‚(*æ„Ÿè°¢@å°ç‹ç‹¸ commentğŸ§¡* )

é‡è¦çš„ä¸€ç‚¹æ˜¯åˆ†å‰çš„è¿›ç¨‹**ä»è°ƒç”¨`fork()`çš„åœ°æ–¹ç»§ç»­**ã€‚ä¸æ˜¯ä»å¤´å¼€å§‹ï¼Œæ‰€ä»¥`Shared`åªæ‰“å°ä¸€æ¬¡ã€‚

åœ¨ Node.js ä¸­è¿è¡Œç±»ä¼¼çš„ä»£ç :

```
 const { fork, isMaster } = require('cluster')

console.log('Shared')

if (isMaster) {
  // Fork workers.
  for (let i = 0; i < 5; i++) {
    fork();
  }
} else {
  // Worker
  console.log(`Worker`);
} 
```

è¾“å‡ºæƒŠäººåœ°ä¸åŒ:

```
Shared
Shared
Worker
Shared
Worker
Shared
Worker
Shared
Worker
Shared
Worker 
```

å…³é”®æ˜¯æ¯æ¬¡å·¥äººåˆ†å‰æ—¶ï¼Œå®ƒéƒ½ä»ä¸€ä¸ªæ–°çš„ V8 å®ä¾‹å¼€å§‹ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªé¡¾åæ€ä¹‰çš„è¡Œä¸ºã€‚Node.js ä¸­çš„ Fork å®é™…ä¸Šæ˜¯åœ¨æ‰§è¡Œ exec/spawnï¼Œè¿™å¯¼è‡´æ¯æ¬¡éƒ½è¿è¡Œå…±äº«ä»£ç ã€‚

## [](#ok-so-lets-move-raw-consolelogshared-endraw-into-raw-if-ismaster-endraw-p)è¿˜å¥½ã€‚æ‰€ä»¥è®©æˆ‘ä»¬æŠŠ`console.log('Shared')`ç§»åˆ°`if (isMaster)` :P

å¥½å§ã€‚æ˜¯çš„ã€‚ä½ æ˜¯å¯¹çš„ã€‚è¿™å°±æ˜¯è§£å†³åŠæ³•ã€‚ä½†æ˜¯å°±è¿™ä¸ªä¾‹å­æ¥è¯´ï¼

åœ¨ä¸€ä¸ªéœ€è¦é›†ç¾¤çš„çœŸå®åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šç«‹å³åˆ†å‰å·¥äººã€‚æˆ‘ä»¬å¯èƒ½æƒ³è¦å»ºç«‹æˆ‘ä»¬çš„ web æ¡†æ¶ï¼Œè§£æ CLI å‚æ•°ï¼Œå¹¶éœ€è¦ä¸€äº›åº“å’Œæ–‡ä»¶ã€‚æ‰€æœ‰è¿™äº›æ­¥éª¤éƒ½å¿…é¡»åœ¨**æ¯ä¸ª**å·¥ä½œå™¨ä¸Šé‡å¤ï¼Œè¿™å¯èƒ½ä¼šå¼•å…¥å¤§é‡ä¸å¿…è¦çš„å¼€é”€ã€‚

## [](#final-solution)æœ€ç»ˆè§£å†³

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†`cluster.fork`åˆ°åº•åœ¨åšä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬çš„å·¥äººé€»è¾‘åˆ†å‰²åˆ°ä¸€ä¸ªå•ç‹¬çš„`worker.js`æ–‡ä»¶ä¸­ï¼Œå¹¶å°†`exec`çš„é»˜è®¤å€¼`process.argv[1]`æ›´æ”¹ä¸º`worker.js`:)è¿™å¯ä»¥é€šè¿‡åœ¨ä¸»è¿›ç¨‹ä¸Šè°ƒç”¨ [`cluster.setupMaster()`](https://nodejs.org/api/cluster.html#cluster_cluster_setupmaster_settings) æ¥å®ç°ã€‚