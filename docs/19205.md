# åœ¨ GraphQL æ•™ç¨‹ä¸­ä½¿ç”¨ TypeORM è®¾ç½® PostgreSQL

> åŸæ–‡:[https://dev . to/rx assim/setup-PostgreSQL-with-type ORM-in-graph QL-tutorial-1cn 8](https://dev.to/rxassim/setup-postgresql-with-typeorm-in-graphql-tutorial-1cn8)

æ³¨æ„:è¿™æ˜¯æˆ‘æ—¶äº‹é€šè®¯ä¸­çš„ä¸€ç¯‡äº¤å‰æ–‡ç« ã€‚æ¯å°é‚®ä»¶å‘å‡ºä¸€å‘¨åï¼Œæˆ‘éƒ½ä¼šåœ¨æˆ‘çš„åšå®¢ä¸Šå‘å¸ƒã€‚è®¢é˜…ä»¥åœ¨æ‚¨çš„æ”¶ä»¶ç®±ä¸­è·å¾—æ›´å¤šç±»ä¼¼çš„å†…å®¹ğŸ’Œï¼

å—¨ï¼åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ GraphQL æœåŠ¡å™¨ä¸­ç”¨ TypeORM è®¾ç½® PostgreSQLã€‚è¿™æ˜¯æˆ‘é€šå¸¸ç”¨äºåç«¯é¡¹ç›®çš„åç«¯è®¾ç½®ã€‚

æœ¬æ•™ç¨‹ä¾§é‡äº MacOS ç¯å¢ƒğŸã€‚ç¨åæˆ‘å¯èƒ½ä¼šä¸º Windows å’Œ Linux ç¼–å†™å…¶ä»–æ•™ç¨‹ã€‚

### [](#macos-postgres-setup)MacOS Postgres è®¾ç½®

æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å®¶é…¿ï¼Œè¿™æ˜¯ä¸€ä¸ª MacOS è½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚

è¦å®‰è£… Homebrewï¼Œè¯·åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®‰è£…ç»“æŸåï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… postgresql åŒ…:

```
brew update
brew install postgresql
brew services start postgresql 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸ºäº†ç¡®ä¿æ‰€æœ‰ä¸œè¥¿éƒ½å·²å®‰è£…ï¼Œä¸‹ä¸€ä¸ªå‘½ä»¤åº”è¯¥è¿”å›å·²å®‰è£…çš„ postgresql çš„ç‰ˆæœ¬:

```
postgres --version 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-the-database)åˆ›å»ºæ•°æ®åº“

ç°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…äº† PostgreSQLï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå°†è¦è¿æ¥çš„æ•°æ®åº“ã€‚æˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„æ•°æ®åº“å‘½åä¸º`graphqldb`ã€‚

åœ¨ç»ˆç«¯ä¸­è¿è¡Œä¸‹ä¸€æ¡å‘½ä»¤:

```
createdb graphqldb 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“ã€‚ä¸ºäº†è¿›è¡Œæµ‹è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨ [TablePlus](https://tableplus.io/) (å…è´¹)ã€‚

ä¸ºäº†æµ‹è¯•æ•°æ®åº“æ˜¯å¦å­˜åœ¨ï¼Œåœ¨ TablePlus ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç»™å®ƒä¸€ä¸ªåç§°ï¼Œåœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†å…¶å‘½åä¸º`GraphqlDB`ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªæ•°æ®åº“åç§°ï¼Œå³`graphqldb`(æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„æ•°æ®åº“çš„åç§°)ï¼Œç„¶åå•å‡» testã€‚å¦‚æœæ‰€æœ‰å­—æ®µéƒ½å˜æˆç»¿è‰²ï¼Œé‚£ä¹ˆæ•°æ®åº“å°±åˆ›å»ºå¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¿æ¥å®ƒäº†ã€‚

[![TablePlus](../Images/fd03eca23ee894965fe7f24bf5fc7963.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DRIGqGtz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/17736659/49346097-a5f63d80-f68d-11e8-93ad-ea1cbf42e04e.png)

### [](#setup-the-project-using-typescript)ä½¿ç”¨ Typescript è®¾ç½®é¡¹ç›®

ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ typescript åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–é¡¹ã€‚

é¦–å…ˆè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®æ–‡ä»¶å¤¹:

```
mkdir graphql-proj
cd graphql-proj 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…`typescript`ä½œä¸ºå¼€å‘ä¾èµ–é¡¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª`tsconfig`æ–‡ä»¶:

```
yarn init -y
yarn add typescript nodemon ts-node @types/node -D 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œ`tsconfig.json`å¹¶å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°å…¶ä¸­:

```
{  "compilerOptions":  {  "lib":  ["es5",  "es6",  "esnext",  "dom"],  "target":  "es5",  "module":  "commonjs",  "moduleResolution":  "node",  "outDir":  "./build",  "emitDecoratorMetadata":  true,  "experimentalDecorators":  true,  "sourceMap":  true  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†ä½¿ç”¨`nodemon`ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…æ‰‹åŠ¨é‡å¯æœåŠ¡å™¨æ¥æµ‹è¯•æˆ‘ä»¬çš„æ›´æ”¹ã€‚åˆ›å»ºä¸€ä¸ª`nodemon.json`æ–‡ä»¶ï¼Œå¹¶å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°å…¶ä¸­:

```
{  "watch":  ["src"],  "ext":  "ts",  "exec":  "ts-node ./src/index.ts"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œå°†ä»¥ä¸‹éƒ¨åˆ†æ·»åŠ åˆ°æ‚¨çš„`package.json` :

```
"scripts":  {  "start":  "nodemon"  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-the-graphql-server)åˆ›å»º GraphQL æœåŠ¡å™¨

å¯¹äºæˆ‘ä»¬çš„ GraphQL æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [graphql-yoga](https://github.com/prisma/graphql-yoga) ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ç”¨äºåˆ›å»º graphql æœåŠ¡å™¨çš„ä¸€ä½“åŒ–åŒ…ã€‚

ç°åœ¨ï¼Œæ·»åŠ è¿™ä¸ªåŒ…`graphql-yoga` :

```
yarn add graphql-yoga 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¦å¿«é€Ÿè¿è¡Œ graphql æœåŠ¡å™¨ï¼Œåªéœ€ä» [graphql-yoga](https://github.com/prisma/graphql-yoga) Quickstart éƒ¨åˆ†å¤åˆ¶ç¤ºä¾‹ã€‚

```
import { GraphQLServer } from 'graphql-yoga'

const typeDefs = `
  type Query {
    hello(name: String): String!
  }
`

const resolvers = {
  Query: {
    hello: (_, { name }) => `Hello ${name || 'World'}`,
  },
}

const server = new GraphQLServer({ typeDefs, resolvers })
server.start(() => console.log('Server is running on localhost:4000')) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬å‘ graphql æ¨¡å¼æ·»åŠ ä¸€ä¸ª`User`ç±»å‹ï¼Œä»¥ä¾¿ç¨åæˆ‘ä»¬å¯ä»¥ä»æ•°æ®åº“ä¸­æ·»åŠ /ç¼–è¾‘/åˆ é™¤ç”¨æˆ·:

```
...
const typeDefs = `
  type User {
    id: ID!
    name: String!
    email: String!
  }
  type Query {
    hello(name: String): String!
    user(id: ID!): User!
  }
`
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#setup-typeorm)Setup TypeORM:

åƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£…ä¸€äº›åŒ…:

```
yarn add typeorm reflect-metadata pg
yarn add @types/node -D 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸€æ—¦å®‰è£…å®Œæˆï¼Œå°†è¿™ä¸¤è¡Œæ·»åŠ åˆ°æ‚¨çš„`tsconfig.json` :

```
...  "emitDecoratorMetadata":  true,  "experimentalDecorators":  true,  ... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ›å»ºä¸€ä¸ª`ormconfig.json`æ–‡ä»¶ï¼Œå°†æˆ‘ä»¬çš„æ•°æ®åº“é…ç½®æ”¾å…¥å…¶ä¸­:

```
{  "type":  "postgres",  "host":  "localhost",  "port":  5432,  "database":  "graphqldb",  "synchronize":  true,  "logging":  true,  "entities":  ["src/entities/**/*.ts"]  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æ‚¨åœ¨é…ç½®ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹`entities`å¹¶å°†æˆ‘ä»¬çš„å®ä½“æ”¾å…¥å…¶ä¸­ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„`User.ts`å®ä½“:

```
import { Entity, PrimaryGeneratedColumn, Column, BaseEntity } from 'typeorm'

@Entity()
export class User extends BaseEntity {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  name: string

  @Column()
  email: string
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªå®ä½“ä¸æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ GraphQL `User`ç±»å‹å…·æœ‰ç›¸åŒçš„å±æ€§ã€‚

ç°åœ¨åœ¨`index.ts`ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨æœåŠ¡å™¨ä¹‹å‰åˆ›å»ºæ•°æ®åº“è¿æ¥:

```
...

const server = new GraphQLServer({ typeDefs, resolvers });

createConnection().then(() => {
  server.start(() => console.log("Server is running on localhost:4000"));
}).catch(() => {
  console.log("Couldn't connect to the database.")
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#create-adduser-mutation)åˆ›å»º addUser çªå˜

ä¸ºäº†æµ‹è¯•è®¾ç½®æ˜¯å¦å¦‚æˆ‘ä»¬å¸Œæœ›çš„é‚£æ ·å¥½ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‘æ•°æ®åº“æ·»åŠ ç”¨æˆ·çš„å˜å¼‚ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ›´æ–°æˆ‘ä»¬çš„æ¨¡å¼:

```
...
const typeDefs = `
  type User {
    id: ID!
    name: String!
    email: String!
  }
  type Query {
    hello(name: String): String!
    user(id: ID!): User!
  }
  type Mutation {
    addUser(name: String!, email: String!): User
  }
`;
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬éœ€è¦è§£å†³`addUser`çªå˜å’Œ`user`æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ TypeORM çš„`getRepository`(æˆ‘å°†å†™å¦ä¸€ç¯‡åšæ–‡æ¥è¯¦è¿° TypeORM ):

```
...
const resolvers = {
  Query: {
    hello: (_, { name }) => `Hello ${name || 'World'}`,
    // this is the user resolver
    user: (_, { id }) => {
      return getRepository(User).findOne(id)
    },
  },
  Mutation: {
    // this is the addUser resolver
    addUser: (_, { name, email }) => {
      const user = new User()
      user.email = email
      user.name = name
      return getRepository(User).save(user)
    },
  },
}
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªä½¿ç”¨è¿™ç§å˜å¼‚çš„ç”¨æˆ·ã€‚è½¬åˆ°`http://localhost:4000`å¹¶æ·»åŠ ç”¨æˆ·:

[![Mutation screenshot](../Images/ddb2cc9a3d2e8a613cf86dae626cfbe6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Q6qtEZg8--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/17736659/49346093-9e369900-f68d-11e8-9d96-66d88c9b46af.png)

æ­£å¦‚æ‚¨åœ¨å³è¾¹çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª id ä¸º`1`çš„ç”¨æˆ·ã€‚

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ä»–çš„`Id`æ¥æŸ¥è¯¢æˆ‘ä»¬åˆšåˆšæ·»åŠ çš„ç”¨æˆ·:

[![Mutation screenshot](../Images/854ef91b08ce87e8dca7edd237150cab.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--tPU_Jqqz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/17736659/49346098-a5f63d80-f68d-11e8-8de2-b2c140bbf594.png)

æˆ‘ä»¬èµ¢å›äº†ç”¨æˆ·ğŸ‰ğŸ‰