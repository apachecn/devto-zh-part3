# ä½¿ç”¨ localstack æµ‹è¯•å…·æœ‰ä¾èµ–å…³ç³»çš„å®¹å™¨

> åŸæ–‡:[https://dev . to/sirech/testing-containers-with-dependencies-with-local stack-3f7k](https://dev.to/sirech/testing-containers-with-dependencies-with-localstack-3f7k)

[![Localstack](../Images/c20bd0b420b35d3dc3a6068e56c59351.png "Localstack")T2ã€‘](///static/bd8f606798f32990e9c6c77dcf2c514a/5a46d/localstack.png)

æˆ‘æœ€è¿‘åœ¨ä¸€æ¬¡ä¼šè®®ä¸Šè°ˆåˆ°äº†ä½¿ç”¨ [ServerSpec](https://serverspec.org) çš„å®¹å™¨çš„ [TDDã€‚](https://github.com/sirech/talks/blob/master/2019-01-tw-tdd_containers.pdf)

åœ¨é‚£é‡Œï¼Œæˆ‘å±•ç¤ºäº†ä¸€ä¸ªåŸºäºæˆ‘å½“å‰é¡¹ç›®çš„ä¾‹å­ã€‚æˆ‘ä»¬æœ‰ä¸€äº›å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºä» AWS ç§˜å¯†ç®¡ç†å™¨è·å–ç§˜å¯†ã€‚æµ‹è¯•å¾ˆæ£˜æ‰‹ï¼Œå› ä¸ºå®ƒä¾èµ–äº *ASM* ã€‚å¤šäºäº† [localstack](https://github.com/localstack/localstack) ï¼Œä½ å¯ä»¥é€šè¿‡æ¨¡ä»¿é‚£äº›ä¾èµ–å…³ç³»æ¥ç¼–å†™æœ‰æ„ä¹‰çš„æµ‹è¯•ã€‚å¦‚æœä½ åªæ˜¯æƒ³è¦ä»£ç ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚å¦‚æœä½ èƒ½ç»™æˆ‘å‡ åˆ†é’Ÿæ—¶é—´ï¼Œæˆ‘ä¼šæ›´è¯¦ç»†åœ°çœ‹ä¸€éã€‚

## [](#the-initial-image)åˆå§‹å›¾åƒ

å‡è®¾æ‚¨æœ‰ä¸€ä¸ªæ­£åœ¨æ‰“åŒ…çš„ç°æœ‰ *Node.js* åº”ç”¨ç¨‹åºã€‚éµå¾ª *TDD* æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å¾—åˆ°è¿™æ ·çš„æµ‹è¯•:

```
require_relative 'spec_helper'

describe 'Application Container' do
  describe file('/etc/alpine-release') do
    its(:content) { is_expected.to match(/3.8.2/) }
  end

  describe 'node' do
    describe command('node --version') do
      its(:stdout) { is_expected.to match(/11.6/) }
    end

    describe process('node') do
      it { is_expected.to be_running }
      its(:args) { is_expected.to contain('app.js') }
      its(:user) { is_expected.to eq('runner') }
    end

    describe 'listens to correct port' do
      it { wait_for(port(3000)).to be_listening.with('tcp') }
    end
  end

  describe file('app.js') do
    it { is_expected.to be_file }
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é€šè¿‡ä¸‹é¢çš„`Dockerfile` :
æ¥å®ç°

```
FROM node:11.6-alpine

WORKDIR /app

# hadolint ignore=DL3018,DL3013
RUN apk update --no-cache && \
  apk add --no-cache bash jq && \
  rm -rf /var/cache/apk/*

COPY package.json .
RUN yarn

COPY app.js .

RUN adduser -D runner

USER runner
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
CMD ["node", "app.js"] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬æœ‰é¢å¤–çš„è¦æ±‚å‘¢ï¼Ÿæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†åˆ©ç”¨ä¸€äº›ç§˜å¯†ã€‚å³:

*   å°†æœ‰ä¸€ä¸ªåä¸º`SECRET`çš„å€¼ä¸º`localstack_secret`çš„ç§˜å¯†
*   æˆ‘ä»¬çš„`GET /secret`è·¯ç”±å°†è¾“å‡º`The super secret value is ${SECRET}`(è¿™ä¸ª app æœ‰ç‚¹å¤ªä¿¡ä»»å®ƒçš„è°ƒç”¨è€…äº†ï¼)

è¿™æ”¹å˜äº†ä¸€åˆ‡ï¼æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦ä¸€äº›ä¾èµ–ï¼Œè¿™ä¹Ÿä¼šå½±å“æµ‹è¯•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆåšã€‚

## [](#injecting-secrets-into-the-container)å°†ç§˜å¯†æ³¨å…¥å®¹å™¨

æˆ‘ä»¬å°†åœ¨è¿è¡Œæ—¶æ³¨å…¥ç§˜å¯†ã€‚ä½ å¯ä»¥åœ¨[è®¸å¤šå…¶ä»–æ–‡ç« ](https://medium.com/@mccode/dont-embed-configuration-or-secrets-in-docker-images-7b2e0f916fdd)ä¸­æ‰¾åˆ°åœ¨æ„å»ºæ—¶ç¼–å†™å®ƒä»¬çš„é™·é˜±ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ğŸ‘‹é‚£ä¸ªã€‚

ç¬¬äºŒä¸ªè¦æ±‚æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›è®©ç§˜å¯†å¤„ç†å¯¹æˆ‘ä»¬ç°æœ‰çš„åº”ç”¨ç¨‹åºé€æ˜ã€‚è¯¥åº”ç”¨ç¨‹åºå°†è·å¾—ä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥çš„ç§˜å¯†ã€‚æˆ‘ä»¬å°†é€šè¿‡å‘æˆ‘ä»¬çš„å›¾åƒæ·»åŠ ä¸€ä¸ª`ENTRYPOINT`æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒè´Ÿè´£è·å–ç§˜å¯†ã€‚

æˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„ç§˜å¯†å‚¨å­˜åœ¨ *ASM* ä¸­ã€‚è¿™æ˜¯å»ºç­‘çš„æ ·å­:

[![Architecture](../Images/9ec9c4e544a805d015f2f15ab69d44a1.png "Architecture")T2ã€‘](///static/27b33952d390a2795b796b39321bde6a/0ad97/arch.png)

### [](#extending-the-app)æ‰©å±• app

å‡è®¾æˆ‘ä»¬å®Œå…¨ç¬¦åˆ TDDï¼Œè®©æˆ‘ä»¬å®šä¹‰è¯æ˜æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæˆåŠŸè¿”å›ç§˜å¯†çš„æµ‹è¯•:

```
describe 'fetches a secret from ASM' do
  it { wait_for(secret).to match(/localstack_secret/) }
end

private

def secret
  command('curl localhost:3000/secret').stdout
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯è·¯çº¿åœ¨ app ä¸­çš„å®ç°æ–¹å¼:

```
app.get('/secret', (req, res) => res.send(`The super secret value is ${process.env.SECRET}`)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªæµ‹è¯•å°†ä¼šå¤±è´¥ï¼Œå› ä¸ºæˆ‘ä»¬å®é™…ä¸Šæ²¡æœ‰å‘åº”ç”¨ç¨‹åºæä¾›ç§˜å¯†ã€‚ä½†æ˜¯æˆ‘ä»¬ä¼šçš„ï¼

### [](#providing-the-secret)æä¾›ç§˜å¯†

æ­£å¦‚æˆ‘æ‰€è¯´çš„ï¼Œè¿™é‡Œä¼šæœ‰ä¸€ä¸ªå…¥å£ç‚¹ã€‚æˆ‘ä»¬ä»æµ‹è¯•å¼€å§‹:

```
describe file('/usr/sbin/entrypoint.sh') do
  it { is_expected.to be_file }
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*å…¥å£ç‚¹*æœ¬èº«å°†ä½¿ç”¨ [awscli](https://aws.amazon.com/cli/) æ¥è·å–ç§˜å¯†ã€‚çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```
#!/usr/bin/env bash

set -e

secret=$(aws --endpoint-url=http://localstack:4584 --region "${AWS_REGION}" secretsmanager get-secret-value --secret-id "${SECRET_KEY}" | jq -r .SecretString)
export SECRET="$secret"

exec "$@" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„ï¼Œå¯¹äºç”Ÿäº§æ˜ åƒï¼Œä½¿ç”¨ç±»ä¼¼äº [pstore](https://github.com/glassechidna/pstore) çš„ä¸œè¥¿å¯èƒ½ä¼šæ›´å¥½ã€‚

ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„`Dockerfile`ä½æ¥æ•´åˆå®ƒã€‚æœ‰äº›äº‹æƒ…è¦åšã€‚æˆ‘ä»¬éœ€è¦æ·»åŠ `awscli`ä½œä¸ºä¾èµ–é¡¹ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ æˆ‘ä»¬çš„*å…¥å£ç‚¹*ï¼Œå¹¶ç¡®ä¿å®ƒè¿è¡Œ:

```
# hadolint ignore=DL3018,DL3013
RUN apk update --no-cache && \
  apk add --no-cache bash jq python py-pip curl && \
  pip --no-cache-dir install --upgrade pip awscli && \
  apk -v --purge del py-pip && \
  rm -rf /var/cache/apk/*

COPY entrypoint.sh /usr/sbin/entrypoint.sh

ENTRYPOINT ["/usr/sbin/entrypoint.sh"] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥ä¸€åˆ‡éƒ½è¦å‡†å¤‡å¥½ï¼ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œæµ‹è¯•ï¼Œå¹¶çœ‹åˆ°â€¦ä»–ä»¬éƒ½å¤±è´¥äº†ã€‚åŒ…æ‹¬ä»¥å‰å®Œå…¨æ˜¯ç»¿è‰²çš„æ—§çš„ã€‚

## [](#introducing-dependencies)å¼•å…¥ä¾èµ–å…³ç³»

æˆ‘ä»¬çš„å®¹å™¨ä¸å†å·¥ä½œï¼Œå› ä¸ºå®ƒè¯•å›¾åœ¨è¿è¡Œæ—¶è®¿é—® *ASM* å¹¶å¤±è´¥ã€‚å¯æ€•çš„ä¾èµ–å†æ¬¡ç ´åäº†æˆ‘ä»¬çš„æµ‹è¯•ã€‚åƒç™»å½• *AWS* å¹¶è·å–çœŸæ­£çš„ç§˜å¯†è¿™æ ·çš„è§£å†³æ–¹æ¡ˆæ„Ÿè§‰å¹¶ä¸ä»¤äººæ»¡æ„ã€‚è¿˜èƒ½åšä»€ä¹ˆï¼Ÿ

è¾“å…¥*æœ¬åœ°å †æ ˆ*ã€‚

å¤šäºäº†è¿™ä¸ª[ä»¤äººæ•¬ç•çš„é¡¹ç›®](https://www.thoughtworks.com/radar/tools/localstack),æˆ‘ä»¬å¯ä»¥æ¨¡ä»¿ *AWS* ä¾èµ–ï¼Œå¹¶ä¿æŒæˆ‘ä»¬çš„æµ‹è¯•(å‡ ä¹)é€æ˜åœ°è¿è¡Œã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åè°ƒæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œä»¥ä¾¿:

*   *localstack* å¯åŠ¨å¹¶åœ¨ 4584 ç«¯å£æä¾›ä¸€ä¸ª *ASM* çš„å‰¯æœ¬
*   æ‰§è¡Œä¸€ä¸ª init å®¹å™¨ï¼Œå°†ä¸€ä¸ªç§˜å¯†æ³¨å…¥åˆ° *ASM* ä¸­
*   æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å°† *localstack* ä½œä¸ºä¸€ä¸ªä¾èµ–é¡¹ï¼Œå› æ­¤è·å–æœºå¯†æ˜¯å¯è¡Œçš„

æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ [Docker Compose](https://docs.docker.com/compose/) æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å®Œæ•´çš„åŒ…æ‹¬ä¸‰ä¸ªå…ƒç´ ï¼Œä¼˜é›…åœ°é…åˆåœ¨ä¸€èµ·:

```
version: '3'
services:
  localstack:
    container_name: localstack
    image: localstack/localstack

    ports:
      - "4584:4584"

    environment:
      - DEFAULT_REGION=eu-central-1
      - SERVICES=secretsmanager

  init:
    container_name: init
    build: ./init

    env_file: .env

    depends_on:
      - localstack

    links:
      - localstack

  app:
    container_name: app
    build: ./app

    ports:
      - "3000:3000"

    env_file: .env

    depends_on:
      - init

    links:
      - localstack 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`init`å®¹å™¨åªæ˜¯ ruby alpine æ‰§è¡Œè¿™ä¸ªè„šæœ¬:

```
asm = Aws::SecretsManager::Client.new(region: ENV['AWS_REGION'], endpoint: 'http://localstack:4584')
asm.create_secret(name: ENV['SECRET_KEY'], secret_string: 'localstack_secret') 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»ä¸€å¼€å§‹çš„*å…¥å£ç‚¹*å°±éœ€è¦è€ƒè™‘ urlï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒæ”¹ä¸º`aws --endpoint-url=http://localstack:4584`ã€‚å¯¹äºå®Œæ•´çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç¯å¢ƒé€‰æ‹© URLã€‚

è¿™æ ·æˆ‘ä»¬å°±å·®ä¸å¤šå®Œæˆäº†ã€‚æˆ‘ä»¬åªéœ€è¦å‘Šè¯‰`ServerSpec`ä½¿ç”¨`docker-compose`æ¥å¯åŠ¨æˆ‘ä»¬çš„å®¹å™¨è®¾ç½®ï¼Œè¿™å¯ä»¥åœ¨`rails_helper.rb` :
ä¸­å®Œæˆ

```
require 'serverspec'
require 'docker'
require 'docker/compose'
require 'rspec/wait'

set :backend, :docker
set :docker_container, 'app'

RSpec.configure do |config|
  config.wait_timeout = 15 # seconds

  compose = Docker::Compose.new

  config.before(:all) do
    compose.up(detached: true, build: true)
  end

  config.after(:all) do
    compose.kill
    compose.rm(force: true)
  end
end 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·ï¼ç°åœ¨æˆ‘ä»¬çš„æµ‹è¯•è¿è¡Œå¾—éå¸¸å¥½ã€‚æˆ‘ä»¬æœ‰ä¸ç§˜å¯†å­˜å‚¨äº¤äº’çš„å®¹å™¨ï¼Œå®ƒæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æµ‹è¯•å¥—ä»¶æ¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸è¿è¡Œã€‚å®ƒæ²¡æœ‰å¾—åˆ°æ›´å¤šçš„æ—¶é—´ã€‚

## [](#whats-next)æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

æœ‰ä½†æ˜¯(ä¸æ˜¯ä¸€ç›´éƒ½æœ‰å—ï¼Ÿ).åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œ *localstack* åœ¨å®ƒçš„å®ç°ä¸­åªèƒ½å­˜å‚¨ä¸€ä¸ªç§˜å¯†ï¼Œæ‰€ä»¥å¦‚æœä½ çš„å®¹å™¨ä¾èµ–äºè·å–å¤šä¸ªç§˜å¯†ï¼Œå®ƒå°†ä¸èƒ½æ‰¾åˆ°æ‰€æœ‰çš„ç§˜å¯†ã€‚è¿™æ˜¯æœ€è¿‘åœ¨ [moto](https://github.com/spulec/moto/pull/1898) ä¸­ä¿®è¡¥çš„ï¼Œä¸‹é¢çš„åº“ï¼Œå®ƒåªæ˜¯åœ¨ç­‰å¾… *localstack* çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ã€‚åœ¨é‚£ä¹‹åï¼Œä»»ä½•ç§˜å¯†éƒ½ä¸ä¼šå…äºè¢«å˜²ç¬‘ã€‚