# åœ¨ Ruby ä¸­ä½¿ç”¨â€œHash#fetchâ€æ¥è·å¾—æ›´å¥½çš„ nil å¤„ç†

> åŸæ–‡:[https://dev . to/raquelxmoss/using-hash fetch-in-ruby-for-better-nil-handling-2l8h](https://dev.to/raquelxmoss/using-hashfetch-in-ruby-for-better-nil-handling-2l8h)

# [](#using-raw-hashfetch-endraw-in-ruby-for-better-nil-handling)åœ¨ Ruby ä¸­ä½¿ç”¨`Hash#fetch`å®ç°æ›´å¥½çš„é›¶å¤„ç†

åœ¨ Ruby ä¸­ï¼Œç”¨`[]`æ–¹æ³•ä»æ•£åˆ—ä¸­æå–å€¼å¾ˆç®€å•ï¼Œä½†æ˜¯å½“æ‚¨è¦æŸ¥æ‰¾çš„å€¼ä¸åœ¨é‚£é‡Œæ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚è¿™å¯èƒ½å¯¼è‡´ç¹ççš„é›¶æ£€æŸ¥ï¼Œæˆ–è€…æˆ‘ä»¬æœ€å–œæ¬¢çš„é”™è¯¯`Undefined method for nil:NilClass`ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªåˆ†ç±»å¹¿å‘Šç½‘ç«™çš„ä¾‹å­ï¼Œå®ƒåœ¨å‘ç”¨æˆ·æ˜¾ç¤ºåˆ—è¡¨æ—¶å¯¹åˆ—è¡¨è¿›è¡Œæ’åºï¼Œä»¥åŠæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Hash#fetch`åœ¨è¿™äº› nil å‘ç”Ÿä¹‹å‰ä¸»åŠ¨å¤„ç†å®ƒä»¬çš„ä¸€äº›æ–¹æ³•ã€‚

åªæ˜¯å¯¹ä»£ç åšä¸€ä¸ªç®€å•çš„è¯´æ˜â€”â€”è¿™äº›ä¾‹å­æ˜¯é€‚åº¦è®¾è®¡çš„ï¼Œä¸ä¸€å®šæ˜¯ä½ åœ¨ç”Ÿäº§ä¸­å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå˜¿ï¼Œè‡³å°‘å®ƒä»¬é˜æ˜äº†æˆ‘çš„è§‚ç‚¹ï¼

## [](#using-hashfetch-to-set-a-default)ä½¿ç”¨ Hash#fetch è®¾ç½®é»˜è®¤å€¼

```
def index
  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders[listings_params[:sort]]

  @listings = Listing.order(price: sort_order)
end 
```

è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé—®é¢˜â€”â€”å¦‚æœç”¨æˆ·æ²¡æœ‰æä¾›`sort`å‚æ•°ï¼Œæˆ–è€…ä»–ä»¬æä¾›äº†ä¸€äº›æ— æ•ˆçš„ä¸œè¥¿ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæœ‰è®¸å¤šæ–¹æ³•å¯ä»¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`||`æ“ä½œç¬¦è®¾ç½®é»˜è®¤å€¼ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ¨¡å¼ï¼Œä¹Ÿæ˜¯å¤„ç†è¿™ç§æƒ…å†µçš„å®Œç¾æ–¹å¼ã€‚

```
def index
  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders[listings_params[:sort]] || :asc

  @listings = Listing.order(price: sort_order)
end 
```

å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘æ›´å–œæ¬¢ä½¿ç”¨`Hash#fetch`æ–¹æ³•æ¥è·å¾—ç¨å¾®æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚ä½¿ç”¨`Hash#fetch`ï¼Œå¦‚æœåœ¨ hash ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªé”®ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªç¼ºçœçš„é”®æ¥æŸ¥æ‰¾ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç† nil æƒ…å†µçš„æ–¹æ³•ã€‚

```
def index
  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort], :asc)

  @listings = Listing.order(price: sort_order)
end 
```

å°½ç®¡è¯­ä¹‰æœ¬èº«å¹¶ä¸æ˜¯ä½¿ç”¨è¿™ç§æ¨¡å¼çš„ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹ä¸€äº›æ›´æœ‰è¶£çš„ä¾‹å­ï¼Œåœ¨è¿™äº›ä¾‹å­ä¸­`Hash#fetch`å¯ä»¥ç”¨æ¥ä¸»åŠ¨å¤„ç† nilsã€‚

## [](#using-raw-hashfetch-endraw-to-set-a-falsey-value)ä½¿ç”¨`Hash#fetch`è®¾ç½®ä¸€ä¸ªå‡å€¼

å½“æ‚¨å¸Œæœ›æ¥å—æ¥è‡ªè°ƒç”¨è€…çš„å‡å€¼ï¼Œä½†é»˜è®¤ä¸ºçœŸå€¼æ—¶ï¼Œè¿™ç§æ¨¡å¼å¾ˆæœ‰ç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚

è¿™é‡Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿç”¨å‚æ•°æ§åˆ¶æ˜¯å¦åœ¨å“åº”ä¸­åŒ…å«å–å®¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º`true`ã€‚å¾ˆå®¹æ˜“ä¸å°å¿ƒåšäº†è¿™æ ·çš„äº‹æƒ…:

```
def index
  @include_seller_details = listings_params[:include_metadata] || true

  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort], :asc)

  @listings = Listing.order(price: sort_order)
end 
```

è¿™å°†æ— æ³•æ­£å¸¸å·¥ä½œï¼å› ä¸ºå¦‚æœ`listing_params[:include_metadata]`æ˜¯ä¸€ä¸ª falsey å€¼ï¼Œé‚£ä¹ˆæ— è®ºå¦‚ä½•å®ƒéƒ½ä¼šè®¡ç®—ä¸º`true`ã€‚è¿™å¯èƒ½ä¸æ˜¯ç¾éš¾æ€§çš„ï¼Œä½†è¿™æ„å‘³ç€æˆ‘ä»¬å°†åœ¨å“åº”ä¸­å‘é€æ¯”æˆ‘ä»¬æƒ³è¦çš„æ›´å¤šçš„ä¿¡æ¯ï¼Œè¿™å¾€å¥½é‡Œè¯´æ˜¯ä¸ç¤¼è²Œçš„ï¼Œå¾€åé‡Œè¯´å¯èƒ½æ˜¯å®‰å…¨é—®é¢˜ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`Hash#fetch`

```
def index
  @include_seller_details = listing_params.fetch(:include_metadata, true)

  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort], :asc)

  @listings = Listing.order(price: sort_order)
end 
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœåœ¨`:include_metadata`æœ‰ä»»ä½•å€¼ï¼ŒåŒ…æ‹¬ä¸€ä¸ª falsey å€¼ï¼Œå®ƒå°†è¢«è®¾ç½®ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚

## [](#run-a-block-of-code-if-you-dont-find-what-youre-looking-for)å¦‚æœæ²¡æœ‰æ‰¾åˆ°æƒ³è¦çš„ä¸œè¥¿ï¼Œè¿è¡Œä¸€æ®µä»£ç 

å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå¦‚æœæ‚¨åœ¨ hash ä¸­æ²¡æœ‰æ‰¾åˆ°æ‚¨æƒ³è¦çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ªé»˜è®¤å€¼æ˜¯å¾ˆå¥½çš„ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ç®€å•çš„å€¼ä¸è¡Œï¼Œæ‚¨å¯èƒ½éœ€è¦è¿è¡Œä¸€æ®µä»£ç ä½œä¸ºåå¤‡ã€‚æ¥å—ä¸€ä¸ªå—æ¥å¸®åŠ©ä½ å®ç°è¿™ä¸€ç‚¹ï¼Œè¿™æ˜¯ç›¸å½“æ¼‚äº®çš„ï¼

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœç”¨æˆ·å‘ API å‘é€ä¸€ä¸ªæ— æ•ˆçš„æ’åºé¡ºåºï¼Œæˆ‘ä»¬å°†åœ¨åˆ†ææœåŠ¡ä¸­è®°å½•ä¸‹æ¥ã€‚è¿™å°†å¸®åŠ©æˆ‘ä»¬å†³å®šä¸‹ä¸€æ­¥æ˜¯å¦è¦ä¸ºæˆ‘ä»¬çš„ç”¨æˆ·æ„å»ºè¿™ä¸ªç‰¹æ€§ã€‚å¦‚æœå¾ˆå¤šç”¨æˆ·è¯·æ±‚åœ¨`popular`æˆ–`new`å‰è®¢è´­åˆ—è¡¨ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸€ç‚¹ä¼šå¾ˆæ–¹ä¾¿ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æŠ¥å‘Šè¯¥å€¼ï¼Œç„¶åè¿”å›é»˜è®¤å€¼ã€‚

```
def index
  @include_seller_details = listing_params.fetch(:include_metadata, true)

  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort]) do |value|
    Analytics.report("user requested to sort listings by #{value}")
    :asc
  end

  @listings = Listing.order(price: sort_order)
end 
```

## [](#safer-handling-of-environment-variables-with-raw-hashfetch-endraw-)ç”¨`Hash#fetch`æ›´å®‰å…¨çš„å¤„ç†ç¯å¢ƒå˜é‡

å¯¹ç¯å¢ƒå˜é‡å¤„ç†ä¸å½“ä¼šå¯¼è‡´ä¸€äº›ç¾éš¾æ€§çš„ç»“æœ(â€¦é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„)ã€‚è¢«å’¬äº†ä¸æ­¢ä¸€æ¬¡ï¼Œæ£€ç´¢ç¯å¢ƒå˜é‡çš„æ—¶å€™å–œæ¬¢ç”¨`Hash#fetch`ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥çªå‡ºæ ‡å¿—å‘å¸ƒï¼Œæˆ–è€…æ·»åŠ /åˆ é™¤ç¯å¢ƒå˜é‡æ˜¯ä¸æ‚¨çš„æ­£å¸¸ä»£ç éƒ¨ç½²è¿‡ç¨‹åˆ†å¼€å¤„ç†çš„äº‹æƒ…ï¼Œè¿™ä¸€ç‚¹å°¤å…¶é‡è¦ã€‚

ä»£ç æœŸæœ›ä¸€ä¸ªç¯å¢ƒå˜é‡+ä¸€ä¸ªæ— å£°çš„å¤±è´¥ï¼Œå¦‚æœå®ƒä¸åœ¨é‚£é‡Œ+ä¸èƒ½æ­£ç¡®åœ°è®¾ç½®ä¸€ä¸ªç¯å¢ƒå˜é‡=æ½œåœ¨çš„éå¸¸æ˜‚è´µçš„é”™è¯¯

ğŸ™ƒ

```
def index
  seasonal_discount = ENV["SEASONAL_DISCOUNT"]

  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort], :asc)

  @listings = Listing.order(price: sort_order)

  if seasonal_discount
    @listings = @listings.map(&:apply_seasonal_discount)
  end
end 
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰äººæœªèƒ½è®¾ç½®`SEASONAL_DISCOUNT`ç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ä¼šæŠ›å‡ºé”™è¯¯ã€‚æˆ‘ä»¬çš„é¡¾å®¢ä¼šé”™è¿‡ä¸€ç¬”å¥½äº¤æ˜“ï¼

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Hash#fetch`,è¿™æ ·å½“æ‰¾ä¸åˆ° env å˜é‡æ—¶ï¼Œè¿™ä¸ªæ“ä½œå°±ä¼šå¤±è´¥ã€‚

```
def index
  seasonal_discount = ENV.fetch("SEASONAL_DISCOUNT")

  valid_sort_orders = {
    lowest_price: :asc,
    highest_price: :desc
  }

  sort_order = valid_sort_orders.fetch(listings_params[:sort], :asc)

  @listings = Listing.order(price: sort_order)

  if seasonal_discount
    @listings = @listings.map(&:apply_seasonal_discount)
  end
end 
```

å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒå˜é‡ï¼Œè¿™å°†ä¼šå¾ˆéº»çƒ¦åœ°å¤±è´¥ï¼Œæ‚¨çš„ä»£ç ç”šè‡³å¯èƒ½æ— æ³•æ­£ç¡®éƒ¨ç½²ã€‚å¦‚æœè¿™æ ·åšæ›´æœ‰æ„ä¹‰çš„è¯ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©è®¾ç½®é»˜è®¤å€¼ï¼Œä½†æ˜¯åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæœ‰å™ªå£°çš„å¤±è´¥æ›´å¥½ã€‚

### [](#those-are-some-of-my-favourite-uses-for-raw-hashfetch-endraw-its-a-really-useful-tool-for-any-rubyist-and-i-think-its-good-to-remember-that-raw-endraw-is-not-the-only-way-to-retrieve-values-from-a-hash)è¿™äº›æ˜¯æˆ‘æœ€å–œæ¬¢çš„`Hash#fetch`ç”¨æ³•ã€‚å¯¹äºä»»ä½• ruby çˆ±å¥½è€…æ¥è¯´ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œæˆ‘è®¤ä¸ºè®°ä½`[]`ä¸æ˜¯ä» Hash ä¸­è·å–å€¼çš„å”¯ä¸€æ–¹æ³•æ˜¯æœ‰å¥½å¤„çš„ã€‚