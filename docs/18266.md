# ä½¿ç”¨ pytest-mock å’Œ pytest-flask è¿›è¡Œæµ‹è¯•

> åŸæ–‡:[https://dev . to/ghost/testing-with-pytest-mock-and-pytest-flask-1i7g](https://dev.to/ghost/testing-with-pytest-mock-and-pytest-flask-1i7g)

Pytest æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„æµè¡Œ Python åº“ã€‚å®ƒæ˜¯æˆ‘é¦–é€‰çš„æµ‹è¯•åº“ï¼Œå› ä¸ºå®ƒæ¯”è¯¸å¦‚å†…ç½®æµ‹è¯•åº“ unittest ä¹‹ç±»çš„æ›¿ä»£åº“éœ€è¦æ›´å°‘çš„æ ·æ¿ä»£ç ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ pytest-flask å’Œ pytest-mock æ¥æµ‹è¯•æ‚¨çš„ flask åº”ç”¨ç¨‹åºã€‚è¿™ä¸¤ä¸ªåº“æ˜¯ Pytest çš„æ’ä»¶ï¼Œæ„å»ºåœ¨ Pytest æä¾›ç»™æˆ‘ä»¬çš„ä¸€äº›ç‰¹æ€§ä¹‹ä¸Šã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æµ‹è¯•ä¸€ä¸ªéå¸¸ç®€å•çš„ Flask åº”ç”¨ç¨‹åºï¼Œæˆ‘åœ¨è¿™é‡Œåˆ›å»ºäº†[æºä»£ç ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº Flask åº”ç”¨çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æˆ‘ä»¥å‰çš„æ–‡ç« ](https://github.com/hmajid2301/medium/tree/master/9.%20Testing%20with%20pytest-mock%20and%20pytest-flask)[ğŸ”Œ ğŸ”Œã€‚å¯¹äºæœ¬æ–‡ï¼Œæ‚¨çœŸæ­£éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå®ƒæ¶‰åŠåˆ°ä¸ºä¸€ä¸ªå‡æƒ³çš„çŒ«å•†åº—ä½¿ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„ RESTful APIã€‚åŸºæœ¬ä¸Šï¼ŒAPI æ‰€åšçš„å°±æ˜¯ä¸æ•°æ®åº“äº¤äº’ï¼Œä»¥è·å–å½“å‰çš„çŒ«ï¼Œæ·»åŠ æ–°çš„çŒ«ï¼Œç¼–è¾‘ç°æœ‰çš„çŒ«ï¼Œå¹¶ä»å•†åº—ä¸­åˆ é™¤çŒ«ã€‚](https://dev.to/hmajid2301/implementing-sqlalchemy-with-docker-18c9)

#### [](#prerequisites)å…ˆå†³æ¡ä»¶

*   ä½ è‡ªå·±çš„çƒ§ç“¶åº”ç”¨
*   ä½¿ç”¨ pip install -r requirements.txt(æˆ– pip3 è€Œä¸æ˜¯ pip)å®‰è£…ä»¥ä¸‹ä¾èµ–é¡¹

å…¶ä¸­ requirements.txt ä¸º:

```
flask==1.0.2
pytest-flask==0.10.0
pytest-mock==1.10.0 
```

#### [](#libraries)åº“

*pytest-flask* å…è®¸æˆ‘ä»¬æŒ‡å®šä¸€ä¸ª app fixtureï¼Œç„¶åç”¨è¿™ä¸ª app å‘é€ API è¯·æ±‚ã€‚å½“å‘æˆ‘ä»¬çš„ flask åº”ç”¨ç¨‹åºå‘é€ HTTP è¯·æ±‚æ—¶ï¼Œç”¨æ³•ç±»ä¼¼äºè¯·æ±‚åº“ã€‚

pytest-mock æ˜¯ä¸€ä¸ªå›´ç»• unittest mock åº“çš„ç®€å•åŒ…è£…å™¨ï¼Œæ‰€ä»¥ä½¿ç”¨ unittest.mock å¯ä»¥åšä»»ä½•äº‹æƒ…ã€‚ç”¨æ³•ä¸Šçš„ä¸»è¦åŒºåˆ«æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨ fixture mocker æ¥è®¿é—®å®ƒï¼Œè€Œä¸” mock åœ¨æµ‹è¯•ç»“æŸæ—¶ç»“æŸã€‚è€Œå¯¹äºæ™®é€šçš„æ¨¡æ‹Ÿåº“ï¼Œå¦‚æœä½ æ¨¡æ‹Ÿ open()å‡½æ•°ï¼Œå®ƒå°†åœ¨æµ‹è¯•æ¨¡å—çš„å‰©ä½™æ—¶é—´å†…è¢«æ¨¡æ‹Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå°†å½±å“å…¶ä»–æµ‹è¯•ã€‚

#### [](#pytestflask-example)pytest-flask ç¤ºä¾‹

```
import pytest

from example_app import create_app

@pytest.fixture
def app():
 app = create_app()
 return app

def test_example(client):
 response = client.get("/")
 assert response.status_code == 200 
```

è¦ä½¿ç”¨ pytest-flaskï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåä¸º app()çš„è®¾å¤‡ï¼Œå®ƒåˆ›å»ºäº†æˆ‘ä»¬çš„ flask æœåŠ¡å™¨ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°† client ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä»»ä½•æµ‹è¯•æ¥ä½¿ç”¨è¿™ä¸ª fixtureã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯å‘é€å„ç§ http è¯·æ±‚ã€‚

ä¸Šé¢æ˜¯ä¸€ä¸ªä½¿ç”¨ pytest-flask çš„éå¸¸ç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬å‘æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‘é€ GET è¯·æ±‚ï¼Œå®ƒåº”è¯¥è¿”å›æ•°æ®åº“ä¸­çš„æ‰€æœ‰çŒ«ã€‚ç„¶åæˆ‘ä»¬æ£€æŸ¥ä»æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ä»£ç æ˜¯ 200 (OK)ã€‚è¿™å¾ˆå¥½ï¼Œé™¤äº†æˆ‘ä»¬å¦‚ä½•åœ¨ä»£ç ä¸­æ¨¡æ‹Ÿå‡ºæŸäº›ç‰¹æ€§ï¼Ÿ

#### [](#pytestmock)pytest-mock

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pytest-mock åº“æ¨¡æ‹Ÿå‡ºæˆ‘ä»¬ä»£ç çš„æŸäº›éƒ¨åˆ†ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»åœ¨ app() fixture å†…éƒ¨è¿›è¡Œæ¨¡æ‹Ÿã€‚å› ä¸ºæˆ‘ä»¬å‰©ä¸‹çš„æµ‹è¯•åªæ˜¯å‘æˆ‘ä»¬çš„ Flask æœåŠ¡å™¨å‘å‡º HTTP è¯·æ±‚ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡è®¾æˆ‘ä»¬ä¸æƒ³æ¨¡æ‹Ÿåˆ°æ•°æ®åº“çš„è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢å‡ è¡Œä»£ç ã€‚

```
mocker.patch("flask_sqlalchemy.SQLAlchemy.init_app", return_value=True)
mocker.patch("flask_sqlalchemy.SQLAlchemy.create_all", return_value=True)
mocker.patch("example.database.get_all", return_value={}) 
```

è¿™æ®µä»£ç æ‰€åšçš„æ˜¯ï¼Œæ¯å½“ä»»ä½•è¢«æ¨¡æ‹Ÿçš„å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œæ¯”å¦‚è¯´ init_appï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿå®ƒï¼Œæ‰€ä»¥å®ƒæ€»æ˜¯è¿”å› trueã€‚æˆ‘ä»¬å¿…é¡»ç»™å®ƒå‡½æ•°çš„â€œå®Œæ•´è·¯å¾„â€,å°±å¥½åƒä½ å¿…é¡»å¯¼å…¥å‡½æ•°æœ¬èº«ä¸€æ ·ã€‚

#### [T1ã€‘test _ example . py](#testexamplepy)

<figure>[![](../Images/a8dac21baccf3da9d7d7e702ccff1721.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--GjLZ1N1---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/855/1%2ActgQ4bI4VKqqom6wq6NiAg.png)

<figcaption>test _ example . py</figcaption>

T6ã€‘</figure>

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒéå¸¸æ— èŠï¼Œå› ä¸ºå½“æˆ‘ä»¬å‘åº”ç”¨ç¨‹åºå‘é€ HTTP GET è¯·æ±‚æ—¶ï¼Œå®ƒä¸ä¼šä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ¨¡æ‹Ÿå‡ºæ¥äº†ï¼Œè€Œåªæ˜¯è¿”å›ä¸€ä¸ªç©ºçš„ dict ({})ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æµ‹è¯•ï¼Œä½ å¯ä»¥è®©å®ƒå˜å¾—æ›´æœ‰è¶£ä¸€ç‚¹ã€‚

#### [](#appendix)é™„å½•

*   [ç¤ºä¾‹æºä»£ç ](https://github.com/hmajid2301/medium/tree/master/9.%20Testing%20with%20pytest-mock%20and%20pytest-flask)
*   [ç”¨ç¢³åˆ¶ä½œçš„ä»£ç å›¾åƒ](https://carbon.now.sh)