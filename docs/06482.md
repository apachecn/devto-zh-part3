# æ„å»ºæ”¯æŒç”¨æˆ·ä¸Šä¼ çš„ Phoenix åº”ç”¨ç¨‹åºçš„åˆ†æ­¥æ•™ç¨‹

> åŸæ–‡:[https://dev . to/alvisesus/step-by-step-by-step-tutorial-to-build-a-phoenix-app-that-supports-user-uploads-345 p](https://dev.to/alvisesus/step-by-step-tutorial-to-build-a-phoenix-app-that-supports-user-uploads-345p)

æœ‰å…´è¶£äº†è§£ Elixirã€Phoenix å’Œè½¯ä»¶æ¶æ„å—ï¼Ÿ[è®¢é˜…æˆ‘çš„æ—¶äº‹é€šè®¯ï¼Œäº†è§£ä¸€èˆ¬æ€è€ƒå’Œæ¯å‘¨æ·±å…¥çš„æ–¹æ³•](https://www.poeticoding.com/subscribe-to-newsletter/)ã€‚

æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥è®©ç”¨æˆ·å°†ä»–ä»¬çš„æ–‡ä»¶ä¸Šä¼ åˆ°æˆ‘ä»¬çš„ Phoenix åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ä¸ºæˆ‘ä»¬ç®¡ç†ä¸Šä¼ çš„å¯é åº“ï¼Œå°†æ–‡ä»¶å®‰å…¨åœ°ä¿å­˜åœ¨äº‘å­˜å‚¨ä¸­ã€‚

ç„¶è€Œï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºåŸºç¡€â€”â€”æˆ‘ä»¬å°†åªä½¿ç”¨ Phoenix é™„å¸¦çš„å·¥å…·ï¼Œè€Œä¸æ˜¯ç¬¬ä¸‰æ–¹åº“ã€‚

æˆ‘ä»¬å°†ä»å¤´å¼€å§‹åˆ›å»ºä¸€ä¸ªå…¨åŠŸèƒ½çš„ Phoenix åº”ç”¨ç¨‹åºï¼Œè¿è¡Œå¹¶é…ç½®æˆ‘ä»¬çš„ Postgres æ•°æ®åº“å’Œ Ecto æ¨¡å¼ï¼Œä½¿ç”¨ Plug å¤„ç†ä¸Šä¼ ï¼Œå¹¶å°†æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ã€‚

å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸‹è½½æ–‡ä»¶äº†ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹ç¼–ç å§ï¼ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»

# [](#new-phoenix-app)æ–°å‡¤å‡° app

è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º*è¯—æ„*
çš„æ–°å‡¤å‡° 1.4 åº”ç”¨ç¨‹åº

```
$ mix phx.new poetic && cd poetic 
```

åˆ›å»ºåï¼Œç¡®ä¿æ­£ç¡®ä¸‹è½½ä¾èµ–å…³ç³»

```
$ mix deps.get
Resolving Hex dependencies... 
```

æˆ‘ä»¬çš„ç³»ç»Ÿä¸­éœ€è¦ [Node.js](https://nodejs.org) ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨`assets`ç›®å½•ä¸­æ„å»ºèµ„äº§ã€‚æˆ‘å‘ç°å¦‚æœä½ éœ€è¦åœ¨åŒä¸€å°æœºå™¨ä¸Šå¤„ç†ä¸åŒçš„èŠ‚ç‚¹ç‰ˆæœ¬ï¼Œnvm éå¸¸æœ‰ç”¨å¹¶ä¸”å®¹æ˜“ä½¿ç”¨ã€‚

å¦‚æœä½ åªæ˜¯æƒ³ç¼–è¯‘è¿™äº›èµ„äº§ï¼Œå¯ä»¥ä» [Node.js ç½‘ç«™](https://nodejs.org)ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…ç¨‹åºã€‚ä¸€æ—¦ä½ å®‰è£…äº† Node.js çš„æœ€æ–°ç‰ˆæœ¬ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨`npm install`å’Œ`webpack.js`å‘½ä»¤
æ¥æ„å»ºèµ„äº§

```
$ cd assets && npm install && node node_modules/webpack/bin/webpack.js --mode development 
```

# [](#postgres-using-docker)PostgresğŸ˜ä½¿ç”¨ DockerğŸ³

æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ Phoenix åº”ç”¨ç¨‹åºå¸¦æœ‰ [Ecto](https://hexdocs.pm/ecto/Ecto.html) ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬å¤„ç†å…³ç³»æ•°æ®åº“ï¼Œå¦‚ [PostgreSQL](https://www.postgresql.org/) ã€‚éœ€è¦ä¸€ä¸ªæ•°æ®åº“æ¥å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚

æˆ‘è®¤ä¸ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Docker æ˜¯åœ¨æˆ‘ä»¬çš„æœ¬åœ°ç³»ç»Ÿä¸Šå¯åŠ¨å’Œè¿è¡Œ PostgreSQL æ•°æ®åº“çš„æœ€ç®€å•ã€æœ€å¿«çš„æ–¹æ³•ã€‚

å¦‚æœä½ ä¸ç¡®å®šå¦‚ä½•ä½¿ç”¨ dockerï¼Œå¯ä»¥çœ‹çœ‹[å¦‚ä½•è¿è¡Œ Docker å®¹å™¨](https://www.poeticoding.com/how-to-run-a-docker-container/)èµ„æºï¼Œåˆæ­¥äº†è§£å¦‚ä½•è¿è¡Œ Docker å®¹å™¨ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª docker å·ï¼Œä»¥ä¿æŒæ•°æ®åº“æ•°æ®çš„æŒä¹…æ€§

```
$ docker volume create poetic-postgres` 
```

æœ‰äº†å·ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°é”€æ¯å’Œé‡æ–°åˆ›å»ºå®¹å™¨ï¼Œè€Œä¸ä¼šå¯¼è‡´ä»»ä½•æ•°æ®ä¸¢å¤±ã€‚

ç„¶åï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œè¿è¡Œå®˜æ–¹ Postgres docker æ˜ åƒï¼Œç‰ˆæœ¬ *11-alpine* ã€‚

```
$ docker container run --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=postgres -v poetic-postgres:/var/lib/postgresql/data --rm postgres:11-alpine
LOG:  listening on IPv4 address "0.0.0.0", port 5432
LOG:  database system is ready to accept connections 
```

æˆ‘ä»¬å·²ç»ç”¨è¿™äº›é€‰é¡¹å¯åŠ¨äº†ä¸€ä¸ª Postgres æœåŠ¡å™¨:

*   `-p 5432:5432`è¡¨ç¤º`--publish port_local_machine:port_container`ã€‚æœ¬åœ°æœºå™¨ä¸­çš„ç«¯å£è¢«æ‰“å¼€ï¼Œè¿æ¥è¢«è½¬å‘åˆ°å®¹å™¨ç«¯å£ã€‚
*   `-e POSTGRES_PASSWORD=postgres`æˆ‘ä»¬é€šè¿‡ç¯å¢ƒå˜é‡`POSTGRES_PASSWORD`å°†å¯†ç `postgres`è®¾ç½®ä¸ºé»˜è®¤çš„`postgres`ç”¨æˆ·ã€‚
*   `-v poetic-postgres:/var/lib/postgresql/data`æˆ‘ä»¬å°†ä¹‹å‰åˆ›å»ºçš„ docker å·æŒ‚è½½åˆ° */var/lib/postgresql/data* ç›®å½•ï¼Œè¿™æ˜¯ Postgres ç”¨æ¥å­˜å‚¨æ•°æ®çš„ç›®å½•ã€‚
*   æˆ‘ä»¬ç»™å®¹å™¨èµ·çš„åå­—ï¼Œä»¥åæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æŒ‡ä»£å®ƒã€‚
*   `--rm`ä¸€æ—¦åœæ­¢ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨ç§»é™¤ï¼Œè€Œå·ä¼šä¿ç•™ã€‚

è¦ç§»é™¤å®¹å™¨ï¼Œå‡è®¾å®ƒæ˜¯ç”¨`--rm`é€‰é¡¹å¯åŠ¨çš„ï¼Œæˆ‘ä»¬åªéœ€åœæ­¢å®ƒï¼Œå®ƒå°±ä¼šè¢«è‡ªåŠ¨ç§»é™¤ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ *postgres* çš„ç»ˆç«¯æŒ‰`CTRL+C`ã€‚æˆ–è€…ï¼Œä½¿ç”¨å¦ä¸€ä¸ªç»ˆç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤:
åœæ­¢å®¹å™¨

```
$ docker container stop postgres 
```

åˆ é™¤å®¹å™¨æ—¶ï¼Œä¸ä¼šåˆ é™¤å·ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹‹å‰ä½¿ç”¨çš„ç›¸åŒçš„`docker container run ...`å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ *postgres* å®¹å™¨ï¼Œä½¿ç”¨ç›¸åŒçš„å·ï¼Œè¿™å°†æ¢å¤æ—§çš„æ•°æ®ã€‚

# [](#configuration)é…ç½®

## [](#ecto-configuration)Ecto é…ç½®

æ—¢ç„¶æˆ‘ä»¬çš„ Postgres æœåŠ¡å™¨å·²ç»å¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Phoenix åº”ç”¨ç¨‹åºæ¥è¿æ¥æ•°æ®åº“ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ [`config/dev.exs`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/config/dev.exs) ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†æˆ‘ä»¬çš„[çˆ±å…‹æ‰˜å›è´­](https://hexdocs.pm/ecto/Ecto.Repo.html)é…ç½®

```
# config/dev.exs
...
config :poetic, Poetic.Repo,
    username: "postgres",
    password: "postgres",
    database: "poetic_dev",
    hostname: "localhost",
    pool_size: 10 
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé…ç½®åŒ¹é…æˆ‘ä»¬æœåŠ¡å™¨çš„ç”¨æˆ·åã€å¯†ç å’Œä¸»æœºåï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æ¥è§¦å®ƒã€‚

ç„¶è€Œï¼Œç›®å‰æˆ‘ä»¬çš„ Postgres ä¸­è¿˜æ²¡æœ‰ poetic_dev æ•°æ®åº“ã€‚ä¸ºäº†åˆ›å»ºå®ƒï¼Œè®©æˆ‘ä»¬åœ¨ç»ˆç«¯
ä¸Šè¿è¡Œè¿™ä¸ª ecto ä»»åŠ¡

```
$ mix ecto.create
The database for Poetic.Repo has been created 
```

è¿™å°±åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®åº“ã€‚

å¦‚æœæ‚¨è¿˜æ²¡æœ‰çœ‹åˆ°`Poetic.Repo`æ¨¡å—ï¼Œå®ƒæ˜¯æˆ‘ä»¬ç”¨æ¥è¿è¡Œæ•°æ®åº“æŸ¥è¯¢çš„æ¨¡å—ï¼Œå®ƒç»§æ‰¿äº† [Ectoã€‚å›è´­](https://hexdocs.pm/ecto/Ecto.Repo.html)åŠŸèƒ½(`insert`ã€`get`ã€...)

```
# lib/poetic/repo.ex
defmodule Poetic.Repo do
  use Ecto.Repo,
    otp_app: :poetic,
    adapter: Ecto.Adapters.Postgres
end 
```

## [](#uploads-directory)ä¸Šä¼ ç›®å½•

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé…ç½®æ¥è®¾ç½®*ä¸Šä¼ ç›®å½•*çš„ç»å¯¹è·¯å¾„ï¼Œæ¦‚è¿°æˆ‘ä»¬å°†åœ¨æœ¬åœ°å­˜å‚¨ä¸Šä¼ çš„ä½ç½®ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯é’ˆå¯¹å¼€å‘ç¯å¢ƒã€‚

```
# config/dev.exs
config :poetic,
   uploads_directory: "/Users/alvise/uploads_dev" 
```

æˆ‘æ›´å–œæ¬¢å°†*ä¸Šä¼ ç›®å½•*æ”¾åœ¨ Phoenix app æ–‡ä»¶å¤¹ä¹‹å¤–ï¼Œæ‰€ä»¥åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘åœ¨æˆ‘çš„ä¸»ç›®å½•ä¸­åˆ›å»ºäº†ä¸€ä¸ª*ä¸Šä¼  _ å¼€å‘*æ–‡ä»¶å¤¹ã€‚

å¦‚æœæˆ‘ä»¬æƒ³åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿™ä¸ªåº”ç”¨â€”â€”æˆ‘ä»¬æƒ³åˆ©ç”¨äº‘å­˜å‚¨ï¼Œè€Œä¸æ˜¯é‡æ„å®ƒæ¥ä½¿ç”¨ S3(è¿™æ˜¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼)-æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åƒ AWS EFS è¿™æ ·çš„æœåŠ¡ï¼Œåœ¨äº‘æœåŠ¡å™¨çš„ç›®å½•ä¸­å®‰è£…ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿã€‚

ç„¶åæˆ‘ä»¬åªéœ€è¦è®¾ç½®ç”Ÿäº§é…ç½®æ¥ä½¿ç”¨æŒ‚è½½çš„ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ

```
# config/prod.exs
config :poetic,
  uploads_directory: System.get_env("POETIC_UPLOADS_DIRECTORY") || "/uploads" 
```

åœ¨ç”Ÿäº§ä¸­ï¼Œå°±åƒåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨ç¯å¢ƒå˜é‡å°†æˆ‘ä»¬çš„è®¾ç½®ä¼ é€’ç»™é…ç½®æ–‡ä»¶ã€‚

# [](#upload-module)ä¸Šä¼ æ¨¡å—

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [`phx.gen.html`](https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Html.html) ç”Ÿæˆå™¨ï¼Œå®ƒä¸ºæˆ‘ä»¬åˆ›å»ºæ¨¡å¼ã€è¿ç§»ã€ä¸Šä¸‹æ–‡ã€æ§åˆ¶å™¨ã€è§†å›¾ã€æµ‹è¯•å’Œ html æ–‡ä»¶ã€‚

ç„¶è€Œï¼Œæˆ‘å‘ç°ç”Ÿæˆçš„æ”¯æ¶å¯¹äºæˆ‘ä»¬éœ€è¦çš„æ¥è¯´æœ‰ç‚¹å¤ªå¤šäº†ã€‚ç›¸åï¼Œæˆ‘å–œæ¬¢ä½¿ç”¨è¿™ä¸ªç”Ÿæˆå™¨æ¥å­¦ä¹ æ›´å¤šå…³äº phoenix æ¨¡å¼çš„çŸ¥è¯†ï¼Œè§‚å¯Ÿç»„ä»¶åº”è¯¥å¦‚ä½•ä¸€èµ·ä½¿ç”¨ã€‚

è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨çš„å”¯ä¸€ç”Ÿæˆå™¨æ˜¯åˆ›å»º Ecto æ¨¡å¼å’Œè¿ç§»ã€‚æˆ‘ä»¬å°†æ‰‹åŠ¨åˆ›å»ºå‰©ä½™çš„å¿…è¦æ–‡ä»¶ã€‚

## [](#ecto-schema-and-migration)Ecto å›¾å¼ä¸è¿ç§»

ä¸€æ—¦ç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬æƒ³ä¿å­˜ä¸åŒçš„ä¿¡æ¯åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸­ã€‚è®©æˆ‘ä»¬ä½¿ç”¨`phx.gen.schema`ä»»åŠ¡
ä¸ºä¸Šä¼ ç”Ÿæˆ*æ¨¡å¼*å’Œ*è¿ç§»*æ–‡ä»¶

```
$ mix phx.gen.schema Documents.Upload uploads filename:string size:integer content_type:string hash:string 
* creating lib/poetic/documents/upload.ex
* creating priv/repo/migrations/20190412141226_create_uploads.exs 
```

ç¬¬ä¸€ä¸ªå‚æ•°`Documents.Upload`æ˜¯æ¨¡å¼åï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ª`Poetic.Documents.Upload`æ¨¡å—ï¼Œå…¶ä¸­`Documents`æ˜¯æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡(æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°æ›´å¤š)ã€‚

`uploads`æ˜¯å°†åœ¨æ•°æ®åº“ä¸­åˆ›å»ºçš„è¡¨ã€‚

å…¶ä½™å‚æ•°å®šä¹‰æ¨¡å¼ä¸­çš„å­—æ®µå’Œè¿ç§»æ–‡ä»¶ä¸­çš„åˆ—ã€‚

è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿ç§»æ–‡ä»¶

```
# priv/repo/migrations/20190412141226_create_uploads.exs

defmodule Poetic.Repo.Migrations.CreateUploads do
  use Ecto.Migration

  def change do
    create table(:uploads) do
      add :filename, :string
      add :size, :integer
      add :content_type, :string
      add :hash, :string

      timestamps()
    end
  end
end 
```

è¿™ä¸ªæ–‡ä»¶åæ˜ äº†æˆ‘ä»¬æƒ³è¦åœ¨æ•°æ®åº“ä¸­åšçš„æ›´æ”¹ï¼Œåˆ›å»ºäº†åŒ…å«`filename`ã€`size`ã€`content_type`å’Œ`hash`åˆ—çš„`uploads`è¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒEcto è¿˜åˆ›å»ºäº†`id`åˆ—ï¼Œè¿™æ˜¯ä¸»é”®ã€‚

ä½¿ç”¨`timestamps()` Ecto æ·»åŠ äº†ä¸¤ä¸ª*æ—¶é—´æˆ³*åˆ—ï¼Œ`inserted_at`å’Œ`updated_at`ï¼Œæ¯å½“æˆ‘ä»¬åœ¨è¡¨ä¸­æ’å…¥æˆ–æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œè¿™ä¸¤ä¸ªåˆ—éƒ½ä¼šè¢«è‡ªåŠ¨ç®¡ç†ã€‚

è®©æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„è¿ç§»åšä¸€äº›å°çš„æ”¹å˜

```
 create table(:uploads) do
    ...
    add :size, :bigint
    add :hash, :string, size: 64
    ...
end

create index(:uploads, [:hash]) 
```

æˆ‘ä»¬æ”¹å˜çš„ç¬¬ä¸€ä»¶äº‹æ˜¯`size`åˆ—çš„ç±»å‹ã€‚ [`integer`](https://www.postgresql.org/docs/10/datatype-numeric.html) Postgres ç±»å‹æ˜¯ä»‹äº *-2147483648* å’Œ *+2147483647* ä¹‹é—´çš„æ•´æ•°ã€‚ä¸ºäº†ä¿å­˜å¤§äº 2GB çš„å€¼ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª`bigint` -è¿™æ˜¯è¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨æˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­å¤„ç†çš„æ–‡ä»¶(é«˜è¾¾ 8192ï¼).

ä¸ºäº†æ•£åˆ—æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨çš„ç®—æ³•æ˜¯ SHA-256ï¼Œå…¶ä¸­åå…­è¿›åˆ¶æ‘˜è¦æ˜¯ä¸€ä¸ª 64 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å·²ç»ä½¿ç”¨`size: 64`é€‰é¡¹è®¾ç½®äº†å­—ç¬¦ä¸²çš„å¤§å°ï¼Œå¹¶ä½¿ç”¨`create index(:uploads, [:hash])`åœ¨è¯¥åˆ—ä¸Šåˆ›å»ºäº†ä¸€ä¸ªç´¢å¼•ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ•£åˆ—æ¥æœç´¢æ–‡ä»¶ï¼Œæœç´¢ä¼šå¿«å¾—å¤šã€‚

ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ Upload Ecto æ¨¡å¼æ–‡ä»¶ï¼Œå®ƒç”¨äºå°†æ•°æ®åº“è®°å½•æ˜ å°„åˆ°ä¸€ä¸ª Elixir ç»“æ„ã€‚

```
# lib/poetic/documents/upload.ex
defmodule Poetic.Documents.Upload do
  use Ecto.Schema
  import Ecto.Changeset

  schema "uploads" do
    field :content_type, :string
    field :filename, :string
    field :hash, :string
    field :size, :integer

    timestamps()
  end

end 
```

æ¨¡å¼ä¸­çš„å­—æ®µæ˜¯`%Poetic.Documents.Upload{}`ç»“æ„çš„å­—æ®µã€‚ä»–ä»¬æ˜ å°„æ•°æ®åº“ç±»å‹(æ¯”å¦‚ *bigint* ï¼Œ *varchar* ç­‰ã€‚)åˆ°ä»™ä¸¹å¼(*æ•´æ•°*ï¼Œ*å­—ç¬¦ä¸²*ç­‰ã€‚).

```
iex> alias Poetic.Documents.Upload
iex> %Upload{}
%Poetic.Documents.Upload{
  __meta__: #Ecto.Schema.Metadata<:built, "uploads">,
  content_type: nil,
  filename: nil,
  hash: nil,
  id: nil,
  inserted_at: nil,
  size: nil,
  updated_at: nil
} 
```

åœ¨è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬è¿˜æ‰¾åˆ°äº†`changeset/2`å‡½æ•°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†éªŒè¯è§„åˆ™å’Œå¿…å¡«å­—æ®µã€‚

```
# lib/poetic/documents/upload.ex
defmodule Poetic.Documents.Upload do
  ...
  def changeset(upload, attrs) do
    upload
    |> cast(attrs, [:filename, :size, :content_type, :hash])
    |> validate_required([:filename, :size, :content_type, :hash])

    # added validations
    |> validate_number(:size, greater_than: 0) #doesn't allow empty files
    |> validate_length(:hash, is: 64)
  end
end 
```

æˆ‘ä»¬æ·»åŠ äº†å¦å¤–ä¸¤ä¸ªéªŒè¯:

*   `validate_number(:size, greater_than: 0)`æ£€æŸ¥ç»™å®šçš„å¤§å°æ˜¯å¦å¤§äº 0(æ²¡æœ‰ç©ºæ–‡ä»¶)ã€‚
*   `validate_length(:hash, is: 64)`æ£€æŸ¥å“ˆå¸Œæ˜¯å¦æ˜¯ 64 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚

ç°åœ¨æ˜¯æ—¶å€™é€šè¿‡è¿è¡Œè¿ç§»ä»»åŠ¡
æ¥åˆ›å»º`uploads`è¡¨äº†

```
$ mix ecto.migrate
[info] == Running 20190412141226 Poetic.Repo.Migrations.CreateUploads.change/0 forward
[info] create table uploads
[info] == Migrated 20190412141226 in 0.0s 
```

ä¸ºäº†æŸ¥çœ‹æ‰€æœ‰å†…å®¹æ˜¯å¦åˆ›å»ºæ­£ç¡®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­£åœ¨è¿è¡Œçš„ *postgres* Docker å®¹å™¨
ä¸­çš„`psql`å®¢æˆ·ç«¯

```
$ docker container exec -it postgres psql -U postgres
psql (10.7)
Type "help" for help.

postgres=# \l
                                  List of databases
    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-------------+----------+----------+------------+------------+-----------------------
 poetic_dev  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
...
postgres=# \c poetic_dev
You are now connected to database "poetic_dev" as user "postgres".

postgres=# \d
 Schema |       Name        |   Type   |  Owner
--------+-------------------+----------+----------
 public | schema_migrations | table    | postgres
 public | uploads           | table    | postgres
 public | uploads_id_seq    | sequence | postgres

postgres=# \d+ uploads
    Column    |              Type              
--------------+--------------------------------
 id           | bigint                         
 filename     | character varying(255) 
 size         | integer                        
 content_type | character varying(255)         
 hash         | character varying(64)         
 inserted_at  | timestamp(0) without time zone 
 updated_at   | timestamp(0) without time zone 
 Indexes:
    "uploads_pkey" PRIMARY KEY, btree (id)
    "uploads_hash_index" btree (hash) 
```

ç„¶åï¼Œæˆ‘ä»¬è¿è¡Œ *iex* å¹¶ä½¿ç”¨ *Ecto* å’Œ *Upload* æ¥åˆ›å»ºä¸€ä¸ªè®°å½•

```
poetic$ iex -S mix

iex> alias Poetic.Repo
iex> alias Poetic.Documents.Upload
iex> %Upload{} \
...> |> Upload.changeset(%{
    filename: "image.jpg", 
    content_type: "image/jpeg",
    hash: String.duplicate("a",64), #fake hash
    size: 1_000
}) |> Repo.insert()

[debug] QUERY OK db=2.4ms decode=0.8ms queue=0.8ms
INSERT INTO "uploads" ...

{:ok, %Poetic.Documents.Upload{id: 1, ...} 
```

`Upload.changeset/2`è¿”å›ä¸€ä¸ª [`Ecto.Changeset`](https://hexdocs.pm/ecto/Ecto.Changeset.html) ï¼Œä¼ é€’ç»™ [`Repo.insert/2`](https://hexdocs.pm/ecto/Ecto.Repo.html#c:insert/2) å‡½æ•°ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸Šä¼ è®°å½•ã€‚

## [](#sha256-function)SHA-256 å‡½æ•°

ä½¿ç”¨æˆ‘ä»¬åœ¨[ä¸­çœ‹åˆ°çš„åœ¨ Elixir](https://www.poeticoding.com/hashing-a-file-in-elixir/) ä¸­æ•£åˆ—ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨`Poetic.Documents.Upload`æ¨¡å—ä¸­æ·»åŠ äº†`sha256(chunks_enum)`å‡½æ•°ã€‚è¿™å°†è®¡ç®—å¹¶è¿”å›ç»™å®šæµçš„ SHA-256 åå…­è¿›åˆ¶æ‘˜è¦ã€‚

```
# lib/poetic/documents/upload.ex
defmodule Poetic.Documents.Upload do
    ...
    def sha256(chunks_enum) do
        chunks_enum
        |> Enum.reduce(:crypto.hash_init(:sha256),&(:crypto.hash_update(&2, &1)))
        |> :crypto.hash_final()
        |> Base.encode16()
        |> String.downcase()
    end
end 
```

è¦è®¡ç®—ä¸€ä¸ªæ–‡ä»¶çš„æ•£åˆ—å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•

```
iex> File.stream!("assets/static/images/phoenix.png", [], 2048) \
...> |> Poetic.Documents.Upload.sha256()
"07aa9b01595fe10..." 
```

## [](#localpath)æœ¬åœ° _ è·¯å¾„

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œå‘Šè¯‰æˆ‘ä»¬ä¸€æ—¦æ”¶åˆ°æ–‡ä»¶ï¼Œåœ¨å“ªé‡Œå­˜å‚¨ã€‚

```
# lib/poetic/documents/upload.ex
defmodule Poetic.Documents.Upload do
    @upload_directory Application.get_env(:poetic, :uploads_directory)

    def local_path(id, filename) do
        [@upload_directory, "#{id}-#{filename}"]
        |> Path.join()
    end
end 
```

è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª*ç»å¯¹è·¯å¾„*ï¼Œå°†æ–‡ä»¶æ”¾åœ¨æˆ‘ä»¬ä¹‹å‰åœ¨`config/dev.exs`ä¸­å®šä¹‰çš„ä¸Šä¼ ç›®å½•ä¸­ã€‚

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ä½¿è·¯å¾„å˜å¾—ç‹¬ç‰¹ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€å°†`id`(ä¸Šä¼ çš„æ•°æ®åº“è®°å½•çš„ä¸»é”®)æ·»åŠ åˆ°æ–‡ä»¶åçš„å¼€å¤´ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤šä¸Šä¼ ï¼ŒæŠŠå®ƒä»¬éƒ½ä¿å­˜åœ¨ä¸€ä¸ªç›®å½•ä¸­å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚æ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨ä¸Šä¼ ç‰¹æ€§ï¼Œæ¯”å¦‚åˆ›å»ºæ—¥æœŸï¼Œæ¥äº§ç”Ÿä¸€ä¸ªç›®å½•å±‚æ¬¡ç»“æ„ï¼Œæ¯”å¦‚`"2019/04/15/#{id}-#{filename}"`ã€‚

# [](#uploadcontroller)ä¸Šä¼ æ§åˆ¶å™¨

åœ¨ [`PoeticWeb.UploadController`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex) æ§åˆ¶å™¨ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€äº›å‡½æ•°æ¥å›ç­”ä»¥ä¸‹ HTTP è¯·æ±‚:

*   å‘ˆç°ä¸€ä¸ªå¸¦æœ‰è¡¨å•çš„é¡µé¢æ¥ä¸Šä¼ æˆ‘ä»¬çš„æ–‡ä»¶
*   `POST /uploads`æ¥æ”¶ä¸Šä¼ å¹¶å°†å…¶å­˜å‚¨åœ¨æœ¬åœ°
*   `GET /uploads`åˆ—å‡ºä¸Šä¼ çš„æ–‡ä»¶
*   `GET /uploads/:id`ä¸‹è½½æ–‡ä»¶

æˆ‘ä»¬é¦–å…ˆæ”¹å˜æˆ‘ä»¬çš„ [`PoeticWeb.Router`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/router.ex) è·¯ç”±å™¨ï¼Œä½¿ç”¨ [`resources`](https://hexdocs.pm/phoenix/routing.html#resources) å°† HTTP è¯·æ±‚åŒ¹é…åˆ°æ§åˆ¶å™¨åŠ¨ä½œ

```
# lib/poetic_web/router.ex
defmodule PoeticWeb.Router do
    ...

  scope "/", PoeticWeb do
    pipe_through :browser

    resources "/uploads", UploadController, only: [:index, :new, :create, :show]
  end
end 
```

ä½¿ç”¨`phx.routes`æ··åˆä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—å‡ºæ‰€æœ‰è·¯çº¿

```
$ mix phx.routes
...
upload_path  GET   /uploads         PoeticWeb.UploadController :index
upload_path  GET   /uploads/new     PoeticWeb.UploadController :new
upload_path  GET   /uploads/:id     PoeticWeb.UploadController :show
upload_path  POST  /uploads         PoeticWeb.UploadController :create 
```

ç°åœ¨åº”è¯¥ä¼šåˆ—å‡º*ä¸Šä¼ *è·¯çº¿ã€‚

## [](#new-action):æ–°åŠ¨ä½œ

ä¸ºäº†å¼€å§‹ç¼–å†™`UploadController`ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`lib/poetic_web/controllers/upload_controller.ex`ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å®šä¹‰äº† [`PoeticWeb.UploadController`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex) æ¨¡å—

```
# lib/poetic_web/controllers/upload_controller.ex
defmodule PoeticWeb.UploadController do
  use PoeticWeb, :controller

  def new(conn, _params) do
    render(conn, "new.html")
  end
end 
```

`new/2`å‡½æ•°å‘ˆç°äº†`new.html`æ¨¡æ¿ï¼Œæˆ‘ä»¬å°†åœ¨è¿™é‡Œç¼–å†™ä¸Šä¼ è¡¨å•ã€‚

è¿™ä¸ªæ¨¡æ¿æ–‡ä»¶å¿…é¡»è¢«å‘½åä¸º [new.html.eex](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/templates/upload/new.html.eex) ï¼Œå¹¶æ”¾ç½®åœ¨`lib/poetic_web/templates/upload`(å…¶ä¸­ *upload* æ˜¯æ§åˆ¶å™¨çš„å°å†™åç§°)ã€‚

```
<%= form_for @conn, Routes.upload_path(@conn, :create), [multipart: true], fn f-> %>

    <%= file_input f, :upload, class: "form-control" %>
    <%= submit "Upload", class: "btn btn-primary" %>

<% end %> 
```

è¿™ä¸ª *EEx* æ¨¡æ¿åˆ›å»ºäº†ä¸€ä¸ª**å¤šéƒ¨åˆ†**è¡¨å•ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­é€‰æ‹©è¦å‘é€çš„æ–‡ä»¶ã€‚å½“ç”¨æˆ·æäº¤è¡¨å•æ—¶ï¼Œå®ƒä¼šå‘å‡ºä¸€ä¸ª`POST /uploads`è¯·æ±‚(ç”±`Routes.upload_path(@conn, :create)`è¿”å›çš„åŠ¨ä½œ)ã€‚

ä¸ºäº†å‘ˆç°æ¨¡æ¿ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªæ§åˆ¶å™¨çš„è§†å›¾ã€‚Phoenix å‡è®¾ä»æ§åˆ¶å™¨åˆ°è§†å›¾ï¼Œå†åˆ°å®ƒä»¬æ‰€å‘ˆç°çš„æ¨¡æ¿éƒ½æœ‰ä¸€ä¸ªå¾ˆå¼ºçš„å‘½åçº¦å®šã€‚`UploadController`éœ€è¦ä¸€ä¸ª`UploadView`æ¥æ¸²æŸ“`lib/poetic_web/templates/upload`ç›®å½•ä¸­çš„æ¨¡æ¿ã€‚

```
defmodule PoeticWeb.UploadView do
  use PoeticWeb, :view
end 
```

åœ¨æµ‹è¯•æˆ‘ä»¬çš„ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é¦–å…ˆå°†`create/2`å‡½æ•°æ·»åŠ åˆ°æ§åˆ¶å™¨ä¸­ï¼Œå¹¶æ£€æŸ¥è¡¨å•å‘åŠ¨ä½œ
å‘é€äº†ä»€ä¹ˆ

```
defmodule PoeticWeb.UploadController do
    ...

  def create(conn, %{"upload" => %Plug.Upload{}=upload}) do
        IO.inspect(upload, label: "UPLOAD")
        text conn, "ok"
  end

end 
```

æˆ‘ä»¬æœŸæœ› params ä¸­æœ‰ä¸€ä¸ª`upload`é”®ï¼Œä¸€ä¸ª [`%Plug.Upload{}`](https://hexdocs.pm/plug/Plug.Upload.html) ç»“æ„ä¿å­˜æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ã€‚

[Plug](https://github.com/elixir-plug/plug) ä¸ºæˆ‘ä»¬ç®¡ç†ä¸Šä¼ ï¼Œå°†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯¥ç»“æ„çš„`path`å­—æ®µä¸­æ‰¾åˆ°è¯¥æ–‡ä»¶ï¼›å½“è¯·æ±‚ç»ˆæ­¢æ—¶ï¼Œä¸´æ—¶æ–‡ä»¶å°†è¢«è‡ªåŠ¨åˆ é™¤ã€‚

æ˜¯æ—¶å€™è¿è¡Œå‡¤å‡°æœåŠ¡å™¨æµ‹è¯•ä¸Šä¼ äº†ã€‚

è¦çœ‹è¡¨æ ¼ï¼Œæˆ‘ä»¬éœ€è¦å»*[http://localhost:4000/uploads/new](http://localhost:4000/uploads/new)*

```
$ mix phx.server
[info] Running PoeticWeb.Endpoint with cowboy 2.6.3 at 0.0.0.0:4000 (http)
[info] Access PoeticWeb.Endpoint at http://localhost:4000 
```

[![New upload multipart form](../Images/0213ee0989f6c47140548c4cec8f33d9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--G27aJwIC--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://1o6jjh24p1t92lcqci49qg8a-wpengine.netdna-ssl.com/wp-content/uploads/2019/04/phoenix_multipart_upload_form.jpg)

æˆ‘å°†ä¸Šä¼ åœ¨é¡¹ç›®èµ„äº§ä¸­æ‰¾åˆ°çš„*phoenix.png*å›¾åƒã€‚ä¸€æ—¦æäº¤ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ç»ˆç«¯
ä¸Šçœ‹åˆ°è¿™ä¸ªæ£€æŸ¥æ—¥å¿—

```
%Plug.Upload{
  content_type: "image/png",
  filename: "phoenix.png",
  path: "/var/folders/lt/t88p62t91mg1mxdlmv_rlkl80000gn/T//plug-1555/multipart-1555258629-39672758309128-2"
} 
```

Plug ç»™äº†æˆ‘ä»¬ä¸‰ä¸ªé‡è¦çš„å­—æ®µ:`filename`ã€`content_type`å’Œ`path`â€”â€”è¿™æ˜¯ä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„ã€‚

# [](#documents-context)å•æ®ä¸Šä¸‹æ–‡

ä¸€æ—¦ [`UploadController.create/2`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex#L16) å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒå¿…é¡»åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªä¸Šä¼ è®°å½•ï¼Œå¹¶å°†æ–‡ä»¶å­˜å‚¨åœ¨ä¸Šä¼ ç›®å½•ä¸­ã€‚

ä¸å…¶å°†æ‰€æœ‰çš„é€»è¾‘æ”¾å…¥`create`å‡½æ•°ï¼Œä¸å¦‚å°†è¿™ä¸ªé€»è¾‘å†™å…¥ä¸€ä¸ª[ä¸Šä¸‹æ–‡](https://hexdocs.pm/phoenix/contexts.html)ä¸­ã€‚ä¸Šä¸‹æ–‡æ˜¯å°†æ§åˆ¶å™¨ä»åº”ç”¨ç¨‹åºçš„é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥çš„ä¸€ä¸ªå¾ˆå¥½çš„æ–¹å¼(æ¯”å¦‚ä½¿ç”¨`Repo`æ¥åˆ›å»ºæˆ–åŠ è½½è®°å½•)ã€‚

## [](#create-upload-from-plugupload)ä»%Plug åˆ›å»ºä¸Šä¼ ã€‚ä¸Šä¼ {}

è®©æˆ‘ä»¬ç”¨æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡`Poetic.Documents`åˆ›å»ºæ–‡ä»¶ [`lib/poetic/documents.ex`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic/documents.ex) ï¼Œæˆ‘ä»¬ç”¨å®ƒä½œä¸ºç®¡ç†ä¸Šä¼ çš„å…¬å…±æ¥å£ã€‚

```
# lib/poetic/documents.ex
defmodule Poetic.Documents do
    import Ecto.Query, warn: false

    alias Poetic.Repo
    alias Poetic.Documents.Upload

    def create_upload_from_plug_upload(%Plug.Upload{
        filename: filename,
        path: tmp_path,
        content_type: content_type
    }) do

        # upload creation logic
    end

end 
```

å®é™…çš„æ•£åˆ—è®¡ç®—ã€æ•°æ®åº“è®°å½•åˆ›å»ºå’Œæ–‡ä»¶å¤åˆ¶ä½œä¸º [`create_upload_from_plug_upload/1`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic/documents.ex#L16) åŠŸèƒ½çš„ä¸€éƒ¨åˆ†å‘ç”Ÿã€‚

```
#create_upload_from_plug_upload function

hash = 
    File.stream!(tmp_path, [], 2048) 
    |> Upload.sha256()

with {:ok, %File.Stat{size: size}} <- File.stat(tmp_path),

  {:ok, upload} <- 
        %Upload{}
        |> Upload.changeset(%{
                filename: filename, content_type: content_type,
                hash: hash, size: size }) |> Repo.insert(),

    :ok <- File.cp(
                tmp_path, 
                Upload.local_path(upload.id, filename))

do 
    {:ok, upload}

else
    {:error, reason}=error -> error
end 
```

ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»*æ’ä»¶ä¸­æå–å‡º*æ–‡ä»¶å*ã€*å†…å®¹ç±»å‹*å’Œ*è·¯å¾„*ã€‚ä¸Šä¼ * struct ä¼ é€’ç»™å‡½æ•°ã€‚

æˆ‘ä»¬é¦–å…ˆè®¡ç®—æ–‡ä»¶çš„ SHA-256 æ•£åˆ—ï¼Œç„¶åä½¿ç”¨`with`æ„é€ æ¥æ£€æŸ¥æ‰€æœ‰ä¸‰ä¸ªä¼ é€’çš„å­å¥æ˜¯å¦åŒ¹é…ã€‚

*   åœ¨ç¬¬ä¸€ä¸ªå­å¥ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ [`File.stat`](https://hexdocs.pm/elixir/File.html#stat/2) å’Œæ¨¡å¼åŒ¹é…å°†`size`å˜é‡ç»‘å®šåˆ°æ–‡ä»¶çš„å¤§å°ã€‚
*   å¦‚æœå‰é¢çš„å­å¥åŒ¹é…ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ‹¥æœ‰äº†å°†ä¸Šä¼ æ’å…¥æ•°æ®åº“æ‰€éœ€çš„ä¸€åˆ‡ã€‚
*   ä¸€æ—¦åœ¨æ•°æ®åº“ä¸­æˆåŠŸåˆ›å»ºäº†ä¸Šä¼ ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨`Upload.local_path(upload.id, filename)`å‡½æ•°å°†æ–‡ä»¶å¤åˆ¶åˆ°ä¸Šä¼ ç›®å½•ä¸­ã€‚

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå‡½æ•°è¿”å›`{:ok, upload}`ï¼Œå…¶ä¸­`upload`æ˜¯ä¸€ä¸ª`Poetic.Documents.Upload`ç»“æ„ã€‚

å¦‚æœå…¶ä¸­ä¸€ä¸ªå­å¥ä¸åŒ¹é…ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ï¼Œå‡½æ•°å°†è¿”å›`{:error, reason}`å…ƒç»„ã€‚

ä¸ºäº†åœ¨ *iex* ä¸Šæµ‹è¯•è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¼ é€’ä¸€ä¸ªæŒ‡å‘æœ‰æ•ˆæ–‡ä»¶çš„`%Plug.Upload{}`ç»“æ„(è®°å¾—è®¾ç½®ä¸€ä¸ªç»å¯¹è·¯å¾„)ã€‚

```
iex> alias Poetic.Documents
iex> upload = %Plug.Upload{
    filename: "phoenix.png", 
    content_type: "image/png",
    path: "/absolute_path_to/phoenix.png", 
}
iex> Documents.create_upload_from_plug_upload(upload)
{:error, :enoent} 
```

å•Šå“¦-å‡ºé—®é¢˜äº†ğŸ¤”

`enoent`æ„å‘³ç€*æ²¡æœ‰è¿™æ ·çš„æ–‡ä»¶æˆ–ç›®å½•*ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†è¿™ä¸ªé”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åˆ›å»ºä¸Šä¼ ç›®å½•(åœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯*/Users/al vise/uploads _ dev*)ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ï¼Œå¾ˆéš¾ç†è§£é”™è¯¯æŒ‡çš„æ˜¯å“ªä¸ªå­å¥ã€‚ä½¿ç”¨å…ƒç»„åŒ…è£…æœ‰ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

ä½†æ˜¯è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹ä¸Šä¼ è¡¨
é‡Œé¢æœ‰ä»€ä¹ˆ

```
poetic_dev=# select * from uploads;
id |  filename   | size  | ...
 5 | phoenix.png | 13900 | ...

(1 rows) 
```

è™½ç„¶æˆ‘ä»¬æœ‰ä¸€ä¸ªé”™è¯¯ï¼Œä¸Šä¼ è®°å½•ä»ç„¶åœ¨æ•°æ®åº“ä¸­ã€‚

å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºåœ¨å°†ä¸Šä¼ æ’å…¥æ•°æ®åº“åï¼Œè¿”å›é”™è¯¯ [`File.cp/2`](https://hexdocs.pm/elixir/File.html#cp/3) çš„å‡½æ•°*å¤±è´¥ã€‚*

## [](#repotransaction)å›è´­äº¤æ˜“

å¸Œæœ›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨[äº‹åŠ¡](https://hexdocs.pm/ecto/Ecto.Repo.html#c:transaction/2_)å°†ä¸€åˆ‡æ‰“åŒ…åˆ°ä¸€ä¸ª*åŸå­*æ“ä½œä¸­ã€‚è¿™æ ·åšæ„å‘³ç€ï¼Œå¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œæ›´æ”¹å°†è¢«å›æ»š(å³ï¼Œå¦‚æœæˆ‘ä»¬åŒ¹é…ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°†è¯·æ±‚å›æ»š)ã€‚

```
Repo.transaction fn ->
    with ...
    do
        upload
    else
        {:error, reason} -> 
            Repo.rollback(reason)
    end
end 
```

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œ`Repo.transaction`è¿”å›`{:ok, upload}`ï¼Œè€Œå¦‚æœå‡ºé”™ï¼Œåˆ™è¿”å›`{:error, reason}`ã€‚

è®©æˆ‘ä»¬é€šè¿‡åˆ›å»º*ä¸Šä¼ ç›®å½•*æ¥ä¿®å¤é”™è¯¯ï¼Œç„¶åé‡è¯•ã€‚

```
iex> %Plug.Upload{
    filename: "phoenix.png", 
    content_type: "image/png",
    path: "/absolute_path_to/phoenix.png", 
} |> Document.create_upload_from_plug_upload()

{:ok,
  %Poetic.Documents.Upload{
        ...
        content_type: "image/png",
    filename: "phoenix.png",
    hash: "07aa9b01...",
    id: 7,
    size: 13900,
    inserted_at: ~N[2019-04-15 12:25:24],
    updated_at: ~N[2019-04-15 12:25:24]
  }
} 
```

å¤ªæ£’äº†â€”â€”æˆåŠŸäº†ğŸ‰ï¼ä¸Šä¼ åœ¨æ•°æ®åº“ä¸­åˆ›å»ºï¼Œæ–‡ä»¶è¢«å¤åˆ¶åˆ° *uploads_dev* ç›®å½•ä¸­ã€‚

```
$ ls /Users/alvise/uploads_dev/
7-phoenix.png 
```

# [](#uploadcontroller-raw-create-endraw-action)ä¸Šä¼ æ§åˆ¶å™¨`:create`åŠ¨ä½œ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„æ–‡æ¡£ä¸Šä¸‹æ–‡æ¥å®ç°ä¸Šä¼ æ§åˆ¶å™¨
ä¸­çš„`create/2`åŠŸèƒ½

```
# PoeticWeb.UploadController
alias Poetic.Documents

def create(conn, %{"upload" => %Plug.Upload{}=upload}) do
    case Documents.create_upload_from_plug_upload(upload) do
        {:ok, upload}->
            put_flash(conn, :info, "file uploaded correctly")
            redirect(conn, to: Routes.upload_path(conn, :index))
        {:error, reason}->
            put_flash(conn, :error, "error upload file: #{inspect(reason)}")
            render(conn, "new.html")
    end
end 
```

æˆ‘ä»¬å°†ä¸Šä¼ ä¼ é€’ç»™`Documents.create_upload_from_plug_upload/1`ï¼Œå®ƒä¸ºæˆ‘ä»¬å¤„ç†ä¸€åˆ‡ã€‚

*   å½“å®ƒæˆåŠŸè¿”å›æ—¶ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ª flash info æ¶ˆæ¯ï¼Œå¹¶é‡å®šå‘åˆ°åˆ—å‡ºæ‰€æœ‰ä¸Šä¼ å†…å®¹çš„ *index* é¡µé¢ã€‚
*   å½“å®ƒè¿”å›ä¸€ä¸ªé”™è¯¯æ—¶ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ª flash é”™è¯¯æ¶ˆæ¯å¹¶é‡å®šå‘åˆ°*æ–°çš„*é¡µé¢ã€‚

# [](#uploadcontroller-raw-index-endraw-action)ã€ä¸Šä¼ æ§åˆ¶å™¨ã€‘- `:index`åŠ¨ä½œ

ä¸ºäº†åˆ—å‡ºä¸Šä¼ çš„å†…å®¹ï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨`Documents`ä¸Šä¸‹æ–‡ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œç§°ä¸º [`list_uploads`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic/documents.ex#L12) ã€‚è¿™å°†è¿”å›æ•°æ®åº“ä¸­çš„æ‰€æœ‰ä¸Šä¼ å†…å®¹ã€‚

```
defmodule Poetic.Documents do
    ...
    def list_uploads do
        Repo.all(Upload)
    end
end 
```

åœ¨`UploadController`ä¸­ï¼Œæˆ‘ä»¬ç„¶ååˆ›å»º [`index/2`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex#L7) å‡½æ•°ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬è·å¾—ä¸Šä¼ åˆ—è¡¨å¹¶å‘ˆç° index.html æ¨¡æ¿*ã€‚* 

```
defmodule PoeticWeb.UploadController do
    ...
  def index(conn, _params) do
        uploads = Documents.list_uploads()
        render(conn, "index.html", uploads: uploads)
  end
end 
```

æˆ‘ä»¬å°†*ä¸Šä¼ *åˆ—è¡¨ä¼ é€’ç»™æ¸²æŸ“å‡½æ•°ï¼Œå¹¶ä¸”åœ¨æ¨¡æ¿ [`lib/poetic_web/templates/upload/index.html.eex`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/templates/upload/index.html.eex) ä¸­ï¼Œæˆ‘ä»¬å¾ªç¯è¯¥åˆ—è¡¨æ¥æ¸²æŸ“ä¸Šä¼ åˆ—è¡¨ã€‚

```
<table class="table">
    <thead>
        <th>ID</th>
        <th>Filename</th>
        <th>Type</th>
        <th>Time</th>
    </thead>
    <tbody>

        <%= for upload <- @uploads do %>
            <tr>
                <td><%= upload.id %></td>
                <td><%= upload.filename %></td>
                <td><%= upload.content_type %></td>
                <td><%= upload.inserted_at %></td>
            </tr>
        <% end %>

    </tbody>
</table> 
```

# [](#lets-try-it)è®©æˆ‘ä»¬è¯•è¯•å§

```
$ mix phx.server
Running PoeticWeb.Endpoint with cowboy
Access PoeticWeb.Endpoint at http://localhost:4000
... 
```

[![:index action to list uploads](../Images/d69bc4c6b13f175e5487f6b489b70544.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--SsN-SVfc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/index_action_to_list_uploads.png)

# [](#download)ä¸‹è½½

ä¸ºäº†è¯·æ±‚ä¸‹è½½ï¼Œæˆ‘ä»¬ä½¿ç”¨ [`show/2`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex#L30) å‡½æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨`GET /uploads/:id` HTTP è¯·æ±‚è°ƒç”¨è¯¥å‡½æ•°ã€‚

æˆ‘ä»¬å¼€å§‹ä¿®æ”¹ [`index.html.eex`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/templates/upload/index.html.eex) æ¨¡æ¿ï¼Œåœ¨æ¯æ¬¡ä¸Šä¼ çš„è¡Œä¸­æ·»åŠ ä¸€ä¸ªä¸‹è½½é“¾æ¥ã€‚

```
<%= for upload <- @uploads do %>
    ...
    <td>
        <%= link "download", to: Routes.upload_path(@conn, :show, upload.id) %>
    </td>
<% end %> 
```

ç„¶åï¼Œåœ¨`Documents`ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† [`get_upload!(id)`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic/documents.ex#L7) å‡½æ•°ï¼Œå½“ç»™å®šä¸€ä¸ª`id`æ—¶ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªä¸Šä¼ ç»“æ„

```
# lib/poetic/documents.ex
defmodule Poetic.Documents do
  ...
    def get_upload!(id) do
        Upload
        |> Repo.get!(id)
    end
end 
```

æœ€åï¼Œè®©æˆ‘ä»¬å®ç° [`show/2`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/controllers/upload_controller.ex#L30) åŠŸèƒ½ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ç»™å®šçš„`id`ä»æ•°æ®åº“ä¸­è·å–ä¸Šä¼ ï¼Œè¿åŒä¿å­˜æ–‡ä»¶çš„`local_path`ï¼Œå¹¶ä½¿ç”¨ [`send_download`](https://hexdocs.pm/phoenix/Phoenix.Controller.html#send_download/3) å‘é€æ–‡ä»¶ã€‚

```
# PoeticWeb.UploadController

def show(conn, %{"id" => id}) do
    upload = Documents.get_upload!(id)
    local_path = Upload.local_path(upload.id, upload.filename)
    send_download conn, {:file, local_path}, filename: upload.filename
end 
```

ç„¶åï¼Œæˆ‘ä»¬å°†è¿æ¥ä¼ é€’ç»™`send_download`å’Œä¸€ä¸ªå…ƒç»„ï¼Œè¯¥å…ƒç»„åŒ…å«æˆ‘ä»¬è¦å‘é€çš„æ–‡ä»¶çš„è·¯å¾„å’Œæ–‡ä»¶åã€‚

ç”¨æˆ‘ä»¬çš„æµè§ˆå™¨è¿›å…¥*[http://localhost:4000/uploads](http://localhost:4000/uploads)*æˆ‘ä»¬ç°åœ¨çœ‹åˆ°äº†*ä¸‹è½½*é“¾æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ä¸‹è½½æ–‡ä»¶

[![List of uploads with download link](../Images/f2536082c506c0e6f5884697781f574a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--6dRsoOB6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/index_download_link.jpg)

# [](#upload-size-limit)ä¸Šä¼ å¤§å°é™åˆ¶

å¦‚æœæˆ‘ä»¬å°è¯•ä¸Šä¼ ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¦‚ 100MB çš„ tiff å›¾åƒï¼Œæˆ‘ä»¬ä¼šæ”¶åˆ°ä»¥ä¸‹é”™è¯¯

[![The request is too large](../Images/678abfe9a6eb25e25fd9a71191449035.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--swnVzwmN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/the_request_is_too_large.jpg)

é»˜è®¤æƒ…å†µä¸‹ï¼Œ[æ’ä»¶å¤šéƒ¨åˆ†è§£æå™¨](https://hexdocs.pm/plug/Plug.Parsers.MULTIPART.html)æœ€å¤šè¯»å– *8_000_000 å­—èŠ‚*ã€‚ä¸ºäº†å¢åŠ è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ [`lib/poetic_web/endpoint.ex`](https://github.com/poeticoding/phoenix_uploads_articles/blob/d67c4b2495a75410f7cc497a6df2dd54be37cc03/lib/poetic_web/endpoint.ex#L30) æ–‡ä»¶

```
# lib/poetic_web/endpoint.ex
plug Plug.Parsers,
    parsers: [:urlencoded, :multipart, :json], 
```

ç”¨`{:multipart, length: num_of_bytes}`
æ”¹å˜`:multipart`

```
plug Plug.Parsers,
    parsers: [:urlencoded, {:multipart, length: 500_000_000}, :json], 
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¾ç½®äº† 500MB çš„é™åˆ¶ã€‚é‡æ–°å¯åŠ¨æœåŠ¡å™¨åï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨è¿™ä¸ªæ”¹å˜åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸Šä¼ ä¸€ä¸ªå·¨å¤§çš„ 200MB çš„ tiff å›¾åƒã€‚

[![Large image uploaded correctly](../Images/27a22cb689c26817c1320a672ab4f099.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--SnqFT2wA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://www.poeticoding.com/wp-content/uploads/2019/04/large_file_upload.jpg)

# [](#wrap-up)æ€»ç»“èµ·æ¥

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†å¦‚ä½•ä»å¤´å¼€å§‹æ„å»º Phoenix åº”ç”¨ç¨‹åºï¼Œè®©ç”¨æˆ·ä½¿ç”¨å¤šéƒ¨åˆ†è¡¨å•ä¸Šä¼ ä»–ä»¬çš„æ–‡ä»¶ã€‚æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•åœ¨æˆ‘ä»¬çš„æœºå™¨ä¸Šä½¿ç”¨ Docker è½»æ¾è¿è¡Œ PostgreSQLï¼Œä½¿ç”¨ Plug æ¥æ”¶ä¸Šä¼ ã€‚ä¸Šä¼ ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Ecto å°†ä¸Šä¼ çš„è¯¦ç»†ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

æœ‰å¾ˆå¤šåº“å¯ä»¥å¸®åŠ©ä½ å¤„ç†ä¸Šä¼ å’Œäº‘å­˜å‚¨ã€‚ä¸€ä¸ªå¾ˆæ£’çš„æ˜¯ [Arc](https://github.com/stavro/arc) ï¼Œå®ƒä¸ Ecto å’Œ AWS S3 é›†æˆå¾—å¾ˆå¥½ã€‚

ä½ å¯ä»¥åœ¨ GitHub repo ä¸­æ‰¾åˆ°ä¸æœ¬æ–‡ç›¸å…³çš„æ‰€æœ‰ä»£ç :[poeticoding/phoenix _ uploads _ articles](https://github.com/poeticoding/phoenix_uploads_articles)ã€‚

æœ‰å…´è¶£äº†è§£ Elixirã€Phoenix å’Œè½¯ä»¶æ¶æ„å—ï¼Ÿ[è®¢é˜…æˆ‘çš„æ—¶äº‹é€šè®¯ï¼Œäº†è§£ä¸€èˆ¬æ€è€ƒå’Œæ¯å‘¨æ·±å…¥çš„æ–¹æ³•](https://www.poeticoding.com/subscribe-to-newsletter/)ã€‚