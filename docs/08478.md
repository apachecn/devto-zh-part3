# ç¬¬ 017 é›†-æ›´å¤šçš„èº«ä»½ï¼Œæ›´å¤šçš„å‰ƒåˆ€é¡µ-ASP.NET æ ¸å¿ƒ:ä» 0 åˆ°çŸ«æ‰è¿‡æ­£

> åŸæ–‡:[https://dev . to/joaofbantunes/episode-017-more-identity-more-razor-pages-ASP-net-core-from-0-to-overkill-1h8b](https://dev.to/joaofbantunes/episode-017-more-identity-more-razor-pages-asp-net-core-from-0-to-overkill-1h8b)

åœ¨è¿™ä¸€é›†é‡Œï¼Œæˆ‘ä»¬ç»§ç»­å¼€å‘æˆ‘ä»¬çš„è®¤è¯æœåŠ¡ï¼ŒåŒæ—¶ç»§ç»­æ¢ç´¢ ASP.NET æ ¸å¿ƒèº«ä»½å’Œ Razor é¡µé¢ã€‚

å¯¹äºæ¼”ç»ƒï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹ä¸€ä¸ªè§†é¢‘ï¼Œä½†å¦‚æœæ‚¨å–œæ¬¢å¿«é€Ÿé˜…è¯»ï¼Œè¯·è·³åˆ°ä¹¦é¢ç»¼åˆã€‚

[https://www.youtube.com/embed/TO2MNzdsZWw](https://www.youtube.com/embed/TO2MNzdsZWw)

æ•´ä¸ªç³»åˆ—çš„æ’­æ”¾åˆ—è¡¨æ˜¯[è¿™é‡Œæ˜¯](https://www.youtube.com/playlist?list=PLN0oN9Azm_MMAjk3nhRnmHdr1l0160Dhs)ã€‚
T3ã€‘

## [T1ã€‘ç®€ä»‹](#intro)

åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ ASP.NET æ ¸å¿ƒ[èº«ä»½](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2)å’Œ[å‰ƒåˆ€é¡µé¢](https://docs.microsoft.com/en-us/aspnet/core/razor-pages/?view=aspnetcore-2.2)æ€»ç»“ä¸Šä¸€é›†å¼€å§‹çš„ç™»å½•å’Œæ³¨å†Œè¿‡ç¨‹ã€‚

### [](#changes-since-the-last-post)è‡ªä¸Šæ¬¡å‘å¸ƒåçš„å˜åŒ–

æˆ‘å°†è·³è¿‡è‡ªä¸Šä¸€ç¯‡æ–‡ç« ä»¥æ¥æˆ‘åšçš„ä¸€äº›äº‹æƒ…ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½å¤ªæœ‰è¶£ï¼Œä½†æ€»ç»“èµ·æ¥:

*   å¯¹ä¹‹å‰åˆ›å»ºçš„é¡µé¢è¿›è¡Œäº†è°ƒæ•´ï¼Œä¸ºæ·»åŠ å¼•å¯¼åšå‡†å¤‡ã€‚
*   æ·»åŠ äº†ä¸€äº›ç¼ºå¤±çš„é¡µé¢ï¼Œå¦‚ç”µå­é‚®ä»¶ç¡®è®¤ã€å¯†ç æ›´æ”¹å’Œé‡ç½®ã€‚

å¦‚æœæ‚¨å¯¹è¿™äº›æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ğŸ˜‰

## [](#twofactor-authentication)åŒå› ç´ è®¤è¯

ä¸ºäº†å®ç°åŒå› ç´ è®¤è¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•](https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm)æˆ–ç®€ç§°ä¸º TOTPã€‚

ä¸æˆ‘ä»¬ç›®å‰å·²ç»å®ç°çš„èº«ä»½éªŒè¯æµç¨‹çš„å…¶ä»–éƒ¨åˆ†ä¸€æ ·ï¼ŒåŒå› ç´ èº«ä»½éªŒè¯(ä»ç°åœ¨å¼€å§‹æˆ‘å°†ç¼©å†™ä¸º 2fa)å¹¶ä¸å¤ªéš¾å®ç°ï¼Œå› ä¸º ASP.NET æ ¸å¿ƒèº«ä»½æä¾›äº†æˆ‘ä»¬å®ç°å®ƒæ‰€éœ€çš„ä¸€åˆ‡ã€‚ç„¶è€Œï¼Œå®ƒéœ€è¦å¤§é‡çš„é¡µé¢æ¥å®ç°å®Œæ•´çš„åŠŸèƒ½é›†ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¿«é€Ÿçœ‹ä¸€ä¸‹æ‰€éœ€çš„ä¸»è¦æ­¥éª¤:

*   ç”¨æˆ·å¯ç”¨å’Œé…ç½® 2fa çš„æ–¹æ³•
*   ä¸ºç”¨æˆ·æä¾›äºŒç»´ç ä»¥è®¾ç½®è®¾å¤‡
*   ç”Ÿæˆå¹¶å‘ç”¨æˆ·æ˜¾ç¤ºæ¢å¤ä»£ç åˆ—è¡¨ï¼Œä»¥é˜²é…ç½®çš„è®¾å¤‡å‘ç”Ÿä»»ä½•é—®é¢˜
*   ç¦ç”¨ 2faï¼ŒåŒæ—¶é‡ç½®å·²é…ç½®çš„è®¾å¤‡
*   åœ¨ç™»å½•è¿‡ç¨‹ä¸­æ·»åŠ ä¸€ä¸ªæ­¥éª¤ï¼Œè¦æ±‚è¾“å…¥ 2fa ä»£ç æˆ–æ¢å¤ä»£ç ä½œä¸ºå¤‡ç”¨ä»£ç 

æˆ‘ä¸ä¼šæ·±å…¥æ‰€æœ‰è¿™äº›æ­¥éª¤çš„ç»†èŠ‚ï¼Œå› ä¸ºæˆ‘è®¤ä¸ºé€šè¿‡æŸ¥çœ‹[ä»£ç ](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode017)æ¥äº†è§£å®ƒä»¬ä¸­çš„å¤§å¤šæ•°åº”è¯¥ä¸ä¼šå¤ªéš¾ï¼Œæ‰€ä»¥æˆ‘å°†åªå¿«é€Ÿæµè§ˆå…¶ä¸­çš„ä¸€äº›ã€‚

å½“æˆ‘ä»¬å¼€å§‹çœ‹ä¸€äº›ä»£ç æ—¶ï¼Œè¯·è®°ä½ï¼Œå½“æˆ‘ä»¬ä» Identity ä¸­å–å‡ºæ‰€æœ‰ä½æ—¶ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯ç°æˆçš„ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€é›†ä¸­çœ‹åˆ°çš„ã€‚æˆ‘å°†å±•ç¤ºçš„ä¸€äº›éƒ¨åˆ†å®Œå…¨æ˜¯å¼€ç®±å³ç”¨çš„ï¼Œå…¶ä»–éƒ¨åˆ†æˆ‘åšäº†ä¸€äº›è°ƒæ•´ä»¥æ›´ç¬¦åˆæˆ‘çš„å–œå¥½ã€‚

### [](#managing-twofactor-authentication)ç®¡ç†åŒå› ç´ è®¤è¯

åœ¨å¸æˆ·ä¸»é¡µä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§é“¾æ¥åˆ° 2fa ç®¡ç†é¡µé¢çš„æ–¹å¼ï¼Œå› æ­¤åœ¨`Index.cshtml`ç»“æŸæ—¶ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä»¥ä¸‹å†…å®¹:

`Pages/Account/Index.cshtml`

```
<!-- ... -->
<div>
    @if (Model.IsTwoFactorEnabled)
    {
        <a asp-page="./ManageTwoFactor" class="btn btn-link">Manage two-factor authentication</a>
    }
    else
    {
        <a asp-page="./ManageTwoFactor" class="btn btn-link">Enable two-factor authentication</a>
    }
</div>
<!-- ... --> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨äº 2fa ç®¡ç†çš„ä¸»é¡µï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯`ManageTwoFactor.cshtml`ã€‚åœ¨æœ¬é¡µä¸­ï¼Œæˆ‘ä»¬ä»…æ ¹æ®ç”¨æˆ·çš„ 2fa é…ç½®çš„å½“å‰çŠ¶æ€æ˜¾ç¤ºä¸€äº›é€‰é¡¹ã€‚

å¦‚æœç”¨æˆ·å·²ç»å¯ç”¨äº†ä¸¤ä¸ªå› ç´ ï¼Œæ ¹æ®æ¢å¤ä»£ç çš„ä½¿ç”¨æƒ…å†µï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå»ºè®®ç”Ÿæˆä¸€ç»„æ–°çš„ä»£ç ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸ºç”¨æˆ·æä¾›äº†ä»¥ä¸‹é€‰é¡¹:

*   ç¦ç”¨ 2fa(å¦‚æœå·²å¯ç”¨)
*   å¿˜è®°å½“å‰çš„æµè§ˆå™¨ï¼Œä¸‹æ¬¡ç™»å½•æ—¶è¯¢é—®ä»£ç 
*   æ·»åŠ éªŒè¯å™¨è®¾å¤‡æˆ–é‡ç½®ç°æœ‰è®¾å¤‡

`Pages/Account/ManageTwoFactor.cshtml`

```
@page
@model CodingMilitia.PlayBall.Auth.Web.Pages.Account.ManageTwoFactorModel
@{
    ViewData["Title"] = "Manage two-factor authentication";
}
<h4>@ViewData["Title"]</h4>
<div>@Model.StatusMessage</div>
@if (Model.IsTwoFactorEnabled)
{
    if (Model.RecoveryCodesLeft == 0)
    {
        <div class="alert alert-danger">
            <strong>You have no recovery codes left.</strong>
            <p>You must <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a> before you can log in with a recovery code.</p>
        </div>
    }
    else if (Model.RecoveryCodesLeft == 1)
    {
        <div class="alert alert-danger">
            <strong>You have 1 recovery code left.</strong>
            <p>You can <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
        </div>
    }
    else if (Model.RecoveryCodesLeft <= 3)
    {
        <div class="alert alert-warning">
            <strong>You have @Model.RecoveryCodesLeft recovery codes left.</strong>
            <p>You should <a asp-page="./GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
        </div>
    }

    if (Model.IsMachineRemembered)
    {
        <form method="post" style="display: inline-block">
            <button type="submit" class="btn btn-primary">Forget this browser</button>
        </form>
    }
    <a asp-page="./DisableTwoFactor" class="btn btn-primary">Disable two-factor authentication</a>
    <a asp-page="./GenerateRecoveryCodes" class="btn btn-primary">Reset recovery codes</a>
}

<h5>Authenticator app</h5>
@if (!Model.HasAuthenticator)
{
    <a id="enable-authenticator" asp-page="./AddTwoFactorApp" class="btn btn-primary">Setup authenticator app</a>
}
else
{
    <a id="enable-authenticator" asp-page="./AddTwoFactorApp" class="btn btn-primary">Setup another authenticator app</a>
    <a id="reset-authenticator" asp-page="./ResetTwoFactorApp" class="btn btn-primary">Reset authenticator app</a>
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ªé¡µé¢çš„ä»£ç éšè—ç›¸å½“ç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€åšçš„å°±æ˜¯åˆ©ç”¨`UserManager`å’Œ`SignInManager`æ¥è·å–ä¿¡æ¯ï¼Œå¹¶åœ¨ POST è¯·æ±‚æ—¶å¿˜è®°æµè§ˆå™¨ã€‚

`Pages/Account/ManageTwoFactor.cshtml.cs`

```
//...
public async Task<IActionResult> OnGetAsync()
{
    var user = await _userManager.GetUserAsync(User);
    if (user == null)
    {
        return NotFound($"Unable to load user with ID '{_userManager.GetUserId(User)}'.");
    }

    HasAuthenticator = await _userManager.GetAuthenticatorKeyAsync(user) != null;
    IsTwoFactorEnabled = await _userManager.GetTwoFactorEnabledAsync(user);
    IsMachineRemembered = await _signInManager.IsTwoFactorClientRememberedAsync(user);
    RecoveryCodesLeft = await _userManager.CountRecoveryCodesAsync(user);

    return Page();
}

public async Task<IActionResult> OnPostAsync()
{
    var user = await _userManager.GetUserAsync(User);
    if (user == null)
    {
        return NotFound($"Unable to load user with ID '{_userManager.GetUserId(User)}'.");
    }

    await _signInManager.ForgetTwoFactorClientAsync();
    StatusMessage =
        "The current browser has been forgotten. When you login again from this browser you will be prompted for your 2fa code.";
    return RedirectToPage();
}
//... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#setting-up-a-new-authenticator-device)è®¾ç½®æ–°çš„è®¤è¯å™¨è®¾å¤‡

å½“è®¾ç½®æ–°è®¾å¤‡æ—¶ï¼Œæˆ‘ä»¬ä¼šå‰å¾€`AddTwoFactorApp.cshtml`ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªäºŒç»´ç (å¦‚æœç”¨æˆ·å–œæ¬¢/éœ€è¦è¾“å…¥ï¼Œåˆ™ç›´æ¥æä¾›å¯†é’¥)ä¾›ç”¨æˆ·åœ¨ authenticator åº”ç”¨ç¨‹åºä¸Šæ‰«æã€‚æ‰«æåï¼Œç”¨æˆ·åº”è¾“å…¥ä»£ç ä»¥ç»§ç»­é…ç½®è¿‡ç¨‹ã€‚

å¼€ç®±å³ç”¨çš„å®ç°å‡†å¤‡ä½¿ç”¨ä¸€ä¸ª JavaScript åº“æ¥å‘ˆç° QR ä»£ç ï¼Œä½†æ˜¯ç”±äºæˆ‘è¯•å›¾åœ¨è®¤è¯æœåŠ¡ä¸­æœ€å°åŒ– JS çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [SkiaSharp åœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆ QR ä»£ç ã€‚äºŒç»´ç ](https://github.com/guitarrapc/SkiaSharp.QrCode)ã€‚

å¯¹äºæœåŠ¡å™¨ç«¯ç”Ÿæˆï¼Œæˆ‘æƒ³åˆ°äº†å‡ ä¸ªå°† QR ç ä¼ é€’åˆ°å‰ç«¯çš„é€‰é¡¹:

*   è®©ä¸€ä¸ªç«¯ç‚¹æ¥æ”¶å¯†é’¥å¹¶ç”Ÿæˆå›¾åƒä½œä¸ºè¾“å‡º
*   åœ¨ base 64 ä¸­ç”Ÿæˆå¹¶ç¼–ç å›¾åƒï¼Œç„¶åå°†å…¶ç›´æ¥åµŒå…¥é¡µé¢

ç¬¬ä¸€ä¸ªé€‰é¡¹å¯èƒ½æ›´å¹²å‡€ï¼Œå› ä¸ºä»é¡µé¢çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸¸è§„çš„é™æ€å›¾åƒï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ª GET è¯·æ±‚ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šåœ¨æœåŠ¡å™¨æ—¥å¿—ä¸­ä½¿ç”¨å…±äº«å¯†é’¥ã€‚å¦‚æœæˆ‘èƒ½é¿å…æ³„éœ²ç§˜å¯†ï¼Œæˆ‘ä¼šçš„ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ª base 64 ç¼–ç çš„å›¾åƒï¼ğŸ™‚

ä¸ºäº†å®ç° QR ç çš„ç”Ÿæˆï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç±»(å…·æœ‰åŒ¹é…çš„æ¥å£)ï¼Œæ°å½“åœ°å‘½åä¸º`Base64QrCodeGenerator`(ä¹‹åä¸è¦å¿˜è®°åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œå®ƒ)ã€‚

`Base64QrCodeGenerator.cs`

```
public class Base64QrCodeGenerator : IBase64QrCodeGenerator
{
    public string Generate(Uri target)
    {
        using (var generator = new QRCodeGenerator())
        {
            var code = generator.CreateQrCode(target.OriginalString, ECCLevel.Q);

            var info = new SKImageInfo(256, 256);
            using (var surface = SKSurface.Create(info))
            {
                var canvas = surface.Canvas;
                canvas.Render(code, info.Width, info.Height);

                using (var image = surface.Snapshot())
                using (var data = image.Encode(SKEncodedImageFormat.Png, 100))
                {
                    return Convert.ToBase64String(data.ToArray());
                }
            }
        }            
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€å®è¯´ï¼Œæˆ‘æ²¡æœ‰èŠ±å¤ªå¤šæ—¶é—´åœ¨è¿™æ®µä»£ç ä¸Šï¼Œå®ƒè‚¯å®šå¯ä»¥è¢«ä¼˜åŒ–ã€‚æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ QR ç ç”Ÿæˆå™¨ï¼Œå®ƒè·å¾—ä¸€ä¸ª`Uri`å¹¶è¿”å› base 64 ç¼–ç çš„å›¾åƒã€‚

æˆ‘ä¸ä¼šåœ¨è¿™é‡Œç²˜è´´`AddTwoFactorApp.cshtml`ä»£ç ï¼Œå› ä¸ºå®ƒåªæ˜¯æ˜¾ç¤º QR ä»£ç ï¼Œå¹¶æœ‰ä¸€ä¸ªè¾“å…¥ä¾›ç”¨æˆ·ä»å¥¹çš„è®¾å¤‡æ’å…¥ä»£ç ã€‚å…³äºåé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€äº›éƒ¨åˆ†ã€‚

`Pages/Account/AddTwoFactorApp.cshtml`

```
public class AddTwoFactorAppModel : PageModel
{
    // ...

    public string SharedKey { get; set; }

    public string QrCode { get; set; }

    [TempData] public string[] RecoveryCodes { get; set; }

    [TempData] public string StatusMessage { get; set; }

    [BindProperty] public InputModel Input { get; set; }

    public class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.",
            MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Verification Code")]
        public string Code { get; set; }
    }

    public async Task<IActionResult> OnGetAsync()
    {
        var user = await _userManager.GetUserAsync(User);
        if (user == null)
        {
            return NotFound($"Unable to load user with ID '{_userManager.GetUserId(User)}'.");
        }

        await LoadSharedKeyAndQrCodeUriAsync(user);

        return Page();
    }

    // ...

    private async Task LoadSharedKeyAndQrCodeUriAsync(PlayBallUser user)
    {
        var unformattedKey = await _userManager.GetAuthenticatorKeyAsync(user);
        if (string.IsNullOrEmpty(unformattedKey))
        {
            await _userManager.ResetAuthenticatorKeyAsync(user);
            unformattedKey = await _userManager.GetAuthenticatorKeyAsync(user);
        }

        SharedKey = FormatKey(unformattedKey);
        var email = await _userManager.GetEmailAsync(user);
        QrCode = _qrCodeGenerator.Generate(GenerateQrCodeUri(email, unformattedKey));
    }

    private string FormatKey(string unformattedKey)
    {
        // makes a simple formatting of the key, to make it simpler for the user to copy it
        // ...
    }

    private Uri GenerateQrCodeUri(string email, string unformattedKey)
    {
        const string authenticatorUriFormat = "otpauth://totp/{0}:{1}?secret={2}&issuer={0}&digits=6";

        return new Uri(
            string.Format(
                authenticatorUriFormat,
                _urlEncoder.Encode("PlayBall"),
                _urlEncoder.Encode(email),
                unformattedKey));
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ GET è¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨`UserManager`æ¥è·å–å…±äº«çš„åŒå› å­å¯†é’¥ï¼Œç„¶åæ ¼å¼åŒ–å¯†é’¥ä»¥ä¾›æ˜¾ç¤ºï¼Œå¹¶ä¸ºå…¶åˆ›å»º Qr ä»£ç ã€‚

`Pages/Account/AddTwoFactorApp.cshtml`

```
public class AddTwoFactorAppModel : PageModel
{
    // ...

    public async Task<IActionResult> OnPostAsync()
    {
        // get and verify user exists...
        // verify model state is valid...
        // ...

        var is2faTokenValid = await _userManager.VerifyTwoFactorTokenAsync(
            user, _userManager.Options.Tokens.AuthenticatorTokenProvider, verificationCode);

        if (!is2faTokenValid)
        {
            ModelState.AddModelError("Input.Code", "Verification code is invalid.");
            await LoadSharedKeyAndQrCodeUriAsync(user);
            return Page();
        }

        await _userManager.SetTwoFactorEnabledAsync(user, true);
        var userId = await _userManager.GetUserIdAsync(user);
        _logger.LogInformation("User with ID '{UserId}' has enabled 2FA with an authenticator app.", userId);

        StatusMessage = "Your authenticator app has been verified.";

        if (await _userManager.CountRecoveryCodesAsync(user) == 0)
        {
            var recoveryCodes = await _userManager.GenerateNewTwoFactorRecoveryCodesAsync(user, 10);
            RecoveryCodes = recoveryCodes.ToArray();
            return RedirectToPage("./ShowRecoveryCodes");
        }
        else
        {
            return RedirectToPage("./ManageTwoFactor");
        }
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ POST è¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨`UserManager`éªŒè¯æ’å…¥çš„ä»£ç ã€‚å¦‚æœä»£ç æœ‰æ•ˆï¼Œæˆ‘ä»¬å°† 2fa è®¾ç½®ä¸º enabledï¼Œå¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•æ¢å¤ä»£ç ï¼Œæˆ‘ä»¬å°†ç”Ÿæˆä»£ç å¹¶å°†å®ƒä»¬æ”¾åœ¨ä¸´æ—¶æ•°æ®å±æ€§ä¸­ï¼Œç„¶åå°†ç”¨æˆ·é‡å®šå‘åˆ°`ShowRecoveryCodes`é¡µé¢ä»¥æŸ¥çœ‹å®ƒä»¬ã€‚

### [](#log-in-with-twofactor-authentication)ä½¿ç”¨åŒå› ç´ è®¤è¯ç™»å½•

æœ‰äº†åŒå› ç´ èº«ä»½è®¤è¯è®¾ç½®ï¼Œç°åœ¨å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿ä»–åœ¨æ­¤è¿‡ç¨‹ä¸­ä»ä»–çš„è®¾å¤‡ä¹‹ä¸€æ’å…¥ä»£ç ã€‚

åœ¨`Login`é¡µé¢ä¸Šï¼Œå·²ç»å‡†å¤‡å¥½äº†åˆ°`LoginWithTwoFactor`é¡µé¢çš„é‡å®šå‘ï¼Œä½†æ˜¯åŸºæœ¬ä¸Šå”¯ä¸€éœ€è¦çš„æ˜¯:

`Pages/LoginWithTwoFactor.cshtml.cs`

```
public async Task<IActionResult> OnPostAsync(string returnUrl = null)
{
    // validate model...
    // sign in with password...
    // ...
    if (signInResult.RequiresTwoFactor)
    {
        return RedirectToPage("./LoginWithTwoFactor", new { ReturnUrl = returnUrl, RememberMe = Input.RememberMe });
    }

    // ...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`LoginWithTwoFactor`æ˜¯ä¸€ä¸ªç®€å•çš„é¡µé¢ï¼Œå¸¦æœ‰ä¸€ä¸ªè¡¨å•ï¼Œä¾›ç”¨æˆ·ä»‹ç»å…¶è®¾å¤‡çš„ä»£ç ã€‚åœ¨ä»£ç éšè—æ–¹é¢ï¼Œé€»è¾‘ç±»ä¼¼äºæˆ‘ä»¬åœ¨`Login.cshtml.cs`ä¸­çœ‹åˆ°çš„ï¼Œä¸»è¦åŒºåˆ«åœ¨äºæˆ‘ä»¬ç”¨æ¥éªŒè¯æ•°æ®çš„`SignInManager`æ–¹æ³•:

`Pages/LoginWithTwoFactor.cshtml.cs`

```
var result = await _signInManager.TwoFactorAuthenticatorSignInAsync(authenticatorCode, rememberMe, Input.RememberMachine); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`LoginWithRecoveryCode`é¡µé¢åŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯å†æ¬¡ä½¿ç”¨äº†ä¸åŒçš„`SignInManager`æ–¹æ³•:

`Pages/LoginWithRecoveryCode.cshtml.cs`

```
var result = await _signInManager.TwoFactorRecoveryCodeSignInAsync(recoveryCode); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è‡³æ­¤ï¼Œæˆ‘æƒ³æˆ‘ä»¬å·²ç»äº†è§£äº†åŒå› ç´ èº«ä»½è®¤è¯å®æ–½çš„ä¸»è¦éƒ¨åˆ†ã€‚è¿˜æ˜¯é‚£å¥è¯ï¼Œå¦‚æœçœ‹ GitHub ä¸Šçš„ä»£ç æœ‰ä»€ä¹ˆä¸å¯¹çš„åœ°æ–¹ï¼Œæˆ³æˆ‘ï¼

## [](#adding-client-side-libraries-with-libman)ç”¨ LibMan æ·»åŠ å®¢æˆ·ç«¯åº“

åœ¨ PlayBall çš„ä¸»å‰ç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ [npm](https://www.npmjs.com/) æ¥ç®¡ç†ä¾èµ–æ€§ã€‚åœ¨ auth æœåŠ¡ä¸­ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ä»»ä½•ä¸œè¥¿ï¼Œå› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è¿˜ä¸éœ€è¦ JavaScriptï¼ŒCSS å·²ç»è¢«å®Œå…¨é—å¿˜äº†ã€‚

ç°åœ¨æˆ‘ä»¬å°†æ”¹å˜è¿™ä¸€ç‚¹ï¼Œå¹¶ä½¿ç”¨ [Bootstrap](https://getbootstrap.com/) æ¥å°è¯•ä½¿æˆ‘ä»¬çš„é¡µé¢ä¸é‚£ä¹ˆå¯æ€•ã€‚æˆ‘çŸ¥é“ Bootstrap å¹¶ä¸æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†ï¼Œä½†æˆ‘åªæ˜¯å¸Œæœ›é¡µé¢æ›´æœ‰ç”¨ï¼Œä¸è¦åœ¨ CSS ä¸ŠèŠ±å¤ªå¤šæ—¶é—´ï¼Œå› ä¸ºè¿™è¿œä¸æ˜¯æˆ‘çš„æœ€ä½³æŠ€èƒ½ğŸ˜›ã€‚

æˆ‘ä»¬å¯ä»¥ç›´æ¥ä» CDN å¯¼å…¥ Bootstrapï¼Œä½†æ˜¯è¿™æ ·æˆ‘ä»¬å°±çœ‹ä¸åˆ° [LibMan](https://docs.microsoft.com/en-us/aspnet/core/client-side/libman/libman-cli?view=aspnetcore-2.2) åœ¨å·¥ä½œã€‚

LibMan(å›¾ä¹¦é¦†ç®¡ç†å‘˜çš„ç®€ç§°)æ˜¯ä¸€ä¸ªç®€å•çš„ã€‚NET å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ç®¡ç†å‰ç«¯åº“ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… LibMan:

```
dotnet tool install -g Microsoft.Web.LibraryManager.Cli 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶ååœ¨æˆ‘ä»¬çš„ web é¡¹ç›®çš„æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ`libman init`æ¥åˆå§‹åŒ–å®ƒã€‚å®ƒä¼šè¦æ±‚æˆ‘ä»¬æä¾›é»˜è®¤çš„æä¾›è€…ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³æŒ‡å®šçš„è¯ï¼Œå®ƒå°†æ˜¯ cdnjsã€‚ç»“æœæ˜¯ä¸€ä¸ªå¸¦æœ‰ä¸€äº›å…ƒæ•°æ®çš„`json`æ–‡ä»¶:

```
{  "version":  "1.0",  "defaultProvider":  "cdnjs",  "libraries":  []  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæˆ‘ä»¬æƒ³è®©åº“é»˜è®¤è½¬åˆ°ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬å¯ä»¥åš`libman init --default-destination wwwroot/lib`ï¼Œè¿™ç»™æˆ‘ä»¬:

```
{  "version":  "1.0",  "defaultProvider":  "cdnjs",  "defaultDestination":  "wwwroot/lib",  "libraries":  []  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨æˆ‘ä»¬æƒ³å®‰è£…å¼•å¯¼ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬åš`libman install twitter-bootstrap`å¹¶å¾—åˆ°:

```
{  "version":  "1.0",  "defaultProvider":  "cdnjs",  "defaultDestination":  "wwwroot/lib",  "libraries":  [  {  "library":  "twitter-bootstrap@4.2.1"  }  ]  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨å®‰è£…åº“æ—¶æŒ‡å®šæä¾›è€…å’Œç›®æ ‡è·¯å¾„ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬å·²ç»è®¾ç½®äº†é»˜è®¤å€¼ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿™æ ·åšã€‚

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œä¸ºé¡µé¢åˆ›å»ºä¸€ä¸ªåŸºæœ¬å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…å«ä¸€ä¸ªåˆ°æˆ‘ä»¬åˆšåˆšå®‰è£…çš„å¼•å¯¼èµ„äº§çš„é“¾æ¥ã€‚

LibMan æœ‰æ¯”æˆ‘åœ¨è¿™é‡Œå±•ç¤ºçš„æ›´å¤šçš„é€‰é¡¹ï¼Œä½†è¿™æ˜¯æˆ‘åˆ°ç›®å‰ä¸ºæ­¢æ‰€éœ€è¦çš„å…¨éƒ¨([æŸ¥çœ‹æ–‡æ¡£äº†è§£æ›´å¤šä¿¡æ¯](https://docs.microsoft.com/en-us/aspnet/core/client-side/libman/libman-cli?view=aspnetcore-2.2))ã€‚è™½ç„¶å®ƒæ²¡æœ‰å¾ˆå¤šé€‰æ‹©ï¼Œå› ä¸ºå®ƒåº”è¯¥æ˜¯éå¸¸ç®€å•çš„ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æ›´å¤šçš„å¤æ‚æ€§ï¼Œå°±ä¸ç¼ºä¹æ›¿ä»£æ–¹æ¡ˆã€‚

## [](#adding-a-base-layout-to-the-pages)å‘é¡µé¢æ·»åŠ åŸºæœ¬å¸ƒå±€

ä¸ºäº†ç»™æ‰€æœ‰é¡µé¢æ·»åŠ ä¸€ä¸ªåŸºæœ¬å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥ä»åˆ›å»ºä¸€ä¸ª`Shared`æ–‡ä»¶å¤¹ä½œä¸º`Pages`çš„å­æ–‡ä»¶å¤¹å¼€å§‹ã€‚åœ¨é‚£é‡Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„`_Layout.cshtml`æ–‡ä»¶(å®ƒæ˜¯æ¨¡æ¿çš„ä¸€éƒ¨åˆ†)ã€‚åœ¨æ–°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ å¦‚ä¸‹å†…å®¹:

`Pages/Shared/_Layout.cshtml`

```
<!DOCTYPE html>
<html>
<head>
    <title>@ViewData["Title"]</title>
    <environment include="Development">
        <link rel="stylesheet" href="~/lib/css/bootstrap.css"/>    
    </environment>
    <environment exclude="Development">
        <link rel="stylesheet" href="~/lib/css/bootstrap.min.css"/>    
    </environment>
</head>
<body>
<div class="container">
    @RenderBody()
</div>
</body>
</html> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¤§éƒ¨åˆ†æ˜¯æ­£å¸¸çš„`HTML`,æœ‰å‡ ä¸ªå‰ƒåˆ€ç‰¹å¾:

*   æ ‡ç­¾åŠ©æ‰‹ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ ¹æ®åº”ç”¨ç¨‹åºå½“å‰çš„æ‰§è¡Œç¯å¢ƒæ¥å‘ˆç°é¡µé¢çš„ç‰¹å®šéƒ¨åˆ†ã€‚
*   `@RenderBody()`æ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬å°†å®ƒæ”¾åœ¨æˆ‘ä»¬å¸Œæœ›å‘ˆç°æ‰€è¯·æ±‚é¡µé¢å†…å®¹çš„åœ°æ–¹ã€‚

ç°åœ¨è¦ä½¿ç”¨å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°æ¯ä¸€é¡µå¹¶åœ¨é¡µçœ‰ä¸­é…ç½®å®ƒï¼Œä½†è¿™å°†æ˜¯å¤§é‡çš„å·¥ä½œï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šå¿˜è®°ä¸€äº›ä¸œè¥¿ã€‚ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`Pages`æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`_ViewStart.cshtml`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

`Pages/_ViewStart.cshtml`

```
@{
    Layout = "_Layout";
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œè¯¥æ–‡ä»¶å°†ç”±è¯¥æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å…¶ä»–è§†å›¾(åŠå…¶åä»£)æ‰§è¡Œï¼Œä½¿å®ƒä»¬éƒ½ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„åŸºæœ¬å¸ƒå±€ã€‚

ç„¶è€Œåœ¨`Account`å­æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªç¨å¾®ä¸åŒçš„å¸ƒå±€ï¼Œå…è®¸ç”¨æˆ·æ³¨é”€ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥éµå¾ªä¸€ä¸ªéå¸¸ç›¸ä¼¼çš„æ–¹æ³•ã€‚åˆ›å»ºå¦ä¸€ä¸ª`Shared`æ–‡ä»¶å¤¹ï¼Œè¿™ä¸€æ¬¡ä½œä¸º`Account`çš„åä»£ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºå¦ä¸€ä¸ªå¸ƒå±€æ–‡ä»¶(è¿™ä¸€æ¬¡æˆ‘å°†å…¶å‘½åä¸º`_Account.cshtml`)ã€‚åœ¨è¿™ä¸ªæ–°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ å¦‚ä¸‹å†…å®¹:

`Pages/Shared/_Account.cshtml`

```
@{
    Layout = "_Layout";
}
<form asp-page="/Logout" method="post">
    <button type="submit" class="btn btn-secondary">Logout</button>
</form>
<div class="container">
    @RenderBody()
</div> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä½¿å¾—è¿™ä¸ªå¸ƒå±€ç»§æ‰¿äº†åŸæ¥çš„å¸ƒå±€ï¼ŒåŒæ—¶æ·»åŠ äº†ä¸€ä¸ªæ³¨é”€æŒ‰é’®ã€‚åœ¨`Account`æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åˆ›å»ºå¦ä¸€ä¸ª`_ViewStart.cshtml`æ–‡ä»¶ï¼ŒåŒ…å«:

`Pages/Account/_ViewStart.cshtml`

```
@{
    Layout = "Shared/_Account";
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#adding-a-partial-view-for-the-status-message)ä¸ºçŠ¶æ€æ¶ˆæ¯æ·»åŠ å±€éƒ¨è§†å›¾

ä¸ºäº†æ€»ç»“è¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºå±€éƒ¨è§†å›¾ã€‚

è¿˜è®°å¾—æˆ‘ä»¬æ”¾åœ¨å¤§å¤šæ•°é¡µé¢é¡¶éƒ¨çš„çŠ¶æ€ä¿¡æ¯å—ï¼Œåœ¨ä¸Šä¸€é›†æˆ‘åªæ˜¯æŠŠå®ƒæ”¾åœ¨äº†ä¸€ä¸ª`div`é‡Œé¢ï¼Ÿå¥½å§ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åˆ°å±€éƒ¨è§†å›¾ä¸­ï¼Œç»™å®ƒä¸€ä¸ªæ›´å¥½çš„ UIã€‚

åœ¨`Pages/Account`æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªåä¸º`_StatusMessage.cshtml`çš„æ–°å±€éƒ¨è§†å›¾(æœ‰ä¸€ä¸ªæ–‡ä»¶æ¨¡æ¿)ã€‚åœ¨é‚£é‡Œæˆ‘ä»¬æœ‰ä»¥ä¸‹å†…å®¹:

`Pages/Account/_StatusMessage.cshtml`

```
@model string

@if (!String.IsNullOrEmpty(Model))
{
    var statusMessageClass = Model.StartsWith("Error") ? "danger" : "success";
    <div class="alert alert-@statusMessageClass alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        @Model
    </div>
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥æ¨¡å‹æ˜¯ä¸€ä¸ªå•ä¸€çš„`string`ï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬ç°åœ¨æ‰€éœ€è¦çš„ã€‚ç„¶åï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¡«å……çš„æ¨¡å‹(å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬ä¸ä¼šæ¸²æŸ“ä»»ä½•ä¸œè¥¿)ï¼Œæˆ‘ä»¬æ˜¾ç¤ºæ¶ˆæ¯ï¼Œç”¨ä¸€äº›å¼•å¯¼ç±»è£…é¥°ï¼ŒåŠ ä¸Šä¸€ä¸ªæŒ‰é’®æ¥æ¶ˆé™¤æ¶ˆæ¯ã€‚

ç°åœ¨ï¼Œä¸ºäº†ä½¿ç”¨å±€éƒ¨è§†å›¾ï¼Œåœ¨æ¯ä¸€é¡µä¸Šï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨ä¸‹é¢çš„å†…å®¹æ›¿æ¢å¸¦æœ‰æ¶ˆæ¯çš„`div`

```
<partial name="_StatusMessage" for="StatusMessage" /> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#outro)å…¶ä»–

è¿™æ˜¯å®ƒçš„è¿™ä¸ªèŒä½å¯¹ ASP.NET æ ¸å¿ƒèº«ä»½å’Œå‰ƒåˆ€é¡µã€‚æˆ‘ä»¬çœ‹äº†ä¸€ä¸‹å®ç°è®¤è¯æµçš„ä¸€äº›æœ€æœ‰è¶£çš„éƒ¨åˆ†(å½“ç„¶æ˜¯ä»æˆ‘çš„è§’åº¦)ã€‚åŒæ ·ï¼Œä¸è¦å¿˜è®° ASP.NET æ ¸å¿ƒèº«ä»½å·²ç»è‡ªå¸¦äº†å¤§éƒ¨åˆ†ç°æˆçš„ï¼Œæ‰€ä»¥åªæœ‰åœ¨æ‚¨éœ€è¦å®šåˆ¶å®ƒæ—¶æ‰ä¼šé‡åˆ°è¿™ç§éº»çƒ¦ã€‚

å¸–å­ä¸­çš„é“¾æ¥:

*   [ASP.NET æ ¸å¿ƒå‰ƒåˆ€é¡µ](https://docs.microsoft.com/en-us/aspnet/core/razor-pages/?view=aspnetcore-2.2)
*   [ASP.NET æ ¸å¿ƒèº«ä»½](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2)
*   [åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•](https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm)
*   [ä¸­æ–‡å­—å¹• ocr:è´¾å®ç‰å­—å¹•æ ¡å¯¹:è´¾å®ç‰](https://github.com/guitarrapc/SkiaSharp.QrCode)
*   [åˆ©ä¼¯æ›¼(å›¾ä¹¦é¦†ç»ç†)](https://docs.microsoft.com/en-us/aspnet/core/client-side/libman/libman-cli?view=aspnetcore-2.2)
*   [npm](https://www.npmjs.com/)
*   [è‡ªä¸¾](https://getbootstrap.com/)

è¿™ä¸ªå¸–å­çš„æºç æ˜¯[è¿™é‡Œ](https://github.com/AspNetCoreFromZeroToOverkill/Auth/tree/episode017)ã€‚

æœ€åä¸€ç‚¹ï¼Œå½“æˆ‘å½•åˆ¶è§†é¢‘çš„æ—¶å€™æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œä½†å†™å®Œå¸–å­åï¼Œè¿™æ„Ÿè§‰æœ‰ç‚¹åˆ°å¤„éƒ½æ˜¯ï¼Œå¤ªå¤šçš„è¯é¢˜æµ“ç¼©åœ¨ä¸€ä¸ªè§†é¢‘/å¸–å­ä¸­ã€‚æˆ‘ä¼šåŠªåŠ›æƒ³å‡ºä¸€ä¸ªæ›´å¥½çš„ç»„ç»‡ç­–ç•¥ğŸ™‚

é‰´äºæˆ‘æ­£åœ¨å®ç°ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘æƒ³åœ¨ä¸€é›†é‡Œæµ“ç¼©å‡ ä¸ªä¸»é¢˜æ˜¯æ­£å¸¸çš„ï¼Œä½†æˆ‘ä¸å®Œå…¨ç¡®å®šé˜…è¯»ä½“éªŒæ˜¯å¦å¾ˆæ£’ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰å»ºè®®ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚

æ„Ÿè°¢åˆ†äº«å’Œåé¦ˆï¼

è°¢è°¢ä½ çš„æ¥è®¿ï¼Œè¥¿é˜¿å…¹ï¼