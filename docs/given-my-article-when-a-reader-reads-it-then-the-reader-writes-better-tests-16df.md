# å½“è¯»è€…é˜…è¯»æˆ‘çš„æ–‡ç« æ—¶ï¼Œè¯»è€…ä¼šå†™å‡ºæ›´å¥½çš„æµ‹è¯•

> åŸæ–‡ï¼š<https://dev.to/jamoyjamie/given-my-article-when-a-reader-reads-it-then-the-reader-writes-better-tests-16df>

# ç»™ä¸€ä¸ªè®¨åŒå†™æµ‹è¯•çš„å¼€å‘è€…

æˆ‘ä¸æ“…é•¿æµ‹è¯•ï¼Œæˆ‘æœ€å¸¸ç”¨çš„å‰¯ä¸šé¡¹ç›®åªæœ‰å¤§çº¦ 5%çš„æµ‹è¯•è¦†ç›–ç‡å°±æ˜¯è¯æ˜ã€‚æˆ‘ä¸èƒ½è®©è‡ªå·±è¾›è‹¦åœ°å®Œæˆå¹¶ç¼–å†™æˆ‘æ­£åœ¨ç¼–å†™çš„ä»£ç çš„æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå°¤å…¶æ˜¯å½“æˆ‘æ²¡æœ‰å¤ªå¤šçš„æ—¶é—´å»åšå…¼èŒé¡¹ç›®çš„æ—¶å€™ã€‚

# æ”¾åœ¨å–œæ¬¢æµ‹è¯•çš„è½¯ä»¶å±‹

ç„¶è€Œï¼Œåœ¨æˆ‘ç›®å‰çš„å·¥ä½œä¸­ï¼Œæˆ‘è¢«æœŸæœ›æ‹¥æœ‰ 80%çš„ä»£ç è¦†ç›–ç‡ï¼Œè¿™æ˜¯ç§°ä¹‹ä¸ºâ€œç¨³å®šâ€çš„æœ€ä½è¦æ±‚çš„ä¸€éƒ¨åˆ†â€”â€”å› æ­¤æˆ‘å®é™…ä¸ŠèŠ±è´¹äº†å¤§éƒ¨åˆ†å·¥ä½œæ—¶é—´æ¥ç¼–å†™å•å…ƒã€é›†æˆå’Œç³»ç»Ÿæµ‹è¯•ã€‚

# ä»–å¿…é¡»åœ¨å·¥ä½œä¸­ç¼–å†™å¤§é‡çš„æµ‹è¯•

æµ‹è¯•æ˜¯æˆ‘ä»¬å…¬å¸éå¸¸æ“…é•¿çš„äº‹æƒ…ã€‚æˆ‘ä»¬æœ‰æ•°åä¸‡è¡Œä»£ç ï¼Œåˆ†å¸ƒåœ¨æ•°åä¸ªä¸åŒé¡¹ç›®çš„æ•°ç™¾ä¸ªä¸åŒçš„å­˜å‚¨åº“ä¸­ï¼Œåœ¨ä»»ä½•ä¸€å¤©ï¼Œæˆ‘éƒ½å¯ä»¥åœ¨å…¶ä¸­çš„ä»»ä½•éƒ¨åˆ†å·¥ä½œã€‚

äº‹å®æ˜¯ï¼Œè¿™äº›æµ‹è¯•è®©æˆ‘ä»¬çœå»äº†æ— æ•°å¤´ç–¼çš„äº‹æƒ…ï¼Œå¹¶ä¸”è®©ç–¯ç‹‚çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å˜å¾—ç®€å•å¤šäº†ã€‚ç”±äºæµ‹è¯•è¦†ç›–ç‡é«˜ï¼Œæˆ‘çŸ¥é“æˆ‘å¯ä»¥ä¿®æ”¹ä»£ç ï¼Œç”šè‡³å¯ä»¥æ‰§è¡Œå¤§è§„æ¨¡çš„é‡æ„ï¼Œå¦‚æœæˆ‘æ„¿æ„çš„è¯ï¼Œåœ¨æˆ‘æš´è·³å¦‚é›·çš„æœ€åï¼Œæˆ‘å¯ä»¥è¿è¡Œæµ‹è¯•ï¼Œå¹¶åœ¨å‡ åˆ†é’Ÿå†…çŸ¥é“ä»£ç çš„è¡Œä¸ºæ˜¯å¦æœ‰ä»»ä½•å˜åŒ–ã€‚

æˆ‘åªæ˜¯ä¸éœ€è¦åœ¨ç¼–è¾‘ä»£ç æ—¶æ‹…å¿ƒä»£ç è¢«ç ´åã€‚

# ç„¶åä»–åœ¨æµ‹è¯•ä¸­å­¦ä¼šäº†ä¸€äº›å·§å¦™çš„æŠ€å·§

è¿™å°±æ˜¯æˆ‘è¦å‘Šè¯‰ä½ è¡Œä¸ºé©±åŠ¨æµ‹è¯•çš„å¥‡å¦™ä¸–ç•Œçš„åœ°æ–¹ã€‚

æˆ‘ä»¬æœ‰ä¸€ä¸ªæƒ¯ä¾‹ï¼Œç”¨ GIVEN-WHEN-THEN ç»“æ„ç¼–å†™æ¯ä¸ªæµ‹è¯•ã€‚è¿™æ˜¯æˆ‘çš„å‰¯ä¸šé¡¹ç›®çš„ä¸€ä¸ªä¾‹å­:

```
[TestMethod]
public void TestReadStringDeserializesTheDataCorrectly()
{
    // GIVEN a buffer of serialized data
    mockMessageBuffer.Setup(m => m.Buffer).Returns(new byte[] { 0, 0, 0, 6, 65, 0, 66, 0, 67, 0 });
    mockMessageBuffer.Setup(m => m.Offset).Returns(0);
    mockMessageBuffer.Setup(m => m.Count).Returns(10);

    // WHEN I read a string from the reader
    string result = reader.ReadString();

    // THEN the value is as expected
    Assert.AreEqual("ABC", result);
} 
```

Enter fullscreen mode Exit fullscreen mode

æˆ‘çœ‹åˆ°è¿™ä¸ªæµ‹è¯•ï¼Œç«‹å³çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°æˆ‘éœ€è¦çš„ä¸€åˆ‡:

*   åœ¨ç»™å®šçš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®æˆ‘ä»¬éœ€è¦çš„ä»»ä½•æ¨¡æ‹Ÿï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œä»ç£ç›˜åŠ è½½ä»»ä½•æµ‹è¯•æ•°æ®ï¼Œå¹¶åšæˆ‘ä»¬å¿…é¡»åšçš„ä»»ä½•å‡†å¤‡ã€‚

*   åœ¨ WHEN éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¿è¡Œè¢«æµ‹è¯•çš„ä»£ç (å¹¶ä¸”å°½æˆ‘ä»¬æ‰€èƒ½ï¼Œ*ä»…*è¢«æµ‹è¯•çš„ä»£ç )å¹¶è·å¾—ç»“æœã€‚

*   åœ¨ THEN éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ–­è¨€ä»£ç çš„è¡Œä¸ºä¸æˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·ã€‚

æœ‰äº†è¿™ä¸ªç®€å•çš„ç»“æ„ï¼Œç†è§£ä¸€ä¸ªæµ‹è¯•åšä»€ä¹ˆå°±å˜å¾—ç®€å•äº†ã€‚æˆ‘å¯ä»¥æµè§ˆå¼€å‘å’Œä»£ç å®¡æŸ¥ä¸­çš„æ•°ç™¾ä¸ªæµ‹è¯•ï¼Œå¹¶åœ¨å‡ ç§’é’Ÿå†…ç«‹å³æŒæ¡æµ‹è¯•æ­£åœ¨åšä»€ä¹ˆï¼Œå› ä¸ºæˆ‘ä»¬å…¬å¸çš„æ¯ä¸ªæµ‹è¯•éƒ½æœ‰ç›¸åŒçš„è¡Œä¸ºé©±åŠ¨æ ¼å¼ã€‚

æˆ‘ä»¬è¿˜å‘ç°è¿™ç§é£æ ¼ä¹Ÿè”“å»¶åˆ°äº†æˆ‘ä»¬æµ‹è¯•çš„å…¶ä»–éƒ¨åˆ†:

```
[TestInitialize]
public void Initialize()
{
    // GIVEN the object cache is disabled
    ObjectCache.Initialize(ObjectCacheSettings.DontUseCache);

    // AND a DarkRiftReader under test
    reader = DarkRiftReader.Create(mockMessageBuffer.Object);
} 
```

Enter fullscreen mode Exit fullscreen mode

æ‚¨ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œå¼€å§‹çœ‹åˆ°æˆ‘ä»¬å¦‚ä½•æ„å»ºæ›´å¤æ‚çš„æµ‹è¯•ã€‚å¦‚æœä½ åœ¨ä»»ä½•éƒ¨åˆ†åšäº†å¤šä»¶äº‹ï¼Œå»ºè®®ä½ ç”¨ AND éƒ¨åˆ†æ¥è®°å½•å®ƒä»¬:

```
[TestMethod]
public void TestExtraLargeMemoryBlocksArePooledCorrectly()
{
    // GIVEN a memory pool with no previously pooled memory

    // WHEN I return an extra large memory block
    byte[] oldBlock = new byte[5000];
    memoryPool.ReturnInstance(oldBlock);

    // AND I request a new extra large memory block
    byte[] newBlock = memoryPool.GetInstance(4000);

    // THEN my memory block is the same
    Assert.AreSame(oldBlock, newBlock);
} 
```

Enter fullscreen mode Exit fullscreen mode

(æˆ‘åœ¨è¿™é‡Œèµ°äº†ä¸€æ¡æ·å¾„ï¼Œæˆ‘å¯èƒ½åº”è¯¥æŠŠ`oldBlock`èµ‹å€¼ç»™ä¸€ä¸ªç»™å®šçš„å˜é‡ï¼Œä½†æ˜¯è¿™ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„)

# å¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åº”ç”¨å®ƒä»¬

å†™æµ‹è¯•çš„æ—¶å€™ä¹Ÿæœ‰å¸®åŠ©ï¼

ç”¨è‹±è¯­æ€è€ƒè¡Œä¸ºè¦å®¹æ˜“å¾—å¤šâ€”â€”è¿™å°±æ˜¯ä¼ªä»£ç å’Œæ©¡çš®é¸­è°ƒè¯•ä¹‹ç±»çš„ä¸œè¥¿å­˜åœ¨çš„åŸå› â€”â€”é‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç”¨ä½ çš„æ¯è¯­ç¼–å†™æµ‹è¯•ï¼Œç„¶åç”¨å®ƒä½œä¸ºæ¨¡æ¿å‘¢ï¼Ÿ

```
[TestMethod]
public void TestGetInstanceUsesPoolWhenHasInstances()
{
    // GIVEN a pool with a single element

    // WHEN I get an instance from the pool

    // THEN a new instance is not generated

    // AND the returned instance is the pooled object
} 
```

Enter fullscreen mode Exit fullscreen mode

```
[TestMethod]
public void TestGetInstanceUsesPoolWhenHasInstances()
{
    // GIVEN a pool with a single element
    object pooledObject = new object();
    objectPool.ReturnInstance(pooledObject);

    // WHEN I get an instance from the pool
    object result = objectPool.GetInstance();

    // THEN a new instance is not generated
    Assert.IsNull(newInstanceCaptor);

    // AND the returned instance is the pooled object
    Assert.IsNotNull(result);
    Assert.AreSame(pooledObject, result);
} 
```

Enter fullscreen mode Exit fullscreen mode

GIVEN-WHEN-THEN çš„ç¡®åˆ‡é¡ºåºä¹Ÿæ— å…³ç´§è¦ï¼Œæˆ‘ä»¬ç»å¸¸å‘ç°ï¼Œåœ¨æœ€å¤æ‚çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æ–­è¨€è¡Œä¸º(THEN)ï¼Œæˆ–è€…åœ¨ç»§ç»­è®¾ç½®(GIVEN)ä¹‹å‰å¯¹æµ‹è¯•ä¸­çš„ç±»æ‰§è¡ŒæŸä¸ªæ­¥éª¤(WHEN)

```
@free
Scenario: I can disconnect from a server
    Given I have a running server
    And 1 client connected
    Then all clients should be connected
    And the server should have 1 client
    When I disconnect client 0
    Then 0 clients should be connected
    And 1 client should be disconnected
    And the server should have 0 clients
    And there should be no recycling warnings 
```

Enter fullscreen mode Exit fullscreen mode

# ç»“è®º

ä½ ä¸çŸ¥é“æˆ‘çš„å‰¯ä¸šæ˜¯åšä»€ä¹ˆçš„ï¼Œæˆ‘ä»æ¥æ²¡æœ‰æåˆ°è¿‡å®ƒï¼Œä½†æ˜¯ä½ ä»ç„¶å¸Œæœ›èƒ½å¤Ÿç†è§£è¿™äº›æµ‹è¯•åšäº†ä»€ä¹ˆï¼Œå°½ç®¡å®ƒä»¬æ¶µç›–äº†æˆ‘å¿…é¡»æ·»åŠ åˆ°å®ƒçš„ä¸€äº›æœ€å¤æ‚å’Œå¤æ€ªçš„ä¼˜åŒ–ï¼

å¯¹æˆ‘æ¥è¯´ï¼Œé‡‡ç”¨è¿™ç§è¡Œä¸ºä¼šå¤§å¤§å‡å°‘æµ‹è¯•çš„éº»çƒ¦ã€‚å¯¹äºå’Œæˆ‘ä¸€èµ·å·¥ä½œçš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œè¿™ä½¿å¾—ç†è§£æˆ‘çš„æµ‹è¯•æ›´å¿«æ›´å®¹æ˜“ã€‚åœ¨åˆå¹¶å®¡æŸ¥ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨é‡Šå®¡æŸ¥æµ‹è¯•è¡Œä¸ºï¼Œç„¶åå¯¹ç…§æ³¨é‡Šæ£€æŸ¥ä»£ç ï¼Œä»¥ä½¿å¤§é‡æµ‹è¯•çš„å®¡æŸ¥æ›´æ˜“äºç®¡ç†ã€‚

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ æ€è€ƒï¼Œä¹Ÿè®¸åœ¨ä½ å†™ä¸‹ä¸€ä¸ªæµ‹è¯•ä¹‹å‰ï¼Œä½ ä¼šå†™ä¸€ä¸ªå¿«é€Ÿçš„ç»™å®šæ—¶é—´ğŸ™‚