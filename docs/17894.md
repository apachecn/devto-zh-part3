# ä½¿ç”¨ passports è¿›è¡Œèº«ä»½éªŒè¯æ„å»º nodejs web åº”ç”¨ç¨‹åº

> åŸæ–‡:[https://dev . to/GM 456742/building-a-nodejs-we B- app-using-passport js-for-authentic ation-3ge 2](https://dev.to/gm456742/building-a-nodejs-web-app-using-passportjs-for-authentication-3ge2)

æ›´æ–°äº†ï¼ï¼ï¼
æœ¬æ•™ç¨‹ä½¿ç”¨ **PassportJS** å‘ MySQL æ•°æ®åº“ç®¡ç†è½¯ä»¶(DBMS)è®¤è¯ NodeJS åº”ç”¨ã€‚è¿™ç¯‡æ–‡ç« çš„åŸå› å¾ˆç®€å•ã€‚åœ¨æˆ‘å­¦ä¹  web å¼€å‘çš„æ—¶å€™ï¼Œå½“æˆ‘åœ¨æˆ‘çš„ç¬¬äºŒä¸ªé¡¹ç›®ä¸­å°† PassportJS èº«ä»½éªŒè¯é›†æˆåˆ°æˆ‘çš„åº”ç”¨ç¨‹åºä¸­æ—¶ï¼Œæˆ‘é¢ä¸´ç€ä¸€ä¸ªæŒ‘æˆ˜ã€‚é‚£æ—¶ï¼Œæˆ‘ä½¿ç”¨ **MySQL** è¿›è¡Œæ•°æ®åº“ç®¡ç†ï¼Œ **SequelizeJS** ç”¨äºåŸºäº SQL çš„æ•°æ®åº“çš„å¯¹è±¡å…³ç³»æ˜ å°„å™¨(ORM ),åœ¨è¿™é‡Œæ˜¯ MySQLï¼Œ **ExpressJS** ä¸­é—´ä»¶ï¼Œ **Body Parser** å’Œ **Express Session** ç”¨äºæœåŠ¡å™¨å’Œä¼šè¯ç®¡ç†ã€‚å›°éš¾åœ¨äºæˆ‘åªèƒ½æ‰¾åˆ°ä½¿ç”¨*æ‰‹æŸ„*ä½œä¸º ORM å’Œ *MongoDB* ä½œä¸º DBMS çš„æ•™ç¨‹ï¼Œé‚£æ—¶æˆ‘è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œæ‰€ä»¥å¦‚æœä½ å‘ç°è‡ªå·±å¤„åœ¨è¿™ä¸ªåå­—è·¯å£ï¼Œè¿™æ˜¯ç»™ä½ çš„ã€‚æˆ‘ä¸ä¼šæµªè´¹ä½ çš„æ—¶é—´ï¼Œè€Œæ˜¯é©¬ä¸ŠæŠ•å…¥è¿›å»ã€‚æˆ‘ä¼šå°½å¯èƒ½çš„ä¸å¤¸å¼ ï¼Œè¿™æ ·å³ä½¿æ˜¯å¯¹ web å¼€å‘äº†è§£æœ€å°‘çš„äººä¹Ÿèƒ½ç†è§£ã€‚æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªè®¾ç½®åšä¸€äº›å‡†å¤‡ã€‚æˆ‘ç”¨çš„æ˜¯ Windows Pcï¼Œæ‰€ä»¥å¦‚æœæˆ‘è¯´çš„ä»»ä½•ä¸œè¥¿ä¸é€‚åˆä½ çš„æ“ä½œç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯æˆ‘çš„å»ºè®®ï¼Œè¯·æ‰¾ä¸€ä¸ªå˜é€šåŠæ³•ï¼Œä½†æˆ‘ç›¸ä¿¡è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ã€‚

é¦–å…ˆï¼Œä½ éœ€è¦ä¸€å°è£…æœ‰ä½ æœ€å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨(æˆ‘ç”¨çš„æ˜¯ VS Code)ã€ç½‘ç»œæµè§ˆå™¨(æˆ‘æ¨è Google Chrome)ã€ä½ æœ€å–œæ¬¢çš„ç»ˆç«¯(æ¨è Git Bash)å’Œä½ é€‰æ‹©çš„ SQL DBMS çš„ç”µè„‘ã€‚æˆ‘ç”¨çš„æ˜¯ MySQL Workbench 6.3 CEã€‚æˆ‘å°†åˆ—å‡ºæ‰€æœ‰çš„æ­¥éª¤ï¼Œè¿™æ ·å¾ˆå®¹æ˜“ç†è§£ã€‚å½“ä½ å…·å¤‡ä»¥ä¸Šæ‰€æœ‰æ¡ä»¶å¹¶æ­£ç¡®è®¾ç½®åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è¯´æ˜è¿›è¡Œæ“ä½œã€‚æˆ‘å‡è®¾ä½ å·²ç»æœ‰ä½ çš„æ•°æ®åº“åˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä¼šå¸¦ä½ é€šè¿‡ã€‚

1.  åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šçš„ä»»æ„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚æˆ‘æ›´å–œæ¬¢ä½¿ç”¨æˆ‘çš„ç»ˆç«¯å¯¼èˆªåˆ°æˆ‘å–œæ¬¢çš„ä½ç½®ï¼Œç„¶åè¾“å…¥`mkdir nameOfProject`ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘å°†åœ¨æˆ‘çš„æ¡Œé¢ä¸Šåˆ›å»ºæ–‡ä»¶å¤¹ *learningPassportJS* ã€‚ä¸‹ä¸€æ­¥æ˜¯é”®å…¥ cd nameOfProject å¯¼èˆªåˆ°é¡¹ç›®æ–‡ä»¶å¤¹ã€‚

[![](../Images/88c63cc031afdf8ab0b4edf3d455ee40.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Dcr8CU50--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.scotch.io/57241/my8dGvx5QZm1UbjmfRDq_projectTerminal.PNG)

1.  åœ¨ç»ˆç«¯ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»åˆå§‹åŒ–æ–‡ä»¶å¤¹æ¥å¤„ç†æ‰€æœ‰çš„ NodeJS æ¡†æ¶ã€‚æ‚¨å¯ä»¥ç¨åå†å†³å®šè¿™æ ·åšï¼Œä½†æ˜¯å¦‚æœæ‚¨æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„æ–°æ‰‹ï¼Œæˆ‘å»ºè®®æ‚¨å…ˆè¿™æ ·åšã€‚é€šè¿‡é”®å…¥`npm init`å¹¶æŒ‰å›è½¦é”®æ¥å®Œæˆæ­¤æ“ä½œã€‚è¿™å°†ä½¿ç”¨ä¸€ä¸ª *package.json* æ–‡ä»¶å»ºç«‹æ‚¨çš„é¡¹ç›®ã€‚è¯¥æ–‡ä»¶å°†åŒ…å«æ‰€æœ‰é¢„æœŸçš„ä¾èµ–é¡¹å’Œè®¸å¯è¯ä»¥åŠæ‚¨çš„å§“åç­‰ä¿¡æ¯ã€‚å‡ºäºæˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘å°†ä¸€ç›´æŒ‰é”®ç›˜ä¸Šçš„ enter é”®æ¥åŠ è½½é»˜è®¤å€¼ï¼Œä½†æˆ‘ä¼šå°†å…¥å£ç‚¹è®¾ç½®ä¸º ***server.js*** ã€‚éšæ„æ¢æˆè‡ªå·±å–œæ¬¢çš„ã€‚è¯·ç¡®ä¿æ‚¨çš„æ–‡æœ¬ä¸­æœ‰å°å†™å­—æ¯ï¼Œå¦åˆ™æ‚¨å°†ä¸å¾—ä¸è‡ªå·±é”®å…¥å®ƒä»¬ã€‚

[![](../Images/d4dbbb53691be1b4b70e6580797d64ed.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--SI5wNlwS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.scotch.io/57241/0SiEsACSSa5teEke1eyb_projectTerminalNpmInit.PNG)

1.  åˆå§‹åŒ–é¡¹ç›®åï¼Œæˆ‘ä»¬å°†åœ¨ç»ˆç«¯ä¸Šç”¨`touch server.js`åˆ›å»º server.js æ–‡ä»¶ã€‚

2.  ç°åœ¨è®©æˆ‘ä»¬å®‰è£…æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚ç¨åæˆ‘ä¼šè§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ¯ä¸€ä¸ªï¼Œä½†æˆ‘å–œæ¬¢å®‰è£…æ‰€æœ‰çš„ä¸œè¥¿æ¥æ‘†è„±å®ƒã€‚ä½ å¯ä»¥åœ¨ä»¥åå®‰è£…å®ƒä»¬ï¼Œä½†ä½ éœ€è¦å®ƒä»¬æ¥æˆåŠŸè¿è¡Œåº”ç”¨ç¨‹åºã€‚å°†å®ƒä»¬ä½œä¸º`npm i --save sequelize passport passport-local mysql2 mysql express express-session body-parser bcrypt-nodejs`å®‰è£…åœ¨ä¸€è¡Œä¸­ï¼Œæˆ–è€…æ‚¨å¯ä»¥é€‰æ‹©å°†å®ƒä»¬å•ç‹¬å®‰è£…ä¸º
    `npm i --save sequelize`
    `npm i --save passport`
    `npm i --save passport-local`
    `npm i --save mysql2`
    `npm i --save mysql`
    `npm i --save express`
    `npm i --save express-session``npm i --save body-parser`
    `npm i --save bcryptjs`

æ·»åŠ `--save`ç¡®ä¿æ‚¨çš„ä¾èµ–é¡¹è¢«æ·»åŠ å¹¶ä¿å­˜åˆ° package.json æ–‡ä»¶ä¸­ã€‚å¦‚æœæ‚¨æƒ³è¦éƒ¨ç½²æ­¤åº”ç”¨ç¨‹åºï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä½ å°†å®ç°ä¸€ä¸ªåä¸º *node_modules* çš„æ–°æ–‡ä»¶å¤¹ã€‚ä¸è¦ç¢°è¿™ä¸ªã€‚è¿™æ˜¯ node ç”¨æ¥åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæœ¬åœ°è¿è¡Œåº”ç”¨ç¨‹åºçš„ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®ä½¿ç”¨ Gitï¼Œä¸è¦å¿˜è®°å°†`node_modules`æ·»åŠ åˆ°é¡¹ç›®æ ¹æ–‡ä»¶å¤¹ä¸­çš„`.gitignore`æ–‡ä»¶ä¸­ã€‚

æ„Ÿè°¢[ä¹”ä¸¹Â·æ€€ç‰¹](https://github.com/jordanrw)çš„è´¡çŒ®ï¼Œæˆ‘æƒ³å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½ å¿…é¡»å…ˆå®‰è£… Sequelize CLIï¼Œç„¶åæ‰èƒ½ä½¿ç”¨ Sequelizeã€‚é€šè¿‡ä»æ‚¨çš„é¦–é€‰ç»ˆç«¯è¿è¡Œ`npm install -g sequelize-cli`æ¥è¿›è¡Œå…¨å±€å®‰è£…ï¼Œæˆ–è€…æ‚¨å¯ä»¥åˆ é™¤`-g`æ¥è¿›è¡Œæœ¬åœ°å®‰è£…ã€‚

1.  æ‰“å¼€åœ¨æ‚¨å–œæ¬¢çš„ç»ˆç«¯ä¸­åˆ›å»ºçš„ server.js æ–‡ä»¶ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ server.js æ–‡ä»¶ä¸­è¾“å…¥å‡ è¡Œä»£ç ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¼šå¯¹æ‰€æœ‰ä»£ç è¿›è¡Œå¤§é‡çš„æ³¨é‡Šï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“ç†è§£æˆ‘ä¸ºä»€ä¹ˆè¦å†™æ¯ä¸€è¡Œã€‚æ‚¨å¯ä»¥å°†ä¸‹é¢çš„ä»£ç å¤åˆ¶åˆ°æœåŠ¡å™¨æ–‡ä»¶ä¸­ã€‚

```
// Requiring necessary npm middleware packages 
var express = require("express");
var bodyParser = require("body-parser");
var session = require("express-session");
// Setting up port
var PORT = process.env.PORT || 8080;
// Creating express app and configuring middleware 
//needed to read through our public folder
var app = express();
app.use(bodyParser.urlencoded({ extended: false })); //For body parser
app.use(bodyParser.json());
app.use(express.static("public"));
//
//we are doing a GET to test if our server is working fine
app.get('/', function(req, res) {    
       res.send('Welcome to Passport with Sequelize and without HandleBars');
});
//
//this will listen to and show all activities on our terminal to 
//let us know what is happening in our app
app.listen(PORT, function() {
    console.log("App listening on PORT " + PORT);
  }); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¿å­˜æœåŠ¡å™¨æ–‡ä»¶ã€‚è®©æˆ‘ä»¬è¿è¡ŒæœåŠ¡å™¨ä»¥ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œã€‚é€šè¿‡åœ¨ç»ˆç«¯ä¸­é”®å…¥`npm start`æˆ–`node server.js`æ¥å®Œæˆã€‚ä½ è¿˜è®°å¾—æˆ‘ä»¬è·‘`npm init`æ—¶çš„*å…¥å£ç‚¹*å—ï¼Ÿè¿™å°±æ˜¯ä½ è¿è¡Œ`npm start`æ—¶çš„å«æ³•ã€‚

å¦‚æœæ‚¨ä¸€ç›´æŒ‰ç…§è¯´æ˜è¿›è¡Œæ“ä½œï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹

[![](../Images/d68d7cbf9d1da4afd526d7aa7d635b85.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--3Sl3q9PT--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn.scotch.io/57241/efP7HKyVTYGJAzXZkI9S_projectTerminalServerTest.PNG)

æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ä½ç½® [localhost:8080](http://localhost:8080) ã€‚è¿™å°†æ˜¾ç¤º*æ¬¢è¿ä½¿ç”¨å¸¦åºåˆ—å’Œä¸å¸¦æŠŠæ‰‹çš„æŠ¤ç…§*ã€‚å¹²å¾—å¥½ï¼ï¼èµ°åˆ°è¿™ä¸€æ­¥ã€‚æ‚¨æ­£åœ¨åˆ›å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°è¯¥é¡µé¢ï¼Œè¯·ä»å¤´å¼€å§‹æŸ¥æ‰¾æ­¥éª¤ã€‚æ‚¨å¯ä»¥ç»“æŸæœåŠ¡å™¨å¹¶å›åˆ°æ‚¨çš„ä»£ç ã€‚

1.  æˆ‘ä»ä¸€å¼€å§‹å°±å‡è®¾æ‚¨å¯èƒ½å·²ç»åˆ›å»ºäº†æ•°æ®åº“ã€‚å¦‚æœä½ æ²¡æœ‰æˆ–è€…ä¸çŸ¥é“å¦‚ä½•å»åšï¼Œä¸è¦æ‹…å¿ƒã€‚åªéœ€æ‰“å¼€æ‚¨é€‰æ‹©çš„ MySQL ç¨‹åºï¼Œåœ¨æŸ¥è¯¢ shell ä¸­è¾“å…¥`CREATE DATABASE passport_demo;`å¹¶è¿è¡Œå®ƒã€‚ä½ åº”è¯¥æœ‰ä¸€ä¸ªåä¸º *passport_demo* çš„æ•°æ®åº“ã€‚

2.  ç°åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨å’Œæ•°æ®åº“å·²ç»å·¥ä½œäº†ï¼Œæ˜¯æ—¶å€™æ·»åŠ å…¶ä»–éƒ¨åˆ†äº†ã€‚æˆ‘ä»¬å°†é…ç½®å’Œåˆå§‹åŒ–æˆ‘ä»¬çš„åºåˆ—æ¨¡å—ã€‚é€šè¿‡åœ¨ç»ˆç«¯ä¸Šé”®å…¥`sequelize init:models & sequelize init:config`å¹¶æŒ‰å›è½¦é”®æ¥å®Œæˆã€‚
    è¿™æ®µä»£ç è¿è¡Œåï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸¤ä¸ªæ–‡ä»¶å¤¹*æ¨¡å‹*å’Œ*é…ç½®*ã€‚
    æ‰“å¼€ config æ–‡ä»¶å¤¹ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ª *config.json* æ–‡ä»¶ã€‚æ‰“å¼€å®ƒå¹¶ç¼–è¾‘å¼€å‘å¯¹è±¡çš„è®¾ç½®ä»¥åŒ¹é…æ‚¨çš„è®¾ç½®ã€‚å¦‚æœæ‚¨çš„æ•°æ®åº“æœ‰å¯†ç ï¼Œè¯·åœ¨è¿™é‡Œç”¨å¼•å·å°†å…¶è¾“å…¥ã€‚ç¤ºä¾‹å¦‚ä¸‹

```
{  "development":  {  "username":  "root",  "password":  "yourpassword",  "database":  "passport_demo",  "host":  "127.0.0.1",  "dialect":  "mysql"  },  "test":  {  "username":  "root",  "password":  null,  "database":  "database_test",  "host":  "127.0.0.1",  "dialect":  "mysql"  },  "production":  {  "username":  "root",  "password":  null,  "database":  "database_production",  "host":  "127.0.0.1",  "dialect":  "mysql"  }  } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‘åå¯¼èˆªå¹¶æ‰“å¼€æ¨¡å‹æ–‡ä»¶å¤¹ã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ª *index.js* æ–‡ä»¶ã€‚è¿™åœ¨æˆ‘ä»¬çš„æ•™ç¨‹ä¸­åº”è¯¥æ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯å¦‚æœä½ çš„ config æ–‡ä»¶å¤¹åœ¨ä¸åŒçš„ä½ç½®ï¼Œä½ å¯ä»¥æ‰“å¼€å®ƒï¼Œä» Col 37 ç¼–è¾‘ç¬¬ 8 è¡Œåˆ°ä½ çš„ä½ç½®ï¼Œå› ä¸ºå®ƒéœ€è¦ *config.json* æ–‡ä»¶æ‰èƒ½å·¥ä½œã€‚ä¸€äº› Windows ç”µè„‘è¿˜ä¼šæŠ›å‡ºæ‰¾ä¸åˆ°é…ç½®æ¨¡å—çš„é”™è¯¯ã€‚å°†åæ–œæ æ”¹ä¸ºæ­£æ–œæ æ¥ä¿®å¤è¿™ä¸ªé”™è¯¯ã€‚

1.  åœ¨ *models* æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º *user.js* çš„æ–°æ–‡ä»¶ã€‚è¿™å°†ä½¿ç”¨ sequelize å°†æˆ‘ä»¬çš„ç”¨æˆ·ä¿¡æ¯æ’å…¥æ•°æ®åº“ã€‚æ ¹æ®æ‚¨çš„éœ€è¦ï¼Œæ‚¨å¯ä»¥æ‹¥æœ‰å¤šä¸ªæ¨¡å‹æ–‡ä»¶ã€‚models æ–‡ä»¶å¤¹åº”è¯¥åŒ…å«æ‚¨åœ¨æ•°æ®åº“ä¸­æ’å…¥çš„å„ç§è¡¨æ ¼ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨æˆ·æ¨¡å‹ã€‚æˆ‘ä»¬å°†è¦æ±‚ *bcryptjs* åŒ…å¯¹ç”¨æˆ·åˆ›å»ºæˆ–ç™»å½•çš„å¯†ç è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚æ‚¨çš„ *user.js* æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º

```
// Requiring bcrypt for password hashing. Using the bcryptjs version as 
//the regular bcrypt module sometimes causes errors on Windows machines
var bcrypt = require("bcryptjs");
//
// Creating our User model
//Set it as export because we will need it required on the server
module.exports = function(sequelize, DataTypes) {
  var User = sequelize.define("User", {
    // The email cannot be null, and must be a proper email before creation
    email: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true,
      validate: {
        isEmail: true
      }
    },
    // The password cannot be null
    password: {
      type: DataTypes.STRING,
      allowNull: false
    }
  });
  // Creating a custom method for our User model. 
  //This will check if an unhashed password entered by the 
  //user can be compared to the hashed password stored in our database
  User.prototype.validPassword = function(password) {
    return bcrypt.compareSync(password, this.password);
  };
  // Hooks are automatic methods that run during various phases of the User Model lifecycle
  // In this case, before a User is created, we will automatically hash their password

  User.hook("beforeCreate", function(user) {
    user.password = bcrypt.hashSync(user.password, bcrypt.genSaltSync(10), null);
  });
  return User;
};

//This is a fix by Samaila Philemon Bala in case you want to use ES6
//and the above is not working

//User.beforeCreate(user => {
  //  user.password = bcrypt.hashSync(
    //  user.password,
      //bcrypt.genSaltSync(10),
      //null
    //);
  //}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1.  è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ *server.js* æ–‡ä»¶ï¼Œæ·»åŠ å‡ è¡Œä»£ç ã€‚æˆ‘ä»¬å°†éœ€è¦è¦æ±‚æœåŠ¡å™¨è¯»å–æ¨¡å‹æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ƒæ¥åŒæ­¥æˆ‘ä»¬çš„æ’å…¥å’Œè¯»å–åˆ°æ•°æ®åº“ã€‚æ‚¨çš„ server.js åº”è¯¥å¦‚ä¸‹æ‰€ç¤º

```
// Requiring necessary npm middleware packages 
var express = require("express");
var bodyParser = require("body-parser");
var session = require("express-session");
// Setting up port
var PORT = process.env.PORT || 8080;
//Import the models folder
var db = require("./models");
//
// Creating express app and configuring middleware 
//needed to read through our public folder
var app = express();
app.use(bodyParser.urlencoded({ extended: false })); //For body parser
app.use(bodyParser.json());
app.use(express.static("public"));
//
//we are doing a GET to test if our server is working fine
app.get('/', function(req, res) {    
       res.send('Welcome to Passport with Sequelize and without HandleBars');
});
//
//this will listen to and show all activities on our terminal to 
//let us know what is happening in our app
// Syncing our database and logging a message to the user upon success
db.sequelize.sync().then(function() {
  app.listen(PORT, function() {
    console.log("==> ğŸŒ  Listening on port %s. Visit http://localhost:%s/ in your browser.", PORT, PORT);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1.  ç°åœ¨è®©æˆ‘ä»¬å¯¼èˆªåˆ° config æ–‡ä»¶å¤¹ï¼Œåˆ›å»ºå¦ä¸€ä¸ªåä¸º*ä¸­é—´ä»¶*çš„æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨è¯¥æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º *isAuthenticated.js* çš„æ–‡ä»¶ã€‚ä½ åº”è¯¥æœ‰`/config/middleware/isAuthenticated.js`ã€‚æ‰“å¼€å¹¶ç¼–è¾‘ *isAuthenticated.js* æ–‡ä»¶ä»¥åŒ¹é…è¿™ä¸ª

```
// This is middleware for restricting routes a user is not allowed to visit if not logged in
module.exports = function(req, res, next) {
  // If the user is logged in, continue with the request to the restricted route
  if (req.user) {
    return next();
  }
  // If the user isn't' logged in, redirect them to the login page
  return res.redirect("/");
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¹Ÿå°†è¢«å¯¼å‡ºï¼Œæˆ‘ä»¬å°†éœ€è¦è¿™ä¸€ç‚¹æ¥é™åˆ¶å¯¹ç™»å½•ç”¨æˆ·åªæ„å‘³ç€é¡µé¢çš„è®¿é—®ã€‚

1.  æ˜¯æ—¶å€™åŠæŠ¤ç…§äº†ã€‚åœ¨ *config* æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º passport.js çš„æ–‡ä»¶ã€‚æ‰“å¼€è¯¥æ–‡ä»¶å¹¶åœ¨æ–‡ä»¶ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ã€‚è¯„è®ºè§£é‡Šäº†ä¸€åˆ‡ã€‚

```
//we import passport packages required for authentication
var passport = require("passport");
var LocalStrategy = require("passport-local").Strategy;
//
//We will need the models folder to check passport agains
var db = require("../models");
//
// Telling passport we want to use a Local Strategy. In other words,
//we want login with a username/email and password
passport.use(new LocalStrategy(
  // Our user will sign in using an email, rather than a "username"
  {
    usernameField: "email"
  },
  function(email, password, done) {
    // When a user tries to sign in this code runs
    db.User.findOne({
      where: {
        email: email
      }
    }).then(function(dbUser) {
      // If there's no user with the given email
      if (!dbUser) {
        return done(null, false, {
          message: "Incorrect email."
        });
      }
      // If there is a user with the given email, but the password the user gives us is incorrect
      else if (!dbUser.validPassword(password)) {
        return done(null, false, {
          message: "Incorrect password."
        });
      }
      // If none of the above, return the user
      return done(null, dbUser);
    });
  }
));
//
// In order to help keep authentication state across HTTP requests,
// Sequelize needs to serialize and deserialize the user
// Just consider this part boilerplate needed to make it all work
passport.serializeUser(function(user, cb) {
  cb(null, user);
});
//
passport.deserializeUser(function(obj, cb) {
  cb(null, obj);
});
//
// Exporting our configured passport
module.exports = passport; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

1.  ä¸ºäº†è®©æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåƒé¢„æœŸçš„é‚£æ ·å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿè·å¾—å¹¶å‘å¸ƒåˆ°æˆ‘ä»¬çš„æ•°æ®åº“ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ”¾åœ¨ *server.js* æ–‡ä»¶ä¸­çš„`app.get`ä»£ç å—ã€‚è®©æˆ‘ä»¬å†™ä¸€ä¸ªå¹²å‡€çš„ä»£ç ã€‚åœ¨æ ¹æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º *routes* çš„æ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºä¸¤ä¸ªåä¸º *api-routes.js* å’Œ *html-routes.js* çš„æ–‡ä»¶ã€‚ *api-routes.js* å°†ç”¨äºè·¯ç”±`GET`å’Œ`POST`è¿›å‡ºæ•°æ®åº“ã€‚æ‰“å¼€ *api-routes.js* å¹¶ç²˜è´´ä»¥ä¸‹å†…å®¹ã€‚è¯„è®ºè§£é‡Šäº†ä¸€åˆ‡ã€‚

```
// Requiring our models and passport as we've configured it
var db = require("../models");
var passport = require("../config/passport");
//
module.exports = function(app) {
  // Using the passport.authenticate middleware with our local strategy.
  // If the user has valid login credentials, send them to the members page.
  // Otherwise the user will be sent an error
  app.post("/api/login", passport.authenticate("local"), function(req, res) {
    // Since we're doing a POST with javascript, we can't actually redirect that post into a GET request
    // So we're sending the user back the route to the members page because the redirect will happen on the front end
    // They won't get this or even be able to access this page if they aren't authed
    res.json("/members");
  });
//
  // Route for signing up a user. The user's password is automatically hashed and stored securely thanks to
  // how we configured our Sequelize User Model. If the user is created successfully, proceed to log the user in,
  // otherwise send back an error
  app.post("/api/signup", function(req, res) {
    console.log(req.body);
    db.User.create({
      email: req.body.email,
      password: req.body.password
    }).then(function() {
      res.redirect(307, "/api/login");
    }).catch(function(err) {
      console.log(err);
      res.json(err);
      // res.status(422).json(err.errors[0].message);
    });
  });
//
  // Route for logging user out
  app.get("/logout", function(req, res) {
    req.logout();
    res.redirect("/");
  });
//
  // Route for getting some data about our user to be used client side
  app.get("/api/user_data", function(req, res) {
    if (!req.user) {
      // The user is not logged in, send back an empty object
      res.json({});
    }
    else {
      // Otherwise send back the user's email and id
      // Sending back a password, even a hashed password, isn't a good idea
      res.json({
        email: req.user.email,
        id: req.user.id
      });
    }
  });
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬æš‚æ—¶ç¦»å¼€ html-routes.js ã€‚æˆ‘ä»¬ä¼šå›æ¥çš„ã€‚æˆ‘ä»¬å°†éœ€è¦å®ƒæ¥å¤„ç†ç™»å½•å’ŒæœåŠ¡æˆ‘ä»¬çš„é¡µé¢ã€‚

1.  åœ¨ *server.js* æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥å¹¶åˆå§‹åŒ– passportã€‚è¯·ç¡®ä¿åœ¨ passport ä¹‹å‰åˆå§‹åŒ–æ‚¨çš„ expressï¼Œå› ä¸º passport éœ€è¦ expressã€‚æœåŠ¡å™¨ä¸­çš„æ ‡è®°éå¸¸é‡è¦ã€‚æˆ‘è¿˜å°†åˆ é™¤`app.get`ä»£ç å—ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å®ƒã€‚æ‚¨çš„æœåŠ¡å™¨æ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º

```
// Requiring necessary npm packages
var express = require("express");
var bodyParser = require("body-parser");
var session = require("express-session");
// Requiring passport as we've configured it
var passport = require("./config/passport");
//
// Setting up port and requiring models for syncing
var PORT = process.env.PORT || 8080;
var db = require("./models");
//
// Creating express app and configuring middleware needed for authentication
var app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(express.static("public"));
// We need to use sessions to keep track of our user's login status
app.use(session({ secret: "keyboard cat", resave: true, saveUninitialized: true }));
app.use(passport.initialize());
app.use(passport.session());
//
// Requiring our routes
require("./routes/html-routes.js")(app);
require("./routes/api-routes.js")(app);
//
// Syncing our database and logging a message to the user upon success
db.sequelize.sync().then(function() {
  app.listen(PORT, function() {
    console.log("==> ğŸŒ  Listening on port %s. Visit http://localhost:%s/ in your browser.", PORT, PORT);
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ html-routesã€‚ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºæˆ‘ä»¬çš„ç”¨æˆ·ç•Œé¢(UI ),ä»¥ä¾¿èƒ½å¤Ÿæ•è·ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ã€‚è¿™å°†æ˜¯æˆ‘ä»¬é€šå¸¸ç”¨ css å’Œ js æ–‡ä»¶åˆ›å»ºçš„å¸¸è§„ html æ–‡ä»¶ï¼Œä½†è¿™æ¬¡å®ƒå°†è¢«æ”¾åœ¨ä¸€ä¸ªå…¬å…±æ–‡ä»¶å¤¹ä¸­ã€‚è¿™æ˜¯ express å°†ä½¿ç”¨å’Œè§£æçš„æ–‡ä»¶å¤¹ã€‚å¦‚æœæ‚¨ç†Ÿæ‚‰ [POSTMAN](https://www.getpostman.com/) ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥åœ¨æ­¤æ—¶ä½¿ç”¨å®ƒæ¥æµ‹è¯•æœåŠ¡å™¨ã€‚

1.  æˆ‘åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«æ–‡ä»¶çš„ç¤ºä¾‹å…¬å…±æ–‡ä»¶å¤¹ã€‚è¿™å°±æ˜¯æˆ‘å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨çš„ã€‚ä» [Mediafire](http://www.mediafire.com/file/39hjqqp8t2ddyuy/learnPassportPublic.zip) ä¸‹è½½å¹¶è§£å‹åˆ°æ ¹æ–‡ä»¶å¤¹ã€‚

2.  çœ‹ä¸€ä¸‹å…¬å…±æ–‡ä»¶å¤¹ä¸­çš„ html æ–‡ä»¶ã€‚æ‚¨å°†çœ‹åˆ°æˆ‘ä½¿ç”¨`API` s æ•è·äº†æ³¨å†Œã€ç™»å½•å’Œæˆå‘˜é¡µé¢`GET`,è¿™æ ·æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†å…¶ä¼ é€’ç»™æœåŠ¡å™¨ã€‚

3.  ç°åœ¨æ‰“å¼€ *html-routes.js* å¹¶ç²˜è´´ä¸‹é¢çš„ä»£ç 

```
// Requiring path to so we can use relative routes to our HTML files
var path = require("path");
//
// Requiring our custom middleware for checking if a user is logged in
var isAuthenticated = require("../config/middleware/isAuthenticated");
//
module.exports = function(app) {
//
  app.get("/", function(req, res) {
    // If the user already has an account send them to the members page
    if (req.user) {
      res.redirect("/members");
    }
    res.sendFile(path.join(__dirname, "../public/signup.html"));
  });
//
  app.get("/login", function(req, res) {
    // If the user already has an account send them to the members page
    if (req.user) {
      res.redirect("/members");
    }
    res.sendFile(path.join(__dirname, "../public/login.html"));
  });
//
  // Here we've add our isAuthenticated middleware to this route.
  // If a user who is not logged in tries to access this route they will be 
  //redirected to the signup page
  app.get("/members", isAuthenticated, function(req, res) {
    res.sendFile(path.join(__dirname, "../public/members.html"));
  });
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¿å­˜æ‰€æœ‰æ–‡ä»¶ï¼Œç„¶åç”¨`npm start`æˆ–`node server.js`è¿è¡ŒæœåŠ¡å™¨ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨å¤±è´¥äº†ï¼Œåœ¨ä½ çš„ç»ˆç«¯ä¸Šæ£€æŸ¥é”™è¯¯ï¼Œå¹¶æ£€æŸ¥æœ¬æ•™ç¨‹ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚çœ‹ä¸€çœ‹`*/public/js/members.js*`ï¼Œä½ å°±èƒ½æ˜ç™½ä½ éœ€è¦ä»€ä¹ˆæ¥è·å–ç”¨æˆ·ä¿¡æ¯ã€‚Sequelize è‡ªåŠ¨ä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ª`id`ï¼Œè¿™æ ·æ‚¨å°±å¯ä»¥ç”¨å®ƒæ¥å¤„ç†æ•°æ®åº“ä¸­å…¶ä»–è¡¨ä¸Šçš„å…³è”ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å¸Œæœ›åœ¨ä¸€ä¸ªåˆ†ç±»ç½‘ç«™ä¸Šè¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ‚¨åªéœ€ç¡®ä¿æœ‰ä¸€ä¸ªæ¨¡å‹ï¼Œå¦‚æ’å…¥æ•°æ®åº“çš„å‘å¸ƒã€æ‰§è¡Œå‘å¸ƒçš„ api è·¯ç”±ã€åœ¨å‘å¸ƒåˆ°æ•°æ®åº“ä¹‹å‰å’Œä¹‹åè·å–é¡µé¢çš„ html è·¯ç”±ã€‚æ€»æ˜¯ç¡®ä¿ä½ é€šè¿‡ä»»ä½•ä½ ä¸å¸Œæœ›ç”¨æˆ·åœ¨æ²¡æœ‰ç™»å½•çš„æƒ…å†µä¸‹è®¿é—®çš„ html è·¯å¾„ä¸Šçš„`isAuthenticated`ã€‚`isAuthenticated`å¦‚æœä½¿ç”¨ï¼Œå°†å§‹ç»ˆæ£€æŸ¥è®¿é—®ã€‚

æˆ‘å¸Œæœ›æˆ‘çš„å­—é¢è§£é‡Šèƒ½å¤Ÿå¸®åŠ©æ‚¨åœ¨ä¸ä½¿ç”¨æ‰‹æŸ„æˆ– MongoDB çš„æƒ…å†µä¸‹è§£å†³èº«ä»½éªŒè¯é—®é¢˜ã€‚

ç†æŸ¥å¾·Â·å¾·å¸ƒæ‹‰